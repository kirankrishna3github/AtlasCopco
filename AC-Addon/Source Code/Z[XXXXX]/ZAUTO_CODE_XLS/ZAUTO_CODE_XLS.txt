

** Please note: This code feature is an IBM property and is protected
* by IBM IP Rights. Any misuse of this code, or sharing beyond IBM
* entity will be a direct violation of IBM Code of Conduct and will
* be dealt with accordingly


** Created By: SANDEEP AGARWALA, Senior Consultant, IBM


REPORT zabap_generator MESSAGE-ID 38..
*$*$--------------------------------------------------------------------
*$*$ Report Name:
*$*$ Description: Allocate next sequential program name (acc. to Stds)
*$*$              Create the Skeleton Code that may be needed
*$*$--------------------------------------------------------------------
*$*$ Naming Conventions used for creating text elements used to create
*$*$ the code for the next program :
*$*$--------------------------------------------------------------------
*$*$ 0nn - text elements used for this program
*$*$ 1nn - Text elements used to create the new program headers
*$*$ ASn - Text elements used to create the AT-SELECTION-SCREEN code
*$*$ Cnn - Text elements used to create any CONSTANT / Commented lines
*$*$ Dnn - Text elements used to create any DATA declarations
*$*$ Fxn - Text elements used to create Forms (x seq. Form Number)
*$*$ Inn - Text elements used to create the INITIALIZATION procedure
*$*$ Snn - Text elements used to create the SELECTION SCREEN code
*$*$ SSn - Text elements used to create the START-OF-SELECTION code
*$*$ INn - Text elements used to create the INCLUDE modules
*$*$ ESn - Text elements used to create the END-OF-SELECTION code
*$*$ EFM - Denotes ENDFORM
*$*$ ELS - Denotes ELSE
*$*$--------------------------------------------------------------------
*$*$Correction #             Modified By                 Date
*$*$Description: Initial Version.
*$*$--------------------------------------------------------------------

TABLES : usr03, dd02t, sscrfields.

*$*$ Declaration of Data variables and constants
CONSTANTS: c_on   VALUE 'X'.
CONSTANTS: c_z    VALUE 'Z'.
CONSTANTS: c_%    VALUE '%'.
CONSTANTS: c_comma(1) TYPE c VALUE ',',
           c_hyphen(1) TYPE c VALUE '-',
           c_quotes(1) TYPE c VALUE '"',
           c_quote  VALUE '''',
           c_dot(1) TYPE c VALUE '.',
           c_star(1) VALUE '*'.

TYPE-POOLS: slis.
TYPE-POOLS: vrm.
TYPE-POOLS: ixml.
TYPE-POOLS: trnsp.

TYPES: BEGIN OF prog_structure,
          z,
          app(2),
          type(1),
          seqno(4) TYPE n,
       END OF prog_structure.

TYPES: BEGIN OF ty_gpvaltab,
         tabname(10) TYPE c,
         field(10)   TYPE c,
         type(1)     TYPE c,
         fname(6)    TYPE c,
       END OF ty_gpvaltab.

TYPES: BEGIN OF ty_excel_data,
        worksheet TYPE string,
        row  TYPE kcd_ex_row_n,
        col  TYPE kcd_ex_col_n,
        dtype TYPE string,
        value TYPE char50,
      END OF ty_excel_data.

TYPES: BEGIN OF ty_selection,
        text   TYPE char40,
        name   TYPE char8,
        table  TYPE char24,
        field  TYPE char24,
        etype  TYPE c,
        mand   TYPE c,
        ftype  TYPE c,
        check  TYPE char24,
        grpval TYPE char24,
        dfault TYPE char24,
       END OF ty_selection.

TYPES: BEGIN OF ty_processing,
        table     TYPE char24,
        fae       TYPE char24,
        field1    TYPE char24,
        field2    TYPE char24,
        field3    TYPE char24,
        field4    TYPE char24,
        field5    TYPE char24,
        field6    TYPE char24,
        field7    TYPE char24,
        field8    TYPE char24,
        field9    TYPE char24,
        field10   TYPE char24,
        field11   TYPE char24,
        field12   TYPE char24,
        field13   TYPE char24,
        field14   TYPE char24,
        field15   TYPE char24,
        j1table   TYPE char24,
        j1cond1   TYPE char24,
        j1cond2   TYPE char24,
        j1cond3   TYPE char24,
        j1cond4   TYPE char24,
        j2table   TYPE char24,
        j2cond1   TYPE char24,
        j2cond2   TYPE char24,
        j2cond3   TYPE char24,
        j2cond4   TYPE char24,
        j3table   TYPE char24,
        j3cond1   TYPE char24,
        j3cond2   TYPE char24,
        j3cond3   TYPE char24,
        j3cond4   TYPE char24,
        j1fld1    TYPE char24,
        j1fld2    TYPE char24,
        j1fld3    TYPE char24,
        j1fld4    TYPE char24,
        j1fld5    TYPE char24,
        j1fld6    TYPE char24,
        j1fld7    TYPE char24,
        j1fld8    TYPE char24,
        j1fld9    TYPE char24,
        j1fld10   TYPE char24,
        j1fld11   TYPE char24,
        j1fld12   TYPE char24,
        j2fld1    TYPE char24,
        j2fld2    TYPE char24,
        j2fld3    TYPE char24,
        j2fld4    TYPE char24,
        j2fld5    TYPE char24,
        j2fld6    TYPE char24,
        j2fld7    TYPE char24,
        j2fld8    TYPE char24,
        j2fld9    TYPE char24,
        j2fld10   TYPE char24,
        j2fld11   TYPE char24,
        j2fld12   TYPE char24,
        j3fld1    TYPE char24,
        j3fld2    TYPE char24,
        j3fld3    TYPE char24,
        j3fld4    TYPE char24,
        j3fld5    TYPE char24,
        j3fld6    TYPE char24,
        j3fld7    TYPE char24,
        j3fld8    TYPE char24,
        j3fld9    TYPE char24,
        j3fld10   TYPE char24,
        j3fld11   TYPE char24,
        j3fld12   TYPE char24,
       END OF ty_processing.

TYPES: BEGIN OF ty_output,
        name    TYPE char20,
        heading TYPE char40,
        table   TYPE char24,
        field   TYPE char24,
        dtype   TYPE c,
        length  TYPE char4,
       END OF ty_output.

TYPES: BEGIN OF ty_fm,
        pname   TYPE char40,
        ptype   TYPE char10,
        mand    TYPE c,
        type    TYPE char30,
       END OF ty_fm.

TYPES: BEGIN OF ty_ldb_nodes,
         ldbnode   TYPE ldbnode,
         sel       TYPE flag,
       END OF ty_ldb_nodes.

TYPES: BEGIN OF ty_infty,
         infty     TYPE infty,
       END OF ty_infty.

TYPES: ty_t_ldb_nodes     TYPE STANDARD TABLE OF ty_ldb_nodes,
       ty_t_infty         TYPE STANDARD TABLE OF ty_infty.

DATA: it_ldb_nodes     TYPE ty_t_ldb_nodes,
      it_ldb_nodes_sel TYPE ty_t_ldb_nodes,
      it_fieldcat      TYPE slis_t_fieldcat_alv,
      it_selfield      TYPE slis_selfield,
      it_infty         TYPE ty_t_infty.

DATA: wa_ldb_nodes     TYPE ty_ldb_nodes,
      wa_fieldcat      TYPE slis_fieldcat_alv,
      wa_infty         TYPE ty_infty,
      wa_trdir         TYPE trdir.

DATA i_gpvaltab TYPE STANDARD TABLE OF ty_gpvaltab INITIAL SIZE 0.

DATA wa_gpvaltab TYPE ty_gpvaltab.

DATA: v_temp_string(132),
      v_temp_string2(100),
      v_temp_string3(132),
      v_temp_string4(132),
      v_exit TYPE flag,
      v_report_wa(132),
      v_username(30),
      v_cat,
      v_index TYPE i,
      v_program TYPE prog_structure,
      v_dataele TYPE dd03l-rollname,
      v_table TYPE dd03l-tabname,
      v_field TYPE dd03l-fieldname,
      v_program_name(40) TYPE c,
      i_program LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      i_program_fmdata LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      i_texttab LIKE textpool OCCURS 200 WITH HEADER LINE,
      i_program_temp LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      i_program_temp2 LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      i_program_temp3 LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      i_program_temp4 LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      i_program_forms LIKE v_report_wa OCCURS 0 WITH HEADER LINE,
      v_textid(3) TYPE n VALUE '000',
      v_linecount(5) TYPE n,
      v_linecount1(5) TYPE n,
      wa_ko200 LIKE ko200.
****Changes Shastry
DATA: v_namespace TYPE rs38l-namespace,
      v_prgname TYPE trdir-name,
      v_wonamespace TYPE trdir-name,
      wa_trnsp_namespace TYPE trnsp_namespace,
      v_devlicense TYPE trnspacel-devlicense.
****END Changes
DATA: i_extdecrip(132) OCCURS 10 WITH HEADER LINE.

DATA: v_name TYPE vrm_id,
      v_ldbname        TYPE ldbnam,
      v_infty          TYPE infty,
      v_answer         TYPE c,
      i_list TYPE vrm_values,
      v_value LIKE LINE OF i_list.

DATA: BEGIN OF i_old_prog OCCURS 0,
        line(132) TYPE c,
      END OF i_old_prog.

DATA: BEGIN OF i_new_prog OCCURS 0,
        line(132) TYPE c,
      END OF i_new_prog.

DATA: BEGIN OF i_program_statement OCCURS 0,
        line(132) TYPE c,
      END OF i_program_statement.

DATA:
* Hold an entire statement, even if it spans multiple lines
  BEGIN OF i_prg_long_line OCCURS 0,
    start       TYPE i,
    end         TYPE i,
    code(5000)  TYPE c,
  END OF i_prg_long_line.

DATA: BEGIN OF i_tabname OCCURS 0,
        tabname LIKE dd02t-tabname,    " Table name
        tabdesc LIKE dd02t-ddtext, " Short text describing ABAP/4 Dictio
      END OF i_tabname.

* Queue to hold list of internal table names for commenting the ENDLOOP
* line
DATA: BEGIN OF i_itab_names OCCURS 0,
        tabname(40) TYPE c,
      END OF i_itab_names.

* Queue to hold list of table names for commenting the ENDSELECT line
DATA: BEGIN OF i_tab_names OCCURS 0,
        tabname(40) TYPE c,
      END OF i_tab_names.

DATA: BEGIN OF i_form_names OCCURS 0,
        tabname(40) TYPE c,
      END OF i_form_names.

* Internal table for IDoc structure
DATA i_idocstruc TYPE STANDARD TABLE OF edi_iapi02 INITIAL SIZE 0.
DATA wa_idocstruc TYPE edi_iapi02.
DATA i_idocstruc1 TYPE STANDARD TABLE OF edi_iapi06 INITIAL SIZE 0.
DATA wa_idocstruc1 TYPE edi_iapi06.

DATA i_fupararef     TYPE STANDARD TABLE OF fupararef INITIAL SIZE 0.
DATA i_fupararef_fm1 TYPE STANDARD TABLE OF fupararef INITIAL SIZE 0.
DATA i_fupararef_fm2 TYPE STANDARD TABLE OF fupararef INITIAL SIZE 0.
DATA i_fupararef_fm3 TYPE STANDARD TABLE OF fupararef INITIAL SIZE 0.
DATA i_fupararef_fm4 TYPE STANDARD TABLE OF fupararef INITIAL SIZE 0.
DATA wa_fupararef TYPE fupararef.

RANGES r_fieldlist FOR amrh-feld1.                          "Char 20
RANGES r_output_list FOR amrh-feld1.
RANGES r_joinset1 FOR amrh-feld1.
RANGES r_joinset2 FOR amrh-feld1.
RANGES r_joinset3 FOR amrh-feld1.

DATA wa_ranges LIKE LINE OF r_fieldlist.

* Function module Importing parameters
DATA i_importing TYPE STANDARD TABLE OF rsimp INITIAL SIZE 0.
DATA wa_importing TYPE rsimp.

* Function module Exporting parameters
DATA i_exporting TYPE STANDARD TABLE OF rsexp INITIAL SIZE 0.
DATA wa_exporting TYPE rsexp.

* Function module Changing parameters
DATA i_changing TYPE STANDARD TABLE OF rscha INITIAL SIZE 0.
DATA wa_changing TYPE rscha.

* Function module Tables parameters
DATA i_tables   TYPE STANDARD TABLE OF rstbl INITIAL SIZE 0.
DATA wa_tables TYPE rstbl.

* Function module exceptions
DATA i_exceptions TYPE STANDARD TABLE OF rsexc INITIAL SIZE 0.
DATA wa_exceptions TYPE rsexc.

* Function module importing parameters
DATA i_para_docu TYPE STANDARD TABLE OF rsfdo INITIAL SIZE 0.
DATA wa_para_docu TYPE rsfdo.

* Excel readers
DATA wa_excel_data TYPE ty_excel_data.
DATA i_excel_data TYPE STANDARD TABLE OF ty_excel_data INITIAL SIZE 0.

* Selection sceeen data
DATA wa_selection TYPE ty_selection.
DATA i_selection TYPE STANDARD TABLE OF ty_selection INITIAL SIZE 0.

* Processing logic data
DATA wa_processing TYPE ty_processing.
DATA i_processing TYPE STANDARD TABLE OF ty_processing INITIAL SIZE 0.

* Output data
DATA wa_output_data TYPE ty_output.
DATA i_output_data TYPE STANDARD TABLE OF ty_output INITIAL SIZE 0.

* FM data
DATA wa_fm TYPE ty_fm.
DATA i_fm TYPE STANDARD TABLE OF ty_fm INITIAL SIZE 0.

* Variable for Include name for created FM
DATA v_fminclude TYPE rs38l-include.

* Excel count
DATA v_cell_count TYPE i.
DATA v_row_count TYPE i.

*Main iXML factory
DATA: g_ixml TYPE REF TO if_ixml.
*XML data bytes size
DATA: g_xml_data_bytes TYPE i.
*XML data
DATA: g_xml_data(1000) OCCURS 0.
*Stream factory
DATA: g_streamfactory TYPE REF TO if_ixml_stream_factory.
*XML istream
DATA: g_istream TYPE REF TO if_ixml_istream.
*XML parser
DATA: g_parser TYPE REF TO if_ixml_parser.
*XML DOM object
DATA g_obj_dom_xml TYPE REF TO if_ixml_document.
DATA g_obj_excel_workbook TYPE REF TO if_ixml_element.
DATA v_obj_properties_element TYPE REF TO if_ixml_element.
DATA g_element TYPE REF TO if_ixml_element.
DATA g_obj_worksheet_collections TYPE REF TO if_ixml_node_collection.
DATA g_obj_worksheet_itr TYPE REF TO if_ixml_node_iterator.
DATA v_obj_worksheet_node TYPE REF TO if_ixml_node.
DATA v_obj_worksheet_element TYPE REF TO if_ixml_element.
DATA v_obj_cell_collections TYPE REF TO if_ixml_node_collection.
DATA v_obj_table_element TYPE REF TO if_ixml_element.
DATA v_obj_row_collections TYPE REF TO if_ixml_node_collection.
DATA v_obj_row_itr TYPE REF TO if_ixml_node_iterator.
DATA v_obj_row_node TYPE REF TO if_ixml_node.
DATA v_obj_row_element TYPE REF TO if_ixml_element.
DATA v_obj_cell_itr TYPE REF TO if_ixml_node_iterator.
DATA v_obj_cell_node TYPE REF TO if_ixml_node.
DATA v_obj_cell_element TYPE REF TO if_ixml_element.
DATA v_obj_data_element TYPE REF TO if_ixml_element.
DATA g_excel_workbook_name TYPE string.
DATA v_worksheet_ss_name TYPE string.
DATA v_author TYPE string.
DATA v_count_worksheets TYPE i.
DATA v_fm1 TYPE tfdir-funcname.
DATA v_fm2 TYPE tfdir-funcname.
DATA v_fm3 TYPE tfdir-funcname.
DATA v_fm4 TYPE tfdir-funcname.
DATA v_fmgrp TYPE char26.
DATA v_fmrfc TYPE c.
DATA: v_type(8) TYPE c.
DATA: v_ttype(55) TYPE c.

*$*$------------------------------------------------------------------
*$*$ Macro Definitions
*$*$------------------------------------------------------------------

DEFINE add_macro_line.
  clear v_report_wa.
  v_report_wa = &1.
*  translate v_report_wa using '~_'.
  append v_report_wa to i_program.
END-OF-DEFINITION.

DEFINE add_macro_line_temp.
  clear v_report_wa.
  v_report_wa = &1.
*  translate v_report_wa using '~_'.
  append v_report_wa to i_program_temp.
END-OF-DEFINITION.

DEFINE add_macro_line_forms.
  clear v_report_wa.
  v_report_wa = &1.
*  translate v_report_wa using '~_'.
  append v_report_wa to i_program_forms.
END-OF-DEFINITION.

DEFINE add_report_texts.

*  read table i_texttab with key entry = &3 transporting no fields.
*  if sy-subrc eq 0.
*    v_textid = v_textid - 1.
*    exit.
*  endif.

  clear i_texttab.
  i_texttab-id    = &1.                  "Text Type
  i_texttab-key   = &2.                  "Text Key
  if &1 = 'S'.
    i_texttab-entry+8 = &3.              "Text value
  else.
    i_texttab-entry = &3.                "Text value
  endif.
  append i_texttab.
END-OF-DEFINITION.

DEFINE add_subroutine_title.
  add_macro_line_forms space.
  add_macro_line_forms text-100.
  concatenate p_sub &1 into v_temp_string2.
  concatenate 'Form' v_temp_string2
                        into v_temp_string2 separated by space.
  concatenate '*$*$' v_temp_string2
        into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms text-100.
  concatenate v_temp_string2 c_dot into v_temp_string.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms space.
END-OF-DEFINITION.

* Blank line
DEFINE blankline.
*  Selection-Screen Uline.
  add_macro_line 'Selection-Screen Skip 1.'.
END-OF-DEFINITION.

* Begin of Block
DEFINE beginblock.
  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Begin Of Block' &1
            'With Frame Title' v_temp_string
            into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
END-OF-DEFINITION.

* End of Block
DEFINE endblock.
  add_macro_line space.
  concatenate 'Selection-Screen End Of Block' &1
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
  add_macro_line space.
END-OF-DEFINITION.

* Parameter
DEFINE param.

  add_macro_line space.
  clear v_temp_string2.

* Form parameter name
  if &4 eq 'DATUM' or &4 eq 'UZEIT'.           "For date and time fields
    concatenate p_para &1 into v_temp_string2. "Use name from the SelScr
    clear v_temp_string2+8.

  else.
    if &1 is not initial.
      concatenate p_para &1 into v_temp_string2.  "Use name from selscr
      clear v_temp_string2+8.
    else.
      concatenate p_para &4 into v_temp_string2.  "Use field
      clear v_temp_string2+8.
    endif.

  endif.

  concatenate text-c00 "'* Parameter:'
              &2 into v_temp_string separated by space.
  add_macro_line v_temp_string.

  add_macro_line 'Selection-Screen Begin Of Line.'.

  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Comment 2(25)' v_temp_string
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.

  if   ( &1 eq 'LFUP' or &1 eq 'LFDL' or &1 eq 'AFUPD'
      or &1 eq'AFDLD' or &1 eq 'AFUPF' or &1 eq'AFDLF' ).
    clear v_temp_string2.
    v_temp_string = 'RLGRAP-FILENAME'.
    concatenate p_para &1 into v_temp_string2(8).
  else.
    concatenate &3 &4 into v_temp_string separated by '-'.
  endif.


  concatenate 'Parameter' v_temp_string2 'type' v_temp_string
                  into v_temp_string separated by space.

  if &5 eq 'Y'.  "If Obligatory
    concatenate v_temp_string 'obligatory'
                        into v_temp_string separated by space.
  endif.

  if &6 ne space.      "Default value
    if &6 cs 'SY-'.
      concatenate v_temp_string 'default' &6
                    into v_temp_string separated by space.
    else.
      concatenate v_temp_string 'default'
                text-121 into v_temp_string separated by space.
      concatenate v_temp_string &6 text-121 into v_temp_string.
    endif.
  endif.

  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
  clear v_temp_string.

  add_macro_line 'Selection-Screen End Of Line.'.

END-OF-DEFINITION.

* Select Options
DEFINE soptions.
  add_macro_line space.
  clear v_temp_string2.

* Form Select option name
  if &4 eq 'DATUM' or &4 eq 'UZEIT'.           "For date and time fields
    concatenate p_sopt &1 into v_temp_string2. "Use name from the SelScr
    clear v_temp_string2+8.

  else.
    if &1 is not initial.
      concatenate p_sopt &1 into v_temp_string2.     "Use name
      clear v_temp_string2+8.
    else.
      concatenate p_sopt &4 into v_temp_string2.     "Use field
      clear v_temp_string2+8.
    endif.

* Variable declaration for SO
    append initial line to i_program_temp2.
    concatenate text-005 "'* Variable declaration for Select-Option:'
                 v_temp_string2 into v_temp_string separated by space.
    append v_temp_string to i_program_temp2.
    concatenate &3 &4 into v_temp_string separated by '-'.
    concatenate 'type' v_temp_string
          into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    concatenate &4 v_temp_string into v_temp_string separated by space.
    concatenate p_glob v_temp_string into v_temp_string.
    concatenate 'Data' v_temp_string
            into v_temp_string separated by space.
    append v_temp_string to i_program_temp2.
  endif.

  concatenate text-c02 "'* Select Options:'
              v_temp_string2
                            into v_temp_string separated by space.
  add_macro_line v_temp_string.

  add_macro_line 'Selection-Screen Begin Of Line.'.

  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Comment 2(22)' v_temp_string
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.

  concatenate p_glob &4 into v_temp_string.

  concatenate 'Select-Options' v_temp_string2 'for' v_temp_string
                              into v_temp_string separated by space.

  if &5 eq 'Y'.       "Obligatory
    concatenate v_temp_string 'Obligatory'
                  into v_temp_string separated by space.
  endif.

  if &6 ne space.      "Default value
    if &6 cs 'SY-'.
      concatenate v_temp_string 'default' &6
                  into v_temp_string separated by space.
    else.
      concatenate v_temp_string 'default' text-121
                into v_temp_string separated by space.
      concatenate v_temp_string &6 text-121 into v_temp_string.
    endif.
  endif.

  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
  add_macro_line 'Selection-Screen End Of Line.'.

END-OF-DEFINITION.

* Radio Button
DEFINE radioleft.
  add_macro_line space.
  concatenate text-c03 "'* Radio Button:'
              &2
              into v_temp_string separated by space.
  add_macro_line v_temp_string.

  add_macro_line 'Selection-Screen Begin Of Line.'.
  add_macro_line 'Selection-Screen Position &1.'.

  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Comment 2(20)' v_temp_string
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
  clear v_temp_string.
  concatenate p_radio &3 into v_temp_string(8).

  if &5 eq space. "default value
    concatenate 'Parameter' v_temp_string 'RadioButton Group' &4
                c_dot into v_temp_string separated by space.
  else.
    concatenate 'Parameter' v_temp_string 'RadioButton Group' &4
             'default' text-121 into v_temp_string separated by space.
    concatenate v_temp_string 'X' text-121 c_dot into v_temp_string.
  endif.

  add_macro_line v_temp_string.
  add_macro_line 'Selection-Screen End Of Line.'.
END-OF-DEFINITION.

DEFINE radioright.
  add_macro_line space.
  concatenate text-c03 "'* Radio Button:'
              &2
            into v_temp_string separated by space.
  add_macro_line v_temp_string.

  add_macro_line 'Selection-Screen Begin Of Line.'.
  add_macro_line 'Selection-Screen Position &1.'.
  clear v_temp_string.
  concatenate p_radio &3 into v_temp_string(8).

  if &5 eq space. "default value
    concatenate 'Parameter' v_temp_string 'RadioButton Group' &4
                c_dot into v_temp_string separated by space.
  else.
    concatenate 'Parameter' v_temp_string 'RadioButton Group' &4
             'default' text-121 into v_temp_string separated by space.
    concatenate v_temp_string 'X' text-121 c_dot into v_temp_string.
  endif.

  add_macro_line v_temp_string.

  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Comment 2(20)' v_temp_string
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
  add_macro_line 'Selection-Screen End Of Line.'.
END-OF-DEFINITION.

* Check Box
DEFINE checkleft.
  add_macro_line space.
  concatenate text-c05 "'* Check Box:'
              &2 into v_temp_string separated by space.
  add_macro_line v_temp_string.

  add_macro_line 'Selection-Screen Begin Of Line.'.
  add_macro_line 'Selection-Screen Position &1.'.

  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Comment 2(20)' v_temp_string
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.

  clear v_temp_string.
  concatenate p_chbox &3 into v_temp_string(8).

  if &4 eq space. "default value
    concatenate 'Parameter' v_temp_string 'as Checkbox.'
                into v_temp_string separated  by space.
  else.
    concatenate 'Parameter' v_temp_string 'as Checkbox default'
                text-121 into v_temp_string separated  by space.
    concatenate v_temp_string 'X' text-121 c_dot into v_temp_string.
  endif.

  add_macro_line v_temp_string.
  add_macro_line 'Selection-Screen End Of Line.'.
END-OF-DEFINITION.

DEFINE checkright.
  add_macro_line space.
  concatenate text-c05 "'* Check Box:'
              &2 into v_temp_string separated by space.
  add_macro_line v_temp_string.

  add_macro_line 'Selection-Screen Begin Of Line.'.
  add_macro_line 'Selection-Screen Position &1.'.

  clear v_temp_string.
  concatenate p_chbox &3 into v_temp_string(8).
  if &4 eq space. "default value
    concatenate 'Parameter' v_temp_string 'as Checkbox.'
                into v_temp_string separated  by space.
  else.
    concatenate 'Parameter' v_temp_string 'as Checkbox default'
                text-121 into v_temp_string separated  by space.
    concatenate v_temp_string 'X' text-121 c_dot into v_temp_string.
  endif.
  add_macro_line v_temp_string.

  v_textid = v_textid + 1.
  concatenate 'text' v_textid into v_temp_string separated by '-'.
  add_report_texts 'I' v_textid &2.

  concatenate 'Selection-Screen Comment 2(20)' v_temp_string
              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line v_temp_string.
  add_macro_line 'Selection-Screen End Of Line.'.
END-OF-DEFINITION.

DEFINE atselectionscr.

  add_macro_line_temp space.
  concatenate text-c07 "'*$*$ Validate'
              &1 into v_temp_string separated by space.
  add_macro_line_temp v_temp_string.

  if &5 is initial.        "If name is not present
    v_temp_string2 = &3.   "Use field
  else.
    v_temp_string2 = &5.
  endif.

  if &4 eq 'P'.
    concatenate p_para v_temp_string2 into v_temp_string3.
  elseif &4 eq 'S'.
    concatenate p_sopt v_temp_string2 into v_temp_string3.
  endif.

  concatenate 'At Selection-Screen ON ' v_temp_string3
                into v_temp_string separated by space.

  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_temp v_temp_string.

  concatenate p_sub 'VALIDATE_' into v_temp_string.
  concatenate 'Perform' v_temp_string
                        into v_temp_string separated by space.
  concatenate v_temp_string v_temp_string2 into v_temp_string.

  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_temp v_temp_string.

  concatenate 'VALIDATE_' v_temp_string2 into v_temp_string.
  add_subroutine_title v_temp_string.

  concatenate &2 &3 into v_temp_string separated by '-'.
  concatenate p_loc &3 into v_temp_string2.

  concatenate  'Data' v_temp_string2 'type' v_temp_string into
               v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms space.

  add_macro_line_forms text-c08 . "'* Check for initial value before validating'.
  concatenate 'Check not' v_temp_string3 'is initial.'
  into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms space.

  concatenate text-c09 "'* Select'
              &1 text-cc9 "'for validation'
                            into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.

  if &4 eq 'P'.
    concatenate 'Select Single' &3
              into v_temp_string separated by space.
  else.
    concatenate 'Select' &3 'Up to 1 rows'
                            into v_temp_string separated by space.
  endif.

  add_macro_line_forms v_temp_string.
  concatenate 'From' &2 'Into' v_temp_string2
                            into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.

* Improvise syntax depending on parameter or Select Options
  if &4 eq 'P'.
    concatenate 'Where' &3 'eq' v_temp_string3
                            into v_temp_string  separated by space.
  else.
    concatenate 'Where' &3 'in' v_temp_string3
                            into v_temp_string  separated by space.
  endif.

  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_forms v_temp_string.
  if &4 eq 'S'.
    add_macro_line_forms 'Endselect.'.
  endif.

  add_macro_line_forms space.
  add_macro_line_forms text-c10.
  "'* Stop processing and issue error message in case of error'.
  add_macro_line_forms 'If sy-subrc ne 0.'.
  concatenate 'Message e398(00) with' text-120
   into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.
  add_report_texts 'I' 'E02' 'Incorrect entry for'.

  clear v_temp_string.

*  v_textid = v_textid + 1.
*  add_report_texts 'I' v_textid &1.

*  break sagarwala.
*  read table i_texttab with key entry = &1.
*  if sy-subrc eq 0.
*  concatenate text-121 &1 text-121 '(' i_texttab-key ')'
*                                into v_temp_string+15.
*  else.
  concatenate text-121 &1 text-121 '(' v_textid ')'
                                into v_temp_string+15.
*  endif.

  concatenate v_temp_string 'space space'
                  into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms 'Endif.'.
  add_macro_line_forms space.
  add_macro_line_forms 'Endform.'.

END-OF-DEFINITION.

DEFINE valuerequest.
  add_macro_line_temp space.

  concatenate p_para &1 into v_temp_string2.

  concatenate text-c11 "'*$*$ F4 help on Screen field'
              v_temp_string2
                          into v_temp_string separated by space.
  add_macro_line_temp v_temp_string.

  concatenate 'At Selection-Screen ON Value-Request for'
            v_temp_string2 into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_temp v_temp_string.

  if &1 eq 'LFUP'.
    concatenate 'Perform F4_Local_uploadfile using' v_temp_string2
                into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_temp v_temp_string.

  elseif &1 eq 'LFDL'.

    concatenate 'Perform F4_Local_downloadfile using' v_temp_string2
                into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_temp v_temp_string.

  elseif &1 eq 'AFUPF'.
    concatenate 'AFUPD' v_temp_string2
                            into v_temp_string2 separated by space.
    concatenate p_para v_temp_string2 into v_temp_string2.
    concatenate 'Perform F4_appfile using' v_temp_string2
                into v_temp_string separated by space.
    concatenate text-121 p_para 'AFUPD' text-121 into v_temp_string2.
    concatenate v_temp_string v_temp_string2 into v_temp_string
                                                separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_temp v_temp_string.

*  elseif &1 eq 'AFDLF'.
*    concatenate 'AFDLD' v_temp_string2
*                            into v_temp_string2 separated by space.
*    concatenate p_para v_temp_string2 into v_temp_string2.
*    concatenate 'Perform F4_appfile using' v_temp_string2
*                into v_temp_string separated by space.
**    concatenate text-121 p_para 'AFDLD' text-121 into v_temp_string2.
**    concatenate v_temp_string v_temp_string2 into v_temp_string
**                                                separated by space.
*    concatenate v_temp_string c_dot into v_temp_string.
*    add_macro_line_temp v_temp_string.

  elseif &1 eq 'ALVV'.

    concatenate 'Perform f4_for_variant using' p_wa
                            into v_temp_string separated by space.
    concatenate v_temp_string 'variant' into v_temp_string.
    concatenate v_temp_string v_temp_string2
                            into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_temp v_temp_string.

  endif.

END-OF-DEFINITION.

DEFINE create_data.

  clear v_temp_string.
  concatenate &2 c_hyphen &3 c_comma into v_temp_string2.

  if not &1 is initial.
    v_temp_string+10 = &1.
  else.
    v_temp_string+10 = &3.
  endif.

  v_temp_string+26 = 'TYPE'.
  v_temp_string+32 = v_temp_string2.
  v_temp_string+54 = c_quotes.

  if not &4 is initial.
    v_temp_string+55(16) = &4.
  else.
    select single scrtext_m into v_temp_string+55(16)
    from dd03vt where tabname eq &2 and fieldname eq &3
    and ddlanguage eq sy-langu. "'EN'.
  endif.
  add_macro_line v_temp_string.

END-OF-DEFINITION.

*****Changes by Shastry
DEFINE create_data_dele.

*  clear v_temp_string.
*  concatenate &3 c_comma into v_temp_string2.
*
*  if not &1 is initial.
*    v_temp_string+10 = &1.
*  else.
*    v_temp_string+10 = &3.
*  endif.
*
*  v_temp_string+26 = 'TYPE'.
*  v_temp_string+32 = v_temp_string2.
*  v_temp_string+54 = c_quotes.
*
*  if not &4 is initial.
*    v_temp_string+55(16) = &4.
*  else.
*    select single scrtext_m into v_temp_string+55(16)
*    from dd04t where rollname eq &3
*    and ddlanguage eq sy-langu. "'EN'.
*  endif.
*  add_macro_line v_temp_string.

  select single rollname into v_dataele
  from dd03l where tabname eq &2 and fieldname eq &3.

  clear v_temp_string.
  concatenate v_dataele c_comma into v_temp_string2.
  clear v_dataele.
  if not &1 is initial.
    v_temp_string+10 = &1.
  else.
    v_temp_string+10 = &3.
  endif.

  v_temp_string+26 = 'TYPE'.
  v_temp_string+32 = v_temp_string2.
  v_temp_string+54 = c_quotes.

  if not &4 is initial.
    v_temp_string+55(16) = &4.
  else.
    select single scrtext_m into v_temp_string+55(16)
    from dd03vt where tabname eq &2 and fieldname eq &3
    and ddlanguage eq sy-langu. "'EN'.
  endif.
  add_macro_line v_temp_string.

END-OF-DEFINITION.

*****End Changes
DEFINE create_data_type.

  clear v_temp_string.

  if &3 eq space.
    concatenate &2 c_comma into v_temp_string2.
    v_temp_string+10 = &1.
    v_temp_string+26 = 'TYPE'.
    v_temp_string+32 = v_temp_string2.

  else.

    concatenate &1 '(' &3 ')' into v_temp_string2.

    v_temp_string+10 = v_temp_string2.
    v_temp_string+26 = 'TYPE'.

    concatenate &2 c_comma into v_temp_string2.
    v_temp_string+32 = v_temp_string2.

  endif.

  v_temp_string+54 = c_quotes.

  if &4 ne space.
    v_temp_string+55(16) = &4.
  else.
    v_temp_string+55(16) = &2.
  endif.

  add_macro_line v_temp_string.


END-OF-DEFINITION.

DEFINE add_where_addition.

  if not &4 is initial. "Blank clause..happens sometimes

    clear v_temp_string2.
    if &3 is initial.           "No parameter name from sel scr
      concatenate &1 &2 into v_temp_string2(8).
    else.
      concatenate &1 &3 into v_temp_string2(8).
    endif.

    if v_temp_string is initial.

      if &5 is not initial.            "join condition
        concatenate &4 '~' &2 into v_temp_string.
      else.
        v_temp_string = &2.
      endif.

      if &1 eq p_para.
        concatenate ' Where' v_temp_string 'eq' v_temp_string2
                                into v_temp_string separated by space.
      else.
        concatenate ' Where' v_temp_string 'in' v_temp_string2
                                into v_temp_string separated by space.
      endif.
    else.

      if &5 is not initial.            "join condition
        concatenate &4 '~' &2 into v_temp_string.
      else.
        v_temp_string = &2.
      endif.

      if &1 eq p_para.
        concatenate '   And' v_temp_string 'eq' v_temp_string2
                      into v_temp_string separated by space.
      else.
        concatenate '   And' v_temp_string 'in' v_temp_string2
                      into v_temp_string separated by space.
      endif.

    endif.

    v_temp_string+48 = '"'.
    select single scrtext_m into v_temp_string+49
    from dd03vt where tabname eq &4 and fieldname eq &2
    and ddlanguage eq sy-langu. "'EN'.

    add_macro_line_forms v_temp_string.

  endif.

END-OF-DEFINITION.

DEFINE add_fae_addition.

  if &4 is not initial.    "Join condition exists
* Read and other options are not working in macro. So looping
    loop at r_fieldlist into wa_ranges.
      if wa_ranges-low eq &1.       "Get the table name
        concatenate wa_ranges-high wa_ranges-low into v_temp_string2
                  separated by '~'.
        exit.
      endif.
    endloop.

    concatenate v_temp_string2 'eq' p_itab
                        into v_temp_string2 separated by space.
    concatenate v_temp_string2 &2 into v_temp_string2.
    concatenate v_temp_string2 '-' &1 into v_temp_string2.

    if v_temp_string is initial.    "add Where addition
      concatenate 'Where' v_temp_string2
                        into v_temp_string+1 separated by space.
    else.                           "add AND addition
      clear v_temp_string.
      concatenate 'And' v_temp_string2
                        into v_temp_string+3 separated by space.
    endif.

    v_temp_string2 = wa_ranges-high."table name for use in select later

  else.                      "No Join
    concatenate &1 'eq' p_itab into v_temp_string2 separated by space.
    concatenate v_temp_string2 &2 into v_temp_string2.
    concatenate v_temp_string2 '-' &1 into v_temp_string2.

    if v_temp_string is initial.    "add Where addition
      concatenate 'Where' v_temp_string2
              into v_temp_string+1 separated by space.
    else.                           "add AND addition
      clear v_temp_string.
      concatenate 'And' v_temp_string2
            into v_temp_string+3 separated by space.
    endif.

    v_temp_string2 = &3.        "table name to be used in select later

  endif.

  v_temp_string+48 = '"'.
  select single scrtext_m into v_temp_string+49
  from dd03vt where tabname eq v_temp_string2 and fieldname eq &1
  and ddlanguage eq sy-langu. "'EN'.

  add_macro_line_forms v_temp_string.

* for Sort statement fields
  concatenate v_temp_string3 &1 into v_temp_string3 separated by space.

* Read logic
  if i_program_temp2[] is initial.
    append initial line to i_program_temp2.
    concatenate text-c12 "'* Read data from table'
                 &3
                text-036 "'and populate the output table'
                 into v_temp_string2 separated by space.
    append v_temp_string2 to i_program_temp2.

    if &6 is not initial.
      concatenate &3 &4 &5 &6 into v_temp_string4 separated by '_'.
    elseif &5 is not initial.
      concatenate &3 &4 &5 into v_temp_string4 separated by '_'.
    elseif &4 is not initial.
      concatenate &3 &4 into v_temp_string4 separated by '_'.
    else.
      v_temp_string4 = &3.
    endif.

    concatenate p_itab v_temp_string4 into v_temp_string4.
    concatenate 'Read table' v_temp_string4 'into' p_wa
                            into v_temp_string2 separated by space.
    shift v_temp_string4 left deleting leading p_itab.
    concatenate v_temp_string2 v_temp_string4 into v_temp_string2.
    concatenate v_temp_string2 'with key'
            into v_temp_string2 separated by space.
    append v_temp_string2 to i_program_temp2.
    clear v_temp_string2.
    concatenate &1 '=' p_wa into v_temp_string2+20 separated by space.
    concatenate v_temp_string2 &2 '-' &1 into v_temp_string2.
    append v_temp_string2 to i_program_temp2.
  else.
    clear v_temp_string2.
    concatenate &1 '=' p_wa into v_temp_string2+20 separated by space.
    concatenate v_temp_string2 &2 '-' &1 into v_temp_string2.
    append v_temp_string2 to i_program_temp2.
  endif.

END-OF-DEFINITION.

** Create Group Validation logic
DEFINE create_grpval.

  add_macro_line_temp space.
  concatenate text-c13 "'*$*$ Validate Data Combination from table'
              &1
              into v_temp_string separated by space.
  add_macro_line_temp v_temp_string.

  concatenate p_sub 'VALIDATE_COMBINATION_' into v_temp_string.
  concatenate 'Perform' v_temp_string
                        into v_temp_string separated by space.
  concatenate v_temp_string &1 into v_temp_string.

  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_temp v_temp_string.

  concatenate 'VALIDATE_COMBINATION_' &1 into v_temp_string.
  add_subroutine_title v_temp_string.

  clear: v_temp_string2, v_temp_string, v_temp_string3.

  concatenate p_loc &2(10) into v_temp_string2.
  concatenate &1 '-' &2(10) into v_temp_string3.
  concatenate 'Data' v_temp_string2 'type' v_temp_string3
                               into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.

  add_macro_line_forms v_temp_string.
  clear: v_temp_string2, v_temp_string, v_temp_string3.

  concatenate p_loc &3(10) into v_temp_string2.
  concatenate &1 '-' &3(10) into v_temp_string3.
  concatenate 'Data' v_temp_string2 'type' v_temp_string3
                              into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_forms v_temp_string.

  if &4 is not initial.
    clear: v_temp_string2, v_temp_string, v_temp_string3.
    concatenate p_loc &4(10) into v_temp_string2.
    concatenate &1 '-' &4(10) into v_temp_string3.
    concatenate 'Data' v_temp_string2 'type' v_temp_string3
                              into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
  endif.

  if &5 is not initial.
    clear: v_temp_string2, v_temp_string, v_temp_string3.
    concatenate p_loc &5(10) into v_temp_string2.
    concatenate &1 '-' &5(10) into v_temp_string3.
    concatenate 'Data' v_temp_string2 'type' v_temp_string3
                              into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
  endif.
  if &6 is not initial.
    clear: v_temp_string2, v_temp_string, v_temp_string3.
    concatenate p_loc &6(10) into v_temp_string2.
    concatenate &1 '-' &6(10) into v_temp_string3.
    concatenate 'Data' v_temp_string2 'type' v_temp_string3
                              into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
  endif.
  if &7 is not initial.
    clear: v_temp_string2, v_temp_string, v_temp_string3.
    concatenate p_loc &7(10) into v_temp_string2.
    concatenate &1 '-' &7(10) into v_temp_string3.
    concatenate 'Data' v_temp_string2 'type' v_temp_string3
                              into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
  endif.

  add_macro_line_forms space.
  concatenate text-c14 "'* Select data from'
              &1
              text-047 "'for combination validation'
                              into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.
  concatenate 'Select Single' &2(10)
                              into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.

  clear v_temp_string.

* 2nd field
  v_temp_string+14 = &3(10).
  add_macro_line_forms v_temp_string.

  if &4 is not initial.
    v_temp_string+14 = &4(10).
    add_macro_line_forms v_temp_string.
  endif.
  if &5 is not initial.
    v_temp_string+14 = &5(10).
    add_macro_line_forms v_temp_string.
  endif.
  if &6 is not initial.
    v_temp_string+14 = &6(10).
    add_macro_line_forms v_temp_string.
  endif.
  if &7 is not initial.
    v_temp_string+14 = &7(10).
    add_macro_line_forms v_temp_string.
  endif.
  concatenate p_loc &2(10) into v_temp_string3.
  concatenate '(' v_temp_string3 c_comma into v_temp_string3.
  concatenate 'From' &1 'Into' v_temp_string3
          into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.
  clear v_temp_string.
  clear v_temp_string3.
  concatenate p_loc &3(10) into v_temp_string3.
  v_temp_string+14 = v_temp_string3.
  if &4 is initial.
    concatenate v_temp_string ')' into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
  else.
    concatenate v_temp_string c_comma into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
    clear v_temp_string3.
    concatenate p_loc &4(10) into v_temp_string3.
    v_temp_string+14 = v_temp_string3.
  endif.
  if &5 is initial.
    if v_temp_string is not initial.
      concatenate v_temp_string ')'  into v_temp_string.
      add_macro_line_forms v_temp_string.
      clear v_temp_string.
    endif.
  else.
    concatenate v_temp_string c_comma into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
    clear v_temp_string3.
    concatenate p_loc &5(10) into v_temp_string3.
    v_temp_string+14 = v_temp_string3.
  endif.
  if &6 is initial.
    if v_temp_string is not initial.
      concatenate v_temp_string ')' into v_temp_string.
      add_macro_line_forms v_temp_string.
      clear v_temp_string.
    endif.
  else.
    concatenate v_temp_string c_comma into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
    clear v_temp_string3.
    concatenate p_loc &6(10) into v_temp_string3.
    v_temp_string+14 = v_temp_string3.
  endif.
  if &7 is initial.
    if v_temp_string is not initial.
      concatenate v_temp_string ')' into v_temp_string.
      add_macro_line_forms v_temp_string.
      clear v_temp_string.
    endif.
  else.
    concatenate v_temp_string c_comma into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
    clear v_temp_string3.
    concatenate p_loc &7(10) into v_temp_string3.
    v_temp_string+14 = v_temp_string3.
    concatenate v_temp_string ')' into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
  endif.

* Improvise syntax depending on parameter or Select Options
  if &2+10(1) eq 'P'.

    if &2+11(6) is initial.        "Name from sel scr is blank
      concatenate p_para &2(10) into v_temp_string2.
    else.
      concatenate p_para &2+11(6) into v_temp_string2.
    endif.

    concatenate 'Where' &2(10) '=' v_temp_string2
                          into v_temp_string separated by space.
  else.

    if &2+11(6) is initial.        "Name from sel scr is blank
      concatenate p_sopt &2(10) into v_temp_string2.
    else.
      concatenate p_sopt &2+11(6) into v_temp_string2.
    endif.

    concatenate 'Where' &2(10) 'in' v_temp_string2
                          into v_temp_string separated by space.
  endif.

  add_macro_line_forms v_temp_string.

  if &3+10(1) eq 'P'.

    if &3+11(6) is initial.        "Name from sel scr is blank
      concatenate p_para &3(10) into v_temp_string2.
    else.
      concatenate p_para &3+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &3(10) '=' v_temp_string2
                            into v_temp_string separated by space.
  else.

    if &3+11(6) is initial.        "Name from sel scr is blank
      concatenate p_sopt &3(10) into v_temp_string2.
    else.
      concatenate p_sopt &3+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &3(10) 'in' v_temp_string2
                            into v_temp_string separated by space.
  endif.

* 3rd field
  if &4+10(1) eq 'P'.
    add_macro_line_forms v_temp_string.

    if &4+11(6) is initial.        "Name from sel scr is blank
      concatenate p_para &4(10) into v_temp_string2.
    else.
      concatenate p_para &4+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &4(10) '=' v_temp_string2
                              into v_temp_string separated by space.
  elseif &4+10(1) eq 'S'.

    add_macro_line_forms v_temp_string.

    if &4+11(6) is initial.        "Name from sel scr is blank
      concatenate p_sopt &4(10) into v_temp_string2.
    else.
      concatenate p_sopt &4+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &4(10) 'in' v_temp_string2
                          into v_temp_string separated by space.

  elseif &4 is initial.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
    clear v_temp_string.
  endif.

* 4th field
  if &5+10(1) eq 'P'.
    add_macro_line_forms v_temp_string.

    if &5+11(6) is initial.        "Name from sel scr is blank
      concatenate p_para &5(10) into v_temp_string2.
    else.
      concatenate p_para &5+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &5(10) '=' v_temp_string2
                           into v_temp_string separated by space.

  elseif &5+10(1) eq 'S'.
    add_macro_line_forms v_temp_string.

    if &5+11(6) is initial.        "Name from sel scr is blank
      concatenate p_sopt &5(10) into v_temp_string2.
    else.
      concatenate p_sopt &5+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &5(10) 'in' v_temp_string2
                    into v_temp_string separated by space.

  elseif &5 is initial.
    if v_temp_string is not initial.
      concatenate v_temp_string c_dot into v_temp_string.
      add_macro_line_forms v_temp_string.
      clear v_temp_string.
    endif.
  endif.

* 5th field
  if &6+10(1) eq 'P'.
    add_macro_line_forms v_temp_string.

    if &6+11(6) is initial.        "Name from sel scr is blank
      concatenate p_para &6(10) into v_temp_string2.
    else.
      concatenate p_para &6+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &6(10) '=' v_temp_string2
                      into v_temp_string separated by space.

  elseif &6+10(1) eq 'S'.
    add_macro_line_forms v_temp_string.

    if &6+11(6) is initial.        "Name from sel scr is blank
      concatenate p_sopt &6(10) into v_temp_string2.
    else.
      concatenate p_sopt &6+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &6(10) 'in' v_temp_string2
                        into v_temp_string separated by space.
  elseif &6 is initial.
    if v_temp_string is not initial.
      concatenate v_temp_string c_dot into v_temp_string.
      add_macro_line_forms v_temp_string.
      clear v_temp_string.
    endif.
  endif.

* 6th Field
  if &7+10(1) eq 'P'.
    add_macro_line_forms v_temp_string.

    if &7+11(6) is initial.        "Name from sel scr is blank
      concatenate p_para &7(10) into v_temp_string2.
    else.
      concatenate p_para &7+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &7(10) '=' v_temp_string2
              into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.

  elseif &7+10(1) eq 'S'.
    add_macro_line_forms v_temp_string.

    if &7+11(6) is initial.        "Name from sel scr is blank
      concatenate p_sopt &7(10) into v_temp_string2.
    else.
      concatenate p_sopt &7+11(6) into v_temp_string2.
    endif.

    concatenate '  And' &7(10) 'in' v_temp_string2
                into v_temp_string separated by space.
    concatenate v_temp_string c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.

  elseif &7 is initial.
    if v_temp_string is not initial.
      concatenate v_temp_string c_dot into v_temp_string.
      add_macro_line_forms v_temp_string.
      clear v_temp_string.
    endif.
  endif.

  add_macro_line_forms space.
  add_macro_line_forms text-c10.
  "'* Stop processing and issue error message in case of error'.
  add_macro_line_forms 'If sy-subrc ne 0.'.
  concatenate 'Message e398(00) with' text-056
                        into v_temp_string separated by space.
  add_macro_line_forms v_temp_string.
  add_report_texts 'I' 'E01' 'Invalid data combination from table'.

  v_textid = v_textid + 1.
  add_report_texts 'I' v_textid &1.

  clear v_temp_string.
  concatenate text-121 v_temp_string &1 text-121
                      '(' v_textid ')' into v_temp_string+15.
  concatenate v_temp_string 'space space'
                 into v_temp_string separated by space.
  concatenate v_temp_string c_dot into v_temp_string.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms 'Endif.'.
  add_macro_line_forms space.
  add_macro_line_forms 'Endform.'.

END-OF-DEFINITION.

*Write logic for populating the final internal table
*The final internal table either produces a report output
*or writes an output file or does both
DEFINE loop_at_table.

  if p_lfdl eq c_on
  or p_afdl eq c_on
  or p_alv  eq c_on.
    add_macro_line_temp space.
    add_macro_line_forms text-c16.
    "'* Populate data into final output internal table'.
    read table i_processing into wa_processing index 1.

    if wa_processing-j3table is not initial.
      concatenate wa_processing-table wa_processing-j1table
                  wa_processing-j2table wa_processing-j3table
             into v_temp_string separated by '_'.

    elseif wa_processing-j2table is not initial.
      concatenate wa_processing-table wa_processing-j1table
                  wa_processing-j2table into
                  v_temp_string separated by '_'.

    elseif wa_processing-j1table is not initial.
      concatenate wa_processing-table wa_processing-j1table
                       into v_temp_string separated by '_'.
    else.
      v_temp_string = wa_processing-table.
    endif.

    v_temp_string3 = v_temp_string.
    concatenate p_itab v_temp_string into v_temp_string.

    concatenate 'Loop at' v_temp_string 'into' p_wa
                          into v_temp_string separated by space.
    concatenate v_temp_string v_temp_string3
                                c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
  endif.

  loop at i_output_data into wa_output_data.

    if wa_output_data-name is initial.
      concatenate p_wa 'outdata' c_hyphen
                          wa_output_data-field into v_temp_string.
    else.
      concatenate p_wa 'outdata' c_hyphen
                          wa_output_data-name into v_temp_string.
    endif.
    concatenate c_star v_temp_string '='
                              into v_temp_string separated by space.
    add_macro_line_forms v_temp_string.

  endloop.

  if p_lfdl eq c_on
  or p_afdl eq c_on
  or p_alv  eq c_on.

    add_macro_line_forms space.
    append lines of i_program_temp4 to i_program_forms.

    add_macro_line_forms space.
    concatenate p_wa 'outdata' into v_temp_string.
    concatenate 'Append' v_temp_string 'to' p_itab
                              into v_temp_string separated by space.
    concatenate v_temp_string 'outdata' c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
    concatenate 'clear' p_wa into v_temp_string separated by space.
    concatenate v_temp_string 'outdata' c_dot into v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms 'ENDLOOP.'.

  endif.

END-OF-DEFINITION.

DEFINE fill_fm_table.

  if &2 eq 'IM'.       "FM Parameter Type Importing

    wa_importing-parameter = &1.    "Parameter name
    wa_importing-typ = &4.
    if &3 eq 'Y'.
      wa_importing-optional = c_on.       "Parameter is optional
    endif.

    select single ddtext from dd04t into wa_para_docu-stext
    where rollname = &4 and ddlanguage = sy-langu and as4local = 'A'.

    wa_para_docu-parameter = &1.
    wa_para_docu-kind = 'P'.

    append wa_importing to i_importing.
    clear wa_importing.
    append wa_para_docu to i_para_docu.
    clear wa_para_docu.

  elseif &2 eq 'EX'.   "Exporting

    wa_exporting-parameter = &1.    "Parameter name
    wa_exporting-typ = &4.

    select single ddtext from dd04t into wa_para_docu-stext
    where rollname = &4 and ddlanguage = sy-langu and as4local = 'A'.
    wa_para_docu-parameter = &1.
    wa_para_docu-kind = 'P'.

    append wa_exporting to i_exporting.
    clear wa_exporting.
    append wa_para_docu to i_para_docu.
    clear wa_para_docu.

  elseif &2 eq 'TA'.   "Tables

    wa_tables-parameter = &1.    "Parameter name
    if &3 eq 'Y'.
      wa_tables-optional = c_on. "Parameter is optional
    endif.
    wa_tables-dbstruct = &4.

    select single ddtext from dd02t into wa_para_docu-stext
    where tabname = &4 and ddlanguage = sy-langu and as4local = 'A'.
    wa_para_docu-parameter = &1.
    wa_para_docu-kind = 'P'.

    append wa_tables to i_tables.
    clear wa_tables.
    append wa_para_docu to i_para_docu.
    clear wa_para_docu.

  elseif &2 eq 'CH'.   "Changing
    wa_changing-parameter = &1.    "Parameter name
    wa_changing-typ = &4.

    select single ddtext from dd04t into wa_para_docu-stext
    where rollname = &4 and ddlanguage = sy-langu and as4local = 'A'.
    wa_para_docu-parameter = &1.
    wa_para_docu-kind = 'P'.

    append wa_changing to i_changing.
    clear wa_changing.
    append wa_para_docu to i_para_docu.
    clear wa_para_docu.

  elseif &2 eq 'EC'.   "Exceptions

    wa_exceptions-exception = &1.

    wa_para_docu-parameter = &1.
    wa_para_docu-kind = 'X'.
    wa_para_docu-stext = &1.

    append wa_exceptions to i_exceptions.
    clear wa_exceptions.

    append wa_para_docu to i_para_docu.
    clear wa_para_docu.
  endif.

END-OF-DEFINITION.

*$*$------------------------------------------------------------------
*$*$ Selection criteria
*$*$------------------------------------------------------------------

SELECTION-SCREEN: BEGIN OF BLOCK program WITH FRAME TITLE text-000.

* File path
SELECTION-SCREEN BEGIN OF BLOCK file WITH FRAME TITLE text-118.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 2(12) text-119.
SELECTION-SCREEN POSITION 15.
PARAMETERS p_file TYPE rlgrap-filename LOWER CASE.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: END OF BLOCK file.

*$*$ Report Catagory
SELECTION-SCREEN: BEGIN OF BLOCK category WITH FRAME TITLE text-001.

SELECTION-SCREEN: BEGIN OF LINE.
*SELECTION-SCREEN position 1.
PARAMETERS: p_cat1 RADIOBUTTON GROUP cat  DEFAULT 'X'.       "Report
SELECTION-SCREEN COMMENT 3(10) text-02t.
PARAMETERS: p_cat2 RADIOBUTTON GROUP cat.           "Conversion
SELECTION-SCREEN COMMENT 16(10) text-02v.
PARAMETERS: p_cat3 RADIOBUTTON GROUP cat.           "Interface
SELECTION-SCREEN COMMENT 29(10) text-02u.
PARAMETERS: p_cat4 NO-DISPLAY. " GROUP cat.           "Function Module
*SELECTION-SCREEN COMMENT 42(15) text-02z.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: END OF BLOCK category.

*$*$ Report Application
SELECTION-SCREEN: BEGIN OF BLOCK application WITH FRAME TITLE text-002.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS: p_app1 RADIOBUTTON GROUP app USER-COMMAND hr.   "MM
SELECTION-SCREEN COMMENT 3(4) text-02k.
PARAMETERS: p_app2 RADIOBUTTON GROUP app.                   "SD
SELECTION-SCREEN COMMENT 10(4) text-02l.
PARAMETERS: p_app3 RADIOBUTTON GROUP app.                   "FI
SELECTION-SCREEN COMMENT 17(4) text-02m.
PARAMETERS: p_app5 RADIOBUTTON GROUP app.                   "HR
SELECTION-SCREEN COMMENT 25(4) text-02a.
PARAMETERS: p_app4 RADIOBUTTON GROUP app  DEFAULT 'X'.      "Others
SELECTION-SCREEN COMMENT 33(9) text-02b.
PARAMETERS: p_app0(2).
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(16)  text-03a MODIF ID hr.
PARAMETERS: p_ldb   TYPE ldbnam MODIF ID hr.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN  PUSHBUTTON 1(20)   btn_node USER-COMMAND ldb_node
                                              MODIF ID hr.
SELECTION-SCREEN COMMENT 25(10) text-03e MODIF ID hr.
SELECT-OPTIONS: s_infty FOR v_infty NO INTERVALS
                                    MATCHCODE OBJECT hrasr00pa_infty
                                    MODIF ID hr.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: END OF BLOCK application.

*$*$ Program Description, ProjectID and Incident Number
SELECTION-SCREEN: BEGIN OF BLOCK prog WITH FRAME TITLE text-003.
*SELECTION-SCREEN SKIP 1.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(29) text-02s.
PARAMETERS: p_desrip(50) LOWER CASE.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(29) text-02q.
PARAMETERS: p_id(10) LOWER CASE.
SELECTION-SCREEN COMMENT 45(15) text-02r.
PARAMETERS: p_sir(10) TYPE n LOWER CASE.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(29) text-02g.
PARAMETERS: p_pgm0(40).               "Program Name (Optional)
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(29) text-02p.
PARAMETERS: p_tran(20).         "Transaction Code
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(29) text-02n.
PARAMETERS: p_devc LIKE tdevc-devclass DEFAULT '$TMP'.  "Dev Class
SELECTION-SCREEN COMMENT 63(15) text-02o.
PARAMETERS: p_cts LIKE e070-trkorr MATCHCODE OBJECT bc407_e070.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: END OF BLOCK prog.

*$*$ Additional Data
SELECTION-SCREEN: BEGIN OF BLOCK additional WITH FRAME TITLE text-004.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS: p_extdes AS CHECKBOX DEFAULT 'X'.      "Extended Description
SELECTION-SCREEN COMMENT 3(20) text-134.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS: p_bdc  AS CHECKBOX USER-COMMAND bdc.   "Batch Input
SELECTION-SCREEN COMMENT 3(13) text-02d.
SELECTION-SCREEN COMMENT 17(16) text-02y MODIF ID bdc.
PARAMETERS: p_tcode TYPE tstc-tcode MODIF ID bdc.  "Transaction Code
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS: p_lfup AS CHECKBOX.        "Local File upload
SELECTION-SCREEN COMMENT 3(23) text-02e.
SELECTION-SCREEN POSITION 28.
PARAMETERS: p_afup AS CHECKBOX.        "Appl File upload
SELECTION-SCREEN COMMENT 30(23) text-02i.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS: p_chbapi AS CHECKBOX USER-COMMAND bapi.       "BAPI feature
SELECTION-SCREEN COMMENT 3(23) text-02w.
SELECTION-SCREEN COMMENT 27(10) text-02x MODIF ID bap.
PARAMETERS: p_bapi LIKE tfdir-funcname MODIF ID bap.  "BAPI Name
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS p_chidin  AS CHECKBOX USER-COMMAND idoc.
SELECTION-SCREEN COMMENT 3(17) text-070.
SELECTION-SCREEN COMMENT 21(12) text-071 MODIF ID id1.
SELECTION-SCREEN POSITION 34.
PARAMETERS p_idmsgi TYPE edidc-mestyp MODIF ID id1.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 21(12) text-066 MODIF ID id1.     "Idoc type
SELECTION-SCREEN POSITION 34.
PARAMETERS: p_idtyp LIKE edi_dc40-idoctyp MODIF ID id1.    "Idoc type
SELECTION-SCREEN: END OF LINE.

SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 11(22) text-064 MODIF ID id1.
SELECTION-SCREEN POSITION 34.
PARAMETERS: p_rcvprt LIKE edi_prt-rcvprt MODIF ID id1.    "Recv type
SELECTION-SCREEN COMMENT 39(17) text-065 MODIF ID id1.    "Recv Partner
PARAMETERS: p_rcvprn LIKE edidc-rcvprn MODIF ID id1
                    MATCHCODE OBJECT edi_rcvprn.
SELECTION-SCREEN: END OF LINE.

SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 11(19) text-067 MODIF ID id1.
SELECTION-SCREEN POSITION 34.
PARAMETERS: p_sndprt LIKE edi_prt-sndprt MODIF ID id1.   "Partner type
SELECTION-SCREEN COMMENT 39(17) text-068 MODIF ID id1.
PARAMETERS: p_sndprn LIKE edidc-sndprn MODIF ID id1
                    MATCHCODE OBJECT edi_sndprn.

SELECTION-SCREEN COMMENT 70(11) text-069 MODIF ID id1.   "Sender Port
PARAMETERS: p_sndpor LIKE edidc-sndpor MODIF ID id1
                    MATCHCODE OBJECT cpediport.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: END OF BLOCK additional.

SELECTION-SCREEN BEGIN OF BLOCK standards WITH FRAME TITLE text-152.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(15) text-042.           "Parameter
PARAMETERS p_para(4)  DEFAULT 'P_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 25(14) text-043.          "Select-options
PARAMETERS p_sopt(4)  DEFAULT 'S_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 48(14) text-051.          "Radio-Button
PARAMETERS p_radio(4) DEFAULT 'R_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 71(9) text-052.           "Checkbox
PARAMETERS p_chbox(4) DEFAULT 'C_'  OBLIGATORY.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(15) text-040.           "Global Variable
PARAMETERS p_glob(4)  DEFAULT 'G_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 25(14) text-041.          "Local Variable
PARAMETERS p_loc(4)   DEFAULT 'L_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 48(14) text-058.          "Internal table
PARAMETERS p_itab(4)  DEFAULT 'I_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 71(9) text-059.           "Type
PARAMETERS p_type(4)  DEFAULT 'TY_' OBLIGATORY.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(15) text-060.           "Range table
PARAMETERS p_range(4) DEFAULT 'R_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 25(14) text-061.          "Structure
PARAMETERS p_str(4)   DEFAULT 'ST_' OBLIGATORY.
SELECTION-SCREEN COMMENT 48(14) text-062.          "Constants
PARAMETERS p_const(4) DEFAULT 'C_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 71(9) text-063.           "WorkArea
PARAMETERS p_wa(4)    DEFAULT 'WA_' OBLIGATORY.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(15) text-077.           "Subroutine
PARAMETERS p_sub(12) DEFAULT 'SUB_'  OBLIGATORY.
SELECTION-SCREEN COMMENT 32(12) text-161.           "Table Type
PARAMETERS p_ttype(8) DEFAULT 'TY_T_'  OBLIGATORY.
SELECTION-SCREEN: END OF LINE.
************
SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(10)   text-162 .     "Reference
SELECTION-SCREEN POSITION 15.
PARAMETERS p_tabfld RADIOBUTTON GROUP ref1 DEFAULT 'X' .
SELECTION-SCREEN COMMENT 17(25)   text-163 .     "Table-field
SELECTION-SCREEN POSITION 44.
PARAMETERS p_datele RADIOBUTTON GROUP ref1 .
SELECTION-SCREEN COMMENT 46(15)   text-164 .     "Data Element
SELECTION-SCREEN: END OF LINE.

***********
SELECTION-SCREEN END OF BLOCK standards.

SELECTION-SCREEN: END OF BLOCK program.

SELECTION-SCREEN: BEGIN OF BLOCK idoc WITH FRAME TITLE text-072.
SELECTION-SCREEN: BEGIN OF LINE.
PARAMETERS: p_chido  AS CHECKBOX USER-COMMAND idoc.
SELECTION-SCREEN COMMENT 3(20)  text-073.     "File format data
PARAMETERS: p_lfdl AS CHECKBOX USER-COMMAND oput. "Local File dload
SELECTION-SCREEN COMMENT 26(20) text-02h.
PARAMETERS: p_afdl AS CHECKBOX USER-COMMAND oput. "Appl File dload
SELECTION-SCREEN COMMENT 49(20) text-02j.
PARAMETERS: p_alv AS CHECKBOX USER-COMMAND oput.      "ALV
SELECTION-SCREEN COMMENT 72(10) text-080.
SELECTION-SCREEN: END OF LINE.

SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(12) text-071 MODIF ID id2.
SELECTION-SCREEN POSITION 44.
PARAMETERS p_idmsgo TYPE edidc-mestyp MODIF ID id2.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(12) text-066 MODIF ID id2.   "Idoc type
SELECTION-SCREEN POSITION 44.
PARAMETERS: p_idtypo LIKE edi_dc40-idoctyp MODIF ID id2. "Idoc type
SELECTION-SCREEN: END OF LINE.

SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(22) text-064 MODIF ID id2.  "Recv type
SELECTION-SCREEN POSITION 44.
PARAMETERS: p_rcvpto LIKE edi_prt-rcvprt MODIF ID id2.  "Recv Partner
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(23) text-065 MODIF ID id2.  "Recv partner
SELECTION-SCREEN POSITION 44.
PARAMETERS: p_rcvpno LIKE edidc-rcvprn MODIF ID id2
                                MATCHCODE OBJECT edi_rcvprn.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(15) text-096 MODIF ID id2.  "Recv Port
SELECTION-SCREEN POSITION 44.
PARAMETERS: p_rcvpoo LIKE edidc-sndpor MODIF ID id2
                                MATCHCODE OBJECT cpediport.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(19) text-067 MODIF ID id2.
SELECTION-SCREEN POSITION 44.
PARAMETERS: p_sndpro LIKE edi_prt-sndprt MODIF ID id2.  "Sender Partner
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN:BEGIN OF LINE.
SELECTION-SCREEN COMMENT 20(21) text-068 MODIF ID id2.
SELECTION-SCREEN POSITION 44.
PARAMETERS: p_sndpno LIKE edidc-sndprn MODIF ID id2
                                 MATCHCODE OBJECT edi_sndprn.
SELECTION-SCREEN: END OF LINE.
SELECTION-SCREEN: END OF BLOCK idoc.

SELECTION-SCREEN: BEGIN OF LINE.
SELECTION-SCREEN COMMENT 5(15)   text-013 MODIF ID alo.     "ALV Option
SELECTION-SCREEN POSITION 22.
PARAMETERS p_alvl RADIOBUTTON GROUP alv DEFAULT 'X' MODIF ID alo.
SELECTION-SCREEN COMMENT 25(8)   text-034 MODIF ID alo.     "List Option
SELECTION-SCREEN POSITION 35.
PARAMETERS p_alvg RADIOBUTTON GROUP alv MODIF ID alo.
SELECTION-SCREEN COMMENT 37(8)   text-035 MODIF ID alo.     "Grid Option
SELECTION-SCREEN: END OF LINE.

*$*$------------------------------------------------------------------
*$*$ initialization
*$*$------------------------------------------------------------------
INITIALIZATION.

  btn_node = text-03d.

*$*$------------------------------------------------------------------
*$*$ Modify Selection screen before display
*$*$------------------------------------------------------------------
AT SELECTION-SCREEN OUTPUT.


  LOOP AT SCREEN.

    IF p_chbapi <> 'X' AND screen-group1 = 'BAP'.
      screen-input = '0'.
      screen-invisible = '1'.
      CLEAR p_bapi.
    ENDIF.

    IF p_bdc <> 'X' AND screen-group1 = 'BDC'.
      screen-input = '0'.
      screen-invisible = '1'.
      CLEAR p_tcode.
    ENDIF.
    IF ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' )
       AND ( screen-group1 = 'OU1' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF p_alv <> 'X' AND screen-group1 = 'ALO'.
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP1' ) AND
       ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP2' ) AND
       ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP3' ) AND
        ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP4' ) AND
       ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP5' ) AND
       ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP6' ) AND
        ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP7' ) AND
        ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP8' ) AND
       ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OP9' ) AND
       ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPJ' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPK' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPL' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPM' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPN' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPO' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPP' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPQ' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPR' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPS' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'OU1' OR screen-group1 = 'OPT' ) AND
           ( p_lfdl <> 'X' AND p_afdl <> 'X' AND p_alv <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF p_chidin <> 'X' AND screen-group1 = 'ID1'.
      screen-input = '0'.
      screen-invisible = '1'.

    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO1' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO2' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO3' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO4' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO5' ) AND
        ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO6' ) AND
         ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO7' ) AND
           ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO8' ) AND
           ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IO9' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOJ' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOK' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOL' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOM' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'ION' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOO' ) AND
          ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOP' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOQ' ) AND
           ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOR' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOS' ) AND
       ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF ( screen-group1 = 'ID2' OR screen-group1 = 'IOT' ) AND
           ( p_chido <> 'X' ).
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    IF p_app5 <> 'X' AND screen-group1 = 'HR'.
      screen-input = '0'.
      screen-invisible = '1'.
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.

*$*$------------------------------------------------------------------
*$*$ Check selection screen data for LDB Name
*$*$------------------------------------------------------------------
AT SELECTION-SCREEN ON p_ldb.

  IF v_ldbname <> p_ldb.
    v_ldbname = p_ldb.
    CLEAR it_ldb_nodes.
  ENDIF.

*$*$------------------------------------------------------------------
*$*$ Check selection screen data
*$*$------------------------------------------------------------------
AT SELECTION-SCREEN.

  IF p_file IS INITIAL.
    MESSAGE e398(00) WITH
    'Please enter File name for uploading screen fields'(132).
  ENDIF.

  IF p_app4 = c_on AND sy-ucomm EQ 'ONLI'.
    IF p_app0 CA ' '.
      MESSAGE e398(00) WITH
             'Please supply a 2 Character Application area'(012).
    ENDIF.
  ENDIF.

  IF p_pgm0 IS NOT INITIAL AND sy-ucomm EQ 'ONLI'.

    PERFORM authorities_and_corr
          USING p_pgm0 'ABAP' ' ' ' '.

  ENDIF.

  CASE sscrfields.

    WHEN 'LDB_NODE'.

      IF it_ldb_nodes IS INITIAL.

        IF p_ldb IS INITIAL.
          MESSAGE e398(00) WITH 'Please Enter LDB Name'(018).
        ENDIF.

        SELECT ldbnode
        FROM   ldbn
        INTO TABLE it_ldb_nodes
        WHERE ldbname = p_ldb
        AND   type NE 'A'.

      ENDIF.

      IF it_fieldcat IS INITIAL.

        wa_fieldcat-col_pos = 1.
        wa_fieldcat-tabname = 'IT_LDB_NODES'.
        wa_fieldcat-fieldname = 'LDBNODE'.
        wa_fieldcat-ref_fieldname = 'LDBNODE'.
        wa_fieldcat-ref_tabname = 'LDBN'.

        APPEND wa_fieldcat TO it_fieldcat.
        CLEAR wa_fieldcat.

      ENDIF.

      IF sy-dynnr = '1000'.

        CALL FUNCTION 'REUSE_ALV_POPUP_TO_SELECT'
          EXPORTING
            i_title              = 'LDB Nodes'
            i_selection          = 'X'
            i_zebra              = 'X'
            i_checkbox_fieldname = 'SEL'
            i_tabname            = 'IT_LDB_NODES'
            it_fieldcat          = it_fieldcat
          IMPORTING
            es_selfield          = it_selfield
            e_exit               = v_exit
          TABLES
            t_outtab             = it_ldb_nodes
          EXCEPTIONS
            program_error        = 1
            OTHERS               = 2.

        CLEAR sy-ucomm.

      ENDIF.

  ENDCASE.

  IF p_chbapi = c_on AND sy-ucomm EQ 'ONLI' AND p_bapi IS INITIAL.
    MESSAGE e398(00) WITH 'Enter BAPI name for posting'(008).
  ENDIF.

  IF p_bdc = c_on AND sy-ucomm EQ 'ONLI' AND p_tcode IS INITIAL.
    MESSAGE e398(00) WITH 'Enter Transaction Code for Batch input'(009).
  ENDIF.

  IF p_chido EQ c_on AND sy-ucomm EQ 'ONLI' AND p_idtypo IS INITIAL.
    MESSAGE e398(00) WITH 'Enter Idoc Type for Outbound'(010).
  ENDIF.

  IF p_chidin EQ c_on AND sy-ucomm EQ 'ONLI' AND p_idtyp IS INITIAL.
    MESSAGE e398(00) WITH 'Enter Idoc Type for Inbound'(011).
  ENDIF.


*$*$------------------------------------------------------------------
*$*$ F4 help for selection screen
*$*$------------------------------------------------------------------
AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file.

  CALL FUNCTION 'WS_FILENAME_GET'
    EXPORTING
      def_path         = 'C:\'
      mask             = ',*.xml,*.xml,.'
      mode             = 'O'
      title            = 'Select Local File'(131)
    IMPORTING
      filename         = p_file
    EXCEPTIONS
      inv_winsys       = 1
      no_batch         = 2
      selection_cancel = 3
      selection_error  = 4
      OTHERS           = 5.

  IF sy-subrc <> 0.
* No action required
  ENDIF.

*&---------------------------------------------------------------------*
*&      Form  read_excel_worksheets
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM read_excel_worksheets.


  FIELD-SYMBOLS <lfs>.

  DATA l_filename TYPE string.
  DATA l_subrc   TYPE sy-subrc.
*Get the 'Data' element under the 'Cell' element
  DATA l_txt_val TYPE string.
  DATA l_index   TYPE i.

  l_filename = p_file.

*Upload the excel XML file
  CALL METHOD cl_gui_frontend_services=>gui_upload
    EXPORTING
      filename   = l_filename
      filetype   = 'BIN'
    IMPORTING
      filelength = g_xml_data_bytes
    CHANGING
      data_tab   = g_xml_data.


*Load ixml library
  CLASS cl_ixml DEFINITION LOAD.

*Creating the main factory for the iXML library
  g_ixml = cl_ixml=>create( ).

*Create a main stream factory.
  CALL METHOD g_ixml->create_stream_factory
    RECEIVING
      rval = g_streamfactory.

*Create a stream for the itab containg XML raw content.
  CALL METHOD g_streamfactory->create_istream_itable
    EXPORTING
      size  = g_xml_data_bytes
      table = g_xml_data[]
    RECEIVING
      rval  = g_istream.

*Create a new XML DOM object.
  g_obj_dom_xml = g_ixml->create_document( ).


*Create XML parser.
  CALL METHOD g_ixml->create_parser
    EXPORTING
      stream_factory = g_streamfactory
      istream        = g_istream
      document       = g_obj_dom_xml
    RECEIVING
      rval           = g_parser.

*Parse the XML source.
  CALL METHOD g_parser->parse
    RECEIVING
      rval = l_subrc.

  IF l_subrc <> 0.
    EXIT.
  ENDIF.

*Make sure DOM is created
  IF g_parser->is_dom_generating( ) NE 'X'.
    EXIT.
  ENDIF.

*Close the opened stream and thereby the opened xml file.
  CALL METHOD g_istream->close.

*Get the root element of the Excel XML.
  CALL METHOD g_obj_dom_xml->get_root_element
    RECEIVING
      rval = g_obj_excel_workbook.
*Get the root element name
  CALL METHOD g_obj_excel_workbook->get_name
    RECEIVING
      rval = g_excel_workbook_name.

*Check if the name is Workbook
  IF g_excel_workbook_name <> 'Workbook'.
    EXIT.
  ENDIF.

*This part of the code explains how to get the document properties.
*Get document properties.
  CALL METHOD g_obj_excel_workbook->find_from_name
    EXPORTING
      name      = 'DocumentProperties'
      namespace = ''
      depth     = 1
    RECEIVING
      rval      = v_obj_properties_element.

*Get author
  CALL METHOD v_obj_properties_element->find_from_name
    EXPORTING
      name      = 'Author'
      namespace = ''
      depth     = 1
    RECEIVING
      rval      = g_element.

  IF NOT g_element IS INITIAL.
    CALL METHOD g_element->get_content_as_string
      RECEIVING
        rval = v_author.
  ENDIF.

*Similarly, the remaining properties can be extracted.

*Get all the Worksheet elements
  CALL METHOD g_obj_excel_workbook->get_elements_by_tag_name
    EXPORTING
      name  = 'Worksheet'
      depth = 1
    RECEIVING
      rval  = g_obj_worksheet_collections.

*Create an iterator for Worksheet elements
  CALL METHOD g_obj_worksheet_collections->create_iterator
    RECEIVING
      rval = g_obj_worksheet_itr.

*Loop through all the Worksheet elements
  DO. "Worksheets
    IF sy-subrc NE 0.
      EXIT.
    ENDIF.

*Get the worksheet as node
    CALL METHOD g_obj_worksheet_itr->get_next
      RECEIVING
        rval = v_obj_worksheet_node.
    IF v_obj_worksheet_node IS INITIAL.
      EXIT.
    ELSE.

*Count number of worksheets
      v_count_worksheets = v_count_worksheets + 1.
    ENDIF.

*Type cast the NODE OBJECT to ELEMENT OBJECT

    v_obj_worksheet_element ?=
    v_obj_worksheet_node->query_interface( ixml_iid_element ).

    CALL METHOD v_obj_worksheet_element->get_attribute
      EXPORTING
        name      = 'Name'
        namespace = 'ss'
      RECEIVING
        rval      = v_worksheet_ss_name.

*The first element within a worksheet should be TABLE.
*Search for the Table element.
    CALL METHOD v_obj_worksheet_element->find_from_name
      EXPORTING
        name      = 'Table'
        namespace = ''
        depth     = 1
      RECEIVING
        rval      = v_obj_table_element.

*If no table element found, continue with next worksheet
    IF v_obj_table_element IS INITIAL.
      CONTINUE.
    ENDIF.

*If table element is found, get all the Row elements
    CALL METHOD v_obj_table_element->get_elements_by_tag_name
      EXPORTING
        name  = 'Row'
        depth = 1
      RECEIVING
        rval  = v_obj_row_collections.

*Create an iterator for Row elements
    CALL METHOD v_obj_row_collections->create_iterator
      RECEIVING
        rval = v_obj_row_itr.

*Loop over all rows in a worksheet
    DO. "Rows
*Get the Row element.
      CALL METHOD v_obj_row_itr->get_next
        RECEIVING
          rval = v_obj_row_node.

      IF v_obj_row_node IS INITIAL.
        EXIT.
      ELSE.
        v_row_count = v_row_count + 1.
      ENDIF.

*Type cast THE NODE OBJECT to ELEMENT OBJECT
      v_obj_row_element ?=
      v_obj_row_node->query_interface( ixml_iid_element ).

*Get all the Cell elements within a Row
      CALL METHOD v_obj_row_element->get_elements_by_tag_name
        EXPORTING
          name  = 'Cell'
          depth = 1
        RECEIVING
          rval  = v_obj_cell_collections.

*Create an iterator for Cell elements
      CALL METHOD v_obj_cell_collections->create_iterator
        RECEIVING
          rval = v_obj_cell_itr.

*Loop through all the Cell elements
      DO. "Cells
*Get the Cell element.
        CALL METHOD v_obj_cell_itr->get_next
          RECEIVING
            rval = v_obj_cell_node.

*        IF v_obj_cell_node IS INITIAL.
*          EXIT.
*        ELSE.

        IF v_worksheet_ss_name EQ 'Selection'
        AND v_cell_count GT 11.
          EXIT.
        ENDIF.
        IF v_cell_count GT 100.
          EXIT.
        ELSE.
          v_cell_count = v_cell_count + 1.
        ENDIF.

        IF v_obj_cell_node IS NOT INITIAL.
*Convert node to element
          v_obj_cell_element ?=
          v_obj_cell_node->query_interface( ixml_iid_element ).

          CALL METHOD v_obj_cell_element->find_from_name
            EXPORTING
              name  = 'Data'
              depth = 1
            RECEIVING
              rval  = v_obj_data_element.

          IF v_obj_data_element IS NOT INITIAL.
*          EXIT.
*        ELSE.
*Get the value of the cell
            CALL METHOD v_obj_data_element->get_content_as_string
              RECEIVING
                rval = l_txt_val.

            wa_excel_data-worksheet = v_worksheet_ss_name.
            wa_excel_data-row = v_row_count.
            wa_excel_data-col = v_cell_count.
            wa_excel_data-value = l_txt_val.
            APPEND wa_excel_data TO i_excel_data.
            CLEAR l_txt_val.
          ENDIF.
        ENDIF.
      ENDDO.
      CLEAR v_cell_count.
    ENDDO.
    CLEAR v_row_count. CLEAR v_cell_count.
  ENDDO.

  PERFORM rearrange_data.

ENDFORM.                    " read_excel_worksheets

*$*$------------------------------------------------------------------
*$*$ start-of-selection.
*$*$------------------------------------------------------------------
START-OF-SELECTION.

  DATA l_text TYPE tstct-ttext.
  DATA l_i_texttab LIKE textpool OCCURS 200 WITH HEADER LINE.
  DATA l_answer TYPE c.

*$*$ Check if LDB Nodes ave been chosen for HR programs
  IF p_app5 = c_on.
    it_ldb_nodes_sel = it_ldb_nodes.
    DELETE it_ldb_nodes_sel WHERE sel IS INITIAL.
    IF it_ldb_nodes_sel IS INITIAL.
      MESSAGE i398(00) WITH 'Please Choose a LDB Node'(017).
      LEAVE LIST-PROCESSING.
    ENDIF.
  ENDIF.

*$*$ Get the extended description of the program
  IF p_extdes = 'X'.
    DESCRIBE TABLE i_extdecrip LINES sy-dbcnt.
    IF sy-dbcnt = 0.
      MESSAGE i016 WITH
        'Please enter a complete'(014) 'Extended program description'(015)
        '- When complete, hit the Save icon'(016).
      EDITOR-CALL FOR i_extdecrip TITLE
          'Extended Description of Program'(037).
    ENDIF.
  ENDIF.

  PERFORM initialising_routine.        "Check Input data
  PERFORM get_next_program_name.       "Get next program name
  PERFORM generate_basic_code.         "Generate the new code

  CHECK p_cat4 EQ space.     "Not for FMs

  PERFORM pop_up_to_confirm.           "Do you want to SAVE ?


* Add the Subroutines to the main program
  add_macro_line space.
  APPEND LINES OF i_program_forms TO i_program.

* Create another table for formatting
  LOOP AT i_program.
    i_old_prog-line = i_program.
    APPEND i_old_prog.
  ENDLOOP.

  PERFORM format.

  wa_trdir-name = v_program_name.
  wa_trdir-subc = '1'.
  IF p_app5 IS NOT INITIAL.
    wa_trdir-ldbname = p_ldb.
  ENDIF.
  wa_trdir-uccheck = 'X'.
*****  Changes by Shastry
  wa_trdir-fixpt = 'X'.
*****End Changes
  INSERT REPORT v_program_name FROM i_new_prog
                               DIRECTORY ENTRY wa_trdir.

  IF p_app5 EQ 'X'.
    CALL FUNCTION 'POPUP_TO_CONFIRM'
      EXPORTING
        titlebar       = 'Report Category'(044)
        text_question  = 'Do you want to choose a report category?'(006)
        text_button_1  = 'Yes'(045)
        text_button_2  = 'No'(046)
        default_button = '1'
        start_column   = 25
        start_row      = 6
      IMPORTING
        answer         = l_answer
      EXCEPTIONS
        text_not_found = 1
        OTHERS         = 2.
    IF sy-subrc EQ 0 AND l_answer EQ '1'.
      CALL FUNCTION 'HR_GET_REPORTCLASS'
        EXPORTING
          repid                = v_program_name
          devcl                = p_devc
          action               = 'U'
        EXCEPTIONS
          transport_impossible = 1
          system_lock_error    = 2
          tables_locked        = 3
          OTHERS               = 4.
      IF sy-subrc <> 0.
      ENDIF.
    ENDIF.
  ENDIF.

  CALL FUNCTION 'READ_TEXT_ELEMENTS'
    EXPORTING
      progname = v_program_name
    TABLES
      texttab  = l_i_texttab.

  APPEND LINES OF l_i_texttab TO i_texttab.
* insert_text_data
  SORT i_texttab BY id key.
  DELETE ADJACENT DUPLICATES FROM i_texttab.
  INSERT textpool v_program_name FROM i_texttab LANGUAGE sy-langu.

  IF sy-subrc EQ 0.
    wa_ko200-pgmid = 'R3TR'.
    wa_ko200-object = 'PROG'.
    wa_ko200-obj_name = v_program_name.
    wa_ko200-operation = 'I'.
    wa_ko200-devclass = p_devc.

    CALL FUNCTION 'TRINT_CORR_INSERT'
      EXPORTING
        iv_order          = p_cts
        is_ko200          = wa_ko200
      EXCEPTIONS
        cancel_edit_error = 1
        show_only_error   = 2
        OTHERS            = 3.
    IF sy-subrc <> 0.      ENDIF.

* If transaction code need to be created
    IF p_tran IS NOT INITIAL.

      l_text = p_desrip.

      CALL FUNCTION 'RPY_TRANSACTION_INSERT'
        EXPORTING
          transaction         = p_tran
          program             = v_program_name
          dynpro              = '1000'
          development_class   = p_devc
          transport_number    = p_cts
          transaction_type    = 'R'
          shorttext           = l_text
          wingui_enabled      = 'X'
        EXCEPTIONS
          cancelled           = 1
          already_exist       = 2
          permission_error    = 3
          name_not_allowed    = 4
          name_conflict       = 5
          illegal_type        = 6
          object_inconsistent = 7
          db_access_error     = 8
          OTHERS              = 9.
      IF sy-subrc <> 0.
        MESSAGE e398(00) WITH 'Transaction'(022) p_tran
                        'could not be created'(026).
      ELSE.
        MESSAGE s398(00) WITH 'Transaction'(022) p_tran
                        'created successfully'(030).
      ENDIF.
    ENDIF.
  ENDIF.

  CALL FUNCTION 'POPUP_TO_DISPLAY_TEXT_LO'
    EXPORTING
      titel        = 'Information'(048)
      textline1    = 'Program created successfully. Please remember to:'(027)
      textline2    = '1. Set Maximum line length to 72 Chars in editor settings'(028)
      textline3    = '2. Perform TEXT ELEMENT analysis in the Text Pool editor'(029)
      start_column = 15
      start_row    = 6.

  SET PARAMETER ID 'RID' FIELD v_program_name.
  LEAVE TO TRANSACTION 'SE38'.

*$*$------------------------------------------------------------------
*$*$   form: initialising_routine.
*$*$------------------------------------------------------------------
FORM: initialising_routine.

  REFRESH: i_program, i_texttab.
  CLEAR: v_program_name, v_temp_string.

  IF p_cat1 = c_on.
    v_cat = 'R'.
  ELSEIF p_cat2 = c_on.
    v_cat = 'C'.
  ELSEIF p_cat3 = c_on.
    v_cat = 'I'.
  ELSEIF p_cat4 = c_on.
    v_cat = 'F'.
  ENDIF.
  IF p_app1 = c_on.
    p_app0 = 'MM'.
  ELSEIF p_app2 = c_on.
    p_app0 = 'SD'.
  ELSEIF p_app3 = c_on.
    p_app0 = 'FI'.
  ELSEIF p_app5 = c_on.
    p_app0 = 'HR'.
  ENDIF.
  CONCATENATE c_z p_app0 v_cat '0' c_% INTO v_program.

ENDFORM.                    "INITIALISING_ROUTINE

*$*$------------------------------------------------------------------
*$*$ form get_next_program_name.
*$*$------------------------------------------------------------------
FORM get_next_program_name.

  DATA: v_lastseq LIKE trdir-name.
  DATA: BEGIN OF l_i_trdir OCCURS 0,
         name TYPE trdir-name,
        END OF l_i_trdir.
  DATA  l_name TYPE trdir-name.

* If program/FM name is provided on Screen
  IF p_pgm0 IS INITIAL.

* If FM is being created
    IF p_cat4 EQ c_on.

* Select and get the last sequence number
      SELECT funcname FROM tfdir
      INTO TABLE l_i_trdir
      WHERE funcname LIKE v_program.

* If program is being created
    ELSE.

      SELECT name FROM trdir
      INTO TABLE l_i_trdir
          WHERE name LIKE v_program.
    ENDIF.

    SORT l_i_trdir BY name DESCENDING.
    LOOP AT l_i_trdir.
      IF l_i_trdir-name+4(4) CO '0123456789'.
        v_lastseq = l_i_trdir-name.
        EXIT.
      ENDIF.
    ENDLOOP.

    l_i_trdir-name = v_lastseq.

    IF l_i_trdir-name IS INITIAL.
      CONCATENATE c_z p_app0 v_cat '0000' INTO v_program.
    ELSE.
      v_program = l_i_trdir-name.
    ENDIF.
    IF p_pgm0 IS INITIAL.
      ADD 1 TO v_program-seqno.
    ENDIF.

    v_program_name = v_program.

  ELSE.

    v_program_name = p_pgm0.
    IF p_cat4 EQ c_on.      "Func Module

      SELECT SINGLE funcname FROM tfdir
         INTO l_name
         WHERE funcname EQ v_program_name.
      IF sy-subrc EQ 0.
        MESSAGE e398(00) WITH 'Function Module' v_program_name
                              'already exists'.
      ENDIF.

    ELSE.
      SELECT SINGLE name FROM trdir
         INTO l_name
         WHERE name EQ v_program_name.
      IF sy-subrc EQ 0.
        MESSAGE i398(00) WITH 'Program' v_program_name 'already exists'.
        LEAVE LIST-PROCESSING.
      ENDIF.

    ENDIF.
  ENDIF.

ENDFORM.                    "GET_NEXT_PROGRAM_NAME

*$*$------------------------------------------------------------------
*$*$ form generate_basic_code.
*$*$------------------------------------------------------------------
FORM generate_basic_code.

  PERFORM read_excel_worksheets.

*$*$ Setup standard program comments page.
  PERFORM setup_program_header.

  IF p_cat4 EQ space.
*$*$ Setup_Includes.
    PERFORM setup_includes.
  ENDIF.

*$*$ Setup Data dclaration area
  PERFORM setup_data_declaration.

* For Function Modules, data decl will go in global data include
  IF p_cat4 EQ c_on.
* Copy the header and data declaration for writing in the FM Global data
    i_program_fmdata[] = i_program[].
* Remove data declaration from the main code
    DELETE i_program FROM v_linecount1.
*$*$ Setup_Includes.
    PERFORM setup_includes.
  ENDIF.

  IF p_cat4 EQ space.         "Not required for FMs
*$*$ Parameters and selections
    PERFORM setup_selection_screen.
*$*$ Setup Initialization
    PERFORM setup_initialization.
*$*$ Setup the At-selection-screen processing
    PERFORM setup_at-selection-screen.
*$*$ Setup standard tOP-of-page headers.
    PERFORM setup_top_of_page.
*$*$ Setup standard end-of-page footers.
    PERFORM setup_end_of_page.
*$*$ Setup Get event
    PERFORM get_event.
  ENDIF.


*$*$ Setup Start-of-Selection event
  PERFORM setup_start-of-selection.
*$*$ Setup End-of-Selection event
  PERFORM setup_end-of-selection.

  IF p_cat4 EQ c_on.         "Only required for FMs
*$*$ Create Function Modules
    PERFORM create_function_modules.
  ENDIF.

ENDFORM.                    "GENERATE_BASIC_CODE

*$*$-------------------------------------------------------------------*
*$*$ form pop_up_to_confirm.
*$*$-------------------------------------------------------------------*
FORM pop_up_to_confirm.

  DATA: v_textline1 LIKE  spop-textline1.
  DATA: v_textline2 LIKE  spop-textline2.
  DATA: v_title    LIKE  spop-titel.
  DATA: v_answer.

  IF p_cat4 EQ c_on.       "Function Module
    CONCATENATE 'Function Module'(02z) v_program_name
                'will be created.'(032)
    INTO v_textline1 SEPARATED BY space.
  ELSE.
    CONCATENATE 'Program'(033) v_program_name 'will be created.'(032)
    INTO v_textline1 SEPARATED BY space.
  ENDIF.

  v_textline2 = 'Do you want to continue?'(007).
  v_title     = 'Create xxxxxxxx'(031).
  REPLACE 'xxxxxxxx' WITH v_program_name INTO v_title.

  CALL FUNCTION 'POPUP_TO_CONFIRM_STEP'
    EXPORTING
      defaultoption = 'N'
      textline1     = v_textline1
      textline2     = v_textline2
      titel         = v_title
    IMPORTING
      answer        = v_answer.
  IF v_answer NE 'J'.
    LEAVE LIST-PROCESSING.
  ENDIF.

ENDFORM.                    "POP_UP_TO_CONFIRM

*$*$-------------------------------------------------------------------*
*$*$ form setup_program_header.
*$*$-------------------------------------------------------------------*
FORM setup_program_header.

  IF v_cat CA 'IRC'.
    CONCATENATE 'Report' v_program_name 'line-size 132'
                'no standard page heading.'
                INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  add_macro_line text-100.
*$*$ Object Name
  v_temp_string = text-101.
  v_temp_string+25 = v_program_name.
  add_macro_line v_temp_string.
*$*$  Author
  SELECT SINGLE * FROM usr03 WHERE bname = sy-uname.
  v_temp_string = text-102.
  v_temp_string+25 = sy-uname.
  CONCATENATE usr03-name1 usr03-name2 INTO v_username.
  v_temp_string+36 = v_username.
  add_macro_line v_temp_string.
*$*$  Date
  v_temp_string = text-103.
  v_temp_string+25 = sy-datum.
  add_macro_line v_temp_string.
*$*$  Copyright
  add_macro_line text-104.
*$*$ Transport Number
  add_macro_line text-110.
  add_macro_line text-105.
*$*$ Logical Database
  add_macro_line text-106.
*$*$ SAPScript name
  add_macro_line text-107.
*$*$ Application Area
  v_temp_string = text-108.
  v_temp_string+25 = p_app0.
  add_macro_line v_temp_string.
*$*$ Description
  v_temp_string = text-109.
  v_temp_string+25 = p_desrip.
  add_macro_line v_temp_string.

  IF NOT p_desrip EQ space.
    add_report_texts 'R' space p_desrip. "Add Report Title
  ENDIF.

  add_macro_line text-105.
*  $*$ Interface ID#
  v_temp_string = text-111.
  v_temp_string+25 = p_id.
  add_macro_line v_temp_string.
*$*$ Incident Number
  v_temp_string = text-112.
  v_temp_string+25 = p_sir.
  add_macro_line v_temp_string.
  add_macro_line text-105.
*$*$ Purpose
  add_macro_line text-113.

  LOOP AT i_extdecrip.
    CONCATENATE '*$*$' i_extdecrip INTO i_extdecrip SEPARATED BY space.
    add_macro_line i_extdecrip(72).
    IF i_extdecrip+72 IS NOT INITIAL.
      add_macro_line i_extdecrip(70).
    ENDIF.
  ENDLOOP.

  add_macro_line text-100.
*$*$ Correction #
  add_macro_line text-114.
*$*$ Modified By
  add_macro_line text-115.
*$*$ Date
  add_macro_line text-116.
*$*$ Transport Number
  add_macro_line text-117.
  add_macro_line text-100.

  IF p_cat4 EQ c_on.     "Reqd for FMs to separate data from main logic
    DESCRIBE TABLE i_program LINES v_linecount1.
  ENDIF.
  v_linecount1 = v_linecount1 + 1.

ENDFORM.                    "SETUP_PROGRAM_HEADER

*$*$-------------------------------------------------------------------*
*$*$ form setup_includes
*$*$-------------------------------------------------------------------*
FORM setup_includes.

  DATA: l_text1(60)  TYPE c,
        l_text2(100) TYPE c.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-03h.
  add_macro_line text-100.

  IF s_infty[] IS NOT INITIAL AND p_app5 IS NOT INITIAL.
    SELECT infty FROM t582s INTO TABLE it_infty
          WHERE sprsl = sy-langu AND
                infty IN s_infty AND
                itbld = space.
    IF sy-subrc EQ 0.
      DESCRIBE TABLE it_infty.
      LOOP AT it_infty INTO wa_infty.
        IF sy-tabix EQ sy-tfill.
          l_text1 = '.'.
        ELSE.
          l_text1 = ','.
        ENDIF.
        IF sy-tabix EQ 1.
          CONCATENATE 'INFOTYPES:'
                      wa_infty-infty
          INTO v_temp_string
          SEPARATED BY space.
          CONCATENATE v_temp_string
                      l_text1
          INTO v_temp_string.
        ELSE.
          CLEAR v_temp_string.
          CONCATENATE wa_infty-infty
                      l_text1
          INTO l_text2.
          v_temp_string+11(5) = l_text2.
        ENDIF.
        add_macro_line v_temp_string.
      ENDLOOP.
    ENDIF.
  ENDIF.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-160.                  "Include common forms
  add_macro_line text-100.
  add_macro_line 'include zcommon_forms.'.  "Common program  Forms
  add_macro_line space.

ENDFORM.                    "SETUP_INCLUDES

*$*$-------------------------------------------------------------------*
*$*$ form setup_data_declaration.
*$*$-------------------------------------------------------------------*
FORM setup_data_declaration.

  DATA l_index1 TYPE i.
  DATA l_index2 TYPE i.
  DATA l_text1(60) TYPE c.
  DATA l_text2(60) TYPE c.
  DATA l_cimtyp TYPE edcim-cimtyp.
  DATA l_index3 TYPE char2.
  DATA l_variable TYPE char40.
  FIELD-SYMBOLS <lfs>.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-d00.
  add_macro_line text-100.
  add_macro_line space.

* HR Tables & infotypes
  IF p_app5 IS NOT INITIAL.
    add_macro_line text-03g.

    DESCRIBE TABLE it_ldb_nodes_sel.
    LOOP AT it_ldb_nodes_sel INTO wa_ldb_nodes.
      IF sy-tabix EQ sy-tfill.
        l_text1 = '.'.
      ELSE.
        l_text1 = ','.
      ENDIF.
      IF sy-tabix EQ 1.
        CONCATENATE 'NODES:'
                    wa_ldb_nodes-ldbnode
        INTO v_temp_string SEPARATED BY space.
        CONCATENATE v_temp_string l_text1
             INTO v_temp_string.
      ELSE.
        CLEAR v_temp_string.
        CONCATENATE wa_ldb_nodes-ldbnode
                    l_text1
        INTO l_text2.
        v_temp_string+7 = l_text2.
      ENDIF.
      add_macro_line v_temp_string.
    ENDLOOP.
    add_macro_line space.
  ENDIF.

*** Type pools for ALV
**  add_macro_line text-03i.
**  if p_alv eq c_on.
**  add_macro_line 'TYPE-POOLS kkblo.'.
**  endif.

* Constants
  add_macro_line text-c01.

*** Constants list for separator
**CONSTANTS: BEGIN OF c_separator,
**            tab(1)          TYPE c  VALUE %_horizontal_tab,
**            comma(1)        TYPE c  VALUE ',',
**            colon(1)        TYPE c  VALUE ':',
**            semicolon(1)    TYPE c  VALUE ';',
**            no_separator(1) TYPE c  VALUE space,
**            pipe(1)         TYPE c  VALUE '|',
**            dot(1)          TYPE c  VALUE '.',
**          END OF c_separator.
  IF p_lfup EQ c_on OR p_afup EQ c_on
  OR p_lfdl EQ c_on OR p_afdl EQ c_on.
    add_macro_line space.
    add_macro_line text-c17 ."'* Constants list for file delimiters'.
    CONCATENATE 'CONSTANTS: BEGIN OF' p_const INTO v_temp_string
                                         SEPARATED BY space.
    CONCATENATE v_temp_string 'separator,' INTO v_temp_string.
    add_macro_line v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+14 = 'tab(1)          TYPE c VALUE %_horizontal_tab,'.
    v_temp_string+62 = '"Tab'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'comma(1)        TYPE c  VALUE'.
    CONCATENATE v_temp_string text-121
                      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string ',' text-121 ',' INTO v_temp_string.
    v_temp_string+54 = '"Comma Separator'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'colon(1)        TYPE c  VALUE'.
    CONCATENATE v_temp_string text-121
                      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string ':' text-121 ',' INTO v_temp_string.
    v_temp_string+54 = '"Colon Separator'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'semicolon(1)    TYPE c  VALUE'.
    CONCATENATE v_temp_string text-121
                      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string ';' text-121 ',' INTO v_temp_string.
    v_temp_string+54 = '"Semicolon'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'no_separator(1) TYPE c  VALUE space,'.
    v_temp_string+54 = '"No Separator'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'pipe(1)         TYPE c  VALUE'.
    CONCATENATE v_temp_string text-121
                      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string '|' text-121 ',' INTO v_temp_string.
    v_temp_string+54 = '"Pipe Separator'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'dot(1)          TYPE c  VALUE'.
    CONCATENATE v_temp_string text-121
                    INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot text-121 ',' INTO v_temp_string.
    v_temp_string+54 = '"Dot Separator'.
    add_macro_line v_temp_string.
    CONCATENATE 'End of' p_const
                    INTO v_temp_string+11 SEPARATED BY space.
    CONCATENATE v_temp_string 'separator' c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

*** Constants for Call Transaction Input and Update method
**CONSTANTS: BEGIN OF c_calltran,
**            update_s(1)  TYPE c VALUE 'S',
**            update_a(1)  TYPE c VALUE 'A',
**            input_e(1)   TYPE c VALUE 'E',
**            input_a(1)   TYPE c VALUE 'A',
**            input_n(1)   TYPE c VALUE 'N',
**          END OF c_calltran.
  IF p_bdc EQ c_on.
    add_macro_line space.
    add_macro_line text-c18.
    "'* Constants for Call Transaction Input and Update method'.
    CONCATENATE 'CONSTANTS: BEGIN OF' p_const INTO v_temp_string
                                         SEPARATED BY space.
    CONCATENATE v_temp_string 'calltran,' INTO v_temp_string.
    add_macro_line v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+14 = 'update_s(1)  TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
          INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'S' text-121 ',' INTO v_temp_string.
    v_temp_string+50 = '"Synchronous Update'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'update_a(1)  TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
              INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'A' text-121 ',' INTO v_temp_string.
    v_temp_string+50 = '"Asynchronous Update'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'input_e(1)   TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
              INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'E' text-121 ',' INTO v_temp_string.
    v_temp_string+50 = '"Display Errors'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'input_a(1)   TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
              INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'A' text-121 ',' INTO v_temp_string.
    v_temp_string+50 = '"Display All'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'input_n(1)   TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
              INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'N' text-121 ',' INTO v_temp_string.
    v_temp_string+50 = '"No Display'.
    add_macro_line v_temp_string.
    CONCATENATE 'End of' p_const
              INTO v_temp_string+11 SEPARATED BY space.
    CONCATENATE v_temp_string 'calltran' c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

*** Constants for ALV Events declaration
**CONSTANTS: BEGIN OF c_alv_events,
**            top_of_page(12) TYPE c VALUE 'TOP_OF_PAGE',
**            end_of_page(12) TYPE c VALUE 'END_OF_PAGE',
**           END OF c_alv_events.

  IF p_alv EQ c_on.
    add_macro_line space.
    add_macro_line text-c19. "'* Constants for ALV Events declaration'.
    CONCATENATE 'CONSTANTS: BEGIN OF' p_const INTO v_temp_string
                                         SEPARATED BY space.
    CONCATENATE v_temp_string 'alv_events,' INTO v_temp_string.
    add_macro_line v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+14 = 'top_of_page(12) TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'TOP_OF_PAGE' text-121 ','
                      INTO v_temp_string.
    v_temp_string+59 = '"Top Of Page'.
    add_macro_line v_temp_string.
    v_temp_string+14 = 'end_of_page(12) TYPE c VALUE'.
    CONCATENATE v_temp_string text-121
                    INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'END_OF_PAGE' text-121 ','
                    INTO v_temp_string.
    v_temp_string+59 = '"End Of Page'.
    add_macro_line v_temp_string.
    CONCATENATE 'End of' p_const INTO v_temp_string+11
                SEPARATED BY space.
    CONCATENATE v_temp_string 'alv_events' c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

  add_macro_line space.
  add_macro_line text-c20. "'* Constants for yes Flag'.
  CONCATENATE 'CONSTANTS' p_const INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'check(1)   TYPE c    VALUE'
                        INTO v_temp_string.
  CONCATENATE v_temp_string text-121
                  INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'X' text-121 c_dot INTO v_temp_string.
  v_temp_string+59 = '"Flag'.
  add_macro_line v_temp_string.

* Types
  add_macro_line space.
  add_macro_line text-d02.
  add_macro_line text-c21. "'* Structure for storing final output data'.
  CONCATENATE p_type 'outdata,' INTO v_temp_string.
  CONCATENATE 'types: begin of' v_temp_string INTO v_temp_string
                 SEPARATED BY space.
  add_macro_line v_temp_string.

  DESCRIBE TABLE i_program LINES l_index1.

  LOOP AT i_output_data INTO wa_output_data.

*      l_index3 = l_index3 + 1.
*
*      concatenate 'v_oufld' l_index3 into l_variable.
*      assign (l_variable) to <lfs>.
*      <lfs> = wa_output_data-name.
*
*      concatenate 'v_ouchd' l_index3 into l_variable.
*      assign (l_variable) to <lfs>.
*      <lfs> = wa_output_data-heading.
*
*      concatenate 'v_outtab' l_index3 into l_variable.
*      assign (l_variable) to <lfs>.
*      <lfs> = wa_output_data-table.
*
*      concatenate 'v_outfld' l_index3 into l_variable.
*      assign (l_variable) to <lfs>.
*      <lfs> = wa_output_data-field.
*
*      concatenate 'v_oudata' l_index3 into l_variable.
*      assign (l_variable) to <lfs>.
*      <lfs> = wa_output_data-dtype.
*
*      concatenate 'v_oulen' l_index3 into l_variable.
*      assign (l_variable) to <lfs>.
*      <lfs> = wa_output_data-length.

**********Shud makes changes here**********
    IF wa_output_data-dtype EQ space AND wa_output_data-length EQ space.
      IF p_tabfld = 'X'.
        create_data wa_output_data-name
                    wa_output_data-table
                    wa_output_data-field
                    wa_output_data-heading.
      ELSE.
        create_data_dele wa_output_data-name
                         wa_output_data-table
                         wa_output_data-field
                         wa_output_data-heading.

      ENDIF.
    ELSE.
      IF wa_output_data-table EQ space AND wa_output_data-field EQ space.
        create_data_type wa_output_data-name
                         wa_output_data-dtype
                         wa_output_data-length
                         wa_output_data-heading.
      ENDIF.
    ENDIF.

  ENDLOOP.

  DESCRIBE TABLE i_program LINES l_index2.

* If no fields have been entered
  IF l_index1 = l_index2.
    add_macro_line text-c22. "'***enter the structure fields here'.
    add_macro_line 'dummy,'.
  ENDIF.

  DESCRIBE TABLE i_program LINES l_index2.
  l_index1 = l_index1 + 1.

  CONCATENATE p_type 'outdata' INTO v_temp_string.
  CONCATENATE 'end of' v_temp_string INTO v_temp_string
                 SEPARATED BY space.
  CONCATENATE v_temp_string c_dot INTO v_temp_string.
  add_macro_line v_temp_string.

* File output structure
  IF p_lfup EQ c_on OR p_afup EQ c_on.
    add_macro_line space.
    add_macro_line text-c23. "'* Structure for storing File data'.
    CONCATENATE p_type 'infile,' INTO v_temp_string.
    CONCATENATE 'types: begin of' v_temp_string INTO v_temp_string
                   SEPARATED BY space.
    add_macro_line v_temp_string.
    APPEND LINES OF i_program FROM l_index1 TO l_index2 TO i_program.
    CONCATENATE p_type 'infile' INTO v_temp_string.
    CONCATENATE 'end of' v_temp_string
                  INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

  LOOP AT i_processing INTO wa_processing.

* Add data declaration for internal tables to be used in
* processing logic part
*  if p_chjn1 eq c_on.
    add_macro_line space.
    CONCATENATE text-c24 "'* Structure for select from table'
                  wa_processing-table   wa_processing-j1table
                  wa_processing-j2table wa_processing-j3table
                 INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    IF wa_processing-j3table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table  wa_processing-j3table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j2table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j1table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
             INTO l_text1 SEPARATED BY '_'.
    ELSE.
      l_text1 = wa_processing-table.
    ENDIF.

    CONCATENATE p_type l_text1 c_comma INTO v_temp_string.
    CONCATENATE 'types: begin of' v_temp_string
                INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    REFRESH r_fieldlist.
    r_fieldlist-sign = 'I'.
    r_fieldlist-option = 'EQ'.

    IF p_tabfld = 'X'.

      IF wa_processing-field1 NE space.
        create_data wa_processing-field1
                wa_processing-table
                wa_processing-field1 space.

        r_fieldlist-low = wa_processing-field1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field2 NE space.
        create_data wa_processing-field2
                    wa_processing-table
                    wa_processing-field2 space.

        r_fieldlist-low = wa_processing-field2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field3 NE space.
        create_data wa_processing-field3
                    wa_processing-table
                    wa_processing-field3 space.

        r_fieldlist-low = wa_processing-field3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field4 NE space.
        create_data wa_processing-field4
                    wa_processing-table
                    wa_processing-field4 space.

        r_fieldlist-low = wa_processing-field4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field5 NE space.
        create_data wa_processing-field5
                    wa_processing-table
                    wa_processing-field5 space.

        r_fieldlist-low = wa_processing-field5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field6 NE space.
        create_data wa_processing-field6
                    wa_processing-table
                    wa_processing-field6 space.

        r_fieldlist-low = wa_processing-field6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field7 NE space.
        create_data wa_processing-field7
                    wa_processing-table
                    wa_processing-field7 space.

        r_fieldlist-low = wa_processing-field7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field8 NE space.
        create_data wa_processing-field8
                    wa_processing-table
                    wa_processing-field8 space.

        r_fieldlist-low = wa_processing-field8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field9 NE space.
        create_data wa_processing-field9
                    wa_processing-table
                    wa_processing-field9 space.

        r_fieldlist-low = wa_processing-field9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field10 NE space.
        create_data wa_processing-field10
                    wa_processing-table
                    wa_processing-field10 space.

        r_fieldlist-low = wa_processing-field10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field11 NE space.
        create_data wa_processing-field11
                    wa_processing-table
                    wa_processing-field11 space.

        r_fieldlist-low = wa_processing-field11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field12 NE space.
        create_data wa_processing-field12
                    wa_processing-table
                    wa_processing-field12 space.

        r_fieldlist-low = wa_processing-field12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field13 NE space.
        create_data wa_processing-field13
                    wa_processing-table
                    wa_processing-field13 space.

        r_fieldlist-low = wa_processing-field13.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field14 NE space.
        create_data wa_processing-field14
                    wa_processing-table
                    wa_processing-field14 space.

        r_fieldlist-low = wa_processing-field14.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field15 NE space.
        create_data wa_processing-field15
                    wa_processing-table
                    wa_processing-field15 space.

        r_fieldlist-low = wa_processing-field15.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld1 NE space AND NOT
         wa_processing-j1fld1 IN r_fieldlist[].
        create_data wa_processing-j1fld1
                    wa_processing-j1table
                    wa_processing-j1fld1 space.

        r_fieldlist-low = wa_processing-j1fld1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld2 NE space AND NOT
         wa_processing-j1fld2 IN r_fieldlist[].
        create_data wa_processing-j1fld2
                    wa_processing-j1table
                    wa_processing-j1fld2 space.

        r_fieldlist-low = wa_processing-j1fld2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld3 NE space AND NOT
         wa_processing-j1fld3 IN r_fieldlist[].
        create_data wa_processing-j1fld3
                    wa_processing-j1table
                    wa_processing-j1fld3 space.

        r_fieldlist-low = wa_processing-j1fld3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld4 NE space AND NOT
         wa_processing-j1fld4 IN r_fieldlist[].
        create_data wa_processing-j1fld4
                    wa_processing-j1table
                    wa_processing-j1fld4 space.

        r_fieldlist-low = wa_processing-j1fld4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld5 NE space AND NOT
         wa_processing-j1fld5 IN r_fieldlist[].
        create_data wa_processing-j1fld5
                    wa_processing-j1table
                    wa_processing-j1fld5 space.

        r_fieldlist-low = wa_processing-j1fld5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld6 NE space AND NOT
         wa_processing-j1fld6 IN r_fieldlist[].
        create_data wa_processing-j1fld6
                    wa_processing-j1table
                    wa_processing-j1fld6 space.

        r_fieldlist-low = wa_processing-j1fld6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld7 NE space AND NOT
         wa_processing-j1fld7 IN r_fieldlist[].
        create_data wa_processing-j1fld7
                    wa_processing-j1table
                    wa_processing-j1fld7 space.

        r_fieldlist-low = wa_processing-j1fld7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld8 NE space AND NOT
         wa_processing-j1fld8 IN r_fieldlist[].
        create_data wa_processing-j1fld8
                    wa_processing-j1table
                    wa_processing-j1fld8 space.

        r_fieldlist-low = wa_processing-j1fld8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld9 NE space AND NOT
         wa_processing-j1fld9 IN r_fieldlist[].
        create_data wa_processing-j1fld9
                    wa_processing-j1table
                    wa_processing-j1fld9 space.

        r_fieldlist-low = wa_processing-j1fld9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld10 NE space AND NOT
         wa_processing-j1fld10 IN r_fieldlist[].
        create_data wa_processing-j1fld10
                    wa_processing-j1table
                    wa_processing-j1fld10 space.

        r_fieldlist-low = wa_processing-j1fld10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld11 NE space AND NOT
         wa_processing-j1fld11 IN r_fieldlist[].
        create_data wa_processing-j1fld11
                    wa_processing-j1table
                    wa_processing-j1fld11 space.

        r_fieldlist-low = wa_processing-j1fld11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld12 NE space AND NOT
         wa_processing-j1fld12 IN r_fieldlist[].
        create_data wa_processing-j1fld12
                    wa_processing-j1table
                    wa_processing-j1fld12 space.

        r_fieldlist-low = wa_processing-j1fld12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld1 NE space AND NOT
         wa_processing-j2fld1 IN r_fieldlist[].
        create_data wa_processing-j2fld1
                    wa_processing-j2table
                    wa_processing-j2fld1 space.

        r_fieldlist-low = wa_processing-j2fld1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld2 NE space AND NOT
         wa_processing-j2fld2 IN r_fieldlist[].
        create_data wa_processing-j2fld2
                    wa_processing-j2table
                    wa_processing-j2fld2 space.

        r_fieldlist-low = wa_processing-j2fld2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld3 NE space AND NOT
         wa_processing-j2fld3 IN r_fieldlist[].
        create_data wa_processing-j2fld3
                    wa_processing-j2table
                    wa_processing-j2fld3 space.

        r_fieldlist-low = wa_processing-j2fld3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld4 NE space AND NOT
         wa_processing-j2fld4 IN r_fieldlist[].
        create_data wa_processing-j2fld4
                    wa_processing-j2table
                    wa_processing-j2fld4 space.

        r_fieldlist-low = wa_processing-j2fld4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld5 NE space AND NOT
         wa_processing-j2fld5 IN r_fieldlist[].
        create_data wa_processing-j2fld5
                    wa_processing-j2table
                    wa_processing-j2fld5 space.

        r_fieldlist-low = wa_processing-j2fld5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld6 NE space AND NOT
         wa_processing-j2fld6 IN r_fieldlist[].
        create_data wa_processing-j2fld6
                    wa_processing-j2table
                    wa_processing-j2fld6 space.

        r_fieldlist-low = wa_processing-j2fld6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld7 NE space AND NOT
         wa_processing-j2fld7 IN r_fieldlist[].
        create_data wa_processing-j2fld7
                    wa_processing-j2table
                    wa_processing-j2fld7 space.

        r_fieldlist-low = wa_processing-j2fld7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld8 NE space AND NOT
         wa_processing-j2fld8 IN r_fieldlist[].
        create_data wa_processing-j2fld8
                    wa_processing-j2table
                    wa_processing-j2fld8 space.

        r_fieldlist-low = wa_processing-j2fld8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld9 NE space AND NOT
         wa_processing-j2fld9 IN r_fieldlist[].
        create_data wa_processing-j2fld9
                    wa_processing-j2table
                    wa_processing-j2fld9 space.

        r_fieldlist-low = wa_processing-j2fld9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld10 NE space AND NOT
         wa_processing-j2fld10 IN r_fieldlist[].
        create_data wa_processing-j2fld10
                    wa_processing-j2table
                    wa_processing-j2fld10 space.

        r_fieldlist-low = wa_processing-j2fld10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld11 NE space AND NOT
         wa_processing-j2fld11 IN r_fieldlist[].
        create_data wa_processing-j2fld11
                    wa_processing-j2table
                    wa_processing-j2fld11 space.

        r_fieldlist-low = wa_processing-j2fld11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld12 NE space AND NOT
         wa_processing-j2fld12 IN r_fieldlist[].
        create_data wa_processing-j2fld12
                    wa_processing-j2table
                    wa_processing-j2fld12 space.

        r_fieldlist-low = wa_processing-j2fld12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld1 NE space AND NOT
         wa_processing-j3fld1 IN r_fieldlist[].
        create_data wa_processing-j3fld1
                    wa_processing-j3table
                    wa_processing-j3fld1 space.

        r_fieldlist-low = wa_processing-j3fld1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld2 NE space AND NOT
         wa_processing-j3fld2 IN r_fieldlist[].
        create_data wa_processing-j3fld2
                    wa_processing-j3table
                    wa_processing-j3fld2 space.

        r_fieldlist-low = wa_processing-j3fld2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld3 NE space AND NOT
         wa_processing-j3fld3 IN r_fieldlist[].
        create_data wa_processing-j3fld3
                    wa_processing-j3table
                    wa_processing-j3fld3 space.

        r_fieldlist-low = wa_processing-j3fld3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld4 NE space AND NOT
         wa_processing-j3fld4 IN r_fieldlist[].
        create_data wa_processing-j3fld4
                    wa_processing-j3table
                    wa_processing-j3fld4 space.

        r_fieldlist-low = wa_processing-j3fld4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld5 NE space AND NOT
         wa_processing-j3fld5 IN r_fieldlist[].
        create_data wa_processing-j3fld5
                    wa_processing-j3table
                    wa_processing-j3fld5 space.

        r_fieldlist-low = wa_processing-j3fld5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld6 NE space AND NOT
         wa_processing-j3fld6 IN r_fieldlist[].
        create_data wa_processing-j3fld6
                    wa_processing-j3table
                    wa_processing-j3fld6 space.

        r_fieldlist-low = wa_processing-j3fld6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld7 NE space AND NOT
         wa_processing-j3fld7 IN r_fieldlist[].
        create_data wa_processing-j3fld7
                    wa_processing-j3table
                    wa_processing-j3fld7 space.

        r_fieldlist-low = wa_processing-j3fld7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld8 NE space AND NOT
         wa_processing-j3fld8 IN r_fieldlist[].
        create_data wa_processing-j3fld8
                    wa_processing-j3table
                    wa_processing-j3fld8 space.

        r_fieldlist-low = wa_processing-j3fld8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld9 NE space AND NOT
         wa_processing-j3fld9 IN r_fieldlist[].
        create_data wa_processing-j3fld9
                    wa_processing-j3table
                    wa_processing-j3fld9 space.

        r_fieldlist-low = wa_processing-j3fld9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld10 NE space AND NOT
         wa_processing-j3fld10 IN r_fieldlist[].
        create_data wa_processing-j3fld10
                    wa_processing-j3table
                    wa_processing-j3fld10 space.

        r_fieldlist-low = wa_processing-j3fld10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld11 NE space AND NOT
         wa_processing-j3fld11 IN r_fieldlist[].
        create_data wa_processing-j3fld11
                    wa_processing-j3table
                    wa_processing-j3fld11 space.

        r_fieldlist-low = wa_processing-j3fld11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld12 NE space AND NOT
         wa_processing-j3fld12 IN r_fieldlist[].
        create_data wa_processing-j3fld12
                    wa_processing-j3table
                    wa_processing-j3fld12 space.

        r_fieldlist-low = wa_processing-j3fld12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

    ELSE.

      IF wa_processing-field1 NE space.
        create_data_dele wa_processing-field1
                wa_processing-table
                wa_processing-field1 space.

        r_fieldlist-low = wa_processing-field1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field2 NE space.
        create_data_dele wa_processing-field2
                    wa_processing-table
                    wa_processing-field2 space.

        r_fieldlist-low = wa_processing-field2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field3 NE space.
        create_data_dele wa_processing-field3
                    wa_processing-table
                    wa_processing-field3 space.

        r_fieldlist-low = wa_processing-field3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field4 NE space.
        create_data_dele wa_processing-field4
                    wa_processing-table
                    wa_processing-field4 space.

        r_fieldlist-low = wa_processing-field4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field5 NE space.
        create_data_dele wa_processing-field5
                    wa_processing-table
                    wa_processing-field5 space.

        r_fieldlist-low = wa_processing-field5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field6 NE space.
        create_data_dele wa_processing-field6
                    wa_processing-table
                    wa_processing-field6 space.

        r_fieldlist-low = wa_processing-field6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field7 NE space.
        create_data_dele wa_processing-field7
                    wa_processing-table
                    wa_processing-field7 space.

        r_fieldlist-low = wa_processing-field7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field8 NE space.
        create_data_dele wa_processing-field8
                    wa_processing-table
                    wa_processing-field8 space.

        r_fieldlist-low = wa_processing-field8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field9 NE space.
        create_data_dele wa_processing-field9
                    wa_processing-table
                    wa_processing-field9 space.

        r_fieldlist-low = wa_processing-field9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field10 NE space.
        create_data_dele wa_processing-field10
                    wa_processing-table
                    wa_processing-field10 space.

        r_fieldlist-low = wa_processing-field10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field11 NE space.
        create_data_dele wa_processing-field11
                    wa_processing-table
                    wa_processing-field11 space.

        r_fieldlist-low = wa_processing-field11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field12 NE space.
        create_data_dele wa_processing-field12
                    wa_processing-table
                    wa_processing-field12 space.

        r_fieldlist-low = wa_processing-field12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field13 NE space.
        create_data_dele wa_processing-field13
                    wa_processing-table
                    wa_processing-field13 space.

        r_fieldlist-low = wa_processing-field13.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field14 NE space.
        create_data_dele wa_processing-field14
                    wa_processing-table
                    wa_processing-field14 space.

        r_fieldlist-low = wa_processing-field14.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-field15 NE space.
        create_data_dele wa_processing-field15
                    wa_processing-table
                    wa_processing-field15 space.

        r_fieldlist-low = wa_processing-field15.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld1 NE space AND NOT
         wa_processing-j1fld1 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld1
                    wa_processing-j1table
                    wa_processing-j1fld1 space.

        r_fieldlist-low = wa_processing-j1fld1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld2 NE space AND NOT
         wa_processing-j1fld2 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld2
                    wa_processing-j1table
                    wa_processing-j1fld2 space.

        r_fieldlist-low = wa_processing-j1fld2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld3 NE space AND NOT
         wa_processing-j1fld3 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld3
                    wa_processing-j1table
                    wa_processing-j1fld3 space.

        r_fieldlist-low = wa_processing-j1fld3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld4 NE space AND NOT
         wa_processing-j1fld4 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld4
                    wa_processing-j1table
                    wa_processing-j1fld4 space.

        r_fieldlist-low = wa_processing-j1fld4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld5 NE space AND NOT
         wa_processing-j1fld5 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld5
                    wa_processing-j1table
                    wa_processing-j1fld5 space.

        r_fieldlist-low = wa_processing-j1fld5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld6 NE space AND NOT
         wa_processing-j1fld6 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld6
                    wa_processing-j1table
                    wa_processing-j1fld6 space.

        r_fieldlist-low = wa_processing-j1fld6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld7 NE space AND NOT
         wa_processing-j1fld7 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld7
                    wa_processing-j1table
                    wa_processing-j1fld7 space.

        r_fieldlist-low = wa_processing-j1fld7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld8 NE space AND NOT
         wa_processing-j1fld8 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld8
                    wa_processing-j1table
                    wa_processing-j1fld8 space.

        r_fieldlist-low = wa_processing-j1fld8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld9 NE space AND NOT
         wa_processing-j1fld9 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld9
                    wa_processing-j1table
                    wa_processing-j1fld9 space.

        r_fieldlist-low = wa_processing-j1fld9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld10 NE space AND NOT
         wa_processing-j1fld10 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld10
                    wa_processing-j1table
                    wa_processing-j1fld10 space.

        r_fieldlist-low = wa_processing-j1fld10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld11 NE space AND NOT
         wa_processing-j1fld11 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld11
                    wa_processing-j1table
                    wa_processing-j1fld11 space.

        r_fieldlist-low = wa_processing-j1fld11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j1fld12 NE space AND NOT
         wa_processing-j1fld12 IN r_fieldlist[].
        create_data_dele wa_processing-j1fld12
                    wa_processing-j1table
                    wa_processing-j1fld12 space.

        r_fieldlist-low = wa_processing-j1fld12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld1 NE space AND NOT
         wa_processing-j2fld1 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld1
                    wa_processing-j2table
                    wa_processing-j2fld1 space.

        r_fieldlist-low = wa_processing-j2fld1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld2 NE space AND NOT
         wa_processing-j2fld2 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld2
                    wa_processing-j2table
                    wa_processing-j2fld2 space.

        r_fieldlist-low = wa_processing-j2fld2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld3 NE space AND NOT
         wa_processing-j2fld3 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld3
                    wa_processing-j2table
                    wa_processing-j2fld3 space.

        r_fieldlist-low = wa_processing-j2fld3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld4 NE space AND NOT
         wa_processing-j2fld4 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld4
                    wa_processing-j2table
                    wa_processing-j2fld4 space.

        r_fieldlist-low = wa_processing-j2fld4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld5 NE space AND NOT
         wa_processing-j2fld5 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld5
                    wa_processing-j2table
                    wa_processing-j2fld5 space.

        r_fieldlist-low = wa_processing-j2fld5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld6 NE space AND NOT
         wa_processing-j2fld6 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld6
                    wa_processing-j2table
                    wa_processing-j2fld6 space.

        r_fieldlist-low = wa_processing-j2fld6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld7 NE space AND NOT
         wa_processing-j2fld7 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld7
                    wa_processing-j2table
                    wa_processing-j2fld7 space.

        r_fieldlist-low = wa_processing-j2fld7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld8 NE space AND NOT
         wa_processing-j2fld8 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld8
                    wa_processing-j2table
                    wa_processing-j2fld8 space.

        r_fieldlist-low = wa_processing-j2fld8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld9 NE space AND NOT
         wa_processing-j2fld9 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld9
                    wa_processing-j2table
                    wa_processing-j2fld9 space.

        r_fieldlist-low = wa_processing-j2fld9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld10 NE space AND NOT
         wa_processing-j2fld10 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld10
                    wa_processing-j2table
                    wa_processing-j2fld10 space.

        r_fieldlist-low = wa_processing-j2fld10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld11 NE space AND NOT
         wa_processing-j2fld11 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld11
                    wa_processing-j2table
                    wa_processing-j2fld11 space.

        r_fieldlist-low = wa_processing-j2fld11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j2fld12 NE space AND NOT
         wa_processing-j2fld12 IN r_fieldlist[].
        create_data_dele wa_processing-j2fld12
                    wa_processing-j2table
                    wa_processing-j2fld12 space.

        r_fieldlist-low = wa_processing-j2fld12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld1 NE space AND NOT
         wa_processing-j3fld1 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld1
                    wa_processing-j3table
                    wa_processing-j3fld1 space.

        r_fieldlist-low = wa_processing-j3fld1.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld2 NE space AND NOT
         wa_processing-j3fld2 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld2
                    wa_processing-j3table
                    wa_processing-j3fld2 space.

        r_fieldlist-low = wa_processing-j3fld2.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld3 NE space AND NOT
         wa_processing-j3fld3 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld3
                    wa_processing-j3table
                    wa_processing-j3fld3 space.

        r_fieldlist-low = wa_processing-j3fld3.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld4 NE space AND NOT
         wa_processing-j3fld4 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld4
                    wa_processing-j3table
                    wa_processing-j3fld4 space.

        r_fieldlist-low = wa_processing-j3fld4.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld5 NE space AND NOT
         wa_processing-j3fld5 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld5
                    wa_processing-j3table
                    wa_processing-j3fld5 space.

        r_fieldlist-low = wa_processing-j3fld5.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld6 NE space AND NOT
         wa_processing-j3fld6 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld6
                    wa_processing-j3table
                    wa_processing-j3fld6 space.

        r_fieldlist-low = wa_processing-j3fld6.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld7 NE space AND NOT
         wa_processing-j3fld7 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld7
                    wa_processing-j3table
                    wa_processing-j3fld7 space.

        r_fieldlist-low = wa_processing-j3fld7.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld8 NE space AND NOT
         wa_processing-j3fld8 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld8
                    wa_processing-j3table
                    wa_processing-j3fld8 space.

        r_fieldlist-low = wa_processing-j3fld8.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld9 NE space AND NOT
         wa_processing-j3fld9 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld9
                    wa_processing-j3table
                    wa_processing-j3fld9 space.

        r_fieldlist-low = wa_processing-j3fld9.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld10 NE space AND NOT
         wa_processing-j3fld10 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld10
                    wa_processing-j3table
                    wa_processing-j3fld10 space.

        r_fieldlist-low = wa_processing-j3fld10.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld11 NE space AND NOT
         wa_processing-j3fld11 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld11
                    wa_processing-j3table
                    wa_processing-j3fld11 space.

        r_fieldlist-low = wa_processing-j3fld11.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.

      IF wa_processing-j3fld12 NE space AND NOT
         wa_processing-j3fld12 IN r_fieldlist[].
        create_data_dele wa_processing-j3fld12
                    wa_processing-j3table
                    wa_processing-j3fld12 space.

        r_fieldlist-low = wa_processing-j3fld12.
        APPEND r_fieldlist. CLEAR r_fieldlist-low.
      ENDIF.


    ENDIF.

    CONCATENATE p_type l_text1 c_dot INTO v_temp_string.
    CONCATENATE 'end of' v_temp_string
                INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

  ENDLOOP.

*************Changes by Shastry
  add_macro_line space.
  add_macro_line text-d07.

  add_macro_line space.
  add_macro_line text-c25. "'* Table type for output data'.
  CONCATENATE p_ttype 'outdata' INTO v_temp_string.
  CONCATENATE 'types' v_temp_string 'type standard table of' p_type
                      INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'outdata' '.'  INTO v_temp_string.
*  CONCATENATE v_temp_string 'initial size 0.' INTO v_temp_string
*                                    SEPARATED BY space.
  add_macro_line v_temp_string.

  IF p_lfup EQ c_on OR p_afup EQ c_on.
    add_macro_line space.
    add_macro_line text-c26. "'* Table type for File data'.
    CONCATENATE p_ttype 'infile' INTO v_temp_string.
    CONCATENATE 'types' v_temp_string 'type standard table of' p_type
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'infile' '.' INTO v_temp_string.
*    CONCATENATE v_temp_string 'initial size 0.' INTO v_temp_string
*                                      SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  LOOP AT i_processing INTO wa_processing.

* Add data declaration for internal tables to be used in
* processing logic part
*  if p_chjn1 eq c_on.
    add_macro_line space.
*    CONCATENATE '* Table type for structure'
*                  wa_processing-table   wa_processing-j1table
*                  wa_processing-j2table wa_processing-j3table
*                 INTO v_temp_string SEPARATED BY space.
*    add_macro_line v_temp_string.

    IF wa_processing-j3table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table  wa_processing-j3table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j2table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j1table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
             INTO l_text1 SEPARATED BY '_'.
    ELSE.
      l_text1 = wa_processing-table.
    ENDIF.

    CONCATENATE  p_type l_text1 INTO v_temp_string.
    CONCATENATE text-c27 "'* Table type for structure'
                v_temp_string
                        INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_ttype l_text1 INTO v_temp_string.
    CONCATENATE 'types' v_temp_string
                      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'type standard table of' p_type
                    INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string l_text1 '.'  INTO v_temp_string.
*    CONCATENATE v_temp_string 'initial size 0.' INTO v_temp_string
*                                                SEPARATED BY space.

    l_index1 = STRLEN( v_temp_string ).
    IF l_index1 GT 72.
      SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1 .
      add_macro_line v_temp_string.
      CLEAR v_temp_string.
      CONCATENATE 'of' l_text1 INTO v_temp_string+15.
      add_macro_line v_temp_string.
    ELSE.
      add_macro_line v_temp_string.
    ENDIF.

  ENDLOOP.

********Changes on 26-02-2009*****************

* Table ttype declarations for BAPI
  IF p_chbapi EQ c_on.

* Select data for the BAPI interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef
    WHERE funcname EQ p_bapi
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.
    SORT i_fupararef BY paramtype pposition.

    LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'T'
                                            AND optional EQ space.
      add_macro_line space.
      CONCATENATE
      text-c28 "'* Parameter Table used in BAPI'
      p_bapi
                      INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_ttype wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'types' v_temp_string
          INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string 'type standard table of'
           wa_fupararef-structure '.'
*      add_macro_line v_temp_string.
*      CLEAR v_temp_string.
*      CONCATENATE 'of'
*      INTO v_temp_string+15 SEPARATED BY space.
*        'initial size 0.'
        INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.

    ENDLOOP.

  ENDIF.

* Add BDC related data
  IF p_bdc EQ c_on.
    add_macro_line space.
    add_macro_line text-c29 . "'* Batch input data table type'.
    CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdcdata' INTO v_temp_string.
    CONCATENATE v_temp_string
                'type standard table of bdcdata .'
                    INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c30. "'* Table type for BDC Call transaction messages'.
    CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdc_messages' INTO v_temp_string.
    CONCATENATE v_temp_string
                'type standard table of bdcmsgcoll .'
                    INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

*  IF p_alv EQ c_on.
*    add_macro_line space.
*    add_macro_line '* Internal table for ALV Field Catalog'.
*    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
*    CONCATENATE v_temp_string 'fieldcat' INTO v_temp_string.
*    CONCATENATE v_temp_string 'type slis_t_fieldcat_alv.'
*                          INTO v_temp_string SEPARATED BY space.
*    add_macro_line v_temp_string.
*
*    add_macro_line space.
*    add_macro_line '* Internal table for ALV field Sort Catalog'.
*    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
*    CONCATENATE v_temp_string 'sortcat' INTO v_temp_string.
*    CONCATENATE v_temp_string 'type slis_t_sortinfo_alv.'
*                              INTO v_temp_string SEPARATED BY space.
*    add_macro_line v_temp_string.
*
*    add_macro_line space.
*    add_macro_line '* Internal table for ALV Field Events'.
*    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
*    CONCATENATE v_temp_string 'event' INTO v_temp_string.
*    CONCATENATE v_temp_string 'type slis_t_event.'
*                             INTO v_temp_string SEPARATED BY space.
*    add_macro_line v_temp_string.
*
*    add_macro_line space.
*    add_macro_line '* Internal table for ALV Header declarations'.
*    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
*    CONCATENATE v_temp_string 'alv_header' INTO v_temp_string.
*    CONCATENATE v_temp_string 'type slis_t_listheader.'
*                           INTO v_temp_string SEPARATED BY space.
*    add_macro_line v_temp_string.
*  ENDIF.

* Create IDoc data declaration
  IF p_chido EQ c_on OR p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c31. "'* Table type  for IDoc Control record'.
    CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidc' INTO v_temp_string.
    CONCATENATE v_temp_string
    'type standard table of edidc.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chido EQ c_on.
    add_macro_line space.
    add_macro_line text-c32. "'* Table type for Idoc Data record'.
    CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_out' INTO v_temp_string.
    CONCATENATE v_temp_string
    'type standard table of edidd.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c32. "'* Table type for Idoc Data record'.
    CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_in' INTO v_temp_string.
    CONCATENATE v_temp_string
    'type standard table of edi_dd40 .'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chido EQ c_on OR p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c34. "'* Table type for Idoc status record'.
    CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edids' INTO v_temp_string.
    CONCATENATE v_temp_string
    'type standard table of edids .'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  add_macro_line space.
  add_macro_line text-c35. " '* Table type for Error '.
  CONCATENATE 'types' p_ttype INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'errors' INTO v_temp_string.
  CONCATENATE v_temp_string
            'type standard table of bapiret2.'
             INTO v_temp_string SEPARATED BY space.
  add_macro_line v_temp_string.
**************************************************
* Table Types declarations for FM1
  IF v_fm1 IS NOT INITIAL.

* Select data for the BAPI interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm1
    WHERE funcname EQ v_fm1
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm1 BY paramtype pposition.

    LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
       text-c36 "'* Table Type for data from FM'
       v_fm1
       INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_ttype wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'types' v_temp_string
          INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string 'type standard table of'
       wa_fupararef-structure '.'
       INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.

    ENDLOOP.

  ENDIF.

* Internal table declarations for FM2
  IF v_fm2 IS NOT INITIAL.

* Select data for the FM interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm2
    WHERE funcname EQ v_fm2
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm2 BY paramtype pposition.

    LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
     text-c36 "'* Table TYPE for data from FM'
     v_fm2
     INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_ttype wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'types' v_temp_string
                  INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string 'type standard table of'
        wa_fupararef-structure '.'
                INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.

    ENDLOOP.

  ENDIF.

* Internal table declarations for FM3
  IF v_fm3 IS NOT INITIAL.

* Select data for the FM interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm3
    WHERE funcname EQ v_fm3
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm3 BY paramtype pposition.

    LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
      text-c36 "'* Table TYPE for data from FM'
      v_fm3
      INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_ttype wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'types' v_temp_string
          INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string 'type standard table of'
        wa_fupararef-structure '.'
                INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.
    ENDLOOP.

  ENDIF.

* Internal table declarations for FM4
  IF v_fm4 IS NOT INITIAL.

* Select data for the FM interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm4
    WHERE funcname EQ v_fm4
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm4 BY paramtype pposition.

    LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
      text-c36 "'* Table TYPE for data from FM'
      v_fm4
      INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_ttype wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'types' v_temp_string
          INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string 'type standard table of'
        wa_fupararef-structure '.'
                INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.
    ENDLOOP.

  ENDIF.

**********************************************
*************End Changes

* Internal Tables
  add_macro_line space.
  add_macro_line text-d03.

  add_macro_line space.
  add_macro_line text-c40. "'* Internal table for output data'.
  CONCATENATE p_itab 'outdata' INTO v_temp_string.

**** Changes by Shastry
*    CONCATENATE p_type 'T_' INTO v_type.
***** End Changes

  CONCATENATE 'data' v_temp_string 'type' p_ttype
                      INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'outdata' '.'  INTO v_temp_string.
*  CONCATENATE v_temp_string 'initial size 0.' INTO v_temp_string
*                                    SEPARATED BY space.
  add_macro_line v_temp_string.

  IF p_lfup EQ c_on OR p_afup EQ c_on.
    add_macro_line space.
    add_macro_line text-c41. "'* Internal table for File data'.
    CONCATENATE p_itab 'infile' INTO v_temp_string.
**** Changes by Shastry
*    CONCATENATE p_type 'T_' INTO v_type.
***** End Changes
    CONCATENATE 'data' v_temp_string 'type' p_ttype
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'infile' '.' INTO v_temp_string.
*    CONCATENATE v_temp_string 'initial size 0.' INTO v_temp_string
*                                      SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  LOOP AT i_processing INTO wa_processing.

* Add data declaration for internal tables to be used in
* processing logic part
*  if p_chjn1 eq c_on.
    add_macro_line space.
    CONCATENATE text-c42 "'* Internal table for data from table'
                  wa_processing-table   wa_processing-j1table
                  wa_processing-j2table wa_processing-j3table
                 INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    IF wa_processing-j3table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table  wa_processing-j3table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j2table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j1table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
             INTO l_text1 SEPARATED BY '_'.
    ELSE.
      l_text1 = wa_processing-table.
    ENDIF.

    CONCATENATE p_itab l_text1 INTO v_temp_string.
    CONCATENATE 'data' v_temp_string
                      INTO v_temp_string SEPARATED BY space.
**** Changes by Shastry
*    CONCATENATE p_type 'T_' INTO v_type.
***** End Changes
    CONCATENATE v_temp_string 'type' p_ttype
                    INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string l_text1 '.' INTO v_temp_string.
*                                               SEPARATED BY space.
*    CONCATENATE v_temp_string 'initial size 0.' INTO v_temp_string
*                                                SEPARATED BY space.

    l_index1 = STRLEN( v_temp_string ).
    IF l_index1 GT 72.
      SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1 .
      add_macro_line v_temp_string.
      CLEAR v_temp_string.
      CONCATENATE 'of' l_text1 INTO v_temp_string+15.
      add_macro_line v_temp_string.
    ELSE.
      add_macro_line v_temp_string.
    ENDIF.

  ENDLOOP.

***********#########################################
***********Shud make Changes from here
***********#########################################

* Internal table declarations for BAPI
  IF p_chbapi EQ c_on.

* Select data for the BAPI interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef
    WHERE funcname EQ p_bapi
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.
    SORT i_fupararef BY paramtype pposition.

    LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'T'
                                            AND optional EQ space.
      add_macro_line space.
      CONCATENATE
      text-c28 "'* Parameter Table used in BAPI'
      p_bapi
                      INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string
          INTO v_temp_string SEPARATED BY space.
*********
      CLEAR v_ttype.
      CONCATENATE p_ttype wa_fupararef-parameter INTO v_ttype.
*********

      CONCATENATE v_temp_string 'type'
           v_ttype
*      add_macro_line v_temp_string.
*      CLEAR v_temp_string.
*      CONCATENATE 'of'
*      INTO v_temp_string+15 SEPARATED BY space.
        '.'
        INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.

    ENDLOOP.

  ENDIF.

* Add BDC related data
  IF p_bdc EQ c_on.
    add_macro_line space.
    add_macro_line text-c44. "'* Batch input data internal table'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdcdata' INTO v_temp_string.

*********
    CLEAR v_ttype.
    CONCATENATE p_ttype 'bdcdata' INTO v_ttype.
*********
    CONCATENATE v_temp_string
                'type' v_ttype '.'
                    INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c45. "'* Internal table for BDC Call transaction messages'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdc_messages' INTO v_temp_string.
*********
    CLEAR v_ttype.
    CONCATENATE p_ttype 'bdc_messages' INTO v_ttype.
*********
    CONCATENATE v_temp_string
                'type' v_ttype '.'
                    INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_alv EQ c_on.
    add_macro_line space.
    add_macro_line text-c46. "'* Internal table for ALV Field Catalog'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'fieldcat' INTO v_temp_string.
    CONCATENATE v_temp_string 'type slis_t_fieldcat_alv.'
                          INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c47. "'* Internal table for ALV field Sort Catalog'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'sortcat' INTO v_temp_string.
    CONCATENATE v_temp_string 'type slis_t_sortinfo_alv.'
                              INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c48. "'* Internal table for ALV Field Events'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'event' INTO v_temp_string.
    CONCATENATE v_temp_string 'type slis_t_event.'
                             INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c49. "'* Internal table for ALV Header declarations'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'alv_header' INTO v_temp_string.
    CONCATENATE v_temp_string 'type slis_t_listheader.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

* Create IDoc data declaration
  IF p_chido EQ c_on OR p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c50. "'* Internal table for IDoc Control record'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidc' INTO v_temp_string.

*********
    CLEAR v_ttype.
    CONCATENATE p_ttype 'edidc' INTO v_ttype.
*********

    CONCATENATE v_temp_string
    'type' v_ttype '.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chido EQ c_on.
    add_macro_line space.
    add_macro_line text-c51. "'* Internal table for Idoc Data record'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_out' INTO v_temp_string.

*********
    CLEAR v_ttype.
    CONCATENATE p_ttype 'edidd_out' INTO v_ttype.
*********
    CONCATENATE v_temp_string
    'type' v_ttype '.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c51. "'* Internal table for Idoc Data record'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_in' INTO v_temp_string.
*********
    CLEAR v_ttype.
    CONCATENATE p_ttype 'edidd_in' INTO v_ttype.
*********
    CONCATENATE v_temp_string
    'type' v_ttype '.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chido EQ c_on OR p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c53. "'* Internal table for Idoc status record'.
    CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edids' INTO v_temp_string.
*********
    CLEAR v_ttype.
    CONCATENATE p_ttype 'edids' INTO v_ttype.
*********

    CONCATENATE v_temp_string
    'type' v_ttype '.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  add_macro_line space.
  add_macro_line text-c54. "'* Error Internal table'.
  CONCATENATE 'data' p_itab INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'errors' INTO v_temp_string.
*********
  CLEAR v_ttype.
  CONCATENATE p_ttype 'errors' INTO v_ttype.
*********
  CONCATENATE v_temp_string
            'type' v_ttype '.'
             INTO v_temp_string SEPARATED BY space.
  add_macro_line v_temp_string.

* Internal table declarations for FM1
  IF v_fm1 IS NOT INITIAL.

* Select data for the BAPI interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm1
    WHERE funcname EQ v_fm1
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm1 BY paramtype pposition.

    LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
     text-c55 "'* Table for data from FM'
     v_fm1
     INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string
          INTO v_temp_string SEPARATED BY space.

*********
      CLEAR v_ttype.
      CONCATENATE p_ttype wa_fupararef-parameter INTO v_ttype.
*********

      CONCATENATE v_temp_string 'type'
       v_ttype '.'
       INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.

    ENDLOOP.

  ENDIF.

* Internal table declarations for FM2
  IF v_fm2 IS NOT INITIAL.

* Select data for the FM interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm2
    WHERE funcname EQ v_fm2
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm2 BY paramtype pposition.

    LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
     text-c55 "'* Table for data from FM'
     v_fm2
     INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string
                  INTO v_temp_string SEPARATED BY space.
*********
      CLEAR v_ttype.
      CONCATENATE p_ttype wa_fupararef-parameter INTO v_ttype.
*********

      CONCATENATE v_temp_string 'type' v_ttype '.'
                INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.

    ENDLOOP.

  ENDIF.

* Internal table declarations for FM3
  IF v_fm3 IS NOT INITIAL.

* Select data for the FM interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm3
    WHERE funcname EQ v_fm3
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm3 BY paramtype pposition.

    LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
      text-c55 "'* Table for data from FM'
      v_fm3
      INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string
          INTO v_temp_string SEPARATED BY space.
*********
      CLEAR v_ttype.
      CONCATENATE p_ttype wa_fupararef-parameter INTO v_ttype.
*********
      CONCATENATE v_temp_string 'type' v_ttype '.'
                INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.
    ENDLOOP.

  ENDIF.

* Internal table declarations for FM4
  IF v_fm4 IS NOT INITIAL.

* Select data for the FM interface from Fupararef
    SELECT * FROM fupararef
    INTO TABLE i_fupararef_fm4
    WHERE funcname EQ v_fm4
      AND ( paramtype EQ 'T' OR paramtype EQ 'I' OR paramtype EQ 'E' ).
*      and optional eq space.

    SORT i_fupararef_fm4 BY paramtype pposition.

    LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional  EQ space.
      add_macro_line space.
      CONCATENATE
      text-c55 "'* Table for data from FM'
      v_fm4
      INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.

      CONCATENATE p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string
          INTO v_temp_string SEPARATED BY space.
*********
      CLEAR v_ttype.
      CONCATENATE p_ttype wa_fupararef-parameter INTO v_ttype.
*********
      CONCATENATE v_temp_string 'type' v_ttype '.'
                INTO v_temp_string SEPARATED BY space.

      l_index1 = STRLEN( v_temp_string ).
      IF l_index1 GT 72.
        SPLIT v_temp_string AT ' of' INTO v_temp_string l_text1.
        add_macro_line v_temp_string.
        CLEAR v_temp_string.
        CONCATENATE 'of' l_text1 INTO v_temp_string+15.
        add_macro_line v_temp_string.
      ELSE.
        add_macro_line v_temp_string.
      ENDIF.
    ENDLOOP.

  ENDIF.

***********#########################################
***********Shud make Changes till here
***********#########################################

* Work areas
  add_macro_line space.
  add_macro_line text-d04.

  add_macro_line space.
  add_macro_line text-c59. "'* Work area for output data'.

  CONCATENATE p_wa 'outdata' INTO v_temp_string.
  CONCATENATE 'data' v_temp_string 'type' p_type
                             INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'outdata.' INTO v_temp_string.
  add_macro_line v_temp_string.

  IF p_lfup EQ c_on OR p_afup EQ c_on.
    add_macro_line space.
    add_macro_line text-c60. "'* Work area for File data'.
    CONCATENATE p_wa 'infile' INTO v_temp_string.
    CONCATENATE 'data' v_temp_string 'type' p_type
                               INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'infile.' INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

  LOOP AT i_processing INTO wa_processing.

* Add data declaration for internal tables to be used in
* processing logic part
*  if p_chjn1 eq c_on.
    add_macro_line space.
    IF wa_processing-j3table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table  wa_processing-j3table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j2table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
                  wa_processing-j2table
             INTO l_text1 SEPARATED BY '_'.
    ELSEIF wa_processing-j1table IS NOT INITIAL.
      CONCATENATE wa_processing-table    wa_processing-j1table
             INTO l_text1 SEPARATED BY '_'.
    ELSE.
      l_text1 = wa_processing-table.
    ENDIF.

    CONCATENATE  p_type l_text1 INTO v_temp_string.
    CONCATENATE text-c61 "'* Work area for structure'
    v_temp_string
    INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_wa l_text1 INTO v_temp_string.
    CONCATENATE 'data' v_temp_string 'type' p_type
                               INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string l_text1 c_dot INTO v_temp_string.
    add_macro_line v_temp_string.

  ENDLOOP.

* Work area declarations for BAPI
  IF p_chbapi EQ c_on.

    LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'T'
                                            AND optional EQ space.

      add_macro_line space.
      CONCATENATE  p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE text-c62 "'* Work area for BAPI parameter tables'
      v_temp_string
      INTO v_temp_string SEPARATED BY space.

      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for bapi exporting parameter structures
    LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'I'
                                            AND optional EQ space
                                            AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c63 "'* Work area for BAPI exporting parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                              SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string  SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for bapi importing parameter structures
    LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'E'
                                            AND optional EQ space
                                            AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c64 "'* Work area for BAPI importing parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                                 SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

  ENDIF.

  IF p_bdc EQ c_on.
    add_macro_line space.
    add_macro_line text-c65. "'* Batch input data work area'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdcdata' INTO v_temp_string.
    CONCATENATE v_temp_string 'type bdcdata.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c66. "'* Work Area for BDC Call transaction messages'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdc_messages' INTO v_temp_string.
    CONCATENATE v_temp_string 'type bdcmsgcoll.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

* Work area declarations for FM1
  IF v_fm1 IS NOT INITIAL.

    LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional EQ space.

      add_macro_line space.
      CONCATENATE  p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE text-c67 "'* Work area for FM parameter tables'
      v_temp_string
      INTO v_temp_string SEPARATED BY space.

      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM exporting parameter structures
    LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'I'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c68 "'* Work area for FM exporting parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                              SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string  SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM importing parameter structures
    LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'E'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c69 "'* Work area for FM importing parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                                 SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

  ENDIF.

* Work area declarations for FM2
  IF v_fm2 IS NOT INITIAL.

    LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional EQ space.

      add_macro_line space.
      CONCATENATE  p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE text-c67 "'* Work area for FM parameter tables'
      v_temp_string
      INTO v_temp_string SEPARATED BY space.

      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM exporting parameter structures
    LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'I'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c68 "'* Work area for FM exporting parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                              SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string  SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM importing parameter structures
    LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'E'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c69 "'* Work area for FM importing parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                                 SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

  ENDIF.

* Work area declarations for FM3
  IF v_fm3 IS NOT INITIAL.

    LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional EQ space.

      add_macro_line space.
      CONCATENATE  p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE text-c67 "'* Work area for FM parameter tables'
      v_temp_string
      INTO v_temp_string SEPARATED BY space.

      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM exporting parameter structures
    LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'I'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c68 "'* Work area for FM exporting parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                              SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string  SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM importing parameter structures
    LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'E'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c69 "'* Work area for FM importing parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                                 SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

  ENDIF.

* Work area declarations for FM4
  IF v_fm4 IS NOT INITIAL.

    LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'T'
                                                AND optional EQ space.

      add_macro_line space.
      CONCATENATE  p_itab wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE text-c67 "'* Work area for FM parameter tables'
      v_temp_string
      INTO v_temp_string SEPARATED BY space.

      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM exporting parameter structures
    LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'I'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c68 "'* Work area for FM exporting parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                              SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string  SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

* add Workarea for FM importing parameter structures
    LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'E'
                                                AND optional EQ space
                                                AND structure NA '-'.

      add_macro_line space.
      CONCATENATE text-c69 "'* Work area for FM importing parameter:'
                    wa_fupararef-parameter INTO v_temp_string
                                                 SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE p_wa wa_fupararef-parameter INTO v_temp_string.
      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                      INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line v_temp_string.
    ENDLOOP.

  ENDIF.

  IF p_alv EQ c_on.
    add_macro_line space.
    add_macro_line text-c79 ."'* Work area for ALV Field layout'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'layout' INTO v_temp_string.
    CONCATENATE v_temp_string 'type slis_layout_alv.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c80. "'* Work area for Variant data for ALV'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'variant' INTO v_temp_string.
    CONCATENATE v_temp_string 'type disvariant.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chido EQ c_on OR p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c81. "'* Work Area for Idoc Control record'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidc' INTO v_temp_string.
    CONCATENATE v_temp_string 'type edidc.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chido EQ c_on.
    add_macro_line space.
    add_macro_line text-c82. "'* Work Area for Idoc Data record for outbound'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_out' INTO v_temp_string.
    CONCATENATE v_temp_string 'type edidd.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chidin EQ c_on.
    add_macro_line space.
    add_macro_line text-c83. "'* Work Area for Idoc Data record for inbound'.
    CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_in' INTO v_temp_string.
    CONCATENATE v_temp_string 'type edi_dd40.'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  add_macro_line space.
  add_macro_line text-c84. "'* Error Work area'.
  CONCATENATE 'data' p_wa INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string 'errors' INTO v_temp_string.
  CONCATENATE v_temp_string 'type bapiret2.'
                    INTO v_temp_string SEPARATED BY space.
  add_macro_line v_temp_string.

  IF  p_chidin EQ c_on.        "If any IDoc operations are involved

* First check whether the IDoc type entered is basic type or
* extension type
    SELECT SINGLE cimtyp INTO l_cimtyp FROM edcim
                      WHERE cimtyp EQ p_idtyp.

    IF sy-subrc EQ 0.
* If the Idoc is extension type
      CALL FUNCTION 'EXTTYPE_READ'
        EXPORTING
          pi_cimtyp        = p_idtyp
        TABLES
          pt_int_syntax    = i_idocstruc1
        EXCEPTIONS
          object_not_found = 1
          db_error         = 2
          no_authority     = 3
          OTHERS           = 4.

* If the Idoc is basic type
    ELSE.
      CALL FUNCTION 'IDOCTYPE_READ'
        EXPORTING
          pi_idoctyp       = p_idtyp
        TABLES
          pt_syntax        = i_idocstruc
        EXCEPTIONS
          object_not_found = 1
          db_error         = 2
          no_authority     = 3
          OTHERS           = 4.

    ENDIF.

  ENDIF.
* Get the structure of the IDoc type for outbound
  IF p_chido EQ c_on.

* First check whether the IDoc type entered is basic type
* or extension type
    SELECT SINGLE cimtyp INTO l_cimtyp FROM edcim
                      WHERE cimtyp EQ p_idtypo.

    IF sy-subrc EQ 0.
* If the Idoc is extension type
      CALL FUNCTION 'EXTTYPE_READ'
        EXPORTING
          pi_cimtyp        = p_idtypo
        TABLES
          pt_int_syntax    = i_idocstruc1
        EXCEPTIONS
          object_not_found = 1
          db_error         = 2
          no_authority     = 3
          OTHERS           = 4.

* If the Idoc is basic type
    ELSE.
      CALL FUNCTION 'IDOCTYPE_READ'
        EXPORTING
          pi_idoctyp       = p_idtypo
        TABLES
          pt_syntax        = i_idocstruc
        EXCEPTIONS
          object_not_found = 1
          db_error         = 2
          no_authority     = 3
          OTHERS           = 4.

    ENDIF.

  ENDIF.

  LOOP AT i_idocstruc1 INTO wa_idocstruc1.
    wa_idocstruc-segtyp = wa_idocstruc1-segtyp.
    APPEND wa_idocstruc TO i_idocstruc.
  ENDLOOP.

* Add data declaration for the Idoc segment if applicable
  LOOP AT i_idocstruc INTO wa_idocstruc.
    add_macro_line space.
    CONCATENATE text-c85 "'* Work area for IDoc Segment:'
           wa_idocstruc-segtyp INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
    CONCATENATE p_wa wa_idocstruc-segtyp INTO v_temp_string.
    CONCATENATE 'data' v_temp_string 'type' wa_idocstruc-segtyp
                    INTO v_temp_string  SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* Variables
  add_macro_line space.
  add_macro_line text-d05.
  add_macro_line space.

* To append the variables for select options..store the line index
  DESCRIBE TABLE i_program LINES v_linecount.

* add variable for bapi exporting parameter structures
  LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'I'
                                          AND optional EQ space
                                          AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c86 "'* Variable for BAPI exporting parameter:'
       wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for bapi importing parameter structures
  LOOP AT i_fupararef INTO wa_fupararef WHERE paramtype EQ 'E'
                                          AND optional EQ space
                                          AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c87 "'* Variable for BAPI importing parameter:'
         wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

  IF p_lfup EQ c_on OR p_afup EQ c_on
  OR p_lfdl EQ c_on OR p_afdl EQ c_on.
    add_macro_line space.
    add_macro_line text-c88 . "'* Variable for storing file name'.
    CONCATENATE p_glob 'filename' INTO v_temp_string.
    CONCATENATE 'data' v_temp_string 'type string.'
                        INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

  IF p_chidin EQ c_on OR p_chido EQ c_on.
    add_macro_line space.
    add_macro_line text-c89. "'* IDoc number'.
    CONCATENATE p_glob 'idoc_number' INTO v_temp_string.
    CONCATENATE 'data' v_temp_string 'type edidc-docnum.'
                        INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.
  ENDIF.

* add variable for FM exporting parameter structures
  LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'I'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c90 "'* Variable for FM exporting parameter:'
       wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM importing parameter structures
  LOOP AT i_fupararef_fm1 INTO wa_fupararef WHERE paramtype EQ 'E'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c91 "'* Variable for FM importing parameter:'
         wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM exporting parameter structures
  LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'I'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c90 "'* Variable for FM exporting parameter:'
       wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM importing parameter structures
  LOOP AT i_fupararef_fm2 INTO wa_fupararef WHERE paramtype EQ 'E'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c91 "'* Variable for FM importing parameter:'
         wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM exporting parameter structures
  LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'I'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c90 "'* Variable for FM exporting parameter:'
       wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM importing parameter structures
  LOOP AT i_fupararef_fm3 INTO wa_fupararef WHERE paramtype EQ 'E'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c91 "'* Variable for FM importing parameter:'
         wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM exporting parameter structures
  LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'I'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c90 "'* Variable for FM exporting parameter:'
       wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* add variable for FM importing parameter structures
  LOOP AT i_fupararef_fm4 INTO wa_fupararef WHERE paramtype EQ 'E'
                                              AND optional EQ space
                                              AND structure CA '-'.

    add_macro_line space.
    CONCATENATE text-c91 "'* Variable for FM importing parameter:'
         wa_fupararef-parameter INTO v_temp_string SEPARATED BY space.
    add_macro_line v_temp_string.

    CONCATENATE p_glob wa_fupararef-parameter INTO v_temp_string.
****    Changes by Shastry
    IF p_tabfld = 'X'.

      CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                          INTO v_temp_string SEPARATED BY space.

    ELSE.
      SPLIT wa_fupararef-structure AT '-' INTO v_table v_field.
      IF v_field IS NOT INITIAL.

        SELECT SINGLE rollname INTO v_dataele
        FROM dd03l WHERE tabname EQ v_table AND fieldname EQ v_field.
        IF v_dataele IS NOT INITIAL.

          CONCATENATE 'data' v_temp_string 'type' v_dataele
                               INTO v_temp_string SEPARATED BY space.
          CLEAR v_dataele.
        ELSE.
          CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                               INTO v_temp_string SEPARATED BY space.

        ENDIF.
      ELSE.
        CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
                             INTO v_temp_string SEPARATED BY space.

      ENDIF.
    ENDIF.
****
*    CONCATENATE 'data' v_temp_string 'type' wa_fupararef-structure
*                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDLOOP.

* Flags
  add_macro_line space.
  add_macro_line text-d06.

ENDFORM.                    "SETUP_DATA_DECLARATION

*$*$-------------------------------------------------------------------*
*$*$ form setup_selection_screen.
*$*$-------------------------------------------------------------------*
FORM setup_selection_screen.

  TYPES: BEGIN OF l_ty_selection,
          field  TYPE char24,
          text   TYPE char40,
          name   TYPE char8,
          default TYPE char24,
         END OF l_ty_selection.

  DATA l_tabix TYPE sy-tabix.

  DATA: l_field1(17)  TYPE c,
        l_field2(17)  TYPE c,
        l_field3(17)  TYPE c,
        l_field4(17)  TYPE c,
        l_field5(17)  TYPE c,
        l_field6(17)  TYPE c.

  DATA l_i_selection TYPE STANDARD TABLE OF ty_selection INITIAL SIZE 0.
  DATA l_i_radio TYPE STANDARD TABLE OF l_ty_selection INITIAL SIZE 0.
  DATA l_wa_radio TYPE l_ty_selection.

  REFRESH i_program_temp2[].
  REFRESH i_gpvaltab[].
  CLEAR wa_gpvaltab.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-s00.
  add_macro_line text-100.

  l_i_selection[] = i_selection[].

  DELETE i_selection WHERE ( etype EQ 'R' OR etype EQ 'C' ).

* Add Parameter 1 on the screen
  IF i_selection[] IS NOT INITIAL.

* Begin Block 1
    beginblock 'A' 'Selection Parameters'.

    LOOP AT i_selection INTO wa_selection.

      IF wa_selection-ftype EQ 'D'.

* If no dictionary reference present, then use sy-datum
        IF wa_selection-table IS INITIAL
        AND wa_selection-field IS INITIAL.

          IF wa_selection-etype EQ 'P'.
            param wa_selection-name wa_selection-text
                    'sy' 'datum' wa_selection-mand wa_selection-dfault.
          ELSE.
            soptions wa_selection-name wa_selection-text
                    'sy' 'datum' wa_selection-mand wa_selection-dfault.
          ENDIF.

        ELSE.
          IF wa_selection-etype EQ 'P'.
            param wa_selection-name wa_selection-text
                            wa_selection-table wa_selection-field
                            wa_selection-mand wa_selection-dfault.
          ELSE.
            soptions wa_selection-name wa_selection-text
                            wa_selection-table wa_selection-field
                            wa_selection-mand wa_selection-dfault.
          ENDIF.

        ENDIF.

      ELSEIF wa_selection-ftype EQ 'T'.
* If no dictionary reference present, then use sy-uzeit
        IF wa_selection-table IS INITIAL
        AND wa_selection-field IS INITIAL.

          IF wa_selection-etype EQ 'P'.
            param wa_selection-name wa_selection-text
                  'sy' 'uzeit' wa_selection-mand wa_selection-dfault.
          ELSE.
            soptions wa_selection-name wa_selection-text
                  'sy' 'uzeit' wa_selection-mand wa_selection-dfault.
          ENDIF.

        ELSE.
          IF wa_selection-etype EQ 'P'.
            param wa_selection-name wa_selection-text
                            wa_selection-table wa_selection-field
                            wa_selection-mand wa_selection-dfault.
          ELSE.
            soptions wa_selection-name wa_selection-text
                            wa_selection-table wa_selection-field
                            wa_selection-mand wa_selection-dfault.
          ENDIF.
        ENDIF.

      ELSE.
        IF wa_selection-etype EQ 'P'.

          param wa_selection-name wa_selection-text
                          wa_selection-table wa_selection-field
                          wa_selection-mand wa_selection-dfault.

          IF wa_selection-check IS NOT INITIAL.
            atselectionscr wa_selection-text wa_selection-check
                           wa_selection-field 'P' wa_selection-name.
          ELSE.
            atselectionscr wa_selection-text wa_selection-table
                           wa_selection-field 'P' wa_selection-name.
          ENDIF.

        ELSE.

          soptions wa_selection-name wa_selection-text
                            wa_selection-table wa_selection-field
                            wa_selection-mand wa_selection-dfault.

          IF wa_selection-check IS NOT INITIAL.
            atselectionscr wa_selection-text wa_selection-check
                           wa_selection-field 'S' wa_selection-name.
          ELSE.
            atselectionscr wa_selection-text wa_selection-table
                           wa_selection-field 'S' wa_selection-name.
          ENDIF.

        ENDIF.

        IF wa_selection-grpval NE space.
          wa_gpvaltab-tabname = wa_selection-grpval.
          wa_gpvaltab-field = wa_selection-field.
          wa_gpvaltab-type  = wa_selection-etype.
          wa_gpvaltab-fname = wa_selection-name.
          APPEND wa_gpvaltab TO i_gpvaltab.
          CLEAR wa_gpvaltab.
        ENDIF.

      ENDIF.
    ENDLOOP.

* If any select options are used, then insert lines for
* variables decl for Select options
    INSERT lines of i_program_temp2 INTO i_program INDEX v_linecount.
    REFRESH i_program_temp2.

* End Block A
    endblock 'A'.

  ENDIF.

  i_selection[] = l_i_selection[].

  DELETE i_selection WHERE ( etype EQ 'P' OR etype EQ 'S'
                          OR etype EQ 'C' ).

  SORT i_selection BY field.

* Add RadioButton on the screen
  IF i_selection[] IS NOT INITIAL.

    LOOP AT i_selection INTO wa_selection.
      l_wa_radio-text =  wa_selection-text.
      l_wa_radio-name =  wa_selection-name.
      l_wa_radio-field =  wa_selection-field.
      l_wa_radio-default =  wa_selection-dfault.
      APPEND l_wa_radio TO l_i_radio.
      CLEAR l_wa_radio.
    ENDLOOP.

* Begin Block 2
    beginblock 'B' 'Radio Options'.

    LOOP AT l_i_radio INTO l_wa_radio.

      radioleft 40 l_wa_radio-text l_wa_radio-name
                    l_wa_radio-field l_wa_radio-default.

      AT END OF field.
        blankline.
      ENDAT.

    ENDLOOP.

* Radio Button End Block
    endblock 'B'.
  ENDIF.

  i_selection[] = l_i_selection[].

  DELETE i_selection WHERE ( etype EQ 'P' OR etype EQ 'S'
                          OR etype EQ 'R' ).

* Add RadioButton on the screen
  IF i_selection[] IS NOT INITIAL.

* Begin Block 2
    beginblock 'C' 'CheckBox Options'.

    LOOP AT i_selection INTO wa_selection.
      checkleft 1 wa_selection-text
                    wa_selection-name wa_selection-dfault.
    ENDLOOP.

    endblock 'C'.
  ENDIF.

  i_selection[] = l_i_selection[].

  IF p_alv EQ c_on.            "ALV Display Variant
    beginblock 'H' 'ALV Variant'.
    param 'alvv' text-038 'DISVARIANT' 'VARIANT' space space.
    endblock 'H'.

    add_macro_line_temp space.
    CONCATENATE text-c07 "'*$*$ Validate'
                text-038
                INTO v_temp_string SEPARATED BY space.
    add_macro_line_temp v_temp_string.

    CONCATENATE 'At Selection-Screen ON' p_para
                  INTO v_temp_string SEPARATED BY space.

    CONCATENATE v_temp_string 'alvv' c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.
    add_macro_line_temp text-c70. "'* Check the existence of Variant'.
    CONCATENATE 'perform alv_variant_check using' p_wa
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'variant' INTO v_temp_string.
    CONCATENATE v_temp_string p_para
                  INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'alvv' c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.

    valuerequest 'ALVV'.

  ENDIF.

* If File Operations are involved
  IF p_lfup EQ c_on.
    beginblock 'D' 'Upload Local File'.
    param 'LFUP' text-019 space space 'Y' space.
    valuerequest 'LFUP'.
    endblock 'D'.
  ENDIF.

  IF p_lfdl EQ c_on.
    beginblock 'E' 'Download Local File'.
    param 'LFDL' text-020 space space 'Y' space.
    valuerequest 'LFDL'.
    endblock 'E'.
  ENDIF.

  IF p_afup EQ c_on.
    beginblock 'F' 'Upload Application Server File'.
    param 'AFUPD' text-021 space space 'Y' space.
    param 'AFUPF' text-023 space space 'Y' space.
    valuerequest 'AFUPF'.
    endblock 'F'.
  ENDIF.

  IF p_afdl EQ c_on.
    beginblock 'G' 'Download Application Server File'.
    param 'AFDLD' text-024 space space 'Y' space.
    param 'AFDLF' text-025 space space 'Y' space.
*    valuerequest 'AFDLF'.
    endblock 'G'.
  ENDIF.

  SORT i_gpvaltab BY tabname.

  CLEAR l_tabix.
  LOOP AT i_gpvaltab INTO wa_gpvaltab.

    AT FIRST.

      add_macro_line_temp space.
      add_macro_line_temp text-100.
      add_macro_line_temp text-as3.
      add_macro_line_temp text-100.

      CONCATENATE 'At Selection-Screen' c_dot INTO v_temp_string.
      add_macro_line_temp v_temp_string.

    ENDAT.

    l_tabix = l_tabix + 1.

    IF l_tabix EQ 1.
      l_field1 = wa_gpvaltab-field.
      l_field1+10 =  wa_gpvaltab-type.
      l_field1+11 =  wa_gpvaltab-fname.
    ENDIF.
    IF l_tabix EQ 2.
      l_field2 = wa_gpvaltab-field.
      l_field2+10 =  wa_gpvaltab-type.
      l_field2+11 =  wa_gpvaltab-fname.
    ENDIF.
    IF l_tabix EQ 3.
      l_field3 = wa_gpvaltab-field.
      l_field3+10 =  wa_gpvaltab-type.
      l_field3+11 =  wa_gpvaltab-fname.
    ENDIF.
    IF l_tabix EQ 4.
      l_field4 = wa_gpvaltab-field.
      l_field4+10 =  wa_gpvaltab-type.
      l_field4+11 =  wa_gpvaltab-fname.
    ENDIF.
    IF l_tabix EQ 5.
      l_field5 = wa_gpvaltab-field.
      l_field5+10 =  wa_gpvaltab-type.
      l_field5+11 =  wa_gpvaltab-fname.
    ENDIF.
    IF l_tabix EQ 6.
      l_field6 = wa_gpvaltab-field.
      l_field6+10 =  wa_gpvaltab-type.
      l_field6+11 =  wa_gpvaltab-fname.
    ENDIF.

    AT END OF tabname.

      IF l_tabix EQ 1.
        CLEAR l_tabix.
        CONTINUE.
      ENDIF.

      create_grpval wa_gpvaltab-tabname l_field1 l_field2
              l_field3 l_field4 l_field5 l_field6.

      CLEAR l_tabix.
      CLEAR: l_field1, l_field2, l_field3, l_field4, l_field5, l_field6.

    ENDAT.

  ENDLOOP.

ENDFORM.                    "SETUP_SELECTION_SCREEN

*$*$-------------------------------------------------------------------*
*$*$ form setup_initialization.
*$*$-------------------------------------------------------------------*
FORM setup_initialization.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-159.
  add_macro_line text-100.

  add_macro_line 'Initialization.'.

  IF p_alv EQ c_on.
    add_macro_line space.

* Get default variant
    add_macro_line text-c71. "'* Get default variant for ALV'.
    CONCATENATE p_wa 'variant-report = sy-repid.' INTO v_temp_string.
    add_macro_line v_temp_string.

    add_macro_line text-039.
    add_macro_line 'EXPORTING'.
    CONCATENATE 'I_SAVE     =' text-121
      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'A' text-121 INTO v_temp_string.
    add_macro_line v_temp_string.
    add_macro_line 'CHANGING'.
    CONCATENATE 'CS_VARIANT =' p_wa
      INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'variant' INTO v_temp_string.
    add_macro_line v_temp_string.
    add_macro_line 'EXCEPTIONS'.
    add_macro_line 'NOT_FOUND  = 2.'.
    add_macro_line  'IF SY-SUBRC = 0.'.
    CONCATENATE p_para 'alvv' INTO v_temp_string.
    CONCATENATE v_temp_string '=' p_wa
                                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'VARIANT-VARIANT' c_dot
                      INTO v_temp_string.
    add_macro_line v_temp_string.
    add_macro_line 'ENDIF.'.

  ENDIF.

ENDFORM.                    "SETUP_INITIALIZATION

*$*$-------------------------------------------------------------------*
*$*$ form setup_at-selection-screen.
*$*$-------------------------------------------------------------------*
FORM setup_at-selection-screen.

  DATA l_text(50) TYPE c.
  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-as1.
  add_macro_line text-100.

  APPEND LINES OF i_program_temp TO i_program.
  REFRESH i_program_temp.

ENDFORM.                    "SETUP_AT-SELECTION-SCREEN

*$*$-------------------------------------------------------------------*
*$*$ form setup_top_of_page.
*$*$-------------------------------------------------------------------*
FORM setup_top_of_page.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-140.
  add_macro_line text-100.
  add_macro_line 'TOP-OF-PAGE.'.
  add_macro_line text-c72. "'* Subroutine for Top of Page event.'.
  add_macro_line text-c73. "'* perform top_of_page.'.

ENDFORM.                    "SETUP_TOP_OF_PAGE

*$*$-------------------------------------------------------------------*
*$*$ form setup_end_of_page.
*$*$-------------------------------------------------------------------*
FORM setup_end_of_page.

  add_macro_line space.
  add_macro_line text-100.
  add_macro_line text-141.
  add_macro_line text-100.
  add_macro_line 'end-of-page.'.
  add_macro_line text-c74. "'* Subroutine for End of Page event.'.
  add_macro_line text-c75. "'* perform end_of_page.'.

ENDFORM.                    "SETUP_TOP_OF_PAGE

*$*$-------------------------------------------------------------------*
*$*$ form setup_start-of-selection.
*$*$-------------------------------------------------------------------*
FORM setup_start-of-selection.

  TYPE-POOLS swbse.
  DATA l_final_text(132) TYPE c.
  DATA l_i_bapifm TYPE rswsourcet.
  DATA l_paramtype TYPE fupararef-parameter.

  DATA l_index TYPE i.
  DATA l_counter(3)  TYPE n.
  DATA l_counter1(3) TYPE n.
  DATA l_sequence(3)  TYPE n.

  DATA: BEGIN OF l_i_select OCCURS 0,
         field1(3)   TYPE n,
         field2(24)  TYPE c,
         field3(24)  TYPE c,
         field4(24)  TYPE c,
         field5(24)  TYPE c,
         field6(24)  TYPE c,
        END OF l_i_select.

  DATA l_i_select_copy LIKE TABLE OF l_i_select INITIAL SIZE 0.
  DATA l_wa_select LIKE LINE OF l_i_select.
  DATA l_wa_select_copy LIKE LINE OF l_i_select.

  IF p_cat4 EQ space.         "Not required for FMs
    add_macro_line space.
    add_macro_line text-100.
    add_macro_line text-ss1.
    add_macro_line text-100.
    add_macro_line 'Start-Of-Selection.'.
  ENDIF.

* If there is a need to read local file from presentation server
  IF p_lfup EQ c_on.
    add_macro_line space.
    add_macro_line text-c76. "'* Read presentation server file'.
    CONCATENATE 'perform read_localfile tables' p_itab
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'infile' INTO v_temp_string.
    add_macro_line v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+30.
    add_macro_line v_temp_string.

    CONCATENATE 'using' p_para INTO v_temp_string+24 SEPARATED BY space.
    CONCATENATE v_temp_string 'lfup' INTO v_temp_string.
    add_macro_line v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+30 = 'c_separator-comma. "Change if needed'.
    add_macro_line v_temp_string.
    add_macro_line space.
    add_macro_line text-c77. "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

* If there is a need to read file from application server
  IF p_afup EQ c_on.
    add_macro_line space.
    add_macro_line text-c78. "'* Read Application Server File'.

    CONCATENATE 'Perform build_filename using' p_para
                               INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'afupd' INTO v_temp_string.
    CONCATENATE v_temp_string p_para
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'afupf' INTO v_temp_string.
    CONCATENATE v_temp_string p_glob
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'filename' c_dot INTO v_temp_string.
    add_macro_line v_temp_string.

    CONCATENATE 'Perform READ_APPFILE tables' p_itab
                               INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'infile' INTO v_temp_string.
    add_macro_line v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+28.
    add_macro_line v_temp_string.

    CONCATENATE 'using' p_glob INTO v_temp_string+22 SEPARATED BY space.
    CONCATENATE v_temp_string 'filename' INTO v_temp_string.
    add_macro_line v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+28 = 'c_separator-comma. "Change if needed'.
    add_macro_line v_temp_string.

    add_macro_line space.
    add_macro_line text-c77. "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line v_temp_string.
  ENDIF.

  add_macro_line space.
  add_macro_line text-c37. "'* Perform selects and populate internal tables'.

  CONCATENATE p_sub 'LOAD_INTERNAL_TABLES' INTO v_temp_string.
  CONCATENATE 'Perform' v_temp_string
                        INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string c_dot INTO v_temp_string.

  add_macro_line v_temp_string.
  add_subroutine_title 'LOAD_INTERNAL_TABLES'.

  DESCRIBE TABLE i_program_forms LINES l_index.

  REFRESH i_program_temp4.

  REFRESH r_output_list.
  r_output_list-sign = 'I'.
  r_output_list-option = 'EQ'.

  LOOP AT i_output_data INTO wa_output_data.
    r_output_list-low = wa_output_data-field.
    r_output_list-high = wa_output_data-name.
    APPEND r_output_list.
    CLEAR r_output_list-low.
    CLEAR r_output_list-high.
  ENDLOOP.

  LOOP AT i_processing INTO wa_processing.
    l_wa_select-field2  = wa_processing-table.
    l_wa_select-field3  = wa_processing-j1table.
    l_wa_select-field4  = wa_processing-j2table.
    l_wa_select-field5  = wa_processing-j3table.
    l_wa_select-field6  = wa_processing-fae.
    APPEND l_wa_select TO l_i_select.
  ENDLOOP.

  l_i_select_copy[] = l_i_select[].

  SORT l_i_select BY field2.      "Sort by table name
  CLEAR l_wa_select.
  CLEAR l_sequence.

  LOOP AT l_i_select_copy INTO l_wa_select_copy.

* If this select has already been done, then go to next record
    IF l_wa_select_copy-field1 IS NOT INITIAL.
      CONTINUE.
    ENDIF.

    l_sequence = l_sequence + 1.

* If there exists a FAE link
    IF l_wa_select_copy-field6 IS NOT INITIAL.

* Do the select from the linked table first
      READ TABLE l_i_select INTO l_wa_select
             WITH KEY field2 = l_wa_select_copy-field6 BINARY SEARCH.

      IF l_wa_select-field1 IS INITIAL.       " Not selected yet
        IF l_wa_select-field6 IS INITIAL.       " No FAE
          l_wa_select-field1 = l_sequence.
          l_sequence = l_sequence + 1.
          MODIFY l_i_select_copy FROM l_wa_select TRANSPORTING field1
                            WHERE field2 = l_wa_select-field2.
          MODIFY l_i_select FROM l_wa_select TRANSPORTING field1
                            WHERE field2 = l_wa_select-field2.
        ELSE.

          CLEAR l_counter.
          l_final_text = l_wa_select_copy-field6.

          DO.
            READ TABLE l_i_select INTO l_wa_select
           WITH KEY field2 = l_wa_select_copy-field6 BINARY SEARCH.
            IF l_wa_select-field6 IS INITIAL.   "No FAE
              IF l_wa_select-field1 IS NOT INITIAL.  "Already selected
                EXIT.
              ENDIF.
              l_counter = l_counter + 1.
              EXIT.
            ELSE.
              IF l_wa_select-field1 IS INITIAL.       " Not selected yet
                l_counter = l_counter + 1.
                l_wa_select_copy-field6 = l_wa_select-field6.
              ENDIF.
            ENDIF.
          ENDDO.

          l_counter1 = l_counter.

          l_wa_select_copy-field6 = l_final_text.

          DO.
            READ TABLE l_i_select INTO l_wa_select
               WITH KEY field2 = l_wa_select_copy-field6 BINARY SEARCH.

            IF l_wa_select-field6 IS INITIAL.   "No FAE
              IF l_wa_select-field1 IS NOT INITIAL.  "Already selected
                EXIT.
              ENDIF.
              l_wa_select-field1 = l_sequence.
              MODIFY l_i_select_copy FROM l_wa_select TRANSPORTING
                       field1 WHERE field2 = l_wa_select-field2.
              MODIFY l_i_select FROM l_wa_select TRANSPORTING field1
                               WHERE field2 = l_wa_select-field2.
              EXIT.
            ELSE.
              IF l_wa_select-field1 IS INITIAL.       " Not selected yet
                l_wa_select_copy-field6 = l_wa_select-field6.
                l_counter = l_counter - 1.
                l_wa_select-field1 = l_sequence + l_counter.
                MODIFY l_i_select_copy FROM l_wa_select TRANSPORTING
                    field1 WHERE field2 = l_wa_select-field2.
                MODIFY l_i_select FROM l_wa_select TRANSPORTING field1
                                 WHERE field2 = l_wa_select-field2.
              ENDIF.
            ENDIF.

          ENDDO.

          l_sequence = l_sequence + l_counter1.
        ENDIF.
      ENDIF.

      l_wa_select_copy-field1 = l_sequence.
      MODIFY l_i_select_copy FROM l_wa_select_copy TRANSPORTING field1.
      MODIFY l_i_select FROM l_wa_select_copy TRANSPORTING field1
                            WHERE field2 = l_wa_select_copy-field2.

* No FAE link, then continue
    ELSE.

      l_wa_select_copy-field1 = l_sequence.
      MODIFY l_i_select_copy FROM l_wa_select_copy TRANSPORTING field1.
      MODIFY l_i_select FROM l_wa_select_copy TRANSPORTING field1
                            WHERE field2 = l_wa_select_copy-field2.
    ENDIF.
  ENDLOOP.

  SORT l_i_select_copy BY field1.

  LOOP AT l_i_select_copy INTO l_wa_select.

    LOOP AT i_processing INTO wa_processing
                        WHERE TABLE eq L_WA_SELECT-FIELD2.

      REFRESH r_joinset1.
      r_joinset1-sign = 'I'.
      r_joinset1-option = 'EQ'.
      r_joinset1-low = wa_processing-j1cond1.
      APPEND r_joinset1. CLEAR r_joinset1-low.
      r_joinset1-low = wa_processing-j1cond2.
      APPEND r_joinset1. CLEAR r_joinset1-low.
      r_joinset1-low = wa_processing-j1cond3.
      APPEND r_joinset1. CLEAR r_joinset1-low.
      r_joinset1-low = wa_processing-j1cond4.
      APPEND r_joinset1. CLEAR r_joinset1-low.
      DELETE r_joinset1 WHERE low IS INITIAL.

      REFRESH r_joinset2.
      r_joinset2-sign = 'I'.
      r_joinset2-option = 'EQ'.
      r_joinset2-low = wa_processing-j2cond1.
      APPEND r_joinset2. CLEAR r_joinset2-low.
      r_joinset2-low = wa_processing-j2cond2.
      APPEND r_joinset2. CLEAR r_joinset2-low.
      r_joinset2-low = wa_processing-j2cond3.
      APPEND r_joinset2. CLEAR r_joinset2-low.
      r_joinset2-low = wa_processing-j2cond4.
      APPEND r_joinset2. CLEAR r_joinset2-low.
      DELETE r_joinset2 WHERE low IS INITIAL.

      REFRESH r_joinset3.
      r_joinset3-sign = 'I'.
      r_joinset3-option = 'EQ'.
      r_joinset3-low = wa_processing-j3cond1.
      APPEND r_joinset3. CLEAR r_joinset3-low.
      r_joinset3-low = wa_processing-j3cond2.
      APPEND r_joinset3. CLEAR r_joinset3-low.
      r_joinset3-low = wa_processing-j3cond3.
      APPEND r_joinset3. CLEAR r_joinset3-low.
      r_joinset3-low = wa_processing-j3cond4.
      APPEND r_joinset3. CLEAR r_joinset3-low.
      DELETE r_joinset3 WHERE low IS INITIAL.

      REFRESH r_fieldlist.
      r_fieldlist-sign = 'I'.
      r_fieldlist-option = 'EQ'.

      IF wa_processing-j1table IS NOT INITIAL.
        "If join conditions exists

        r_fieldlist-high = wa_processing-table.        "Table name

      ENDIF.

      r_fieldlist-low = wa_processing-field1.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field2.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field3.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field4.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field5.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field6.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field7.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field8.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field9.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field10.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field11.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field12.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field13.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field14.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.
      r_fieldlist-low = wa_processing-field15.
      APPEND r_fieldlist. CLEAR r_fieldlist-low.



      IF wa_processing-j1table IS NOT INITIAL.

        r_fieldlist-high = wa_processing-j1table.        "Table name

        IF NOT wa_processing-j1fld1 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld1.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld2 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld2.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld3 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld3.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld4 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld4.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld5 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld5.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld6 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld6.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld7 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld7.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld8 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld8.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld9 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld9.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld10 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld10.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld11 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld11.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j1fld12 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j1fld12.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.

        r_fieldlist-high = wa_processing-j2table.        "Table name

        IF NOT wa_processing-j2fld1 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld1.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld2 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld2.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld3 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld3.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld4 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld4.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld5 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld5.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld6 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld6.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld7 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld7.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld8 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld8.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld9 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld9.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld10 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld10.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld11 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld11.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j2fld12 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j2fld12.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.

        r_fieldlist-high = wa_processing-j3table.        "Table name

        IF NOT wa_processing-j3fld1 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld1.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld2 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld2.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld3 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld3.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld4 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld4.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld5 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld5.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld6 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld6.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld7 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld7.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld8 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld8.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld9 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld9.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld10 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld10.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld11 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld11.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.
        IF NOT wa_processing-j3fld12 IN r_fieldlist[].
          r_fieldlist-low = wa_processing-j3fld12.
          APPEND r_fieldlist. CLEAR r_fieldlist-low.
        ENDIF.

      ENDIF.

      DELETE r_fieldlist WHERE low IS INITIAL.

      PERFORM create_join_select TABLES r_fieldlist r_joinset1
                                        r_joinset2 r_joinset3
                            USING l_wa_select-field2 l_wa_select-field3
                                  l_wa_select-field4 l_wa_select-field5
                                  l_wa_select-field6.
      APPEND LINES OF i_program_temp2 TO i_program_temp4.
    ENDLOOP.

  ENDLOOP.

* Add logic for retrieving the data using FM
  IF v_fm1 IS NOT INITIAL.
    add_macro_line_temp space.
    add_macro_line_temp text-c38. "'* Call FM to retrieve the data'.

    CONCATENATE p_sub 'FETCH_DATA_USING_FM1 TABLES' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.
    add_macro_line_temp space.
    add_macro_line_temp text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.'
                                INTO v_temp_string.
    add_macro_line_temp v_temp_string.
  ENDIF.

* Add logic for retrieving the data using FM
  IF v_fm2 IS NOT INITIAL.
    add_macro_line_temp space.
    add_macro_line_temp text-c38. "'* Call FM to retrieve the data'.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM2 TABLES' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.
    add_macro_line_temp space.
    add_macro_line_temp text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.'
                                INTO v_temp_string.
    add_macro_line_temp v_temp_string.
  ENDIF.

* Add logic for retrieving the data using FM
  IF v_fm3 IS NOT INITIAL.
    add_macro_line_temp space.
    add_macro_line_temp text-c38. "'* Call FM to retrieve the data'.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM3 TABLES' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.
    add_macro_line_temp space.
    add_macro_line_temp text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.'
                                INTO v_temp_string.
    add_macro_line_temp v_temp_string.
  ENDIF.

* Add logic for retrieving the data using FM
  IF v_fm4 IS NOT INITIAL.
    add_macro_line_temp space.
    add_macro_line_temp text-c38. "'* Call FM to retrieve the data'.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM4 TABLES' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.
    add_macro_line_temp space.
    add_macro_line_temp text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.'
                                INTO v_temp_string.
    add_macro_line_temp v_temp_string.
  ENDIF.

  add_macro_line_temp space.
  add_macro_line_temp 'Endform.'.

  INSERT lines of i_program_temp INTO i_program_forms INDEX l_index.
  REFRESH i_program_temp.

  IF v_fm1 IS NOT INITIAL.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM1' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
            INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'TABLES' p_itab
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-c56.
    "'* Call function module for retrieving the necessary data'.

    CLEAR l_i_bapifm[].
    CLEAR l_i_bapifm.
    CLEAR l_paramtype.
    CLEAR l_index.

    CALL FUNCTION 'FUNCTION_STUB_GENERATE'
      EXPORTING
        funcname           = v_fm1
      TABLES
        SOURCE             = l_i_bapifm
      EXCEPTIONS
        function_not_exist = 1
        OTHERS             = 2.
    IF sy-subrc <> 0. ENDIF.

    CLEAR l_index.
    LOOP AT l_i_bapifm INTO l_final_text.

      l_index = l_index + 1.

      IF l_final_text CS 'EXPORTING'.
        l_paramtype = 'I'.
        CLEAR l_index.
      ENDIF.
      IF l_final_text CS 'IMPORTING'.
        l_paramtype = 'E'.
        CLEAR l_index.
        l_final_text(1) = space.
      ENDIF.
      IF l_final_text CS 'TABLES '.
        l_paramtype = 'T'.
        CLEAR l_index.
      ENDIF.

      IF l_paramtype EQ 'E'.
        l_final_text(1) = space.
      ENDIF.

      IF l_final_text(1) EQ '"'.
        l_final_text(1) = '*'.
      ELSE.

* Add appropriate data containers for the BAPI interface
        READ TABLE i_fupararef_fm1 INTO wa_fupararef
                            WITH KEY paramtype = l_paramtype
                                     pposition = l_index BINARY SEARCH.
        IF sy-subrc EQ 0.
          IF l_paramtype EQ 'I' OR l_paramtype EQ 'E'.

            IF wa_fupararef-structure CA '-'.
              CONCATENATE p_glob wa_fupararef-parameter
              INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ELSE.
              CONCATENATE p_wa wa_fupararef-parameter
                            INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ENDIF.

          ELSEIF l_paramtype EQ 'T'.
            CONCATENATE p_itab wa_fupararef-parameter
                              INTO v_temp_string.
            CONCATENATE l_final_text v_temp_string
                    INTO l_final_text SEPARATED BY space.

          ENDIF.
        ENDIF.
      ENDIF.
      APPEND l_final_text TO i_program_forms.

    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms text-c57.
    "'* Check if the call is successful'.
    add_macro_line_forms 'If sy-subrc eq 0.'.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

  IF v_fm2 IS NOT INITIAL.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM2' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                  INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
            INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'TABLES' p_itab
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-c56.
    "'* Call function module for retrieving the necessary data'.

    CLEAR l_i_bapifm[].
    CLEAR l_i_bapifm.
    CLEAR l_paramtype.
    CLEAR l_index.

    CALL FUNCTION 'FUNCTION_STUB_GENERATE'
      EXPORTING
        funcname           = v_fm2
      TABLES
        SOURCE             = l_i_bapifm
      EXCEPTIONS
        function_not_exist = 1
        OTHERS             = 2.
    IF sy-subrc <> 0. ENDIF.

    CLEAR l_index.
    LOOP AT l_i_bapifm INTO l_final_text.

      l_index = l_index + 1.

      IF l_final_text CS 'EXPORTING'.
        l_paramtype = 'I'.
        CLEAR l_index.
      ENDIF.
      IF l_final_text CS 'IMPORTING'.
        l_paramtype = 'E'.
        CLEAR l_index.
        l_final_text(1) = space.
      ENDIF.
      IF l_final_text CS 'TABLES '.
        l_paramtype = 'T'.
        CLEAR l_index.
      ENDIF.

      IF l_paramtype EQ 'E'.
        l_final_text(1) = space.
      ENDIF.

      IF l_final_text(1) EQ '"'.
        l_final_text(1) = '*'.
      ELSE.

* Add appropriate data containers for the FM interface
        READ TABLE i_fupararef_fm2 INTO wa_fupararef
                            WITH KEY paramtype = l_paramtype
                                     pposition = l_index BINARY SEARCH.
        IF sy-subrc EQ 0.
          IF l_paramtype EQ 'I' OR l_paramtype EQ 'E'.

            IF wa_fupararef-structure CA '-'.
              CONCATENATE p_glob wa_fupararef-parameter
              INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ELSE.
              CONCATENATE p_wa wa_fupararef-parameter
                            INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ENDIF.

          ELSEIF l_paramtype EQ 'T'.
            CONCATENATE p_itab wa_fupararef-parameter
                              INTO v_temp_string.
            CONCATENATE l_final_text v_temp_string
                    INTO l_final_text SEPARATED BY space.

          ENDIF.
        ENDIF.
      ENDIF.
      APPEND l_final_text TO i_program_forms.

    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms text-c57.
    "'* Check if the call is successful'.
    add_macro_line_forms 'If sy-subrc eq 0.'.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

  IF v_fm3 IS NOT INITIAL.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM3' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
              INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
            INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'TABLES' p_itab
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-c56.
    "'* Call function module for retrieving the necessary data'.

    CLEAR l_i_bapifm[].
    CLEAR l_i_bapifm.
    CLEAR l_paramtype.
    CLEAR l_index.

    CALL FUNCTION 'FUNCTION_STUB_GENERATE'
      EXPORTING
        funcname           = v_fm3
      TABLES
        SOURCE             = l_i_bapifm
      EXCEPTIONS
        function_not_exist = 1
        OTHERS             = 2.
    IF sy-subrc <> 0. ENDIF.

    CLEAR l_index.
    LOOP AT l_i_bapifm INTO l_final_text.

      l_index = l_index + 1.

      IF l_final_text CS 'EXPORTING'.
        l_paramtype = 'I'.
        CLEAR l_index.
      ENDIF.
      IF l_final_text CS 'IMPORTING'.
        l_paramtype = 'E'.
        CLEAR l_index.
        l_final_text(1) = space.
      ENDIF.
      IF l_final_text CS 'TABLES '.
        l_paramtype = 'T'.
        CLEAR l_index.
      ENDIF.

      IF l_paramtype EQ 'E'.
        l_final_text(1) = space.
      ENDIF.

      IF l_final_text(1) EQ '"'.
        l_final_text(1) = '*'.
      ELSE.

* Add appropriate data containers for the FM interface
        READ TABLE i_fupararef_fm3 INTO wa_fupararef
                            WITH KEY paramtype = l_paramtype
                                     pposition = l_index BINARY SEARCH.
        IF sy-subrc EQ 0.
          IF l_paramtype EQ 'I' OR l_paramtype EQ 'E'.

            IF wa_fupararef-structure CA '-'.
              CONCATENATE p_glob wa_fupararef-parameter
              INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ELSE.
              CONCATENATE p_wa wa_fupararef-parameter
                            INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ENDIF.

          ELSEIF l_paramtype EQ 'T'.
            CONCATENATE p_itab wa_fupararef-parameter
                              INTO v_temp_string.
            CONCATENATE l_final_text v_temp_string
                    INTO l_final_text SEPARATED BY space.

          ENDIF.
        ENDIF.
      ENDIF.
      APPEND l_final_text TO i_program_forms.

    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms text-c57.
    "'* Check if the call is successful'.
    add_macro_line_forms 'If sy-subrc eq 0.'.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

  IF v_fm4 IS NOT INITIAL.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'FETCH_DATA_USING_FM4' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                        INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
            INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'TABLES' p_itab
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-c56.
    "'* Call function module for retrieving the necessary data'.

    CLEAR l_i_bapifm[].
    CLEAR l_i_bapifm.
    CLEAR l_paramtype.
    CLEAR l_index.

    CALL FUNCTION 'FUNCTION_STUB_GENERATE'
      EXPORTING
        funcname           = v_fm4
      TABLES
        SOURCE             = l_i_bapifm
      EXCEPTIONS
        function_not_exist = 1
        OTHERS             = 2.
    IF sy-subrc <> 0. ENDIF.

    CLEAR l_index.
    LOOP AT l_i_bapifm INTO l_final_text.

      l_index = l_index + 1.

      IF l_final_text CS 'EXPORTING'.
        l_paramtype = 'I'.
        CLEAR l_index.
      ENDIF.
      IF l_final_text CS 'IMPORTING'.
        l_paramtype = 'E'.
        CLEAR l_index.
        l_final_text(1) = space.
      ENDIF.
      IF l_final_text CS 'TABLES '.
        l_paramtype = 'T'.
        CLEAR l_index.
      ENDIF.

      IF l_paramtype EQ 'E'.
        l_final_text(1) = space.
      ENDIF.

      IF l_final_text(1) EQ '"'.
        l_final_text(1) = '*'.
      ELSE.

* Add appropriate data containers for the FM interface
        READ TABLE i_fupararef_fm4 INTO wa_fupararef
                            WITH KEY paramtype = l_paramtype
                                     pposition = l_index BINARY SEARCH.
        IF sy-subrc EQ 0.
          IF l_paramtype EQ 'I' OR l_paramtype EQ 'E'.

            IF wa_fupararef-structure CA '-'.
              CONCATENATE p_glob wa_fupararef-parameter
              INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ELSE.
              CONCATENATE p_wa wa_fupararef-parameter
                            INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ENDIF.

          ELSEIF l_paramtype EQ 'T'.
            CONCATENATE p_itab wa_fupararef-parameter
                              INTO v_temp_string.
            CONCATENATE l_final_text v_temp_string
                    INTO l_final_text SEPARATED BY space.

          ENDIF.
        ENDIF.
      ENDIF.
      APPEND l_final_text TO i_program_forms.

    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms text-c57.
    "'* Check if the call is successful'.
    add_macro_line_forms 'If sy-subrc eq 0.'.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

  add_macro_line space.
  add_macro_line text-c92. "'* Process the internal table table'(C92).
  CONCATENATE p_sub 'PROCESS_DATA' INTO v_temp_string.
  CONCATENATE 'Perform' v_temp_string
                        INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string c_dot INTO v_temp_string.
  add_macro_line v_temp_string.
  add_subroutine_title 'PROCESS_DATA'.

* Loop at table and collect output data
  loop_at_table.
  add_macro_line_forms space.
  add_macro_line_forms 'Endform.'.

  add_macro_line space.
  add_macro_line text-c93. "'* Populate the final output table for display'.

  CONCATENATE p_sub 'FINAL_STATISTICS' INTO v_temp_string.
  CONCATENATE 'Perform' v_temp_string
                        INTO v_temp_string SEPARATED BY space.
  CONCATENATE v_temp_string c_dot INTO v_temp_string.
  add_subroutine_title 'FINAL_STATISTICS'.

  IF p_bdc EQ c_on.
    add_macro_line_forms text-c94.
    "'*Populate the BDC data table for Call Transaction'.
    add_macro_line_forms text-c95.
    "'*  Perform bdcdynpro tables i_bdcdata using prog_name screen_no.'(C95).
    add_macro_line_forms text-c96.
    "'*  Perform bdcfield  tables i_bdcdata using fieldname fieldval.'(C96).
    add_macro_line_forms space.
    add_macro_line_forms text-c97. "'*Call transaction using the i_bdcdata table'(C97).
    CONCATENATE 'Perform call_transaction Tables' p_itab
                                  INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdc_messages' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    v_temp_string+32 = p_itab.
    CONCATENATE v_temp_string 'bdcdata' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    v_temp_string+32 = p_itab.
    CONCATENATE v_temp_string 'errors' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE text-121 p_tcode text-121 INTO v_temp_string.
    CONCATENATE 'Using' v_temp_string
                        INTO v_temp_string+26 SEPARATED BY space.
    CLEAR v_temp_string(26).
    v_temp_string+57 = '"T Code'.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    v_temp_string+32 = 'c_calltran-input_e'.
    v_temp_string+57 = '"Method A/E/N'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+32 = 'c_calltran-update_s'.
    CONCATENATE v_temp_string+32 c_dot INTO v_temp_string+32.
    v_temp_string+57 = '"Update S/A'.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-c98. "'*Check for any errors and create BDC session'(C98).
    CONCATENATE 'if not' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdc_messages[] is initial.'
                                                  INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-c99. "'*Open a BDC session for the failed record'(C99).
    CONCATENATE 'Perform Open_bdc_session TABLES' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+26 = 'Using'.
    CONCATENATE text-121 'session_name' text-121 c_dot
              INTO v_temp_string+32.
    v_temp_string+52 = '"Session Name'.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-c04. "'*Insert BDC session for the failed record'.
    CONCATENATE 'Perform insert_bdc_tab TABLES' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'bdcdata' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+30.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    v_temp_string+24 = 'Using'.
    CONCATENATE text-121 p_tcode text-121 c_dot INTO v_temp_string+30.
    v_temp_string+52 = '"T Code'.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-c06. "'*Close the BDC session'.
    CONCATENATE 'Perform close_bdc_tab TABLES' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+23 = 'Using'.
    CONCATENATE text-121 'session_name' text-121 c_dot
                        INTO v_temp_string+29.
    v_temp_string+52 = '"Session Name'.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms 'ENDIF.'.

  ENDIF.

* Add logic for posting the data using BAPI
  IF p_chbapi EQ c_on.
    add_macro_line_forms space.
    add_macro_line_forms text-c15. "'* Call BAPI to post the data'.

    CONCATENATE p_sub 'POST_DATA_USING_BAPI TABLES' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.'
                                INTO v_temp_string.
    add_macro_line_forms v_temp_string.
  ENDIF.

* Create Inbound IDoc logic
  IF p_chidin EQ c_on.
    add_macro_line_forms space.
    add_macro_line_forms text-c33.
    "'* Create IDoc to post inbound data'.

    CONCATENATE p_sub 'POST_DATA_USING_IDOC TABLES' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
  ENDIF.

* Create Outbound IDoc logic
  IF p_chido EQ c_on.
    add_macro_line_forms space.
    add_macro_line_forms text-c39. "'* Create Outbound IDocs'.
    CONCATENATE p_sub 'CREATE_OUTBOUND_IDOC Tables' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
  ENDIF.

* If there is a need to write file to application server
  IF p_afdl EQ c_on.

    add_macro_line_forms space.
    add_macro_line_forms text-c43.
    "'* Check output table is not empty before continuing'(C43).
    CONCATENATE 'If not' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'outdata[] is initial.'
                                          INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms space.
    add_macro_line_forms text-c52. "'* Write Application Server File'(C52).
    CONCATENATE 'Perform build_filename using' p_para
                               INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'afdld' INTO v_temp_string.
    CONCATENATE v_temp_string p_para
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'afdlf' INTO v_temp_string.
    CONCATENATE v_temp_string p_glob
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'filename' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms text-c58.
    "'* Note: The output table should have all type C fields before'(C58).
    add_macro_line_forms text-ca0. "'* downloading with separators'(CA0).
    CONCATENATE 'Perform write_appfile tables' p_itab
                          INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'outdata' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+29.
    add_macro_line_forms v_temp_string.
    CONCATENATE 'using' p_glob INTO v_temp_string+23 SEPARATED BY space.
    CONCATENATE v_temp_string 'filename' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+29 = 'c_separator-comma. "Change if needed'.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.
  ENDIF.

* If there is a need to write local file to presentation server
  IF p_lfdl EQ c_on.

    add_macro_line_forms space.
    add_macro_line_forms text-c43.
    "'* Check output table is not empty before continuing'(C43).
    CONCATENATE 'If not' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'outdata[] is initial.'
                                          INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms space.
    add_macro_line_forms text-c58.
    "'* Note: The output table should have all type C fields before'(C58).
    add_macro_line_forms text-ca0. "'* downloading with separators'(CA0).
    add_macro_line_forms space.
    add_macro_line_forms text-ca1. "'* Write Presentation Server File'(CA1).
    CONCATENATE 'Perform write_localfile tables' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'outdata' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+31.
    add_macro_line_forms v_temp_string.
    CONCATENATE 'using' p_para INTO v_temp_string+25 SEPARATED BY space.
    CONCATENATE v_temp_string 'lfdl' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+31 = 'c_separator-comma. "Change if needed'.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.

  ENDIF.

  add_macro_line_forms space.
  add_macro_line_forms 'Endform.'.

  IF p_chbapi EQ c_on.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'POST_DATA_USING_BAPI' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
            INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'TABLES' p_itab
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-ca2.
    "'* Call BAPI function module for posting the final data'(CA2).

    CLEAR l_i_bapifm[].
    CLEAR l_i_bapifm.
    CLEAR l_paramtype.
    CLEAR l_index.

    CALL FUNCTION 'FUNCTION_STUB_GENERATE'
      EXPORTING
        funcname           = p_bapi
      TABLES
        SOURCE             = l_i_bapifm
      EXCEPTIONS
        function_not_exist = 1
        OTHERS             = 2.
    IF sy-subrc <> 0. ENDIF.

    CLEAR l_index.
    LOOP AT l_i_bapifm INTO l_final_text.

      l_index = l_index + 1.

      IF l_final_text CS 'EXPORTING'.
        l_paramtype = 'I'.
        CLEAR l_index.
      ENDIF.
      IF l_final_text CS 'IMPORTING'.
        l_paramtype = 'E'.
        CLEAR l_index.
        l_final_text(1) = space.
      ENDIF.
      IF l_final_text CS 'TABLES '.
        l_paramtype = 'T'.
        CLEAR l_index.
      ENDIF.

      IF l_paramtype EQ 'E'.
        l_final_text(1) = space.
      ENDIF.

      IF l_final_text(1) EQ '"'.
        l_final_text(1) = '*'.
      ELSE.

* Add appropriate data containers for the BAPI interface
        READ TABLE i_fupararef INTO wa_fupararef
                            WITH KEY paramtype = l_paramtype
                                     pposition = l_index BINARY SEARCH.
        IF sy-subrc EQ 0.
          IF l_paramtype EQ 'I' OR l_paramtype EQ 'E'.

            IF wa_fupararef-structure CA '-'.
              CONCATENATE p_glob wa_fupararef-parameter
              INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ELSE.
              CONCATENATE p_wa wa_fupararef-parameter
                            INTO v_temp_string.
              CONCATENATE l_final_text v_temp_string
                                INTO l_final_text SEPARATED BY space.
            ENDIF.

          ELSEIF l_paramtype EQ 'T'.
            CONCATENATE p_itab wa_fupararef-parameter
                              INTO v_temp_string.
            CONCATENATE l_final_text v_temp_string
                    INTO l_final_text SEPARATED BY space.

          ENDIF.
        ENDIF.
      ENDIF.
      APPEND l_final_text TO i_program_forms.

    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms text-ca3.
    "'* Commit transaction if the BAPI call is successful'(CA3).
    add_macro_line_forms 'If sy-subrc eq 0.'.
* Call Function 'BAPI_TRANSACTION_COMMIT'.
    add_macro_line_forms text-098.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

* Create Inbound IDoc logic
  IF p_chidin EQ c_on.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'POST_DATA_USING_IDOC' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                                INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
    INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'Tables' p_itab
                                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    CLEAR v_temp_string.
    add_macro_line_forms text-ca4.
    "'* Populate the Control Record for IDoc'(CA4).

*   CONCATENATE p_sub 'populate_control_record Using' INTO v_temp_string
*    CONCATENATE 'Perform' v_temp_string
*                        INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms 'Perform populate_control_record Using'.

    CLEAR v_temp_string.
    CONCATENATE p_wa 'edidc' INTO v_temp_string+25.
    v_temp_string+52 = '"Message Type'.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE text-121 p_idmsgi text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Message Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_idtyp text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Idoc Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_rcvprt text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Receiver Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_rcvprn text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Recv Partner'.
    add_macro_line_forms v_temp_string.
    v_temp_string+25 = 'space'.
    v_temp_string+52 = '"Receiver Port'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_sndprt text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Sender Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_sndprn text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Sender Partner'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_sndpor text-121 c_dot INTO v_temp_string+25.
    v_temp_string+52 = '"Sender Port'.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-ca5.
    "'* Populate IDoc Data Record for posting inbound data'(CA5).

    CONCATENATE p_sub 'populate_idoc_data Tables' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                          INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_in' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-ca6.
    "'* Create inbound IDoc for posting data'(CA6).

*    CONCATENATE p_sub 'create_idoc_inbound Tables' INTO v_temp_string.
    CONCATENATE 'Perform create_idoc_inbound Tables' p_itab
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_in'  INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+35.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE 'using' p_wa INTO v_temp_string+29 SEPARATED BY space.
    CONCATENATE v_temp_string 'edidc' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    CONCATENATE 'changing' p_glob INTO v_temp_string+26
                        SEPARATED BY space.
    CONCATENATE v_temp_string 'idoc_number' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

* Create Outbound IDoc logic
  IF p_chido EQ c_on.

* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'CREATE_OUTBOUND_IDOC' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                            INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2
                      INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'TABLES' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    CLEAR v_temp_string.
    add_macro_line_forms text-ca4.
    "'* Populate the Control Record for IDoc'(CA4).

*   CONCATENATE p_sub 'populate_control_record Using' INTO v_temp_string
*    CONCATENATE 'Perform' v_temp_string
*                        INTO v_temp_string SEPARATED BY space.

    add_macro_line_forms 'Perform populate_control_record Using'.

    CLEAR v_temp_string.
    CONCATENATE p_wa 'edidc' INTO v_temp_string+25.
    v_temp_string+52 = '"Message Type'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE text-121 p_idmsgo text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Message Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_idtypo text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Idoc Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_rcvpto text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Receiver Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_rcvpno text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Recv Partner'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_rcvpoo text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Receiver Port'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_sndpro text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Sender Type'.
    add_macro_line_forms v_temp_string.
    CONCATENATE text-121 p_sndpno text-121 INTO v_temp_string+25.
    v_temp_string+52 = '"Sender Partner'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+25 = 'space'.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    v_temp_string+52 = '"Sender Port'.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-ca7.
    "'* Populate IDoc Data Record for posting outbound data'(CA7).

    CONCATENATE p_sub 'populate_idoc_data Tables' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string p_itab
                          INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_out' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-ca8. "'* Create Outbound IDoc'(CA8).
*    CONCATENATE p_sub 'create_idoc_outbound Tables' INTO v_temp_string.
    CONCATENATE 'Perform create_idoc_outbound Tables' p_itab
                        INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'edidd_out' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE p_itab 'errors' INTO v_temp_string+36.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE 'using' p_wa INTO v_temp_string+30 SEPARATED BY space.
    CONCATENATE v_temp_string 'edidc' c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-c77.
    "'* Check for any errors before processing further'.
    CONCATENATE 'Check' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[] is initial.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

  IF p_chidin EQ c_on OR p_chido EQ c_on.
* Subroutine
    add_macro_line_forms space.
    add_macro_line_forms text-100.
    CONCATENATE p_sub 'POPULATE_IDOC_DATA' INTO v_temp_string2.
    CONCATENATE 'Form' v_temp_string2
                        INTO v_temp_string2 SEPARATED BY space.
    CONCATENATE '*$*$' v_temp_string2 INTO v_temp_string
                         SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms text-100.
    CONCATENATE v_temp_string2 'Tables p_i_edidd.'
              INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    LOOP AT i_idocstruc INTO wa_idocstruc.
      add_macro_line_forms space.
      CONCATENATE text-ca9
      "'* Add IDoc data table with fields from segment'(CA9)
               wa_idocstruc-segtyp INTO v_temp_string SEPARATED BY space
.
      add_macro_line_forms v_temp_string.
      CONCATENATE text-121 wa_idocstruc-segtyp text-121
            INTO v_temp_string.

      IF p_chidin EQ c_on.
        CONCATENATE 'edidd_in-segnam =' v_temp_string
                              INTO v_temp_string SEPARATED BY space.
      ENDIF.
      IF p_chido EQ c_on.
        CONCATENATE 'edidd_out-segnam =' v_temp_string
                              INTO v_temp_string SEPARATED BY space.
      ENDIF.

      CONCATENATE p_wa v_temp_string c_dot INTO v_temp_string.
      add_macro_line_forms v_temp_string.
      add_macro_line_forms text-cb0.
      "'***Map your segments fields here'(CB0).
      IF p_chidin EQ c_on.
        CONCATENATE p_wa 'edidd_in-sdata =' INTO v_temp_string.
      ENDIF.
      IF p_chido EQ c_on.
        CONCATENATE p_wa 'edidd_out-sdata =' INTO v_temp_string.
      ENDIF.

      CONCATENATE v_temp_string p_wa INTO v_temp_string
              SEPARATED BY space.
      CONCATENATE v_temp_string wa_idocstruc-segtyp c_dot
              INTO v_temp_string.
      add_macro_line_forms v_temp_string.

      CONCATENATE 'Append' p_wa INTO v_temp_string SEPARATED BY space.
      IF p_chidin EQ c_on.
        CONCATENATE v_temp_string 'edidd_in to' INTO v_temp_string.
      ENDIF.
      IF p_chido EQ c_on.
        CONCATENATE v_temp_string 'edidd_out to' INTO v_temp_string.
      ENDIF.

      CONCATENATE v_temp_string 'p_i_edidd'
                              INTO v_temp_string SEPARATED BY space.
      CONCATENATE v_temp_string c_dot INTO v_temp_string.
      add_macro_line_forms v_temp_string.
    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms 'Endform.'.
  ENDIF.

ENDFORM.                    "SETUP_START-OF-SELECTION

*$*$-------------------------------------------------------------------*
*$*$ form setup_end-of-selection.
*$*$-------------------------------------------------------------------*
FORM setup_end-of-selection.

  TYPE-POOLS swbse.
  DATA l_text(20) TYPE c.
  DATA l_text1(72) TYPE c.
  DATA l_text2(40) TYPE c.
  DATA l_text3(40) TYPE c.
  DATA l_text4(40) TYPE c.
  DATA l_text5(40) TYPE c.
  DATA l_final_text(132) TYPE c.
  DATA l_i_bapifm TYPE rswsourcet.
  DATA l_index TYPE i.
  DATA l_paramtype TYPE fupararef-parameter.

  IF p_cat4 EQ space.         "Not required for FMs
    add_macro_line space.
    add_macro_line text-100.
    add_macro_line text-es1.
    add_macro_line text-100.
    add_macro_line 'END-OF-SELECTION.'.
  ENDIF.

  IF p_alv EQ c_on.           "If ALV output is required
    add_macro_line space.
    add_macro_line text-cb1.
    "'* Display the report output using ALV'(CB1).

    CONCATENATE p_sub 'WRITE_REPORT' INTO v_temp_string.
    CONCATENATE 'Perform' v_temp_string
                          INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.

    add_macro_line v_temp_string.
    add_subroutine_title 'WRITE_REPORT'.

    add_macro_line_forms text-cb2.
    "'* Write the final report depending on error or success'(CB2).
    CONCATENATE 'If not' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors[]' INTO v_temp_string.
    CONCATENATE v_temp_string 'is initial.'
                           INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
    add_macro_line_forms text-cb3. "'* Write Report Header'(CB3).
    add_macro_line_forms 'Perform write_report_header'.
    add_macro_line_forms text-127.
    add_macro_line_forms text-128.
    add_macro_line_forms text-129.
    add_macro_line_forms space.

    add_macro_line_forms text-cb4. "'* Write Error Report'(CB4).
    CONCATENATE 'Perform write_error_report TABLES' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'errors.' INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-cb5."'* Else write the report data'(CB5).
    add_macro_line_forms 'Else.'.

    add_macro_line_forms space.
    add_macro_line_forms text-cb6.
    "'* If no ALV output is required'(CB6).
    CONCATENATE 'If' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'outdata[] is initial.'
                        INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-cb3. "'* Write Report Header'(CB3).
    add_macro_line_forms 'Perform write_report_header'.
    add_macro_line_forms text-127.
    add_macro_line_forms text-128.
    add_macro_line_forms text-129.
    add_macro_line_forms space.
    add_macro_line_forms text-cb7.
    "'******* Add your own custom message here for display'(CB7).

    add_macro_line_forms 'else.'.

    add_macro_line_forms space.
    add_macro_line_forms text-cb3. "'* Write Report Header'(CB3).
    CONCATENATE 'Perform write_alv_header Using' p_itab
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'alv_header[]' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE text-121 'prog short description' text-121
                INTO v_temp_string+31.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-cb8.
    "'* Prepare layout for the ALV display'(CB8).
    CONCATENATE 'Perform prepare_layout USING' p_wa
                INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'layout' INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+29 = 'c_check    "Column Optimize'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No Column Heading'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'c_check    "Zebra layout'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No Vertical line'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No Key Fix'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'c_check    "No Input'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "Window Titlebar'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No Sumchoice'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No total line'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No subchoice'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No subtotals'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "Totals only'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "Totals text'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "No scrolling'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space      "Detail popup'.
    add_macro_line_forms v_temp_string.
    v_temp_string+29 = 'space.     "Detail Titlebar'.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-cb9.
    "'* Prepare Event table for the ALV display'(CB9).
    CONCATENATE 'Perform populate_events Tables' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'event' INTO v_temp_string.
    add_macro_line_forms  v_temp_string.
    CLEAR v_temp_string.
    v_temp_string+25 = 'Using C_ALV_EVENTS-TOP_OF_PAGE'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE text-121 'TOP_OF_PAGE' text-121 INTO v_temp_string+30.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.

    add_macro_line_forms space.
    add_macro_line_forms text-cc0.
    "'* Prepare field catalog for the ALV display'(CC0).
    CONCATENATE p_sub 'create_fieldcatalog' INTO v_temp_string.
    CONCATENATE 'PERFORM' v_temp_string INTO v_temp_string
                                  SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.

    add_macro_line_forms text-cc1.
    "'* Display report output'(CC1).
    CONCATENATE 'Perform display_report TABLES' p_itab
                            INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'outdata' INTO v_temp_string.
    add_macro_line_forms  v_temp_string.

    CLEAR v_temp_string.
    v_temp_string+24 = 'Using sy-cprog'.
    v_temp_string+46 = '"Callback program'.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    CONCATENATE p_wa 'layout' INTO v_temp_string+30.
    v_temp_string+46 = '"Display layout'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'fieldcat' INTO v_temp_string+30.
    v_temp_string+46 = '"Field Catalog'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'sortcat' INTO v_temp_string+30.
    v_temp_string+46 = '"Sort details'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_const 'check' INTO v_temp_string+30.
    v_temp_string+46 = '"Variant(A, ,U,X)'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_wa 'variant' INTO v_temp_string+30.
    v_temp_string+46 = '"Display Variant'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE p_itab 'event' INTO v_temp_string+30.
    v_temp_string+46 = '"Events'.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.
    CONCATENATE text-121 p_itab 'outdata' text-121
                    INTO v_temp_string+30.
    v_temp_string+46 = '"Output itab name'.
    add_macro_line_forms v_temp_string.
    IF p_alvl EQ c_on.          "ALV List option is chosen
      CLEAR v_temp_string.
      CONCATENATE p_const 'check.' INTO v_temp_string+30.
      v_temp_string+46 = '"List/Grid display'.
      add_macro_line_forms v_temp_string.
    ELSE.
      CLEAR v_temp_string.
      v_temp_string+30 = 'space.'.
      v_temp_string+46 = '"List/Grid display'.
      add_macro_line_forms v_temp_string.
    ENDIF.

    add_macro_line_forms space.
    add_macro_line_forms 'Endif.'.
    add_macro_line_forms 'endif.'.
    add_macro_line_forms space.

    add_macro_line_forms 'ENDFORM.'.

    add_subroutine_title 'CREATE_FIELDCATALOG'.
*    CONCATENATE p_sub 'build_fieldcat_tab Tables' INTO v_temp_string.
*    CONCATENATE 'Perform' v_temp_string p_itab
    CONCATENATE 'Perform build_fieldcat_tab Tables' p_itab
                       INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string 'fieldcat' INTO v_temp_string.
    CONCATENATE v_temp_string 'using:'
                            INTO v_temp_string SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    LOOP AT i_output_data INTO wa_output_data.

      IF sy-tabix NE 1.
        CONCATENATE l_final_text c_comma INTO l_final_text.
        add_macro_line_forms l_final_text.
      ENDIF.

      CLEAR:l_text,l_text1,l_text2,l_text3,l_text4,l_final_text,l_text5.
      CONCATENATE c_quote c_quote INTO l_text5 SEPARATED BY space.

      TRANSLATE wa_output_data-heading TO UPPER CASE.
      CONCATENATE c_quote p_itab 'OUTDATA' c_quote INTO l_text.

      IF wa_output_data-name IS NOT INITIAL.
        CONCATENATE c_quote wa_output_data-name c_quote INTO l_text1.
      ELSE.
        CONCATENATE c_quote wa_output_data-field c_quote INTO l_text1.
      ENDIF.

      CONCATENATE l_text1 l_text5 c_quote INTO l_text1
                                        SEPARATED BY space.
      CONCATENATE l_text1 wa_output_data-table c_quote INTO l_text1.

      CONCATENATE c_quote wa_output_data-heading c_quote INTO l_text3.
      CONCATENATE c_quote 'L' c_quote INTO l_text4.

      CONCATENATE l_text l_text1 l_text5 l_text5
                           INTO l_text1 SEPARATED BY space.
      CONCATENATE l_text3 l_text5 l_text5 l_text5 l_text4
                              INTO l_final_text+10 SEPARATED BY space.

      add_macro_line_forms l_text1.
      CLEAR l_text1.

      AT LAST.
        CONCATENATE l_final_text c_dot INTO l_final_text.
        add_macro_line_forms l_final_text.
      ENDAT.

    ENDLOOP.

    add_macro_line_forms space.
    add_macro_line_forms 'ENDFORM.'.

    add_subroutine_title 'TOP_OF_PAGE'.
    add_macro_line_forms text-cc2.
    "'* Call the ALV function module for header top of page'(CC2).
*  CALL FUNCTION 'REUSE_ALV_COMMENTARY_WRITE'
    add_macro_line_forms text-130.
    add_macro_line_forms 'EXPORTING'.
    CONCATENATE 'it_list_commentary =' p_itab
            INTO l_final_text SEPARATED BY space.
    CONCATENATE l_final_text 'alv_header.' INTO l_final_text.
    add_macro_line_forms l_final_text.

    add_macro_line_forms space.
    add_macro_line_forms 'ENDFORM.'.

    add_subroutine_title 'END_OF_PAGE'.
    add_macro_line_forms text-cc3.
    " '** Write the logic for any End of Page display here'(CC3).
    add_macro_line_forms space.
    add_macro_line_forms 'ENDFORM.'.

  ENDIF.

ENDFORM.                    "SETUP_END-OF-SELECTION

*$*$-------------------------------------------------------------------*
*$*$ form format
*$*$-------------------------------------------------------------------*
FORM format.

  DATA: lstr_old_prog LIKE i_old_prog.

*  data l_edit type s38e.
*  data l_rc type sy-subrc.

*  data l_i_line_break type RSWSOURCET occurs 0.
*  data l_string type string.

  PERFORM create_condensed_table TABLES i_old_prog
                                        i_prg_long_line.

  LOOP AT i_prg_long_line.
    TRANSLATE i_prg_long_line-code TO UPPER CASE.

    IF i_prg_long_line-code(1) EQ '*'.  " Do not modify Comment Lines
      LOOP AT i_old_prog FROM i_prg_long_line-start
                              TO i_prg_long_line-end.

        i_new_prog-line = i_old_prog-line.
        APPEND i_new_prog.
      ENDLOOP.                         " LOOP AT i_OLD_PROG
    ELSEIF i_prg_long_line-code(6) EQ 'TABLES'.
*     Reformat any TABLES statements.  Will only reformat when TABLES
*     is at the start of the statement.  Will not try to get table
*     descriptions for CALL FUNCTIONS or FORM/PERFORMs

*     Get the table names from mstr_long_line.
      PERFORM get_table_names_from_statement TABLES i_tabname
                                              USING i_prg_long_line-code
.
*     Find the descriptions for eaCH table
      PERFORM get_table_descriptions TABLES i_tabname.

*     create the new statement
      PERFORM build_new_tables_statement USING i_prg_long_line.
    ELSE. " All other modifications to the code handled here
      LOOP AT i_old_prog FROM i_prg_long_line-start
                            TO   i_prg_long_line-end.

*       Remove extra spaces from line for comparisons
        lstr_old_prog = i_old_prog.
        CONDENSE lstr_old_prog.
        TRANSLATE lstr_old_prog TO UPPER CASE.

        IF lstr_old_prog-line CS '"'.  " Comments
          i_new_prog-line = i_old_prog-line.
        ELSE.
          IF lstr_old_prog-line CS ' LIKE ' OR
             lstr_old_prog-line CS ' FOR '.
            PERFORM get_for_like_comment USING i_old_prog
                                      CHANGING i_new_prog.
          ELSEIF lstr_old_prog-line(7) = 'LOOP AT '.
*     save table name into a queue
            PERFORM enqueue_itab_name USING i_prg_long_line-code.
            i_new_prog-line = i_old_prog-line.
          ELSEIF lstr_old_prog-line(7) = 'ENDLOOP'.
*     get name off of queue and add it as a comment to the ENDLOOP line
            PERFORM add_comment_to_endloop USING i_old_prog-line
                                        CHANGING i_new_prog-line.
          ELSEIF lstr_old_prog-line(7) EQ 'SELECT ' AND
                 lstr_old_prog-line(13) NE 'SELECT SINGLE'.
*     save table name into a queue
            PERFORM enqueue_tab_name USING i_old_prog-line.
            i_new_prog-line = i_old_prog-line.
*          ELSEIF lstr_old_prog-line(9) = 'ENDSELECT'.
**     get name off of queue and add it as a comment to the ENDSELECT
*            PERFORM add_comment_to_select USING i_old_prog-line
*                                          CHANGING i_new_prog-line.
          ELSEIF lstr_old_prog-line(5) = 'FORM '.
*         save form name into a queue
            PERFORM enqueue_form_name USING i_old_prog-line.
            i_new_prog-line = i_old_prog-line.
          ELSEIF lstr_old_prog-line(7) = 'ENDFORM'.
*         get name off of queue and add it as a comment to the ENDFORM
            PERFORM add_comment_to_endform USING i_old_prog-line
                                           CHANGING i_new_prog-line.
          ELSE.                        " Any other lines
            i_new_prog-line = i_old_prog-line.
          ENDIF.
        ENDIF.

        APPEND i_new_prog.
      ENDLOOP.                         " LOOP AT i_OLD_PROG
    ENDIF.
  ENDLOOP.                             " LOOP AT i_prg_long_line

*  l_edit-line_size = 72.

*   loop at i_new_prog.
*   l_string = i_new_prog.
*   l_i_line_break = l_string.
*   append l_i_line_break.
*   endloop.
*
** Set line break for lines greater than 72 chars
*            call function 'ED_CONVERT_SOURCE'
*              exporting
*                source_name       = sy-repid
*                state             = 'I'
*                extend_mod        = 'X'
*              tables
*                source            = l_i_line_break
*              changing
*                edit              = l_edit
*                rc                = l_rc.

*   loop at l_i_line_break.
*   l_i_old_source = l_i_line_break.
*   append l_i_old_source.
*   endloop.

  i_old_prog[] = i_new_prog[].
  REFRESH i_new_prog[]. CLEAR i_new_prog.

  CALL FUNCTION 'PRETTY_PRINTER'
    EXPORTING
      inctoo             = space
    TABLES
      ntext              = i_new_prog
      otext              = i_old_prog
    EXCEPTIONS
      enqueue_table_full = 1
      include_enqueued   = 2
      include_readerror  = 3
      include_writeerror = 4
      OTHERS             = 5.

ENDFORM.                    "format

*---------------------------------------------------------------------*
*       FORM CREATE_CONDENSED_TABLE                                   *
*---------------------------------------------------------------------*
*       Create a table that has all statements condensed onto 1 line  *
*---------------------------------------------------------------------*
*  -->  FTAB_OLD_PROG                                                 *
*  -->  FTAB_long_line                                                *
*---------------------------------------------------------------------*
FORM create_condensed_table
     TABLES ftab_old_prog STRUCTURE i_old_prog
            ftab_long_line STRUCTURE i_prg_long_line.

  DATA:
* Structure to hold program code/comment
    BEGIN OF fstr_line,
      code(72)    TYPE c,              " Program Code
      comment(72) TYPE c,              " Inline comments
     END OF fstr_line.

  LOOP AT ftab_old_prog.

    IF ftab_long_line-start = 0.
      ftab_long_line-start = ftab_long_line-end + 1.
      CLEAR ftab_long_line-end.
    ENDIF.

*   Strip off any inline comments so they do not get in the way
*   If comments are not separated, then words in the comments could
*   look like keywords, and cause problems
    SPLIT ftab_old_prog-line AT '"' INTO fstr_line-code
                                         fstr_line-comment.

*   Align all statements to be left justified
    SHIFT fstr_line-code LEFT DELETING LEADING space.

*   Put all lines that make up a single statement into one field
*   This will make it easier to isolate key words.  For example, if you
*   want to process a TABLES statement, but exclude the TABLES part of a
*   function call, or a subroutine call.
    CONCATENATE ftab_long_line-code
                fstr_line-code
      INTO ftab_long_line-code SEPARATED BY space.

    IF fstr_line-code   CA '.'   OR    " Period means end of statement
       fstr_line-code(1) = '*' OR      " Comment Line
       fstr_line-code   CO space.      " Blank Line
*     Keep track of the table index that the statement ends on
      ftab_long_line-end = sy-tabix.
*     Remove delimiter from concatenation of fields
      SHIFT ftab_long_line-code LEFT BY 1 PLACES.
      APPEND ftab_long_line.
      CLEAR: ftab_long_line-code,
             ftab_long_line-start.
*     Don't clear out fstr_long_line-end yet.  It is used to calc
*     fstr_long_line-start.
    ENDIF.

  ENDLOOP.                             " LOOP AT FTAB_OLD_PROG
ENDFORM.                               " FORM CREATE_CONDENSED_TABLE


*---------------------------------------------------------------------*
*       FORM GET_TABLE_NAMES_FROM_STATEMENT                           *
*---------------------------------------------------------------------*
*  -->  FTAB_TABNAME                                                  *
*  -->  FC_STATEMENT                                                  *
*---------------------------------------------------------------------*
FORM get_table_names_from_statement
     TABLES ftab_tabname STRUCTURE i_tabname
     USING  fc_statement.

  CLEAR ftab_tabname.
  REFRESH ftab_tabname.

  REPLACE 'TABLES' WITH space INTO fc_statement.
  TRANSLATE fc_statement USING '. '.   " Replace periods
  TRANSLATE fc_statement USING ', '.   " Replace commas
  TRANSLATE fc_statement USING ': '.   " Replace colons

  CONDENSE fc_statement.               " Remove all extra spaces

  SPLIT fc_statement AT space INTO TABLE ftab_tabname.

ENDFORM. " FORM GET_TABLE_NAMES_FROM_STATEMENT
*---------------------------------------------------------------------*
*       FORM GET_TABLE_DESCRIPTIONS                                   *
*---------------------------------------------------------------------*
*  -->  FTAB_TABNAME                                                  *
*  -->  LOOP                                                          *
*  -->  AT                                                            *
*  -->  FTAB_TABNAME                                                  *
*---------------------------------------------------------------------*
FORM get_table_descriptions TABLES ftab_tabname STRUCTURE i_tabname.

  LOOP AT ftab_tabname.
    SELECT SINGLE * FROM  dd02t
           WHERE  tabname     = ftab_tabname-tabname
           AND    ddlanguage  = sy-langu.

    IF sy-subrc = 0.
      ftab_tabname-tabdesc = dd02t-ddtext.
      MODIFY ftab_tabname.
    ENDIF.

  ENDLOOP.                             " LOOP AT FTAB_TABNAME
ENDFORM.                               " FORM GET_TABLE_DESCRIPTIONS
*---------------------------------------------------------------------*
*       FORM BUILD_NEW_TABLES_STATEMENT                               *
*---------------------------------------------------------------------*
*  -->  FSTR_LONG_LINE                                                *
*---------------------------------------------------------------------*
FORM build_new_tables_statement
     USING fstr_long_line LIKE i_prg_long_line.

  DATA: lc_sep(1)   TYPE c,
        li_rows     TYPE i.

  DESCRIBE TABLE i_tabname LINES li_rows.

  i_new_prog-line = 'TABLES:'.
  APPEND i_new_prog.

  LOOP AT i_tabname.
    IF sy-tabix = li_rows.
      lc_sep = '.'.
    ELSE.
      lc_sep = ','.
    ENDIF.

    CONCATENATE '~~~~'
                i_tabname-tabname
                lc_sep INTO i_new_prog.
    i_new_prog+30 = '"'.
    i_new_prog+31 = i_tabname-tabdesc.

    TRANSLATE i_new_prog USING '~ '.

    APPEND i_new_prog.

  ENDLOOP.                             " LOOP AT i_TABNAME

ENDFORM.                               " FORM BUILD_NEW_TABLES_STATEMENT
*---------------------------------------------------------------------*
*       FORM GET_FOR/LIKE_COMMENT                                     *
*---------------------------------------------------------------------*
*  -->  F_OLD_PROG                                                    *
*  -->  F_NEW_PROG                                                    *
*---------------------------------------------------------------------*
FORM get_for_like_comment USING value(f_old_prog) LIKE i_old_prog
                       CHANGING f_new_prog.

  DATA:
    lc_dummy(1)    TYPE c,
    lc_tabname(40) TYPE c,
    ltab_nametab   LIKE dntab OCCURS 0 WITH HEADER LINE,
    BEGIN OF lstr_field,
      tabname      LIKE dd02t-tabname, " Table name
      fldname      LIKE dd02t-tabname, " Table name
    END OF lstr_field.

  IF f_old_prog-line   CA '"' OR       " Line already commented
     f_old_prog-line(1) = '*'.
    f_new_prog = f_old_prog.
    EXIT.
  ELSEIF f_old_prog CS ' LIKE '.
    SPLIT f_old_prog AT ' LIKE ' INTO lc_dummy
                                      lc_tabname.
  ELSEIF f_old_prog CS ' FOR '.
    SPLIT f_old_prog AT ' FOR ' INTO lc_dummy
                                     lc_tabname.
  ELSE.
    f_new_prog = f_old_prog.
    EXIT.
  ENDIF.

* If there is anything following the table-field in a LIKE or FOR clause
* it will be removed so that only the table-field remains
  SPLIT lc_tabname AT space INTO lc_tabname
                                 lc_dummy.

  TRANSLATE lc_tabname USING '. '.     " Remove periods
  TRANSLATE lc_tabname USING ', '.     " Remove commas
  CONDENSE lc_tabname.                 " Remove extra white space

  SPLIT lc_tabname AT '-' INTO lstr_field-tabname
                               lstr_field-fldname.

* The system variables are actually defined in DDIC structure SYST
  IF lstr_field-tabname = 'SY'.
    lstr_field-tabname = 'SYST'.
  ENDIF.

  CALL FUNCTION 'NAMETAB_GET'
    EXPORTING
      langu   = sy-langu
      only    = ' '
      tabname = lstr_field-tabname
    TABLES
      nametab = ltab_nametab
    EXCEPTIONS
      OTHERS  = 4.

  READ TABLE ltab_nametab
       WITH KEY tabname   = lstr_field-tabname
                fieldname = lstr_field-fldname.

  IF sy-subrc = 0.
    CONCATENATE f_old_prog
                '"'
                ltab_nametab-fieldtext
    INTO f_new_prog SEPARATED BY space.
  ELSE.
    f_new_prog = f_old_prog.
  ENDIF.

ENDFORM.                               " FORM BUILD_NEW_TABLES_STATEMENT
*---------------------------------------------------------------------*
*       FORM ENQUEUE_ITAB_NAME                                        *
*---------------------------------------------------------------------*
*  -->  F_LINE                                                        *
*---------------------------------------------------------------------*
FORM enqueue_itab_name USING value(f_line) LIKE i_prg_long_line-code.

  DATA:
    lc_dummy(1) TYPE c,
    lc_itab(40) TYPE c.

  TRANSLATE f_line TO UPPER CASE.

  SPLIT f_line AT 'LOOP AT ' INTO lc_dummy
                                  lc_itab.

  SPLIT lc_itab AT space INTO lc_itab
                              lc_dummy.

  TRANSLATE lc_itab USING '. '.
  CONDENSE lc_itab.

  i_itab_names = lc_itab.

* Always have the most recent LOOP AT table as the first entry in the
* queue
  INSERT i_itab_names INDEX 1.

ENDFORM.                               " ENQUEUE_ITAB_NAME
*---------------------------------------------------------------------*
*       FORM ADD_COMMENT_TO_ENDLOOP                                   *
*---------------------------------------------------------------------*
*  -->  FSTR_LONG_LINE                                                *
*  -->  F_PROG_LINE                                                   *
*---------------------------------------------------------------------*
FORM add_comment_to_endloop USING fstr_long_line LIKE i_old_prog-line
                         CHANGING f_prog_line.

  IF i_old_prog-line NA '"'.        " No comments
*     Get the internal table from the queue
    READ TABLE i_itab_names INDEX 1.
    CONCATENATE i_old_prog-line
                '"'
                'LOOP AT'
                i_itab_names-tabname
      INTO f_prog_line SEPARATED BY space.
*     Dequeue the itab name
    DELETE i_itab_names INDEX 1.
  ELSE.
    f_prog_line = i_old_prog-line.
  ENDIF.
ENDFORM.                    "add_comment_to_endloop
*---------------------------------------------------------------------*
*       FORM ENQUEUE_TAB_NAME                                         *
*---------------------------------------------------------------------*
*  -->  F_LINE                                                        *
*---------------------------------------------------------------------*
FORM enqueue_tab_name USING  f_line LIKE i_old_prog-line.

  DATA:
    lc_dummy(1) TYPE c,
    lc_tab(40) TYPE c.

  TRANSLATE f_line TO UPPER CASE.

  SPLIT f_line AT ' FROM ' INTO lc_dummy
                                lc_tab.

  CONDENSE lc_tab. " Remove leading/trailing extra spaces

  SPLIT lc_tab AT space INTO lc_tab
                             lc_dummy.

  TRANSLATE lc_tab USING '. '.
  CONDENSE lc_tab.

  i_tab_names = lc_tab.

* Always have the most recent LOOP AT table as the first entry in the
* queue
  INSERT i_tab_names INDEX 1.

ENDFORM.                    "enqueue_tab_name
**---------------------------------------------------------------------*
**       FORM ADD_COMMENT_TO_SELECT                                    *
**---------------------------------------------------------------------*
**  -->  FSTR_LONG_LINE                                                *
**  -->  F_PROG_LINE                                                   *
**---------------------------------------------------------------------*
*FORM add_comment_to_select USING fstr_long_line LIKE i_old_prog-line
*                        CHANGING f_prog_line.
*
*  IF i_old_prog-line NA '"'.        " No comments
**     Get the table from the queue
*    READ TABLE i_tab_names INDEX 1.
*    CONCATENATE i_old_prog-line
*                '"'
*                'SELECT FROM'
*                i_tab_names-tabname
*      INTO f_prog_line SEPARATED BY space.
**     Dequeue the tab name
*    DELETE i_tab_names INDEX 1.
*  ELSE.
*    f_prog_line = i_old_prog-line.
*  ENDIF.
*
*ENDFORM.
*---------------------------------------------------------------------*
*       FORM ADD_COMMENT_TO_ENDFORM                                   *
*---------------------------------------------------------------------*
*  -->  FSTR_LONG_LINE                                                *
*  -->  F_NEW_PROG                                                    *
*---------------------------------------------------------------------*
FORM add_comment_to_endform USING fstr_long_line LIKE i_old_prog-line
                         CHANGING f_prog_line.

  IF i_old_prog-line NA '"'.        " No comments
*     Get the table from the queue
    READ TABLE i_form_names INDEX 1.
    CONCATENATE i_old_prog-line
                '"'
                'FORM'
                i_form_names-tabname
      INTO f_prog_line SEPARATED BY space.
*     Dequeue the form name
    DELETE i_form_names INDEX 1.
  ELSE.
    f_prog_line = i_old_prog-line.
  ENDIF.

ENDFORM.                    "add_comment_to_endform

*---------------------------------------------------------------------*
*       FORM ENQUEUE_FORM_NAME                                        *
*---------------------------------------------------------------------*
*  -->  F_LINE                                                        *
*---------------------------------------------------------------------*
FORM enqueue_form_name USING f_line.

  DATA:
    lc_dummy(1) TYPE c,
    lc_tab(40) TYPE c.

  TRANSLATE f_line TO UPPER CASE.

  SPLIT f_line AT 'FORM ' INTO lc_dummy
                               lc_tab.

  CONDENSE lc_tab. " Remove leading/trailing extra spaces

  SPLIT lc_tab AT space INTO lc_tab
                             lc_dummy.

  TRANSLATE lc_tab USING '. '.
  CONDENSE lc_tab.

  i_form_names = lc_tab.

* Always have the most recent LOOP AT table as the first entry in the
* queue
  INSERT i_form_names INDEX 1.

ENDFORM.                               " FORM ENQUEUE_FORM_NAME

*&---------------------------------------------------------------------*
*&      Form  create_join_select
*----------------------------------------------------------------------*
*      -->P_R_FIELDLIST  text
*      -->P_R_JOINSET1  text
*      -->P_R_JOINSET2  text
*      -->P_P_TBJ1  text
*      -->P_P_TBJ2  text
*      -->P_P_TBJ3  text
*      -->P_P_FAEJ1  text
*----------------------------------------------------------------------*
FORM create_join_select  TABLES r_fieldlist STRUCTURE r_fieldlist
                                r_joinset1 STRUCTURE r_fieldlist
                                r_joinset2 STRUCTURE r_fieldlist
                                r_joinset3 STRUCTURE r_fieldlist
                         USING  table1
                                table2
                                table3
                                table4
                                faetab.

  DATA l_text(60) TYPE c.
  DATA l_text1(100) TYPE c.
  RANGES r_fieldlist_backup FOR wa_ranges.

  add_macro_line_temp space.
  CONCATENATE text-cc4 "'* Select data from table'(CC4)
              table1 table2 table3 table4
                INTO v_temp_string SEPARATED BY space.
  add_macro_line_temp v_temp_string.

  IF table4 IS NOT INITIAL.
    CONCATENATE p_sub 'SELECT' INTO v_temp_string.
    CONCATENATE 'PERFORM' v_temp_string INTO v_temp_string
                                SEPARATED BY space.
    CONCATENATE v_temp_string table1 table2 table3 table4
                            INTO v_temp_string SEPARATED BY '_'.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.

    CONCATENATE 'SELECT' table1 table2 table3 table4
                            INTO v_temp_string SEPARATED BY '_'.
    add_subroutine_title v_temp_string.

  ELSEIF table3 IS NOT INITIAL.
    CONCATENATE p_sub 'SELECT' INTO v_temp_string.
    CONCATENATE 'PERFORM' v_temp_string INTO v_temp_string
                                SEPARATED BY space.
    CONCATENATE v_temp_string table1 table2 table3
                            INTO v_temp_string SEPARATED BY '_'.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.

    CONCATENATE 'SELECT' table1 table2 table3
                            INTO v_temp_string SEPARATED BY '_'.
    add_subroutine_title v_temp_string.

  ELSEIF table2 IS NOT INITIAL.
    CONCATENATE p_sub 'SELECT' INTO v_temp_string.
    CONCATENATE 'PERFORM' v_temp_string INTO v_temp_string
                                SEPARATED BY space.
    CONCATENATE v_temp_string table1 table2
                            INTO v_temp_string SEPARATED BY '_'.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.

    CONCATENATE 'SELECT' table1 table2
                            INTO v_temp_string SEPARATED BY '_'.
    add_subroutine_title v_temp_string.
  ELSE.
    CONCATENATE p_sub 'SELECT_DATA' INTO v_temp_string.
    CONCATENATE 'PERFORM' v_temp_string INTO v_temp_string
                                SEPARATED BY space.

    CONCATENATE v_temp_string table1
                                   INTO v_temp_string SEPARATED BY '_'.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_temp v_temp_string.

    CONCATENATE 'SELECT_DATA' table1
                            INTO v_temp_string SEPARATED BY '_'.
    add_subroutine_title v_temp_string.
  ENDIF.

  CLEAR v_temp_string.

  IF faetab IS NOT INITIAL.
    READ TABLE i_processing INTO wa_processing WITH KEY table = faetab.
    IF sy-subrc EQ 0.
      IF wa_processing-j3table IS NOT INITIAL.
        CONCATENATE wa_processing-table wa_processing-j1table
                    wa_processing-j2table wa_processing-j3table
               INTO l_text1 SEPARATED BY '_'.

      ELSEIF wa_processing-j2table IS NOT INITIAL.
        CONCATENATE wa_processing-table wa_processing-j1table
                    wa_processing-j2table INTO l_text1 SEPARATED BY '_'.

      ELSEIF wa_processing-j1table IS NOT INITIAL.
        CONCATENATE wa_processing-table wa_processing-j1table
                         INTO l_text1 SEPARATED BY '_'.
      ELSE.
        l_text1 = wa_processing-table.
      ENDIF.
    ENDIF.
  ELSE.
    l_text1 = faetab.
  ENDIF.

* For all entries condition, check if the table is not initial
  IF NOT faetab IS INITIAL.
    v_temp_string = text-cc5.
    "'*Check that the table used for For All Entries is not empty'(CC5).
    add_macro_line_forms v_temp_string.
    CONCATENATE 'Check not' p_itab INTO v_temp_string
                    SEPARATED BY space.
    CONCATENATE v_temp_string 'XXXX[] is initial.' INTO v_temp_string.
    REPLACE 'XXXX' IN v_temp_string WITH l_text1.
    add_macro_line_forms v_temp_string.
    add_macro_line_forms space.
  ENDIF.

  add_macro_line_forms text-cc4. "'* Select data from table'(CC4).
  LOOP AT r_fieldlist INTO wa_ranges.

    IF sy-tabix EQ 1.
      IF wa_ranges-high IS NOT INITIAL.
        CONCATENATE wa_ranges-high '~' wa_ranges-low INTO v_temp_string.
      ELSE.
        v_temp_string = wa_ranges-low.
      ENDIF.
      CONCATENATE 'Select' v_temp_string INTO v_temp_string
                    SEPARATED BY space.
      add_macro_line_forms v_temp_string.
      CONTINUE.
    ENDIF.

    CLEAR v_temp_string.
    IF wa_ranges-high IS NOT INITIAL.
      CONCATENATE wa_ranges-high '~' wa_ranges-low INTO v_temp_string+7.
    ELSE.
      v_temp_string+7 = wa_ranges-low.
    ENDIF.
    add_macro_line_forms v_temp_string.
  ENDLOOP.
  CLEAR v_temp_string.

  CONCATENATE 'From' table1 INTO v_temp_string+2 SEPARATED BY space.
  add_macro_line_forms v_temp_string.

  IF table2 IS NOT INITIAL.      "Join table 1
    CLEAR v_temp_string.
    CONCATENATE 'Join' table2 INTO v_temp_string+2 SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    READ TABLE r_joinset1 INTO wa_ranges INDEX 1.
    CONCATENATE  table1 '~' wa_ranges-low INTO v_temp_string2.
    CONCATENATE  table2 '~' wa_ranges-low INTO v_temp_string3.
    CONCATENATE 'ON' v_temp_string2 'eq' v_temp_string3
                  INTO v_temp_string+4 SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    LOOP AT r_joinset1 INTO wa_ranges FROM 2.
      CLEAR v_temp_string.
      CONCATENATE  table1 '~' wa_ranges-low INTO v_temp_string2.
      CONCATENATE  table2 '~' wa_ranges-low INTO v_temp_string3.
      CONCATENATE 'and' v_temp_string2 'eq' v_temp_string3
                  INTO v_temp_string+3 SEPARATED BY space.
      add_macro_line_forms v_temp_string.
    ENDLOOP.
  ENDIF.

  IF table3 IS NOT INITIAL.     "Join table 2
    CLEAR v_temp_string.
    CONCATENATE 'Join' table3 INTO v_temp_string+2 SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    READ TABLE r_joinset2 INTO wa_ranges INDEX 1.
    CONCATENATE  table2 '~' wa_ranges-low INTO v_temp_string2.
    CONCATENATE  table3 '~' wa_ranges-low INTO v_temp_string3.
    CONCATENATE 'ON' v_temp_string2 'eq' v_temp_string3
                            INTO v_temp_string+4 SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    LOOP AT r_joinset2 INTO wa_ranges FROM 2.
      CLEAR v_temp_string.
      CONCATENATE  table2 '~' wa_ranges-low INTO v_temp_string2.
      CONCATENATE  table3 '~' wa_ranges-low INTO v_temp_string3.
      CONCATENATE 'and' v_temp_string2 'eq' v_temp_string3
                            INTO v_temp_string+3 SEPARATED BY space.
      add_macro_line_forms v_temp_string.
    ENDLOOP.
  ENDIF.

  IF table4 IS NOT INITIAL.     "Join table 3
    CLEAR v_temp_string.
    CONCATENATE 'Join' table4 INTO v_temp_string+2 SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    CLEAR v_temp_string.
    READ TABLE r_joinset3 INTO wa_ranges INDEX 1.
    CONCATENATE  table3 '~' wa_ranges-low INTO v_temp_string2.
    CONCATENATE  table4 '~' wa_ranges-low INTO v_temp_string3.
    CONCATENATE 'ON' v_temp_string2 'eq' v_temp_string3
                            INTO v_temp_string+4 SEPARATED BY space.
    add_macro_line_forms v_temp_string.

    LOOP AT r_joinset2 INTO wa_ranges FROM 2.
      CLEAR v_temp_string.
      CONCATENATE  table3 '~' wa_ranges-low INTO v_temp_string2.
      CONCATENATE  table4 '~' wa_ranges-low INTO v_temp_string3.
      CONCATENATE 'and' v_temp_string2 'eq' v_temp_string3
                            INTO v_temp_string+3 SEPARATED BY space.
      add_macro_line_forms v_temp_string.
    ENDLOOP.
  ENDIF.

  CLEAR v_temp_string.

  IF table4 IS NOT INITIAL.
    CONCATENATE table1 table2 table3 table4
                                     INTO l_text SEPARATED BY '_'.
  ELSEIF table3 IS NOT INITIAL.
    CONCATENATE table1 table2 table3 INTO l_text SEPARATED BY '_'.
  ELSEIF table2 IS NOT INITIAL.
    CONCATENATE table1 table2 INTO l_text SEPARATED BY '_'.
  ELSE.
    l_text = table1.
  ENDIF.
  CONCATENATE 'Into table' p_itab INTO v_temp_string+2
                    SEPARATED BY space.
  CONCATENATE v_temp_string l_text INTO v_temp_string.
  add_macro_line_forms v_temp_string.

  CLEAR v_temp_string.
  CLEAR v_temp_string2.
  CLEAR v_temp_string3.

* Now take care of the For all entries scenario
  IF NOT faetab IS INITIAL.

    CLEAR i_program_temp2[].
    CLEAR i_program_temp3[].

    CONCATENATE 'For All Entries in' p_itab
                          INTO v_temp_string+2 SEPARATED BY space.
    CONCATENATE v_temp_string l_text1 INTO v_temp_string.
    add_macro_line_forms v_temp_string.
    CLEAR v_temp_string.

    r_fieldlist_backup[] = r_fieldlist[].

* Check which of the fields is being used for FAE
    READ TABLE i_processing INTO wa_processing WITH KEY table = faetab.
    IF sy-subrc EQ 0.

      IF wa_processing-field1 IN r_fieldlist[].
        add_fae_addition wa_processing-field1 l_text1
                              table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field1.
      ENDIF.

      IF wa_processing-field2 IN r_fieldlist[].
        add_fae_addition wa_processing-field2 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field2.
      ENDIF.

      IF wa_processing-field3 IN r_fieldlist[].
        add_fae_addition wa_processing-field3 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field3.
      ENDIF.

      IF wa_processing-field4 IN r_fieldlist[].
        add_fae_addition wa_processing-field4 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field4.
      ENDIF.

      IF wa_processing-field5 IN r_fieldlist[].
        add_fae_addition wa_processing-field5 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field5.
      ENDIF.

      IF wa_processing-field6 IN r_fieldlist[].
        add_fae_addition wa_processing-field6 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field6.
      ENDIF.

      IF wa_processing-field7 IN r_fieldlist[].
        add_fae_addition wa_processing-field7 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field7.
      ENDIF.

      IF wa_processing-field8 IN r_fieldlist[].
        add_fae_addition wa_processing-field8 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field8.
      ENDIF.

      IF wa_processing-field9 IN r_fieldlist[].
        add_fae_addition wa_processing-field9 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field9.
      ENDIF.

      IF wa_processing-field10 IN r_fieldlist[].
        add_fae_addition wa_processing-field10 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field10.
      ENDIF.

      IF wa_processing-field11 IN r_fieldlist[].
        add_fae_addition wa_processing-field11 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field11.
      ENDIF.

      IF wa_processing-field12 IN r_fieldlist[].
        add_fae_addition wa_processing-field12 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field12.
      ENDIF.

      IF wa_processing-field13 IN r_fieldlist[].
        add_fae_addition wa_processing-field13 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field13.
      ENDIF.

      IF wa_processing-field14 IN r_fieldlist[].
        add_fae_addition wa_processing-field14 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field14.
      ENDIF.

      IF wa_processing-field15 IN r_fieldlist[].
        add_fae_addition wa_processing-field15 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-field15.
      ENDIF.

      IF wa_processing-j1fld1 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld1 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld1.
      ENDIF.

      IF wa_processing-j1fld2 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld2 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld2.
      ENDIF.

      IF wa_processing-j1fld3 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld3 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld3.
      ENDIF.

      IF wa_processing-j1fld4 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld4 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld4.
      ENDIF.

      IF wa_processing-j1fld5 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld5 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld5.
      ENDIF.

      IF wa_processing-j1fld6 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld6 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld6.
      ENDIF.

      IF wa_processing-j1fld7 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld7 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld7.
      ENDIF.

      IF wa_processing-j1fld8 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld8 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld8.
      ENDIF.

      IF wa_processing-j1fld9 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld9 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld9.
      ENDIF.

      IF wa_processing-j1fld10 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld10 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld10.
      ENDIF.

      IF wa_processing-j1fld11 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld11 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld11.
      ENDIF.

      IF wa_processing-j1fld12 IN r_fieldlist[].
        add_fae_addition wa_processing-j1fld12 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j1fld12.
      ENDIF.

      IF wa_processing-j2fld1 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld1 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld1.
      ENDIF.

      IF wa_processing-j2fld2 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld2 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld2.
      ENDIF.

      IF wa_processing-j2fld3 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld3 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld3.
      ENDIF.

      IF wa_processing-j2fld4 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld4 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld4.
      ENDIF.

      IF wa_processing-j2fld5 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld5 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld5.
      ENDIF.

      IF wa_processing-j2fld6 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld6 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld6.
      ENDIF.

      IF wa_processing-j2fld7 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld7 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld7.
      ENDIF.

      IF wa_processing-j2fld8 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld8 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld8.
      ENDIF.

      IF wa_processing-j2fld9 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld9 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld9.
      ENDIF.

      IF wa_processing-j2fld10 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld10 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld10.
      ENDIF.

      IF wa_processing-j2fld11 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld11 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld11.
      ENDIF.

      IF wa_processing-j2fld12 IN r_fieldlist[].
        add_fae_addition wa_processing-j2fld12 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j2fld12.
      ENDIF.

      IF wa_processing-j3fld1 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld1 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld1.
      ENDIF.

      IF wa_processing-j3fld2 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld2 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld2.
      ENDIF.

      IF wa_processing-j3fld3 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld3 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld3.
      ENDIF.

      IF wa_processing-j3fld4 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld4 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld4.
      ENDIF.

      IF wa_processing-j3fld5 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld5 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld5.
      ENDIF.

      IF wa_processing-j3fld6 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld6 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld6.
      ENDIF.

      IF wa_processing-j3fld7 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld7 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld7.
      ENDIF.

      IF wa_processing-j3fld8 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld8 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld8.
      ENDIF.

      IF wa_processing-j3fld9 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld9 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld9.
      ENDIF.

      IF wa_processing-j3fld10 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld10 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld10.
      ENDIF.

      IF wa_processing-j3fld11 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld11 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld11.
      ENDIF.

      IF wa_processing-j3fld12 IN r_fieldlist[].
        add_fae_addition wa_processing-j3fld12 l_text1
                            table1 table2 table3 table4.
        DELETE r_fieldlist WHERE low EQ wa_processing-j3fld12.
      ENDIF.

      r_fieldlist[] = r_fieldlist_backup[].

    ENDIF.
  ENDIF.

  IF i_program_temp2[] IS NOT INITIAL.
    DESCRIBE TABLE i_program_temp2 LINES v_index.
    READ TABLE i_program_temp2 INTO v_temp_string2 INDEX v_index.
    CONCATENATE v_temp_string2 'BINARY SEARCH.'
                        INTO v_temp_string2 SEPARATED BY space.
    MODIFY i_program_temp2 FROM v_temp_string2 INDEX v_index.
    APPEND 'If sy-subrc eq 0.' TO i_program_temp2.

* Append the output list mapping
    LOOP AT r_fieldlist INTO wa_ranges.

      READ TABLE r_output_list WITH KEY low = wa_ranges-low.
      IF sy-subrc EQ 0.
        IF r_output_list-high IS NOT INITIAL.
          CONCATENATE p_wa 'outdata-' r_output_list-high
                    INTO v_temp_string2.
        ELSE.
          CONCATENATE p_wa 'outdata-' wa_ranges-low
                    INTO v_temp_string2.
        ENDIF.

        CONCATENATE v_temp_string2 '=' p_wa
                         INTO v_temp_string2 SEPARATED BY space.
        CONCATENATE v_temp_string2 l_text '-'
                          wa_ranges-low c_dot INTO v_temp_string2.

        APPEND v_temp_string2 TO i_program_temp3.
        DELETE r_output_list WHERE low = wa_ranges-low.
        "Remove field from list
      ENDIF.

    ENDLOOP.
    APPEND LINES OF i_program_temp3 TO i_program_temp2.
    APPEND 'Endif.' TO i_program_temp2.
  ENDIF.

  LOOP AT i_selection INTO wa_selection.
    IF table1 EQ wa_selection-table.
      IF wa_selection-etype EQ 'P'.
        add_where_addition p_para wa_selection-field
                           wa_selection-name table1 table2.
      ELSE.
        add_where_addition p_sopt wa_selection-field
                           wa_selection-name table1 table2.
      ENDIF.
    ENDIF.
  ENDLOOP.

  LOOP AT i_selection INTO wa_selection.
    IF table2 EQ wa_selection-table.
      IF wa_selection-etype EQ 'P'.
        add_where_addition p_para wa_selection-field
                           wa_selection-name table2 table1.
      ELSE.
        add_where_addition p_sopt wa_selection-field
                           wa_selection-name table2 table1.
      ENDIF.
    ENDIF.
  ENDLOOP.

  LOOP AT i_selection INTO wa_selection.
    IF table3 EQ wa_selection-table.
      IF wa_selection-etype EQ 'P'.
        add_where_addition p_para wa_selection-field
                           wa_selection-name table3 table1.
      ELSE.
        add_where_addition p_sopt wa_selection-field
                           wa_selection-name table3 table1.
      ENDIF.
    ENDIF.
  ENDLOOP.

  LOOP AT i_selection INTO wa_selection.
    IF table4 EQ wa_selection-table.
      IF wa_selection-etype EQ 'P'.
        add_where_addition p_para wa_selection-field
                           wa_selection-name table4 table1.
      ELSE.
        add_where_addition p_sopt wa_selection-field
                           wa_selection-name table4 table1.
      ENDIF.
    ENDIF.
  ENDLOOP.

* Add period in the last line of the code
  DESCRIBE TABLE i_program_forms LINES v_index.
  READ TABLE i_program_forms INTO v_temp_string INDEX v_index.
  SPLIT v_temp_string AT '"' INTO v_temp_string v_temp_string2.
  CONCATENATE v_temp_string c_dot INTO v_temp_string.
  IF v_temp_string2 IS NOT INITIAL.
    SHIFT v_temp_string2 LEFT DELETING LEADING space.
    v_temp_string+48 = '"'. v_temp_string+49 = v_temp_string2.
  ENDIF.
  MODIFY i_program_forms FROM v_temp_string INDEX v_index.
  add_macro_line_forms space.
  add_macro_line_forms text-cc6.
  "'* Issue error message if the select fails'(CC6).
  add_macro_line_forms 'if sy-subrc ne 0.'.
  CONCATENATE 'Message i398(00) with' text-050
              INTO v_temp_string SEPARATED BY space.
  add_macro_line_forms v_temp_string.
  add_report_texts 'I' 'E03' 'No data selected from table'.

  v_textid = v_textid + 1.
  add_report_texts 'I' v_textid table1.

  CLEAR v_temp_string.
  CONCATENATE text-121 table1 text-121
                      '(' v_textid ')' INTO v_temp_string+10.

  IF table2 IS NOT INITIAL.
    v_textid = v_textid + 1.
    add_report_texts 'I' v_textid table2.

    CONCATENATE v_temp_string text-121
                    INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string table2 text-121
                    '(' v_textid ')' INTO v_temp_string.
  ELSE.
    CONCATENATE v_temp_string 'space'
              INTO v_temp_string SEPARATED BY space.
  ENDIF.

  IF table3 IS NOT INITIAL.
    v_textid = v_textid + 1.
    add_report_texts 'I' v_textid table3.

    CONCATENATE v_temp_string text-121
              INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string table3 text-121
                      '(' v_textid ')' INTO v_temp_string.
  ELSE.
    CONCATENATE v_temp_string 'space'
              INTO v_temp_string SEPARATED BY space.
  ENDIF.

  IF table4 IS NOT INITIAL.
    v_textid = v_textid + 1.
    add_report_texts 'I' v_textid table3.

*    CONCATENATE v_temp_string text-121
*              INTO v_temp_string SEPARATED BY space.
*    CONCATENATE v_temp_string table4 text-121
*                      '(' v_textid ')' INTO v_temp_string.
  ENDIF.

  CONCATENATE v_temp_string c_dot INTO v_temp_string.
  add_macro_line_forms v_temp_string.
  add_macro_line_forms 'Leave list-processing.'.

  IF v_temp_string3 IS NOT INITIAL.
    add_macro_line_forms space.
    add_macro_line_forms text-cc7.
    "'* Sort table for use in Binary search later'(CC7).
    add_macro_line_forms 'else.'.
    CONCATENATE 'Sort' p_itab INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string l_text INTO v_temp_string.
    SHIFT v_temp_string3 LEFT DELETING LEADING space.
    CONCATENATE v_temp_string 'by' v_temp_string3
                  INTO v_temp_string SEPARATED BY space.
    CONCATENATE v_temp_string c_dot INTO v_temp_string.
    add_macro_line_forms v_temp_string.
  ENDIF.

  add_macro_line_forms 'endif.'.
  add_macro_line_forms space.
  add_macro_line_forms 'endform.'.

ENDFORM.                    " create_join_select

*&---------------------------------------------------------------------*
*&      Form  create_function_modules
*&---------------------------------------------------------------------*
*       Create New Function Module
*----------------------------------------------------------------------*
FORM create_function_modules.

  DATA l_fmname(30) TYPE c.
  DATA  obj_check TYPE REF TO cl_function_builder.

*call method obj_check->ch_check_namespace
*    exporting
*      fb_name         = l_fmname
*      fb_area         = v_fmgrp
*    exceptions
*      wrong_namespace = 1
*      others          = 2.
*
*IF SY-SUBRC NE 0.
*MESSAGE I398(00) WITH
*        'Function Group' v_fmgrp
*        'is not in valid customer namespace'
*        raising action_cancelled.
**        SET Screen 1000.
*        CALL SELECTION-SCREEN 1000.
*        LEAVE LIST-PROCESSING.
*ENDIF.
* If the Function Group does not exist, then create it
  CALL FUNCTION 'FUNCTION_POOL_CREATE'
    EXPORTING
      pool_name           = v_fmgrp
      short_text          = p_desrip
    EXCEPTIONS
      name_already_exists = 1
      name_not_correct    = 2
      OTHERS              = 3.
  IF sy-subrc <> 0.  ENDIF.

  LOOP AT i_fm INTO wa_fm.
    TRANSLATE wa_fm-ptype TO UPPER CASE.
    fill_fm_table wa_fm-pname wa_fm-ptype(2) wa_fm-mand wa_fm-type.
  ENDLOOP.

  l_fmname = v_program_name.

*PERFORM AUTHORITIES_AND_CORR
*          Using v_program_name 'FUGC' ' ' ' '.
*
* Check before creating FM
  PERFORM pop_up_to_confirm.

  CALL FUNCTION 'FUNCTION_CREATE'
    EXPORTING
*      corrnum                 = p_cts
      funcname                = l_fmname
      function_pool           = v_fmgrp
      remote_call             = v_fmrfc
      short_text              = p_desrip
*      suppress_corr_check     = space
    IMPORTING
      function_include        = v_fminclude
    TABLES
      exception_list          = i_exceptions
      export_parameter        = i_exporting
      import_parameter        = i_importing
      tables_parameter        = i_tables
      changing_parameter      = i_changing
      parameter_docu          = i_para_docu
    EXCEPTIONS
      double_task             = 1
      error_message           = 2
      function_already_exists = 3
      invalid_function_pool   = 4
      invalid_name            = 5
      too_many_functions      = 6
      OTHERS                  = 7.

  IF sy-subrc EQ 0.

* Add the Subroutines to the main program
    add_macro_line space.

    READ REPORT v_fminclude INTO i_program_temp.
    DESCRIBE TABLE i_program_temp LINES v_linecount.
    v_linecount = v_linecount - 1.
    INSERT lines of i_program INTO i_program_temp
                    INDEX v_linecount.

* Now add the sobroutines after the ENDFUNCTION
    APPEND LINES OF i_program_forms TO i_program_temp.

* Create another table for formatting
    LOOP AT i_program_temp.
      i_old_prog-line = i_program_temp.
      APPEND i_old_prog.
    ENDLOOP.

    PERFORM format.
    INSERT REPORT v_fminclude FROM i_new_prog.

    REFRESH i_old_prog. REFRESH i_new_prog.
    CLEAR i_old_prog. CLEAR i_new_prog.

* Copy the data declaration part in the main include
    CONCATENATE 'L' v_fmgrp 'TOP' INTO v_fminclude.
    READ REPORT v_fminclude INTO i_old_prog.
    APPEND LINES OF i_program_fmdata TO i_old_prog.
    PERFORM format.
    INSERT REPORT v_fminclude FROM i_new_prog.

* insert_text_data
    SORT i_texttab BY id key.
    CONCATENATE 'SAPLZ' v_fmgrp INTO v_program_name.
    INSERT textpool v_program_name FROM i_texttab LANGUAGE sy-langu.

    SET PARAMETER ID 'LIB' FIELD l_fmname.
    LEAVE TO TRANSACTION 'SE37'.

*    wa_ko200-pgmid = 'R3TR'.
*    wa_ko200-object = 'FUGR'.
*    wa_ko200-obj_name = v_program_name.
*    wa_ko200-operation = 'I'.
*    wa_ko200-devclass = p_devc.
*
*    CALL FUNCTION 'TRINT_CORR_INSERT'
*      EXPORTING
*        iv_order          = p_cts
*        is_ko200          = wa_ko200
*      EXCEPTIONS
*        cancel_edit_error = 1
*        show_only_error   = 2
*        OTHERS            = 3.
*    IF sy-subrc <> 0.      ENDIF.

  ENDIF.

ENDFORM.                    " create_function_modules

*&---------------------------------------------------------------------*
*&      Form  rearrange_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM rearrange_data.

  DATA l_index   TYPE i.
*  data l_index2   type char2.
*  data l_index3   type char2.
  DATA l_variable TYPE char40.
  FIELD-SYMBOLS <lfs>.
  DATA l_i_excel_sheet1 TYPE STANDARD TABLE OF
                                   ty_excel_data INITIAL SIZE 0.
  DATA l_i_excel_sheet2 TYPE STANDARD TABLE OF
                                   ty_excel_data INITIAL SIZE 0.
  DATA l_i_excel_sheet3 TYPE STANDARD TABLE OF
                                   ty_excel_data INITIAL SIZE 0.
  DATA l_i_excel_sheet4 TYPE STANDARD TABLE OF
                                   ty_excel_data INITIAL SIZE 0.
* Remove all headers from the excel data
*  delete i_Excel_data where row eq 1.
*  delete i_Excel_data where row eq 2.
*  delete i_Excel_data where col eq 1.

  l_i_excel_sheet1[] = l_i_excel_sheet2[] = l_i_excel_sheet3[]
            = l_i_excel_sheet4[] = i_excel_data[].

  DELETE l_i_excel_sheet1 WHERE worksheet NE 'Selection'.
  DELETE l_i_excel_sheet2 WHERE worksheet NE 'Processing'.
  DELETE l_i_excel_sheet3 WHERE worksheet NE 'Input-Output'.
  DELETE l_i_excel_sheet4 WHERE worksheet NE 'Function Module'.

  DELETE l_i_excel_sheet1 WHERE row EQ 2.
  DELETE l_i_excel_sheet1 WHERE col GE 11.

*  READ TABLE l_i_excel_sheet1 INTO wa_excel_data
*                                  WITH KEY value = 'D - Date'.
*  IF sy-subrc EQ 0.
*    DELETE l_i_excel_sheet1 WHERE row GE wa_excel_data-row.
*  ENDIF.

  LOOP AT l_i_excel_sheet1 INTO wa_excel_data.
    MOVE wa_excel_data-col TO l_index.
    ASSIGN COMPONENT l_index OF STRUCTURE wa_selection TO <lfs>.
    MOVE wa_excel_data-value TO <lfs>.
    AT END OF row.
      TRANSLATE wa_selection+48 TO UPPER CASE.
      APPEND wa_selection TO i_selection.
      CLEAR wa_selection.
    ENDAT.
  ENDLOOP.

*  SORT l_i_excel_sheet2 BY row.

  DELETE l_i_excel_sheet2 WHERE row EQ 2.
  DELETE l_i_excel_sheet2 WHERE col GT 68.

*  READ TABLE l_i_excel_sheet2 INTO wa_excel_data WITH KEY value = 'END'
*.
*  IF sy-subrc EQ 0.
*    DELETE l_i_excel_sheet2 WHERE row GE wa_excel_data-row.
*  ENDIF.

  READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                    WITH KEY value = 'Function Module 1'.
  IF sy-subrc EQ 0.
    l_index = sy-tabix.
    READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                      WITH KEY row = wa_excel_data-row
                               col = 2.
    IF sy-subrc EQ 0.
      v_fm1 = wa_excel_data-value.
      TRANSLATE v_fm1 TO UPPER CASE.
    ENDIF.
  ENDIF.

  READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                    WITH KEY value = 'Function Module 2'.
  IF sy-subrc EQ 0.
    READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                      WITH KEY row = wa_excel_data-row
                               col = 2.
    IF sy-subrc EQ 0.
      v_fm2 = wa_excel_data-value.
      TRANSLATE v_fm2 TO UPPER CASE.
    ENDIF.
  ENDIF.

  READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                    WITH KEY value = 'Function Module 3'.
  IF sy-subrc EQ 0.
    READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                      WITH KEY row = wa_excel_data-row
                               col = 2.
    IF sy-subrc EQ 0.
      v_fm3 = wa_excel_data-value.
      TRANSLATE v_fm3 TO UPPER CASE.
    ENDIF.
  ENDIF.

  READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                    WITH KEY value = 'Function Module 4'.
  IF sy-subrc EQ 0.
    READ TABLE l_i_excel_sheet2 INTO wa_excel_data
                      WITH KEY row = wa_excel_data-row
                               col = 2.
    IF sy-subrc EQ 0.
      v_fm4 = wa_excel_data-value.
      TRANSLATE v_fm4 TO UPPER CASE.
    ENDIF.
  ENDIF.

  SORT l_i_excel_sheet2 BY row col.
  DELETE l_i_excel_sheet2 FROM l_index.

  LOOP AT l_i_excel_sheet2 INTO wa_excel_data.
    MOVE wa_excel_data-col TO l_index.
    ASSIGN COMPONENT l_index OF STRUCTURE wa_processing TO <lfs>.
    MOVE wa_excel_data-value TO <lfs>.
    AT END OF row.
      TRANSLATE wa_processing TO UPPER CASE.
      APPEND wa_processing TO i_processing.
      CLEAR wa_processing.
    ENDAT.
  ENDLOOP.

  DELETE l_i_excel_sheet3 WHERE row EQ 2.
*  DELETE l_i_excel_sheet3 WHERE row GE 33.
  DELETE l_i_excel_sheet3 WHERE col GT 6.

  LOOP AT l_i_excel_sheet3 TRANSPORTING NO FIELDS
        WHERE value CS 'Either Column C & D' .
    DELETE l_i_excel_sheet3 FROM sy-tabix.
  ENDLOOP.


  LOOP AT l_i_excel_sheet3 INTO wa_excel_data.
    MOVE wa_excel_data-col TO l_index.
    ASSIGN COMPONENT l_index OF STRUCTURE wa_output_data TO <lfs>.
    MOVE wa_excel_data-value TO <lfs>.
    AT END OF row.
      TRANSLATE wa_output_data+60 TO UPPER CASE.
      APPEND wa_output_data TO i_output_data.
      CLEAR wa_output_data.
    ENDAT.
  ENDLOOP.

  SORT l_i_excel_sheet4 BY row col.

  READ TABLE l_i_excel_sheet4 INTO wa_excel_data
                    WITH KEY row = '2' col = '2' BINARY SEARCH.
  IF sy-subrc EQ 0.
    v_fmrfc = wa_excel_data-value.
  ENDIF.

  READ TABLE l_i_excel_sheet4 INTO wa_excel_data
                    WITH KEY row = '4' col = '2' BINARY SEARCH.
  IF sy-subrc EQ 0.
    v_fmgrp = wa_excel_data-value.
  ENDIF.

  DELETE l_i_excel_sheet4 WHERE row LE 6.
  DELETE l_i_excel_sheet4 WHERE row GE 32.
  DELETE l_i_excel_sheet4 WHERE col GT 4.

  LOOP AT l_i_excel_sheet4 INTO wa_excel_data.
    MOVE wa_excel_data-col TO l_index.
    ASSIGN COMPONENT l_index OF STRUCTURE wa_fm TO <lfs>.
    MOVE wa_excel_data-value TO <lfs>.
    AT END OF row.
      APPEND wa_fm TO i_fm.
      CLEAR wa_fm.
    ENDAT.
  ENDLOOP.

ENDFORM.                    " rearrange_data

*&---------------------------------------------------------------------*
*&      Form  get_event
*&---------------------------------------------------------------------*
FORM get_event .

  DATA l_text1(60) TYPE c.

* For HR only
  IF p_app5 IS NOT INITIAL.

    add_macro_line space.
    add_macro_line text-100.
    add_macro_line text-03f.
    add_macro_line text-100.
    add_macro_line space.

    LOOP AT it_ldb_nodes_sel INTO wa_ldb_nodes.

      CONCATENATE text-cc8 "'* GET event for node'(CC8)
                  wa_ldb_nodes-ldbnode
                  INTO v_temp_string SEPARATED BY space.
      add_macro_line v_temp_string.
      CONCATENATE wa_ldb_nodes-ldbnode '.' INTO l_text1.
      CONCATENATE 'GET' l_text1 INTO v_temp_string
                  SEPARATED BY space.
      add_macro_line v_temp_string.
      add_macro_line space.

    ENDLOOP.

  ENDIF.

ENDFORM.                    " get_event
*&---------------------------------------------------------------------*
*&      Form  AUTHORITIES_AND_CORR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_PGM0  text
*      -->P_7249   text
*      -->P_7250   text
*      -->P_7251   text
*      -->P_7252   text
*----------------------------------------------------------------------*
FORM authorities_and_corr USING progname TYPE tadir-obj_name
                          object_class TYPE trdir-clas
                          suppress_extend_dialog TYPE c
                          suppress_upgrade_check TYPE c.
  DATA BEGIN OF edit.
          INCLUDE STRUCTURE s38e.
  DATA END OF edit.

  DATA: show_mode(8),
        extend,
        extend_mod,
        subrc LIKE sy-subrc,
        programm LIKE trdir-name,
        f_progname LIKE rs38l-include,
        l_namespace LIKE rs38l-namespace,
        l_inclname LIKE trdir-name,
        l_suppress_corr_check,
          boolean(1).

  DATA: namespace LIKE rs38l-namespace.
  DATA: l_trdir TYPE trdir.

  DATA: BEGIN OF ddenq,                "DICT-Sperrschlssel
                objtype LIKE rsdeo-objtype,
                objname LIKE rsdeo-objname,
         END OF ddenq.

  programm = progname.
  CLEAR extend.
  CLEAR extend_mod.

  l_trdir-name = progname.

  l_inclname = programm.

  show_mode = 'INSERT'.

  CALL FUNCTION 'RS_PROGNAME_SPLIT'
    EXPORTING
      progname_with_namespace = l_inclname
    IMPORTING
      namespace               = l_namespace
    EXCEPTIONS
      delimiter_error         = 1
      OTHERS                  = 2.

  CALL FUNCTION 'RS_ACCESS_PERMISSION'
    EXPORTING
      mode                     = 'INSERT'
      object                   = progname
      object_class             = 'ABAP'
      trdir_inf                = l_trdir
      suppress_language_check  = space
      global_lock              = 'X'
    EXCEPTIONS
      canceled_in_corr         = 01
      enqueued_by_user         = 03
      enqueue_system_failure   = 04
      illegal_parameter_values = 05
      locked_by_author         = 06
      no_modify_permission     = 07
      no_show_permission       = 08
      permission_failure       = 02. "not try to show an object

  IF sy-subrc <> 0.
    CLEAR extend_mod.

      CLEAR: progname,
             programm,
             l_inclname,
             l_trdir.

      MESSAGE e398(00) WITH
           'Provide program name with valid customer namespace'(049).
      LEAVE LIST-PROCESSING.
    ENDIF.


  ENDFORM.                    " AUTHORITIES_AND_CORR

*Text symbol text
*000:Selection criteria
*001:Program Category
*002:Program Application
*003:Program Description, Project ID and Incident Number
*004:Additional Data
*005:* Variable declaration for Select-Option:
*006:Do you want to choose a report category?
*007:Do you want to continue?
*008:Enter BAPI name for posting
*009:Enter Transaction Code for Batch input
*010:Enter Idoc Type for Outbound
*011:Enter Idoc Type for Inbound
*012:Please supply a 2 Character Application area
*013:Display Option
*014:Please enter a complete
*015:Extended program description
*016:- When complete, hit the Save icon
*017:Please Choose a LDB Node
*018:Please Enter LDB Name
*019:Upload Filepath
*020:Download Filepath
*021:App. Server Directory
*022:Transaction
*023:Filepath
*024:App.Server Directory
*025:Filepath
*026:could not be created
*027:Program created successfully. Please remember to:
*028:1. Set Maximum line length to 72 Chars in editor settings
*029:2. Perform TEXT ELEMENT analysis in the Text Pool editor
*02A:HR
*02B:Others
*02D:Batch Input
*02E:Local File Upload
*02G:Program Name(Optional)
*02H:Local File Download
*02I:App Server File Upload
*02J:App Server File Download
*02K:MM
*02L:SD
*02M:FI
*02N:Package
*02O:WB Request/Task
*02P:Transaction Code
*02Q:Program ID
*02R:Incident Number
*02S:Program Description
*02T:Report
*02U:Interface
*02V:Conversion
*02W:Post data using BAPI
*02X:BAPI Name
*02Y:Transaction Code
*02Z:Function Module
*030:created successfully
*031:Create xxxxxxxx
*032:will be created.
*033:Program
*034:ALV List
*035:ALV Grid
*036:and populate the output table
*037:Extended Description of Program
*038:ALV Display Variant
*039:Call Function 'REUSE_ALV_VARIANT_DEFAULT_GET'
*03A:Logical Database
*03D:LDB Nodes
*03E:Infotypes
*03F:*$*$ GET Events for Logical Database
*03G:*$*$   Tables/Nodes (for use with Logical Databases)
*03H:*$*$   Infotypes (for use with Logical Databases)
*040:Global Variable
*041:Local Variable
*042:Parameters
*043:Select-Options
*044:Report Category
*045:Yes
*046:No
*047:for combination validation
*048:Information
*049:Provide program name with valid customer namespace
*050:'No data selected from table'(e03)
*051:Radio-Button
*052:Check Box
*056:'Invalid data combination from table'(e01)
*058:Internal table
*059:Type
*060:Range Table
*061:Structure
*062:Constants
*063:WorkArea
*064:Recipient Partner Type
*065:Recipient Partner
*066:Basic  Type
*067:Sender Partner Type
*068:Sender Partner
*069:Sender Port
*070:Posting with IDOC
*071:Message Type
*072:Output Information
*073:Create outbound IDOC
*077:Subroutine
*080:ALV Report
*096:Recipient Port
*098:Call Function 'BAPI_TRANSACTION_COMMIT'.
*100:*$*$--------------------------------------------------------------------
*101:*$*$ Object Name:
*102:*$*$ Author:
*103:*$*$ Date:
*104:*$*$ Copyright:
*105:*$*$
*106:*$*$ Logical Database:
*107:*$*$ SAPScript name:
*108:*$*$ Application Area:
*109:*$*$ Description:
*110:*$*$ Transport Number:
*111:*$*$ Development ID#:
*112:*$*$ Incident Number:
*113:*$*$ Purpose:
*114:*$*$ Correction #
*115:*$*$ Modified By
*116:*$*$ Date
*117:*$*$ Transport Number
*118:Selection-Screen data
*119:File path
*120:'Incorrect entry for'(e02)
*121:'
*127:               Using 'Company code description'
*128:                     'prog short description'
*129:                     'prog description'.
*130:CALL FUNCTION 'REUSE_ALV_COMMENTARY_WRITE'
*131:Select Local File
*132:Please enter File name for uploading screen fields
*134:Extended Description
*140:*$*$ TOP OF PAGE Event
*141:*$*$ END OF PAGE Event
*152:Program Naming Standards
*159:*$*$ INITIALIZATION Event
*160:*$*$ Include programs
*161:Table Type
*162:Reference
*163:Table Name - Field Name
*164:Data Elements
*165:
*AS1:*$*$  AT SELECTION SCREEN ON Event
*AS3:*$*$  AT SELECTION SCREEN Event
*C00:* Parameter:
*C01:*$*$   Constants
*C02:* Select Options:
*C03:* Radio Button:
*C04:*Insert BDC session for the failed record
*C05:* Check Box:
*C06:*Close the BDC session
*C07:*$*$ Validate
*C08:* Check for initial value before validating
*C09:* Select
*C10:* Stop processing and issue error message in case of error
*C11:*$*$ F4 help on Screen field
*C12:* Read data from table
*C13:*$*$ Validate Data Combination from table
*C14:* Select data from
*C15:* Call BAPI to post the data
*C16:* Populate data into final output internal table
*C17:* Constants list for file delimiters
*C18:* Constants for Call Transaction Input and Update method
*C19:* Constants for ALV Events declaration
*C20:* Constants for yes Flag
*C21:* Structure for storing final output data
*C22:***enter the structure fields here
*C23:* Structure for storing File data
*C24:* Structure for select from table
*C25:* Table type for output data
*C26:* Table type for File data
*C27:* Table type for structure
*C28:* Parameter Table used in BAPI
*C29:* Batch input data table type
*C30:* Table type for BDC Call transaction messages
*C31:* Table type  for IDoc Control record
*C32:* Table type for Idoc Data record
*C33:* Create IDoc to post inbound data
*C34:* Table type for Idoc status record
*C35:* Table type for Error
*C36:* Table Type for data from FM
*C37:* Perform selects and populate internal tables
*C38:* Call FM to retrieve the data
*C39:* Create Outbound IDocs
*C40:* Internal table for output data
*C41:* Internal table for File data
*C42:* Internal table for data from table
*C43:* Check output table is not empty before continuing
*C44:* Batch input data internal table
*C45:* Internal table for BDC Call transaction messages
*C46:* Internal table for ALV Field Catalog
*C47:* Internal table for ALV field Sort Catalog
*C48:* Internal table for ALV Field Events
*C49:* Internal table for ALV Header declarations
*C50:* Internal table for IDoc Control record
*C51:* Internal table for Idoc Data record
*C52:* Write Application Server File
*C53:* Internal table for Idoc status record
*C54:* Error Internal table
*C55:* Table for data from FM
*C56:* Call function module for retrieving the necessary data
*C57:* Check if the call is successful
*C58:* Note: The output table should have all type C fields before
*C59:* Work area for output data
*C60:* Work area for File data
*C61:* Work area for structure
*C62:* Work area for BAPI parameter tables
*C63:* Work area for BAPI exporting parameter:
*C64:* Work area for BAPI importing parameter:
*C65:* Batch input data work area
*C66:* Work Area for BDC Call transaction messages
*C67:* Work area for FM parameter tables
*C68:* Work area for FM exporting parameter:
*C69:* Work area for FM importing parameter:
*C70:* Check the existence of Variant
*C71:* Get default variant for ALV
*C72:* Subroutine for Top of Page event.
*C73:* perform top_of_page.
*C74:* Subroutine for End of Page event.
*C75:* perform end_of_page.
*C76:* Read presentation server file
*C77:* Check for any errors before processing further
*C78:* Read Application Server File
*C79:* Work area for ALV Field layout
*C80:* Work area for Variant data for ALV
*C81:* Work Area for Idoc Control record
*C82:* Work Area for Idoc Data record for outbound
*C83:* Work Area for Idoc Data record for inbound
*C84:* Error Work area
*C85:* Work area for IDoc Segment:
*C86:* Variable for BAPI exporting parameter:
*C87:* Variable for BAPI importing parameter:
*C88:* Variable for storing file name
*C89:* IDoc number
*C90:* Variable for FM exporting parameter:
*C91:* Variable for FM importing parameter:
*C92:* Process the internal table table
*C93:* Populate the final output table for display
*C94:*Populate the BDC data table for Call Transaction
*C95:*  Perform bdcdynpro tables i_bdcdata using prog_name screen_no.
*C96:*  Perform bdcfield  tables i_bdcdata using fieldname fieldval.
*C97:*Call transaction using the i_bdcdata table
*C98:*Check for any errors and create BDC session
*C99:*Open a BDC session for the failed record
*CA0:* downloading with separators
*CA1:* Write Presentation Server File
*CA2:* Call BAPI function module for posting the final data
*CA3:* Commit transaction if the BAPI call is successful
*CA4:* Populate the Control Record for IDoc
*CA5:* Populate IDoc Data Record for posting inbound data
*CA6:* Create inbound IDoc for posting data
*CA7:* Populate IDoc Data Record for posting outbound data
*CA8:* Create Outbound IDoc
*CA9:* Add IDoc data table with fields from segment
*CB0:***Map your segments fields here
*CB1:* Display the report output using ALV
*CB2:* Write the final report depending on error or success
*CB3:* Write Report Header
*CB4:* Write Error Report
*CB5:* Else write the report data
*CB6:* If no ALV output is required
*CB7:******* Add your own custom message here for display
*CB8:* Prepare layout for the ALV display
*CB9:* Prepare Event table for the ALV display
*CC0:* Prepare field catalog for the ALV display
*CC1:* Display report output
*CC2:* Call the ALV function module for header top of page
*CC3:** Write the logic for any End of Page display here
*CC4:* Select data from table
*CC5:*Check that the table used for For All Entries is not empty
*CC6:* Issue error message if the select fails
*CC7:* Sort table for use in Binary search later
*CC8:* GET event for node
*CC9:for validation
*D00:*$*$   Data Declarations
*D02:*$*$   Types
*D03:*$*$   Internal Tables
*D04:*$*$   Workareas
*D05:*$*$   Variables
*D06:*$*$   Flags
*D07:*$*$   Table Types
*ES1:*$*$  END OF SELECTION Event
*S00:*$*$ Selection criteria
*SS1:*$*$ START OF SELECTION Event
