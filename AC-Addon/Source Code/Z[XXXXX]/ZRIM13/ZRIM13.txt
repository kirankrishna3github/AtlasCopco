*&---------------------------------------------------------------------*
*& Report  ZRIM13                                                      *
*&                                                                     *
*&---------------------------------------------------------------------*
*&                                                                     *
*&                                                                     *
*&---------------------------------------------------------------------*

REPORT  ZRIM13                                  .
TYPE-POOLS ALMB.

DATA:   BDCDATA LIKE BDCDATA    OCCURS 0 WITH HEADER LINE.
DATA:   MESSTAB LIKE BDCMSGCOLL OCCURS 0 WITH HEADER LINE.

* Internal tables for storing all data
DATA: GS_VBAK TYPE VBAK.
DATA: LS_VIQMEL TYPE VIQMEL.
DATA: BEGIN OF GI_PARTNERS OCCURS 0,
        VBELN LIKE VBPA-VBELN,
        POSNR LIKE VBPA-POSNR,
        PARVW LIKE VBPA-PARVW,
        KUNNR LIKE VBPA-KUNNR,
      END OF GI_PARTNERS.
DATA: IT_VBAP TYPE VBAP OCCURS 0 WITH HEADER LINE.
DATA: IT_T399A TYPE T399A OCCURS 0 WITH HEADER LINE.

DATA: IT_PLKO TYPE PLKO OCCURS 0 WITH HEADER LINE.
DATA: IT_PLAS TYPE PLAS OCCURS 0 WITH HEADER LINE.
DATA: IT_PLPO TYPE PLPO OCCURS 0 WITH HEADER LINE.
DATA: IT_PLMZ TYPE PLMZ OCCURS 0 WITH HEADER LINE.
DATA: IT_STPO TYPE STPO OCCURS 0 WITH HEADER LINE.
DATA: IT_CRHD TYPE CRHD OCCURS 0 WITH HEADER LINE.


DATA: BEGIN OF IT_SERV_MATNR OCCURS 0,
        WERKS LIKE T001W-WERKS,
        SVOBJ LIKE T399A-SVOBJ,
      END OF IT_SERV_MATNR.

DATA LT_METHODS      TYPE BAPI_ALM_ORDER_METHOD_T.
DATA LS_METHODS      TYPE BAPI_ALM_ORDER_METHOD.
DATA LT_HEADER              TYPE TABLE OF BAPI_ALM_ORDER_HEADERS_I.
DATA LS_HEADER              TYPE BAPI_ALM_ORDER_HEADERS_I.
DATA LT_HEADER_UP           TYPE TABLE OF BAPI_ALM_ORDER_HEADERS_UP.
DATA LS_HEADER_UP           TYPE BAPI_ALM_ORDER_HEADERS_UP.
DATA LT_HEADER_SRV          TYPE TABLE OF BAPI_ALM_ORDER_SRVDAT_E.
DATA LS_HEADER_SRV          TYPE BAPI_ALM_ORDER_SRVDAT_E.
DATA LT_HEADER_SRV_UP       TYPE TABLE OF BAPI_ALM_ORDER_SRVDAT_UP.
DATA LS_HEADER_SRV_UP       TYPE BAPI_ALM_ORDER_SRVDAT_UP.
* Userstatus
DATA LT_USERSTATUS    TYPE ALMB_USERSTATUS.
DATA LS_USERSTATUS    TYPE BAPI_ALM_ORDER_USRSTAT.
* Partner
DATA LT_PARTNER       TYPE ALMB_PARTNER_TAB.
DATA LS_PARTNER       TYPE BAPI_ALM_ORDER_PARTN_MUL.
DATA LT_PARTNER_UP    TYPE ALMB_PARTNER_UP_TAB.
DATA LS_PARTNER_UP    TYPE BAPI_ALM_ORDER_PARTN_MUL_UP.
* Operations
DATA LT_OPERATIONS    TYPE BAPI_ALM_ORDER_OPERATION_T.
DATA LS_OPERATIONS    TYPE BAPI_ALM_ORDER_OPERATION.
DATA LT_OPERATIONS_UP TYPE BAPI_ALM_ORDER_OPERATION_UT.
DATA LS_OPERATIONS_UP TYPE BAPI_ALM_ORDER_OPERATION_UP.
* Components
DATA LT_COMPONENTS    TYPE BAPI_ALM_ORDER_COMPONENT_T.
DATA LS_COMPONENTS    TYPE BAPI_ALM_ORDER_COMPONENT.
DATA LT_COMPONENTS_UP TYPE BAPI_ALM_ORDER_COMPONENT_UT.
DATA LS_COMPONENTS_UP TYPE BAPI_ALM_ORDER_COMPONENT_UP.
* Return
DATA LT_RETURN TYPE STANDARD TABLE OF BAPIRET2.
* Order numbers
DATA LS_NUMBERS       TYPE BAPI_ALM_NUMBERS.
DATA LT_NUMBERS       TYPE BAPI_ALM_NUMBERS_T.

DATA: GV_ITEMKEY(4) TYPE N.
DATA: GV_NEW_AUFNR TYPE AUFNR.

DATA: CAUFVD LIKE CAUFVD.
DATA: BEGIN OF IT_RIWOL OCCURS 0.
        INCLUDE STRUCTURE RIWOL.
DATA: END OF IT_RIWOL.



PARAMETERS: P_VBELN LIKE VBAK-VBELN OBLIGATORY,
            P_QMNUM TYPE QMNUM.

START-OF-SELECTION.

* 0. Get needed data.
* 0a. Headerdata from the sales order.
  SELECT SINGLE * FROM VBAK INTO GS_VBAK
                    WHERE VBELN = P_VBELN.
  SELECT * FROM VBAP INTO TABLE IT_VBAP
                    WHERE VBELN = P_VBELN.

* 0b. Notification data
  CALL FUNCTION 'READ_NOTIFICATION'
    EXPORTING
*   FEKNZ                = 'X'
*   MAKNZ                = 'X'
*   MSGTY                = 'E'
      QMNUM                = GS_VBAK-QMNUM
*   I_DELETE             =
*   I_NOBUFFER           =
*   I_VIQMEL             =
*   IV_AKTYP             =
    IMPORTING
*   IBAUTX               =
*   IEQKT                =
*   INDABSCHL            =
*   IPLTXT               =
      IVIQMEL              = LS_VIQMEL
*   IRIWO02              =
*   ERIWO03              =
*   E_QMTYP              =
*   INDLOEVM             =
*   INDMARC              =
*   FLGSER               =
* TABLES
*   IVIQMFE              =
*   IVIQMMA              =
*   IVIQMSM              =
*   IVIQMUR              =
*   TRIWO020TAB          =
    EXCEPTIONS
      INVALID_NUMBER       = 1
      OTHERS               = 2
            .
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.



* 0c. Get partner data from the sales order.
  SELECT VBELN POSNR PARVW KUNNR INTO TABLE GI_PARTNERS
                          FROM VBPA
                         WHERE VBELN = P_VBELN.


* 1. Fill in the Method.
* 1a. Header.
  LS_METHODS-REFNUMBER  = '1'.
  LS_METHODS-OBJECTTYPE = 'HEADER'.
  LS_METHODS-METHOD     = 'CREATE'.
  LS_METHODS-OBJECTKEY  = '%00000000001'.
  APPEND LS_METHODS TO LT_METHODS.
* 1b. Partner
*  LS_METHODS-OBJECTTYPE = 'PARTNER'.
*  APPEND LS_METHODS TO LT_METHODS.
* 1c. Operation => Filled in later!.
*  LS_METHODS-OBJECTTYPE = 'OPERATION'.
*  LS_METHODS-OBJECTKEY  = '%000000000010010'.
*  APPEND LS_METHODS TO LT_METHODS.
* 1d. Components => Filled in later!.
* LS_METHODS-OBJECTTYPE = 'COMPONENT'.
* LS_METHODS-OBJECTKEY  = '%00000000001'.
* APPEND LS_METHODS TO LT_METHODS.

* 2. Fill in the Header
  LS_HEADER-ORDERID       = '%00000000001'.
  LS_HEADER_UP-ORDERID    = '%00000000001'.
  LS_HEADER-ORDER_TYPE    = 'ZAM1'.
  LS_HEADER-PLANPLANT     = LS_VIQMEL-IWERK.
* Get work center
  SELECT SINGLE ARBPL INTO LS_HEADER-MN_WK_CTR
                      FROM CRHD
                     WHERE OBJTY = LS_VIQMEL-CROBJTY
                       AND OBJID = LS_VIQMEL-ARBPL.
*   ls_header-MN_WK_CTR     = ls_viqmel-ARBPL.
  LS_HEADER_UP-MN_WK_CTR  = 'X'.
  LS_HEADER-PLANT         = LS_VIQMEL-ARBPLWERK.
  LS_HEADER_UP-PLANT      = 'X'.
  LS_HEADER-FUNCT_LOC     = LS_VIQMEL-TPLNR.
  LS_HEADER_UP-FUNCT_LOC  = 'X'.
  LS_HEADER-EQUIPMENT     = LS_VIQMEL-EQUNR.
  LS_HEADER_UP-EQUIPMENT  = 'X'.
  LS_HEADER-SERIALNO      = LS_VIQMEL-SERIALNR.
  LS_HEADER_UP-SERIALNO   = 'X'.
*  ls_header-MATERIAL      =
  LS_HEADER-SALES_ORD     = LS_VIQMEL-VBELN.
  LS_HEADER_UP-SALES_ORD  = 'X'.
  LS_HEADER-S_ORD_ITEM    = '000010'.
  LS_HEADER_UP-S_ORD_ITEM = 'X'.
* Following data comes from the original notification.
* - Start - and enddate fied
*  LS_HEADER-START_DATE    = LS_VIQMEL-STRMN.
*  LS_HEADER_UP-START_DATE = 'X'.
*  LS_HEADER-FINISH_DATE   = LS_VIQMEL-LTRMN.
*  LS_HEADER_UP-FINISH_DATE = 'X'.
* - Priority
  LS_HEADER-PRIORITY      = LS_VIQMEL-PRIOK.
  LS_HEADER_UP-PRIORITY   = 'X'.
* - Planner group
  LS_HEADER-PLANGROUP     = LS_VIQMEL-INGRP.
  LS_HEADER_UP-PLANGROUP  = 'X'.
* - Accounting indicator
*   240107: Derivation still needs to be specified.
  LS_HEADER-CALC_MOTIVE   = '1E'.           " Temporarily hardcoded
  LS_HEADER_UP-CALC_MOTIVE = 'X'.

*  ls_header-PMACTTYPE     =
*  ls_header-              =
*  ls_header-              =
*
  APPEND LS_HEADER TO LT_HEADER.
  APPEND LS_HEADER_UP TO LT_HEADER_UP.

* 3. Fill in the partners.
*  LOOP AT GI_PARTNERS WHERE VBELN = P_VBELN.
*    CHECK NOT GI_PARTNERS-KUNNR IS INITIAL.
*    LS_PARTNER-ORDERID    = '%00000000001'.
*    LS_PARTNER-PARTN_ROLE = GI_PARTNERS-PARVW.
*    LS_PARTNER-PARTNER    = GI_PARTNERS-KUNNR.
*    APPEND LS_PARTNER TO LT_PARTNER.
*  ENDLOOP.
*  LS_PARTNER_UP-ORDERID = '%00000000001'.
*  LS_PARTNER_UP-PARTN_ROLE = 'X'.
*  LS_PARTNER_UP-PARTNER = 'X'.
*  APPEND LS_PARTNER_UP TO LT_PARTNER_UP.

* 4. Fill in the operations.
* 4a. Get the task list for the material of the sales order.
  LOOP AT IT_VBAP.
    IT_SERV_MATNR-SVOBJ = IT_VBAP-MATNR.
    IT_SERV_MATNR-WERKS = IT_VBAP-WERKS.
    APPEND IT_SERV_MATNR.
  ENDLOOP.
  BREAK AIR21775.
  SELECT * FROM T399A INTO TABLE IT_T399A
                 FOR ALL ENTRIES IN IT_SERV_MATNR
               WHERE IWERK = IT_SERV_MATNR-WERKS
                 AND SVOBJ_ID = '01'
                 AND SVOBJ = IT_SERV_MATNR-SVOBJ.
* 4b. get the operations.
  SELECT * FROM PLKO INTO TABLE IT_PLKO
                 FOR ALL ENTRIES IN IT_T399A
               WHERE PLNTY = IT_T399A-PLNTY
                 AND PLNNR = IT_T399A-STDNR
                 AND PLNAL = IT_T399A-STDAL.
  SELECT * FROM PLAS INTO TABLE IT_PLAS
                 FOR ALL ENTRIES IN IT_PLKO
               WHERE PLNTY = IT_PLKO-PLNTY
                 AND PLNNR = IT_PLKO-PLNNR
                 AND PLNAL = IT_PLKO-PLNAL.
  SELECT * FROM PLPO INTO TABLE IT_PLPO
                 FOR ALL ENTRIES IN IT_PLAS
               WHERE PLNTY = IT_PLAS-PLNTY
                 AND PLNNR = IT_PLAS-PLNNR
                 AND PLNKN = IT_PLAS-PLNKN
                 AND ZAEHL = IT_PLAS-ZAEHL.
*                 and plnal = it_plko-STDAL.
  SELECT * FROM CRHD INTO TABLE IT_CRHD
                 FOR ALL ENTRIES IN IT_PLPO
               WHERE OBJTY = IT_PLPO-OBJTY
                 AND OBJID = IT_PLPO-ARBID.
*  LS_OPERATIONS
  READ TABLE IT_T399A INDEX 1.
*  gv_itemkey = '0010'.
  CLEAR  LS_METHODS-REFNUMBER.

  LOOP AT IT_PLPO.
* 1c. Add operation to the methods-table.
    LS_METHODS-REFNUMBER  = LS_METHODS-REFNUMBER + 1.
    LS_METHODS-OBJECTTYPE = 'OPERATION'.
    GV_ITEMKEY = GV_ITEMKEY + 10.
    CONCATENATE '%00000000001' GV_ITEMKEY INTO LS_METHODS-OBJECTKEY.
*    LS_METHODS-OBJECTKEY  = '%000000000010010'.
    LS_METHODS-METHOD     = 'CREATE'.
    APPEND LS_METHODS TO LT_METHODS.
* Continue with the operation.
    LS_OPERATIONS-ACTIVITY = IT_PLPO-VORNR.
    LS_OPERATIONS-CONTROL_KEY = IT_PLPO-STEUS.
*    IF LS_OPERATIONS-CONTROL_KEY IS INITIAL.
    READ TABLE IT_CRHD WITH KEY OBJTY = IT_PLPO-OBJTY
                                OBJID = IT_PLPO-ARBID.
    IF SY-SUBRC EQ 0.
      LS_OPERATIONS-WORK_CNTR = IT_CRHD-ARBPL.
      IF LS_OPERATIONS-CONTROL_KEY IS INITIAL.
        MOVE IT_CRHD-STEUS TO LS_OPERATIONS-CONTROL_KEY.
      ENDIF.
    ENDIF.
*    ENDIF.
*    IT_CRHD-ARBPL
*    LS_OPERATIONS-WORK_CNTR = IT_T399A-VAPLZ.
    LS_OPERATIONS-PLANT = IT_PLPO-WERKS.
    LS_OPERATIONS-DESCRIPTION = IT_PLPO-LTXA1.
    LS_OPERATIONS-CURRENCY = IT_PLPO-WAERS.
    LS_OPERATIONS-PURCH_ORG = IT_PLPO-EKORG.
    LS_OPERATIONS-PUR_GROUP = IT_PLPO-EKGRP.
    LS_OPERATIONS-DURATION_NORMAL = IT_PLPO-DAUNO.
    LS_OPERATIONS-DURATION_NORMAL_UNIT = IT_PLPO-DAUNE.
    LS_OPERATIONS-WORK_ACTIVITY = IT_PLPO-ARBEI.
    LS_OPERATIONS-UN_WORK = IT_PLPO-ARBEH.
    LS_OPERATIONS-CALC_KEY = IT_PLPO-INDET.
    LS_OPERATIONS-ACTTYPE = IT_PLPO-LARNT.
*    LS_OPERATIONS-EXECFACTOR =
*    LS_OPERATIONS-MRP_RELEVANT =
*    LS_OPERATIONS-
*    LS_OPERATIONS-
    APPEND LS_OPERATIONS TO LT_OPERATIONS.
  ENDLOOP.
  SORT LT_OPERATIONS.

  LS_OPERATIONS_UP-ACTIVITY = 'X'.
  LS_OPERATIONS_UP-CONTROL_KEY = 'X'.
  LS_OPERATIONS_UP-WORK_CNTR = 'X'.
  LS_OPERATIONS_UP-PLANT = 'X'.
  LS_OPERATIONS_UP-DESCRIPTION = 'X'.
  LS_OPERATIONS_UP-CURRENCY = 'X'.
  LS_OPERATIONS_UP-PURCH_ORG = 'X'.
  LS_OPERATIONS_UP-PUR_GROUP = 'X'.
  LS_OPERATIONS_UP-DURATION_NORMAL = 'X'.
  LS_OPERATIONS_UP-DURATION_NORMAL_UNIT = 'X'.

  LS_OPERATIONS_UP-WORK_ACTIVITY =  'X'.
  LS_OPERATIONS_UP-UN_WORK =  'X'.
  LS_OPERATIONS_UP-CALC_KEY = 'X'.
  LS_OPERATIONS_UP-ACTTYPE = 'X'.

  APPEND LS_OPERATIONS_UP TO LT_OPERATIONS_UP.
*  ENDLOOP.
*  SORT LT_OPERATIONS.

* 5. Get the components
  SELECT * FROM PLMZ INTO TABLE IT_PLMZ
                 FOR ALL ENTRIES IN IT_PLKO
               WHERE PLNTY = IT_PLKO-PLNTY
                 AND PLNNR = IT_PLKO-PLNNR
                 AND PLNAL = IT_PLKO-PLNAL.
  SELECT * FROM STPO INTO TABLE IT_STPO
                 FOR ALL ENTRIES IN IT_PLMZ
               WHERE STLTY = IT_PLMZ-STLTY
                 AND STLNR = IT_PLMZ-STLNR
                 AND STLKN = IT_PLMZ-STLKN.
* 1d. Components
  LS_METHODS-REFNUMBER  = '1'.
  LS_METHODS-OBJECTTYPE = 'COMPONENT'.
  LS_METHODS-OBJECTKEY  = '%00000000001'.
  LS_METHODS-METHOD     = 'CREATE'.
  APPEND LS_METHODS TO LT_METHODS.

  LOOP AT IT_STPO.
    LS_COMPONENTS-MATERIAL = IT_STPO-IDNRK.
*    LS_COMPONENTS-plant    = IT_STPO-
    LS_COMPONENTS-REQUIREMENT_QUANTITY      = IT_STPO-MENGE.
    LS_COMPONENTS-REQUIREMENT_QUANTITY_UNIT = IT_STPO-MEINS.
    READ TABLE IT_PLMZ WITH KEY STLTY = IT_STPO-STLTY
                                STLNR = IT_STPO-STLNR
                                STLKN = IT_STPO-STLKN.
    READ TABLE IT_PLKO WITH KEY PLNTY = IT_PLMZ-PLNTY
                                PLNNR = IT_PLMZ-PLNNR
                                PLNAL = IT_PLMZ-PLNAL.
    READ TABLE IT_PLAS WITH KEY PLNTY = IT_PLKO-PLNTY
                                PLNNR = IT_PLKO-PLNNR
                                PLNAL = IT_PLKO-PLNAL.
    READ TABLE IT_PLPO WITH KEY PLNTY = IT_PLAS-PLNTY
                                PLNNR = IT_PLAS-PLNNR
                                PLNKN = IT_PLAS-PLNKN
                                ZAEHL = IT_PLAS-ZAEHL.



    LS_COMPONENTS-ACTIVITY = IT_PLPO-VORNR.
*    LS_COMPONENTS-

    APPEND LS_COMPONENTS TO LT_COMPONENTS.
  ENDLOOP.
  SORT LT_COMPONENTS.

  LS_COMPONENTS_UP-MATERIAL = 'X'.
  LS_COMPONENTS_UP-REQUIREMENT_QUANTITY      = 'X'.
  LS_COMPONENTS_UP-REQUIREMENT_QUANTITY_UNIT = 'X'.

  APPEND LS_COMPONENTS_UP TO LT_COMPONENTS_UP.
  BREAK AIR21775.
  BREAK AIR22187.

* 1e. Add SAVE-statement to the Methods.
  CLEAR LS_METHODS.
  LS_METHODS-METHOD     = 'SAVE'.
*   LS_METHODS-METHOD     = 'DIALOG'.
  APPEND LS_METHODS TO LT_METHODS.

  SET PARAMETER ID 'IQM' FIELD P_QMNUM.


  CALL FUNCTION 'BAPI_ALM_ORDER_MAINTAIN'
    TABLES
      IT_METHODS             = LT_METHODS
      IT_HEADER              = LT_HEADER
      IT_HEADER_UP           = LT_HEADER_UP
*     IT_HEADER_SRV          = LT_HEADER_SRV
*     IT_HEADER_SRV_UP       = LT_HEADER_SRV_UP
*     IT_USERSTATUS          = LT_USERSTATUS
*      IT_PARTNER             = LT_PARTNER
*      IT_PARTNER_UP          = LT_PARTNER_UP
      IT_OPERATION           = LT_OPERATIONS
      IT_OPERATION_UP        = LT_OPERATIONS_UP
*   IT_RELATION            =
*   IT_RELATION_UP         =
     IT_COMPONENT           = LT_COMPONENTS
     IT_COMPONENT_UP        = LT_COMPONENTS_UP
*   IT_TEXT                =
*   IT_TEXT_LINES          =
*   EXTENSION_IN           =
    RETURN                 = LT_RETURN
    ET_NUMBERS             = LT_NUMBERS
            .

  BREAK AIR21775.

  BREAK AIR22187.

  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*   EXPORTING
*     WAIT          =
*   IMPORTING
*     RETURN        =
            .
**************************************************
*  EXIT.
**************************************************


  READ TABLE LT_NUMBERS INTO LS_NUMBERS INDEX 1.
  MOVE LS_NUMBERS-AUFNR_NEW TO GV_NEW_AUFNR.

* II. Assign service order to the notification.

  SELECT SINGLE * INTO CORRESPONDING FIELDS OF CAUFVD
                  FROM CAUFV
                 WHERE AUFNR = GV_NEW_AUFNR.
  IT_RIWOL-IHNUM = GS_VBAK-QMNUM.
  APPEND IT_RIWOL.

  CALL FUNCTION 'IWOL_ADD_NOTIF_TO_DDB_INT'
    EXPORTING
      I_CAUFVD                  = CAUFVD
    TABLES
      T_RIWOL                   = IT_RIWOL
* EXCEPTIONS
*   NOTIFICATION_EXISTS       = 1
*   OTHERS                    = 2
            .
  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*   EXPORTING
*     WAIT          =
*   IMPORTING
*     RETURN        =
            .

* III. Vice versa: assign the notification to the service order.

  PERFORM BDC_DYNPRO      USING 'SAPLCOIH' '0101'.
  PERFORM BDC_FIELD       USING 'BDC_CURSOR'
                                'CAUFVD-AUFNR'.
  PERFORM BDC_FIELD       USING 'BDC_OKCODE'
                                '/00'.
  PERFORM BDC_FIELD       USING 'CAUFVD-AUFNR'
                                GV_NEW_AUFNR.

  PERFORM BDC_DYNPRO      USING 'SAPLCOIH' '3000'.
  PERFORM BDC_FIELD       USING 'BDC_OKCODE'
                                '=IOLU'.

  PERFORM BDC_DYNPRO      USING 'SAPLCOIH' '3000'.
  PERFORM BDC_FIELD       USING 'BDC_OKCODE'
                                '=IHAD'.
  PERFORM BDC_FIELD       USING 'BDC_CURSOR'
                                'RIWOL-BEARB(01)'.
  PERFORM BDC_FIELD       USING 'RIWOL0-SELEC(01)'
                                'X'.

  PERFORM BDC_DYNPRO      USING 'SAPLCOIH' '3000'.
  PERFORM BDC_FIELD       USING 'BDC_OKCODE'
                                '=BU'.
  PERFORM BDC_FIELD       USING 'BDC_CURSOR'
                                'CAUFVD-KTEXT'.
  PERFORM BDC_TRANSACTION USING 'IW32'.




*----------------------------------------------------------------------*
*        Start new screen                                              *
*----------------------------------------------------------------------*
FORM BDC_DYNPRO USING PROGRAM DYNPRO.
  CLEAR BDCDATA.
  BDCDATA-PROGRAM  = PROGRAM.
  BDCDATA-DYNPRO   = DYNPRO.
  BDCDATA-DYNBEGIN = 'X'.
  APPEND BDCDATA.
ENDFORM.                    "BDC_DYNPRO

*----------------------------------------------------------------------*
*        Insert field                                                  *
*----------------------------------------------------------------------*
FORM BDC_FIELD USING FNAM FVAL.
*  IF FVAL <> NODATA.
  CLEAR BDCDATA.
  BDCDATA-FNAM = FNAM.
  BDCDATA-FVAL = FVAL.
  APPEND BDCDATA.
*  ENDIF.
ENDFORM.                    "BDC_FIELD
*----------------------------------------------------------------------*
*        Start new transaction according to parameters                 *
*----------------------------------------------------------------------*

FORM BDC_TRANSACTION USING TCODE.
* batch input session
*  CALL FUNCTION 'BDC_INSERT'
*    EXPORTING
*      TCODE     = TCODE
*    TABLES
*      DYNPROTAB = BDCDATA.
  CALL TRANSACTION TCODE USING BDCDATA
             MODE   'N'
             UPDATE 'S'
             MESSAGES INTO MESSTAB.


  REFRESH BDCDATA.
ENDFORM.                    "BDC_TRANSACTION

*Selection text£º
*P_QMNUM:D       Notification
*P_VBELN:D       Sales document
