*&---------------------------------------------------------------------*
*&  Include           ZERO2MASTER_ANDA_08B_FUNC
*&---------------------------------------------------------------------*
FORM f_08b.
  DATA: lv_objtype TYPE char1,
        lt_steps   TYPE STANDARD TABLE OF char600,
        lt_keysour TYPE STANDARD TABLE OF char600,
        ls_list    TYPE char600.


  CASE gc_x.
    WHEN 08b1_rb1.
      lv_objtype = 'P'.
    WHEN 08b1_rb2.
      lv_objtype = 'F'.
    WHEN 08b1_rb3.
      lv_objtype = 'C'.
    WHEN OTHERS.
  ENDCASE.
  IF 08b1_cb1 IS INITIAL.
    CLEAR: 08b1_p0.
  ENDIF.

*  CALL METHOD ycl_cwu_utility=>count_step_08b
*    EXPORTING
*      iv_object_type     = lv_objtype
*      iv_username        = 08b1_p0
*      it_objectid        = 08b1_p1[]
*      iv_fileout         = 08b3_rb2
*      iv_filename        = 08b4_p1
*      iv_onlyyz          = gc_x
*      iv_max_objects     = 08b5_p1
*      iv_nocount_blank   = 08b2_cb1
*      iv_nocount_include = 08b2_cb2
*      iv_nocount_declare = 08b2_cb3
*      iv_fullline        = 08b4_cb1
*      iv_comtline        = 08b4_cb2
*      iv_procline        = 08b4_cb3
*      pv_dosearch        = 08b2_cb4
*      pv_keyword         = 08b2_p1
*      iv_codepage        = '8400'
*    IMPORTING
*      et_steps           = lt_steps
*      et_keysource       = lt_keysour.

  PERFORM count_step_08b
    TABLES  lt_steps
            lt_keysour
            08b1_p1[]
    USING   lv_objtype
            08b1_p0
            08b3_rb2
            08b4_p1
            gc_x
            08b5_p1
            08b2_cb1
            08b2_cb2
            08b2_cb3
            08b4_cb1
            08b4_cb2
            08b4_cb3
            08b2_cb4
            08b2_p1
            '8400'.

  IF lt_steps IS INITIAL.
    MESSAGE i001(00) WITH 'No objects found.'.
  ENDIF.

  IF 08b3_rb3 IS NOT INITIAL.
    IF    08b2_cb4 IS NOT INITIAL
      AND lt_keysour IS NOT INITIAL.
      LOOP AT lt_keysour  INTO ls_list.
        IF sy-tabix = 1.
          WRITE ls_list.
          ULINE.
        ELSE.
          CLEAR: lv_str1 , lv_str2.
          SPLIT ls_list AT cl_abap_char_utilities=>horizontal_tab
            INTO lv_str1 lv_str2.
          CONDENSE: lv_str1, lv_str2.
          WRITE: /(120) sy-uline.
          WRITE: / sy-vline, 3 lv_str1, 37 sy-vline,
                 40 lv_str2, 120 sy-vline.
        ENDIF.
      ENDLOOP.
      WRITE: /(120) sy-uline.
    ENDIF.
  ELSEIF 08b3_rb1 IS NOT INITIAL.
    LOOP AT lt_steps INTO ls_list.
      CLEAR: lv_str1, lv_str2,lv_str3,lv_str4,
             lv_str5, lv_str6,lv_str7.
      SPLIT ls_list AT  '","'
        INTO lv_str1 lv_str2 lv_str3 lv_str4
             lv_str5  lv_str6 lv_str7.
      REPLACE ALL OCCURRENCES OF '"' IN: lv_str1 WITH '',
      lv_str2 WITH space,lv_str3 WITH space,lv_str4 WITH space,
      lv_str5 WITH space,lv_str6 WITH space,lv_str7 WITH space.
      REPLACE ALL OCCURRENCES OF ',' IN lv_str7 WITH space.
      CONDENSE: lv_str1,lv_str2,lv_str3,lv_str4,
                lv_str5,lv_str6,lv_str7.
      IF lv_str1 IS INITIAL.
        CONTINUE.
      ENDIF.
      IF sy-tabix = 1.
        WRITE: /(150) sy-uline.
      ENDIF.
      WRITE: / sy-vline, lv_str1 NO-GAP, 30 sy-vline,
             lv_str2 NO-GAP,45 sy-vline , lv_str3 NO-GAP,
             60 sy-vline, lv_str4 NO-GAP,
             78 sy-vline, lv_str5 NO-GAP, 96 sy-vline,
             lv_str6 NO-GAP,110 sy-vline, 112(150) lv_str7 NO-GAP,
             150 sy-vline.
      WRITE: /(150) sy-uline.
    ENDLOOP.

  ENDIF.
ENDFORM.                    "f_08b
*&---------------------------------------------------------------------*
*&      Form  COUNT_STEP_08B
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ET_STEPS  text
*      -->P_ET_KEYSOURCE  text
*      -->PV_OBJECT_TYPE  text
*      -->PV_USERNAME  text
*      -->P_IT_OBJECTID  text
*      -->PV_FILEOUT  text
*      -->PV_FILENAME  text
*      -->PV_ONLYYZ  text
*      -->PV_MAX_OBJECTS  text
*      -->PV_NOCOUNT_BLANK  text
*      -->PV_NOCOUNT_INCLUDE  text
*      -->PV_NOCOUNT_DECLARE  text
*      -->PV_FULLLINE  text
*      -->PV_COMTLINE  text
*      -->PV_PROCLINE  text
*      -->PV_DOSEARCH  text
*      -->PV_KEYWORD  text
*      -->PV_CODEPAGE  text
*----------------------------------------------------------------------*
FORM count_step_08b  TABLES   pt_steps
                              pt_keysource
                              pt_objectid
                     USING    pv_object_type
                              pv_username
                              pv_fileout
                              pv_filename
                              pv_onlyyz
                              pv_max_objects
                              pv_nocount_blank
                              pv_nocount_include
                              pv_nocount_declare
                              pv_fullline
                              pv_comtline
                              pv_procline
                              pv_dosearch
                              pv_keyword
                              pv_codepage.
  DATA: lv_program_lines TYPE i,
        lv_filename      TYPE string.

  lv_filename  = pv_filename.

  REFRESH: gt_txdir_08b,gt_program_08b,gt_source_file_08b,gt_steps_08b.
  CLEAR:  gv_folder_08b,
          gv_onlyyz_08b,
          gv_objtype_08b,
          gv_obj_lines_08b,
          gv_codepage_08b.
  gt_fgroup_08b = 'X'.
  gv_onlymain_08b = 'X'.
  gv_onlyyz_08b = pv_onlyyz.
  gv_objtype_08b = pv_object_type.

*  CALL METHOD ycl_cwu_utility=>gen_objectlist_sub1_08b
*    EXPORTING
*      iv_objectid = pt_objectid
*      iv_username = pv_username.

  PERFORM gen_objectlist_sub1_08b
    TABLES pt_objectid
    USING pv_username.

  DESCRIBE TABLE gt_txdir_08b LINES lv_program_lines.
  CHECK lv_program_lines <> 0.
  IF  lv_program_lines > pv_max_objects.
    MESSAGE e001(00) WITH 'The maxiumn object is '(8b1) pv_max_objects
      'While current entries is '(8b2) gv_obj_lines_08b.
  ELSE.
*    select *
*      FROM D020S
*      into TABLE mt_D020S
*      FOR ALL ENTRIES IN gt_txdir_08b
*      WHERE PROG = gt_txdir_08b.
  ENDIF.

*  set_proglist_sub2_08b
*  CALL METHOD ycl_cwu_utility=>gen_proglist_sub2_08b
*    EXPORTING
*      pv_nocount_include = iv_nocount_include.

  PERFORM gen_proglist_sub2_08b
    USING pv_nocount_include.

*  Generate program line and count the step
*  CALL METHOD ycl_cwu_utility=>stepcount_sub3_08b
*    EXPORTING
*      iv_nocount_blank   = iv_nocount_blank
*      iv_nocount_include = iv_nocount_include
*      iv_nocount_declare = iv_nocount_declare
*      pv_dosearch        = pv_dosearch
*      pv_keyword         = pv_keyword
*    IMPORTING
*      et_keysource       = et_keysource.

  PERFORM stepcount_sub3_08b
    TABLES pt_keysource
    USING   pv_nocount_blank
            pv_nocount_include
            pv_nocount_declare
            pv_dosearch
            pv_keyword.

* prepare the folder and codepage for download
*  CALL METHOD ycl_cwu_utility=>perpare_download_sub4_08b
*    EXPORTING
*      iv_codepage = iv_codepage
*    IMPORTING
*      et_steps    = et_steps
*    CHANGING
*      iv_filename = lv_filename.

  PERFORM perpare_download_sub4_08b
    TABLES pt_steps
    USING pv_codepage
    CHANGING lv_filename.

  APPEND LINES OF pt_steps TO gt_steps_08b.
* Download file to local PC
  IF pv_fileout IS NOT INITIAL.
*    CHECK SY-UNAME <> 'SSCEXTCWU'.
*    CALL METHOD ycl_cwu_utility=>download_code_sub5_08b
*      EXPORTING
*        iv_filename = lv_filename
*        iv_fullline = iv_fullline
*        iv_comtline = iv_comtline
*        iv_procline = iv_procline.

    PERFORM download_code_sub5_08b
      USING lv_filename
            pv_fullline
            pv_comtline
            pv_procline.

  ENDIF.
ENDFORM.                    " COUNT_STEP_08B
*&---------------------------------------------------------------------*
*&      Form  GEN_OBJECTLIST_SUB1_08B
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PT_OBJECTID  text
*      -->P_PV_USERNAME  text
*----------------------------------------------------------------------*
FORM gen_objectlist_sub1_08b  TABLES pt_objectid
                              USING  pv_username.
  DATA: s_progid  TYPE RANGE OF char40,
        lv_progid LIKE LINE OF s_progid,
        lv_posi   TYPE i,
        lv_lines  TYPE i.

  DATA: ls_objectid TYPE ty_s_objectid,
        ls_txdir    TYPE  ty_s_txdir,
        lt_d020t    TYPE STANDARD TABLE OF d020t,
        ls_d020t    TYPE d020t.

  DATA: lt_trdir      TYPE STANDARD TABLE OF trdir,
        lt_tfdir      TYPE STANDARD TABLE OF tfdir,
        lt_vseoclass  TYPE STANDARD TABLE OF vseoclass,
        ls_vseoclass  TYPE vseoclass,
        ls_tfdir      TYPE tfdir,
        ls_trdir      TYPE trdir.

  APPEND LINES OF pt_objectid TO s_progid.

  lv_progid-sign = 'I'.
  lv_progid-option = 'EQ'.
** Append objects to object list once username is not initial
  IF pv_username IS NOT INITIAL.
    CASE gv_objtype_08b.
      WHEN 'P'.
        IF pv_username = '*'.
          SELECT *
            INTO CORRESPONDING FIELDS OF TABLE lt_trdir
            FROM trdir
           WHERE  subc = '1'.    "Executable
        ELSE.
          SELECT *
          INTO CORRESPONDING FIELDS OF TABLE lt_trdir
          FROM trdir
         WHERE ( cnam = pv_username OR unam = pv_username )
           AND subc = '1'.    "Executable
        ENDIF.

        IF sy-subrc = 0.
          LOOP AT lt_trdir INTO ls_trdir.
            IF gv_onlyyz_08b IS NOT INITIAL.
              IF  NOT ( ( ls_trdir-name(1) = 'Y' )
                  OR ( ls_trdir-name(1) = 'Z' ) ).
                CONTINUE.
              ENDIF.
            ENDIF.
            CLEAR: lv_progid-low.
            lv_progid-low =  ls_trdir-name.
            APPEND lv_progid TO s_progid.
          ENDLOOP.
        ENDIF.
      WHEN 'F'.
        IF pv_username = '*'.
          SELECT *
            INTO CORRESPONDING FIELDS OF TABLE lt_tfdir
            FROM tfdir INNER JOIN trdir
            ON tfdir~pname = trdir~name
            WHERE (    trdir~cnam <> 'SAP'
                  AND  trdir~unam <> 'SAP' ).
        ELSE.
          SELECT *
          INTO CORRESPONDING FIELDS OF TABLE lt_tfdir
          FROM tfdir
          INNER JOIN trdir
            ON tfdir~pname = trdir~name
          WHERE (   trdir~cnam = pv_username
                  OR trdir~unam = pv_username ).
        ENDIF.

        IF sy-subrc = 0.
          LOOP AT lt_tfdir INTO ls_tfdir.
            IF gv_onlyyz_08b IS NOT INITIAL.
              IF  NOT ( ls_tfdir-funcname(1) = 'Y'
                  OR ls_tfdir-funcname(1) = 'Z' ).
                CONTINUE.
              ENDIF.
            ENDIF.
            CLEAR: lv_progid-low.
            lv_progid-low =  ls_tfdir-funcname.
            APPEND lv_progid TO s_progid.
          ENDLOOP.
        ENDIF.
      WHEN 'C'.
        IF pv_username = '*'.
          SELECT *
            INTO CORRESPONDING FIELDS OF TABLE lt_vseoclass
            FROM vseoclass
            WHERE author <> 'SAP'.
        ELSE.
          SELECT *
          INTO CORRESPONDING FIELDS OF TABLE lt_vseoclass
          FROM vseoclass
          WHERE author =    pv_username
            OR  changedby = pv_username .
        ENDIF.
        IF sy-subrc = 0.
          LOOP AT lt_vseoclass INTO ls_vseoclass.
            IF gv_onlyyz_08b IS NOT INITIAL.
              IF  NOT ( ls_vseoclass-clsname(1) = 'Y'
                  OR ls_vseoclass-clsname(1) = 'Z' ).
                CONTINUE.
              ENDIF.
            ENDIF.
            CLEAR: lv_progid-low.
            lv_progid-low =  ls_vseoclass-clsname.
            APPEND lv_progid TO s_progid.
          ENDLOOP.
        ENDIF.
      WHEN OTHERS.
    ENDCASE.
  ENDIF.
  SORT s_progid.
  DELETE ADJACENT DUPLICATES FROM s_progid.
  DESCRIBE TABLE s_progid LINES gv_obj_lines_08b.
  CHECK s_progid IS NOT INITIAL.
  REFRESH: lt_trdir,gt_txdir_08b.
* Prepare program list
  CASE gv_objtype_08b.
    WHEN 'P'.
      IF gv_onlymain_08b IS INITIAL.
        SELECT *
          INTO CORRESPONDING FIELDS OF TABLE lt_trdir
          FROM trdir
          WHERE name IN s_progid.
      ELSE.
        SELECT *
          INTO CORRESPONDING FIELDS OF TABLE lt_trdir
          FROM trdir
          WHERE name IN s_progid
            AND subc = '1'.
      ENDIF.
      CHECK lt_trdir IS NOT INITIAL.
      LOOP AT lt_trdir INTO ls_trdir.
        ls_txdir-flag       = gv_objtype_08b.
        CLEAR ls_txdir-funcname.
        ls_txdir-pname    = ls_trdir-name.
        CLEAR ls_txdir-clsname.
        APPEND ls_txdir TO gt_txdir_08b.

      ENDLOOP.
    WHEN 'F'.
      SELECT  funcname
              pname
        INTO CORRESPONDING FIELDS OF TABLE gt_txdir_08b
        FROM tfdir
        INNER JOIN trdir
        ON tfdir~pname = trdir~name
        WHERE funcname IN s_progid.
      LOOP AT gt_txdir_08b  INTO ls_txdir.
        ls_txdir-flag = 'F'.
        MODIFY gt_txdir_08b FROM ls_txdir.
      ENDLOOP.
    WHEN 'C'.
      SELECT *
        INTO TABLE lt_trdir
        FROM trdir
        WHERE occurs = ' '
           AND dbapl = 'S'
           AND appl = 'S'.
      DELETE lt_trdir WHERE  cnam  = 'SAP'
                          OR unam  = 'SAP'.
      LOOP AT lt_trdir INTO ls_trdir.
        CLEAR: lv_posi,ls_txdir.
        FIND '=' IN ls_trdir-name MATCH OFFSET lv_posi.
        IF sy-subrc <> 0.
          CONTINUE.
        ELSE.
          IF ls_trdir-name(lv_posi) NOT IN s_progid.
            CONTINUE.
          ELSE.
            ls_txdir-flag    = 'C'.
            ls_txdir-pname   = ls_trdir-name.
            ls_txdir-clsname = ls_trdir-name(lv_posi).
            APPEND ls_txdir TO gt_txdir_08b.
          ENDIF.
        ENDIF.
      ENDLOOP.
    WHEN OTHERS.
  ENDCASE.
ENDFORM.                    " GEN_OBJECTLIST_SUB1_08B
*&---------------------------------------------------------------------*
*&      Form  GEN_PROGLIST_SUB2_08B
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PV_NOCOUNT_INCLUDE  text
*----------------------------------------------------------------------*
FORM gen_proglist_sub2_08b  USING    pv_nocount_include.
  DATA: ls_txdir    TYPE ty_s_txdir,
        ls_program  TYPE ty_s_program,
        lt_d020t    TYPE STANDARD TABLE OF d020t,
        ls_d020t    TYPE d020t.

  DATA: lt_includes TYPE STANDARD TABLE OF char40,
        ls_includes TYPE char40,
        lv_cnt      TYPE i,
        lv_funcname TYPE rs38l-name,    "Program Name
        lv_includes TYPE rs38l-include,
        lv_group    TYPE rs38l-area.

*  gt_program_08b
  CASE gv_objtype_08b.
    WHEN 'P'.
      LOOP AT gt_txdir_08b INTO ls_txdir.
        CLEAR: ls_program.
        ls_program-mainprogram = ls_txdir-pname.
        ls_program-name        = ls_txdir-pname.
        ls_program-mainflg     = 'X'.
        APPEND ls_program TO gt_program_08b.
        IF pv_nocount_include IS INITIAL.
*  -------Get include programs
          CALL FUNCTION 'RS_GET_ALL_INCLUDES'
            EXPORTING
              program      = ls_txdir-pname
            TABLES
              includetab   = lt_includes
            EXCEPTIONS
              not_existent = 1
              no_program   = 2
              OTHERS       = 3.

          LOOP AT lt_includes INTO ls_includes.
            CLEAR ls_program.
            ls_program-mainprogram = ls_txdir-pname.
            ls_program-name        = ls_includes.
            APPEND ls_program TO gt_program_08b.
          ENDLOOP.

*  *******Get dynpro program
          SELECT *
            INTO CORRESPONDING FIELDS OF TABLE lt_d020t
            FROM d020t
            WHERE prog =  ls_txdir-pname
              AND dynr <> '1000'
              AND lang =  sy-langu.

          LOOP AT lt_d020t INTO ls_d020t.
            CLEAR ls_program.
            ls_program-mainprogram = ls_txdir-pname.
            ls_program-name        = ls_d020t-prog.
            ls_program-dynr        = ls_d020t-dynr.
            APPEND ls_program TO gt_program_08b.
          ENDLOOP.
        ENDIF.
      ENDLOOP.
    WHEN 'F'.
      LOOP AT gt_txdir_08b INTO ls_txdir.
        CLEAR: lv_includes,
               lv_group,
               ls_program.
*  -----Function module[FUNCTION_INCLUDE_INFO]
        CALL FUNCTION 'FUNCTION_INCLUDE_INFO'
          CHANGING
            funcname            = ls_txdir-funcname
            include             = lv_includes
            group               = lv_group
          EXCEPTIONS
            function_not_exists = 1
            include_not_exists  = 2
            group_not_exists    = 3
            no_selections       = 4
            no_function_include = 5
            OTHERS              = 6.

        CLEAR ls_program.
        ls_program-mainprogram = ls_txdir-funcname.
        ls_program-name        = lv_includes.
        ls_program-funcname    = ls_txdir-funcname.
        ls_program-group       = lv_group.
        ls_program-mainflg     = 'X'.
        APPEND ls_program TO gt_program_08b.

        IF pv_nocount_include IS INITIAL.
          CLEAR ls_program.
          ls_program-mainprogram = ls_txdir-funcname.
          ls_program-name        = ls_txdir-pname.
          ls_program-group       = lv_group.
          APPEND ls_program TO gt_program_08b.

*  -----Function module[RS_GET_ALL_INCLUDES]
          CALL FUNCTION 'RS_GET_ALL_INCLUDES'
            EXPORTING
              program      = ls_txdir-pname
            TABLES
              includetab   = lt_includes
            EXCEPTIONS
              not_existent = 1
              no_program   = 2
              OTHERS       = 3.

          LOOP AT lt_includes INTO ls_includes.
            CLEAR: lv_funcname.
*  ---------Function module[FUNCTION_INCLUDE_INFO]
            CALL FUNCTION 'FUNCTION_INCLUDE_INFO'
              CHANGING
                funcname            = lv_funcname
                include             = ls_includes
*                group               = lv_group_tmp
              EXCEPTIONS
                function_not_exists = 1
                include_not_exists  = 2
                group_not_exists    = 3
                no_selections       = 4
                no_function_include = 5
                OTHERS              = 6.

            IF lv_funcname IS INITIAL.
              CLEAR ls_program.
              ls_program-mainprogram = ls_txdir-funcname.
              ls_program-name        = ls_includes.
              ls_program-group       = lv_group.
              APPEND ls_program TO gt_program_08b.
            ELSE.
              CONTINUE.
            ENDIF.
          ENDLOOP.
        ENDIF.

*  *******Get dynpro program
        SELECT *
          INTO CORRESPONDING FIELDS OF TABLE lt_d020t
          FROM d020t
          WHERE prog =  ls_txdir-pname
            AND dynr <> '1000'
            AND lang =  sy-langu.

        LOOP AT lt_d020t INTO ls_d020t.
          CLEAR ls_program.
          ls_program-mainprogram = ls_txdir-funcname.
          ls_program-name        = ls_d020t-prog.
          ls_program-dynr        = ls_d020t-dynr.
          ls_program-group       = lv_group.
          APPEND ls_program TO gt_program_08b.
        ENDLOOP.
      ENDLOOP.
    WHEN 'C'.
      DATA: lv_pname TYPE rs38l-include.
      LOOP AT gt_txdir_08b INTO ls_txdir.
        CLEAR: ls_program.
        ls_program-mainprogram = ls_txdir-clsname.
        ls_program-name        = ls_txdir-pname.
        lv_pname = ls_txdir-pname.
        SHIFT lv_pname BY 2 PLACES RIGHT CIRCULAR.
        IF lv_pname(2) = 'CU'.
          ls_program-mainflg     = 'X'.
        ELSE.
          CLEAR: ls_program-mainflg .
        ENDIF.

        ls_program-clsname     = ls_txdir-clsname.
        APPEND ls_program TO gt_program_08b.
      ENDLOOP.
    WHEN OTHERS.
  ENDCASE.
ENDFORM.                    " GEN_PROGLIST_SUB2_08B
*&---------------------------------------------------------------------*
*&      Form  STEPCOUNT_SUB3_08B
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PT_KEYSOURCE  text
*      -->P_PV_NOCOUNT_BLANK  text
*      -->P_PV_NOCOUNT_INCLUDE  text
*      -->P_PV_NOCOUNT_DECLARE  text
*      -->P_PV_DOSEARCH  text
*      -->P_PV_KEYWORD  text
*----------------------------------------------------------------------*
FORM stepcount_sub3_08b  TABLES   pt_keysource
                         USING    pv_nocount_blank
                                  pv_nocount_include
                                  pv_nocount_declare
                                  pv_dosearch
                                  pv_keyword.
  DATA: ls_program TYPE ty_s_program,
        lt_line    TYPE ty_t_line255,
        ls_line    TYPE ty_s_line255,
        ls_file    TYPE ty_s_progline.
*-TEXTPOOL
  DATA: ls_textpool TYPE textpool,
        lt_textpool TYPE TABLE OF textpool.

  DATA: ls_d020s TYPE d020s,
        ls_d021s TYPE d021s,
        ls_d022s TYPE d022s,
        ls_d023s TYPE d023s,
        lt_d021s TYPE TABLE OF d021s,
        lt_d022s TYPE TABLE OF d022s,
        lt_d023s TYPE TABLE OF d023s.

  DATA: lv_dynpro_prog(44) TYPE c,
        lv_lineno(6)        TYPE n,
        lv_totalstep(6)    TYPE p,
        lv_commentstep(6)  TYPE p,
        lv_processstep(6)  TYPE p,
        lv_spacestep(6)    TYPE p,
        lv_datastep(6)     TYPE p,
        lv_column          TYPE i,
        lv_column_text(1)  TYPE c,
        lv_str1            TYPE char255,
        lv_str2            TYPE char255,
        l_flg_con(1)          TYPE c,
        lv_com1(20)        TYPE c,
        lv_com2(20)        TYPE c,
        l_flg_do(1)           TYPE c,
        l_flg_val(1)          TYPE c,
        lflag_end          TYPE char1,
        lflag_decl         TYPE char1,
        lflag_first        TYPE char1,
        lv_line            TYPE i,
        lv_off             TYPE i,
        lv_off1             TYPE i,
        lv_off2             TYPE i,
        lv_match_char       TYPE char1 VALUE '''',
        l_flg_cmt(1)        TYPE c,
        lv_index            TYPE char10,
        ls_keysource        TYPE string.

  LOOP AT gt_program_08b INTO ls_program.

    CLEAR: lv_totalstep,
           lv_commentstep,
           lv_spacestep,
           lv_datastep,
           lv_lineno.

    IF ls_program-dynr = ''.
      READ REPORT ls_program-name INTO lt_line.
    ELSE.
      CLEAR: ls_d020s,
             lt_d021s,
             lt_d022s,
             lt_d023s,
             lv_dynpro_prog.

      lv_dynpro_prog       = ls_program-name.
      lv_dynpro_prog+40(4) = ls_program-dynr.

      IMPORT DYNPRO ls_d020s lt_d021s lt_d022s lt_d023s
             ID lv_dynpro_prog.

      IF sy-subrc = 0.
        lt_line[] = lt_d022s[].
      ENDIF.
    ENDIF.

*   Gain total lines
    DESCRIBE TABLE lt_line LINES lv_totalstep.

    LOOP AT lt_line INTO ls_line.
      CLEAR ls_file.
      lv_lineno = lv_lineno + 1.
      ls_file-name   = ls_program-name.
      ls_file-dynr   = ls_program-dynr.
      ls_file-mainp  = ls_program-mainprogram.
      ls_file-source = ls_line.
      ls_file-group  = ls_program-group.
      ls_file-funcname = ls_program-funcname.
      ls_file-clsname  = ls_program-clsname.
      ls_file-lineno = lv_lineno.

      IF ls_line = ' '.
        ADD 1 TO lv_commentstep.
        ADD 1 TO lv_spacestep.
        ls_file-commentflg = 'X'.
        APPEND ls_file TO gt_source_file_08b.
        CONTINUE.
      ELSE.
        IF lflag_first = 'A'.
          lflag_first = 'B'.
        ELSEIF lflag_first IS INITIAL.
          lflag_first = 'A'.
        ENDIF.
      ENDIF.
      IF pv_dosearch IS NOT INITIAL AND pv_keyword IS NOT INITIAL.
        FIND FIRST OCCURRENCE OF REGEX pv_keyword
          IN ls_line-line.
        IF sy-subrc = 0.
          CLEAR: ls_keysource, lv_index.
          lv_index = sy-tabix.
          CONCATENATE ls_program-name
                      cl_abap_char_utilities=>horizontal_tab
                      ls_line
                      '['
                      lv_index
                      ']'
          INTO  ls_keysource.
          APPEND ls_keysource TO pt_keysource.
        ENDIF.
      ENDIF.
      SHIFT ls_line LEFT DELETING LEADING space.
      IF ls_line(1) = '*' OR ls_line(1) = '"'.
        ADD 1 TO lv_commentstep.
        ls_file-commentflg = 'X'.
        APPEND ls_file TO gt_source_file_08b.
        CONTINUE.
      ELSE.
        IF lflag_first = 'A'.
          lflag_first = 'B'.
        ELSE.
          lflag_first = 'A'.
        ENDIF.
      ENDIF.

      IF lflag_end IS NOT INITIAL OR lflag_first = 'A'.
        SPLIT ls_line AT space INTO lv_com1
                                    lv_com2.
        CLEAR: lv_off.
        FIND ':' IN lv_com1 MATCH OFFSET lv_off.
        IF sy-subrc = 0.
          lv_com1 = lv_com1(lv_off).
        ENDIF.
        CASE lv_com1.
          WHEN 'REPORT'
            OR 'TYPES'
            OR 'DATA'
            OR 'CONSTANTS'
            OR 'INCLUDE'
            OR 'TABLES'
            OR 'RANGES'
            OR 'CONTROLS'
            OR 'TYPE-POOLS'
            OR 'FIELD-SYMBOLS'.

            ADD 1 TO lv_datastep.
            ls_file-commentflg = 'X'.
            lflag_decl = 'X'.
        ENDCASE.
      ENDIF.

      IF lflag_end IS INITIAL AND lflag_decl IS NOT INITIAL.
        ADD 1 TO lv_datastep.
        ls_file-commentflg = 'X'.
      ENDIF.

      CLEAR: lv_off.
      lv_str1 = ls_line.
      FIND FIRST OCCURRENCE OF '"' IN lv_str1 MATCH OFFSET lv_off.
      IF sy-subrc = 0.
        lv_str1+lv_off = space.
        CONDENSE lv_str1.
      ENDIF.

      CLEAR: lv_off1.
      FIND FIRST OCCURRENCE OF lv_match_char IN lv_str1 MATCH OFFSET lv_off1.
      IF sy-subrc = 0.
        lv_str1+lv_off1(1) = space.
        WHILE sy-subrc = 0.
          FIND FIRST OCCURRENCE OF lv_match_char IN lv_str1 MATCH OFFSET lv_off2.
          lv_str1+lv_off2(1) = 'X'.
        ENDWHILE.
      ENDIF.

      CLEAR: lv_off.
      lv_line   = STRLEN( lv_str1 ).
      lv_off =  lv_line - 1.
      IF lv_str1+lv_off(1) = '.'.
        lflag_end  = 'X'.
        CLEAR lflag_decl.
      ELSE.
        CLEAR: lflag_end .
      ENDIF.

      APPEND ls_file TO gt_source_file_08b.
    ENDLOOP.

    IF pv_nocount_blank = 'X'.
      ls_program-totalstep   = lv_totalstep - lv_spacestep.
      ls_program-processstep = lv_totalstep - lv_commentstep.
      ls_program-commentstep = lv_commentstep - lv_spacestep.
    ELSE.
      ls_program-totalstep   = lv_totalstep.
      ls_program-processstep = lv_totalstep - lv_commentstep.
      ls_program-commentstep = lv_commentstep.
    ENDIF.

    IF pv_nocount_declare = 'X'.
      ls_program-processstep = ls_program-processstep - lv_datastep.
      ls_program-commentstep = ls_program-commentstep + lv_datastep.
    ENDIF.

    MODIFY gt_program_08b FROM ls_program.

    ls_file-name   = ls_program-name.
    ls_file-dynr   = ls_program-dynr.
    ls_file-commentflg = 'X'.

    CLEAR: ls_textpool.
    REFRESH lt_textpool.

    READ TEXTPOOL ls_program-name INTO lt_textpool LANGUAGE sy-langu.
    SORT lt_textpool BY id key.

*   List header: Column headings
    READ TABLE lt_textpool TRANSPORTING NO FIELDS WITH KEY id = 'H'.
    IF sy-subrc = 0.
      CLEAR:  ls_file-source.
      APPEND ls_file TO gt_source_file_08b.
      ls_file-lineno = ls_file-lineno + 1.
      ls_file-source =  '*List header: Column headings£º'(t60).
      APPEND ls_file TO gt_source_file_08b.

      CLEAR ls_textpool.
      LOOP AT lt_textpool INTO ls_textpool WHERE id = 'H'.
        CLEAR:  ls_file-source.
        ls_file-lineno = ls_file-lineno + 1.
        CONCATENATE '* ' ls_textpool-key ':' ls_textpool-entry
         INTO ls_file-source.
        APPEND ls_file TO gt_source_file_08b.
      ENDLOOP.
    ENDIF.

*   Text symbol text
    READ TABLE lt_textpool TRANSPORTING NO FIELDS WITH KEY id = 'I'.
    IF sy-subrc = 0.
      CLEAR:  ls_file-source.
      APPEND ls_file TO gt_source_file_08b.
      ls_file-lineno = ls_file-lineno + 1.
      ls_file-source =  '*Text symbol text£º'(t61).
      APPEND ls_file TO gt_source_file_08b.

      CLEAR ls_textpool.
      LOOP AT lt_textpool INTO ls_textpool WHERE id = 'I'.
        CLEAR:  ls_file-source.
        ls_file-lineno = ls_file-lineno + 1.
        CONCATENATE '* ' ls_textpool-key ':' ls_textpool-entry
         INTO ls_file-source.
        APPEND ls_file TO gt_source_file_08b.
      ENDLOOP.
    ENDIF.

*   Selection text
    READ TABLE lt_textpool TRANSPORTING NO FIELDS WITH KEY id = 'S'.
    IF sy-subrc = 0.
      CLEAR:  ls_file-source.
      APPEND ls_file TO gt_source_file_08b.
      ls_file-lineno = ls_file-lineno + 1.
      ls_file-source =  '*Selection text£º'(t62).
      APPEND ls_file TO gt_source_file_08b.

      CLEAR ls_textpool.
      LOOP AT lt_textpool INTO ls_textpool WHERE id = 'S'.
        CLEAR:  ls_file-source.
        ls_file-lineno = ls_file-lineno + 1.
        CONCATENATE '* ' ls_textpool-key ':' ls_textpool-entry
         INTO ls_file-source.
        APPEND ls_file TO gt_source_file_08b.
      ENDLOOP.
    ENDIF.

*   List Title: Titlebar
    READ TABLE lt_textpool TRANSPORTING NO FIELDS WITH KEY id = 'T'.
    IF sy-subrc = 0.
      CLEAR:  ls_file-source.
      APPEND ls_file TO gt_source_file_08b.
      ls_file-lineno = ls_file-lineno + 1.
      ls_file-source =  '*List Title: Titlebar£º'(t63).
      APPEND ls_file TO gt_source_file_08b.

      CLEAR ls_textpool.
      LOOP AT lt_textpool INTO ls_textpool WHERE id = 'T'.
        CLEAR:  ls_file-source.
        ls_file-lineno = ls_file-lineno + 1.
        CONCATENATE '* ' ls_textpool-key ':' ls_textpool-entry
         INTO ls_file-source.
        APPEND ls_file TO gt_source_file_08b.
      ENDLOOP.
    ENDIF.

  ENDLOOP.

  IF pt_keysource IS NOT INITIAL.
    CLEAR: ls_keysource.
    CONCATENATE 'The keyword' pv_keyword 'is used in below programs'
      INTO ls_keysource SEPARATED BY space.
    INSERT ls_keysource INTO pt_keysource INDEX 1.
  ENDIF.
ENDFORM.                    " STEPCOUNT_SUB3_08B
*&---------------------------------------------------------------------*
*&      Form  PERPARE_DOWNLOAD_SUB4_08B
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PT_STEPS  text
*      -->P_PV_CODEPAGE  text
*      <--P_LV_FILENAME  text
*----------------------------------------------------------------------*
FORM perpare_download_sub4_08b  TABLES   pt_steps
                                USING    pv_codepage
                                CHANGING pv_filename.

  TYPES: BEGIN OF lty_cmethod_text,
          clsname      TYPE vseoattrib-clsname,
          cmpname      TYPE vseoattrib-cmpname,
          descript     TYPE vseoattrib-descript,
          program      TYPE programm,
         END OF lty_cmethod_text.
  DATA: lt_vseoattr TYPE STANDARD TABLE OF lty_cmethod_text,
        ls_vseoattr TYPE  lty_cmethod_text.
  DATA: lv_path        TYPE filep,
        lv_file        TYPE filep,
        ls_program     TYPE ty_s_program,
        ls_program_tmp TYPE ty_s_program,
        ls_steps       TYPE ty_s_csvline,
        lv_sep         VALUE ',',
        ls_seocpdkey   TYPE seocpdkey,
        lv_string      TYPE string.

  DATA: lv_percent(3)          TYPE p,
        lv_programinfo(60)     TYPE c,
        lv_totalstep_bk(6)     TYPE p,
        lv_processstep_bk(6)   TYPE p,
        lv_commentstep_bk(6)   TYPE p,
        lv_percent_unit(5)     TYPE c.

  DATA: lv_dynr_c(4)           TYPE c,
        lv_totalstep_c(6)      TYPE c,
        lv_processstep_c(6)    TYPE c,
        lv_commentstep_c(6)    TYPE c,
        lv_percent_c(3)        TYPE c,
        lv_totalstep_bk_c(6)   TYPE c,
        lv_processstep_bk_c(6) TYPE c,
        lv_commentstep_bk_c(6) TYPE c,
        l_rec_textpool TYPE textpool,
        lt_textpool TYPE TABLE OF textpool.
* Set the codepage
  IF pv_codepage IS NOT INITIAL.
    gv_codepage_08b = pv_codepage.
  ELSE.
    CALL FUNCTION 'NLS_GET_FRONTEND_CP'
      EXPORTING
        langu                 = sy-langu
      IMPORTING
        frontend_codepage     = gv_codepage_08b
      EXCEPTIONS
        illegal_syst_codepage = 1
        no_frontend_cp_found  = 2
        internal_or_db_error  = 3
        OTHERS                = 4.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ENDIF.

* set the folder name
  CALL FUNCTION 'TRINT_SPLIT_FILE_AND_PATH'
    EXPORTING
      full_name     = pv_filename
    IMPORTING
      stripped_name = lv_file
      file_path     = lv_path
    EXCEPTIONS
      x_error       = 1
      OTHERS        = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  IF lv_path IS  NOT INITIAL.
    gv_folder_08b = lv_path.
    IF NOT lv_file IS INITIAL.
      IF NOT lv_file CS '.'.
        CONCATENATE pv_filename '.csv' INTO pv_filename.
      ENDIF.
    ELSE.
      pv_filename = 'C:\Sourcesteps.csv'.
    ENDIF.
  ENDIF.
  CASE gv_objtype_08b.
    WHEN 'F'.
      "N/A
    WHEN 'C'.
      SELECT *
        FROM vseomethod
        INTO CORRESPONDING FIELDS OF TABLE lt_vseoattr
        FOR ALL ENTRIES IN gt_program_08b
        WHERE clsname = gt_program_08b-clsname.
      CLEAR: ls_seocpdkey.
      LOOP AT lt_vseoattr INTO ls_vseoattr.
        ls_seocpdkey-clsname  = ls_vseoattr-clsname.
        ls_seocpdkey-cpdname  = ls_vseoattr-cmpname.
        CALL FUNCTION 'SEO_METHOD_GET_SOURCE'
          EXPORTING
            mtdkey                        = ls_seocpdkey
          IMPORTING
            incname                       = ls_vseoattr-program
          EXCEPTIONS
            _internal_method_not_existing = 1
            _internal_class_not_existing  = 2
            version_not_existing          = 3
            inactive_new                  = 4
            inactive_deleted              = 5
            OTHERS                        = 6.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
        MODIFY  lt_vseoattr FROM ls_vseoattr.
      ENDLOOP.
    WHEN OTHERS.
  ENDCASE.
  LOOP AT gt_program_08b INTO ls_program.
    ls_program_tmp = ls_program.
    AT NEW mainprogram.
*-Head
      CONCATENATE '"[Program ID]"'       lv_sep
                  '"[Dynpro No.]"'       lv_sep
                  '"[Total Lines]"'     lv_sep
                  '"[Process Lines]"'     lv_sep
                  '"[Comment Lines]"'     lv_sep
                  '"[Percentage]"'        lv_sep
                  '"[Title]"'              lv_sep
                  INTO ls_steps.
      APPEND ls_steps TO pt_steps.
    ENDAT.

    lv_percent = ls_program-commentstep / ls_program-totalstep * 100.

    IF ls_program-dynr <> ''.
      SELECT SINGLE dtxt
        INTO lv_programinfo
        FROM d020t
       WHERE prog = ls_program-name
         AND dynr = ls_program-dynr
         AND lang = sy-langu.
    ELSE.
      READ TEXTPOOL ls_program-name
        INTO lt_textpool LANGUAGE sy-langu.
      CLEAR l_rec_textpool.
      READ TABLE lt_textpool
        WITH KEY id = 'R' INTO l_rec_textpool.
      lv_programinfo = l_rec_textpool-entry.
    ENDIF.
    CASE gv_objtype_08b.
      WHEN 'F'.
        IF ls_program_tmp-mainflg IS NOT INITIAL.
          SELECT SINGLE stext
            INTO lv_programinfo
            FROM tftit
            WHERE funcname = ls_program_tmp-funcname.
        ENDIF.
      WHEN 'C'.
        CLEAR: ls_vseoattr.
        READ TABLE lt_vseoattr INTO ls_vseoattr
          WITH KEY program = ls_program_tmp-name.
        IF sy-subrc = 0.
          lv_programinfo = ls_vseoattr-descript.
        ENDIF.
      WHEN OTHERS.
    ENDCASE.
    IF ls_program-dynr  IS NOT INITIAL.
      WRITE ls_program-dynr        TO lv_dynr_c.
    ELSE.
      lv_dynr_c = 'N/A'.
    ENDIF.

    WRITE ls_program-totalstep   TO lv_totalstep_c.
    WRITE ls_program-processstep TO lv_processstep_c.
    WRITE ls_program-commentstep TO lv_commentstep_c.
    WRITE lv_percent             TO lv_percent_c.

    CONCATENATE lv_percent_c '%' INTO lv_percent_unit SEPARATED BY space.

    CLEAR ls_steps.
    CONCATENATE '"' ls_program-name  '"' lv_sep
                '"' lv_dynr_c        '"' lv_sep
                '"' lv_totalstep_c   '"' lv_sep
                '"' lv_processstep_c '"' lv_sep
                '"' lv_commentstep_c '"' lv_sep
                '"' lv_percent_unit  '"' lv_sep
                '"' lv_programinfo   '"' lv_sep
                INTO ls_steps.
    APPEND ls_steps TO pt_steps.

    lv_totalstep_bk   = lv_totalstep_bk   + ls_program-totalstep.
    lv_processstep_bk = lv_processstep_bk + ls_program-processstep.
    lv_commentstep_bk = lv_commentstep_bk + ls_program-commentstep.

    AT END OF mainprogram.

*     Gain present
      lv_percent = lv_commentstep_bk / lv_totalstep_bk * 100.

      WRITE lv_totalstep_bk   TO lv_totalstep_bk_c.
      WRITE lv_processstep_bk TO lv_processstep_bk_c.
      WRITE lv_commentstep_bk TO lv_commentstep_bk_c.
      WRITE lv_percent        TO lv_percent_c.

      CONCATENATE lv_percent_c '%' INTO lv_percent_unit
                                       SEPARATED BY space.

*-- Calaculte totle line
      IF ls_program_tmp-clsname IS NOT INITIAL.
        CLEAR: lv_string.
        SELECT SINGLE descript
          INTO lv_string
          FROM vseoclass
          WHERE clsname = ls_program_tmp-clsname.
        CONCATENATE '"[Totle]-' lv_string '"' INTO lv_string.
        CONCATENATE lv_string lv_sep
                    '" "' lv_sep
                    '"' lv_totalstep_bk_c   '"' lv_sep
                    '"' lv_processstep_bk_c '"' lv_sep
                    '"' lv_commentstep_bk_c '"' lv_sep
                    '"' lv_percent_unit     '"' lv_sep
                    '" "' lv_sep
                    INTO ls_steps.
      ELSE.
        CONCATENATE '"[Totle]"' lv_sep
                    '" "' lv_sep
                    '"' lv_totalstep_bk_c   '"' lv_sep
                    '"' lv_processstep_bk_c '"' lv_sep
                    '"' lv_commentstep_bk_c '"' lv_sep
                    '"' lv_percent_unit     '"' lv_sep
                    '" "' lv_sep
                    INTO ls_steps.
      ENDIF.
      APPEND ls_steps TO pt_steps.

      CLEAR ls_steps.
      APPEND ls_steps TO pt_steps.
      APPEND ls_steps TO pt_steps.

      CLEAR: lv_totalstep_bk,
             lv_processstep_bk,
             lv_commentstep_bk.
    ENDAT.
  ENDLOOP.

ENDFORM.                    " PERPARE_DOWNLOAD_SUB4_08B
*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD_CODE_SUB5_08B
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LV_FILENAME  text
*      -->P_PV_FULLLINE  text
*      -->P_PV_COMTLINE  text
*      -->P_PV_PROCLINE  text
*----------------------------------------------------------------------*
FORM download_code_sub5_08b  USING    pv_filename
                                      pv_fullline
                                      pv_comtline
                                      pv_procline.
* Full source line
  TYPES: BEGIN OF l_typ_line,
           source(255) TYPE c,   "Source Line
         END OF l_typ_line.

  DATA: ls_all TYPE l_typ_line,
        lt_all TYPE TABLE OF l_typ_line,
* Comment source line
        ls_comment TYPE l_typ_line,
        lt_comment TYPE TABLE OF l_typ_line,
* Process source line
        ls_process TYPE l_typ_line,
        lt_process TYPE TABLE OF l_typ_line.

  DATA:
        ls_file TYPE ty_s_progline,
        ls_file_tmp TYPE ty_s_progline,
        lv_filename TYPE string.
*-----------------------------------------------------------------------

  SORT gt_source_file_08b.

*  CALL METHOD ycl_cwu_utility=>download1_pc_xxx
*    EXPORTING
*      iv_filename = iv_filename
*      it_file     = mt_steps_08b.

  PERFORM download1_pc_xxx
    TABLES gt_steps_08b
    USING pv_filename.

  IF    pv_fullline IS INITIAL
    AND pv_comtline IS INITIAL
    AND pv_procline IS INITIAL.
    EXIT.
  ENDIF.

  LOOP AT gt_source_file_08b INTO ls_file.

    ls_file_tmp  = ls_file.
    IF pv_fullline = 'X'.
      CLEAR ls_all.
      MOVE ls_file-source TO ls_all-source.
      APPEND ls_all TO lt_all.
    ENDIF.

    IF pv_comtline = 'X'.
      IF ls_file-commentflg = 'X'.
        CLEAR ls_comment.
        MOVE ls_file-source TO ls_comment-source.
        APPEND ls_comment TO lt_comment.
      ENDIF.
    ENDIF.

    IF pv_procline = 'X'.
      IF ls_file-commentflg <> 'X'.
        CLEAR ls_process.
        MOVE ls_file-source TO ls_process-source.
        APPEND ls_process TO lt_process.
      ENDIF.
    ENDIF.

    AT END OF dynr.
*     Download entire sourceline
      IF pv_fullline = 'X' AND lt_all IS NOT INITIAL.
        IF gt_fgroup_08b IS NOT INITIAL AND gv_objtype_08b = 'F'.
          IF ls_file_tmp-funcname IS INITIAL.
            IF ls_file_tmp-dynr IS NOT INITIAL.
*              CONCATENATE gv_folder_08b
*                        ls_file_tmp-group
*                        '(Function Group)/'
*                        ls_file_tmp-name
*                        '_'
*                        ls_file_tmp-dynr
*                        '.txt'
*              INTO      lv_filename.
              CONCATENATE gv_folder_08b
                        ls_file_tmp-group
                        '(Function Group)\'
                        ls_file_tmp-name
                        '_SCREEN\screen_'
                        ls_file_tmp-dynr
                        '.txt'
              INTO      lv_filename.

            ELSE.
              CONCATENATE gv_folder_08b
                        ls_file_tmp-group
                        '(Function Group)\'
                        ls_file_tmp-name
                        '.txt'
              INTO      lv_filename.
            ENDIF.
          ELSE.
            CONCATENATE gv_folder_08b
                       ls_file_tmp-group
                       '(Function Group)\'
                        ls_file_tmp-mainp
                        '\'
                        ls_file_tmp-name
                        '.txt'
              INTO      lv_filename.
          ENDIF.
        ELSE.
          IF ls_file_tmp-dynr IS NOT INITIAL.
*            CONCATENATE gv_folder_08b
*                        ls_file_tmp-mainp
*                        '/'
*                        ls_file_tmp-name
*                        '_'
*                        ls_file_tmp-dynr
*                        '.txt'
*              INTO      lv_filename.
            CONCATENATE gv_folder_08b
                        ls_file_tmp-mainp
                        '\'
                        ls_file_tmp-name
                        '_SCREEN/screen_'
                        ls_file_tmp-dynr
                        '.txt'
              INTO      lv_filename.
          ELSE.
            CONCATENATE gv_folder_08b
                      ls_file_tmp-mainp
                      '\'
                      ls_file_tmp-name
                      '.txt'
            INTO      lv_filename.
          ENDIF.

        ENDIF.

        IF ls_file_tmp-dynr IS INITIAL OR ls_file_tmp-dynr = '1000'.
*          CALL METHOD ycl_cwu_utility=>download1_pc_xxx
*            EXPORTING
*              iv_filename = lv_filename
*              it_file     = lt_all.
          PERFORM download1_pc_xxx
            TABLES lt_all
            USING lv_filename.
        ELSE.
*          CALL METHOD download_screen
*            EXPORTING
*              iv_progid   = ls_file_tmp-name
*              iv_dynpr    = ls_file_tmp-dynr
*              iv_filename = lv_filename
*              .
          PERFORM download_screen
            USING ls_file_tmp-name
                  ls_file_tmp-dynr
                  lv_filename.
        ENDIF.
      ENDIF.
*     Download command sourceline
      IF pv_comtline = 'X'  AND lt_comment IS NOT INITIAL.
        IF gt_fgroup_08b IS NOT INITIAL AND gv_objtype_08b = 'F'.
          IF ls_file_tmp-funcname IS INITIAL.
            CONCATENATE gv_folder_08b
                        ls_file_tmp-group
                        '(Function Group)\'
                        ls_file_tmp-name
                        '(comment).txt'
              INTO      lv_filename.
          ELSE.
            CONCATENATE gv_folder_08b
                        ls_file_tmp-group
                        '(Function Group)\'
                        ls_file_tmp-mainp
                        '\'
                        ls_file_tmp-funcname
                        '\'
                        ls_file_tmp-name
                        '(comment).txt'
              INTO      lv_filename.
          ENDIF.
        ELSE.
          CONCATENATE gv_folder_08b
                      ls_file_tmp-mainp
                      '\'
                      ls_file_tmp-name
                      '(comment).txt'
            INTO      lv_filename.
        ENDIF.
*        CALL METHOD ycl_cwu_utility=>download1_pc_xxx
*          EXPORTING
*            iv_filename = lv_filename
*            it_file     = lt_comment.
        PERFORM download1_pc_xxx
          TABLES lt_comment
          USING lv_filename.
      ENDIF.
*     Download process sourceline
      IF pv_procline = 'X' AND lt_process IS NOT INITIAL.
        IF gt_fgroup_08b IS NOT INITIAL AND gv_objtype_08b = 'F'.
          IF ls_file_tmp-funcname IS INITIAL.
            CONCATENATE gv_folder_08b
                        ls_file_tmp-group
                        '(Function Group)\'
                        ls_file_tmp-name
                        '(process).txt'
              INTO      lv_filename.
          ELSE.
            CONCATENATE gv_folder_08b
                        ls_file_tmp-group
                        '(Function Group)'
                        ls_file_tmp-mainp
                        '\'
                        ls_file_tmp-funcname
                        '\'
                        ls_file_tmp-name
                        '(process).txt'
              INTO      lv_filename.
          ENDIF.
        ELSE.
          CONCATENATE gv_folder_08b
                      ls_file_tmp-mainp
                      '\'
                      ls_file_tmp-name
                      '(process).txt'
            INTO      lv_filename.
        ENDIF.

*        CALL METHOD ycl_cwu_utility=>download1_pc_xxx
*          EXPORTING
*            iv_filename = lv_filename
*            it_file     = lt_process.
        PERFORM download1_pc_xxx
          TABLES lt_process
          USING lv_filename.
      ENDIF.

      CLEAR: ls_all,
             lt_all,
             ls_comment,
             lt_comment,
             ls_process,
             lt_process.
    ENDAT.
  ENDLOOP.

ENDFORM.                    " DOWNLOAD_CODE_SUB5_08B
*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD1_PC_XXX
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_MT_STEPS_08B  text
*      -->P_IV_FILENAME  text
*----------------------------------------------------------------------*
FORM download1_pc_xxx  TABLES   pt_file
                       USING    pv_filename.

  DATA: result_tab TYPE match_result_tab,
        result_wa  TYPE match_result,
        lv_invalid TYPE string VALUE '\/:*?"<>|',
        lv_invalidreg TYPE string VALUE '(\|/|:|*|?|"|<|>)',
        lv_filenm  TYPE string,
        lv_file    TYPE string,
        lv_len     TYPE i,
        lv_rep     TYPE char1 VALUE '&'.
  FIELD-SYMBOLS: <ls_file> TYPE string.

  lv_filenm = pv_filename.
  FIND ALL OCCURRENCES OF '\' IN lv_filenm RESULTS result_tab.
  IF sy-subrc =  0.
    SORT result_tab BY offset DESCENDING.
    READ TABLE result_tab INTO result_wa INDEX 1.
    lv_len = result_wa-offset + 1.
    lv_file = lv_filenm+lv_len.
    IF lv_file CA lv_invalid.
      REPLACE ALL OCCURRENCES OF REGEX '(\\|\/|\:|\*|\?|\"|<|>|\|)'
        IN lv_file WITH lv_rep.
      CONCATENATE lv_filenm(lv_len)
                  lv_file
           INTO lv_filenm.
    ENDIF.
  ENDIF.
  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      filename                        = lv_filenm
      filetype                        = 'ASC'
*      append                          = '
      write_field_separator           = 'X'
      trunc_trailing_blanks           = 'X'
      codepage                        = gv_codepage_08b
    TABLES
      data_tab                        = pt_file
    EXCEPTIONS
      file_write_error                = 1
      no_batch                        = 2
      gui_refuse_filetransfer         = 3
      invalid_type                    = 4
      no_authority                    = 5
      unknown_error                   = 6
      header_not_allowed              = 7
      separator_not_allowed           = 8
      filesize_not_allowed            = 9
      header_too_long                 = 10
      dp_error_create                 = 11
      dp_error_send                   = 12
      dp_error_write                  = 13
      unknown_dp_error                = 14
      access_denied                   = 15
      dp_out_of_memory                = 16
      disk_full                       = 17
      dp_timeout                      = 18
      file_not_found                  = 19
      dataprovider_exception          = 20
      control_flush_error             = 21
      OTHERS                          = 22
      .

  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'S' NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
     INTO lv_file.
    WRITE: / lv_file.
  ENDIF.
ENDFORM.                    " DOWNLOAD1_PC_XXX
*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD_SCREEN
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_screen  USING    pv_progid
                               pv_dynpr
                               pv_filename.
  DATA: lt_fileds TYPE STANDARD TABLE OF d021s,
        lt_flowlogic TYPE  dyn_flowlist,
        lt_params      TYPE STANDARD TABLE OF d023s,
        lt_fields_char TYPE STANDARD TABLE OF scr_chfld,
        lt_dynp_char TYPE STANDARD TABLE OF scr_chfld.

  DATA: lv_dynpro_prog(44) TYPE c,
        lv_descript TYPE d020t-dtxt,
        lv_filelength TYPE i,
        lv_prog_len     TYPE p,
        lv_status TYPE char1.

  DATA: ls_d020s  TYPE d020s,
        ls_params TYPE d023s,
        ls_flowlogic  TYPE d022s,
        ls_dynp_char TYPE  scr_chfld,
        ls_fields_char TYPE scr_chfld,
        ls_header_char TYPE scr_chhead.


  CONSTANTS:
    stars(64)          VALUE
    '****************************************************************',
  comment1(64)       VALUE
    '*   THIS FILE IS GENERATED BY THE SCREEN PAINTER.              *',
  comment2(64)       VALUE
    '*   NEVER CHANGE IT MANUALLY, PLEASE !                         *',
  dynpro_text(8)     VALUE '%_DYNPRO',                      "#EC NOTEXT
  header_text(8)     VALUE '%_HEADER',                      "#EC NOTEXT
  params_text(8)     VALUE '%_PARAMS',                      "#EC NOTEXT
  descript_text(13)  VALUE '%_DESCRIPTION',                 "#EC NOTEXT
  fields_text(8)     VALUE '%_FIELDS',                      "#EC NOTEXT
  kreuz(1)           VALUE 'x',                             "#EC NOTEXT
  flowlogic_text(11) VALUE '%_FLOWLOGIC'.                   "#EC NOTEXT

  SELECT SINGLE dtxt
    FROM d020t
    INTO lv_descript
     WHERE prog  = pv_progid
       AND dynr  = pv_dynpr.

  lv_dynpro_prog       = pv_progid. "ls_program-name.
  lv_dynpro_prog+40(4) = pv_dynpr.          "ls_program-dynr.

  IMPORT DYNPRO ls_d020s lt_fileds lt_flowlogic lt_params
         ID lv_dynpro_prog.

  CHECK sy-subrc = 0.

  CALL FUNCTION 'RS_SCRP_HEADER_RAW_TO_CHAR'
    EXPORTING
      header_int  = ls_d020s
    IMPORTING
      header_char = ls_header_char
    EXCEPTIONS
      OTHERS      = 1.

  REFRESH lt_dynp_char.

* Comment
  CLEAR: ls_dynp_char.
  ls_dynp_char-feldname = stars.
  APPEND ls_dynp_char TO lt_dynp_char.
  CLEAR: ls_dynp_char.
  ls_dynp_char-feldname = comment1.
  APPEND ls_dynp_char TO lt_dynp_char.
  CLEAR: ls_dynp_char.
  ls_dynp_char-feldname = comment2.
  APPEND ls_dynp_char TO lt_dynp_char.
  CLEAR: ls_dynp_char.
  ls_dynp_char-feldname = stars.
  APPEND ls_dynp_char TO lt_dynp_char.

* Identification
  ls_dynp_char-feldname = dynpro_text.      APPEND ls_dynp_char TO lt_dynp_char.
  ls_dynp_char-feldname = ls_header_char-prog. APPEND ls_dynp_char TO lt_dynp_char.
  ls_dynp_char-feldname = ls_header_char-dnum. APPEND ls_dynp_char TO lt_dynp_char.
  ls_dynp_char-feldname = sy-saprl.         APPEND ls_dynp_char TO lt_dynp_char.
  DESCRIBE FIELD pv_progid LENGTH lv_prog_len IN CHARACTER MODE.
  ls_dynp_char(16) = lv_prog_len.      APPEND ls_dynp_char TO lt_dynp_char.

* Header
  ls_dynp_char-feldname = header_text.
  APPEND ls_dynp_char TO lt_dynp_char.     "  '%_HEADER'
  APPEND ls_header_char TO lt_dynp_char.

* Description
  ls_dynp_char-feldname = descript_text.
  APPEND ls_dynp_char TO lt_dynp_char.
  ls_dynp_char-feldname = lv_descript.
  APPEND ls_dynp_char TO lt_dynp_char.

* Fieldlist
  ls_dynp_char-feldname  = fields_text.          "  '%_FIELDS'
  APPEND ls_dynp_char TO lt_dynp_char.
  CALL FUNCTION 'RS_SCRP_FIELDS_RAW_TO_CHAR'
    TABLES
      fields_int  = lt_fileds
      fields_char = lt_fields_char
    EXCEPTIONS
      OTHERS      = 1.

  LOOP AT lt_fields_char INTO ls_fields_char.
    APPEND ls_fields_char TO lt_dynp_char.
  ENDLOOP.

* Flowlogic
  ls_dynp_char = flowlogic_text.         "  '%_FLOWLOGIC'
  APPEND ls_dynp_char TO lt_dynp_char.

  LOOP AT lt_flowlogic INTO ls_flowlogic.
    APPEND ls_flowlogic TO lt_dynp_char.
  ENDLOOP.

* Dynpro Parameters
  ls_dynp_char = params_text.
  APPEND ls_dynp_char TO lt_dynp_char.

  LOOP AT lt_params INTO ls_params.
    APPEND ls_params TO lt_dynp_char.
  ENDLOOP.

* Download  (ab 5.0 mittels GUI_DOWNLOAD anstelle von DOWNLOAD
  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      filename              = pv_filename
      filetype              = 'ASC'
      write_field_separator = 'X'
      trunc_trailing_blanks = 'X'
    IMPORTING
      filelength            = lv_filelength
    TABLES
      data_tab              = lt_dynp_char
    EXCEPTIONS
      OTHERS                = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " DOWNLOAD_SCREEN
