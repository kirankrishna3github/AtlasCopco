************************************************************************
* Program ID           : YSE_REN_TRAN_COSTS                            *
* Program Title        : Transport Report                              *
* Author               : Erik Walravens                                *
* Date                 : 27.02.2007                                    *
* Development Number   : D035                                          *
* Change Request Number: CD1K910949                                    *
* Description          : Overview of transport items for contracts     *
*                        within selection parameters.                  *
************************************************************************
* Change History Log                                                   *
*----------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number | Change Ref *
*----------------------------------------------------------------------*
* MOD-001 |15/03/2007| Erik Walravens | CD1K912417        | 001        *
* Description: Changed titles.                                         *
*----------------------------------------------------------------------*
* MOD-002 |20/03/2007| Erik Walravens | CD1K912693        | 002        *
* Description: ???                                                     *
*----------------------------------------------------------------------*
* MOD-003 |22/03/2007| Erik Walravens | CD1K912844        | 003        *
* Description: Corrected generic transport service number.             *
*              Extended Sales Document types to ZQP1, ZQP2 and ZRIB.   *
*----------------------------------------------------------------------*
* MOD-004 |22/03/2007| Erik Walravens | CD1K912859        | 004        *
* Description: Cosmetic changes, header descriptions...                *
*---------------------------------------------------------------------*
* MOD-016 |16/04/2007| Pieter Jespers | CD1K913810        | 017       *
* Description: Authorisation check                                    *
************************************************************************
REPORT zse_ren_tran_costs.

************************************************************************
* TABLES                                                               *
************************************************************************
TABLES: vttk, likp, vbak.

************************************************************************
* TYPE-POOLS                                                           *
************************************************************************
TYPE-POOLS slis.

************************************************************************
* FIELD-SYMBOLS                                                        *
************************************************************************
FIELD-SYMBOLS: <fieldcat> TYPE LINE OF slis_t_fieldcat_alv.

************************************************************************
* OBJECTS                                                              *
************************************************************************
DATA:  obj_container     TYPE REF TO cl_gui_docking_container,
       obj_alv           TYPE REF TO cl_gui_alv_grid.

************************************************************************
* INTERNAL TYPES                                                       *
************************************************************************
TYPES:  BEGIN OF str_result,
               connr        TYPE vbak-vbeln,         " Contract number
               posnr        TYPE vbap-posnr,         " Contract item
               delnr        TYPE likp-vbeln,         " Delivery number
               lfdat        TYPE likp-lfdat,         " Delivery date
               vstel        TYPE likp-vstel,         " Shipping point
               sfnam        TYPE kna1-name1,         " Ship-from name
               sfstr        TYPE kna1-stras,         " Ship-from street
               sfpco        TYPE kna1-pstlz,
               " ship-from postal code
               sfcty        TYPE kna1-ort01,         " Ship-from city
               sfctr        TYPE t005t-landx,        " Ship-from country
               kunnr        TYPE kna1-kunnr,         " Ship-to partner
               stnam        TYPE kna1-name1,         " Ship-to name
               ststr        TYPE kna1-stras,         " Ship-to street
               stpco        TYPE kna1-pstlz,
               " ship-to postal code
               stcty        TYPE kna1-ort01,         " Ship-to city
               stctr        TYPE t005t-landx,        " Ship-to country
               tplst        TYPE vttk-tplst,
               " Transport planning point
               tknum        TYPE vttk-tknum,         " Shipment ID
               shtyp        TYPE vttk-shtyp,         " Shipment type
               tdlnr        TYPE vttk-tdlnr,         " Forwarder nr
               tdnam        TYPE kna1-name1,         " Forwarder name
               vsart        TYPE vttk-vsart,         " Shipping type
               exti1        TYPE vttk-exti1,         " External ID 1
               sttrg        TYPE vttk-sttrg,         " Shipment status
               status       TYPE dd07v-ddtext,
               " Status description
               kwert        TYPE konv-kwert,         " Transport cost
        END OF str_result,

        BEGIN OF str_konv,
             knumv        TYPE konv-knumv,
             kposn        TYPE konv-kposn,
             kwert        TYPE konv-kwert,
        END OF str_konv,

        BEGIN OF str_items,
*               vbeln        TYPE vbap-vbeln,
*               posnr        TYPE vbap-posnr,
*               kunnr        TYPE vbak-kunnr,
*               knumv        TYPE konv-knumv,
*               kwert        TYPE konv-kwert,
          vbeln TYPE vbeln_va,
          auart TYPE auart,
          vtweg TYPE vtweg,
          knumv TYPE knumv,
          kunnr TYPE kunnr,
          posnr TYPE posnr_va,
          matnr TYPE matnr,
          kwert TYPE kwert,
        END OF str_items,

        BEGIN OF str_delivs,
               vbelv        TYPE vbfa-vbelv,
               vbeln        TYPE vbfa-vbeln,
        END OF str_delivs,

        BEGIN OF str_vbpa,
               vbeln        TYPE vbpa-vbeln,
               posnr        TYPE vbpa-posnr,
               kunnr        TYPE vbpa-kunnr,
        END OF str_vbpa,

        BEGIN OF str_addr,
               kunnr        TYPE kna1-kunnr,         " Partner nr
               name1        TYPE kna1-name1,         " Name
               stras        TYPE kna1-stras,         " Street
               pstlz        TYPE kna1-pstlz,         " Postal code
               ort01        TYPE kna1-ort01,         " City
               landx        TYPE t005t-landx,        " Country
        END OF str_addr,

        BEGIN OF str_ship,
               vstel        TYPE tvst-vstel,         " Shipping point
               name1        TYPE kna1-name1,         " Name
               stras        TYPE kna1-stras,         " Street
               pstlz        TYPE kna1-pstlz,         " Postal code
               ort01        TYPE kna1-ort01,         " City
               landx        TYPE t005t-landx,        " Country
        END OF str_ship,

        BEGIN OF str_t005t,
               land1        TYPE t005t-land1,
               landx        TYPE t005t-landx,
        END OF str_t005t,

        BEGIN OF str_lfa1,
               lifnr        TYPE lfa1-lifnr,        " Forwarder nr
               name1        TYPE lfa1-name1,        " Forwarder name
        END OF str_lfa1,

        BEGIN OF str_status,
               domvalue_l   TYPE dd07v-domvalue_l,  " Status value
               ddtext       TYPE dd07v-ddtext,      " Status description
        END OF str_status.


************************************************************************
* LOCAL VARIABLES                                                      *
************************************************************************
*User's own data
DATA:   lv_tplst    TYPE vttk-tplst,
        lv_tknum    TYPE vttk-tknum,
        lv_shtyp    TYPE vttk-shtyp,
        lv_tdlnr    TYPE vttk-tdlnr,
        lv_delnr    TYPE likp-vbeln,
        lv_kunnr    TYPE kna1-kunnr,
        lv_connr    TYPE vbak-vbeln.
*ALV grid
DATA:   lv_repid    LIKE sy-repid,
        okcode      LIKE sy-ucomm,        " return param screen 100
        gs_layout   TYPE lvc_s_layo,      " ALV grid layout
        gs_variant  TYPE disvariant.      " ALV grid variant
*Process
DATA:   lv_lines    TYPE p.               " Number of records

************************************************************************
* RANGES                                                               *
************************************************************************
RANGES:
  r_tplst FOR vttk-tplst,           " Transport planning point
  r_shtyp FOR vttk-shtyp,           " Shipment type
  r_vsart FOR vttk-vsart,           " Shipping type
  r_tdlnr FOR vttk-tdlnr,           " Forwarder agent
  r_vstel FOR vbap-vstel,           " Shipping point
  r_kunnr FOR vbak-kunnr.           " Ship-to partner

************************************************************************
* LOCAL CONSTANTS                                                      *
************************************************************************
CONSTANTS:
  gc_engl  TYPE spras        VALUE 'E',
  gc_true  TYPE c            VALUE 'X',
  gc_zqp   TYPE vbak-auart   VALUE 'ZQP',  " Doc type: Rental contracts
  gc_zqp1  TYPE vbak-auart   VALUE 'ZQP1', " Doc type:
  gc_zqp2  TYPE vbak-auart   VALUE 'ZQP2', " Doc type:
  gc_zrib  TYPE vbak-auart   VALUE 'ZRIB',
  " Doc type: cross division rental
  gc_rent  TYPE vbak-vtweg   VALUE '21',   " Distr. channel: Rental
  gc_trans TYPE konv-kschl   VALUE 'ZTRA', " Condition type: Transport
  gc_trsv1 TYPE vbap-matnr   VALUE '000000010000100147',
  " Generic transport service CD1
  gc_trsv2 TYPE vbap-matnr   VALUE '000000010000306431',
  " Generic transport service CQ1
  gc_trsv3 TYPE vbap-matnr   VALUE '000000010000306432',
  " Generic transport service CQ1
  gc_delo  TYPE likp-lfart   VALUE 'ZLF',  " Outbound delivery
  gc_deli  TYPE likp-lfart   VALUE 'LR',   " Inbound delivery
  gc_shipto  TYPE vbpa-parvw VALUE 'WE',   " ShipTo partner
  gc_field TYPE dd07v-domname VALUE 'STTRG'. " Status field

************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:   it_result   TYPE TABLE OF str_result WITH HEADER LINE,
        it_konv     TYPE TABLE OF str_konv   WITH HEADER LINE,
        it_items    TYPE TABLE OF str_items  WITH HEADER LINE,
        it_delivs   TYPE TABLE OF str_delivs WITH HEADER LINE,
        it_addr     TYPE TABLE OF str_addr   WITH HEADER LINE,
        it_ship     TYPE TABLE OF str_ship   WITH HEADER LINE,
        it_vbpa     TYPE TABLE OF str_vbpa   WITH HEADER LINE,
        it_lfa1     TYPE TABLE OF str_lfa1   WITH HEADER LINE,
        it_status   TYPE TABLE OF str_status WITH HEADER LINE,
        it_fieldcat TYPE lvc_t_fcat          WITH HEADER LINE.
" ALV grid field catalog

************************************************************************
* SELECTION SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-s01.
PARAMETERS:
*p_bukrs TYPE vbak-bukrs_vf OBLIGATORY,    " Company code
*p_vkbur  TYPE vbak-vkbur,          " Sales office (depot)
                p_tplst  TYPE vttk-tplst,
                " Transport planning point
                p_vstel  TYPE likp-vstel,          " Shipping point
                p_shtyp  TYPE  vttk-shtyp,         " Shipment type
                p_tdlnr  TYPE vttk-tdlnr,          " Forwarder Agent
                p_vsart  TYPE vttk-vsart,          " Shipping type
                p_kunnr  TYPE kna1-kunnr,          " Ship-to partner
                p_angdt  TYPE likp-lfdat,          " Start delivery date
                p_bnddt  TYPE likp-lfdat.          " End delivery date
SELECT-OPTIONS: so_tknum FOR  vttk-tknum,          " Shipment ID
                so_sttrg FOR  vttk-sttrg,          " Shipment status
                so_delnr FOR  likp-vbeln,          " Delivery document
                so_connr FOR  vbak-vbeln.          " Contract number
SELECTION-SCREEN END OF BLOCK b1.

************************************************************************
* INITIALIZATION                                                       *
************************************************************************
INITIALIZATION.

  PERFORM load_own_data.

************************************************************************
* INITIALIZATION                                                       *
************************************************************************
AT SELECTION-SCREEN.

  PERFORM check_authorization.

************************************************************************
* START OF SELECTION                                                   *
************************************************************************
START-OF-SELECTION.

  PERFORM init_data.
  PERFORM load_data.
  PERFORM load_addresses.
  PERFORM load_statusses.

  LOOP AT it_result.

    PERFORM get_shipfrom_address.
    PERFORM get_shipto_address.
    PERFORM get_forwarder.
    PERFORM get_status.

    MODIFY it_result.

  ENDLOOP.

  CALL SCREEN 100.


************************************************************************
* FORM: LOAD_OWN_DATA                                                  *
************************************************************************
* Loads the user's own data for most selection fields.                 *
************************************************************************
FORM load_own_data.

* Transport Planning Point
  GET PARAMETER ID 'TDP' FIELD lv_tplst.
  IF NOT lv_tplst IS INITIAL.
    p_tplst = lv_tplst.
  ENDIF.

* Shipment ID
  GET PARAMETER ID 'TNR' FIELD lv_tknum.
  IF NOT lv_tknum IS INITIAL.
    so_tknum-sign = 'I'.
    so_tknum-option = 'EQ'.
    so_tknum-low = lv_tknum.
    APPEND so_tknum.
  ENDIF.

* Shipment Type
  GET PARAMETER ID 'TSH' FIELD lv_shtyp.
  IF NOT lv_shtyp IS INITIAL.
    p_shtyp = lv_shtyp.
  ENDIF.

* Forwarder agent
  GET PARAMETER ID 'LIF' FIELD lv_tdlnr.
  IF NOT lv_tdlnr IS INITIAL.
    p_tdlnr = lv_tdlnr.
  ENDIF.

* Delivery number
  GET PARAMETER ID 'VL' FIELD lv_delnr.
  IF NOT lv_delnr IS INITIAL.
    so_delnr-sign = 'I'.
    so_delnr-option = 'EQ'.
    so_delnr-low = lv_delnr.
    APPEND so_delnr.
  ENDIF.

* Ship-to partner
  GET PARAMETER ID 'KUN' FIELD lv_kunnr.
  IF NOT lv_kunnr IS INITIAL.
    p_kunnr = lv_kunnr.
  ENDIF.

* Contract number
  GET PARAMETER ID 'KTN' FIELD lv_connr.
  IF NOT lv_connr IS INITIAL.
    so_connr-sign = 'I'.
    so_connr-option = 'EQ'.
    so_connr-low = lv_connr.
    APPEND so_connr.
  ENDIF.

ENDFORM.  " load_own_data


************************************************************************
* FORM: INIT_DATA                                                      *
************************************************************************
* Reformats input parameters.                                          *
************************************************************************
FORM init_data.

  IF p_angdt IS INITIAL.
    p_angdt = '00000000'.
  ENDIF.

  IF p_bnddt IS INITIAL.
    p_bnddt = '31129999'.
  ENDIF.

  IF NOT p_tplst IS INITIAL.
    r_tplst-sign = 'I'.
    r_tplst-option = 'EQ'.
    r_tplst-low = p_tplst.
    APPEND r_tplst.
  ENDIF.

  IF NOT p_shtyp IS INITIAL.
    r_shtyp-sign = 'I'.
    r_shtyp-option = 'EQ'.
    r_shtyp-low = p_shtyp.
    APPEND r_shtyp.
  ENDIF.

  IF NOT p_tdlnr IS INITIAL.
    r_tdlnr-sign = 'I'.
    r_tdlnr-option = 'EQ'.
    r_tdlnr-low = p_tdlnr.
    APPEND r_tdlnr.
  ENDIF.

  IF NOT p_vsart IS INITIAL.
    r_vsart-sign = 'I'.
    r_vsart-option = 'EQ'.
    r_vsart-low = p_vsart.
    APPEND r_vsart.
  ENDIF.

  IF NOT p_vstel IS INITIAL.
    r_vstel-sign = 'I'.
    r_vstel-option = 'EQ'.
    r_vstel-low = p_vstel.
    APPEND r_vstel.
  ENDIF.

  IF NOT p_kunnr IS INITIAL.
    r_kunnr-sign = 'I'.
    r_kunnr-option = 'EQ'.
    r_kunnr-low = p_kunnr.
    APPEND r_kunnr.
  ENDIF.

ENDFORM.    " init_data


************************************************************************
* FORM: LOAD_CONTRACT_ITEMS                                            *
************************************************************************
* Load all contracts that have an item with a reference to a shipment  *
* condition type. Next retrieve all delivery and shipment info based   *
* on these contracts.                                                  *
************************************************************************
FORM load_data.

* Note van Tom: konv mee joinen in volgende select.
* Answer: For pooled tables join is not allowed.
* This doesn't work since konv is a 'pooled' table
*
*  SELECT *
*      INTO CORRESPONDING FIELDS OF TABLE it_items
*      FROM vbak
*     INNER JOIN vbap
*        ON vbap~vbeln EQ vbak~vbeln
*     INNER JOIN konv
*        ON konv~knumv EQ vbak~knumv
*       AND konv~kposn EQ vbap~posnr
*     WHERE vbak~vtweg EQ gc_rent             " Rental Distr. channel
*       AND vbak~auart EQ gc_cont             " Contracts
*AND vbap~matnr EQ gc_trser.           " Generic transport service

* Load all condition type records with transport conditions

*Note: Optimize by selecting VBAK/VBAP first and then select conditions.
*  SELECT knumv
*         kposn
*         kwert
*      FROM konv
*      INTO CORRESPONDING FIELDS OF TABLE it_konv
*     WHERE kschl EQ gc_trans
*      AND  kappl = 'V'
*      AND  zaehk = '1'
*      AND  stunr = '108'.

*Note: Shipping point (VBAP-VSTEL) cannot be used in where condition
*since
*       it is not entered in the transport item of the rental contract.

*Note: Generic Transport Services are different in CD1 and CQ1, and will
*       probably be different in CP1 too. A permantent solution would be
*       to maintain a Z-table with generic services in each client.
*  IF NOT it_konv[] IS INITIAL.
  SELECT  a~vbeln
          a~auart
          a~vtweg
          a~knumv
          a~kunnr
          b~posnr
          b~matnr
      INTO CORRESPONDING FIELDS OF TABLE it_items
      FROM vbak AS a
      INNER JOIN vbap AS b
        ON a~vbeln = b~vbeln
*         FOR ALL ENTRIES IN it_konv
     WHERE
*           vbak~bukrs_vf EQ p_bukrs          " Company code
*       AND vbak~vkbur    EQ p_vkbur          " Sales office
           a~vbeln    IN so_connr          " Range of contracts
       AND a~vtweg    EQ gc_rent       AND " Rental
         ( a~auart    EQ gc_zqp         OR
           a~auart    EQ gc_zqp1        OR
           a~auart    EQ gc_zqp2        OR
           a~auart    EQ gc_zrib )     AND
*         AND a~knumv    EQ it_konv-knumv     " Condition record nr
*        AND   a~knumv   EQ it_konv-knumv     " Condition record nr
*          AND b~posnr    EQ it_konv-kposn AND " Item
*          AND b~posnr    EQ it_konv-kposn " Item
         ( b~matnr    EQ gc_trsv1       OR
         " Generic transport service
           b~matnr    EQ gc_trsv2       OR
           b~matnr    EQ gc_trsv2 )
       AND a~kunnr    IN r_kunnr.          " Ship-to partner

  IF sy-subrc = 0.
    SORT it_items BY vbeln ASCENDING.
  ENDIF.
*  ENDIF.

********************************
  IF NOT it_items[] IS INITIAL.
    SELECT knumv
           kposn
           kwert
        FROM konv
        INTO CORRESPONDING FIELDS OF TABLE it_konv
        FOR ALL ENTRIES IN it_items
       WHERE kschl EQ gc_trans
        AND  knumv = it_items-knumv     " Condition record nr
        AND  kposn = it_items-posnr.    " Condition record nr
*      AND  kappl = 'V'
*      AND  zaehk = '1'
*      AND  stunr = '108'.
    IF sy-subrc = 0.
*      SORT it_konv by knumv kposn.
    ENDIF.
  ENDIF.
********************************


  LOOP AT it_items.
*    CHECK    it_items-vtweg    EQ gc_rent       AND " Rental
*             ( it_items-auart    EQ gc_zqp         OR
*               it_items-auart    EQ gc_zqp1        OR
*               it_items-auart    EQ gc_zqp2        OR
*               it_items-auart    EQ gc_zrib ).
*
*    CHECK   ( it_items-matnr    EQ gc_trsv1       OR
*            " Generic transport service
*              it_items-matnr    EQ gc_trsv2       OR
*              it_items-matnr    EQ gc_trsv2 ).

    READ TABLE it_konv WITH KEY knumv = it_items-knumv
                          kposn = it_items-posnr.
    IF sy-subrc = 0.
      it_items-kwert = it_konv-kwert.
      MODIFY it_items.
    ENDIF.
  ENDLOOP.  " it_items

  DESCRIBE TABLE it_items LINES lv_lines.
  IF lv_lines > 0.

*   Load all delivery and shipment information for the items
    IF NOT it_items[] IS INITIAL.
      SELECT a~vbelv AS connr
             a~vbeln AS delnr
             b~lfdat
             b~vstel
             c~tplst
             c~tknum
             c~shtyp
             c~tdlnr
             c~vsart
             c~exti1
             c~sttrg
          INTO CORRESPONDING FIELDS OF TABLE it_result
          FROM vbfa AS a
          INNER JOIN likp AS b
            ON a~vbeln EQ b~vbeln
          JOIN vttp
            ON a~vbeln EQ vttp~vbeln
          INNER JOIN vttk AS c
            ON vttp~tknum EQ c~tknum
           FOR ALL ENTRIES IN it_items
         WHERE a~vbeln IN so_delnr           " range of deliveries
           AND a~vbelv EQ it_items-vbeln
           AND a~vbtyp_n EQ 'J'
         AND ( b~lfart EQ gc_deli
          OR   b~lfart EQ gc_delo )
           AND b~lfdat GE p_angdt
           AND b~lfdat LE p_bnddt
           AND b~vstel IN r_vstel            " Shipping point
           AND c~tplst IN r_tplst            " Transport planning point
           AND c~shtyp IN r_shtyp            " Shipment type
           AND c~tdlnr IN r_tdlnr            " Forwarder agent
           AND c~vsart IN r_vsart.           " Shipping type
    ENDIF.
    DESCRIBE TABLE it_result LINES lv_lines.
    IF lv_lines > 0.

*     Load forwarding agent names
      IF NOT it_result[] IS INITIAL.
        SELECT lifnr name1
            INTO TABLE it_lfa1
            FROM lfa1
             FOR ALL ENTRIES IN it_result
           WHERE lifnr EQ it_result-tdlnr.
      ENDIF.
    ENDIF.  " records in it_result
  ENDIF.  " items found

ENDFORM.  " select_contract_items


************************************************************************
* FORM: LOAD_ADDRESSES                                                 *
************************************************************************
* Prepare internal tables with address information of all ship-to      *
* partners and all shipping points.                                    *
************************************************************************
FORM load_addresses.

  DESCRIBE TABLE it_items LINES lv_lines.
  IF lv_lines > 0.

*   Load addresses for all ship-to partners in selected contracts
*   note: posnr = 00000 and posnr = 10? Result in two lines?
    IF NOT it_items[] IS INITIAL.
      SELECT a~vbeln
             a~posnr
  	      b~kunnr
             b~name1
             b~stras
             b~pstlz
             b~ort01
             c~landx
          INTO CORRESPONDING FIELDS OF TABLE it_addr
          FROM vbpa AS a
          INNER JOIN kna1 AS b
            ON b~kunnr EQ a~kunnr
          INNER JOIN t005t AS c
            ON b~land1 EQ c~land1
           FOR ALL ENTRIES IN it_items
         WHERE a~vbeln EQ it_items-vbeln
         AND ( a~posnr EQ it_items-posnr
          OR   a~posnr EQ space )
           AND a~parvw EQ gc_shipto
           AND c~spras EQ gc_engl.

      SORT it_addr.
      DELETE ADJACENT DUPLICATES FROM it_addr.
    ENDIF.

*   Load shipfrom addresses
    IF NOT it_result[] IS INITIAL.
      SELECT a~vstel
             b~vtext AS name1             " adrc~name1
             c~street AS stras
             c~post_code1 AS pstlz
             c~city1 AS ort01
             d~landx
          INTO CORRESPONDING FIELDS OF TABLE it_ship
          FROM tvst AS a
          INNER JOIN tvstt AS b
            ON a~vstel = b~vstel
          INNER JOIN adrc AS c
            ON a~adrnr = c~addrnumber
          INNER JOIN t005t AS d
            ON c~country = d~land1
           FOR ALL ENTRIES IN it_result
         WHERE a~vstel  EQ it_result-vstel
           AND d~spras EQ gc_engl.              " 2BC to user spras

      SORT it_ship.
      DELETE ADJACENT DUPLICATES FROM it_ship.
    ENDIF.
  ENDIF.  " records in it_items
ENDFORM.  " load_addresses


************************************************************************
* FORM: LOAD_STATUSSES                                                 *
************************************************************************
************************************************************************
FORM load_statusses.

  SELECT domvalue_l
         ddtext
      FROM dd07v
      INTO CORRESPONDING FIELDS OF TABLE it_status
     WHERE domname = gc_field
       AND ddlanguage = gc_engl.

ENDFORM.  " load_statusses


************************************************************************
* FORM: GET_SHIPFROM_ADDRESS                                           *
************************************************************************
************************************************************************
FORM get_shipfrom_address.

  READ TABLE it_ship WITH KEY vstel = it_result-vstel.
  IF sy-subrc = 0.
    it_result-sfnam = it_ship-name1.
    it_result-sfstr = it_ship-stras.
    it_result-sfpco = it_ship-pstlz.
    it_result-sfcty = it_ship-ort01.
    it_result-sfctr = it_ship-landx.
  ENDIF.

ENDFORM.  " get_shipto_address


************************************************************************
* FORM: GET_SHIPTO_ADDRESS                                             *
************************************************************************
************************************************************************
FORM get_shipto_address.

  READ TABLE it_items WITH KEY vbeln = it_result-connr.
  IF sy-subrc = 0.
    it_result-kunnr = it_items-kunnr.
    it_result-posnr = it_items-posnr.
    it_result-kwert = it_items-kwert.
  ENDIF.

  READ TABLE it_addr WITH KEY kunnr = it_result-kunnr.
  IF sy-subrc = 0.
    it_result-stnam = it_addr-name1.
    it_result-ststr = it_addr-stras.
    it_result-stpco = it_addr-pstlz.
    it_result-stcty = it_addr-ort01.
    it_result-stctr = it_addr-landx.
  ENDIF.

ENDFORM.  " get_shipto_address


************************************************************************
* FORM: GET_FORWARDER                                                  *
************************************************************************
************************************************************************
FORM get_forwarder.

  READ TABLE it_lfa1 WITH KEY lifnr = it_result-tdlnr.
  IF sy-subrc = 0.
    it_result-tdnam = it_lfa1-name1.
  ENDIF.

ENDFORM.  " get_forwarder


************************************************************************
* FORM: GET_STATUS                                                     *
************************************************************************
************************************************************************
FORM get_status.

  READ TABLE it_status WITH KEY domvalue_l = it_result-sttrg.
  IF sy-subrc = 0.
    it_result-status = it_status-ddtext.
  ENDIF.

ENDFORM.  " get_forwarder


*****************
* Output
**********************
************************************************************************
**
** Module STATUS_0100 OUTPUT
**
************************************************************************
**
MODULE status_0100 OUTPUT.
  SET TITLEBAR 'TITLE100' .
  SET PF-STATUS 'STATUS100'.
ENDMODULE.                 " STATUS_0100  OUTPUT


************************************************************************
**
** Module USER_COMMAND_0100 INPUT
**
************************************************************************
**
MODULE user_command_0100 INPUT.
  CASE okcode.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
  ENDCASE.  " okcode
ENDMODULE.  " USER_COMMAND_0100 INPUT


************************************************************************
**
** Module PREPARE_SCREEN OUTPUT
**
************************************************************************
**
MODULE prepare_screen OUTPUT.

  IF obj_container IS INITIAL.

*   Create the container
    CREATE OBJECT obj_container
      EXPORTING
          repid           =  sy-repid
          dynnr           =  sy-dynnr
          lifetime        =  cntl_lifetime_dynpro
*          ratio           =  90.
          extension       =  5000.

*   Create the ALV control
    CREATE OBJECT obj_alv
      EXPORTING
        i_parent = obj_container.

    PERFORM build_alv.
  ENDIF.    " obj_container INITIAL
ENDMODULE.                 " PREPARE_SCREEN  OUTPUT


************************************************************************
* Form BUILD_ALV                                                       *
************************************************************************
* No arguments                                                         *
************************************************************************
* Builds the field catalog, sets display parameters and calls the      *
* method to display the results on screen.                             *
************************************************************************
FORM build_alv.

  PERFORM build_field_catalog.

*    Note: Comment out gs_variant-variant when the default variant
*          doesn't exist yet or when the field catalog has changed.
*          Create it at run-time and from then on include it as a
*          parameter to the first display method.

* Build layout, including default variant with subtotals
  gs_variant-report = sy-repid.
*  gs_variant-variant = '/SUB_TOTALS'.
*  gs_layout-no_toolbar = lc_true.
  gs_layout-sel_mode   = 'B'.        " single row selectable

*    Note: i_save parameter:
*    U Only user specific layouts can be saved
*    X Only global layouts can be saved
*    A Both user specific and global layouts can be saved
*    Space Layouts can not be saved

*  gs_layout-no_toolbar = lc_true.
*  gs_layout-sel_mode   = 'D'.

  CALL METHOD obj_alv->set_table_for_first_display
    EXPORTING
      i_save          = 'A'
      is_variant      = gs_variant
      is_layout       = gs_layout
    CHANGING
      it_outtab       = it_result[]
      it_fieldcatalog = it_fieldcat[].

ENDFORM.                    "build_alv


************************************************************************
* Form BUILD_FIELD_CATALOG                                             *
************************************************************************
* Builds the field catalog for each field in it_result.                *
************************************************************************
FORM build_field_catalog.

  CLEAR it_fieldcat.

*   Field: Plant
  it_fieldcat-fieldname = 'TPLST'.
  it_fieldcat-outputlen = 6.
  it_fieldcat-coltext = 'Plant'(001).
  it_fieldcat-tooltip = 'Transportation planning point'(002).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Shipment ID
  it_fieldcat-fieldname = 'TKNUM'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Shipm ID'(003).
  it_fieldcat-tooltip = 'Shipment ID'(004).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Delivery date
  it_fieldcat-fieldname = 'LFDAT'.
  it_fieldcat-outputlen = 9.
  it_fieldcat-coltext = 'Deliv date'(005).
  it_fieldcat-tooltip = 'Delivery date'(006).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Transport cost
  it_fieldcat-fieldname = 'KWERT'.
  it_fieldcat-outputlen = 8.
  it_fieldcat-coltext = 'Charged'(007).
  it_fieldcat-tooltip = 'Charged to customer'(008).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Forwarder nr
  it_fieldcat-fieldname = 'TDLNR'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Forw nr'(009).
  it_fieldcat-tooltip = 'Forwarder number'(010).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Forwarder name
  it_fieldcat-fieldname = 'TDNAM'.
  it_fieldcat-outputlen = 15.
  it_fieldcat-coltext = 'Forw name'(011).
  it_fieldcat-tooltip = 'Forwarder name'(012).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Shipment type
  it_fieldcat-fieldname = 'SHTYP'.
  it_fieldcat-outputlen = 6.
  it_fieldcat-coltext = 'Shipm. type'(013).
  it_fieldcat-tooltip = 'Shipment type'(014).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Shipping type
  it_fieldcat-fieldname = 'VSART'.
  it_fieldcat-outputlen = 6.
  it_fieldcat-coltext = 'Ship.type'(015).
  it_fieldcat-tooltip = 'Shipping type'(016).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Shipping point
  it_fieldcat-fieldname = 'VSTEL'.
  it_fieldcat-outputlen = 6.
  it_fieldcat-coltext = 'Ship pnt'(017).
  it_fieldcat-tooltip = 'Shipping point'(018).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: External ID 1
  it_fieldcat-fieldname = 'EXTI1'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Ext ID'(019).
  it_fieldcat-tooltip = 'External ID 1'(020).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

**   Field: Shipment status
*    it_fieldcat-fieldname = 'STTRG'.
*    it_fieldcat-outputlen = 10.
*    it_fieldcat-coltext = 'Ship. stat'(021).
*    it_fieldcat-tooltip = 'Shipment status'(022).
*    it_fieldcat-fix_column = 'X'.
*    it_fieldcat-emphasize = 'X'.
*    APPEND it_fieldcat.

*   Field: Shipment status description
  it_fieldcat-fieldname = 'STATUS'.
  it_fieldcat-outputlen = 20.
  it_fieldcat-coltext = 'Ship. stat'(023).
  it_fieldcat-tooltip = 'Shipment status'(024).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-from name
  it_fieldcat-fieldname = 'SFNAM'.
  it_fieldcat-outputlen = 15.
  it_fieldcat-coltext = 'Ship from'(025).
  it_fieldcat-tooltip = 'Ship-from name'(026).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-from street
  it_fieldcat-fieldname = 'SFSTR'.
  it_fieldcat-outputlen = 15.
  it_fieldcat-coltext = 'Street'(027).
  it_fieldcat-tooltip = 'Ship-from street'(028).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-from postal code
  it_fieldcat-fieldname = 'SFPCO'.
  it_fieldcat-outputlen = 6.
  it_fieldcat-coltext = 'Postal'(029).
  it_fieldcat-tooltip = 'ship-from postal code'(030).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-from city
  it_fieldcat-fieldname = 'SFCTY'.
  it_fieldcat-outputlen = 8.
  it_fieldcat-coltext = 'City'(031).
  it_fieldcat-tooltip = 'Ship-from city'(032).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-from country
  it_fieldcat-fieldname = 'SFCTR'.
  it_fieldcat-outputlen = 8.
  it_fieldcat-coltext = 'Country'(033).
  it_fieldcat-tooltip = 'Ship-from country'(034).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-to partner
  it_fieldcat-fieldname = 'KUNNR'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Ship-to'(035).
  it_fieldcat-tooltip = 'Ship-to partner'(036).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-to name
  it_fieldcat-fieldname = 'STNAM'.
  it_fieldcat-outputlen = 15.
  it_fieldcat-coltext = 'Name'(037).
  it_fieldcat-tooltip = 'Ship-to name'(038).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-to street
  it_fieldcat-fieldname = 'STSTR'.
  it_fieldcat-outputlen = 15.
  it_fieldcat-coltext = 'Street'(039).
  it_fieldcat-tooltip = 'Ship-to street'(040).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-to postal code
  it_fieldcat-fieldname = 'STPCO'.
  it_fieldcat-outputlen = 6.
  it_fieldcat-coltext = 'Postal'(041).
  it_fieldcat-tooltip = 'Ship-to postal code'(042).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-to city
  it_fieldcat-fieldname = 'STCTY'.
  it_fieldcat-outputlen = 8.
  it_fieldcat-coltext = 'City'(043).
  it_fieldcat-tooltip = 'Ship-to city'(044).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Ship-to country
  it_fieldcat-fieldname = 'STCTR'.
  it_fieldcat-outputlen = 8.
  it_fieldcat-coltext = 'Country'(045).
  it_fieldcat-tooltip = 'Ship-to country'(046).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Contract number
  it_fieldcat-fieldname = 'CONNR'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Contract'(047).
  it_fieldcat-tooltip = 'Contract number'(048).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Contract item
  it_fieldcat-fieldname = 'POSNR'.
  it_fieldcat-outputlen = 4.
  it_fieldcat-coltext = 'Item'(049).
  it_fieldcat-tooltip = 'Contract item'(050).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

*   Field: Delivery number
  it_fieldcat-fieldname = 'DELNR'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Delivery'(051).
  it_fieldcat-tooltip = 'Delivery number'(052).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

ENDFORM.    " build_field_catalog
*&---------------------------------------------------------------------*
*&      Form  Check_Authorization
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_authorization .


  AUTHORITY-CHECK OBJECT 'V_LIKP_VST'
           ID 'VSTEL' FIELD p_vstel
           ID 'ACTVT' DUMMY.

  IF sy-subrc = 4.
*   No authorisation to display the data
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '007' WITH p_vstel.
  ELSEIF sy-subrc <> 0.
*   Error checking authorization.
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
  ENDIF.


ENDFORM.                    " Check_Authorization

*Text symbol text£º
*001:Plant
*002:Transportation planning point
*003:Shipm ID
*004:Shipment ID
*005:Deliv date
*006:Delivery date
*007:Charged
*008:Charged to customer
*009:Forw nr
*010:Forwarder number
*011:Forw name
*012:Forwarder name
*013:Shipm. type
*014:Shipment type
*015:Ship.type
*016:Shipping type
*017:Ship pnt
*018:Shipping point
*019:Ext ID
*020:External ID 1
*021:SHIP. STAT
*022:SHIPMENT STATUS
*023:Ship. stat
*024:Shipment status
*025:Ship from
*026:Ship-from name
*027:Street
*028:Ship-from street
*029:Postal
*030:ship-from postal code
*031:City
*032:Ship-from city
*033:Country
*034:Ship-from country
*035:Ship-to
*036:Ship-to partner
*037:Name
*038:Ship-to name
*039:Street
*040:Ship-to street
*041:Postal
*042:Ship-to postal code
*043:City
*044:Ship-to city
*045:Country
*046:Ship-to country
*047:Contract
*048:Contract number
*049:Item
*050:Contract item
*051:Delivery
*052:Delivery number

*S01:Selection parameters
*Selection text£º
*P_ANGDT:        Start delivery date
*P_BNDDT:        End delivery date
*P_KUNNR:        Ship-to partner
*P_SHTYP:        Shipment Type
*P_TDLNR:        Forwarder Agent
*P_TPLST:        Transportation Planning Point
*P_VSART:        Shipping Type
*P_VSTEL:        Shipping point
*SO_CONNR:        Contract number
*SO_DELNR:        Delivery number
*SO_STTRG:        Shipment status
*SO_TKNUM:        Shipment number
