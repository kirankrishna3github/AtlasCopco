REPORT ZAL_ABAP message-id 26 line-size 255
no standard page heading.
* ZCP1_QMEL.
PARAMETER DOWNLOAD(1) DEFAULT 'S' lower case. "N-svr,Y-clnt
PARAMETER EXECMODE(1) DEFAULT 'B' lower case. "D-dlg,B-btch
PARAMETER OUT_DIR(48) DEFAULT "output file dir
'/var/load/CD1/UK/read' lower case.
PARAMETER IN_DIR(48) DEFAULT "input file dir
'/var/load/CD1/UK/read' lower case.
PARAMETER P_DEST TYPE RFCDES-RFCDEST DEFAULT
'NONE'.
PARAMETER P_PROGID TYPE RFCOPT-RFCEXEC DEFAULT
SPACE.
PARAMETER P_GWHOST TYPE RFCOPT-RFCGWHOST DEFAULT
SPACE.
PARAMETER P_GWSERV TYPE RFCOPT-RFCGWSERV DEFAULT
SPACE.
PARAMETER P_SRVFM(30) DEFAULT "Server Callback function
SPACE.
PARAMETER P_PKGSZ TYPE I DEFAULT "Stream package size
5000.
PARAMETER P_SNC_ON(1) DEFAULT "X-on SPACE-off
SPACE.

PARAMETER $PARAM1 TYPE D.

PARAMETER $PARAM2 TYPE D.

PARAMETER P_DF_VK(40) DEFAULT "ABAP data flow object key
'' lower case.
PARAMETER P_DI_GEN(40) DEFAULT "DI version that generated ABAP
'' lower case.

*** Machine generated ABAP. Do not modify.            ***
*** (C)Copyright Business Objects S.A.  All rights reserved. ***
*
* Date Time:
*    03/03/16 07:49:35
* SAP used for generated this ABAP:
*    Release: 701
*    Host   : 10.25.3.82
*
* ABAP Dataflow Name:
*    DF_R3_CTS_LZ_SAP_CP1_QMEL_D
* ABAP program name in SAP:
*  ZCP1_QMEL
* Generated ABAP file name:
*    //AIRSBEAP0512/D$/Data/SAPLogistics/VAL/ABAP/ZCP1_QMEL
TABLES QMEL.
TABLES QMIH.
TABLES ILOA.
TABLES AUFK.
TABLES ZSTC_SALES_COMP.

DATA: begin of ITAB6 occurs 0,
QMNUM(12) TYPE C,
MANDT(3) TYPE C,
QMART(2) TYPE C,
QMTXT(40) TYPE C,
ARTPR(2) TYPE C,
PRIOK(1) TYPE C,
ERNAM(12) TYPE C,
ERDAT TYPE D,
AENAM(12) TYPE C,
AEDAT TYPE D,
MZEIT TYPE T,
QMDAT TYPE D,
QMNAM(12) TYPE C,
STRMN TYPE D,
LTRMN TYPE D,
WAERS(5) TYPE C,
AUFNR(12) TYPE C,
VERID(4) TYPE C,
RM_MATNR(18) TYPE C,
RM_WERKS(4) TYPE C,
SA_AUFNR(12) TYPE C,
MATNR(18) TYPE C,
REVLV(2) TYPE C,
MATKL(9) TYPE C,
PRDHA(18) TYPE C,
KZKRI(1) TYPE C,
KZDKZ(1) TYPE C,
KUNUM(10) TYPE C,
FEKNZ(1) TYPE C,
MAKNZ(1) TYPE C,
OBJNR(22) TYPE C,
QMDAB TYPE D,
RBNR(9) TYPE C,
RBNRI(1) TYPE C,
INDTX(1) TYPE C,
KZMLA(1) TYPE C,
HERKZ(2) TYPE C,
BEZDT TYPE D,
LIFNUM(10) TYPE C,
BUNAME(12) TYPE C,
VBELN(10) TYPE C,
BSTNK(35) TYPE C,
BSTDK TYPE D,
SPART(2) TYPE C,
VKORG(4) TYPE C,
VTWEG(2) TYPE C,
ADRNR(10) TYPE C,
MAWERK(4) TYPE C,
QMKAT(1) TYPE C,
QMGRP(8) TYPE C,
QMCOD(4) TYPE C,
AUSWIRK(4) TYPE C,
TEILEV(4) TYPE C,
PRUEFLOS(12) TYPE N,
CHARG(10) TYPE C,
LGORTCHARG(4) TYPE C,
LICHN(15) TYPE C,
HERSTELLER(10) TYPE C,
EMATNR(18) TYPE C,
EKORG(4) TYPE C,
BKGRP(3) TYPE C,
LGORTVORG(4) TYPE C,
FERTAUFNR(12) TYPE C,
FERTAUFPL(10) TYPE N,
EBELN(10) TYPE C,
EBELP(5) TYPE N,
MJAHR(4) TYPE N,
MBLNR(10) TYPE C,
MBLPO(4) TYPE N,
LS_KDAUF(10) TYPE C,
LS_KDPOS(6) TYPE N,
LS_VBELN(10) TYPE C,
LS_POSNR(6) TYPE N,
CROBJTY(2) TYPE C,
ARBPL(8) TYPE N,
ARBPLWERK(4) TYPE C,
FEART(8) TYPE C,
PNLKN(8) TYPE N,
MGEIG(16) TYPE P DECIMALS 3,
MGFRD(16) TYPE P DECIMALS 3,
MGEIN(3) TYPE C,
BZMNG(16) TYPE P DECIMALS 3,
RKMNG(16) TYPE P DECIMALS 3,
RGMNG(16) TYPE P DECIMALS 3,
RKDAT TYPE D,
COAUFNR(12) TYPE C,
QWRNUM(12) TYPE C,
REFNUM(20) TYPE C,
KDMAT(35) TYPE C,
IDNLF(35) TYPE C,
SERIALNR(18) TYPE C,
KZLOESCH(1) TYPE C,
PRODDAT TYPE D,
DEVICEID(40) TYPE C,
VKBUR(4) TYPE C,
VKGRP(3) TYPE C,
AUTKZ(1) TYPE C,
BEDID(12) TYPE N,
BEDZL(8) TYPE N,
PROFIL_TYP(2) TYPE C,
PROFIL_ID(8) TYPE N,
HANDLE(22) TYPE C,
TSEGFL(1) TYPE C,
TSEGTP(10) TYPE C,
TZONSO(6) TYPE C,
TZONID(1) TYPE C,
FUNKTION(4) TYPE C,
/SAPSMOSS/INSTN(10) TYPE C,
/SAPSMOSS/MNUMM(24) TYPE N,
/SAPSMOSS/OSSYS(10) TYPE C,
/SAPSMOSS/DBSYS(10) TYPE C,
/SAPSMOSS/REL(10) TYPE C,
/SAPSMOSS/COMP(20) TYPE C,
/SAPSMOSS/FRONT(10) TYPE C,
/SAPSMOSS/SYSTYP(1) TYPE C,
/SAPSMOSS/ADDID(10) TYPE C,
/SAPSMOSS/ADDREL(10) TYPE C,
/SAPSMOSS/TSTMP(14) TYPE N,
/SAPSMOSS/STATUS(1) TYPE C,
/SAPSMOSS/ERDAT TYPE D,
/SAPSMOSS/SYSID(8) TYPE C,
/SAPSMOSS/MANDT(3) TYPE C,
PSP_NR(8) TYPE N,
ESTIMATED_COSTS(16) TYPE P DECIMALS 2,
CLAIMED_COSTS(16) TYPE P DECIMALS 2,
RESULT_COSTS(16) TYPE P DECIMALS 2,
CHANCE(2) TYPE N,
OPPONENT(2) TYPE C,
KALNR(12) TYPE N,
KALVAR(4) TYPE C,
OBJNR_REAL(22) TYPE C,
OBJNR_STAT(22) TYPE C,
PHASE(1) TYPE C,
/ISDFPS/OBJNR(22) TYPE C,
LOGSYSTEM(10) TYPE C,
/ISDFPS/MEQUI(18) TYPE C,
YY_BEMOT(2) TYPE C,
IWERK(4) TYPE C,
ILOAN(12) TYPE C,
ILOAI(1) TYPE C,
EQUNR(18) TYPE C,
BAUTL(18) TYPE C,
EBORT(20) TYPE C,
MSAUS(1) TYPE C,
AUSVN TYPE D,
AUSBS TYPE D,
AUSZT TYPE F,
MAUEH(3) TYPE C,
BTPLN(30) TYPE C,
BEQUI(18) TYPE C,
AUSWK(1) TYPE C,
VERFV(3) TYPE N,
VERFN(3) TYPE N,
VERFM(3) TYPE N,
ANLZV(1) TYPE C,
ANLZN(1) TYPE C,
ANLZE(1) TYPE C,
INSPK(12) TYPE C,
INGRP(3) TYPE C,
WARPL(12) TYPE C,
ABNUM TYPE I,
WAPOS(16) TYPE C,
KDAUF(10) TYPE C,
KDPOS(6) TYPE N,
SCREENTY(4) TYPE C,
PLNTY(1) TYPE C,
PLNNR(8) TYPE C,
PLNAL(2) TYPE C,
REVNR(8) TYPE C,
ZAEHL(8) TYPE N,
TPLNR(30) TYPE C,
Z_BUKRS(4) TYPE C,
Z_VKORG(4) TYPE C,
Z_WERKS(4) TYPE C,
Z_EKORG(4) TYPE C,
Z_MAMUSERCMPY(4) TYPE C,
Z_REGION(40) TYPE C,
Z_COUNTRY(40) TYPE C,
Z_COUNTRYDSCR(255) TYPE C,
Z_SALESCOMPANY(40) TYPE C,
Z_SALESCMPDSCR(255) TYPE C.
DATA: end of ITAB6.

data: append_flag(1) value ' ',
      cntbuf type i,
      delimleng type i,last_batch(1) value ' '.

CONSTANTS C_DF_VK(40) VALUE '1671'.
CONSTANTS C_DI_GEN(40) VALUE '14.2.3.660'.
DATA WARN_MSG(50).


DATA: gv_directory     TYPE epsdirnam  VALUE '/var/load/xxx/UK/read/',
      gv_logsys        LIKE tbdlst-logsys.

start-of-selection.
* Logical system
  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = gv_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'E' NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    STOP.
  ENDIF.
  REPLACE 'xxx' IN out_dir WITH gv_logsys(3).
  REPLACE 'xxx' IN in_dir WITH gv_logsys(3).


  IF DOWNLOAD = 'S' OR
     DOWNLOAD = 'N' OR
     DOWNLOAD = 'Y'.
      .
  ELSE.
     DATA: m_xfer_err_msg(700).
     CONCATENATE
'ABAP program does not recognize this new '
'data transfer method: ' DOWNLOAD
'. Regenerate the ABAP program and upload to this system.'
     INTO m_xfer_err_msg.
     MESSAGE  E240(S#) WITH m_xfer_err_msg.
  ENDIF.

  IF EXECMODE = 'B' OR
     EXECMODE = 'D'.
      .
  ELSE.
     DATA: m_exec_err_msg(700).
     CONCATENATE
'ABAP program does not recognize this new '
'execution option: ' EXECMODE
'. Regenerate the ABAP program and upload to this system.'
     INTO m_exec_err_msg.
     MESSAGE  E240(S#) WITH m_exec_err_msg.
  ENDIF.

  IF DOWNLOAD = 'S'.
     PERFORM CONNECT_RFCDEST_TO_PROGID.
  ENDIF.



PERFORM FORM6.
last_batch = 'X'.
PERFORM FORM7.
FREE ITAB6.
  IF DOWNLOAD = 'S'.
     PERFORM DISCONNECT_RFCDEST_FROM_PROGID.
  ENDIF.


end-of-selection.

CLEAR WARN_MSG.

IF NOT P_DF_VK IS INITIAL.
  IF P_DF_VK <> C_DF_VK.
     CONCATENATE '$$Warning$'
                 C_DF_VK
                 '$' INTO WARN_MSG.
  ENDIF.
ENDIF.
IF NOT P_DI_GEN IS INITIAL.
  IF P_DI_GEN <> C_DI_GEN.
     IF WARN_MSG IS INITIAL.
       CONCATENATE '$$Warning$$'
                   C_DI_GEN
                   INTO WARN_MSG.
     ELSE.
       CONCATENATE WARN_MSG
                   C_DI_GEN
                   INTO WARN_MSG.
     ENDIF.
  ENDIF.
ENDIF.

IF NOT WARN_MSG IS INITIAL.
  IF EXECMODE = 'D'.
    WRITE WARN_MSG.
    NEW-LINE.
  ELSE.
    MESSAGE S240(S#) with WARN_MSG.
  ENDIF.
ENDIF.


write  '* Program Complete *'.
write  '(C)Copyright Business Objects S.A.  All rights reserved.'.

FORM FORM6.
DATA ALTMP188(12) TYPE C.
DATA ALTMP189(3) TYPE C.
DATA ALTMP190(2) TYPE C.
DATA ALTMP191(40) TYPE C.
DATA ALTMP192(2) TYPE C.
DATA ALTMP193(1) TYPE C.
DATA ALTMP194(12) TYPE C.
DATA ALTMP195 TYPE D.
DATA ALTMP196(12) TYPE C.
DATA ALTMP197 TYPE D.
DATA ALTMP198 TYPE T.
DATA ALTMP199 TYPE D.
DATA ALTMP200(12) TYPE C.
DATA ALTMP201 TYPE D.
DATA ALTMP202 TYPE D.
DATA ALTMP203(5) TYPE C.
DATA ALTMP204(12) TYPE C.
DATA ALTMP205(4) TYPE C.
DATA ALTMP206(18) TYPE C.
DATA ALTMP207(4) TYPE C.
DATA ALTMP208(12) TYPE C.
DATA ALTMP209(18) TYPE C.
DATA ALTMP210(2) TYPE C.
DATA ALTMP211(9) TYPE C.
DATA ALTMP212(18) TYPE C.
DATA ALTMP213(1) TYPE C.
DATA ALTMP214(1) TYPE C.
DATA ALTMP215(10) TYPE C.
DATA ALTMP216(1) TYPE C.
DATA ALTMP217(1) TYPE C.
DATA ALTMP218(22) TYPE C.
DATA ALTMP219 TYPE D.
DATA ALTMP220(9) TYPE C.
DATA ALTMP221(1) TYPE C.
DATA ALTMP222(1) TYPE C.
DATA ALTMP223(1) TYPE C.
DATA ALTMP224(2) TYPE C.
DATA ALTMP225 TYPE D.
DATA ALTMP226(10) TYPE C.
DATA ALTMP227(12) TYPE C.
DATA ALTMP228(10) TYPE C.
DATA ALTMP229(35) TYPE C.
DATA ALTMP230 TYPE D.
DATA ALTMP231(2) TYPE C.
DATA ALTMP232(4) TYPE C.
DATA ALTMP233(2) TYPE C.
DATA ALTMP234(10) TYPE C.
DATA ALTMP235(4) TYPE C.
DATA ALTMP236(1) TYPE C.
DATA ALTMP237(8) TYPE C.
DATA ALTMP238(4) TYPE C.
DATA ALTMP239(4) TYPE C.
DATA ALTMP240(4) TYPE C.
DATA ALTMP241(12) TYPE N.
DATA ALTMP242(10) TYPE C.
DATA ALTMP243(4) TYPE C.
DATA ALTMP244(15) TYPE C.
DATA ALTMP245(10) TYPE C.
DATA ALTMP246(18) TYPE C.
DATA ALTMP247(4) TYPE C.
DATA ALTMP248(3) TYPE C.
DATA ALTMP249(4) TYPE C.
DATA ALTMP250(12) TYPE C.
DATA ALTMP251(10) TYPE N.
DATA ALTMP252(10) TYPE C.
DATA ALTMP253(5) TYPE N.
DATA ALTMP254(4) TYPE N.
DATA ALTMP255(10) TYPE C.
DATA ALTMP256(4) TYPE N.
DATA ALTMP257(10) TYPE C.
DATA ALTMP258(6) TYPE N.
DATA ALTMP259(10) TYPE C.
DATA ALTMP260(6) TYPE N.
DATA ALTMP261(2) TYPE C.
DATA ALTMP262(8) TYPE N.
DATA ALTMP263(4) TYPE C.
DATA ALTMP264(8) TYPE C.
DATA ALTMP265(8) TYPE N.
DATA ALTMP266(16) TYPE P DECIMALS 3.
DATA ALTMP267(16) TYPE P DECIMALS 3.
DATA ALTMP268(3) TYPE C.
DATA ALTMP269(16) TYPE P DECIMALS 3.
DATA ALTMP270(16) TYPE P DECIMALS 3.
DATA ALTMP271(16) TYPE P DECIMALS 3.
DATA ALTMP272 TYPE D.
DATA ALTMP273(12) TYPE C.
DATA ALTMP274(12) TYPE C.
DATA ALTMP275(20) TYPE C.
DATA ALTMP276(35) TYPE C.
DATA ALTMP277(35) TYPE C.
DATA ALTMP278(18) TYPE C.
DATA ALTMP279(1) TYPE C.
DATA ALTMP280 TYPE D.
DATA ALTMP281(40) TYPE C.
DATA ALTMP282(4) TYPE C.
DATA ALTMP283(3) TYPE C.
DATA ALTMP284(1) TYPE C.
DATA ALTMP285(12) TYPE N.
DATA ALTMP286(8) TYPE N.
DATA ALTMP287(2) TYPE C.
DATA ALTMP288(8) TYPE N.
DATA ALTMP289(22) TYPE C.
DATA ALTMP290(1) TYPE C.
DATA ALTMP291(10) TYPE C.
DATA ALTMP292(6) TYPE C.
DATA ALTMP293(1) TYPE C.
DATA ALTMP294(4) TYPE C.
DATA ALTMP295(10) TYPE C.
DATA ALTMP296(24) TYPE N.
DATA ALTMP297(10) TYPE C.
DATA ALTMP298(10) TYPE C.
DATA ALTMP299(10) TYPE C.
DATA ALTMP300(20) TYPE C.
DATA ALTMP301(10) TYPE C.
DATA ALTMP302(1) TYPE C.
DATA ALTMP303(10) TYPE C.
DATA ALTMP304(10) TYPE C.
DATA ALTMP305(14) TYPE N.
DATA ALTMP306(1) TYPE C.
DATA ALTMP307 TYPE D.
DATA ALTMP308(8) TYPE C.
DATA ALTMP309(3) TYPE C.
DATA ALTMP310(8) TYPE N.
DATA ALTMP311(16) TYPE P DECIMALS 2.
DATA ALTMP312(16) TYPE P DECIMALS 2.
DATA ALTMP313(16) TYPE P DECIMALS 2.
DATA ALTMP314(2) TYPE N.
DATA ALTMP315(2) TYPE C.
DATA ALTMP316(12) TYPE N.
DATA ALTMP317(4) TYPE C.
DATA ALTMP318(22) TYPE C.
DATA ALTMP319(22) TYPE C.
DATA ALTMP320(1) TYPE C.
DATA ALTMP321(22) TYPE C.
DATA ALTMP322(10) TYPE C.
DATA ALTMP323(18) TYPE C.
DATA ALTMP324(2) TYPE C.
DATA ALTMP325(4) TYPE C.
DATA ALTMP326(12) TYPE C.
DATA ALTMP327(1) TYPE C.
DATA ALTMP328(18) TYPE C.
DATA ALTMP329(18) TYPE C.
DATA ALTMP330(20) TYPE C.
DATA ALTMP331(1) TYPE C.
DATA ALTMP332 TYPE D.
DATA ALTMP333 TYPE D.
DATA ALTMP334 TYPE F.
DATA ALTMP335(3) TYPE C.
DATA ALTMP336(30) TYPE C.
DATA ALTMP337(18) TYPE C.
DATA ALTMP338(1) TYPE C.
DATA ALTMP339(3) TYPE N.
DATA ALTMP340(3) TYPE N.
DATA ALTMP341(3) TYPE N.
DATA ALTMP342(1) TYPE C.
DATA ALTMP343(1) TYPE C.
DATA ALTMP344(1) TYPE C.
DATA ALTMP345(12) TYPE C.
DATA ALTMP346(3) TYPE C.
DATA ALTMP347(12) TYPE C.
DATA ALTMP348 TYPE I.
DATA ALTMP349(16) TYPE C.
DATA ALTMP350(10) TYPE C.
DATA ALTMP351(6) TYPE N.
DATA ALTMP352(4) TYPE C.
DATA ALTMP353(1) TYPE C.
DATA ALTMP354(8) TYPE C.
DATA ALTMP355(2) TYPE C.
DATA ALTMP356(8) TYPE C.
DATA ALTMP357(8) TYPE N.
DATA ALTMP358(30) TYPE C.
DATA ALTMP359(4) TYPE C.
DATA ALTMP360(4) TYPE C.
DATA ALTMP361(4) TYPE C.
DATA ALTMP362(4) TYPE C.
DATA ALTMP363(4) TYPE C.
DATA ALTMP364(40) TYPE C.
DATA ALTMP365(40) TYPE C.
DATA ALTMP366(255) TYPE C.
DATA ALTMP367(40) TYPE C.
DATA ALTMP368(255) TYPE C.

DATA QMEL9QMNUM LIKE QMEL-QMNUM.
DATA QMEL9MANDT LIKE QMEL-MANDT.
DATA QMEL9QMART LIKE QMEL-QMART.
DATA QMEL9QMTXT LIKE QMEL-QMTXT.
DATA QMEL9ARTPR LIKE QMEL-ARTPR.
DATA QMEL9PRIOK LIKE QMEL-PRIOK.
DATA QMEL9ERNAM LIKE QMEL-ERNAM.
DATA QMEL9ERDAT LIKE QMEL-ERDAT.
DATA QMEL9AENAM LIKE QMEL-AENAM.
DATA QMEL9AEDAT LIKE QMEL-AEDAT.
DATA QMEL9MZEIT LIKE QMEL-MZEIT.
DATA QMEL9QMDAT LIKE QMEL-QMDAT.
DATA QMEL9QMNAM LIKE QMEL-QMNAM.
DATA QMEL9STRMN LIKE QMEL-STRMN.
DATA QMEL9LTRMN LIKE QMEL-LTRMN.
DATA QMEL9WAERS LIKE QMEL-WAERS.
DATA QMEL9AUFNR LIKE QMEL-AUFNR.
DATA QMEL9VERID LIKE QMEL-VERID.
DATA QMEL9RM_MATNR LIKE QMEL-RM_MATNR.
DATA QMEL9RM_WERKS LIKE QMEL-RM_WERKS.
DATA QMEL9SA_AUFNR LIKE QMEL-SA_AUFNR.
DATA QMEL9MATNR LIKE QMEL-MATNR.
DATA QMEL9REVLV LIKE QMEL-REVLV.
DATA QMEL9MATKL LIKE QMEL-MATKL.
DATA QMEL9PRDHA LIKE QMEL-PRDHA.
DATA QMEL9KZKRI LIKE QMEL-KZKRI.
DATA QMEL9KZDKZ LIKE QMEL-KZDKZ.
DATA QMEL9KUNUM LIKE QMEL-KUNUM.
DATA QMEL9FEKNZ LIKE QMEL-FEKNZ.
DATA QMEL9MAKNZ LIKE QMEL-MAKNZ.
DATA QMEL9OBJNR LIKE QMEL-OBJNR.
DATA QMEL9QMDAB LIKE QMEL-QMDAB.
DATA QMEL9RBNR LIKE QMEL-RBNR.
DATA QMEL9RBNRI LIKE QMEL-RBNRI.
DATA QMEL9INDTX LIKE QMEL-INDTX.
DATA QMEL9KZMLA LIKE QMEL-KZMLA.
DATA QMEL9HERKZ LIKE QMEL-HERKZ.
DATA QMEL9BEZDT LIKE QMEL-BEZDT.
DATA QMEL9LIFNUM LIKE QMEL-LIFNUM.
DATA QMEL9BUNAME LIKE QMEL-BUNAME.
DATA QMEL9VBELN LIKE QMEL-VBELN.
DATA QMEL9BSTNK LIKE QMEL-BSTNK.
DATA QMEL9BSTDK LIKE QMEL-BSTDK.
DATA QMEL9SPART LIKE QMEL-SPART.
DATA QMEL9VKORG LIKE QMEL-VKORG.
DATA QMEL9VTWEG LIKE QMEL-VTWEG.
DATA QMEL9ADRNR LIKE QMEL-ADRNR.
DATA QMEL9MAWERK LIKE QMEL-MAWERK.
DATA QMEL9QMKAT LIKE QMEL-QMKAT.
DATA QMEL9QMGRP LIKE QMEL-QMGRP.
DATA QMEL9QMCOD LIKE QMEL-QMCOD.
DATA QMEL9AUSWIRK LIKE QMEL-AUSWIRK.
DATA QMEL9TEILEV LIKE QMEL-TEILEV.
DATA QMEL9PRUEFLOS LIKE QMEL-PRUEFLOS.
DATA QMEL9CHARG LIKE QMEL-CHARG.
DATA QMEL9LGORTCHARG LIKE QMEL-LGORTCHARG.
DATA QMEL9LICHN LIKE QMEL-LICHN.
DATA QMEL9HERSTELLER LIKE QMEL-HERSTELLER.
DATA QMEL9EMATNR LIKE QMEL-EMATNR.
DATA QMEL9EKORG LIKE QMEL-EKORG.
DATA QMEL9BKGRP LIKE QMEL-BKGRP.
DATA QMEL9LGORTVORG LIKE QMEL-LGORTVORG.
DATA QMEL9FERTAUFNR LIKE QMEL-FERTAUFNR.
DATA QMEL9FERTAUFPL LIKE QMEL-FERTAUFPL.
DATA QMEL9EBELN LIKE QMEL-EBELN.
DATA QMEL9EBELP LIKE QMEL-EBELP.
DATA QMEL9MJAHR LIKE QMEL-MJAHR.
DATA QMEL9MBLNR LIKE QMEL-MBLNR.
DATA QMEL9MBLPO LIKE QMEL-MBLPO.
DATA QMEL9LS_KDAUF LIKE QMEL-LS_KDAUF.
DATA QMEL9LS_KDPOS LIKE QMEL-LS_KDPOS.
DATA QMEL9LS_VBELN LIKE QMEL-LS_VBELN.
DATA QMEL9LS_POSNR LIKE QMEL-LS_POSNR.
DATA QMEL9CROBJTY LIKE QMEL-CROBJTY.
DATA QMEL9ARBPL LIKE QMEL-ARBPL.
DATA QMEL9ARBPLWERK LIKE QMEL-ARBPLWERK.
DATA QMEL9FEART LIKE QMEL-FEART.
DATA QMEL9PNLKN LIKE QMEL-PNLKN.
DATA QMEL9MGEIG LIKE QMEL-MGEIG.
DATA QMEL9MGFRD LIKE QMEL-MGFRD.
DATA QMEL9MGEIN LIKE QMEL-MGEIN.
DATA QMEL9BZMNG LIKE QMEL-BZMNG.
DATA QMEL9RKMNG LIKE QMEL-RKMNG.
DATA QMEL9RGMNG LIKE QMEL-RGMNG.
DATA QMEL9RKDAT LIKE QMEL-RKDAT.
DATA QMEL9COAUFNR LIKE QMEL-COAUFNR.
DATA QMEL9QWRNUM LIKE QMEL-QWRNUM.
DATA QMEL9REFNUM LIKE QMEL-REFNUM.
DATA QMEL9KDMAT LIKE QMEL-KDMAT.
DATA QMEL9IDNLF LIKE QMEL-IDNLF.
DATA QMEL9SERIALNR LIKE QMEL-SERIALNR.
DATA QMEL9KZLOESCH LIKE QMEL-KZLOESCH.
DATA QMEL9PRODDAT LIKE QMEL-PRODDAT.
DATA QMEL9DEVICEID LIKE QMEL-DEVICEID.
DATA QMEL9VKBUR LIKE QMEL-VKBUR.
DATA QMEL9VKGRP LIKE QMEL-VKGRP.
DATA QMEL9AUTKZ LIKE QMEL-AUTKZ.
DATA QMEL9BEDID LIKE QMEL-BEDID.
DATA QMEL9BEDZL LIKE QMEL-BEDZL.
DATA QMEL9PROFIL_TYP LIKE QMEL-PROFIL_TYP.
DATA QMEL9PROFIL_ID LIKE QMEL-PROFIL_ID.
DATA QMEL9HANDLE LIKE QMEL-HANDLE.
DATA QMEL9TSEGFL LIKE QMEL-TSEGFL.
DATA QMEL9TSEGTP LIKE QMEL-TSEGTP.
DATA QMEL9TZONSO LIKE QMEL-TZONSO.
DATA QMEL9TZONID LIKE QMEL-TZONID.
DATA QMEL9FUNKTION LIKE QMEL-FUNKTION.
DATA QMEL9/SAPSMOSS/INSTN LIKE QMEL-/SAPSMOSS/INSTN.
DATA QMEL9/SAPSMOSS/MNUMM LIKE QMEL-/SAPSMOSS/MNUMM.
DATA QMEL9/SAPSMOSS/OSSYS LIKE QMEL-/SAPSMOSS/OSSYS.
DATA QMEL9/SAPSMOSS/DBSYS LIKE QMEL-/SAPSMOSS/DBSYS.
DATA QMEL9/SAPSMOSS/REL LIKE QMEL-/SAPSMOSS/REL.
DATA QMEL9/SAPSMOSS/COMP LIKE QMEL-/SAPSMOSS/COMP.
DATA QMEL9/SAPSMOSS/FRONT LIKE QMEL-/SAPSMOSS/FRONT.
DATA QMEL9/SAPSMOSS/SYSTYP LIKE QMEL-/SAPSMOSS/SYSTYP.
DATA QMEL9/SAPSMOSS/ADDID LIKE QMEL-/SAPSMOSS/ADDID.
DATA QMEL9/SAPSMOSS/ADDREL LIKE QMEL-/SAPSMOSS/ADDREL.
DATA QMEL9/SAPSMOSS/TSTMP LIKE QMEL-/SAPSMOSS/TSTMP.
DATA QMEL9/SAPSMOSS/STATUS LIKE QMEL-/SAPSMOSS/STATUS.
DATA QMEL9/SAPSMOSS/ERDAT LIKE QMEL-/SAPSMOSS/ERDAT.
DATA QMEL9/SAPSMOSS/SYSID LIKE QMEL-/SAPSMOSS/SYSID.
DATA QMEL9/SAPSMOSS/MANDT LIKE QMEL-/SAPSMOSS/MANDT.
DATA QMEL9PSP_NR LIKE QMEL-PSP_NR.
DATA QMEL9ESTIMATED_COSTS LIKE QMEL-ESTIMATED_COSTS.
DATA QMEL9CLAIMED_COSTS LIKE QMEL-CLAIMED_COSTS.
DATA QMEL9RESULT_COSTS LIKE QMEL-RESULT_COSTS.
DATA QMEL9CHANCE LIKE QMEL-CHANCE.
DATA QMEL9OPPONENT LIKE QMEL-OPPONENT.
DATA QMEL9KALNR LIKE QMEL-KALNR.
DATA QMEL9KALVAR LIKE QMEL-KALVAR.
DATA QMEL9OBJNR_REAL LIKE QMEL-OBJNR_REAL.
DATA QMEL9OBJNR_STAT LIKE QMEL-OBJNR_STAT.
DATA QMEL9PHASE LIKE QMEL-PHASE.
DATA QMEL9/ISDFPS/OBJNR LIKE QMEL-/ISDFPS/OBJNR.
DATA QMEL9LOGSYSTEM LIKE QMEL-LOGSYSTEM.
DATA QMEL9/ISDFPS/MEQUI LIKE QMEL-/ISDFPS/MEQUI.
DATA QMEL9YY_BEMOT LIKE QMEL-YY_BEMOT.
DATA QMIH9IWERK LIKE QMIH-IWERK.
DATA QMIH9ILOAN LIKE QMIH-ILOAN.
DATA QMIH9ILOAI LIKE QMIH-ILOAI.
DATA QMIH9EQUNR LIKE QMIH-EQUNR.
DATA QMIH9BAUTL LIKE QMIH-BAUTL.
DATA QMIH9EBORT LIKE QMIH-EBORT.
DATA QMIH9MSAUS LIKE QMIH-MSAUS.
DATA QMIH9AUSVN LIKE QMIH-AUSVN.
DATA QMIH9AUSBS LIKE QMIH-AUSBS.
DATA QMIH9AUSZT LIKE QMIH-AUSZT.
DATA QMIH9MAUEH LIKE QMIH-MAUEH.
DATA QMIH9BTPLN LIKE QMIH-BTPLN.
DATA QMIH9BEQUI LIKE QMIH-BEQUI.
DATA QMIH9AUSWK LIKE QMIH-AUSWK.
DATA QMIH9VERFV LIKE QMIH-VERFV.
DATA QMIH9VERFN LIKE QMIH-VERFN.
DATA QMIH9VERFM LIKE QMIH-VERFM.
DATA QMIH9ANLZV LIKE QMIH-ANLZV.
DATA QMIH9ANLZN LIKE QMIH-ANLZN.
DATA QMIH9ANLZE LIKE QMIH-ANLZE.
DATA QMIH9INSPK LIKE QMIH-INSPK.
DATA QMIH9INGRP LIKE QMIH-INGRP.
DATA QMIH9WARPL LIKE QMIH-WARPL.
DATA QMIH9ABNUM LIKE QMIH-ABNUM.
DATA QMIH9WAPOS LIKE QMIH-WAPOS.
DATA QMIH9KDAUF LIKE QMIH-KDAUF.
DATA QMIH9KDPOS LIKE QMIH-KDPOS.
DATA QMIH9SCREENTY LIKE QMIH-SCREENTY.
DATA QMIH9PLNTY LIKE QMIH-PLNTY.
DATA QMIH9PLNNR LIKE QMIH-PLNNR.
DATA QMIH9PLNAL LIKE QMIH-PLNAL.
DATA QMIH9REVNR LIKE QMIH-REVNR.
DATA QMIH9ZAEHL LIKE QMIH-ZAEHL.
DATA ILOA9TPLNR LIKE ILOA-TPLNR.
DATA ZSTC_SALE_019BUKRS LIKE ZSTC_SALES_COMP-BUKRS.
DATA ZSTC_SALE_019VKORG LIKE ZSTC_SALES_COMP-VKORG.
DATA ZSTC_SALE_019WERKS LIKE ZSTC_SALES_COMP-WERKS.
DATA ZSTC_SALE_019EKORG LIKE ZSTC_SALES_COMP-EKORG.
DATA ZSTC_SALE_019MAMUSERCMPY LIKE ZSTC_SALES_COMP-MAMUSERCMPY.
DATA ZSTC_SALE_019REGION LIKE ZSTC_SALES_COMP-REGION.
DATA ZSTC_SALE_019COUNTRY LIKE ZSTC_SALES_COMP-COUNTRY.
DATA ZSTC_SALE_019COUNTRYDSCR LIKE ZSTC_SALES_COMP-COUNTRYDSCR.
DATA ZSTC_SALE_019SALESCOMPANY LIKE ZSTC_SALES_COMP-SALESCOMPANY.
DATA ZSTC_SALE_019SALESCMPDSCR LIKE ZSTC_SALES_COMP-SALESCMPDSCR.
DATA AUFK9IDAT3 LIKE AUFK-IDAT3.
DATA AUFK9AUFNR LIKE AUFK-AUFNR.
DATA ILOA9ILOAN LIKE ILOA-ILOAN.
DATA QMIH9QMNUM LIKE QMIH-QMNUM.



SELECT
  QMEL9~QMNUM
  QMEL9~MANDT
  QMEL9~QMART
  QMEL9~QMTXT
  QMEL9~ARTPR
  QMEL9~PRIOK
  QMEL9~ERNAM
  QMEL9~ERDAT
  QMEL9~AENAM
  QMEL9~AEDAT
  QMEL9~MZEIT
  QMEL9~QMDAT
  QMEL9~QMNAM
  QMEL9~STRMN
  QMEL9~LTRMN
  QMEL9~WAERS
  QMEL9~AUFNR
  QMEL9~VERID
  QMEL9~RM_MATNR
  QMEL9~RM_WERKS
  QMEL9~SA_AUFNR
  QMEL9~MATNR
  QMEL9~REVLV
  QMEL9~MATKL
  QMEL9~PRDHA
  QMEL9~KZKRI
  QMEL9~KZDKZ
  QMEL9~KUNUM
  QMEL9~FEKNZ
  QMEL9~MAKNZ
  QMEL9~OBJNR
  QMEL9~QMDAB
  QMEL9~RBNR
  QMEL9~RBNRI
  QMEL9~INDTX
  QMEL9~KZMLA
  QMEL9~HERKZ
  QMEL9~BEZDT
  QMEL9~LIFNUM
  QMEL9~BUNAME
  QMEL9~VBELN
  QMEL9~BSTNK
  QMEL9~BSTDK
  QMEL9~SPART
  QMEL9~VKORG
  QMEL9~VTWEG
  QMEL9~ADRNR
  QMEL9~MAWERK
  QMEL9~QMKAT
  QMEL9~QMGRP
  QMEL9~QMCOD
  QMEL9~AUSWIRK
  QMEL9~TEILEV
  QMEL9~PRUEFLOS
  QMEL9~CHARG
  QMEL9~LGORTCHARG
  QMEL9~LICHN
  QMEL9~HERSTELLER
  QMEL9~EMATNR
  QMEL9~EKORG
  QMEL9~BKGRP
  QMEL9~LGORTVORG
  QMEL9~FERTAUFNR
  QMEL9~FERTAUFPL
  QMEL9~EBELN
  QMEL9~EBELP
  QMEL9~MJAHR
  QMEL9~MBLNR
  QMEL9~MBLPO
  QMEL9~LS_KDAUF
  QMEL9~LS_KDPOS
  QMEL9~LS_VBELN
  QMEL9~LS_POSNR
  QMEL9~CROBJTY
  QMEL9~ARBPL
  QMEL9~ARBPLWERK
  QMEL9~FEART
  QMEL9~PNLKN
  QMEL9~MGEIG
  QMEL9~MGFRD
  QMEL9~MGEIN
  QMEL9~BZMNG
  QMEL9~RKMNG
  QMEL9~RGMNG
  QMEL9~RKDAT
  QMEL9~COAUFNR
  QMEL9~QWRNUM
  QMEL9~REFNUM
  QMEL9~KDMAT
  QMEL9~IDNLF
  QMEL9~SERIALNR
  QMEL9~KZLOESCH
  QMEL9~PRODDAT
  QMEL9~DEVICEID
  QMEL9~VKBUR
  QMEL9~VKGRP
  QMEL9~AUTKZ
  QMEL9~BEDID
  QMEL9~BEDZL
  QMEL9~PROFIL_TYP
  QMEL9~PROFIL_ID
  QMEL9~HANDLE
  QMEL9~TSEGFL
  QMEL9~TSEGTP
  QMEL9~TZONSO
  QMEL9~TZONID
  QMEL9~FUNKTION
  QMEL9~/SAPSMOSS/INSTN
  QMEL9~/SAPSMOSS/MNUMM
  QMEL9~/SAPSMOSS/OSSYS
  QMEL9~/SAPSMOSS/DBSYS
  QMEL9~/SAPSMOSS/REL
  QMEL9~/SAPSMOSS/COMP
  QMEL9~/SAPSMOSS/FRONT
  QMEL9~/SAPSMOSS/SYSTYP
  QMEL9~/SAPSMOSS/ADDID
  QMEL9~/SAPSMOSS/ADDREL
  QMEL9~/SAPSMOSS/TSTMP
  QMEL9~/SAPSMOSS/STATUS
  QMEL9~/SAPSMOSS/ERDAT
  QMEL9~/SAPSMOSS/SYSID
  QMEL9~/SAPSMOSS/MANDT
  QMEL9~PSP_NR
  QMEL9~ESTIMATED_COSTS
  QMEL9~CLAIMED_COSTS
  QMEL9~RESULT_COSTS
  QMEL9~CHANCE
  QMEL9~OPPONENT
  QMEL9~KALNR
  QMEL9~KALVAR
  QMEL9~OBJNR_REAL
  QMEL9~OBJNR_STAT
  QMEL9~PHASE
  QMEL9~/ISDFPS/OBJNR
  QMEL9~LOGSYSTEM
  QMEL9~/ISDFPS/MEQUI
  QMEL9~YY_BEMOT
  QMIH9~IWERK
  QMIH9~ILOAN
  QMIH9~ILOAI
  QMIH9~EQUNR
  QMIH9~BAUTL
  QMIH9~EBORT
  QMIH9~MSAUS
  QMIH9~AUSVN
  QMIH9~AUSBS
  QMIH9~AUSZT
  QMIH9~MAUEH
  QMIH9~BTPLN
  QMIH9~BEQUI
  QMIH9~AUSWK
  QMIH9~VERFV
  QMIH9~VERFN
  QMIH9~VERFM
  QMIH9~ANLZV
  QMIH9~ANLZN
  QMIH9~ANLZE
  QMIH9~INSPK
  QMIH9~INGRP
  QMIH9~WARPL
  QMIH9~ABNUM
  QMIH9~WAPOS
  QMIH9~KDAUF
  QMIH9~KDPOS
  QMIH9~SCREENTY
  QMIH9~PLNTY
  QMIH9~PLNNR
  QMIH9~PLNAL
  QMIH9~REVNR
  QMIH9~ZAEHL
  ILOA9~TPLNR
  ZSTC_SALE_019~BUKRS
  ZSTC_SALE_019~VKORG
  ZSTC_SALE_019~WERKS
  ZSTC_SALE_019~EKORG
  ZSTC_SALE_019~MAMUSERCMPY
  ZSTC_SALE_019~REGION
  ZSTC_SALE_019~COUNTRY
  ZSTC_SALE_019~COUNTRYDSCR
  ZSTC_SALE_019~SALESCOMPANY
  ZSTC_SALE_019~SALESCMPDSCR
  AUFK9~IDAT3
  AUFK9~AUFNR
  ILOA9~ILOAN
  QMIH9~QMNUM
into (QMEL9QMNUM,
  QMEL9MANDT,
  QMEL9QMART,
  QMEL9QMTXT,
  QMEL9ARTPR,
  QMEL9PRIOK,
  QMEL9ERNAM,
  QMEL9ERDAT,
  QMEL9AENAM,
  QMEL9AEDAT,
  QMEL9MZEIT,
  QMEL9QMDAT,
  QMEL9QMNAM,
  QMEL9STRMN,
  QMEL9LTRMN,
  QMEL9WAERS,
  QMEL9AUFNR,
  QMEL9VERID,
  QMEL9RM_MATNR,
  QMEL9RM_WERKS,
  QMEL9SA_AUFNR,
  QMEL9MATNR,
  QMEL9REVLV,
  QMEL9MATKL,
  QMEL9PRDHA,
  QMEL9KZKRI,
  QMEL9KZDKZ,
  QMEL9KUNUM,
  QMEL9FEKNZ,
  QMEL9MAKNZ,
  QMEL9OBJNR,
  QMEL9QMDAB,
  QMEL9RBNR,
  QMEL9RBNRI,
  QMEL9INDTX,
  QMEL9KZMLA,
  QMEL9HERKZ,
  QMEL9BEZDT,
  QMEL9LIFNUM,
  QMEL9BUNAME,
  QMEL9VBELN,
  QMEL9BSTNK,
  QMEL9BSTDK,
  QMEL9SPART,
  QMEL9VKORG,
  QMEL9VTWEG,
  QMEL9ADRNR,
  QMEL9MAWERK,
  QMEL9QMKAT,
  QMEL9QMGRP,
  QMEL9QMCOD,
  QMEL9AUSWIRK,
  QMEL9TEILEV,
  QMEL9PRUEFLOS,
  QMEL9CHARG,
  QMEL9LGORTCHARG,
  QMEL9LICHN,
  QMEL9HERSTELLER,
  QMEL9EMATNR,
  QMEL9EKORG,
  QMEL9BKGRP,
  QMEL9LGORTVORG,
  QMEL9FERTAUFNR,
  QMEL9FERTAUFPL,
  QMEL9EBELN,
  QMEL9EBELP,
  QMEL9MJAHR,
  QMEL9MBLNR,
  QMEL9MBLPO,
  QMEL9LS_KDAUF,
  QMEL9LS_KDPOS,
  QMEL9LS_VBELN,
  QMEL9LS_POSNR,
  QMEL9CROBJTY,
  QMEL9ARBPL,
  QMEL9ARBPLWERK,
  QMEL9FEART,
  QMEL9PNLKN,
  QMEL9MGEIG,
  QMEL9MGFRD,
  QMEL9MGEIN,
  QMEL9BZMNG,
  QMEL9RKMNG,
  QMEL9RGMNG,
  QMEL9RKDAT,
  QMEL9COAUFNR,
  QMEL9QWRNUM,
  QMEL9REFNUM,
  QMEL9KDMAT,
  QMEL9IDNLF,
  QMEL9SERIALNR,
  QMEL9KZLOESCH,
  QMEL9PRODDAT,
  QMEL9DEVICEID,
  QMEL9VKBUR,
  QMEL9VKGRP,
  QMEL9AUTKZ,
  QMEL9BEDID,
  QMEL9BEDZL,
  QMEL9PROFIL_TYP,
  QMEL9PROFIL_ID,
  QMEL9HANDLE,
  QMEL9TSEGFL,
  QMEL9TSEGTP,
  QMEL9TZONSO,
  QMEL9TZONID,
  QMEL9FUNKTION,
  QMEL9/SAPSMOSS/INSTN,
  QMEL9/SAPSMOSS/MNUMM,
  QMEL9/SAPSMOSS/OSSYS,
  QMEL9/SAPSMOSS/DBSYS,
  QMEL9/SAPSMOSS/REL,
  QMEL9/SAPSMOSS/COMP,
  QMEL9/SAPSMOSS/FRONT,
  QMEL9/SAPSMOSS/SYSTYP,
  QMEL9/SAPSMOSS/ADDID,
  QMEL9/SAPSMOSS/ADDREL,
  QMEL9/SAPSMOSS/TSTMP,
  QMEL9/SAPSMOSS/STATUS,
  QMEL9/SAPSMOSS/ERDAT,
  QMEL9/SAPSMOSS/SYSID,
  QMEL9/SAPSMOSS/MANDT,
  QMEL9PSP_NR,
  QMEL9ESTIMATED_COSTS,
  QMEL9CLAIMED_COSTS,
  QMEL9RESULT_COSTS,
  QMEL9CHANCE,
  QMEL9OPPONENT,
  QMEL9KALNR,
  QMEL9KALVAR,
  QMEL9OBJNR_REAL,
  QMEL9OBJNR_STAT,
  QMEL9PHASE,
  QMEL9/ISDFPS/OBJNR,
  QMEL9LOGSYSTEM,
  QMEL9/ISDFPS/MEQUI,
  QMEL9YY_BEMOT,
  QMIH9IWERK,
  QMIH9ILOAN,
  QMIH9ILOAI,
  QMIH9EQUNR,
  QMIH9BAUTL,
  QMIH9EBORT,
  QMIH9MSAUS,
  QMIH9AUSVN,
  QMIH9AUSBS,
  QMIH9AUSZT,
  QMIH9MAUEH,
  QMIH9BTPLN,
  QMIH9BEQUI,
  QMIH9AUSWK,
  QMIH9VERFV,
  QMIH9VERFN,
  QMIH9VERFM,
  QMIH9ANLZV,
  QMIH9ANLZN,
  QMIH9ANLZE,
  QMIH9INSPK,
  QMIH9INGRP,
  QMIH9WARPL,
  QMIH9ABNUM,
  QMIH9WAPOS,
  QMIH9KDAUF,
  QMIH9KDPOS,
  QMIH9SCREENTY,
  QMIH9PLNTY,
  QMIH9PLNNR,
  QMIH9PLNAL,
  QMIH9REVNR,
  QMIH9ZAEHL,
  ILOA9TPLNR,
  ZSTC_SALE_019BUKRS,
  ZSTC_SALE_019VKORG,
  ZSTC_SALE_019WERKS,
  ZSTC_SALE_019EKORG,
  ZSTC_SALE_019MAMUSERCMPY,
  ZSTC_SALE_019REGION,
  ZSTC_SALE_019COUNTRY,
  ZSTC_SALE_019COUNTRYDSCR,
  ZSTC_SALE_019SALESCOMPANY,
  ZSTC_SALE_019SALESCMPDSCR,
  AUFK9IDAT3,
  AUFK9AUFNR,
  ILOA9ILOAN,
  QMIH9QMNUM)
FROM QMEL AS QMEL9
 INNER JOIN AUFK AS AUFK9
 ON ( QMEL9~AUFNR = AUFK9~AUFNR )
 INNER JOIN QMIH AS QMIH9
 ON ( QMEL9~QMNUM = QMIH9~QMNUM )
 INNER JOIN ZSTC_SALES_COMP AS ZSTC_SALE_019
 ON ( QMEL9~VKORG = ZSTC_SALE_019~VKORG )
 INNER JOIN ILOA AS ILOA9
 ON ( QMIH9~ILOAN = ILOA9~ILOAN )
WHERE ( ( AUFK9~IDAT3 <= $PARAM1 )
 OR ( AUFK9~IDAT3 >= $PARAM2 ) ).
ALTMP188 = QMEL9QMNUM.
ALTMP189 = QMEL9MANDT.
ALTMP190 = QMEL9QMART.
ALTMP191 = QMEL9QMTXT.
ALTMP192 = QMEL9ARTPR.
ALTMP193 = QMEL9PRIOK.
ALTMP194 = QMEL9ERNAM.
ALTMP195 = QMEL9ERDAT.
ALTMP196 = QMEL9AENAM.
ALTMP197 = QMEL9AEDAT.
ALTMP198 = QMEL9MZEIT.
ALTMP199 = QMEL9QMDAT.
ALTMP200 = QMEL9QMNAM.
ALTMP201 = QMEL9STRMN.
ALTMP202 = QMEL9LTRMN.
ALTMP203 = QMEL9WAERS.
ALTMP204 = QMEL9AUFNR.
ALTMP205 = QMEL9VERID.
ALTMP206 = QMEL9RM_MATNR.
ALTMP207 = QMEL9RM_WERKS.
ALTMP208 = QMEL9SA_AUFNR.
ALTMP209 = QMEL9MATNR.
ALTMP210 = QMEL9REVLV.
ALTMP211 = QMEL9MATKL.
ALTMP212 = QMEL9PRDHA.
ALTMP213 = QMEL9KZKRI.
ALTMP214 = QMEL9KZDKZ.
ALTMP215 = QMEL9KUNUM.
ALTMP216 = QMEL9FEKNZ.
ALTMP217 = QMEL9MAKNZ.
ALTMP218 = QMEL9OBJNR.
ALTMP219 = QMEL9QMDAB.
ALTMP220 = QMEL9RBNR.
ALTMP221 = QMEL9RBNRI.
ALTMP222 = QMEL9INDTX.
ALTMP223 = QMEL9KZMLA.
ALTMP224 = QMEL9HERKZ.
ALTMP225 = QMEL9BEZDT.
ALTMP226 = QMEL9LIFNUM.
ALTMP227 = QMEL9BUNAME.
ALTMP228 = QMEL9VBELN.
ALTMP229 = QMEL9BSTNK.
ALTMP230 = QMEL9BSTDK.
ALTMP231 = QMEL9SPART.
ALTMP232 = QMEL9VKORG.
ALTMP233 = QMEL9VTWEG.
ALTMP234 = QMEL9ADRNR.
ALTMP235 = QMEL9MAWERK.
ALTMP236 = QMEL9QMKAT.
ALTMP237 = QMEL9QMGRP.
ALTMP238 = QMEL9QMCOD.
ALTMP239 = QMEL9AUSWIRK.
ALTMP240 = QMEL9TEILEV.
ALTMP241 = QMEL9PRUEFLOS.
ALTMP242 = QMEL9CHARG.
ALTMP243 = QMEL9LGORTCHARG.
ALTMP244 = QMEL9LICHN.
ALTMP245 = QMEL9HERSTELLER.
ALTMP246 = QMEL9EMATNR.
ALTMP247 = QMEL9EKORG.
ALTMP248 = QMEL9BKGRP.
ALTMP249 = QMEL9LGORTVORG.
ALTMP250 = QMEL9FERTAUFNR.
ALTMP251 = QMEL9FERTAUFPL.
ALTMP252 = QMEL9EBELN.
ALTMP253 = QMEL9EBELP.
ALTMP254 = QMEL9MJAHR.
ALTMP255 = QMEL9MBLNR.
ALTMP256 = QMEL9MBLPO.
ALTMP257 = QMEL9LS_KDAUF.
ALTMP258 = QMEL9LS_KDPOS.
ALTMP259 = QMEL9LS_VBELN.
ALTMP260 = QMEL9LS_POSNR.
ALTMP261 = QMEL9CROBJTY.
ALTMP262 = QMEL9ARBPL.
ALTMP263 = QMEL9ARBPLWERK.
ALTMP264 = QMEL9FEART.
ALTMP265 = QMEL9PNLKN.
ALTMP266 = QMEL9MGEIG.
ALTMP267 = QMEL9MGFRD.
ALTMP268 = QMEL9MGEIN.
ALTMP269 = QMEL9BZMNG.
ALTMP270 = QMEL9RKMNG.
ALTMP271 = QMEL9RGMNG.
ALTMP272 = QMEL9RKDAT.
ALTMP273 = QMEL9COAUFNR.
ALTMP274 = QMEL9QWRNUM.
ALTMP275 = QMEL9REFNUM.
ALTMP276 = QMEL9KDMAT.
ALTMP277 = QMEL9IDNLF.
ALTMP278 = QMEL9SERIALNR.
ALTMP279 = QMEL9KZLOESCH.
ALTMP280 = QMEL9PRODDAT.
ALTMP281 = QMEL9DEVICEID.
ALTMP282 = QMEL9VKBUR.
ALTMP283 = QMEL9VKGRP.
ALTMP284 = QMEL9AUTKZ.
ALTMP285 = QMEL9BEDID.
ALTMP286 = QMEL9BEDZL.
ALTMP287 = QMEL9PROFIL_TYP.
ALTMP288 = QMEL9PROFIL_ID.
ALTMP289 = QMEL9HANDLE.
ALTMP290 = QMEL9TSEGFL.
ALTMP291 = QMEL9TSEGTP.
ALTMP292 = QMEL9TZONSO.
ALTMP293 = QMEL9TZONID.
ALTMP294 = QMEL9FUNKTION.
ALTMP295 = QMEL9/SAPSMOSS/INSTN.
ALTMP296 = QMEL9/SAPSMOSS/MNUMM.
ALTMP297 = QMEL9/SAPSMOSS/OSSYS.
ALTMP298 = QMEL9/SAPSMOSS/DBSYS.
ALTMP299 = QMEL9/SAPSMOSS/REL.
ALTMP300 = QMEL9/SAPSMOSS/COMP.
ALTMP301 = QMEL9/SAPSMOSS/FRONT.
ALTMP302 = QMEL9/SAPSMOSS/SYSTYP.
ALTMP303 = QMEL9/SAPSMOSS/ADDID.
ALTMP304 = QMEL9/SAPSMOSS/ADDREL.
ALTMP305 = QMEL9/SAPSMOSS/TSTMP.
ALTMP306 = QMEL9/SAPSMOSS/STATUS.
ALTMP307 = QMEL9/SAPSMOSS/ERDAT.
ALTMP308 = QMEL9/SAPSMOSS/SYSID.
ALTMP309 = QMEL9/SAPSMOSS/MANDT.
ALTMP310 = QMEL9PSP_NR.
ALTMP311 = QMEL9ESTIMATED_COSTS.
ALTMP312 = QMEL9CLAIMED_COSTS.
ALTMP313 = QMEL9RESULT_COSTS.
ALTMP314 = QMEL9CHANCE.
ALTMP315 = QMEL9OPPONENT.
ALTMP316 = QMEL9KALNR.
ALTMP317 = QMEL9KALVAR.
ALTMP318 = QMEL9OBJNR_REAL.
ALTMP319 = QMEL9OBJNR_STAT.
ALTMP320 = QMEL9PHASE.
ALTMP321 = QMEL9/ISDFPS/OBJNR.
ALTMP322 = QMEL9LOGSYSTEM.
ALTMP323 = QMEL9/ISDFPS/MEQUI.
ALTMP324 = QMEL9YY_BEMOT.
ALTMP325 = QMIH9IWERK.
ALTMP326 = QMIH9ILOAN.
ALTMP327 = QMIH9ILOAI.
ALTMP328 = QMIH9EQUNR.
ALTMP329 = QMIH9BAUTL.
ALTMP330 = QMIH9EBORT.
ALTMP331 = QMIH9MSAUS.
ALTMP332 = QMIH9AUSVN.
ALTMP333 = QMIH9AUSBS.
ALTMP334 = QMIH9AUSZT.
ALTMP335 = QMIH9MAUEH.
ALTMP336 = QMIH9BTPLN.
ALTMP337 = QMIH9BEQUI.
ALTMP338 = QMIH9AUSWK.
ALTMP339 = QMIH9VERFV.
ALTMP340 = QMIH9VERFN.
ALTMP341 = QMIH9VERFM.
ALTMP342 = QMIH9ANLZV.
ALTMP343 = QMIH9ANLZN.
ALTMP344 = QMIH9ANLZE.
ALTMP345 = QMIH9INSPK.
ALTMP346 = QMIH9INGRP.
ALTMP347 = QMIH9WARPL.
ALTMP348 = QMIH9ABNUM.
ALTMP349 = QMIH9WAPOS.
ALTMP350 = QMIH9KDAUF.
ALTMP351 = QMIH9KDPOS.
ALTMP352 = QMIH9SCREENTY.
ALTMP353 = QMIH9PLNTY.
ALTMP354 = QMIH9PLNNR.
ALTMP355 = QMIH9PLNAL.
ALTMP356 = QMIH9REVNR.
ALTMP357 = QMIH9ZAEHL.
ALTMP358 = ILOA9TPLNR.
ALTMP359 = ZSTC_SALE_019BUKRS.
ALTMP360 = ZSTC_SALE_019VKORG.
ALTMP361 = ZSTC_SALE_019WERKS.
ALTMP362 = ZSTC_SALE_019EKORG.
ALTMP363 = ZSTC_SALE_019MAMUSERCMPY.
ALTMP364 = ZSTC_SALE_019REGION.
ALTMP365 = ZSTC_SALE_019COUNTRY.
ALTMP366 = ZSTC_SALE_019COUNTRYDSCR.
ALTMP367 = ZSTC_SALE_019SALESCOMPANY.
ALTMP368 = ZSTC_SALE_019SALESCMPDSCR.
 move ALTMP188 to ITAB6-QMNUM.
 move ALTMP189 to ITAB6-MANDT.
 move ALTMP190 to ITAB6-QMART.
 move ALTMP191 to ITAB6-QMTXT.
 move ALTMP192 to ITAB6-ARTPR.
 move ALTMP193 to ITAB6-PRIOK.
 move ALTMP194 to ITAB6-ERNAM.
 move ALTMP195 to ITAB6-ERDAT.
 move ALTMP196 to ITAB6-AENAM.
 move ALTMP197 to ITAB6-AEDAT.
 move ALTMP198 to ITAB6-MZEIT.
 move ALTMP199 to ITAB6-QMDAT.
 move ALTMP200 to ITAB6-QMNAM.
 move ALTMP201 to ITAB6-STRMN.
 move ALTMP202 to ITAB6-LTRMN.
 move ALTMP203 to ITAB6-WAERS.
 move ALTMP204 to ITAB6-AUFNR.
 move ALTMP205 to ITAB6-VERID.
 move ALTMP206 to ITAB6-RM_MATNR.
 move ALTMP207 to ITAB6-RM_WERKS.
 move ALTMP208 to ITAB6-SA_AUFNR.
 move ALTMP209 to ITAB6-MATNR.
 move ALTMP210 to ITAB6-REVLV.
 move ALTMP211 to ITAB6-MATKL.
 move ALTMP212 to ITAB6-PRDHA.
 move ALTMP213 to ITAB6-KZKRI.
 move ALTMP214 to ITAB6-KZDKZ.
 move ALTMP215 to ITAB6-KUNUM.
 move ALTMP216 to ITAB6-FEKNZ.
 move ALTMP217 to ITAB6-MAKNZ.
 move ALTMP218 to ITAB6-OBJNR.
 move ALTMP219 to ITAB6-QMDAB.
 move ALTMP220 to ITAB6-RBNR.
 move ALTMP221 to ITAB6-RBNRI.
 move ALTMP222 to ITAB6-INDTX.
 move ALTMP223 to ITAB6-KZMLA.
 move ALTMP224 to ITAB6-HERKZ.
 move ALTMP225 to ITAB6-BEZDT.
 move ALTMP226 to ITAB6-LIFNUM.
 move ALTMP227 to ITAB6-BUNAME.
 move ALTMP228 to ITAB6-VBELN.
 move ALTMP229 to ITAB6-BSTNK.
 move ALTMP230 to ITAB6-BSTDK.
 move ALTMP231 to ITAB6-SPART.
 move ALTMP232 to ITAB6-VKORG.
 move ALTMP233 to ITAB6-VTWEG.
 move ALTMP234 to ITAB6-ADRNR.
 move ALTMP235 to ITAB6-MAWERK.
 move ALTMP236 to ITAB6-QMKAT.
 move ALTMP237 to ITAB6-QMGRP.
 move ALTMP238 to ITAB6-QMCOD.
 move ALTMP239 to ITAB6-AUSWIRK.
 move ALTMP240 to ITAB6-TEILEV.
 move ALTMP241 to ITAB6-PRUEFLOS.
 move ALTMP242 to ITAB6-CHARG.
 move ALTMP243 to ITAB6-LGORTCHARG.
 move ALTMP244 to ITAB6-LICHN.
 move ALTMP245 to ITAB6-HERSTELLER.
 move ALTMP246 to ITAB6-EMATNR.
 move ALTMP247 to ITAB6-EKORG.
 move ALTMP248 to ITAB6-BKGRP.
 move ALTMP249 to ITAB6-LGORTVORG.
 move ALTMP250 to ITAB6-FERTAUFNR.
 move ALTMP251 to ITAB6-FERTAUFPL.
 move ALTMP252 to ITAB6-EBELN.
 move ALTMP253 to ITAB6-EBELP.
 move ALTMP254 to ITAB6-MJAHR.
 move ALTMP255 to ITAB6-MBLNR.
 move ALTMP256 to ITAB6-MBLPO.
 move ALTMP257 to ITAB6-LS_KDAUF.
 move ALTMP258 to ITAB6-LS_KDPOS.
 move ALTMP259 to ITAB6-LS_VBELN.
 move ALTMP260 to ITAB6-LS_POSNR.
 move ALTMP261 to ITAB6-CROBJTY.
 move ALTMP262 to ITAB6-ARBPL.
 move ALTMP263 to ITAB6-ARBPLWERK.
 move ALTMP264 to ITAB6-FEART.
 move ALTMP265 to ITAB6-PNLKN.
 move ALTMP266 to ITAB6-MGEIG.
 move ALTMP267 to ITAB6-MGFRD.
 move ALTMP268 to ITAB6-MGEIN.
 move ALTMP269 to ITAB6-BZMNG.
 move ALTMP270 to ITAB6-RKMNG.
 move ALTMP271 to ITAB6-RGMNG.
 move ALTMP272 to ITAB6-RKDAT.
 move ALTMP273 to ITAB6-COAUFNR.
 move ALTMP274 to ITAB6-QWRNUM.
 move ALTMP275 to ITAB6-REFNUM.
 move ALTMP276 to ITAB6-KDMAT.
 move ALTMP277 to ITAB6-IDNLF.
 move ALTMP278 to ITAB6-SERIALNR.
 move ALTMP279 to ITAB6-KZLOESCH.
 move ALTMP280 to ITAB6-PRODDAT.
 move ALTMP281 to ITAB6-DEVICEID.
 move ALTMP282 to ITAB6-VKBUR.
 move ALTMP283 to ITAB6-VKGRP.
 move ALTMP284 to ITAB6-AUTKZ.
 move ALTMP285 to ITAB6-BEDID.
 move ALTMP286 to ITAB6-BEDZL.
 move ALTMP287 to ITAB6-PROFIL_TYP.
 move ALTMP288 to ITAB6-PROFIL_ID.
 move ALTMP289 to ITAB6-HANDLE.
 move ALTMP290 to ITAB6-TSEGFL.
 move ALTMP291 to ITAB6-TSEGTP.
 move ALTMP292 to ITAB6-TZONSO.
 move ALTMP293 to ITAB6-TZONID.
 move ALTMP294 to ITAB6-FUNKTION.
 move ALTMP295 to ITAB6-/SAPSMOSS/INSTN.
 move ALTMP296 to ITAB6-/SAPSMOSS/MNUMM.
 move ALTMP297 to ITAB6-/SAPSMOSS/OSSYS.
 move ALTMP298 to ITAB6-/SAPSMOSS/DBSYS.
 move ALTMP299 to ITAB6-/SAPSMOSS/REL.
 move ALTMP300 to ITAB6-/SAPSMOSS/COMP.
 move ALTMP301 to ITAB6-/SAPSMOSS/FRONT.
 move ALTMP302 to ITAB6-/SAPSMOSS/SYSTYP.
 move ALTMP303 to ITAB6-/SAPSMOSS/ADDID.
 move ALTMP304 to ITAB6-/SAPSMOSS/ADDREL.
 move ALTMP305 to ITAB6-/SAPSMOSS/TSTMP.
 move ALTMP306 to ITAB6-/SAPSMOSS/STATUS.
 move ALTMP307 to ITAB6-/SAPSMOSS/ERDAT.
 move ALTMP308 to ITAB6-/SAPSMOSS/SYSID.
 move ALTMP309 to ITAB6-/SAPSMOSS/MANDT.
 move ALTMP310 to ITAB6-PSP_NR.
 move ALTMP311 to ITAB6-ESTIMATED_COSTS.
 move ALTMP312 to ITAB6-CLAIMED_COSTS.
 move ALTMP313 to ITAB6-RESULT_COSTS.
 move ALTMP314 to ITAB6-CHANCE.
 move ALTMP315 to ITAB6-OPPONENT.
 move ALTMP316 to ITAB6-KALNR.
 move ALTMP317 to ITAB6-KALVAR.
 move ALTMP318 to ITAB6-OBJNR_REAL.
 move ALTMP319 to ITAB6-OBJNR_STAT.
 move ALTMP320 to ITAB6-PHASE.
 move ALTMP321 to ITAB6-/ISDFPS/OBJNR.
 move ALTMP322 to ITAB6-LOGSYSTEM.
 move ALTMP323 to ITAB6-/ISDFPS/MEQUI.
 move ALTMP324 to ITAB6-YY_BEMOT.
 move ALTMP325 to ITAB6-IWERK.
 move ALTMP326 to ITAB6-ILOAN.
 move ALTMP327 to ITAB6-ILOAI.
 move ALTMP328 to ITAB6-EQUNR.
 move ALTMP329 to ITAB6-BAUTL.
 move ALTMP330 to ITAB6-EBORT.
 move ALTMP331 to ITAB6-MSAUS.
 move ALTMP332 to ITAB6-AUSVN.
 move ALTMP333 to ITAB6-AUSBS.
 move ALTMP334 to ITAB6-AUSZT.
 move ALTMP335 to ITAB6-MAUEH.
 move ALTMP336 to ITAB6-BTPLN.
 move ALTMP337 to ITAB6-BEQUI.
 move ALTMP338 to ITAB6-AUSWK.
 move ALTMP339 to ITAB6-VERFV.
 move ALTMP340 to ITAB6-VERFN.
 move ALTMP341 to ITAB6-VERFM.
 move ALTMP342 to ITAB6-ANLZV.
 move ALTMP343 to ITAB6-ANLZN.
 move ALTMP344 to ITAB6-ANLZE.
 move ALTMP345 to ITAB6-INSPK.
 move ALTMP346 to ITAB6-INGRP.
 move ALTMP347 to ITAB6-WARPL.
 move ALTMP348 to ITAB6-ABNUM.
 move ALTMP349 to ITAB6-WAPOS.
 move ALTMP350 to ITAB6-KDAUF.
 move ALTMP351 to ITAB6-KDPOS.
 move ALTMP352 to ITAB6-SCREENTY.
 move ALTMP353 to ITAB6-PLNTY.
 move ALTMP354 to ITAB6-PLNNR.
 move ALTMP355 to ITAB6-PLNAL.
 move ALTMP356 to ITAB6-REVNR.
 move ALTMP357 to ITAB6-ZAEHL.
 move ALTMP358 to ITAB6-TPLNR.
 move ALTMP359 to ITAB6-Z_BUKRS.
 move ALTMP360 to ITAB6-Z_VKORG.
 move ALTMP361 to ITAB6-Z_WERKS.
 move ALTMP362 to ITAB6-Z_EKORG.
 move ALTMP363 to ITAB6-Z_MAMUSERCMPY.
 move ALTMP364 to ITAB6-Z_REGION.
 move ALTMP365 to ITAB6-Z_COUNTRY.
 move ALTMP366 to ITAB6-Z_COUNTRYDSCR.
 move ALTMP367 to ITAB6-Z_SALESCOMPANY.
 move ALTMP368 to ITAB6-Z_SALESCMPDSCR.
 append ITAB6.
 cntbuf = cntbuf + 1.
 if download = 'N'.
  if cntbuf > 5000.
    perform FORM7.
    clear cntbuf.
    refresh ITAB6.
    append_flag = 'A'.
  endif.
 endif.
 if download = 'S'.
  if cntbuf > P_PKGSZ.
    perform FORM7.
    clear cntbuf.
    refresh ITAB6.
  endif.
 endif.
ENDSELECT.
ENDFORM.

FORM FORM7.
data: outfile(512), ldfile(50).
ldfile = 'CTS_LZ_SAP_CP1_QMEL_D'.
concatenate out_dir ldfile into outfile
  separated by '/'.
  IF DOWNLOAD = 'S'.
     DATA: error_message(700),mtext(800),iEOP(1).
     CALL FUNCTION P_SRVFM
          DESTINATION P_DEST
          KEEPING LOGICAL UNIT OF WORK
          EXPORTING
            EOS = last_batch
          IMPORTING
            EOP = iEOP
          TABLES
            E_TABLE = ITAB6
          EXCEPTIONS
            READ_ERROR = 1
            SYSTEM_FAILURE = 2
            MESSAGE error_message
            COMMUNICATION_FAILURE = 3
            MESSAGE error_message
            OTHERS = 4.

     IF sy-subrc ne 0.
        Case sy-subrc.
        when 1.
        CONCATENATE
        'Data Services read error. '
        'Check Data Services error log.'
        INTO mtext.
        MESSAGE  E240(S#) WITH mtext.
        when 2.
        CONCATENATE
'SAP System Failure while calling DS remote function: '
      error_message INTO mtext.
        MESSAGE  E240(S#) WITH mtext.
        when 3.
        CONCATENATE
'SAP System Failure while calling DS remote function: '
      error_message INTO mtext.
        MESSAGE  E240(S#) WITH mtext.
        when 4.
        MESSAGE  E240(S#) WITH
'Other SAP System Failure while calling DS remote function.'.
        endcase.
      ENDIF.
      IF iEOP = 'X'.
         PERFORM DISCONNECT_RFCDEST_FROM_PROGID.
         LEAVE PROGRAM.
       ENDIF.
  ELSE.
data  dlmtlen type i value '1'.
data xdlmtlen type i value '1'.
data:
  ht(1) type c,
  xht(1) type x,
  conv type ref to cl_abap_conv_in_ce.
xht = '7F'.
conv = cl_abap_conv_in_ce=>create(
  encoding = '1100'
  input = xht
).
call method conv->read(
  exporting n    = xdlmtlen
  importing data = ht
            len = dlmtlen
).
data return_code type i.
 perform write_delimited_file
           tables   ITAB6
           using    outfile
                    append_flag
                    ht
                    dlmtlen
                    download
           changing return_code.

  case return_code.
    when 1.
      IF EXECMODE = 'D'.
        WRITE: /5 'No line selected'.
      ELSE.
        MESSAGE E047(S#).
      ENDIF.
    when 2.
      IF EXECMODE = 'D'.
        WRITE: /5 'Open File Error -- ', 25 OUTFILE.
      ELSE.
        MESSAGE  E084(E0) WITH OUTFILE.
      ENDIF.
    when 3.
      IF EXECMODE = 'D'.
        WRITE: /5 'Data exceed length limit (8192) '.
      ELSE.
        MESSAGE  E240(S#) WITH
             'Data exceed length limit (8192) '.
      ENDIF.
    when 4.
      IF EXECMODE = 'D'.
        WRITE: /5 'Call function WS_DOWNLOAD error'.
      ELSE.
        MESSAGE  E240(S#) WITH
             'Call function WS_DOWNLOAD error'.
      ENDIF.
  endcase.
 ENDIF.
ENDFORM.

FORM SUBSTRING USING SRC BEG LEN CHANGING RET.

DATA: VA1 TYPE I.
DATA: VA2 TYPE I.
DATA: VA3 TYPE I.

VA3 = STRLEN( SRC ).

IF  BEG = 0.   VA1 = 0.
ELSE.
  IF  BEG < 0.
    VA1 = VA3 + BEG.
    IF  VA1 < 0.   VA1 = 0.
    ENDIF.
  ELSE.          VA1 = BEG - 1.
  ENDIF.
ENDIF.

IF  LEN < 0.   VA2 = 0.
ELSE.          VA2 = VA3 - VA1.
ENDIF.

IF  VA2 > LEN. VA2 = LEN.
ENDIF.

IF  VA2 < 1.   MOVE ''           TO RET.
ELSE.          MOVE SRC+VA1(VA2) TO RET.
ENDIF.

ENDFORM.

form write_delimited_file
           tables   datatab
           using    file
                    append
                    delimit
                    dlength
                    dwnload
          changing rc.

  data: type1,
        appd(1),
        temp(32),
        time1(8),
        date1(10),
        output(8192),
        rcount type i,
        offset type i,
        tablen type i,
        maxlen type i value '8192'.

  data: begin of clientab occurs 0,
             output(8192),
          end of clientab.

  field-symbols: <f>.
  field-symbols <delim1>.
  data delim2(16).
  data l_filename type string.

  appd = append.
  if appd is not initial.
     appd = 'X'.
  endif.
  move file to l_filename.
  describe table datatab lines tablen.


  if dwnload = 'Y'.
     clear clientab. refresh clientab.
     rcount = 0.
  else.
     if appd = space.
   open dataset file for output in text mode ENCODING UTF-8.
     else.
    open dataset file for appending in text mode ENCODING UTF-8.
     endif.
     if sy-subrc <> 0.
         rc = 2. exit.
     endif.
  endif.

  loop at datatab.
    clear: tablen, offset, output.
    do.
      assign component sy-index of
         structure datatab to <f>.
      if sy-subrc <> 0. exit. endif.
      if sy-index > 1.
         assign delimit(dlength) TO <delim1> CASTING TYPE C.
         delim2 = <delim1>.
         write delim2(dlength) to output+offset(dlength).
         add dlength to offset.
      endif.

      describe field <f> type type1.

      if type1 = 'I' or type1 = 'N'.
          type1 = 'P'.
      endif.

      case type1.
        when 'D'.
          if <f> = '00000000'.
             <f> = ' '.
          else.
             move <f> to time1.
             assign time1 to <f>.
          endif.
        when 'F'.
          if <f> = '0.0'.
            temp = '0.0'.
          else.
             write <f> to temp exponent 0.
          endif.
          condense temp no-gaps.
          translate temp using ',.'.
          assign temp to <f>.
        when 'P'.
          if <f> < 0.
             write '-' to output+offset(1).
             add 1 to offset.
             <f> = <f> * ( -1 ).
          endif.
          move <f> to temp.
          condense temp no-gaps.
          translate temp using ',.'.
          assign temp to <f>.
      endcase.

      sy-fdpos = strlen( <f> ).

      tablen = offset + sy-fdpos.
      if tablen > maxlen.
         rc = 3. exit.
      endif.
      write <f> to output+offset(sy-fdpos).
      add sy-fdpos to offset.
    enddo.

    if dwnload = 'Y'.
       clientab-output = output.
       append clientab.
       rcount = rcount + 1.
       if rcount >= 50.
          SY-BATCH = SPACE.
          CALL FUNCTION 'GUI_DOWNLOAD'
            EXPORTING
              FILENAME = l_filename
              FILETYPE = 'ASC'
              CODEPAGE = '4110'
              APPEND   = appd
              WRITE_FIELD_SEPARATOR = 'X'
*            IMPORTING
*              FILELENGTH =
            TABLES
              DATA_TAB = clientab
            EXCEPTIONS
              OTHERS = 1.
          if sy-subrc <> 0.
             rc = 4.
          endif.
          clear clientab. refresh clientab.
          rcount = 0. appd = 'A'.
       endif.
    else.
       transfer output to file.
    endif.
  endloop.

  if dwnload = 'Y'.
       SY-BATCH = SPACE.
       CALL FUNCTION 'GUI_DOWNLOAD'
         EXPORTING
           FILENAME = l_filename
           FILETYPE = 'ASC'
              CODEPAGE = '4110'
           APPEND   = appd
           WRITE_FIELD_SEPARATOR = 'X'
*         IMPORTING
*           FILELENGTH =
         TABLES
           DATA_TAB = clientab
         EXCEPTIONS
           OTHERS = 1.
          if sy-subrc <> 0.
             rc = 4.
          endif.
  else.
       close dataset file.
  endif.
endform.

FORM CONNECT_RFCDEST_TO_PROGID.
 INCLUDE rfctypes.

 DATA: len     type i,
       R3NAME(4),
       SYSTNR(2),
       uid     LIKE SYS_UID,
       options LIKE RFCOPT,
       isunicode  TYPE n.

 DATA: NTOTAL     LIKE GWY_STRUCT-NOREG,
       GWY_GWHOST LIKE GWY_STRUCT-GWHOST,
       GWY_GWSERV LIKE GWY_STRUCT-GWSERV,
       GWY_TPNAME LIKE GWY_SYSTEM-TPNAME.

 TABLES: RFCSI.

* Check program ID
 IF P_PROGID = SPACE.							
    RAISE INVALID_PROGRAM_ID.
 ENDIF.

* determine if the RFC destination authority
  CALL FUNCTION 'RFC_READ_TCPIP_DESTINATION'
       EXPORTING destination = P_DEST
                 authority_check = 'X'
  IMPORTING rfcunicode = isunicode.

* Use current gateway if no info exits
 IF P_GWHOST = SPACE OR P_GWSERV = SPACE.
  CALL FUNCTION 'RFC_SYSTEM_INFO'
      IMPORTING
          RFCSI_EXPORT = RFCSI.

  len = strlen( rfcsi-rfcdest ) - 2.
  systnr = rfcsi-rfcdest+len.
  len = len - 1 - 3.
  r3name = rfcsi-rfcdest+len(3).
  len = len - 1.
  options-rfcgwhost = rfcsi-rfcdest(len).
  CONCATENATE 'sapgw' SYSTNR INTO options-rfcgwserv.
 ELSE.
   options-rfcgwhost = P_GWHOST.
   options-rfcgwserv = P_GWSERV.
 ENDIF.

* Parameters for GWY function call
  GWY_GWHOST = OPTIONS-RFCGWHOST.
  GWY_GWSERV = OPTIONS-RFCGWSERV.
  GWY_TPNAME = P_PROGID.

* Check gateway and server program registered
  CALL FUNCTION 'GWY_GET_NO_REG_PROGRAMS'
     EXPORTING
        GWHOST      = GWY_GWHOST
        GWSERV      = GWY_GWSERV
        TPNAME      = GWY_TPNAME
     IMPORTING
        NOREG_TOTAL = NTOTAL
     EXCEPTIONS
        OTHERS      = 1.

  IF sy-subrc NE 0.
     raise CONNECT_TO_GATEWAY_FAILED.
  ENDIF.

  IF NTOTAL = 0.
     raise SERVER_NOT_REGISTERED.
  ENDIF.

  IF NTOTAL GT 1.
     raise DUPLICATE_REG_PROGRAMS.
  ENDIF.

* build new connection to a registered server
  options-rfcexec   = gwy_tpname.
  options-rfcgwhost = gwy_gwhost.
  options-rfcgwserv = gwy_gwserv.
  options-rfchost   = '%%RFCSERVER%%'.
  IF P_SNC_ON = 'X'.
    options-rfcsnc  = 'X'.
  ENDIF.

  CALL 'RFCControl' ID 'CODE' FIELD 'O'
                    ID 'DESTINATION' FIELD P_DEST
                    ID 'TYPE' FIELD rfctype_external_tcp
                    ID 'OPTIONS' FIELD options.

  IF sy-subrc NE 0.
     RAISE CONNECT_TO_REG_SERVER_FAILED.
   ENDIF.

* and set exclusive mode to keep server owned
  CALL FUNCTION 'SYSTEM_SET_REG_SERVER_PROPERTY'
      EXPORTING  destination = P_DEST
                 exclusiv    = 'Y'
      EXCEPTIONS connect_to_reg_server_failed = 1
                 exclusiv_not_supported       = 2.

  IF SY-SUBRC NE 0.
     CASE SY-SUBRC.
          WHEN 1.
              RAISE CONNECT_TO_REG_SERVER_FAILED.
          WHEN 2.
              RAISE EXCLUSIV_NOT_SUPPORTED.
     ENDCASE.
  ENDIF.

ENDFORM.

FORM DISCONNECT_RFCDEST_FROM_PROGID.
* set exclusive mode to E to end the session
  CALL FUNCTION 'SYSTEM_SET_REG_SERVER_PROPERTY'
     EXPORTING
         destination = P_DEST
         exclusiv    = 'E'
     EXCEPTIONS
         connect_to_reg_server_failed = 1				
         exclusiv_not_supported       = 2.
ENDFORM.
