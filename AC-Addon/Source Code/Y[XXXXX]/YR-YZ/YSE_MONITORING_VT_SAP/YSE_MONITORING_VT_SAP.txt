*&---------------------------------------------------------------------*
*& Report  YSE_MONITORING_VT_SAP
*&
*&---------------------------------------------------------------------*
*&
*& Monitoring tool VisiTour vs. SAP
*&
*&---------------------------------------------------------------------*
*  Author                : Jules Smets
*  Date                  : 08.11.2010
*  Change Request Number : CR1519
*  Transport request Nr. : CD1K960836
*----------------------------------------------------------------------*
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD.NR. |   DATE     | NAME               | CORRECT. NR| CHANGE REF. *
*----------------------------------------------------------------------*
* MOD-001 | 01.01.9999 |                    | CD1K9..... | CR....      *
*----------------------------------------------------------------------*

************************************************************************

REPORT  yse_monitoring_vt_sap.

* ALV grid
TYPE-POOLS: slis.

*----------------------------------------------------------------------*
* BDC Tables                                                           *
*----------------------------------------------------------------------*
DATA: i_bdcdata      LIKE bdcdata OCCURS 0 WITH HEADER LINE,
      struct_bdcdata TYPE bdcdata.

*BDC Structure for Messages
DATA : BEGIN OF i_messtab OCCURS 0.
        INCLUDE STRUCTURE bdcmsgcoll.
DATA : END OF i_messtab.

*----------------------------------------------------------------------*
* Internal tables for BAPI-ALM_ORDER_GETDETAIL                         *
*----------------------------------------------------------------------*
DATA: BEGIN OF i_es_header OCCURS 100.
        INCLUDE STRUCTURE bapi_alm_order_header_e.
DATA: END OF i_es_header.

*DATA: BEGIN OF i_es_srvdat OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_srvdat_e.
*DATA: END OF i_es_srvdat.
*DATA: BEGIN OF i_partner OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_partner.
*DATA: END OF i_partner.

DATA: BEGIN OF i_operations OCCURS 100.
        INCLUDE STRUCTURE bapi_alm_order_operation_e.
DATA: END OF i_operations.

*DATA: BEGIN OF i_components OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_component_e.
*DATA: END OF i_components.
*DATA: BEGIN OF i_relations OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_relation_export.
*DATA: END OF i_relations.
*DATA: BEGIN OF i_texts OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_text.
*DATA: END OF i_texts.
*DATA: BEGIN OF i_text_lines OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_text_lines.
*DATA: END OF i_text_lines.
*DATA: BEGIN OF i_prts OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_prt_e.
*DATA: END OF i_prts.
*DATA: BEGIN OF i_costs_sum OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_costs_sum_e.
*DATA: END OF i_costs_sum.
*DATA: BEGIN OF i_costs_detail OCCURS 100.
*        INCLUDE STRUCTURE bapi_alm_order_costs_detail_e.
*DATA: END OF i_costs_detail.
*
DATA: BEGIN OF i_return OCCURS 100.
        INCLUDE STRUCTURE bapiret2.
DATA: END OF i_return.

DATA: lt_methods      LIKE bapi_alm_order_method  OCCURS 0
                           WITH HEADER LINE,
      lt_component    LIKE bapi_alm_order_component  OCCURS 0
                           WITH HEADER LINE,
      lt_operation    LIKE bapi_alm_order_operation  OCCURS 0
                           WITH HEADER LINE,
      lt_operation_up LIKE bapi_alm_order_operation_up  OCCURS 0
                           WITH HEADER LINE.

* Return
DATA: lt_return   TYPE STANDARD TABLE OF bapiret2 WITH HEADER LINE,
      ls_return   LIKE bapiret2.

DATA: BEGIN OF it_vtin  OCCURS 0,
        line(50)   TYPE c,
      END OF it_vtin.

DATA: BEGIN OF it_vt  OCCURS 0,
        aufnr        TYPE aufnr,
        oper         TYPE vornr,
        status       TYPE ycallstate,
        work_cntr    TYPE arbpl,
        duration(4)  TYPE n,
        date         TYPE datum,
      END OF it_vt.

DATA: BEGIN OF it_out  OCCURS 0,
        aufnr        TYPE aufnr,
        oper         TYPE vornr,
        status_vt    TYPE ycallstate,
        status_sap   TYPE usrflag,
        workc_vt     TYPE arbpl,
        workc_sap    TYPE arbpl,
        dur_vt(4)    TYPE n,
        dur_sap      TYPE arbeit,
        date_vt      TYPE datum,
        date_sap     TYPE datum,
        stat_clsd    TYPE xfeld,
        selkz        TYPE xfeld,
        zzcol        TYPE col_code,
      END OF it_out.

* ALV
DATA: xv_variant         LIKE disvariant,
      xv_variant_flag    TYPE c,
      xv_sd_alv_variant  LIKE disvariant,
      xt_fcat            TYPE slis_t_fieldcat_alv,
      ls_fcat            LIKE LINE OF xt_fcat,
      xt_alv_sort        TYPE slis_t_sortinfo_alv,
      xv_user_command    TYPE slis_formname  VALUE 'USER_COMMAND',
      xv_variant_save    TYPE c              VALUE 'U',
      xv_layout          TYPE slis_layout_alv,
      xv_grid            TYPE lvc_s_glay,
      xt_events          TYPE slis_t_event,
      ls_events          TYPE slis_alv_event,
      xt_event_exits     TYPE slis_t_event_exit.

DATA: gv_status          TYPE usrflag,
      gv_dur_c(4)        TYPE c,
      gv_dur_a           TYPE arbeit,
      gv_date_c(10)      TYPE c,
      gv_error           TYPE xfeld,
      gv_oper_index      TYPE sytabix,
      gv_count           TYPE sytabix,
      gv_col(10)         TYPE n,
      gv_repid           LIKE sy-repid,
      gv_answer          TYPE c,
      gv_text            TYPE char80,
      gv_stat_nok        TYPE xfeld,
      gv_stat_rel        TYPE xfeld,
      gv_stat_clsd       TYPE xfeld,
      gv_objnr           TYPE j_objnr,
      gv_arbei(8)        TYPE c,
      gv_arbei_p         TYPE arbeit,
      gv_aufpl           TYPE co_aufpl,
      wa_jest            TYPE jest,
      gs_afvc            TYPE afvc,
      gv_afvgd_old       TYPE afvgd,
      gv_afvgd_new       TYPE afvgd,
      gv_newdate         LIKE afvv-fsavd,
      gv_enddate         LIKE afvv-fsavd,
      gv_seconds         TYPE cx_bearb,
      gv_bedid           TYPE bedid,
      gv_gstrp           TYPE pm_ordgstrp,
      gv_gltrp           TYPE co_gltrp,
      gv_cnt_upd         TYPE i,
      gv_mode(1)         TYPE c  VALUE 'N'.

CONSTANTS:  c_x                         VALUE 'X',
            c_msgty_e                   VALUE 'E',
            c_msgty_s                   VALUE 'S',
            c_msgty_w                   VALUE 'W',
            c_blank                     VALUE ' ',
            c_0010(4)                   VALUE '0010',
            c_stat_rel   TYPE j_status  VALUE 'I0002',
            c_stat_cnf   TYPE j_status  VALUE 'I0009',
            c_stat_teco  TYPE j_status  VALUE 'I0045',
            c_stat_clsd  TYPE j_status  VALUE 'I0046',
            c_z000001(7)                VALUE 'Z000001'.


*&---------------------------------------------------------------------*
*&  Selection screen                                                   *
*&---------------------------------------------------------------------*
* Input file
PARAMETERS: p_infile TYPE  rlgrap-filename LOWER CASE.
*                 DEFAULT 'C:\VT.MONITOR.xls'.


AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_infile.

* Get the filename
  PERFORM get_filename USING p_infile.


*&---------------------------------------------------------------------*
*&  Main program                                                       *
*&---------------------------------------------------------------------*
START-OF-SELECTION.

* Read input file
  PERFORM read_file.

* Compare input from VisiTour with SEO in SAP
  PERFORM compare_data.

* Display differences
  IF it_out[] IS INITIAL.
    MESSAGE i001(00) WITH 'No differences found'(i01).
  ELSE.
    PERFORM alv_fcat.
    PERFORM alv_layout.
    PERFORM alv_events.
    PERFORM alv_display.
  ENDIF.

*&---------------------------------------------------------------------*
*&  Forms                                                              *
*&---------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*&      Form  GET_FILENAME
*&---------------------------------------------------------------------*
*       Get the filename
*----------------------------------------------------------------------*
*      -->P_INFILE : Input file
*----------------------------------------------------------------------*
FORM get_filename  USING    p_infile.

  CALL FUNCTION 'WS_FILENAME_GET'
    EXPORTING
      def_path         = 'C:\'
      mask             = ',*.XLS.'
    IMPORTING
      filename         = p_infile
    EXCEPTIONS
      inv_winsys       = 1
      no_batch         = 2
      selection_cancel = 3
      selection_error  = 4
      OTHERS           = 5.

  IF sy-subrc <> 0.
  ENDIF.

ENDFORM.                    " GET_FILENAME

*&---------------------------------------------------------------------*
*&      Form  READ_FILE
*&---------------------------------------------------------------------*
*       Read input file
*----------------------------------------------------------------------*
FORM read_file .

* Read EXCEL file
  CALL FUNCTION 'FAA_FILE_UPLOAD_EXCEL'
    EXPORTING
      i_filename                 = p_infile
*      I_TEST                     =
*      I_UCOMM                    =
*      I_MAXCOLS                  =
      i_delimiter                = '|'
    TABLES
      et_filecontent             = it_vtin
    EXCEPTIONS
      error_accessing_file       = 1
      OTHERS                     = 2
            .
  IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

* Store in an internal table
  LOOP AT it_vtin.
    CLEAR it_vt.
    SPLIT it_vtin AT '|' INTO it_vt-aufnr it_vt-oper it_vt-status
                              it_vt-work_cntr gv_dur_c
                              gv_date_c.
    PERFORM add_zeros USING it_vt-aufnr.
    PERFORM add_zeros USING it_vt-oper.
    it_vt-duration  = gv_dur_c.
    it_vt-date+0(4) = gv_date_c+6(4).
    it_vt-date+4(2) = gv_date_c+3(2).
    it_vt-date+6(2) = gv_date_c+0(2).
    APPEND it_vt.
  ENDLOOP.

ENDFORM.                    " READ_FILE

*&---------------------------------------------------------------------*
*&      Form  ADD_ZEROS
*&---------------------------------------------------------------------*
*       Add leading zeros
*----------------------------------------------------------------------*
*      -->P_FIELD : field
*----------------------------------------------------------------------*
FORM add_zeros  USING    p_field.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = p_field
    IMPORTING
      output = p_field.

ENDFORM.                    " ADD_ZEROS

*&---------------------------------------------------------------------*
*&      Form  COMPARE_DATA
*&---------------------------------------------------------------------*
*       Compare input from VisiTour with SEO in SAP
*----------------------------------------------------------------------*
FORM compare_data .

  LOOP AT it_vt.
*   Progress indicator
    gv_text = 'Operation & of Order & is being processed'(i02).
    REPLACE '&' WITH it_vt-oper  INTO gv_text.
    REPLACE '&' WITH it_vt-aufnr INTO gv_text.
    CONDENSE gv_text.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        text = gv_text.

*   Get SAP data
    PERFORM get_sap_data USING it_vt-aufnr it_vt-oper.
    CHECK gv_error IS INITIAL.
*   Status 'Fixed'
    CLEAR gv_status.
    IF it_vt-status = '3'.
      gv_status = 'X'.
    ENDIF.
    IF gv_status NE i_operations-usr11.
      gv_error = c_x.
    ENDIF.
*   Workcenter
    IF it_vt-work_cntr NE i_operations-work_cntr.
      gv_error = c_x.
    ENDIF.
*   Duration
    gv_dur_a = it_vt-duration / 60.
    IF gv_dur_a NE i_operations-work_activity.
      gv_error = c_x.
    ENDIF.
*   Date
    IF it_vt-date NE i_operations-earl_sched_start_date.
      gv_error = c_x.
    ENDIF.

*   Error
    IF gv_error = c_x.
*     Get status 'Closed'
      PERFORM get_stat_clsd.
*     Fill internal table for output
      PERFORM fill_output.
    ENDIF.

  ENDLOOP.

ENDFORM.                    " COMPARE_DATA

*&---------------------------------------------------------------------*
*&      Form  GET_SAP_DATA
*&---------------------------------------------------------------------*
*       Get SAP data
*----------------------------------------------------------------------*
*      -->P_AUFNR : Service order number
*      -->P_OPER  : Operation number
*----------------------------------------------------------------------*
FORM get_sap_data  USING  p_aufnr TYPE aufnr
                          p_oper  TYPE vornr.

  CLEAR gv_error.

  CALL FUNCTION 'BAPI_ALM_ORDER_GET_DETAIL'
    EXPORTING
      number           = p_aufnr
    IMPORTING
      es_header        = i_es_header
*      es_srvdata       = i_es_srvdat
    TABLES
*      et_partner       = i_partner
      et_operations    = i_operations
*      et_components    = i_components
*      et_relations     = i_relations
*      et_texts         = i_texts[]
*      et_text_lines    = i_text_lines[]
*      et_prts          = i_prts[]
*      et_costs_sum     = i_costs_sum[]
*      et_costs_details = i_costs_detail[]
      return           = i_return[].

*---------------------------------------------------------------*
* Check if Ordernumber is available in SAP                      *
*---------------------------------------------------------------*
  IF NOT i_return[] IS INITIAL.
    READ TABLE i_return INDEX 1.
    IF i_return-type NE c_msgty_s.
      gv_error = c_x.
      RETURN.
    ENDIF.
  ENDIF.

*---------------------------------------------------------------*
* Check if operation exists in SAP                              *
*---------------------------------------------------------------*
  SORT i_operations[] BY activity.
  IF NOT i_operations[] IS INITIAL AND
     NOT it_vt-oper IS INITIAL.
    READ TABLE i_operations WITH KEY activity = p_oper
                            BINARY SEARCH.
    IF sy-subrc <> 0.
      gv_error = c_x.
      RETURN.
    ELSE.
      gv_oper_index = sy-tabix.
    ENDIF.
  ENDIF.

ENDFORM.                    " GET_SAP_DATA

*&---------------------------------------------------------------------*
*&      Form  GET_STAT_CLSD
*&---------------------------------------------------------------------*
*       Get status 'Closed'
*----------------------------------------------------------------------*
FORM get_stat_clsd .

  CLEAR gv_stat_clsd.

* Get status CLSD (Closed)
  CALL FUNCTION 'STATUS_CHECK'
    EXPORTING
      objnr             = i_es_header-object_no
      status            = c_stat_clsd
    EXCEPTIONS
      object_not_found  = 1
      status_not_active = 2
      OTHERS            = 3.

  IF sy-subrc = 0.
    gv_stat_clsd = 'X'.
    RETURN.
  ELSE.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.                    " GET_STAT_CLSD

*&---------------------------------------------------------------------*
*&      Form  FILL_OUTPUT
*&---------------------------------------------------------------------*
*       Fill internal table for output
*----------------------------------------------------------------------*
FORM fill_output .

  it_out-aufnr      = it_vt-aufnr.
  it_out-oper       = it_vt-oper.
  it_out-status_vt  = it_vt-status.
  it_out-status_sap = i_operations-usr11.
  it_out-workc_vt   = it_vt-work_cntr.
  it_out-workc_sap  = i_operations-work_cntr.
  it_out-dur_vt     = it_vt-duration.
  it_out-dur_sap    = i_operations-work_activity.
  it_out-date_vt    = it_vt-date.
  it_out-date_sap   = i_operations-earl_sched_start_date.
  it_out-stat_clsd  = gv_stat_clsd.
  APPEND it_out.

ENDFORM.                    " FILL_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  ALV_FCAT
*&---------------------------------------------------------------------*
*       ALV field catalog
*----------------------------------------------------------------------*
FORM alv_fcat .

** Create Fieldcatalogue from internal table
** CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE' ...

  CLEAR gv_col.

* Field definitions
  PERFORM add_field USING 'AUFNR'      12 'Service Order'(t01)    'X'.
  PERFORM add_field USING 'OPER'        8 'Operation'(t02)        ' '.
  PERFORM add_field USING 'STATUS_VT'  10 'Status VT'(t03)        ' '.
  PERFORM add_field USING 'STATUS_SAP' 15 'Status Fixed SAP'(t04) ' '.
  PERFORM add_field USING 'WORKC_VT'   14 'Workcenter VT'(t05)    ' '.
  PERFORM add_field USING 'WORKC_SAP'  14 'Workcenter SAP'(t06)   ' '.
  PERFORM add_field USING 'DUR_VT'     15 'Duration VT (m)'(t07)  ' '.
  PERFORM add_field USING 'DUR_SAP'    15 'Duration SAP (h)'(t08) ' '.
  PERFORM add_field USING 'DATE_VT'    10 'Date VT'(t09)          ' '.
  PERFORM add_field USING 'DATE_SAP'   10 'Date SAP'(t10)         ' '.
  PERFORM add_field USING 'STAT_CLSD'  15 'Stat. Closed SAP'(t11) ' '.

ENDFORM.                    " ALV_FCAT

*&---------------------------------------------------------------------*
*&      Form  ADD_FIELD
*&---------------------------------------------------------------------*
*       Add field to field catalog
*----------------------------------------------------------------------*
FORM add_field  USING    p_field
                         p_len
                         p_descr
                         p_key.

  gv_col = gv_col + 1.

  CLEAR ls_fcat.
  ls_fcat-col_pos    = gv_col.
  ls_fcat-fieldname  = p_field.
  ls_fcat-outputlen  = p_len.
  ls_fcat-seltext_l  = p_descr.
  ls_fcat-seltext_m  = p_descr.
  ls_fcat-seltext_s  = p_descr.
  ls_fcat-fix_column = 'X'.
  ls_fcat-emphasize  = 'X'.
  ls_fcat-hotspot    = p_key.
  ls_fcat-key        = p_key.

* Checkbox
  IF p_field = 'STATUS_SAP'  OR
     p_field = 'STAT_CLSD'.
    ls_fcat-checkbox   = 'X'.
  ENDIF.

* Suppress leading zeros
  IF p_field = 'AUFNR' OR
     p_field = 'OPER'.
    ls_fcat-edit_mask = '==ALPHA'.
  ENDIF.

  APPEND ls_fcat TO xt_fcat.

ENDFORM.                    " ADD_FIELD

*&---------------------------------------------------------------------*
*&      Form  ALV_LAYOUT
*&---------------------------------------------------------------------*
*       Modify ALV layout
*----------------------------------------------------------------------*
FORM alv_layout .

* Define layout
  xv_layout-zebra               = c_x.
  xv_layout-get_selinfos        = c_x.
  xv_layout-detail_popup        = c_x.
  xv_layout-box_fieldname       = 'SELKZ'.
  xv_layout-no_keyfix           = c_x.
  xv_layout-group_change_edit   = c_x.
  xv_layout-info_fieldname      = 'ZZCOL'.
*  xv_layout-totals_before_items = c_x.
*  xv_layout-key_hotspot         = c_x.
*  xv_layout-colwidth_optimize   = c_x.
*  xv_layout-smalltitle          = c_x.
*  xv_layout-grid_title          = 'title'.

* Define grid settings
  xv_grid-coll_end_l = c_x.

ENDFORM.                    " ALV_LAYOUT

*&---------------------------------------------------------------------*
*&      Form  ALV_EVENTS
*&---------------------------------------------------------------------*
*       Define ALV events
*----------------------------------------------------------------------*
FORM alv_events .

* Fill events
  ls_events-form = ls_events-name = 'USER_COMMAND'.
  APPEND ls_events TO xt_events.
  ls_events-form = ls_events-name = 'PF_STATUS_SET'.
  APPEND ls_events TO xt_events.

ENDFORM.                    " ALV_EVENTS

*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&---------------------------------------------------------------------*
*       User Command callback routine for ALV
*----------------------------------------------------------------------*
FORM user_command USING r_ucomm LIKE sy-ucomm
                        rs_selfield TYPE slis_selfield.

  CASE r_ucomm.

    WHEN 'UPD_SEO'.
*     Update Service Orders
      PERFORM update_service_orders.
      rs_selfield-refresh = c_x.

    WHEN '&IC1'.
*     Selection
      IF NOT rs_selfield-value IS INITIAL.
        CASE rs_selfield-fieldname.
          WHEN 'AUFNR'.
*           Display Service Order
            SET PARAMETER ID 'ANR' FIELD rs_selfield-value.
            CALL TRANSACTION 'IW33' AND SKIP FIRST SCREEN.
        ENDCASE.
      ENDIF.

  ENDCASE.

ENDFORM.                    " user_command

*&---------------------------------------------------------------------*
*&      Form  PF_STATUS_SET
*&---------------------------------------------------------------------*
*       PF-status callback routine for ALV
*----------------------------------------------------------------------*
FORM pf_status_set USING rt_extab TYPE slis_t_extab.

  SET PF-STATUS 'YSE_MON'.

ENDFORM.                    " PF_STATUS_SET

*&---------------------------------------------------------------------*
*&      Form  ALV_DISPLAY
*&---------------------------------------------------------------------*
*       Display ALV grid
*----------------------------------------------------------------------*
FORM alv_display .

*  xv_sd_alv_variant = xv_variant.
  gv_repid = sy-repid.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program      = gv_repid
      i_callback_user_command = xv_user_command
*      i_callback_top_of_page  = 'ALV_TOP'
      i_grid_title            = 'Monitoring VisiTour vs. SAP'(h01)
      is_layout               = xv_layout
      it_fieldcat             = xt_fcat
      i_grid_settings         = xv_grid
      it_events               = xt_events
      it_sort                 = xt_alv_sort
      i_default               = 'X'
      i_save                  = 'A'
*      is_variant              = xv_sd_alv_variant
      i_screen_start_column   = 0
      i_screen_start_line     = 0
      i_screen_end_column     = 0
      i_screen_end_line       = 0
    TABLES
      t_outtab                = it_out
    EXCEPTIONS
      program_error           = 1
      OTHERS                  = 2.

  IF sy-subrc NE 0.
*   message id sy-msgid type sy-msgty number sy-msgno
*           with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " ALV_DISPLAY

*&---------------------------------------------------------------------*
*&      Form  UPDATE_SERVICE_ORDERS
*&---------------------------------------------------------------------*
*       Update Service Orders
*----------------------------------------------------------------------*
FORM update_service_orders .

* Records selected ?
  LOOP AT it_out WHERE selkz = c_x.
    EXIT.
  ENDLOOP.
  CHECK sy-subrc = 0.

* Confirm reprocessing
  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = text-h01
      text_question         = text-q01
      icon_button_1         = 'ICON_OKAY'
      icon_button_2         = 'ICON_CANCEL'
      default_button        = '2'
      display_cancel_button = space
    IMPORTING
      answer                = gv_answer
    EXCEPTIONS
      text_not_found        = 1
      OTHERS                = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  CHECK gv_answer = '1'.

  CLEAR gv_cnt_upd.

* Loop on the selected IDocs
  LOOP AT it_out WHERE selkz = c_x.

*   Progress indicator
    gv_text = 'Operation & of Order & is being processed'(i02).
    REPLACE '&' WITH it_out-oper  INTO gv_text.
    REPLACE '&' WITH it_out-aufnr INTO gv_text.
    CONDENSE gv_text.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        text = gv_text.

*   Get SAP data
    PERFORM get_sap_data USING it_out-aufnr it_out-oper.
    CHECK gv_error IS INITIAL.

*   Check if status is not CNF, TECO or CLSD
    CLEAR gv_stat_nok.
    PERFORM check_status.
    CHECK gv_stat_nok IS INITIAL.

*   Check status REL
    PERFORM check_status_rel.

*   Update operation data
    PERFORM update_operation.

*   Update OK ?
    IF gv_error IS INITIAL.
*     Count
      gv_cnt_upd = gv_cnt_upd + 1.
*     Remove from table
      DELETE it_out.
    ENDIF.

  ENDLOOP.

  MESSAGE i001(00) WITH 'Number of Service Orders updated : '(i03)
                        gv_cnt_upd.

ENDFORM.                    " UPDATE_SERVICE_ORDERS

*&---------------------------------------------------------------------*
*&      Form  CHECK_STATUS
*&---------------------------------------------------------------------*
*       Check if status is not CNF, TECO or CLSD
*----------------------------------------------------------------------*
FORM check_status .

  CONCATENATE 'OR' it_out-aufnr INTO gv_objnr.

* Check status CNF (Confirmed)
  CALL FUNCTION 'STATUS_CHECK'
    EXPORTING
      objnr             = gv_objnr
      status            = c_stat_cnf
    EXCEPTIONS
      object_not_found  = 1
      status_not_active = 2
      OTHERS            = 3.
  IF sy-subrc = 0.
    gv_stat_nok = 'X'.
    RETURN.
  ELSE.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

* Check status TECO (Technical Completed)
  CALL FUNCTION 'STATUS_CHECK'
    EXPORTING
      objnr             = gv_objnr
      status            = c_stat_teco
    EXCEPTIONS
      object_not_found  = 1
      status_not_active = 2
      OTHERS            = 3.
  IF sy-subrc = 0.
    gv_stat_nok = 'X'.
    RETURN.
  ELSE.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

* Check status CLSD (Closed)
  CALL FUNCTION 'STATUS_CHECK'
    EXPORTING
      objnr             = gv_objnr
      status            = c_stat_clsd
    EXCEPTIONS
      object_not_found  = 1
      status_not_active = 2
      OTHERS            = 3.
  IF sy-subrc = 0.
    gv_stat_nok = 'X'.
    RETURN.
  ELSE.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.                    " CHECK_STATUS

*&---------------------------------------------------------------------*
*&      Form  CHECK_STATUS_REL
*&---------------------------------------------------------------------*
*       Check status REL (Released)
*----------------------------------------------------------------------*
FORM check_status_rel .

  CONCATENATE 'OR' it_out-aufnr INTO gv_objnr.

  CLEAR gv_stat_rel.

  CALL FUNCTION 'STATUS_CHECK'
    EXPORTING
      objnr             = gv_objnr
      status            = c_stat_rel
    EXCEPTIONS
      object_not_found  = 1
      status_not_active = 2
      OTHERS            = 3.
  IF sy-subrc = 0.
    gv_stat_rel = 'X'.
  ELSE.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.                    " CHECK_STATUS_REL

*&---------------------------------------------------------------------*
*&      Form  UPDATE_OPERATION
*&---------------------------------------------------------------------*
*       Update operation data
*----------------------------------------------------------------------*
FORM update_operation .

  REFRESH: i_bdcdata, i_messtab.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLCOIH'  '0101'  'X' ' ' ' '
                 CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  '' ' ' 'CAUFVD-AUFNR' it_out-aufnr
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  '' ' ' 'BDC_OKCODE'  '/00'
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

*----------------------------------------------------------------------*
*   Operations
*----------------------------------------------------------------------*
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLCOIH'  '3000'  'X' ''  ''
               CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  '' 'BDC_OKCODE'  '=VGUE'
               CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

*----------------------------------------------------------------------*
*   Select all operations
*----------------------------------------------------------------------*
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    'SAPLCOIH'  '3000'  'X' ''  ''
       CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
      USING    ''  ''  '' 'BDC_OKCODE' '=AMAK'
      CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

*----------------------------------------------------------------------*
*   General data
*----------------------------------------------------------------------*
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    'SAPLCOIH'  '3000'  'X' ''  ''
       CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
      USING    ''  ''  '' 'BDC_OKCODE' '=VGD0'
      CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

*----------------------------------------------------------------------*
*   Hit the next operation button as many times as necessary to find
*   the correct operation
*----------------------------------------------------------------------*
  IF gv_oper_index > 1.
    gv_count = gv_oper_index - 1.
    DO gv_count TIMES.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLCOIH'  '3000'  'X' ''  ''
           CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  '' 'BDC_OKCODE' '=VG+'
          CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDDO.
  ENDIF.
*----------------------------------------------------------------------*
*   Change workcenter (eventually) and go to the tab dates
*----------------------------------------------------------------------*
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    'SAPLCOIH'  '3000'  'X' ''  ''
       CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  IF NOT it_out-workc_vt IS INITIAL.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  '' 'AFVGD-ARBPL' it_out-workc_vt
                CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
  ENDIF.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  '' 'BDC_OKCODE' '=VGD1'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLCOIH'  '3000'  'X' ''  ''
               CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  gv_dur_a = it_out-dur_vt.
  gv_arbei_p =   gv_dur_a / 60.
  IF NOT gv_arbei_p IS INITIAL.
    WRITE gv_arbei_p TO gv_arbei.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  '' 'AFVGD-ARBEI' gv_arbei
                        CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
  ENDIF.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  '' 'BDC_OKCODE' '=VGD3'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

*----------------------------------------------------------------------*
*   To the tab with the enhancement
*----------------------------------------------------------------------*
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    'SAPLCOIH'  '3000'  'X' ''  ''
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  '' 'BDC_OKCODE' '=VGD5'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.
*----------------------------------------------------------------------*
*   Update the field 'field key'
*----------------------------------------------------------------------*
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    'SAPLCOIH'  '3000'  'X' ''  ''
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
      USING    ''  ''  '' 'AFVGD-SLWID' c_z000001
      CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
        USING    ''  ''  '' 'BDC_OKCODE' '/00'
        CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLCOIH'  '3000'  'X' ''  ''
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Status Fixed
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
    USING    ''  ''  '' 'AFVGD-USR11' c_x
    CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Order alrady released ?
  IF NOT gv_stat_rel IS INITIAL.
*   Save
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
        USING    ''  ''  '' 'BDC_OKCODE' '=BU'
        CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
  ELSE.
*  Release the order
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  '' 'BDC_OKCODE' '=IHKZ'
         CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLCOIH'  '3000'  'X' ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  '' 'BDC_OKCODE' '=FREI'
          CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
*   Save
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLCOIH'  '3000'  'X' ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  '' 'BDC_OKCODE' '=BU'
          CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
  ENDIF.
*----------------------------------------------------------------------*
*   Call transaction IW32
*----------------------------------------------------------------------*
  CALL TRANSACTION  'IW32'  USING i_bdcdata
                            MODE gv_mode
                            UPDATE 'S'
                            MESSAGES INTO i_messtab.

* Check if BDC error
  IF NOT i_messtab[] IS INITIAL.
    LOOP AT i_messtab WHERE msgtyp = 'E'  OR
                            msgtyp = 'A'.
      gv_error = 'X'.
      EXIT.
    ENDLOOP.
  ENDIF.
  CHECK gv_error IS INITIAL.

* Dates
  IF it_out-date_vt NE it_out-date_sap.
*   Update dates
    PERFORM update_dates.
*   Update dates from other operations
    PERFORM update_dates_oper.
  ENDIF.

* User status
  IF it_out-status_sap IS INITIAL.
    PERFORM update_user_status.
  ENDIF.

*----------------------------------------------------------------------*
* If there is a workcenter change --> also change notification
*----------------------------------------------------------------------*
  REFRESH i_bdcdata.

  IF it_out-workc_vt NE it_out-workc_sap  AND
     it_out-oper = c_0010                 AND
     NOT it_out-workc_vt IS INITIAL.
    PERFORM change_workcenter.
  ENDIF.

ENDFORM.                    " UPDATE_OPERATION

*&---------------------------------------------------------------------*
*&      Form  UPDATE_DATES
*&---------------------------------------------------------------------*
*       Update dates
*----------------------------------------------------------------------*
FORM update_dates .

  SELECT SINGLE aufpl INTO gv_aufpl
         FROM afko
         WHERE aufnr = it_out-aufnr.

  CALL FUNCTION 'CO_DB_AFVG_READ_WITH_VORNR'
    EXPORTING
      afvg_nummer = gv_aufpl
      vornr_imp   = it_out-oper
*      VSNMR_IMP   =
    IMPORTING
      afvgd_exp   = gv_afvgd_old
    EXCEPTIONS
      not_found   = 1
      OTHERS      = 2
            .
  IF sy-subrc = 0.
    CLEAR: gv_newdate.
    CLEAR: gv_enddate.
    IF NOT it_out-date_vt IS INITIAL.
      gv_newdate = it_out-date_vt.
      gv_seconds = it_out-dur_vt * 60.

      CALL FUNCTION 'CX_SCHED_VIA_OPERATING_TIME'
       EXPORTING
         i_date_start          = gv_newdate
*         i_time_start          = gv_newtime
         i_duration_sec        = gv_seconds
       IMPORTING
         e_date_end            = gv_enddate
*         e_time_end            = gv_endtime
       EXCEPTIONS
         parameters_not_valid  = 1
         OTHERS                = 2
            .
      IF sy-subrc <> 0.
      ENDIF.

*     Intercept wrong dates from Visitour
      IF gv_newdate(4) < '2000'.
        CLEAR: gv_gstrp, gv_gltrp.
        SELECT SINGLE gstrp gltrp INTO (gv_gstrp, gv_gltrp)
               FROM afko
               WHERE aufnr = it_out-aufnr.
        IF sy-subrc = 0.
          IF gv_gstrp < sy-datum.
            gv_gstrp = sy-datum.
          ENDIF.
          IF gv_gltrp < sy-datum.
            gv_gltrp = sy-datum.
          ENDIF.
          gv_newdate = gv_gstrp.
          gv_enddate = gv_gltrp.
        ENDIF.
      ENDIF.

*     Modify dates
      IF gv_newdate <> gv_afvgd_old-fsavd.
        gv_afvgd_new = gv_afvgd_old.
        MOVE gv_newdate TO gv_afvgd_new-fsavd.
        MOVE gv_newdate TO gv_afvgd_new-ssavd.
        IF NOT gv_enddate IS INITIAL.
          MOVE gv_enddate TO gv_afvgd_new-fsedd.
          MOVE gv_enddate TO gv_afvgd_new-ssedd.
        ELSE.
          MOVE gv_newdate TO gv_afvgd_new-fsedd.
          MOVE gv_newdate TO gv_afvgd_new-ssedd.
        ENDIF.

        UPDATE afvv SET fsavd = gv_afvgd_new-fsavd
                        ssavd = gv_afvgd_new-ssavd
                        fsedd = gv_afvgd_new-fsedd
                        ssedd = gv_afvgd_new-ssedd
                        epanf = gv_afvgd_new-fsavd
                        epend = gv_afvgd_new-fsedd
                        ntanf = gv_afvgd_new-fsavd
                        ntend = gv_afvgd_new-fsedd
                    WHERE aufpl = gv_afvgd_new-aufpl
                      AND aplzl = gv_afvgd_new-aplzl.

        PERFORM create_changedoc.

*       Extra updates on header (when operation = 0010)
        IF it_out-oper = c_0010.
          CLEAR: gv_bedid.
          SELECT SINGLE bedid INTO gv_bedid
                 FROM afko
                 WHERE aufnr = it_out-aufnr.
          IF sy-subrc = 0.
            UPDATE afko SET gstrs = gv_afvgd_new-fsavd
                            gltrs = gv_afvgd_new-fsedd
                        WHERE aufnr = it_out-aufnr.
            UPDATE kbko SET gstrs = gv_afvgd_new-fsavd
                            gltrs = gv_afvgd_new-fsedd
                        WHERE bedid = gv_bedid.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " UPDATE_DATES

*&---------------------------------------------------------------------*
*&      Form  CREATE_CHANGEDOC
*&---------------------------------------------------------------------*
*       Create change document
*----------------------------------------------------------------------*
FORM create_changedoc.

  DATA: n_afvv         TYPE afvv,
        o_afvv         TYPE afvv,
        objectid       TYPE cdhdr-objectid ,
        t_cdtxt        TYPE TABLE OF cdtxt,
        wa_viauf_afvc  TYPE viauf_afvc,
        lv_aufnr       TYPE aufnr,
        lv_autyp       TYPE auftyp.


  CLEAR : o_afvv, n_afvv, lv_aufnr, lv_autyp.

  IF gv_afvgd_old-epanf <> gv_afvgd_new-epanf.

    o_afvv-mandt = sy-mandt.
    o_afvv-aufpl = gv_afvgd_old-aufpl.
    o_afvv-aplzl = gv_afvgd_old-aplzl.
    o_afvv-epanf = gv_afvgd_old-epanf.

    n_afvv = o_afvv.
    n_afvv-epanf = gv_afvgd_new-epanf.

    SELECT SINGLE aufnr INTO lv_aufnr
           FROM viauf_afvc
           WHERE aufpl = gv_afvgd_old-aufpl
             AND aplzl = gv_afvgd_old-aplzl.

    IF sy-subrc = 0.
      SELECT SINGLE autyp INTO lv_autyp
             FROM aufk
             WHERE aufnr = lv_aufnr.
      CONCATENATE sy-mandt lv_autyp lv_aufnr INTO objectid.

      CALL FUNCTION 'YSE_AFVV_WRITE_DOCUMENT'
        EXPORTING
          objectid                = objectid
          tcode                   = 'IW32'
          utime                   = sy-uzeit
          udate                   = sy-datum
          username                = sy-uname
          planned_or_real_changes = 'R'
          n_afvv                  = n_afvv
          o_afvv                  = o_afvv
          upd_afvv                = 'U'
        TABLES
          icdtxt_afvv             = t_cdtxt.
    ENDIF.

  ENDIF.

ENDFORM.                    " CREATE_CHANGEDOC

*&---------------------------------------------------------------------*
*&      Form  UPDATE_DATES_OPER
*&---------------------------------------------------------------------*
*       Update dates from other operations
*----------------------------------------------------------------------*
FORM update_dates_oper .

  DATA: lv_oper    TYPE vornr,
        lv_afvgd   TYPE afvgd.


  SELECT SINGLE aufpl INTO gv_aufpl
         FROM afko
         WHERE aufnr = it_out-aufnr.

* First change header dates
  lv_oper = c_0010.
  CALL FUNCTION 'CO_DB_AFVG_READ_WITH_VORNR'
    EXPORTING
      afvg_nummer = gv_aufpl
      vornr_imp   = lv_oper
*      VSNMR_IMP   =
    IMPORTING
      afvgd_exp   = lv_afvgd
    EXCEPTIONS
      not_found   = 1
      OTHERS      = 2
            .
  IF sy-subrc = 0.
    CLEAR: gv_bedid.
    SELECT SINGLE bedid INTO gv_bedid
           FROM afko
           WHERE aufnr = it_out-aufnr.
    IF sy-subrc = 0.
      UPDATE afko SET gstrs = lv_afvgd-ntanf
                      gsuzs = lv_afvgd-ntanz
                      gltrs = lv_afvgd-ntend
                      gluzs = lv_afvgd-ntenz
                  WHERE aufnr = it_out-aufnr.
      UPDATE kbko SET gstrs = lv_afvgd-ntanf
                      gltrs = lv_afvgd-ntend
                  WHERE bedid = gv_bedid.
    ENDIF.
  ENDIF.

* Change other operations (when needed)
  LOOP AT i_operations WHERE control_key = 'ZCO3'.
    CHECK i_operations-activity NE it_out-oper.
    lv_oper = i_operations-activity.
    CALL FUNCTION 'CO_DB_AFVG_READ_WITH_VORNR'
      EXPORTING
        afvg_nummer = gv_aufpl
        vornr_imp   = lv_oper
*      VSNMR_IMP   =
      IMPORTING
        afvgd_exp   = lv_afvgd
      EXCEPTIONS
        not_found   = 1
        OTHERS      = 2
              .
    IF sy-subrc = 0.
      UPDATE afvv SET fsavd = lv_afvgd-ntanf
                      ssavd = lv_afvgd-ntanf
                      fsavz = lv_afvgd-ntanz
                      ssavz = lv_afvgd-ntanz
                      fsedd = lv_afvgd-ntend
                      ssedd = lv_afvgd-ntend
                      fsedz = lv_afvgd-ntenz
                      ssedz = lv_afvgd-ntenz
                      epanf = lv_afvgd-ntanf
                      epanz = lv_afvgd-ntanz
                      epend = lv_afvgd-ntend
                      epenz = lv_afvgd-ntenz
                  WHERE aufpl = lv_afvgd-aufpl
                    AND aplzl = lv_afvgd-aplzl.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " UPDATE_DATES_OPER

*&---------------------------------------------------------------------*
*&      Form  UPDATE_USER_STATUS
*&---------------------------------------------------------------------*
*       Update user status
*----------------------------------------------------------------------*
FORM update_user_status .

  DATA: lv_usr_stat_fixe  LIKE  tj30t-estat,
        lv_aufpl          LIKE afko-aufpl,
        ls_afvc           TYPE afvc.

  SELECT SINGLE aufpl INTO lv_aufpl
         FROM afko
         WHERE aufnr = it_out-aufnr.

  SELECT SINGLE * INTO ls_afvc
         FROM afvc
         WHERE aufpl = lv_aufpl
           AND vornr = it_out-oper.

  CONCATENATE 'OV' ls_afvc-aufpl ls_afvc-aplzl INTO gv_objnr.

  SELECT SINGLE estat INTO lv_usr_stat_fixe
         FROM tj30t
         WHERE stsma = 'ZAM00003'
           AND txt04 = 'FIXE'
           AND spras = sy-langu.

  CALL FUNCTION 'STATUS_CHANGE_EXTERN'
    EXPORTING
      check_only          = ' '
      client              = sy-mandt
      objnr               = gv_objnr
      user_status         = lv_usr_stat_fixe
      set_inact           = ' '
      no_check            = ' '
    EXCEPTIONS
      object_not_found    = 1
      status_inconsistent = 2
      status_not_allowed  = 3
      OTHERS              = 4.
  IF sy-subrc = 0.
*   COMMIT WORK AND WAIT.
    PERFORM process_commit.
  ENDIF.

ENDFORM.                    " UPDATE_USER_STATUS

*&---------------------------------------------------------------------*
*&      Form  PROCESS_COMMIT
*&---------------------------------------------------------------------*
*       Process commit
*----------------------------------------------------------------------*
FORM process_commit .

  DATA: lv_bapiret2 TYPE bapiret2.

  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
    EXPORTING
      wait   = 'X'
    IMPORTING
      return = lv_bapiret2.

ENDFORM.                    " PROCESS_COMMIT

*&---------------------------------------------------------------------*
*&      Form  CHANGE_WORKCENTER
*&---------------------------------------------------------------------*
*       Change workcenter
*----------------------------------------------------------------------*
FORM change_workcenter .

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING    'SAPLIQS0'  '0100'  'X' ' ' ' '
                       CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  '' ' ' 'RIWO00-QMNUM' i_es_header-notif_no
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  '' ' ' 'BDC_OKCODE'  '/00'
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING    'SAPLIQS0'  '7200'  'X' ' ' ' '
                         CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  '' ' ' 'RIWO00-GEWRK' it_out-workc_vt
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  '' ' ' 'BDC_OKCODE'  '=BUCH'
     CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.
*----------------------------------------------------------------------*
*   Call transaction IW52
*----------------------------------------------------------------------*
  CALL TRANSACTION  'IW52'  USING i_bdcdata
                            MODE gv_mode
                            UPDATE 'S'
                            MESSAGES INTO i_messtab.

ENDFORM.                    " CHANGE_WORKCENTER

*Text symbol text£º
*H01:Monitoring VisiTour vs. SAP
*I01:No differences found
*I02:Operation & of Order & is being processed
*I03:Number of Service Orders updated :
*Q01:You are about to update the selected Service Orders. Are you sure to continue ?
*T01:Service Order
*T02:Operation
*T03:Status VT
*T04:Status Fixed SAP
*T05:Workcenter VT
*T06:Workcenter SAP
*T07:Duration VT (m)
*T08:Duration SAP (h)
*T09:Date VT
*T10:Date SAP

*T11:Stat. Closed SAP
*Selection text£º
*P_INFILE:        Input file
