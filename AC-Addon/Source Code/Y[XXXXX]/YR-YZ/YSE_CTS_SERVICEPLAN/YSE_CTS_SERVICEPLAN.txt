*----------------------------------------------------------------------*
* PROGRAM ID           : YSE_CTS_SERVICEPLAN                           *
* PROGRAM TITLE        : CTS Service Plan report                       *
* AUTHOR               : Pratap Mada                                   *
* DATE                 : 25/06/2012                                    *
* DEVELOPMENT ID       :                                               *
* CHANGE REQUEST NUMBER: CD1K972315                                    *
*                        CD1K972442                                    *
*                        CD1K972448                                    *
*                        CD1K972448                                    *
*                        CD1K972458                                    *
*                        CD1K972475                                    *
*                        CD1K972476                                    *
*                        CD1K972478                                    *
*                        CD1K972484                                    *
*                        CD1K972515                                    *
*                        CD1K972517                                    *
*                        CD1K972519                                    *
*                        CD1K972541                                    *
*                        CD1K972545                                    *
*                        CD1K972551                                    *
*                        CD1K972562                                    *
*                        CD1K972564                                    *
*                        CD1K972566                                    *
*                        CD1K972568                                    *
*                        CD1K972594                                    *
*                        CD1K972696                                    *
*                        CD1K972736                                    *
*                        CD1K972895                                    *
*                        CD1K972899                                    *
*                        CD1K972908                                    *
*                        CD1K972939                                    *
* PROGRAM DESCRIPTION  : Create report with orders with service plan   *
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
* MOD.NR. | DATE       | NAME           | CORRECTION NR. | CHANGE REF. *
*----------------------------------------------------------------------*
* MOD-001 | 23.01.2014 | D.Praveen Babu | CD1K980109     |  CR3144     *
*         | Cumulative NIS in YSE_CTS report                           *
*----------------------------------------------------------------------*
REPORT yse_cts_serviceplan NO STANDARD PAGE HEADING
                                    LINE-SIZE 400.

INCLUDE yse_cts_serviceplan_top.


*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_vkorg.

  AUTHORITY-CHECK OBJECT 'V_VBRK_VKO'
           ID 'VKORG' FIELD p_vkorg
           ID 'ACTVT' FIELD '03'.

  IF sy-subrc NE 0.
*.. No authorization for sales organisation: &1
    MESSAGE e001(00) WITH text-e03 p_vkorg.
  ENDIF.

* begin of insertion MOD-002
*...................Transaction counter...............................*
  CALL METHOD ycl_statistics=>record_transaction .
* end of insertion MOD-002
AT SELECTION-SCREEN ON s_perio.

  IF s_vbeln-low  IS INITIAL AND
     s_vbeln-high IS INITIAL.
    IF NOT s_perio-high IS INITIAL.
*.... Fill in only 1 period !
      MESSAGE e001(00) WITH text-e04.
    ENDIF.
  ENDIF.

*-INITIALIZATION--------------------------------------------------------
INITIALIZATION.
* to become SDI statusses at F4
  EXPORT p_obtyp = 'VBP' TO MEMORY ID 'PM_OBTYP'.


*-START OF SELECTION----------------------------------------------------
START-OF-SELECTION.

  PERFORM get_data.

*-----------------------------------------------------------------------
END-OF-SELECTION.

* Process the data
  PERFORM process_data.

* create ALV-GRID
  PERFORM build_field_catlog CHANGING gt_fieldcat.
  PERFORM fill_events_f14.
  PERFORM alv_display.


*- SUBROUTINES---------------------------------------------------------
*&---------------------------------------------------------------------*
*&      Form  build_field_catlog
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FIELDCAT  text
*----------------------------------------------------------------------*
FORM build_field_catlog  CHANGING pt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA : ls_fcat TYPE slis_fieldcat_alv.

*-----------------------Profit Center---------------------*
  ls_fcat-fieldname = 'PRCTR'.
*  ls_fcat-rollname = 'PRCTR'.
  ls_fcat-outputlen = '15'.

  CALL FUNCTION 'YSE_CHECK_DEV_MATRIX'
    EXPORTING
      object      = 'YSE_NEWGL_ACTIVE'
      checkfield  = 'BUKRS'
      value_field = gv_bukrs2
      counter     = 1
    EXCEPTIONS
      active      = 1
      passive     = 2
      not_found   = 3
      OTHERS      = 4.
  IF sy-subrc = 1.
    gv_newgl_active = 'Y'.
  ELSE.
    gv_newgl_active = 'N'.
  ENDIF.
  IF gv_newgl_active = 'Y'.
    ls_fcat-seltext_l = 'Segment'(i50).
  ELSE.
    ls_fcat-seltext_l = 'Profit Center'(i49).
  ENDIF.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero    = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------GAC-------------------------------*
  ls_fcat-fieldname = 'WW006'.
  ls_fcat-rollname = 'RKEG_WW006'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.


*-----------------------PGC-------------------------------*
  ls_fcat-fieldname = 'WW007'.
  ls_fcat-rollname = 'RKEG_WW007'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------Acc.indicator-------------------*
  ls_fcat-fieldname = 'WW003'.
  ls_fcat-rollname = 'RKEG_WW003'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------Customer name-----------------*
  ls_fcat-fieldname = 'NAME1'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer Name'(i19).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Distr.Channel--------------------*
  ls_fcat-fieldname = 'VTWEG'.
  ls_fcat-rollname = 'VTWEG'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Sales document--------------------*
  ls_fcat-fieldname = 'VBELN'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Sales Doc no'(008).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Sales Document Item----------------*
  ls_fcat-fieldname = 'POSNR'.
  ls_fcat-rollname = 'POSNR_VA'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------Material group--------------------*
  ls_fcat-fieldname = 'MATKL'.
  ls_fcat-rollname = 'MATKL'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Currency------------------------*
  ls_fcat-fieldname = 'REC_WAERS'.
  ls_fcat-rollname = 'WAERS'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------Posting PERIOD-----------------------*
  ls_fcat-fieldname = 'PERIO'.
  ls_fcat-outputlen = '8'.
  ls_fcat-seltext_l = text-002. "'PSTG Period'(002).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Equipment-------------------------*
  ls_fcat-fieldname = 'EQUNR'.
  ls_fcat-rollname = 'EQUNR'.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Product---------------------------*
  ls_fcat-fieldname = 'MATNR'.
  ls_fcat-outputlen = '18'.
  ls_fcat-seltext_l = 'Product'(009).
  ls_fcat-no_zero   = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------NIS ----"Revenues Actual---------------------*
  ls_fcat-fieldname = 'TOT_VV100'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = text-i31. "NIS   "'Revenues Actual'(i31).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------InvoiceD revenue --Net invoiced sales Actual----------*
  ls_fcat-fieldname = 'NET_INV_SLS'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-i33. "Invoice Revenue
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------Parts Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV200'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Parts Actual'(i35).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Labour Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV300'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Labour Actual'(i36).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Ad Hoc Expenses Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV600'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Ad Hoc Expenses Actual'(i38).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Subcontracting Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV500'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Subcontracting Actual'(i39).
  APPEND ls_fcat TO pt_fieldcat.

*  *-----------------------Mileage Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV400'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Mileage Actual'(i37).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Fix price accruals Actual---------------*
  ls_fcat-fieldname = 'TOT_VV114'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Fix price accruals Actual'(i41).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Unadjusted COGS Actual------------------*
  ls_fcat-fieldname = 'UNADJ_COGS'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Unadjusted COGS Actual'(i42).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Unadjusted Gross Profit Actual----------*
  ls_fcat-fieldname = 'UNADJ_GP'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Unadjusted Gross Profit Actual'(i43).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Sales office text--------------*
  ls_fcat-fieldname = 'VKBUR_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales office(Text)'(i15).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Sales group---------------------*
  ls_fcat-fieldname = 'VKGRP'.
  ls_fcat-rollname = 'VKGRP'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales group text--------------*
  ls_fcat-fieldname = 'VKGRP_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales group(Text)'(i55).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Sales district--------------------*
  ls_fcat-fieldname = 'BZIRK'.
  ls_fcat-rollname = 'BZIRK'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

**-----------------------Sales district text--------------*
*  ls_fcat-fieldname = 'BZIRK_TEXT'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Sales district(Text)'(i14).
*  append ls_fcat to pt_fieldcat.
*  clear ls_fcat.

*-----------------------SDI status-------------------------*
  ls_fcat-fieldname = 'STTXT'.
  ls_fcat-rollname = 'J_STEXT'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------Start date------------------------*
  ls_fcat-fieldname = 'GUEBG'.
  ls_fcat-rollname = 'VBDAT_VEDA'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------End date------------------------*
  ls_fcat-fieldname = 'GUEEN'.
  ls_fcat-rollname = 'VNDAT_VEDA'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Contract item value total---------*
  ls_fcat-fieldname = 'TOT_VAL'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Contract item value total'(i28).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Tot.Revenues Planned---------------------*
  ls_fcat-fieldname = 'TOT_PLREV'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Tot.Revenues Planned'(i45).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Tot.Costs Planned-------------------*
  ls_fcat-fieldname = 'TOT_PLCOST'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Tot.Costs Planned'(i46).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Total Actual Costs-------------------*
  ls_fcat-fieldname = 'TOT_ACCOST'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-003. "'Total Actual Costs'(003).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*-----------------------Balance Receivables not invoiced----------*
  ls_fcat-fieldname = 'BAL_REC_NOT_INV'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-004. "'Unbilled Recognized Revenue'(004).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.


*-----------------------Balance Accrued Revenue----------*
  ls_fcat-fieldname = 'BAL_ACCR_REV'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-005. "'YTD Deferred Revenue'(005).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.


*-----------------------New Balance Accrued Revenue----------*
  ls_fcat-fieldname = 'BAL_DEF_REV'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-006. "'MTD Deferred Revenue'(006).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

*  *-----------------------New Balance Accrued Revenue----------*
  ls_fcat-fieldname = 'BAL_ACCR_REV_NEW'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-007. "'MTD Accured Revenue'(007).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*Begin of MOD-001.
*  *-----------------------Actual Cost----------*
  ls_fcat-fieldname = 'WOGBTR'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = text-010. "Actual Cost.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*End of MOD-001.
ENDFORM.                    " build_field_catlog

*&---------------------------------------------------------------------*
*&      Form  fill_events_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_events_f14 .

  DATA lv_event       TYPE slis_alv_event.

  CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
    EXPORTING
      i_list_type = 0
    IMPORTING
      et_events   = gt_events_tab.

*--- allocate form for user-command ---------------------------------*
  READ TABLE gt_events_tab WITH KEY name = slis_ev_user_command
                        INTO lv_event.
  IF sy-subrc = 0.
    MOVE gv_form_user_command TO lv_event-form.
    MODIFY gt_events_tab FROM lv_event INDEX sy-tabix.
  ENDIF.

ENDFORM.                    " fill_events_f14

*&--------------------------------------------------------------------*
*&      Form  user_command_l
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*---------------------------------------------------------------------*
FORM user_command_l                                         "#EC CALLED
                 USING p_ucomm LIKE sy-ucomm                "#EC NEEDED
                          p_selfield TYPE slis_selfield.    "#EC NEEDED

  p_selfield-refresh = 'S'.
  PERFORM check_pf2_with_object_f16 USING p_ucomm.
  PERFORM set_p_selfield_general_f16 USING p_selfield.

  CASE p_ucomm.
    WHEN 'ISEL'.
      p_ucomm = 'DISP'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
  ENDCASE.

ENDFORM.                    "user_command_l

*&---------------------------------------------------------------------*
*&      Form  check_pf2_with_object_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*----------------------------------------------------------------------*
FORM check_pf2_with_object_f16  USING    p_ucomm TYPE syucomm.

  CHECK p_ucomm = gv_ic1.
  p_ucomm = 'ISEL'.

ENDFORM.                    " check_pf2_with_object_f16

*&---------------------------------------------------------------------*
*&      Form  set_p_selfield_general_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
FORM set_p_selfield_general_f16  USING f_selfield TYPE slis_selfield.

  f_selfield-col_stable = gc_x.
  f_selfield-row_stable = gc_x.

ENDFORM.                    " set_p_selfield_general_f16

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*      -->P_ENDCASE  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_f16  USING p_ucomm LIKE sy-ucomm      "#EC NEEDED
                                p_selfield TYPE slis_selfield. "#EC NEEDED

  PERFORM check_object_tab_marked_f14 USING p_ucomm p_selfield.

  LOOP AT gt_final INTO wa_final WHERE selected = gc_x .
    gv_index = sy-tabix.
    PERFORM fcodes_with_mark_l USING p_ucomm p_selfield.
    wa_final-selected = ' '.
    MODIFY gt_final FROM wa_final INDEX gv_index.
  ENDLOOP.

  CLEAR p_ucomm.

ENDFORM.                    " fcodes_with_mark_f16

*&---------------------------------------------------------------------*
*&      Form  check_object_tab_marked_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
FORM check_object_tab_marked_f14  USING    p_ucomm LIKE sy-ucomm "#EC NEEDED
                                        p_selfield TYPE slis_selfield. "#EC NEEDED

  READ TABLE gt_final INTO wa_final
               WITH KEY selected = gc_x.

  IF NOT sy-subrc IS INITIAL.
    IF NOT p_selfield-tabindex IS INITIAL.
      READ TABLE gt_final INTO wa_final
                INDEX p_selfield-tabindex.
      wa_final-selected = gc_x.
      MODIFY gt_final FROM wa_final
            INDEX p_selfield-tabindex.
    ENDIF.
  ELSE.
*--- Checkbox markiert -----------------------------------------------*
    p_selfield-sel_tab_field = 'G_MARK'.
  ENDIF.

ENDFORM.                    " check_object_tab_marked_f14

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_F_UCOMM  text
*      -->P_F_SELFIELD  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_l  USING   p_ucomm LIKE sy-ucomm      "#EC NEEDED
                              p_selfield TYPE slis_selfield. "#EC NEEDED
  CASE p_ucomm.
*   Display Contract
    WHEN 'DISP'.
      SET PARAMETER ID 'KTN' FIELD wa_final-vbeln.
      CALL TRANSACTION 'VA43' AND SKIP FIRST SCREEN.     "#EC CI_CALLTA
  ENDCASE.

ENDFORM.                    " fcodes_with_mark_l

*&---------------------------------------------------------------------*
*&      Form  alv_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_display .

  gv_repid = sy-repid.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
     EXPORTING
       i_callback_program                =  gv_repid
       i_save                            = 'A'
       it_events                         =  gt_events_tab[]
*      I_GRID_TITLE                      =
*      I_GRID_SETTINGS                   =
*      is_layout                         =  g_layout
       it_fieldcat                       =  gt_fieldcat[]
     TABLES
        t_outtab                         =  gt_final.

ENDFORM.                    " alv_display

*&---------------------------------------------------------------------*
*&      Form  check_statusses
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM check_statusses USING r_objnr TYPE objpo.

  CLEAR: g_excl,
         g_incl.

  REFRESH: gt_status,
           gt_statustext.

* get active statusses
  CALL FUNCTION 'STATUS_READ'
    EXPORTING
      objnr       = r_objnr
      only_active = 'X'
    TABLES
      status      = gt_status
    EXCEPTIONS
      OTHERS      = 01.

  CHECK sy-subrc = 0.

* get status descriptions
  LOOP AT gt_status INTO wa_status.
    CALL FUNCTION 'STATUS_NUMBER_CONVERSION'
      EXPORTING
        language      = sy-langu
        objnr         = r_objnr
        status_number = wa_status-stat
      IMPORTING
        txt04         = wa_statustext-txt04
      EXCEPTIONS
        OTHERS        = 01.
    IF sy-subrc = 0.
      APPEND wa_statustext TO gt_statustext.
    ENDIF.
  ENDLOOP.

* check status inclusive
  IF NOT g_stai1_lines IS INITIAL.
    LOOP AT gt_statustext INTO wa_statustext.
      LOOP AT gt_stai1 INTO wa_stai1.
        IF wa_stai1-low = wa_statustext-txt04.
          g_incl = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF g_incl = 'X'.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDIF.

* check status exclusive
  IF NOT g_stae1_lines IS INITIAL.
    LOOP AT gt_statustext INTO wa_statustext.
      LOOP AT gt_stae1 INTO wa_stae1.
        IF wa_stae1-low = wa_statustext-txt04.
          g_excl = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF g_excl = 'X'.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.                    "check_statusse
*&---------------------------------------------------------------------*
*&      Form  GET_COPADATA
*&---------------------------------------------------------------------*
*       Get the copa information
*----------------------------------------------------------------------*
FORM get_copadata .

  REFRESH: gt_copa2.
  SELECT SINGLE bukrs
    INTO gv_bukrs2
    FROM tvko
    WHERE vkorg = p_vkorg.

  SELECT  paledger
          vrgar
          versi
          perio
          paobjnr
          pasubnr
          belnr
          posnr
          budat
          rec_waers
          kaufn
          kdpos
          bukrs
          kokrs
          prctr
          equnr
          ww002
          ww003
          ww006
          ww007
          vv100
          vv110
          vv200
          vv300
          vv400
          vv500
          vv600
          vv120
          vv112
          vv113
          vv114
          vv130
          vv140
          vv150
          FROM ce11000
          INTO TABLE gt_copa
          FOR ALL ENTRIES IN gt_vbap
          WHERE vrgar    IN ('C', 'B', 'F' )
               AND kaufn    EQ gt_vbap-vbeln
               AND kdpos    EQ gt_vbap-posnr.

  DELETE gt_copa WHERE paledger NE '02'.
  DELETE gt_copa WHERE equnr NOT IN s_equnr.
  DELETE gt_copa WHERE prctr NOT IN s_prctr.
  DELETE gt_copa WHERE ww002 NOT IN s_plc.
  DELETE gt_copa WHERE ww006 NOT IN s_gac.
  DELETE gt_copa WHERE ww007 NOT IN s_pgc.

  gt_copa2[] = gt_copa[].
  DELETE gt_copa WHERE perio NOT IN s_perio.
  DELETE gt_copa2 WHERE vrgar NE 'C'.

*Begin of MOD-001++
  PERFORM get_actual_cost.
*End of MOD-001++


ENDFORM.                    " GET_COPADATA
*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
*       Fill and process the final output data
*----------------------------------------------------------------------*
FORM process_data .
* Cumulate detailrecords
  Data:lv_wogbtr type wtgxxx."MOD-001++
  SORT gt_copa BY vrgar kaufn kdpos.
  LOOP AT gt_copa INTO wa_copa.

    wa_final-prctr1 = wa_copa-prctr.
    CALL FUNCTION 'YSE_CONVERT_PRCTR_BL'
      EXPORTING
        prctr_in    = wa_copa-prctr
        bukrs       = wa_copa-bukrs
      IMPORTING
        segment_out = wa_copa-prctr.

    SELECT SINGLE ww002 INTO gv_ww002
        FROM ce41000
        WHERE aktbo = gc_x
          AND paobjnr = wa_copa-paobjnr
          AND pasubnr = wa_copa-pasubnr.
    IF sy-subrc = 0.
      wa_copa-ww002 = gv_ww002.
    ENDIF.

    MOVE-CORRESPONDING wa_copa TO wa_final.

    CLEAR wa_vbap.
    READ TABLE gt_vbap INTO wa_vbap
                        WITH KEY vbeln = wa_copa-kaufn
                                posnr = wa_copa-kdpos
                 BINARY SEARCH.
    IF sy-subrc EQ 0.
      MOVE-CORRESPONDING wa_vbap TO wa_final.
*Begin of MOD-001++
      CLEAR: wa_coep,lv_wogbtr.
      READ TABLE gt_coep INTO wa_coep WITH KEY objnr = wa_vbap-objnr.
      IF sy-subrc EQ 0.
        lv_wogbtr = - 1 * wa_coep-wogbtr.
        MOVE:lv_wogbtr TO wa_final-wogbtr.
      ENDIF.
*End of MOD-001++
      CLEAR wa_veda.
      READ TABLE gt_veda INTO wa_veda
                      WITH KEY vbeln = wa_vbap-vbeln
                               vposn = wa_vbap-posnr
                       BINARY SEARCH.
      IF sy-subrc NE 0.
        READ TABLE gt_veda INTO wa_veda
                   WITH KEY vbeln = wa_vbap-vbeln
                            vposn = '000000'.
      ENDIF.
      IF sy-subrc EQ 0.
        wa_final-guebg = wa_veda-vbegdat.  "Contract start date
        wa_final-gueen = wa_veda-venddat.  "Contract end date
        IF wa_veda-vbegdat LT g_fdate.
          g_fdate = wa_veda-vbegdat.
        ENDIF.
      ENDIF.

      wa_final-perio     = wa_copa-perio.

      CLEAR wa_final1.
      READ TABLE gt_final INTO wa_final1
                   WITH KEY perio = wa_copa-perio
                            vbeln = wa_copa-kaufn
                            posnr = wa_copa-kdpos.
      IF sy-subrc NE 0.

        wa_final-tot_vv200 = wa_copa-vv200.
        wa_final-tot_vv300 = wa_copa-vv300.
        wa_final-tot_vv400 = wa_copa-vv400.
        wa_final-tot_vv500 = wa_copa-vv500.
        wa_final-tot_vv600 = wa_copa-vv600.
        wa_final-tot_vv100 = wa_copa-vv100.
        wa_final-tot_vv120 = wa_copa-vv120.
        wa_final-tot_vv112 = wa_copa-vv112.
        wa_final-tot_vv110 = wa_copa-vv110.
        wa_final-tot_vv114 = wa_copa-vv114.
        wa_final-tot_vv130 = wa_copa-vv130.
        wa_final-tot_vv140 = wa_copa-vv140.
        wa_final-tot_vv150 = wa_copa-vv150.

*     *Calculating MTD Deferred Revenue and MTD accured revenue
*    CLEAR: wa_bseg1,
*           wa_bseg.
        APPEND wa_final TO gt_final.
        CLEAR wa_final.

      ELSE.

        wa_final-tot_vv200 = wa_final1-tot_vv200 + wa_copa-vv200.
        wa_final-tot_vv300 = wa_final1-tot_vv300 + wa_copa-vv300.
        wa_final-tot_vv400 = wa_final1-tot_vv400 + wa_copa-vv400.
        wa_final-tot_vv500 = wa_final1-tot_vv500 + wa_copa-vv500.
        wa_final-tot_vv600 = wa_final1-tot_vv600 + wa_copa-vv600.
        wa_final-tot_vv100 = wa_final1-tot_vv100 + wa_copa-vv100.
        wa_final-tot_vv120 = wa_final1-tot_vv120 + wa_copa-vv120.
        wa_final-tot_vv112 = wa_final1-tot_vv112 + wa_copa-vv112.
        wa_final-tot_vv110 = wa_final1-tot_vv110 + wa_copa-vv110.
        wa_final-tot_vv114 = wa_final1-tot_vv114 + wa_copa-vv114.
        wa_final-tot_vv130 = wa_final1-tot_vv130 + wa_copa-vv130.
        wa_final-tot_vv140 = wa_final1-tot_vv140 + wa_copa-vv140.
        wa_final-tot_vv150 = wa_final1-tot_vv150 + wa_copa-vv150.

*Calculating MTD Deferred Revenue and MTD accured revenue
*    CLEAR: wa_bseg1,
*           wa_bseg.
        MODIFY gt_final FROM wa_final INDEX sy-tabix.
        CLEAR wa_final.
      ENDIF.
    ENDIF.
  ENDLOOP.

  wa_fdate-sign = 'I'.
  wa_fdate-option = 'BT'.
  wa_fdate-low = g_fdate.
  wa_fdate-high = g_ldate.
  APPEND wa_fdate TO r_cdate.

  wa_hkont-sign = 'I'.
  wa_hkont-option = 'EQ'.
  wa_hkont-low = '0002997901'.
  APPEND wa_hkont TO r_hkont.
  wa_hkont-low = '0001780002'.
  APPEND wa_hkont TO r_hkont.


  REFRESH: gt_bsis.
  CLEAR g_tabix.

  PERFORM get_bsis.


  SORT gt_bsis BY zuonr prctr.

  REFRESH: gt_final1.
  gt_final1[] = gt_final[].
  DELETE gt_final1 WHERE kalnr IS INITIAL.
  IF gt_final1 IS NOT INITIAL.
*     *. Fetch planned cost via unit cost estimate
    SELECT  lednr
            bzobj
            kalnr
            kalka
            kadky
            tvers
            bwvar
            kkzma
            posnr
            wrtfw_kpf
           FROM ckis
           INTO TABLE gt_ckis
           FOR ALL ENTRIES IN gt_final1
           WHERE lednr = '00'
                  AND bzobj = '4'
                  AND kalnr = gt_final1-kalnr.
  ENDIF.

  REFRESH: gt_final1.
  gt_final1[] = gt_final[].
  DELETE gt_final1 WHERE fplnr IS INITIAL.
  IF gt_final1 IS NOT INITIAL.
    SELECT fplnr
           fpltr
           waers
           fakwr
           fksaf
           FROM fplt
           INTO TABLE gt_fplt
           FOR ALL ENTRIES IN gt_final1
           WHERE fplnr EQ gt_final1-fplnr
           AND fksaf IN ('A', 'C').
  ENDIF.


  SORT gt_bsis1 BY  bukrs belnr gjahr buzei prctr.
* Calculate remaining fields and get missing info
  LOOP AT gt_final INTO wa_final.
*.. Net invoiced sales
*    wa_final-net_inv_sls = wa_final-tot_vv100 + wa_final-tot_vv110.

*.. Unadjusted COGS Actual
    wa_final-unadj_cogs = wa_final-tot_vv200 + wa_final-tot_vv300 +
           wa_final-tot_vv400 + wa_final-tot_vv500 + wa_final-tot_vv600 +
           wa_final-tot_vv114 + wa_final-tot_vv130 +
           wa_final-tot_vv140 + wa_final-tot_vv150.

*.. Unadjusted Gross Profit Actual
    wa_final-unadj_gp = ( wa_final-tot_vv100 + wa_final-tot_vv110 ) - wa_final-unadj_cogs.

*.. Unadjusted Gross Profit Actual
    CATCH SYSTEM-EXCEPTIONS arithmetic_errors = 1.
      IF NOT wa_final-net_inv_sls IS INITIAL.
        wa_final-%ugp = 100 * wa_final-unadj_gp / ( wa_final-tot_vv100 + wa_final-tot_vv110 ).
      ENDIF.
    ENDCATCH.
    IF sy-subrc = 1.
      wa_final-%ugp = c_99999.
    ENDIF.

*.. Get SDI status
    CALL FUNCTION 'STATUS_TEXT_EDIT'
      EXPORTING
        flg_user_stat    = 'X'
        objnr            = wa_final-objnr
        only_active      = 'X'
        spras            = sy-langu
      IMPORTING
        line             = wa_final-sttxt
      EXCEPTIONS
        object_not_found = 1
        OTHERS           = 2.
    IF sy-subrc <> 0.                                       "#EC NEEDED
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

**.. Get descriptions

*.. Sales office
    SELECT SINGLE bezei INTO wa_final-vkbur_text
       FROM tvkbt WHERE spras = sy-langu
                    AND vkbur = wa_final-vkbur.

*.. Sales group
    SELECT SINGLE bezei INTO wa_final-vkgrp_text
       FROM tvgrt WHERE spras = sy-langu
                    AND vkgrp = wa_final-vkgrp.


    LOOP AT gt_fplt INTO wa_fplt
                 WHERE fplnr EQ wa_final-fplnr.

      IF wa_fplt-waers EQ wa_final-rec_waers.
        gv_out_fakwr = wa_fplt-fakwr.
      ELSE.
*    *       If not in CoCo currency, convert the value
        CALL FUNCTION 'CONVERT_AMOUNT_TO_CURRENCY'
          EXPORTING
            date             = wa_final-prsdt
            foreign_currency = wa_fplt-waers
            foreign_amount   = wa_fplt-fakwr
            local_currency   = wa_final-rec_waers
          IMPORTING
            local_amount     = gv_out_fakwr
          EXCEPTIONS
            error            = 1
            OTHERS           = 2.

      ENDIF.
      IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ELSE.
        IF wa_fplt-fksaf = 'C'.
          ADD gv_out_fakwr TO wa_final-inv.
        ELSE.
          ADD gv_out_fakwr TO wa_final-inv_out.
        ENDIF.
      ENDIF.
    ENDLOOP.


    wa_final-tot_val = wa_final-inv + wa_final-inv_out.
    wa_final-tot_plrev  = wa_final-tot_val.

*Total Planned Cost
    CLEAR wa_final-tot_plcost.
    LOOP AT gt_ckis INTO wa_ckis
            WHERE kalnr EQ wa_final-kalnr.
      wa_final-tot_plcost =  wa_final-tot_plcost + wa_ckis-wrtfw_kpf.
    ENDLOOP.
    IF sy-subrc NE 0.
      ADD 1 TO wa_final-tot_plcost.
    ENDIF.


*    CLEAR: g_vv100,
*          g_vv113.
    LOOP AT gt_copa2 INTO wa_copa2
                WHERE kaufn =  wa_final-vbeln
                AND kdpos = wa_final-posnr.


*      *Total Actual cost
      wa_final-tot_accost = wa_final-tot_accost + wa_copa2-vv200 + wa_copa2-vv300 +
                           wa_copa2-vv400 + wa_copa2-vv500 +
                           wa_copa2-vv600.

*      g_vv100 = g_vv100 + wa_copa2-vv100.
*      g_vv113 = g_vv113 + wa_copa2-vv113.
    ENDLOOP.

*
**    *      Unbilled recognized revenue
*    wa_final-bal_rec_not_inv = g_vv100 - g_vv113.
*
**      *      YTD deferred revenue
*    wa_final-bal_accr_rev = g_vv100 - g_vv113.
**
**    wa_final-tot_accost = wa_final-tot_vv200 + wa_final-tot_vv300 +
**                           wa_final-tot_vv400 + wa_final-tot_vv500 +
**                           wa_final-tot_vv600.
** Balance Receivables not invoiced
** When actual net invoiced sales < contract item invoice to-date than 0...else actual net invoiced
**  sales - contract item invoiced to-date
*    IF wa_final-bal_rec_not_inv < wa_final-inv.
*      wa_final-bal_rec_not_inv = 0.
*    ELSE.
*      wa_final-bal_rec_not_inv =  wa_final-bal_rec_not_inv - wa_final-inv .
*    ENDIF.
*
*
*
** When actual net invoiced sales < contract item invoice to-date than actual net invoiced sales -
**contract item invoiced to-date else 0
*    IF wa_final-bal_accr_rev < wa_final-inv.
*      wa_final-bal_accr_rev = wa_final-bal_accr_rev - wa_final-inv .
*    ELSE.
*      wa_final-bal_accr_rev = 0.
*    ENDIF.


*Calculating the MTD deferred revenue and MTD Accured revenue

    CLEAR: gv_zuonr,
           gv_peri.

    gv_peri = wa_final-perio.
    CLEAR wa_period.
    READ TABLE gt_period INTO wa_period
                       WITH KEY perio = gv_peri
                       BINARY SEARCH.
    IF sy-subrc EQ 0.
      CONCATENATE wa_final-vbeln wa_final-posnr INTO gv_zuonr.

      CLEAR: wa_final-bal_def_rev,
             wa_final-bal_accr_rev_new.

*Calculating MTD Deferred and accrued revenuw and YTD deferred and Accured revenue
      LOOP AT gt_bsis INTO wa_bsis
                   WHERE  zuonr EQ gv_zuonr AND
*                         ( budat GE wa_period-fdate AND
*                           budat LE wa_period-edate ) AND
                          budat IN  r_cdate AND
                          prctr EQ wa_final-prctr1.
        IF ( wa_bsis-budat GE wa_period-fdate AND wa_bsis-budat LE wa_period-edate ).
*          CalCulating the MTD deferred revenue and MTD accrued revenue
          IF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'H'.
            wa_final-bal_def_rev = wa_final-bal_def_rev + ( wa_bsis-dmbtr * -1 ).
          ELSEIF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'S'.
            wa_final-bal_def_rev = wa_final-bal_def_rev + wa_bsis-dmbtr .
          ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'H'.
            wa_final-bal_accr_rev_new = wa_final-bal_accr_rev_new + ( wa_bsis-dmbtr * -1 ).
          ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'S'.
            wa_final-bal_accr_rev_new = wa_final-bal_accr_rev_new + wa_bsis-dmbtr.
          ENDIF.
*          Calculating the Invoiced Revenue
          IF ( wa_bsis-blart NE 'ZZ' AND wa_bsis-blart NE 'SA' ).
            IF ( wa_bsis-hkont EQ '0002997901' OR wa_bsis-hkont EQ '0001780002' )
                       AND wa_bsis-shkzg EQ 'H'.
              wa_final-net_inv_sls = wa_final-net_inv_sls + ( wa_bsis-dmbtr * -1 ).
            ELSEIF ( wa_bsis-hkont EQ '0002997901' OR wa_bsis-hkont EQ '0001780002' )
                  AND wa_bsis-shkzg EQ 'S'.
              wa_final-net_inv_sls = wa_final-net_inv_sls + wa_bsis-dmbtr.
            ENDIF.
          ENDIF.
        ENDIF.
        IF ( wa_bsis-budat GE wa_final-guebg AND wa_bsis-budat LE wa_period-edate ).
*          Calculating the YTD deferred revenue and YTD accrued revenue
          IF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'H'.
            wa_final-bal_accr_rev = wa_final-bal_accr_rev + ( wa_bsis-dmbtr * -1 ).
          ELSEIF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'S'.
            wa_final-bal_accr_rev = wa_final-bal_accr_rev + wa_bsis-dmbtr.
          ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'H'.
            wa_final-bal_rec_not_inv = wa_final-bal_rec_not_inv + ( wa_bsis-dmbtr * -1 ).
          ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'S'.
            wa_final-bal_rec_not_inv = wa_final-bal_rec_not_inv + wa_bsis-dmbtr .
          ENDIF.
        ENDIF.
      ENDLOOP.
*      *Calculating MTD Deferred and accrued revenuw and YTD deferred and Accured revenue
      LOOP AT gt_bsas INTO wa_bsis
                   WHERE  zuonr EQ gv_zuonr AND
*                         ( budat GE wa_period-fdate AND
*                           budat LE wa_period-edate ) AND
                          budat IN  r_fdate AND
                          prctr EQ wa_final-prctr1.
        IF ( wa_bsis-budat GE wa_period-fdate AND wa_bsis-budat LE wa_period-edate ).
*          CalCulating the MTD deferred revenue and MTD accrued revenue
          IF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'H'.
            wa_final-bal_def_rev = wa_final-bal_def_rev + ( wa_bsis-dmbtr * -1 ).
          ELSEIF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'S'.
            wa_final-bal_def_rev = wa_final-bal_def_rev + wa_bsis-dmbtr .
          ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'H'.
            wa_final-bal_accr_rev_new = wa_final-bal_accr_rev_new + ( wa_bsis-dmbtr * -1 ).
          ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'S'.
            wa_final-bal_accr_rev_new = wa_final-bal_accr_rev_new + wa_bsis-dmbtr.
          ENDIF.
*          Calculating the Invoiced Revenue
          IF ( wa_bsis-blart NE 'ZZ' AND wa_bsis-blart NE 'SA' ).
            IF ( wa_bsis-hkont EQ '0002997901' OR wa_bsis-hkont EQ '0001780002' )
                       AND wa_bsis-shkzg EQ 'H'.
              wa_final-net_inv_sls = wa_final-net_inv_sls + ( wa_bsis-dmbtr * -1 ).
            ELSEIF ( wa_bsis-hkont EQ '0002997901' OR wa_bsis-hkont EQ '0001780002' )
                  AND wa_bsis-shkzg EQ 'S'.
              wa_final-net_inv_sls = wa_final-net_inv_sls + wa_bsis-dmbtr.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDLOOP.
      LOOP AT gt_bseg INTO wa_bseg
                      WHERE vbel2 EQ wa_final-vbeln AND
                            posn2 EQ wa_final-posnr.
        CLEAR wa_bsis.
        READ TABLE gt_bsis1 INTO wa_bsis
                            WITH KEY bukrs = wa_bseg-bukrs
                                     belnr = wa_bseg-belnr
                                     gjahr = wa_bseg-gjahr
                                     buzei = wa_bseg-buzei
                                     prctr = wa_final-prctr1
                                    BINARY SEARCH.
        IF sy-subrc EQ 0.
          IF ( wa_bsis-budat GE wa_period-fdate AND wa_bsis-budat LE wa_period-edate ).
*            Calculating the MTD deferred revenue and MTD accrued revenue, Invoiced revenue
            IF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'H'.
              wa_final-bal_def_rev = wa_final-bal_def_rev + ( wa_bsis-dmbtr * -1 ).
              wa_final-net_inv_sls = wa_final-net_inv_sls + ( wa_bsis-dmbtr * -1 ).
            ELSEIF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'S'.
              wa_final-bal_def_rev = wa_final-bal_def_rev + wa_bsis-dmbtr .
              wa_final-net_inv_sls = wa_final-net_inv_sls + wa_bsis-dmbtr.
            ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'H'.
              wa_final-bal_accr_rev_new = wa_final-bal_accr_rev_new + ( wa_bsis-dmbtr * -1 ).
              wa_final-net_inv_sls = wa_final-net_inv_sls + ( wa_bsis-dmbtr * -1 ).
            ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'S'.
              wa_final-bal_accr_rev_new = wa_final-bal_accr_rev_new + wa_bsis-dmbtr.
              wa_final-net_inv_sls = wa_final-net_inv_sls + wa_bsis-dmbtr.
            ENDIF.

          ENDIF.
          IF ( wa_bsis-budat GE wa_final-guebg AND wa_bsis-budat LE wa_period-edate ).
*            calculating the YTD deferred revenue and YTD accrued revenue
            IF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'H'.
              wa_final-bal_accr_rev = wa_final-bal_accr_rev + ( wa_bsis-dmbtr * -1 ).
            ELSEIF wa_bsis-hkont EQ '0002997901' AND wa_bsis-shkzg EQ 'S'.
              wa_final-bal_accr_rev = wa_final-bal_accr_rev + wa_bsis-dmbtr.
            ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'H'.
              wa_final-bal_rec_not_inv = wa_final-bal_rec_not_inv + ( wa_bsis-dmbtr * -1 ).
            ELSEIF wa_bsis-hkont EQ '0001780002' AND wa_bsis-shkzg EQ 'S'.
              wa_final-bal_rec_not_inv = wa_final-bal_rec_not_inv + wa_bsis-dmbtr .
            ENDIF.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.

    wa_final-perio+4(1) = '/'.
    PACK wa_final-vbeln TO wa_final-vbeln.
    CONDENSE wa_final-vbeln NO-GAPS.

*.. Add new fields to internal table
    MODIFY gt_final FROM wa_final
                    TRANSPORTING vbeln
                                 net_inv_sls
                                 unadj_cogs
                                 unadj_gp
                                 %ugp
                                 sttxt
                                 vkbur_text
                                 vkgrp_text
                                 inv
                                 inv_out
                                 tot_val
                                 tot_plcost
                                 tot_accost
                                 bal_rec_not_inv
                                 bal_accr_rev
                                 bal_def_rev
                                 bal_accr_rev_new
                                 perio
                                 tot_plrev.
    CLEAR wa_final.

  ENDLOOP.
ENDFORM.                    " PROCESS_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*°’#      fetching the data
*----------------------------------------------------------------------*
FORM get_data .
* Fill status tables
  REFRESH: gt_stai1,
           gt_stae1,
           gt_copa.

  LOOP AT s_stai1 INTO wa_stai.
    CLEAR wa_stai1.
    MOVE s_stai1-low TO wa_stai1-low.
    APPEND wa_stai1 TO gt_stai1.
  ENDLOOP.

  LOOP AT s_stae1 INTO wa_stae.
    CLEAR wa_stae.
    MOVE s_stae1-low TO wa_stae1-low.
    APPEND wa_stae1 TO gt_stae1.
  ENDLOOP.


  CLEAR: wa_year,
         wa_fdate,
         wa_period.
  REFRESH: gt_period.

  wa_year-sign = 'I'.
  wa_year-option  = 'EQ'.

  wa_fdate-sign = 'I'.
  wa_fdate-option = 'BT'.
  LOOP AT s_perio INTO wa_peri.
    CLEAR: g_fdate,
           g_ldate.


    g_fdate(4) = wa_year-low = wa_peri-low+0(4).
    g_fdate+4(2) = wa_peri-low+5(2).
    g_fdate+6(2) = '01'.

    APPEND wa_year TO r_year.

    wa_date = g_fdate.
    IF wa_date-month < 12.
      wa_date-month = wa_date-month + 1.
    ELSE.
      wa_date-month = 1.
      wa_date-year  = wa_date-year + 1.
    ENDIF.
    wa_date-day   = 1.
    wa_date_tmp = wa_date.
* no special "leap year" algorithm necessary: in SAP NW we trust...
    wa_date_tmp = wa_date_tmp - 1.
    g_ldate = wa_date_tmp.

    wa_fdate-low = g_fdate.
    wa_fdate-high = g_ldate.
    APPEND wa_fdate TO r_fdate.

    wa_period-perio = wa_peri-low.
    wa_period-fdate = g_fdate.
    wa_period-edate = g_ldate.
    APPEND wa_period TO gt_period.
    CLEAR wa_period.
  ENDLOOP.

  SORT gt_period BY perio.

  SELECT langu
         segment
         name
         FROM fagl_segmt
         INTO TABLE gt_seg
         WHERE langu EQ sy-langu
         AND name IN s_plc.

  REFRESH: r_seg.
  CLEAR wa_segment.
  wa_segment-sign = 'I'.
  wa_segment-option  = 'EQ'.

  LOOP AT gt_seg INTO wa_seg.
    wa_segment-low = wa_seg-segment.
    APPEND wa_segment TO r_seg.
  ENDLOOP.


* Number of records in the status-tables
  DESCRIBE TABLE gt_stai1 LINES g_stai1_lines.
  DESCRIBE TABLE gt_stae1 LINES g_stae1_lines.

*Fetch Sales doc data
  IF s_vbeln[] IS NOT INITIAL.
    SELECT vbeln
           vbtyp
           auart
           vkorg
           vtweg
           spart
           vkgrp
           vkbur
           kunnr
           FROM vbak
           INTO TABLE gt_vbak
           WHERE vbeln IN s_vbeln
           AND vbtyp IN (c_c, c_g, c_l, c_h, c_k)
           AND vkorg EQ p_vkorg
           AND vkgrp IN s_vkgrp
           AND vkbur IN s_vkbur
           AND kunnr IN s_kunnr.
  ELSE.

    PERFORM get_numberrange.
    SELECT vbeln
      vbtyp
      auart
      vkorg
      vtweg
      spart
      vkgrp
      vkbur
      kunnr
      FROM vbak
      INTO TABLE gt_vbak
      WHERE vbeln IN r_vbeln
      AND vbtyp IN (c_c, c_g, c_l, c_h, c_k)
      AND vkorg EQ p_vkorg
      AND vkgrp IN s_vkgrp
      AND vkbur IN s_vkbur
      AND kunnr IN s_kunnr.
  ENDIF.
  IF sy-subrc EQ 0.
    SORT gt_vbak BY vbeln.
    SELECT vbeln
           posnr
           matnr
           matkl
           arktx
           werks
           objnr
           kalnr
           FROM vbap
           INTO TABLE gt_vbap1
           FOR ALL ENTRIES IN gt_vbak
           WHERE vbeln EQ gt_vbak-vbeln
           AND  posnr IN s_posnr
           AND  matnr IN s_matnr
           AND matkl IN s_matkl.
  ENDIF.

  LOOP AT gt_vbap1 INTO wa_vbap1.
    CLEAR wa_vbak.
    READ TABLE gt_vbak INTO wa_vbak
                     WITH KEY vbeln = wa_vbap1-vbeln
                     BINARY SEARCH.
    IF sy-subrc EQ 0.
      MOVE-CORRESPONDING wa_vbak TO wa_vbap.
      MOVE-CORRESPONDING wa_vbap1 TO wa_vbap.
      APPEND wa_vbap TO gt_vbap.
      CLEAR wa_vbap.
    ENDIF.
  ENDLOOP.

  IF gt_vbap[] IS INITIAL.
    WRITE: / text-i01.              "No orders selected
    EXIT.
  ENDIF.

  IF gt_vbap[] IS NOT INITIAL.
*Fetch the vbkd
    SELECT vbeln
           posnr
           kdgrp
           bzirk
           prsdt
           fplnr
           FROM vbkd
           INTO TABLE gt_vbkd
           FOR ALL ENTRIES IN gt_vbap
           WHERE vbeln EQ gt_vbap-vbeln.

    SORT gt_vbkd BY vbeln posnr.

    SELECT kunnr
           name1
           FROM kna1
           INTO TABLE gt_kna1
           FOR ALL ENTRIES IN gt_vbap
           WHERE kunnr EQ gt_vbap-kunnr.
    SORT gt_kna1 BY kunnr.

  ENDIF.

  CLEAR: g_tabix,
         wa_zuonr.

  wa_zuo-sign = 'I'.
  wa_zuo-option = 'EQ'.

  REFRESH: gt_zuonr.
  LOOP AT gt_vbap INTO wa_vbap.

    g_tabix = sy-tabix.

*    getting customer name
    CLEAR wa_kna1.
    READ TABLE gt_kna1 INTO wa_kna1
                          WITH KEY kunnr = wa_vbap-kunnr
                          BINARY SEARCH.
    IF sy-subrc EQ 0.
      wa_vbap-name1 = wa_kna1-name1.
    ENDIF.
* check on vbkd (first with item , if not found without item)
    CLEAR wa_vbkd.
    READ TABLE gt_vbkd INTO wa_vbkd
                   WITH KEY vbeln = wa_vbap-vbeln
                            posnr = wa_vbap-posnr
                            BINARY SEARCH. "
    IF sy-subrc NE 0. "
      READ TABLE gt_vbkd INTO wa_vbkd
                     WITH KEY vbeln = wa_vbap-vbeln.
    ENDIF.
    IF sy-subrc EQ 0.
      wa_vbap-kdgrp = wa_vbkd-kdgrp.
      wa_vbap-bzirk = wa_vbkd-bzirk.
      wa_vbap-prsdt = wa_vbkd-prsdt.
      wa_vbap-fplnr = wa_vbkd-fplnr.
    ENDIF.
*
*    IF NOT wa_vbap-bzirk IN s_bzirk.
*      DELETE gt_vbap  INDEX g_tabix.
*      CONTINUE.
*    ENDIF.
*.. check status inclusive / exlusive
    IF NOT ( g_stai1_lines IS INITIAL
        AND g_stae1_lines IS INITIAL ) .
      PERFORM check_statusses USING wa_vbap-objnr.
      IF NOT g_stai1_lines IS INITIAL AND g_incl = ' '.
        DELETE gt_vbap INDEX g_tabix.
        CONTINUE.
      ELSEIF NOT g_stae1_lines IS INITIAL AND g_excl = 'X'.
        DELETE gt_vbap INDEX g_tabix.
        CONTINUE.
      ENDIF.
    ENDIF.
    CONCATENATE wa_vbap-vbeln wa_vbap-posnr INTO wa_zuonr-zuonr.
    APPEND wa_zuonr TO gt_zuonr.

    wa_zuo-low =  wa_zuonr-zuonr.
    APPEND wa_zuo TO  r_zuonr.

    MODIFY gt_vbap FROM wa_vbap.

  ENDLOOP.

* Select CO-PA info
  SORT gt_vbap BY vbeln posnr.
  REFRESH: gt_copa.
  IF gt_vbap[] IS NOT INITIAL.

    PERFORM get_copadata.

    SELECT vbeln
           vposn
           vbegdat
           venddat
           FROM veda
           INTO TABLE gt_veda
           FOR ALL ENTRIES IN gt_vbap
           WHERE vbeln EQ gt_vbap-vbeln.

    SORT gt_veda BY vbeln vposn.
  ENDIF.
ENDFORM.                    " GET_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_NUMBERRANGE
*&---------------------------------------------------------------------*
*       Fetch the Number range and fill the sales order no range
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_numberrange .

  REFRESH: r_vbeln.
  SELECT *
     FROM nriv
    INTO TABLE gt_nriv
    WHERE object EQ 'RV_BELEG'.

  DELETE gt_nriv WHERE
        ( nrrangenr NE '09' AND nrrangenr NE '10' ).

  wa_vbeln-sign = 'I'.
  wa_vbeln-option = 'BT'.
  LOOP AT gt_nriv INTO wa_nriv.
    wa_vbeln-low = wa_nriv-fromnumber.
    wa_vbeln-high = wa_nriv-tonumber.
    APPEND wa_vbeln TO r_vbeln.

  ENDLOOP.
ENDFORM.                    " GET_NUMBERRANGE
*&---------------------------------------------------------------------*
*&      Form  GET_BSIS
*&---------------------------------------------------------------------*
*       Get the BSIS table
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_bsis .

  REFRESH gt_bsas.
  SORT gt_zuonr BY zuonr.
  DELETE gt_zuonr WHERE zuonr IS INITIAL.
  DELETE ADJACENT DUPLICATES FROM gt_zuonr
       COMPARING ALL FIELDS.

  IF s_vbeln IS INITIAL.
    SELECT bukrs
       hkont
       augdt
       augbl
       zuonr
       gjahr
       belnr
       buzei
       budat
       blart
       shkzg
       dmbtr
       prctr
       segment
       FROM bsis
       INTO  TABLE gt_bsis
      FOR ALL ENTRIES IN gt_zuonr
       WHERE bukrs EQ gv_bukrs2
       AND hkont IN r_hkont
       AND zuonr EQ gt_zuonr-zuonr
*     AND gjahr IN r_year
       AND budat IN r_cdate
       AND segment IN r_seg.

    SELECT bukrs
      hkont
      augdt
      augbl
      zuonr
      gjahr
      belnr
      buzei
      budat
      blart
      shkzg
      dmbtr
      prctr
      segment
      FROM bsas
      INTO  TABLE gt_bsas
     FOR ALL ENTRIES IN gt_zuonr
      WHERE bukrs EQ gv_bukrs2
      AND hkont IN r_hkont
      AND zuonr EQ gt_zuonr-zuonr
      AND budat IN r_fdate
      AND segment IN r_seg.
  ELSE.
    SELECT bukrs
   hkont
   augdt
   augbl
   zuonr
   gjahr
   belnr
   buzei
   budat
   blart
   shkzg
   dmbtr
   prctr
   segment
   FROM bsis
   INTO  TABLE gt_bsis
   WHERE bukrs EQ gv_bukrs2
   AND hkont IN r_hkont
   AND zuonr IN r_zuonr
*     AND gjahr IN r_year
   AND budat IN r_cdate
   AND segment IN r_seg.

    SELECT bukrs
      hkont
      augdt
      augbl
      zuonr
      gjahr
      belnr
      buzei
      budat
      blart
      shkzg
      dmbtr
      prctr
      segment
      FROM bsas
      INTO  TABLE gt_bsas
      WHERE bukrs EQ gv_bukrs2
      AND hkont IN r_hkont
      AND zuonr IN r_zuonr
      AND budat IN r_cdate
      AND segment IN r_seg.
  ENDIF.

  SELECT bukrs
   hkont
   augdt
   augbl
   zuonr
   gjahr
   belnr
   buzei
   budat
   blart
   shkzg
   dmbtr
   prctr
   segment
   FROM bsis
   INTO TABLE gt_bsis1
   WHERE bukrs EQ gv_bukrs2
   AND hkont IN r_hkont
   AND budat IN r_cdate
   AND blart IN ('RV', 'Z1', 'ZX' )
   AND segment IN r_seg.

  REFRESH: gt_bsis2.
  gt_bsis2[] = gt_bsis1[].
  SORT gt_bsis2 BY   bukrs belnr gjahr buzei.
  DELETE ADJACENT DUPLICATES FROM gt_bsis2
                    COMPARING bukrs belnr gjahr buzei.
  IF gt_bsis2[] IS NOT INITIAL.
    SELECT bukrs
           belnr
           gjahr
           buzei
           vbel2
           posn2
           FROM bseg
           INTO TABLE gt_bseg
           FOR ALL ENTRIES IN gt_bsis2
           WHERE bukrs EQ gt_bsis2-bukrs
           AND   belnr EQ gt_bsis2-belnr
           AND   gjahr EQ gt_bsis2-gjahr
           AND   buzei EQ gt_bsis2-buzei
           AND   vbel2 IN s_vbeln
           AND   posn2 IN s_posnr.
  ENDIF.

  SORT gt_bsis BY zuonr.
  SORT gt_bseg BY vbel2 posn2.
  LOOP AT gt_zuonr INTO wa_zuonr.

    CLEAR wa_bsis.
    READ TABLE gt_bsis INTO wa_bsis
                  WITH KEY zuonr = wa_zuonr-zuonr
                  BINARY SEARCH.
    IF sy-subrc NE 0.
      CLEAR wa_bseg.
      READ TABLE gt_bseg INTO wa_bseg
                 WITH KEY vbel2 = wa_zuonr-zuonr+0(10)
                          posn2 = wa_zuonr-zuonr+10(6)
                 BINARY SEARCH.
    ENDIF.
    IF sy-subrc EQ 0.
      DELETE gt_bsas WHERE zuonr EQ wa_zuonr-zuonr.
    ENDIF.
  ENDLOOP.
ENDFORM.                    " GET_BSIS
*&---------------------------------------------------------------------*
*&      Form  GET_ACTUAL_COST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_actual_cost .
  TYPES:BEGIN OF ty_coep,
        kokrs  TYPE kokrs,
        belnr  TYPE belnr_d,
        buzei  TYPE buzei,
        objnr  TYPE j_objnr,
        wtgbtr TYPE wtgxxx,
        wogbtr TYPE wtgxxx,
        wkgbtr TYPE wtgxxx,
        twaer  TYPE twaer,
        owaer  TYPE owaer,
        beltp  TYPE beltp,
        END OF ty_coep.
  TYPES:BEGIN OF ty_beknz,
       sign   TYPE char1,
       option TYPE char2,
       low    TYPE beknz,
       high   TYPE beknz,
       END OF ty_beknz.

  DATA:lt_coep  TYPE STANDARD TABLE OF ty_coep,
       lt_beknz TYPE STANDARD TABLE OF ty_beknz,
       ls_coep  TYPE ty_coep,
       ls_beknz TYPE ty_beknz.
  DATA:lv_act_lc TYPE wogxxx.

  CONSTANTS:lc_lednr TYPE lednr VALUE '00',
            lc_wrttp TYPE wrttp VALUE '04',
            lc_versn TYPE versn VALUE '000',
            lc_2     TYPE char1 VALUE '2',
            lc_h     TYPE char1 VALUE 'H',
            lc_s     TYPE char1 VALUE 'S',
            lc_eq    TYPE char2 VALUE 'EQ',
            lc_i     TYPE char1 VALUE 'I'.
*Assign Debit/Credit indicator
  ls_beknz-sign   = lc_i.
  ls_beknz-option = lc_eq.
  ls_beknz-low    = lc_h.
  APPEND ls_beknz TO lt_beknz.
  CLEAR ls_beknz.

  ls_beknz-sign   = lc_i.
  ls_beknz-option = lc_eq.
  ls_beknz-low    = lc_s.
  APPEND ls_beknz TO lt_beknz.
  CLEAR ls_beknz.

  IF NOT gt_vbap[] IS INITIAL.
    SELECT kokrs
           belnr
           buzei
           objnr
           wtgbtr
           wogbtr
           wkgbtr
           twaer
           owaer
           beltp
           INTO TABLE lt_coep
           FROM coep
           FOR ALL ENTRIES IN gt_vbap
           WHERE lednr =  lc_lednr
             AND objnr =  gt_vbap-objnr
             AND wrttp =  lc_wrttp
             AND versn =  lc_versn
             AND beknz IN lt_beknz.
  ENDIF.

  SORT lt_coep BY objnr belnr.
  DELETE ADJACENT DUPLICATES FROM lt_coep COMPARING belnr.
  LOOP AT lt_coep INTO ls_coep.
    IF ls_coep-beltp EQ lc_2.
      CLEAR:ls_coep-belnr,ls_coep-buzei.
      COLLECT ls_coep INTO gt_coep.
      CLEAR ls_coep.
    ENDIF.
  ENDLOOP.
ENDFORM.                    " GET_ACTUAL_COST

*Text symbol text£º
*001:Selection screen input
*002:PSTG Period
*003:Total Actual Costs
*004:Unbilled Recognized Revenue
*005:YTD Deferred Revenue
*006:MTD Deferred Revenue
*007:MTD Accrued revenue
*008:Sales Doc no
*009:Product
*010:Total Actual Revenues
*E03:No authorization for sales organisation: &1
*E04:Fill in only 1 period !
*I01:No contracts selected !
*I15:Sales office(Text)
*I19:Customer Name
*I28:Contract item value total
*I31:NIS
*I33:Invoiced Revenue
*I35:Parts Actual
*I36:Labour Actual
*I37:Mileage Actual
*I38:Ad Hoc Expenses Actual
*I39:Subcontracting Actual
*I41:Fix price accruals Actual
*I42:Unadjusted COGS Actual
*I43:Unadjusted Gross Profit Actual
*I45:Tot.Revenues Planned
*I46:Tot.Costs Planned
*I49:Profit Center
*I50:Segment

*I55:Sales group(Text)
*Selection text£º
*P_VKORG:D       .
*S_EQUNR:D       .
*S_GAC:D       .
*S_KUNNR:        Customer
*S_MATKL:D       .
*S_MATNR:        Product
*S_PERIO:D       .
*S_PGC:D       .
*S_PLC:D       .
*S_POSNR:D       .
*S_PRCTR:D       .
*S_STAE1:        SDI Status excluded
*S_STAI1:        SDI Status included
*S_VBELN:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
