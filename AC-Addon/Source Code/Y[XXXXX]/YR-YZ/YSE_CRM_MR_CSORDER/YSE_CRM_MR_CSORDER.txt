*----------------------------------------------------------------------*
* PROGRAM ID    : YSE_CRM_MR_CSORDER                                   *
* PROGRAM TITLE : MR CS Order Mass upload  tool requirement            *
* AUTHOR        : Anda Wu                                              *
* DATE          : 07/07/2014                                           *
* DEVELOPMENT ID:                                                      *
*                                                                      *
* CHANGE REQUEST NUMBER:                                               *
*                                                                      *
* Program Description: MR CS Order Mass upload  tool requirement       *
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
*  DATE    | NAME     |TRANSPORT  | CR# and short Description          *
*----------------------------------------------------------------------*
*07/07/2014|Anda Wu   |CD1K982226 |CR3294: Initial version             *
*----------------------------------------------------------------------*
REPORT  yse_crm_mr_csorder NO STANDARD PAGE HEADING LINE-SIZE 255.
************************************************************************
* TYPE SPOOLS                                                          *
************************************************************************
TYPE-POOLS slis.

************************************************************************
* TYPES                                                                *
************************************************************************
TYPES:
  BEGIN OF ty_input_file,
    qmart         TYPE qmel-qmart,    "Notification Type
    qmtxt         TYPE qmel-qmtxt,    "Noti. description
    equnr         TYPE equz-equnr,    "Equipment
    bstkd         TYPE vbkd-bstkd,    "P0 Number
    matnr         TYPE mara-matnr,    "Material
    bemot         TYPE vbkd-bemot,    "Accounting indicator
    ktext         TYPE caufvd-ktext,  "SEO description
    dauno         TYPE afvgd-dauno,   "Work Plan hour ZAM001
    dauno2        TYPE afvgd-dauno,   "Work Plan expense ZAM063
    dauno3        TYPE afvgd-dauno,   "Work Plan expense ZAM051
  END OF ty_input_file,

  BEGIN OF ty_equz_iloa,
    equnr         TYPE equz-equnr,    "equip No.
    datbi         TYPE equz-datbi,
    eqlfn         TYPE equz-eqlfn,
    iloan         TYPE equz-iloan,
    vkorg         TYPE iloa-vkorg,    "Sales Organization
    vtweg         TYPE iloa-vtweg,    "Distribution Channel
    spart         TYPE iloa-spart,    "Division
  END OF ty_equz_iloa,

  BEGIN OF ty_order_flow,
    bstkd         TYPE vbkd-bstkd,    "P0 Number
    qmnum         TYPE qmel-qmnum,    "Notification No
    aufnr         TYPE qmel-aufnr,    "Sevice Order No
    vbeln         TYPE qmel-vbeln,    "Sales Order Number
    iw32_err      TYPE string,
  END OF ty_order_flow,

  BEGIN OF ty_update_log,
    bstkd         TYPE vbkd-bstkd,    "P0 Number
    mess          TYPE string,
  END OF ty_update_log,

  BEGIN OF ty_vbkd,
    vbeln         TYPE vbkd-vbeln,
    posnr         TYPE vbkd-posnr,
    bstkd         TYPE vbkd-bstkd,    "P0 Number
  END OF ty_vbkd,

  BEGIN OF ty_alv_output,
    bstkd         TYPE char35,        "P0 Number
    aufnr         TYPE char12,        "Sevice Order No
    mess          TYPE string,        "Process message
  END OF ty_alv_output.

************************************************************************
* WORKAREAS                                                            *
************************************************************************
DATA:
  gs_update       TYPE ty_input_file.

************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:
  gt_lfile        TYPE yse_t_lfile,                 "Local file name
  gt_equz_iloa    TYPE STANDARD TABLE OF ty_equz_iloa,
  gt_bdcdata      TYPE STANDARD TABLE OF bdcdata,
  gt_fieldcat     TYPE slis_t_fieldcat_alv,
  gt_vbkd         TYPE STANDARD TABLE OF ty_vbkd,
  gt_alv_output   TYPE STANDARD TABLE OF ty_alv_output,
  gt_order_flow   TYPE STANDARD TABLE OF ty_order_flow,
  gt_update       TYPE STANDARD TABLE OF ty_input_file,"Update filedata
  gt_overflow     TYPE STANDARD TABLE OF ty_update_log,
  gt_update_log   TYPE STANDARD TABLE OF ty_update_log."update process log

************************************************************************
* VARIABLES                                                            *
************************************************************************
DATA:
"gv_obtab        TYPE tcla-obtab,    "Name of database table for object
  gs_orderflow    TYPE ty_order_flow,
  gs_layout       TYPE slis_layout_alv,
  gv_po_check     TYPE char1,                 "Check duplicate PO
  gv_tot_lines    TYPE i,                           "Process lines
  gv_suc_lines    TYPE i,                           "Success Lines
  gv_fai_lines    TYPE i.                           "Failed lines

************************************************************************
* CONSTANTS                                                            *
************************************************************************
CONSTANTS:
  gc_tab          TYPE c VALUE cl_abap_char_utilities=>horizontal_tab,
  gc_datbi_9999   TYPE sy-datum VALUE '99991231',
  gc_qmart_x1     TYPE qmel-qmart VALUE 'X1',
  gc_qmart_xb     TYPE qmel-qmart VALUE 'XB',
  gc_type_e       TYPE c VALUE 'E',
  gc_type_i       TYPE c VALUE 'I',
  gc_hifi         TYPE c VALUE '-',
  gc_colon        TYPE c VALUE ':',
  gc_x            TYPE c VALUE 'X'.

************************************************************************
* SELECTION-SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-t01.
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-t02.
PARAMETERS: p_vkorg   TYPE vbak-vkorg OBLIGATORY DEFAULT 'CN02',
            p_vtweg   TYPE vbak-vtweg OBLIGATORY DEFAULT '11',
            p_spart   TYPE vbak-spart OBLIGATORY DEFAULT '01'.
SELECTION-SCREEN END OF BLOCK b2.
PARAMETERS:
          p_file(1024) TYPE c LOWER CASE OBLIGATORY.  "Local File Path

SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: cb_hflg    AS CHECKBOX                    "Header text flag
              DEFAULT 'X' MODIF ID m1.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b1.

*&---------------------------------------------------------------------*
*& INITIALIZATION                                                      *
*&---------------------------------------------------------------------*
INITIALIZATION.
* Do initialization
  PERFORM frm_do_init.

*&---------------------------------------------------------------------*
*& AT SELECTION-SCREEN OUTPUT                                          *
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN OUTPUT.
* Set selection screen
  PERFORM set_screen.

*&---------------------------------------------------------------------*
*& AT SELECTION-SCREEN                                                 *
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN.
* Check if the file path and name exist
  PERFORM check_filename.

*&---------------------------------------------------------------------*
*& AT SELECTION-SCREEN  ON VALUE-REQUEST                               *
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file.
* Get local file path
  PERFORM select_file.

*&---------------------------------------------------------------------*
*& START-OF-SELECTION                                                  *
*&---------------------------------------------------------------------*
START-OF-SELECTION.
* Read local file into a internal table
  PERFORM read_file.
* Write entry to datebase table
  PERFORM write_db.
* ALV display
  PERFORM show_alv.

*&---------------------------------------------------------------------*
*& END-OF-SELECTION                                                    *
*&---------------------------------------------------------------------*
END-OF-SELECTION.
*  IF gv_tot_lines > 0.
**   WRITE process result message
*    PERFORM write_log.
*  ENDIF.

*&---------------------------------------------------------------------*
*&      Form  select_file
*&---------------------------------------------------------------------*
*       Get local file path
*----------------------------------------------------------------------*
FORM select_file .

  DATA:
    lv_title  TYPE string,     "Referrence title
    lt_file   TYPE filetable,  "Internal table of dialog filenames
    ls_file   TYPE file_table, "Working area for IT_FILE,
    lv_rc     TYPE i.          "Return Code

  lv_title = text-001.
  CLEAR: lt_file[],
         ls_file.

* Open local file dialog
  CALL METHOD cl_gui_frontend_services=>file_open_dialog
    EXPORTING
      window_title            = lv_title
      with_encoding           = 'X'
    CHANGING
      file_table              = lt_file
*      FILE_ENCODING           = lv_ENCODING
      rc                      = lv_rc
    EXCEPTIONS
      file_open_dialog_failed = 1
      cntl_error              = 2
      error_no_gui            = 3
      not_supported_by_gui    = 4
      OTHERS                  = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  IF lv_rc = 1.
    READ TABLE lt_file INDEX 1 INTO ls_file.
    IF sy-subrc EQ 0.
      p_file = ls_file-filename.
    ENDIF.
  ENDIF.

ENDFORM.                    " select_file
*&---------------------------------------------------------------------*
*&      Form  READ_FILE
*&---------------------------------------------------------------------*
*       Read local file into a internal table
*----------------------------------------------------------------------*
FORM read_file .

  DATA: lv_filename TYPE string.

* Read file entires
  lv_filename = p_file.

  PERFORM get_from_pres IN PROGRAM yam_common_routines
                                    TABLES  gt_lfile
                                    USING   lv_filename
                                            ycl_se_utility=>c_ft_asc
                                            ' '.

* Delete the blank lines
  DELETE gt_lfile
    WHERE text IS INITIAL.

* Gain update characteristic names
  IF cb_hflg IS NOT INITIAL.
    DELETE gt_lfile INDEX 1.
  ENDIF.

ENDFORM.                    " READ_FILE
*&---------------------------------------------------------------------*
*&      Form  WRITE_DB
*&---------------------------------------------------------------------*
*       Write entry to datebase table
*----------------------------------------------------------------------*
FORM write_db .

  DATA: lv_mess_str   TYPE string,
        ls_update_log TYPE ty_update_log,
        ls_qmel       TYPE qmel,
        ls_vbkd       TYPE ty_vbkd,
        ls_equz_iloa  TYPE ty_equz_iloa,
"        lv_objectkey  TYPE bapi1003_key-object,
        ls_option     TYPE ctu_params ,
        ls_bdcmsg     TYPE bdcmsgcoll.

  DATA: lt_bdcmsgcoll TYPE STANDARD TABLE OF bdcmsgcoll.
  FIELD-SYMBOLS: <lfs_update> TYPE ty_input_file.

* Get total process entires
  DESCRIBE TABLE gt_lfile LINES gv_tot_lines.
  PERFORM convert_to_struc.

* Check if update entries is empty
  IF gt_update IS INITIAL.
    MESSAGE s000(yse_sales_log) DISPLAY LIKE gc_type_e
      WITH text-002.
    LEAVE LIST-PROCESSING.
  ENDIF.

** Make conversion of file equi-equnr
  LOOP AT gt_update ASSIGNING <lfs_update>.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = <lfs_update>-equnr
      IMPORTING
        output = <lfs_update>-equnr.
    CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
      EXPORTING
        input        = <lfs_update>-matnr
      IMPORTING
        output       = <lfs_update>-matnr
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ENDLOOP.

* Get Sales and Distribution info
  PERFORM frm_get_sd.

  ls_option-dismode   = 'N'.
  ls_option-updmode   = 'S'.
  ls_option-racommit  = 'X'.

  LOOP AT gt_update INTO gs_update.
    CLEAR:  gs_orderflow.
    READ TABLE gt_equz_iloa INTO ls_equz_iloa
        WITH KEY equnr = gs_update-equnr.
    IF sy-subrc <> 0.
      MESSAGE e000(yse_sales_log)
        WITH 'Equipment not exist:'(014)
             gs_update-equnr
        INTO lv_mess_str.
      CLEAR: ls_update_log.
      ls_update_log-bstkd = gs_update-bstkd.
      ls_update_log-mess = lv_mess_str.
      APPEND ls_update_log TO gt_update_log.
      CLEAR: gs_update.
      CONTINUE.
    ELSE.
      IF  NOT (   ls_equz_iloa-vkorg  = p_vkorg
              AND ls_equz_iloa-vtweg  = p_vtweg
              AND ls_equz_iloa-spart  = p_spart ).
        CLEAR lv_mess_str.
        MESSAGE e000(yse_sales_log)
          WITH 'Equipment not fulfill the selection screen:'(015)
               gs_update-equnr
           INTO lv_mess_str.
        CLEAR: ls_update_log.
        ls_update_log-bstkd = gs_update-bstkd.
        ls_update_log-mess = lv_mess_str.
        APPEND ls_update_log TO gt_update_log.
        CLEAR: gs_update.
        CONTINUE.
      ENDIF.
    ENDIF.
    IF gv_po_check  IS NOT INITIAL.
      READ TABLE gt_vbkd TRANSPORTING NO FIELDS
        WITH KEY bstkd = gs_update-bstkd.
      IF sy-subrc = 0.
        MESSAGE e000(yse_sales_log)
          WITH 'The PO number already exist!'(064)
               gs_update-equnr
          INTO lv_mess_str.
        CLEAR: ls_update_log.
        ls_update_log-bstkd = gs_update-bstkd.
        ls_update_log-mess = lv_mess_str.
        APPEND ls_update_log TO gt_update_log.
        CLEAR: gs_update.
        CONTINUE.
      ENDIF.
    ENDIF.

    IF gs_update-qmart = gc_qmart_x1.
      PERFORM frm_bdc_fill_x1.
    ELSE.
      PERFORM frm_bdc_fill_xb.
    ENDIF.

    CALL TRANSACTION 'IW51'
      USING gt_bdcdata
      OPTIONS FROM ls_option
      MESSAGES INTO lt_bdcmsgcoll.

    READ TABLE lt_bdcmsgcoll INTO ls_bdcmsg
        WITH KEY msgtyp = gc_type_e.
    IF sy-subrc = 0.
      CLEAR: lv_mess_str.
      MESSAGE ID ls_bdcmsg-msgid TYPE ls_bdcmsg-msgtyp
        NUMBER ls_bdcmsg-msgnr
        WITH ls_bdcmsg-msgv1 ls_bdcmsg-msgv2
             ls_bdcmsg-msgv3 ls_bdcmsg-msgv4
        INTO lv_mess_str.
      CLEAR: ls_update_log.
      ls_update_log-bstkd = gs_update-bstkd.
      ls_update_log-mess = lv_mess_str.
      APPEND ls_update_log TO gt_update_log.
      REFRESH: gt_bdcdata,lt_bdcmsgcoll.
      CLEAR: gs_update.
      CONTINUE.
    ELSE.
      READ TABLE lt_bdcmsgcoll INTO ls_bdcmsg
        WITH KEY msgid = 'IM'
                 msgnr = '525'.
      IF sy-subrc = 0.
        gs_orderflow-qmnum  = ls_bdcmsg-msgv1.
        gs_orderflow-bstkd = gs_update-bstkd.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
          EXPORTING
            input  = gs_orderflow-qmnum
          IMPORTING
            output = gs_orderflow-qmnum.
        SELECT SINGLE *
          FROM qmel
          INTO ls_qmel
          WHERE qmnum = gs_orderflow-qmnum.
        IF sy-subrc = 0.
          gs_orderflow-vbeln  = ls_qmel-vbeln.
          gs_orderflow-aufnr  = ls_qmel-aufnr.
          IF gs_orderflow-aufnr IS INITIAL.
            lv_mess_str = 'Service Order is not generated!'(037).
            CLEAR: ls_update_log.
            ls_update_log-bstkd = gs_update-bstkd.
            ls_update_log-mess = lv_mess_str.
            APPEND ls_update_log TO gt_update_log.
            REFRESH: gt_bdcdata,lt_bdcmsgcoll.
            CLEAR: gs_update.
            CONTINUE.
          ENDIF.
          PERFORM frm_change_seo.
          APPEND  gs_orderflow TO gt_order_flow.
          gv_suc_lines        = gv_suc_lines + 1.
        ENDIF.
      ELSE.
        READ TABLE lt_bdcmsgcoll INTO ls_bdcmsg
          WITH KEY msgtyp = gc_type_i.
        IF sy-subrc = 0.
          CLEAR: lv_mess_str.
          MESSAGE ID ls_bdcmsg-msgid TYPE ls_bdcmsg-msgtyp
            NUMBER ls_bdcmsg-msgnr
            WITH ls_bdcmsg-msgv1 ls_bdcmsg-msgv2
                 ls_bdcmsg-msgv3 ls_bdcmsg-msgv4
            INTO lv_mess_str.
          CLEAR: ls_update_log.
          ls_update_log-bstkd = gs_update-bstkd.
          ls_update_log-mess = lv_mess_str.
          APPEND ls_update_log TO gt_update_log.
          REFRESH: gt_bdcdata,lt_bdcmsgcoll.
          CLEAR: gs_update.
          CONTINUE.
        ENDIF.
      ENDIF.
    ENDIF.

    REFRESH: gt_bdcdata,lt_bdcmsgcoll.
    CLEAR: gs_update.
  ENDLOOP.

ENDFORM.                    " WRITE_DB

*&---------------------------------------------------------------------*
*&      Form  WRITE_LOG
*&---------------------------------------------------------------------*
*       WRITE process result message
*----------------------------------------------------------------------*
FORM write_log .

  DATA: lv_mess_str     TYPE string,
        lv_bstkd        TYPE string,
        ls_update_log   TYPE ty_update_log,
        ls_order_flow   TYPE ty_order_flow,
        lv_log_version  TYPE c.
  gv_fai_lines = gv_tot_lines - gv_suc_lines.
  lv_log_version = 'X'.
  IF lv_log_version IS NOT INITIAL.
    WRITE: 'Total Process Entries:'(005) , AT 30(6) gv_tot_lines,
            / 'Successful Process Entries:'(006), AT 30(6) gv_suc_lines,
            / 'Failed Process Entries:'(007), AT 30(6) gv_fai_lines.
    ULINE.

    IF gv_tot_lines = gv_suc_lines.
      MESSAGE s000(yse_sales_log)
        WITH 'Successfully update all equipment'(008).
    ENDIF.
    READ TABLE gt_order_flow INTO ls_order_flow
      TRANSPORTING NO FIELDS
      WITH KEY iw32_err = SPACE.
    IF sy-subrc = 0.
      WRITE: / ,'Successfully processed entries:'(009).
      LOOP AT gt_order_flow INTO ls_order_flow
          WHERE iw32_err IS INITIAL.
        CLEAR: lv_bstkd,lv_mess_str.
        lv_bstkd = ls_order_flow-bstkd.
        CONDENSE: lv_bstkd.
        CONCATENATE 'Notification-'(031)
                    ls_order_flow-qmnum
                    '|Service-'(032)
                    ls_order_flow-aufnr
                    '|SO-'(033)
                     ls_order_flow-vbeln
              INTO lv_mess_str.

        WRITE: /, lv_bstkd, gc_colon , lv_mess_str.
        IF ls_order_flow-iw32_err IS NOT INITIAL.
          WRITE: 'IW32 update error:'(055),ls_order_flow-iw32_err.
        ENDIF.
      ENDLOOP.
      ULINE.
    ENDIF.
    IF gt_update_log IS NOT INITIAL.
      WRITE: / 'Failed processed entries:'(034).
      LOOP AT gt_update_log INTO ls_update_log.
        WRITE: / ls_update_log-bstkd, gc_colon,ls_update_log-mess.
      ENDLOOP.
      ULINE.
    ENDIF.
  ELSE.
    LOOP AT gt_order_flow INTO ls_order_flow
      WHERE iw32_err IS INITIAL.
      CONDENSE ls_order_flow-bstkd.
      WRITE: / ls_order_flow-bstkd,"gc_tab,
               ls_order_flow-aufnr,"gc_tab,
               'Successful'(061).
    ENDLOOP.
    LOOP AT gt_order_flow INTO ls_order_flow
      WHERE iw32_err IS NOT INITIAL.
      CONDENSE ls_order_flow-bstkd.
      WRITE: / ls_order_flow-bstkd,"gc_tab,
               ls_order_flow-aufnr,"gc_tab,
            ls_order_flow-iw32_err.
    ENDLOOP.
    LOOP AT gt_update_log INTO ls_update_log.
      WRITE: / ls_update_log-bstkd, space ,"gc_tab,
               ls_update_log-mess.
    ENDLOOP.
  ENDIF.


ENDFORM.                    " WRITE_LOG
*&---------------------------------------------------------------------*
*&      Form  CONVERT_TO_STRUC
*&---------------------------------------------------------------------*
*       Convert internal table to structure ty_input_file
*----------------------------------------------------------------------*
FORM convert_to_struc .

  DATA:
    ls_lfile TYPE yse_s_lfile,
    ls_update_log   TYPE ty_update_log,
    lt_field TYPE TABLE OF string,
    lv_field TYPE string,
    lv_line  TYPE string,
    lv_overflow TYPE c,
    lflg_suc TYPE c,
    lv_mess_str  TYPE string.
  FIELD-SYMBOLS:
    <fs_tab> TYPE STANDARD TABLE,
    <fs_wa> TYPE ANY,
    <fs_field> TYPE ANY.
  DATA: lo_wa TYPE REF TO data,
        lo_itab TYPE REF TO data.
  CREATE DATA:
    lo_wa TYPE ty_input_file,
    lo_itab TYPE TABLE OF ty_input_file INITIAL SIZE 1.

  ASSIGN lo_wa->* TO <fs_wa>.
  ASSIGN lo_itab->* TO <fs_tab>.
  ASSIGN gt_update TO <fs_tab>.

  LOOP AT gt_lfile INTO ls_lfile.
    CLEAR: lt_field,
           lflg_suc,
           ls_update_log,
           lv_overflow.
    lv_line = ls_lfile-text.
    SPLIT lv_line AT gc_tab INTO TABLE lt_field.
    lv_mess_str = lv_line.
    REPLACE ALL OCCURRENCES OF  gc_tab
      IN lv_mess_str
      WITH gc_hifi.
    LOOP AT lt_field INTO lv_field.
*      CONDENSE lv_field.
      SHIFT lv_field LEFT DELETING LEADING '0'.
      ASSIGN COMPONENT sy-tabix OF STRUCTURE <fs_wa> TO <fs_field>.
      TRY .
          <fs_field> = lv_field.
        CATCH cx_sy_conversion_no_number.
          lflg_suc = gc_type_e.
          CONCATENATE
                text-012
                lv_mess_str+4
            INTO lv_mess_str.
          CLEAR ls_update_log.
          ls_update_log-mess = lv_mess_str.
          APPEND ls_update_log TO gt_update_log.
          EXIT.
        CATCH cx_sy_conversion_overflow.
          lv_mess_str = text-059.
          REPLACE FIRST OCCURRENCE OF '&' IN lv_mess_str WITH lv_field.
          CLEAR ls_update_log.
          ls_update_log-mess = lv_mess_str.
          <fs_field> = 0.
          lv_overflow = 'X'.
      ENDTRY.
    ENDLOOP.
    IF lflg_suc IS NOT INITIAL.
      CONTINUE.
    ENDIF.
    IF lv_overflow IS NOT INITIAL.
      MOVE-CORRESPONDING <fs_wa> TO ls_update_log.
      APPEND ls_update_log TO gt_overflow.
    ENDIF.
    APPEND <fs_wa> TO <fs_tab>.
    CLEAR  <fs_wa>.
  ENDLOOP.

ENDFORM.                    " CONVERT_TO_STRUC

*&---------------------------------------------------------------------*
*&      Form  CHECK_FILENAME
*&---------------------------------------------------------------------*
*       Check if the file path and name exist
*----------------------------------------------------------------------*
FORM check_filename .

  DATA:
    lv_exist TYPE c.
  CALL FUNCTION 'TMP_GUI_GET_FILE_EXIST'
    EXPORTING
      fname          = p_file
    IMPORTING
      exist          = lv_exist
    EXCEPTIONS
      fileinfo_error = 1
      OTHERS         = 2.
  IF sy-subrc <> 0 OR lv_exist IS INITIAL.
    MESSAGE e000(yse_sales_log)
      WITH 'Please enter an invaild filename'(010).
  ENDIF.

ENDFORM.                    " CHECK_FILENAME

*&---------------------------------------------------------------------*
*&      Form  FRM_DO_INIT
*&---------------------------------------------------------------------*
*       Do initialization
*----------------------------------------------------------------------*
FORM frm_do_init .

  CLEAR: gs_update.

  CLEAR:
    gv_tot_lines    ,                           "Process lines
    gv_suc_lines    ,                           "Success Lines
    gv_fai_lines    .                           "Failed lines

  REFRESH:
    gt_lfile        ,                           "Local file name
    gt_update       ,                           "Update file data
    gt_update_log   .                           "update process log

ENDFORM.                    " FRM_DO_INIT
*&---------------------------------------------------------------------*
*&      Form  SET_SCREEN
*&---------------------------------------------------------------------*
*       Set selection screen
*----------------------------------------------------------------------*
FORM set_screen .

* Set editable for parameter [p_class],[p_charno],[p_hflg]
  LOOP AT SCREEN.
    IF screen-group1 = 'M1'.
      screen-input = '0'.
      screen-invisible = '1'.
      MODIFY SCREEN.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " SET_SCREEN
*&---------------------------------------------------------------------*
*&      Form  FRM_BDC_FILL_X1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM frm_bdc_fill_x1 .

  DATA: ls_bdcdata  TYPE   bdcdata .

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIQS0'  '0100'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'RIWO00-QMART'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/00'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RIWO00-QMART'  gs_update-qmart
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIQS0'  '7200'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=VA02'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'VIQMEL-QMTXT'  gs_update-qmtxt
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'RIWO1-EQUNR'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RIWO1-EQUNR'  gs_update-equnr
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMV45A'  '4001'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/00'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'VBKD-BSTKD'  gs_update-bstkd
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'RV45A-KWMENG(01)'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RV45A-MABNR(01)'  gs_update-matnr
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RV45A-KWMENG(01)'  '1'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLSPO4'  '0300'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'SVALD-VALUE(01)'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=FURT'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'SVALD-VALUE(01)'  gs_update-bemot
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMV45A'  '4001'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/EBAC1'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIQS0'  '7200'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=BUCH'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

ENDFORM.                    " FRM_BDC_FILL_X1
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_SD
*&---------------------------------------------------------------------*
*       Get Sales and Distribution info
*----------------------------------------------------------------------*
FORM frm_get_sd .

  SELECT    equz~equnr    "
            equz~datbi
            equz~eqlfn
            equz~iloan
            iloa~vkorg    "Sales Organization
            iloa~vtweg    "Distribution Channel
            iloa~spart    "Division
    INTO  TABLE  gt_equz_iloa
    FROM equz
      INNER JOIN iloa
      ON equz~iloan = iloa~iloan
    FOR ALL entries IN gt_update
    WHERE equz~equnr = gt_update-equnr
      AND equz~datbi = gc_datbi_9999.
  IF sy-subrc <> 0.
    MESSAGE s000(yse_sales_log)
      DISPLAY LIKE gc_type_e
      WITH 'Please check the equipment No in the file!'(011).
    LEAVE LIST-PROCESSING.
  ENDIF.
  IF gv_po_check  IS NOT INITIAL.
    SELECT  vbeln
            posnr
            bstkd
    INTO TABLE gt_vbkd
    FROM vbkd
    FOR ALL ENTRIES IN gt_update
    WHERE posnr = space
      AND bstkd = gt_update-bstkd.
  ENDIF.

ENDFORM.                    " FRM_GET_SD
*&---------------------------------------------------------------------*
*&      Form  FRM_CHANGE_SEO
*&---------------------------------------------------------------------*
*       Maintain the head text and operation information
*----------------------------------------------------------------------*
FORM frm_change_seo .

  DATA: lv_refnum  TYPE ifrefnum,
        lv_wait_se TYPE i,
        ls_update_log TYPE ty_update_log,
        lt_operation TYPE STANDARD TABLE OF bapi_alm_order_operation_e,
        ls_operation TYPE bapi_alm_order_operation_e,
        lt_return  TYPE STANDARD TABLE OF bapiret2,
        ls_return   TYPE bapiret2,
        lt_header  TYPE STANDARD TABLE OF bapi_alm_order_headers_i,
        ls_header  TYPE bapi_alm_order_headers_i,
        lt_headup  TYPE STANDARD TABLE OF bapi_alm_order_headers_up,
        ls_headup  TYPE bapi_alm_order_headers_up,
        lt_method TYPE STANDARD TABLE OF bapi_alm_order_method,
        ls_method   TYPE bapi_alm_order_method,
        lv_flag     TYPE flag,
        lt_oper   TYPE STANDARD TABLE OF bapi_alm_order_operation,
        ls_oper   TYPE bapi_alm_order_operation,
        lt_operup TYPE STANDARD TABLE OF  bapi_alm_order_operation_up,
        ls_operup TYPE bapi_alm_order_operation_up.

  lv_wait_se = 1.

  CALL FUNCTION 'BAPI_ALM_ORDER_GET_DETAIL'
    EXPORTING
      number        = gs_orderflow-aufnr
    TABLES
      et_operations = lt_operation
      return        = lt_return.

  CLEAR: ls_method.
  ls_method-refnumber  = '1'.
  ls_method-objecttype = 'HEADER'.
  ls_method-method     =  'CHANGE'.
  ls_method-objectkey  = gs_orderflow-aufnr.
  APPEND ls_method TO lt_method.

  ls_header-orderid    = gs_orderflow-aufnr.
  ls_header-short_text = gs_update-ktext.
  APPEND ls_header TO lt_header.

  ls_headup-orderid    = gs_orderflow-aufnr.
  ls_headup-short_text = gc_x.
  APPEND ls_headup TO lt_headup.

  READ TABLE lt_operation INTO ls_operation
    WITH KEY  acttype = 'ZAM001'.
  IF sy-subrc = 0.
    lv_refnum = lv_refnum + 1.
    CLEAR: ls_method.
    ls_method-refnumber  = lv_refnum .
    ls_method-objecttype = 'OPERATION'.
    ls_method-method    =  'CHANGE'.
    CONCATENATE gs_orderflow-aufnr
                ls_operation-activity
          INTO  ls_method-objectkey .
    APPEND ls_method TO lt_method.

    ls_oper-work_activity = gs_update-dauno.
    APPEND ls_oper TO lt_oper.

    ls_operup-work_activity = gc_x.
    APPEND ls_operup TO lt_operup.
  ENDIF.

  CLEAR: ls_operation.
  READ TABLE lt_operation INTO ls_operation
    WITH KEY  acttype = 'ZAM063'.
  IF sy-subrc = 0.
    lv_refnum = lv_refnum + 1.
    CLEAR: ls_method.
    ls_method-refnumber  = lv_refnum.
    ls_method-objecttype = 'OPERATION'.
    ls_method-method    =  'CHANGE'.
    CONCATENATE gs_orderflow-aufnr
                ls_operation-activity
          INTO  ls_method-objectkey .
    APPEND ls_method TO lt_method.

    ls_oper-work_activity = gs_update-dauno2.
    APPEND ls_oper TO lt_oper.

    ls_operup-work_activity = gc_x.
    APPEND ls_operup TO lt_operup.
  ENDIF.

  CLEAR: ls_operation.
  READ TABLE lt_operation INTO ls_operation
    WITH KEY  acttype = 'ZAM051'.
  IF sy-subrc = 0.
    lv_refnum = lv_refnum + 1.
    CLEAR: ls_method.
    ls_method-refnumber  = lv_refnum.
    ls_method-objecttype = 'OPERATION'.
    ls_method-method    =  'CHANGE'.
    CONCATENATE gs_orderflow-aufnr
                ls_operation-activity
          INTO  ls_method-objectkey .
    APPEND ls_method TO lt_method.

    ls_oper-work_activity = gs_update-dauno3.
    APPEND ls_oper TO lt_oper.

    ls_operup-work_activity = gc_x.
    APPEND ls_operup TO lt_operup.
  ENDIF.

  CLEAR: ls_method.
  ls_method-refnumber  = '1'.
  ls_method-method    =  'SAVE'.
  ls_method-objectkey =  gs_orderflow-aufnr.
  APPEND ls_method TO lt_method.

  WAIT UP TO lv_wait_se SECONDS.
  CALL FUNCTION 'BAPI_ALM_ORDER_MAINTAIN'
    TABLES
      it_methods      = lt_method
      it_header       = lt_header
      it_header_up    = lt_headup
      it_operation    = lt_oper
      it_operation_up = lt_operup
      return          = lt_return.
  CALL FUNCTION 'ALM_ME_COMMIT_OR_ROLLBACK'
    IMPORTING
      commit = lv_flag
    TABLES
      return = lt_return.

  READ TABLE lt_return TRANSPORTING NO FIELDS
    WITH KEY type = gc_type_e.
  IF sy-subrc = 0.
    CLEAR: ls_update_log.
    ls_update_log-bstkd = gs_orderflow-bstkd.
    READ TABLE lt_return INTO ls_return
      WITH KEY type = gc_type_e.
    MESSAGE ID ls_return-id TYPE ls_return-type
      NUMBER ls_return-number
      WITH ls_return-message_v1 ls_return-message_v2
           ls_return-message_v3 ls_return-message_v4
      INTO gs_orderflow-iw32_err.
    ls_update_log-mess = gs_orderflow-iw32_err.
    APPEND ls_update_log TO gt_update_log.
    EXIT.
  ENDIF.

  REFRESH: lt_return.
  IF gs_update-qmart <> gc_qmart_xb.

*   Do release for the non-XB notification
    PERFORM frm_do_release.
*
*    CLEAR: ls_method.
*    ls_method-refnumber  = '1'.
*    ls_method-objecttype = 'HEADER'.
*    ls_method-method    =  'RELEASE'.
*    ls_method-objectkey =  gs_orderflow-aufnr.
*    APPEND ls_method TO lt_method.
*    WAIT UP TO lv_wait_se SECONDS.
*    CALL FUNCTION 'BAPI_ALM_ORDER_MAINTAIN'
*      TABLES
*        it_methods      = lt_method
*        it_header       = lt_header
*        it_header_up    = lt_headup
*        it_operation    = lt_oper
*        it_operation_up = lt_operup
*        return          = lt_return.
*    CALL FUNCTION 'ALM_ME_COMMIT_OR_ROLLBACK'
*      IMPORTING
*        commit = lv_flag
*      TABLES
*        return = lt_return.
*    READ TABLE lt_return TRANSPORTING NO FIELDS
*      WITH KEY type = gc_type_e.
*    IF sy-subrc = 0.
*      READ TABLE lt_return INTO ls_return
*        WITH KEY type = gc_type_e.
*      MESSAGE ID ls_return-id TYPE ls_return-type
*        NUMBER ls_return-number
*        WITH ls_return-message_v1 ls_return-message_v2
*             ls_return-message_v3 ls_return-message_v4
*        INTO gs_orderflow-iw32_err.
*    ENDIF.
  ENDIF.

ENDFORM.                    " FRM_CHANGE_SEO
*&---------------------------------------------------------------------*
*&      Form  FRM_BDC_FILL_XB
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM frm_bdc_fill_xb .
  DATA: ls_bdcdata  TYPE   bdcdata .

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIQS0'  '0100'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'RIWO00-QMART'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/00'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RIWO00-QMART'  gs_update-qmart
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIQS0'  '7200'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=VA02'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'VIQMEL-QMTXT'  gs_update-qmtxt
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'RIWO1-EQUNR'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RIWO1-EQUNR'  gs_update-equnr
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMV45A'  '4001'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/EBAC1'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'VBKD-BSTKD'  gs_update-bstkd
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'RV45A-KWMENG(01)'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RV45A-MABNR(01)'  gs_update-matnr
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RV45A-KWMENG(01)'  '1'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIQS0'  '7200'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=BUCH'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

ENDFORM.                    " FRM_BDC_FILL_XB
*&---------------------------------------------------------------------*
*&      Form  SHOW_ALV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM show_alv .

*  Get ALV DATA
  PERFORM get_alv_data.
* FIELDCAT set
  PERFORM alv_fieldcat_set.
* LAYOUT set
  PERFORM alv_layout_set.
* ALV display
  PERFORM alv_display.

ENDFORM.                    " SHOW_ALV
*&---------------------------------------------------------------------*
*&      Form  ALV_FIELDCAT_SET
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_fieldcat_set .
  DATA:
     lv_linecnt  TYPE i,
     ls_fieldcat TYPE slis_fieldcat_alv.

  CLEAR lv_linecnt.
* P0 Number
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'BSTKD'.
  ls_fieldcat-seltext_s = 'PO No.'(038).
  ls_fieldcat-seltext_m = 'PO Number'(039).
  ls_fieldcat-fix_column = gc_x.
  APPEND ls_fieldcat TO gt_fieldcat.

* Sevice Order No
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'AUFNR'.
  ls_fieldcat-seltext_s = 'SEO No.'(040).
  ls_fieldcat-seltext_m = 'Service Order'(041).
  ls_fieldcat-fix_column = gc_x.
  APPEND ls_fieldcat TO gt_fieldcat.

* SO item
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'MESS'.
  ls_fieldcat-seltext_s = 'Err.Msg'(042).
  ls_fieldcat-seltext_m = 'Error Message'(043).
  APPEND ls_fieldcat TO gt_fieldcat.
ENDFORM.                    " ALV_FIELDCAT_SET
*&---------------------------------------------------------------------*
*&      Form  ALV_LAYOUT_SET
*&---------------------------------------------------------------------*
*      LAYOUT set
*----------------------------------------------------------------------*
FORM alv_layout_set .
  CLEAR: gs_layout.
  gs_layout-zebra = gc_x.               "ALV lines cross-color display
  gs_layout-colwidth_optimize = gc_x.   " Auto optimize column width
  gs_layout-detail_popup = gc_x.        " Show detail screen
*  gs_layout-box_fieldname  = 'SEL'.
ENDFORM.                    " ALV_LAYOUT_SET
*&---------------------------------------------------------------------*
*&      Form  ALV_DISPLAY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM alv_display .
  CHECK gt_alv_output IS NOT INITIAL.
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program = sy-repid
      is_layout          = gs_layout
      it_fieldcat        = gt_fieldcat
    TABLES
      t_outtab           = gt_alv_output
    EXCEPTIONS
      program_error      = 1
      OTHERS             = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
ENDFORM.                    " ALV_DISPLAY
*&---------------------------------------------------------------------*
*&      Form  GET_ALV_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_alv_data .
  DATA: ls_alv_output TYPE ty_alv_output,
        ls_order_flow TYPE ty_order_flow,
        ls_update_log TYPE ty_update_log.
  FIELD-SYMBOLS: <lfs_alv_output> TYPE ty_alv_output.

*  LOOP AT gt_order_flow INTO ls_order_flow
*    WHERE iw32_err IS INITIAL.
*    CONDENSE ls_order_flow-bstkd.
*    CLEAR: ls_alv_output.
*    ls_alv_output-bstkd = ls_order_flow-bstkd.
*    ls_alv_output-aufnr = ls_order_flow-aufnr.
*    ls_alv_output-mess  = 'Successful'(061).
*    READ TABLE gt_overflow INTO ls_update_log
*      WITH KEY bstkd = ls_order_flow-bstkd.
*    IF sy-subrc = 0.
*      CONCATENATE ls_alv_output-mess
*                  ls_update_log-mess
*           INTO ls_alv_output-mess
*           SEPARATED BY  '|'.
*      DELETE TABLE gt_overflow FROM ls_update_log.
*    ENDIF.
*    APPEND ls_alv_output TO gt_alv_output.
*  ENDLOOP.
*  LOOP AT gt_order_flow INTO ls_order_flow
*    WHERE iw32_err IS NOT INITIAL.
*    CLEAR: ls_alv_output.
*    CONDENSE ls_order_flow-bstkd.
*    ls_alv_output-bstkd = ls_order_flow-bstkd.
*    ls_alv_output-aufnr = ls_order_flow-aufnr.
*    ls_alv_output-mess  = ls_order_flow-iw32_err .
*    APPEND ls_alv_output TO gt_alv_output.
*    gv_suc_lines = gv_suc_lines - 1.
*  ENDLOOP.
*  LOOP AT gt_update_log INTO ls_update_log.
*    READ TABLE gt_overflow INTO ls_update_log
*      WITH KEY bstkd = ls_update_log-bstkd.
*    IF sy-subrc = 0.
*      DELETE TABLE gt_overflow FROM ls_update_log.
*    ENDIF.
*  ENDLOOP.
*  APPEND LINES OF gt_overflow TO gt_update_log.

  LOOP AT gt_update_log INTO ls_update_log.
    CLEAR: ls_alv_output.
    ls_alv_output-bstkd = ls_update_log-bstkd.
    ls_alv_output-mess  = ls_update_log-mess.
    APPEND ls_alv_output TO gt_alv_output.
  ENDLOOP.

  LOOP AT gt_alv_output ASSIGNING <lfs_alv_output>.
    READ TABLE gt_order_flow INTO ls_order_flow
      with key bstkd = <lfs_alv_output>-bstkd.
    IF sy-subrc = 0.
      <lfs_alv_output>-aufnr = ls_order_flow-aufnr.
      READ TABLE gt_overflow INTO ls_update_log
        with key bstkd = <lfs_alv_output>-bstkd.
      IF sy-subrc = 0.
        CONCATENATE <lfs_alv_output>-mess '|' ls_update_log-mess
          INTO <lfs_alv_output>-mess.
      ENDIF.
    ENDIF.
  ENDLOOP.

  LOOP AT gt_order_flow INTO ls_order_flow
    WHERE iw32_err IS INITIAL.
    READ TABLE gt_alv_output TRANSPORTING NO FIELDS
      with key bstkd = ls_order_flow-bstkd.
    IF sy-subrc = 0.
      CONTINUE.
    ENDIF.
    CONDENSE ls_order_flow-bstkd.
    CLEAR: ls_alv_output.
    ls_alv_output-bstkd = ls_order_flow-bstkd.
    ls_alv_output-aufnr = ls_order_flow-aufnr.
    ls_alv_output-mess  = 'Successful'(061).
    READ TABLE gt_overflow INTO ls_update_log
      WITH KEY bstkd = ls_order_flow-bstkd.
    IF sy-subrc = 0.
      CONCATENATE ls_alv_output-mess
                  ls_update_log-mess
           INTO ls_alv_output-mess
           SEPARATED BY  '|'.
    ENDIF.
    APPEND ls_alv_output TO gt_alv_output.
  ENDLOOP.

ENDFORM.                    " GET_ALV_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_DO_RELEASE
*&---------------------------------------------------------------------*
*       Do release for the non-XB notification
*----------------------------------------------------------------------*
FORM frm_do_release .

  DATA: lt_bdcmsgcoll TYPE STANDARD TABLE OF bdcmsgcoll,
        lv_mess_str   TYPE string,
        ls_bdcmsg     TYPE bdcmsgcoll,
        ls_option     TYPE ctu_params ,
        ls_update_log TYPE ty_update_log,
        ls_bdcdata  TYPE   bdcdata .

  REFRESH: gt_bdcdata, lt_bdcmsgcoll.
  ls_option-dismode   = 'N'.
  ls_option-updmode   = 'S'.
  ls_option-racommit  = 'X'.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLCOIH'  '0101'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_CURSOR'  'CAUFVD-AUFNR'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/00'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'CAUFVD-AUFNR'  gs_orderflow-aufnr
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLCOIH'  '3000'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=FREI'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLCOIH'  '3000'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '/00'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM  fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLCOIH'  '3000'  'X'  ''  ''
             CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CLEAR  ls_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
          CHANGING ls_bdcdata.
  APPEND ls_bdcdata  TO gt_bdcdata.

  CALL TRANSACTION 'IW32'
    USING gt_bdcdata
    OPTIONS FROM ls_option
    MESSAGES INTO lt_bdcmsgcoll.
  READ TABLE lt_bdcmsgcoll INTO ls_bdcmsg
        WITH KEY msgtyp = gc_type_e.

  IF sy-subrc = 0.
    READ TABLE gt_update_log INTO ls_update_log
      WITH KEY bstkd = gs_update-bstkd.
    IF sy-subrc = 0.
      CLEAR: lv_mess_str.
      MESSAGE ID ls_bdcmsg-msgid TYPE ls_bdcmsg-msgtyp
        NUMBER ls_bdcmsg-msgnr
        WITH ls_bdcmsg-msgv1 ls_bdcmsg-msgv2
             ls_bdcmsg-msgv3 ls_bdcmsg-msgv4
        INTO lv_mess_str.
      CLEAR: ls_update_log.
      ls_update_log-mess = lv_mess_str.
      MODIFY gt_update_log FROM ls_update_log.
      REFRESH: gt_bdcdata,lt_bdcmsgcoll.
      CLEAR: gs_update.
    ELSE.
      CLEAR: lv_mess_str.
      MESSAGE ID ls_bdcmsg-msgid TYPE ls_bdcmsg-msgtyp
        NUMBER ls_bdcmsg-msgnr
        WITH ls_bdcmsg-msgv1 ls_bdcmsg-msgv2
             ls_bdcmsg-msgv3 ls_bdcmsg-msgv4
        INTO lv_mess_str.
      CLEAR: ls_update_log.
      ls_update_log-bstkd = gs_update-bstkd.
      ls_update_log-mess = lv_mess_str.
      APPEND ls_update_log TO gt_update_log.
      REFRESH: gt_bdcdata,lt_bdcmsgcoll.
      CLEAR: gs_update.
    ENDIF.
  ENDIF.
ENDFORM.                    " FRM_DO_RELEASE

*Text symbol text
*001:Select a file for upload
*002:[No Input Data] or [Error Happen On Converting]
*005:Total Process Entries:
*006:Successful Process Entries:
*007:Failed Process Entries:
*008:Successfully update all equipment
*009:Successfully processed entries:
*010:Please enter an invaild filename
*011:Please check the equipment No in the file!
*012:Error to convert record:
*014:Equipment not exist:
*015:Equipment not fulfill the selection screen:
*031:Notification-
*032:|Service-
*033:|SO-
*034:Failed processed entries:
*037:Service Order is not generated!
*038:PO No.
*039:PO Number
*040:SEO No.
*041:Service Order
*042:Err.Msg
*043:Error Message
*055:IW32 update error:
*059:Amount &  is overflow, and reset to 0
*061:Successful
*064:The PO number already exist!
*T01:Input

*T02:Sales and Distribution
*Selection text
*CB_HFLG:        With Header Text
*P_FILE:        Local File
*P_SPART:D       .
*P_VKORG:D       .
*P_VTWEG:D       .
