********************************************************************
* Program ID        : YSE_AM_INVOICE_SF                               *
* Project           : SEED                                            *
* Author            : Pieter Jespers                                  *
* Date              : 29/01/2007                                      *
* Functional spec   : SEED   D263: Layout for AM invoice              *
* Print Program used for smartform YSE_AM_INVOICE_SF                  *
**********************************************************************
* MOD. NO.|  DATE    | NAME     |CORRE.NR  | CHANGE REFERENCE         *
*----------------------------------------------------------------------*
* MOD-001 |2008.05.21|M.Jacobs  |CD1K940547| ZD01+ZD02--> flow A       *
* MOD-002 |2008.05.22|M.Jacobs  |CD1K940586| Correction Detail         *
* MOD-003 |2008.05.22|M.Jacobs  |CD1K940588| Initialisation            *
* MOD-004 |2008.05.23|M.Jacobs  |CD1K940633| VBRP before VBAP + vat    *
* MOD-005 |2008.07.03|K.Pavan   |CD1K941741| Displaying all line items *
* MOD-006 |2008.08.25|N.Narychkina |CD1K941741| Displaying extra info  *
************************************************************************
REPORT yse_am_invoice_sf_250808 LINE-COUNT 100 MESSAGE-ID vn.

TABLES: komk,                          "Communicationarea for conditions
        komp,                          "Communicationarea for conditions
        komvd,                         "Communicationarea for conditions
        vbco3,                         "Communicationarea for view
        vbdka,                         "Headerview
        vbdpa,                         "Itemview
        vbdpau,                        "Subitemnumbers
        conf_out,                      "Configuration data
        sadr,                          "Addresses
        tvag,                          "Reason for rejection
        vedka,                         "Servicecontract head data
        vedpa,                         "Servicecontract position data
        vedkn,                         "Servicecontract head notice data
        vedpn,                         "Servicecontract pos. notice data
        riserls,                       "Serialnumbers
        komser,                        "Serialnumbers for print
        tvbur,                         "Sales office
        tvko,                          "Sales organisation
        adrs,                          "Communicationarea for Address
        fpltdr,                        "billing schedules
        wtad_addis_in_so_print,        "additional
        vbpa,
        wtad_buying_print_extra_text.  "texts belonging to additional

TYPE-POOLS szadr.

INCLUDE rvadtabl.
INCLUDE rvdirekt.
INCLUDE vedadata.

* data for access to central address maintenance
INCLUDE sdzavdat.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
TYPE-POOLS: addi.

DATA price_print_mode(1) TYPE c.       "Print-mode
DATA: retcode   LIKE sy-subrc.         "Returncode
DATA: repeat(1) TYPE c.
DATA: xscreen(1) TYPE c.               "Output on printer or screen
DATA: BEGIN OF steu,                   "Controldata for output
        vdkex(1) TYPE c,
        vdpex(1) TYPE c,
        kbkex(1) TYPE c,
        kbpex(1) TYPE c,
      END OF steu.


DATA: BEGIN OF tvbdpa OCCURS 0.        "Internal table for items
        INCLUDE STRUCTURE vbdpa.
DATA: END OF tvbdpa.

DATA: BEGIN OF tkomv OCCURS 50.
        INCLUDE STRUCTURE komv.
DATA: END OF tkomv.

DATA: BEGIN OF tkomvd OCCURS 50.
        INCLUDE STRUCTURE komvd.
DATA: END OF tkomvd.

DATA: BEGIN OF tvbdpau OCCURS 5.
        INCLUDE STRUCTURE vbdpau.
DATA: END   OF tvbdpau.

DATA: BEGIN OF tkomcon OCCURS 50.
        INCLUDE STRUCTURE conf_out.
DATA: END   OF tkomcon.

DATA: BEGIN OF tkomservh OCCURS 1.
        INCLUDE STRUCTURE vedka.
DATA: END   OF tkomservh.

DATA: BEGIN OF tkomservp OCCURS 5.
        INCLUDE STRUCTURE vedpa.
DATA: END   OF tkomservp.

DATA: BEGIN OF tkomservhn OCCURS 5.
        INCLUDE STRUCTURE vedkn.
DATA: END   OF tkomservhn.

DATA: BEGIN OF tkomservpn OCCURS 5.
        INCLUDE STRUCTURE vedpn.
DATA: END   OF tkomservpn.

DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
DATA: END   OF tkomser_print.

DATA: BEGIN OF tfpltdr OCCURS 5.
        INCLUDE STRUCTURE fpltdr.
DATA: END   OF tfpltdr.

TYPES: BEGIN OF y_type_new,
         pospa TYPE pospa,
         fkimg TYPE fkimg,
         item_categ TYPE pstyv,
         short_text TYPE arktx,
       END OF y_type_new.



DATA: taddi_print TYPE addi_so_print_itab WITH HEADER LINE.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: pr_kappl(01)   TYPE c VALUE 'V'. "Application for pricing

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: nast_anzal LIKE nast-anzal.      "Number of outputs (Orig. + Cop.)
DATA: nast_tdarmod LIKE nast-tdarmod.  "Archiving only one time

* current language for read buffered.
DATA: gf_language LIKE sy-langu.

DATA: wa_knvk_contact TYPE knvk.
DATA: wa_adcp_contact TYPE adcp.
DATA: lv_ztext(60) TYPE c.
DATA: wa_t052 TYPE t052.
DATA: wa_tpfkt_contact TYPE tpfkt.
DATA: it_ztext TYPE TABLE OF ttext.
DATA: wa_ztext TYPE ttext.
DATA: wa_tvbdpa_extra TYPE vbdpa.
DATA: wa_tvbdpa_extra1 TYPE vbdpa.
DATA: wa_tkomv TYPE komv.
DATA: wa_veda TYPE veda.
DATA: wa_vbak TYPE vbak.
DATA: wa_vbak_quot TYPE vbak.
DATA: wa_vbrk TYPE vbrk.
DATA:  it_vbrp TYPE TABLE OF vbrp.
DATA: wa_vbrp TYPE vbrp.
DATA: wa_vbrp0 TYPE vbrp.
DATA: it_tvbdpa_extra TYPE TABLE OF vbdpa.
DATA: w_vtext TYPE t685t-vtext.
DATA: wa_vbpa_bill_to TYPE vbpa.
DATA: wa_vbpa_ship_to TYPE vbpa.
DATA: wa_it_gen TYPE y_type_new.
DATA: wa_it_gen_full TYPE lbbil_it_gen.
DATA: wa_it_gen1 TYPE y_type_new.
DATA: it_gen TYPE TABLE OF y_type_new.
DATA: wa_it_kond TYPE lbbil_it_kond.
DATA: wa_vbfa TYPE vbfa.
DATA: wa_ser02 TYPE ser02.
DATA: wa_objk TYPE objk.
DATA: wa_tvgrt TYPE tvgrt.
DATA: v_vkaus TYPE abrvw.
DATA: v_bezei TYPE bezei20.
DATA: ls_bil_invoice TYPE lbbil_invoice.

DATA: v_tel TYPE telf1.
DATA: v_fax TYPE telfx.
DATA: yse_sf_output TYPE yse_sf_output.
DATA: et_operations	TYPE TABLE OF	bapi_alm_order_operation_e,
      wa_operations TYPE  bapi_alm_order_operation_e,
      et_components TYPE TABLE OF  bapi_alm_order_component_e,
      wa_components LIKE  bapi_alm_order_component_e.
DATA: l_flow(2).
DATA: lay_am_invoice TYPE TABLE OF yse_lay_am_invoice,
      wa_lay_am_invoice TYPE yse_lay_am_invoice,
      wa_lay_am_invoice0 TYPE yse_lay_am_invoice,
* begin of insertion MOD-006
      lay_am_component TYPE TABLE OF yse_lay_am_invoice,
      wa_lay_am_component TYPE yse_lay_am_invoice,
      lay_am_operation TYPE TABLE OF yse_lay_am_invoice,
      wa_lay_am_operation TYPE yse_lay_am_invoice,
* end of insertion MOD-006
      s_kschl_discounts TYPE TABLE OF yse_kschl,
      s_kschl_markups   TYPE TABLE OF yse_kschl,
      w_tot_freight     TYPE netwr,
      w_tot_discount    TYPE netwr,
      w_tot_netwr       TYPE netwr,
      it_vat TYPE TABLE OF yse_vat,
      w_vat_total TYPE  netwr.
DATA: l_faktf TYPE  faktf,
      l_display TYPE  kvgr5,
      l_aufnr TYPE aufnr,
      it_vbap TYPE TABLE OF vbap,
      wa_vbap TYPE vbap.



CONSTANTS:
faktf_costs TYPE  faktf VALUE '02',
faktf_fixedrate TYPE  faktf VALUE '01'.
*&---------------------------------------------------------------------*
*&      Form  ENTRY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry USING return_code TYPE i
                 us_screen TYPE c.
  DATA: lf_retcode TYPE sy-subrc.

  CLEAR retcode.
  xscreen = us_screen.

  PERFORM processing_sf  USING us_screen
                      CHANGING lf_retcode.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY
*
***********************************************************************
*       S U B R O U T I N E S                                         *
***********************************************************************


*---------------------------------------------------------------------*
*       FORM CHECK_REPEAT                                             *
*---------------------------------------------------------------------*
*       A text is printed, if it is a repeat print for the document.  *
*---------------------------------------------------------------------*

FORM check_repeat.

  CLEAR repeat.
  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'.
    CHECK *nast-vstat = '1'.
    repeat = 'X'.
    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT


**---------------------------------------------------------------------*
**       FORM GET_DATA                                                 *
**---------------------------------------------------------------------*
**       General provision of data for the form                        *
**---------------------------------------------------------------------*
*
*FORM GET_DATA.
*
*  DATA: US_VEDA_VBELN     LIKE VEDA-VBELN.
*  DATA: US_VEDA_POSNR_LOW LIKE VEDA-VPOSN.
*
*  DATA: DA_MESS LIKE VBFS OCCURS 0 WITH HEADER LINE.
*
*  CALL FUNCTION 'RV_PRICE_PRINT_GET_MODE'
*    IMPORTING
*      E_PRINT_MODE = PRICE_PRINT_MODE.
*
*  IF PRICE_PRINT_MODE EQ CHARA.
*    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
*      TABLES
*        TKOMV = TKOMV.
*  ENDIF.
*
*  CLEAR KOMK.
*  CLEAR KOMP.
*
*  VBCO3-MANDT = SY-MANDT.
*  VBCO3-SPRAS = NAST-SPRAS.
*  VBCO3-VBELN = NAST-OBJKY.
*  VBCO3-KUNDE = NAST-PARNR.
*  VBCO3-PARVW = NAST-PARVW.
*
*  CALL FUNCTION 'RV_DOCUMENT_PRINT_VIEW'
*    EXPORTING
*      COMWA                       = VBCO3
*    IMPORTING
*      KOPF                        = VBDKA
*    TABLES
*      POS                         = TVBDPA
*      MESS                        = DA_MESS
*    EXCEPTIONS
*      FEHLER_BEI_DATENBESCHAFFUNG = 1.
*  IF SY-SUBRC NE 0.
*    PERFORM PROTOCOL_UPDATE.
*    RETCODE = 1.
*    EXIT.
*  ELSE.
*    LOOP AT DA_MESS.
*      SY-MSGID = DA_MESS-MSGID.
*      SY-MSGNO = DA_MESS-MSGNO.
*      SY-MSGTY = DA_MESS-MSGTY.
*      SY-MSGV1 = DA_MESS-MSGV1.
*      SY-MSGV2 = DA_MESS-MSGV2.
*      SY-MSGV3 = DA_MESS-MSGV3.
*      SY-MSGV4 = DA_MESS-MSGV4.
*      PERFORM PROTOCOL_UPDATE.
*    ENDLOOP.
*  ENDIF.
*
** fill address key --> necessary for emails
*  ADDR_KEY-ADDRNUMBER = VBDKA-ADRNR.
*  ADDR_KEY-PERSNUMBER = VBDKA-ADRNP.
*  ADDR_KEY-ADDR_TYPE  = VBDKA-ADDRESS_TYPE.
*
** Fetch servicecontract-data and notice-data for head and position.
*  US_VEDA_VBELN     = VBDKA-VBELN.
*  US_VEDA_POSNR_LOW = POSNR_LOW.
*  CALL FUNCTION 'SD_VEDA_GET_PRINT_DATA'
*    EXPORTING
*      I_DOCUMENT_NUMBER = US_VEDA_VBELN
*      I_LANGUAGE        = SY-LANGU
*      I_POSNR_LOW       = US_VEDA_POSNR_LOW
*    TABLES
*      PRINT_DATA_POS    = TKOMSERVP
*      PRINT_DATA_HEAD   = TKOMSERVH
*      PRINT_NOTICE_POS  = TKOMSERVPN
*      PRINT_NOTICE_HEAD = TKOMSERVHN.
*
*  PERFORM GET_CONTROLL_DATA.
*
*  PERFORM SENDER.
*  PERFORM CHECK_REPEAT.
*  PERFORM TVBDPAU_CREATE.
*
*ENDFORM.                    "GET_DATA

*---------------------------------------------------------------------*
*       FORM GET_ITEM_BILLING_SCHEDULES                               *
*---------------------------------------------------------------------*
*       In this routine the billing schedules are fetched from the    *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM get_item_billing_schedules.

  REFRESH tfpltdr.
  CHECK NOT vbdpa-fplnr IS INITIAL.

  CALL FUNCTION 'BILLING_SCHED_PRINTVIEW_READ'
    EXPORTING
      i_fplnr    = vbdpa-fplnr
      i_language = nast-spras
      i_vbeln    = vbdka-vbeln
    TABLES
      zfpltdr    = tfpltdr.

ENDFORM.                    "GET_ITEM_BILLING_SCHEDULES



*&---------------------------------------------------------------------*
*&      FORM  GET_ITEM_ADDIS
*&---------------------------------------------------------------------*
*       Additionals data are fetched from database
*----------------------------------------------------------------------*
FORM get_item_addis.

  CLEAR: taddi_print.

  CALL FUNCTION 'WTAD_ADDIS_IN_SO_PRINT'
       EXPORTING
            fi_vbeln              = vbdka-vbeln
            fi_posnr              = vbdpa-posnr
*           FI_LANGUAGE           = SY-LANGU
       TABLES
            fet_addis_in_so_print = taddi_print
       EXCEPTIONS
            addis_not_active      = 1
            no_addis_for_so_item  = 2
            OTHERS                = 3.

ENDFORM.                               " GET_ITEM_ADDIS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS                                 *
*---------------------------------------------------------------------*
*       In this routine the configuration data item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_characteristics.

  DATA da_t_cabn LIKE cabn OCCURS 10 WITH HEADER LINE.
  DATA: BEGIN OF da_key,
          mandt LIKE cabn-mandt,
          atinn LIKE cabn-atinn,
        END   OF da_key.

  REFRESH tkomcon.
  CHECK NOT vbdpa-cuobj IS INITIAL AND
            vbdpa-attyp NE var_typ.

  CALL FUNCTION 'VC_I_GET_CONFIGURATION'
    EXPORTING
      instance      = vbdpa-cuobj
      language      = nast-spras
      print_sales   = charx
    TABLES
      configuration = tkomcon
    EXCEPTIONS
      OTHERS        = 4.

  RANGES : da_in_cabn FOR da_t_cabn-atinn.
* Beschreibung der Merkmale wegen Objektmerkmalen auf sdcom-vkond holen
  CLEAR da_in_cabn. REFRESH da_in_cabn.
  LOOP AT tkomcon.
    da_in_cabn-option = 'EQ'.
    da_in_cabn-sign   = 'I'.
    da_in_cabn-low    = tkomcon-atinn.
    APPEND da_in_cabn.
  ENDLOOP.

  CLEAR da_t_cabn. REFRESH da_t_cabn.
  CALL FUNCTION 'CLSE_SELECT_CABN'
*    EXPORTING
*         KEY_DATE                     = SY-DATUM
*         BYPASSING_BUFFER             = ' '
*         WITH_PREPARED_PATTERN        = ' '
*         I_AENNR                      = ' '
*    IMPORTING
*         AMBIGUOUS_OBJ_CHARACTERISTIC =
     TABLES
          in_cabn                      = da_in_cabn
          t_cabn                       = da_t_cabn
     EXCEPTIONS
          no_entry_found               = 1
          OTHERS                       = 2.

* Preisfindungsmerkmale / Merkmale auf VCSD_UPDATE herausnehmen
  SORT da_t_cabn.
  LOOP AT tkomcon.
    da_key-mandt = sy-mandt.
    da_key-atinn = tkomcon-atinn.
    READ TABLE da_t_cabn WITH KEY da_key BINARY SEARCH.
    IF sy-subrc <> 0 OR
       ( ( da_t_cabn-attab = 'SDCOM' AND
          da_t_cabn-atfel = 'VKOND'       ) OR
        ( da_t_cabn-attab = 'VCSD_UPDATE' ) ) .
      DELETE tkomcon.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_PRICES                                          *
*---------------------------------------------------------------------*
*       In this routine the price data for the item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_prices.

  CLEAR: komp,
         tkomv.

  IF komk-knumv NE vbdka-knumv OR
     komk-knumv IS INITIAL.
    CLEAR komk.
    komk-mandt = sy-mandt.
    komk-kalsm = vbdka-kalsm.
    komk-kappl = pr_kappl.
    komk-waerk = vbdka-waerk.
    komk-knumv = vbdka-knumv.
    komk-knuma = vbdka-knuma.
    komk-vbtyp = vbdka-vbtyp.
    komk-land1 = vbdka-land1.
    komk-vkorg = vbdka-vkorg.
    komk-vtweg = vbdka-vtweg.
    komk-spart = vbdka-spart.
    komk-bukrs = vbdka-bukrs_vf.
    komk-hwaer = vbdka-waers.
    komk-prsdt = vbdka-erdat.
    komk-kurst = vbdka-kurst.
    komk-kurrf = vbdka-kurrf.
    komk-kurrf_dat = vbdka-kurrf_dat.
  ENDIF.
  komp-kposn = vbdpa-posnr.
  komp-kursk = vbdpa-kursk.
  komp-kursk_dat = vbdpa-kursk_dat.
  IF vbdka-vbtyp CA 'HKNOT6'.
    IF vbdpa-shkzg CA ' A'.
      komp-shkzg = 'X'.
    ENDIF.
  ELSE.
    IF vbdpa-shkzg CA 'BX'.
      komp-shkzg = 'X'.
    ENDIF.
  ENDIF.

  IF price_print_mode EQ chara.
    CALL FUNCTION 'RV_PRICE_PRINT_ITEM'
      EXPORTING
        comm_head_i = komk
        comm_item_i = komp
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
        comm_item_e = komp
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ELSE.
    CALL FUNCTION 'RV_PRICE_PRINT_ITEM_BUFFER'
      EXPORTING
        comm_head_i = komk
        comm_item_i = komp
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
        comm_item_e = komp
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ENDIF.

ENDFORM.                    "GET_ITEM_PRICES

**---------------------------------------------------------------------*
**       FORM GET_HEADER_PRICES                                        *
**---------------------------------------------------------------------*
**       In this routine the price data for the header is fetched from *
**       the database.                                                 *
**---------------------------------------------------------------------*
*
*FORM GET_HEADER_PRICES.
*
*  LOOP AT TVBDPA.
*
*    CALL FUNCTION 'SD_TAX_CODE_MAINTAIN'
*      EXPORTING
*        KEY_KNUMV           = VBDKA-KNUMV
*        KEY_KPOSN           = TVBDPA-POSNR
*        I_APPLICATION       = ' '
*        I_PRICING_PROCEDURE = VBDKA-KALSM
*      TABLES
*        XKOMV               = TKOMV.
*
*
*  ENDLOOP.
*
*  IF PRICE_PRINT_MODE EQ CHARA.
*    CALL FUNCTION 'RV_PRICE_PRINT_HEAD'
*      EXPORTING
*        COMM_HEAD_I = KOMK
*        LANGUAGE    = NAST-SPRAS
*      IMPORTING
*        COMM_HEAD_E = KOMK
*      TABLES
*        TKOMV       = TKOMV
*        TKOMVD      = TKOMVD.
*  ELSE.
*    CALL FUNCTION 'RV_PRICE_PRINT_HEAD_BUFFER'
*      EXPORTING
*        COMM_HEAD_I = KOMK
*        LANGUAGE    = NAST-SPRAS
*      IMPORTING
*        COMM_HEAD_E = KOMK
*      TABLES
*        TKOMV       = TKOMV
*        TKOMVD      = TKOMVD.
*  ENDIF.
*
*ENDFORM.                    "GET_HEADER_PRICES
*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*

FORM protocol_update.

  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE



*---------------------------------------------------------------------*
*       FORM SENDER                                                   *
*---------------------------------------------------------------------*
*       This routine determines the address of the sender (Table VKO) *
*---------------------------------------------------------------------*

FORM sender.

  SELECT SINGLE * FROM tvko  WHERE vkorg = vbdka-vkorg.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'TVKO'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
    EXIT.
  ENDIF.

  CLEAR gv_fb_addr_get_selection.
  gv_fb_addr_get_selection-addrnumber = tvko-adrnr.         "SADR40A
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = gv_fb_addr_get_selection
      address_group     = 'CA01'
    IMPORTING
      sadr              = sadr
    EXCEPTIONS
      OTHERS            = 01.
  IF sy-subrc NE 0.
    CLEAR sadr.
  ENDIF.                                                    "SADR40A
  vbdka-sland = sadr-land1.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'SADR'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SENDER

*---------------------------------------------------------------------*
*       FORM TVBDPAU_CREATE                                           *
*---------------------------------------------------------------------*
*       This routine is creating a table which includes the subitem-  *
*       numbers                                                       *
*---------------------------------------------------------------------*

FORM tvbdpau_create.

  CLEAR tvbdpau.
  REFRESH tvbdpau.
  LOOP AT tvbdpa.
    IF tvbdpa-uepos IS INITIAL OR
       tvbdpa-uepos NE tvbdpau-posnr.
* Append work area to internal table TVBDPAU
      IF tvbdpau-uposv > 0.
        APPEND tvbdpau.
        CLEAR tvbdpau.
      ENDIF.
* Start filling new work area
      tvbdpau-posnr = tvbdpa-posnr.

      IF NOT tvbdpa-uepos IS INITIAL AND
         tvbdpa-uepos NE tvbdpau-posnr.
        tvbdpau-posnr = tvbdpa-uepos.
        tvbdpau-uepvw = tvbdpa-uepvw.
        tvbdpau-uposv = tvbdpa-posnr.
      ENDIF.

    ELSE.
      IF tvbdpau-uposv IS INITIAL OR
         tvbdpau-uposv > tvbdpa-posnr.
        tvbdpau-uposv = tvbdpa-posnr.
      ENDIF.
      IF tvbdpau-uposb < tvbdpa-posnr AND
         tvbdpau-uposv < tvbdpa-posnr.
        tvbdpau-uposb = tvbdpa-posnr.
      ENDIF.
      tvbdpau-uepvw = tvbdpa-uepvw.    "UPOS-Verwendung
    ENDIF.
  ENDLOOP.
  IF tvbdpau-uposv > 0.
    APPEND tvbdpau.
  ENDIF.
  SORT tvbdpau.

ENDFORM.                    "TVBDPAU_CREATE

*&---------------------------------------------------------------------*
*&      Form  GET_CONTROLL_DATA
*&---------------------------------------------------------------------*
*       Checks if servicedata for the header exists.                   *
*       Checks if servicedata for the position exists.                 *
*       Checks if noticedata for the header exists.                    *
*       Checks if noticedata for the position exists.                  *
*----------------------------------------------------------------------*
FORM get_controll_data.

  DATA: lines TYPE i.

* Exists servicedata for the header?
  DESCRIBE TABLE tkomservh LINES lines.
  IF lines GT 0.
    steu-vdkex = 'X'.
  ENDIF.

* Exists servicedata for the position?
  DESCRIBE TABLE tkomservp LINES lines.
  IF lines GT 0.
    steu-vdpex = 'X'.
  ENDIF.

* Exists noticedata for the header?
  DESCRIBE TABLE tkomservhn LINES lines.
  IF lines GT 0.
    steu-kbkex = 'X'.
  ENDIF.

* Exists noticedata for the position?
  DESCRIBE TABLE tkomservpn LINES lines.
  IF lines GT 0.
    steu-kbpex = 'X'.
  ENDIF.

ENDFORM.                               " GET_CONTROLL_DATA
*eject


*&---------------------------------------------------------------------*
*&      Form  processing_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM processing_sf USING proc_screen
                   CHANGING cf_retcode.

  DATA: ls_print_data_to_read TYPE lbbil_print_data_to_read.

  DATA: lf_fm_name            TYPE rs38l_fnam.
  DATA: ls_control_param      TYPE ssfctrlop.
  DATA: ls_composer_param     TYPE ssfcompop.
  DATA: ls_recipient          TYPE swotobjid.
  DATA: ls_sender             TYPE swotobjid.
  DATA: lf_formname           TYPE tdsfname.
  DATA: ls_addr_key           LIKE addr_key.
  DATA: ls_dlv-land           LIKE vbrk-land1.
  DATA: ls_job_info           TYPE ssfcrescl.




* SmartForm from customizing table TNAPR
  lf_formname = tnapr-sform.

* determine print data
  PERFORM set_print_data_to_read USING    lf_formname
                                 CHANGING ls_print_data_to_read
                                 cf_retcode.

  IF cf_retcode = 0.
* select print data
    PERFORM get_data_new USING    ls_print_data_to_read
                         CHANGING ls_addr_key
                                  ls_dlv-land
                                  ls_bil_invoice
                                  cf_retcode.

    PERFORM get_data_sf.
    PERFORM header_serv_print_sf.
    PERFORM item_print_sf.
    PERFORM get_extra_data USING ls_bil_invoice.
    PERFORM fill_discount_markup_table.
    PERFORM fill_lay_invoice_table." USING ls_bil_invoice.
    PERFORM fill_vat_table.
    PERFORM data_to_display.
  ENDIF.

  IF cf_retcode = 0.
    PERFORM set_print_param USING    ls_addr_key
                                     ls_dlv-land
                            CHANGING ls_control_param
                                     ls_composer_param
                                     ls_recipient
                                     ls_sender
                                     cf_retcode.
  ENDIF.

  DATA: l_sform TYPE tdsfname,
        l_land1 TYPE land1_gp,
        l_bukrs TYPE bukrs.


  CLEAR l_bukrs.
  SELECT SINGLE bukrs INTO l_bukrs FROM vbrk WHERE vbeln = nast-objky.

  CLEAR l_land1.
  SELECT SINGLE land1 INTO l_land1 FROM  t001
         WHERE  bukrs  = l_bukrs.



  CALL FUNCTION 'YSE_LAY_GET_FNAME'
    EXPORTING
      tnapr = tnapr
      land1 = l_land1
    IMPORTING
      sform = l_sform.

  IF NOT l_sform IS INITIAL.
    lf_formname = l_sform .
  ELSE.
    lf_formname = tnapr-sform.
  ENDIF.

  IF cf_retcode = 0.
* determine smartform function module for invoice
    CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
         EXPORTING  formname           = lf_formname
*                 variant            = ' '
*                 direct_call        = ' '
         IMPORTING  fm_name            = lf_fm_name
         EXCEPTIONS no_form            = 1
                    no_function_module = 2
                    OTHERS             = 3.
    IF sy-subrc <> 0.
*   error handling
      cf_retcode = sy-subrc.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

  IF cf_retcode = 0.
    PERFORM check_repeat.
    IF ls_composer_param-tdcopies EQ 0.
      nast_anzal = 1.
    ELSE.
      nast_anzal = ls_composer_param-tdcopies.
    ENDIF.
    ls_composer_param-tdcopies = 1.
    DO nast_anzal TIMES.
* In case of repetition only one time archiving
      IF sy-index > 1 AND nast-tdarmod = 3.
        nast_tdarmod = nast-tdarmod.
        nast-tdarmod = 1.
        ls_composer_param-tdarmod = 1.
      ENDIF.
      IF sy-index NE 1 AND repeat IS INITIAL.
        repeat = 'X'.
      ENDIF.
* call smartform invoice

*There are more tables that we give to the function like:
*tkomservp
*tkomservh
*tkomservpn
*tkomservhn
*tkomcon
*taddi_print
*vbc03

      CALL FUNCTION lf_fm_name
           EXPORTING
                      archive_index        = toa_dara
                      archive_parameters   = arc_params
                      control_parameters   = ls_control_param
                      mail_recipient       = ls_recipient
                      mail_sender          = ls_sender
                      output_options       = ls_composer_param
                      user_settings        = space
                      is_nast              = nast
                      is_repeat            = repeat
                      vbdka                = vbdka
                      sadr                 = sadr
                      wa_knvk_contact      = wa_knvk_contact
                      wa_adcp_contact      = wa_adcp_contact
                      wa_tpfkt_contact     = wa_tpfkt_contact
                      wa_veda              = wa_veda
                      wa_vbak              = wa_vbak
                      wa_vbpa_ship_to      = wa_vbpa_ship_to
                      wa_vbpa_bill_to      = wa_vbpa_bill_to
                      is_bil_invoice       = ls_bil_invoice
                      wa_tvgrt             = wa_tvgrt
                      wa_vbrk              = wa_vbrk
                      v_fname              = lf_formname
                      l_faktf              = l_faktf
                      w_vat_total          = w_vat_total
                      tot_freight          = w_tot_freight
                      tot_discount         = w_tot_discount
                      tot_netwr            = w_tot_netwr
                      sf_output            = yse_sf_output
           IMPORTING  job_output_info      = ls_job_info
*                     document_output_info =
*                     job_output_options   =
           TABLES     tvbdpa               = tvbdpa
                      tkomser              = tkomser
                      tfpltdr              = tfpltdr
                      tkomv                = tkomv
                      tvbdpa_extra         = it_tvbdpa_extra
                      et_operations        = et_operations
                      lay_am_invoice       = lay_am_invoice
                      s_kschl_discounts    = s_kschl_discounts
                      s_kschl_markups      = s_kschl_markups
                      it_vbap              = it_vbap
                      it_vbrp              = it_vbrp
                      it_vat               = it_vat

           EXCEPTIONS formatting_error     = 1
                      internal_error       = 2
                      send_error           = 3
                      user_canceled        = 4
                      OTHERS               = 5.

      IF sy-subrc <> 0.
*   error handling
        cf_retcode = sy-subrc.
        PERFORM protocol_update.
* get SmartForm protocoll and store it in the NAST protocoll
        PERFORM add_smfrm_prot.
      ENDIF.
    ENDDO.
* get SmartForm spoolid and store it in the NAST protocoll
    DATA ls_spoolid LIKE LINE OF ls_job_info-spoolids.
    LOOP AT ls_job_info-spoolids INTO ls_spoolid.
      IF ls_spoolid NE space.
        PERFORM protocol_update_spool USING '342' ls_spoolid
                                            space space space.
*       MOD-001 - start of modification for PDF output
        IF nast-nacha = '8'.
*         Define variable to build suggested file name
          DATA: lv_fname TYPE string.
*         Build suggested filename
          CONCATENATE wa_vbrk-fkart
                      '_'
                      wa_vbrk-vbeln
                      '.pdf'
                 INTO lv_fname.
*         Call function to convert the spool to a local PDF file
          CALL FUNCTION 'YSE_PRINT_PDF'
            EXPORTING
              ps_spoolid = ls_spoolid
              pv_fname   = lv_fname.
        ENDIF.
*       MOD-001 - end of modif

      ENDIF.
    ENDLOOP.
    ls_composer_param-tdcopies = nast_anzal.
    IF NOT nast_tdarmod IS INITIAL.
      nast-tdarmod = nast_tdarmod.
      CLEAR nast_tdarmod.
    ENDIF.

  ENDIF.

ENDFORM.                    " processing_sf
*&---------------------------------------------------------------------*
*&      Form  set_print_param
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_ADDR_KEY  text
*      -->P_LS_DLV_LAND  text
*      <--P_LS_CONTROL_PARAM  text
*      <--P_LS_COMPOSER_PARAM  text
*      <--P_LS_RECIPIENT  text
*      <--P_LS_SENDER  text
*      <--P_CF_RETCODE  text
*----------------------------------------------------------------------*
FORM set_print_param USING    is_addr_key LIKE addr_key
                              is_dlv-land LIKE vbrk-land1
                     CHANGING cs_control_param TYPE ssfctrlop
                              cs_composer_param TYPE ssfcompop
                              cs_recipient TYPE  swotobjid
                              cs_sender TYPE  swotobjid
                              cf_retcode TYPE sy-subrc.

  DATA: ls_itcpo     TYPE itcpo.
  DATA: lf_repid     TYPE sy-repid.
  DATA: lf_device    TYPE tddevice.
  DATA: ls_recipient TYPE swotobjid.
  DATA: ls_sender    TYPE swotobjid.

  lf_repid = sy-repid.

  CALL FUNCTION 'WFMC_PREPARE_SMART_FORM'
    EXPORTING
      pi_nast       = nast
      pi_country    = is_dlv-land
      pi_addr_key   = is_addr_key
      pi_repid      = lf_repid
      pi_screen     = xscreen
    IMPORTING
      pe_returncode = cf_retcode
      pe_itcpo      = ls_itcpo
      pe_device     = lf_device
      pe_recipient  = cs_recipient
      pe_sender     = cs_sender.

  IF cf_retcode = 0.
    MOVE-CORRESPONDING ls_itcpo TO cs_composer_param.
*   CS_CONTROL_PARAM-NO_OPEN
*   CS_CONTROL_PARAM-NO_CLOSE
    cs_control_param-device      = lf_device.
    cs_control_param-no_dialog   = 'X'.
    cs_control_param-preview     = xscreen.
    cs_control_param-getotf      = ls_itcpo-tdgetotf.
    cs_control_param-langu       = nast-spras.

  ENDIF.

ENDFORM.                    " set_print_param
*&---------------------------------------------------------------------*
*&      Form  add_smfrm_prot
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM add_smfrm_prot .

  DATA: lt_errortab             TYPE tsferror.
* DATA: LF_MSGNR                TYPE SY-MSGNO.
  FIELD-SYMBOLS: <fs_errortab>  TYPE LINE OF tsferror.

* get smart form protocoll
  CALL FUNCTION 'SSF_READ_ERRORS'
    IMPORTING
      errortab = lt_errortab.

* add smartform protocoll to nast protocoll
  LOOP AT lt_errortab ASSIGNING <fs_errortab>.
*   CLEAR LF_MSGNR.
*   LF_MSGNR = <FS_ERRORTAB>-ERRNUMBER.
    CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
         EXPORTING
              msg_arbgb = <fs_errortab>-msgid
*             MSG_NR    = LF_MSGNR
              msg_nr    = <fs_errortab>-msgno
              msg_ty    = <fs_errortab>-msgty
              msg_v1    = <fs_errortab>-msgv1
              msg_v2    = <fs_errortab>-msgv2
              msg_v3    = <fs_errortab>-msgv3
              msg_v4    = <fs_errortab>-msgv4
         EXCEPTIONS
              OTHERS    = 1.
  ENDLOOP.


ENDFORM.                    " add_smfrm_prot
*&---------------------------------------------------------------------*
*&      Form  protocol_update_spool
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_4225   text
*      -->P_LS_SPOOLID  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*----------------------------------------------------------------------*
FORM protocol_update_spool  USING    syst_msgno
                                     p_ls_spoolid
                                     p_space1
                                     p_space2
                                     p_space3.
  syst-msgid = 'VN'.
  syst-msgno = syst_msgno.
  syst-msgv1 = p_ls_spoolid.
  CONDENSE syst-msgv1.
  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = p_space1
      msg_v3    = p_space2
      msg_v4    = p_space3
    EXCEPTIONS
      OTHERS    = 1.


ENDFORM.                    " protocol_update_spool
*&---------------------------------------------------------------------*
*&      Form  get_data_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_data_sf .

  DATA: us_veda_vbeln     LIKE veda-vbeln.
  DATA: us_veda_posnr_low LIKE veda-vposn.

  DATA: da_mess LIKE vbfs OCCURS 0 WITH HEADER LINE.

  CALL FUNCTION 'RV_PRICE_PRINT_GET_MODE'
    IMPORTING
      e_print_mode = price_print_mode.

  IF price_print_mode EQ chara.
    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
      TABLES
        tkomv = tkomv.
  ENDIF.

  CLEAR komk.
  CLEAR komp.

  vbco3-mandt = sy-mandt.
  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.


  CALL FUNCTION 'RV_DOCUMENT_PRINT_VIEW'
    EXPORTING
      comwa                       = vbco3
    IMPORTING
      kopf                        = vbdka
    TABLES
      pos                         = tvbdpa
      mess                        = da_mess
    EXCEPTIONS
      fehler_bei_datenbeschaffung = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
    retcode = 1.
    EXIT.
  ELSE.
    LOOP AT da_mess.
      sy-msgid = da_mess-msgid.
      sy-msgno = da_mess-msgno.
      sy-msgty = da_mess-msgty.
      sy-msgv1 = da_mess-msgv1.
      sy-msgv2 = da_mess-msgv2.
      sy-msgv3 = da_mess-msgv3.
      sy-msgv4 = da_mess-msgv4.
      PERFORM protocol_update.
    ENDLOOP.
  ENDIF.

* fill address key --> necessary for emails
  addr_key-addrnumber = vbdka-adrnr.
  addr_key-persnumber = vbdka-adrnp.
  addr_key-addr_type  = vbdka-address_type.

* Fetch servicecontract-data and notice-data for head and position.
  us_veda_vbeln     = vbdka-vbeln.
  us_veda_posnr_low = posnr_low.
  CALL FUNCTION 'SD_VEDA_GET_PRINT_DATA'
    EXPORTING
      i_document_number = us_veda_vbeln
      i_language        = sy-langu
      i_posnr_low       = us_veda_posnr_low
    TABLES
      print_data_pos    = tkomservp
      print_data_head   = tkomservh
      print_notice_pos  = tkomservpn
      print_notice_head = tkomservhn.

  PERFORM get_controll_data.

  PERFORM sender.
  PERFORM check_repeat.
  PERFORM tvbdpau_create.


ENDFORM.                    " get_data_sf
*&---------------------------------------------------------------------*
*&      Form  header_serv_print_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM header_serv_print_sf .

  CHECK NOT steu-vdkex IS INITIAL.
  READ TABLE tkomservh INDEX 1.
  MOVE tkomservh TO vedka.


ENDFORM.                    " header_serv_print_sf
*&---------------------------------------------------------------------*
*&      Form  item_print_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM item_print_sf .

  DATA: da_subrc LIKE sy-subrc,
        da_dragr LIKE tvag-dragr.
  DATA: da_ganf(1) TYPE c,      "Print flag for billing correction
        da_lanf(1) TYPE c.      "Print flag for billing correction

  LOOP AT tvbdpa.
    vbdpa = tvbdpa.

    IF vbdpa-dragr EQ space.           "Print rejected item?
      IF vbdpa-posnr_neu NE space.     "Item
        PERFORM get_item_prices.
      ELSE.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " item_print_sf
*&---------------------------------------------------------------------*
*&      Form  get_extra_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_extra_data USING ls_bil_invoice TYPE lbbil_invoice.
  DATA: l_vbelv TYPE vbelv.

  CLEAR: wa_knvk_contact,
         wa_adcp_contact,
         wa_tpfkt_contact,
         wa_tvbdpa_extra,
         wa_tkomv.

  FREE: it_ztext,
        it_tvbdpa_extra.

*Get the contact person
  SELECT SINGLE * FROM knvk INTO wa_knvk_contact
                WHERE kunnr EQ ls_bil_invoice-hd_gen-sold_to_party.

*Get the phone and fax of contact
  IF sy-subrc EQ 0.
    SELECT SINGLE * FROM adcp INTO wa_adcp_contact
                  WHERE persnumber EQ wa_knvk_contact-prsnr AND
                        date_from <= sy-datum AND
                        date_to >= sy-datum.
*Get the title of the contact
    SELECT SINGLE * FROM tpfkt INTO wa_tpfkt_contact
                  WHERE pafkt EQ wa_knvk_contact-pafkt AND
                  spras EQ nast-spras.
    IF sy-subrc NE 0.
      SELECT SINGLE * FROM tpfkt INTO wa_tpfkt_contact
                WHERE pafkt EQ wa_knvk_contact-pafkt AND
                spras EQ 'E'.
    ENDIF.

  ENDIF.

*If the telephone number of the contact person is not available we need
*to get it from the customer master
  IF wa_adcp_contact-tel_number IS INITIAL OR
     wa_adcp_contact-fax_number IS INITIAL.
    CLEAR: v_tel, v_fax.
    SELECT SINGLE telf1 telfx FROM kna1 INTO (v_tel, v_fax)
                      WHERE kunnr EQ ls_bil_invoice-hd_gen-sold_to_party
                      .
*Fill tel
    IF wa_adcp_contact-tel_number IS INITIAL.
      wa_adcp_contact-tel_number = v_tel.
    ENDIF.
*Fill fax
    IF wa_adcp_contact-fax_number IS INITIAL.
      wa_adcp_contact-fax_number = v_fax.
    ENDIF.

  ENDIF.


*Get the ADRNR for the ship-to party
  SELECT SINGLE * FROM vbpa INTO wa_vbpa_ship_to
                WHERE vbeln EQ ls_bil_invoice-hd_gen-bil_number AND
                      posnr EQ '000000' AND
                      parvw EQ 'WE'.

*Get the ADRNR for the bill-to party
  SELECT SINGLE * FROM vbpa INTO wa_vbpa_bill_to
                WHERE vbeln EQ ls_bil_invoice-hd_gen-bil_number AND
                      posnr EQ '000000' AND
                      parvw EQ 'RE'.

*Above function does not work properly so we do it manually!!
  CLEAR vbdka-zterm_tx4.

  wa_t052-zterm = ls_bil_invoice-hd_gen-terms_paym.

  FREE it_ztext.
  CALL FUNCTION 'FI_TEXT_ZTERM'
    EXPORTING
      i_t052  = wa_t052
    TABLES
      t_ztext = it_ztext.

  READ TABLE it_ztext INTO wa_ztext INDEX 1.
  MOVE wa_ztext TO vbdka-zterm_tx4.


*Get the estimated rental start and end
  SELECT SINGLE * FROM veda INTO wa_veda
            WHERE vbeln EQ ls_bil_invoice-hd_ref-order_numb AND
                  vposn EQ '000000'.

*Get vbak info (linked sales order)
  SELECT SINGLE * FROM vbak INTO wa_vbak
              WHERE vbeln EQ ls_bil_invoice-hd_ref-order_numb.

*Get quotation info:
  CLEAR l_vbelv.
  SELECT SINGLE vbelv INTO l_vbelv FROM vbfa
         WHERE vbeln = ls_bil_invoice-hd_ref-order_numb
           AND vbtyp_v = 'B'.

  CLEAR wa_vbak_quot.
  SELECT SINGLE * FROM vbak INTO wa_vbak_quot WHERE vbeln = l_vbelv.


*Get the description of the sales group
  SELECT SINGLE * FROM tvgrt INTO wa_tvgrt
             WHERE vkgrp EQ vbdka-vkgrp.


*Get vbrk info (linked sales order)
  SELECT SINGLE * FROM vbrk INTO wa_vbrk
              WHERE vbeln EQ ls_bil_invoice-hd_gen-bil_number.


ENDFORM.                    " get_extra_data
*&---------------------------------------------------------------------*
*&      Form  get_data_new
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_PRINT_DATA_TO_READ  text
*      <--P_LS_ADDR_KEY  text
*      <--P_LS_DLV_LAND  text
*      <--P_LS_BIL_INVOICE  text
*      <--P_CF_RETCODE  text
*----------------------------------------------------------------------*
FORM get_data_new
     USING    is_print_data_to_read TYPE lbbil_print_data_to_read
     CHANGING cs_addr_key           LIKE addr_key
              cs_dlv-land           LIKE vbrk-land1
              cs_bil_invoice        TYPE lbbil_invoice
              cf_retcode.


  IF nast-objky+10 NE space.
    nast-objky = nast-objky+16(10).
  ELSE.
    nast-objky = nast-objky.
  ENDIF.

  CLEAR cs_bil_invoice.
* read print data
  CALL FUNCTION 'LB_BIL_INV_OUTP_READ_PRTDATA'
    EXPORTING
      if_bil_number         = nast-objky
      if_parvw              = nast-parvw
      if_parnr              = nast-parnr
      if_language           = nast-spras
      is_print_data_to_read = is_print_data_to_read
    IMPORTING
      es_bil_invoice        = cs_bil_invoice
    EXCEPTIONS
      records_not_found     = 1
      records_not_requested = 2
      OTHERS                = 3.
  IF sy-subrc <> 0.
*  error handling
    cf_retcode = sy-subrc.
    PERFORM protocol_update.
  ENDIF.

* get nast partner adress for communication strategy
  PERFORM get_addr_key USING    cs_bil_invoice-hd_adr
                       CHANGING cs_addr_key.

* get delivery land
  PERFORM get_dlv-land USING    cs_bil_invoice-hd_gen
                       CHANGING cs_dlv-land.


ENDFORM.                    " get_data_new

*&---------------------------------------------------------------------*
*&      Form  get_addr_key
*&---------------------------------------------------------------------*
FORM get_addr_key USING    it_hd_adr   TYPE lbbil_invoice-hd_adr
                  CHANGING cs_addr_key LIKE addr_key.

  FIELD-SYMBOLS <fs_hd_adr> TYPE LINE OF lbbil_invoice-hd_adr.

  READ TABLE it_hd_adr ASSIGNING <fs_hd_adr>
                       WITH KEY bil_number = nast-objky
                                partn_role = nast-parvw.
  IF sy-subrc = 0.
    cs_addr_key-addrnumber = <fs_hd_adr>-addr_no.
    cs_addr_key-persnumber = <fs_hd_adr>-person_numb.
    cs_addr_key-addr_type  = <fs_hd_adr>-address_type.
  ENDIF.

ENDFORM.                               " get_addr_key

*&---------------------------------------------------------------------*
*&      Form  get_dlv_land
*&---------------------------------------------------------------------*
FORM get_dlv-land USING    it_hd_gen   TYPE lbbil_invoice-hd_gen
                  CHANGING cs_dlv-land LIKE vbrk-land1.

  DATA: ls_address TYPE kna1.

  CALL FUNCTION 'VIEW_KNA1'
    EXPORTING
      kunde     = nast-parnr
    IMPORTING
      anschrift = ls_address
    EXCEPTIONS
      no_kna1   = 1
      OTHERS    = 2.

  IF sy-subrc <> 0.
    PERFORM protocol_update.
  ENDIF.

  cs_dlv-land = ls_address-land1.


ENDFORM.                               " get_dlv_land
*---------------------------------------------------------------------*
*       FORM SET_PRINT_DATA_TO_READ                                   *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*
FORM set_print_data_to_read
         USING    if_formname LIKE tnapr-sform
         CHANGING cs_print_data_to_read TYPE lbbil_print_data_to_read
                  cf_retcode.

  FIELD-SYMBOLS: <fs_print_data_to_read> TYPE xfeld.
  DATA: lt_fieldlist TYPE tsffields.

* set print data requirements
  DO.
    ASSIGN COMPONENT sy-index OF STRUCTURE
                     cs_print_data_to_read TO <fs_print_data_to_read>.
    IF sy-subrc <> 0. EXIT. ENDIF.
    <fs_print_data_to_read> = 'X'.
  ENDDO.

  CALL FUNCTION 'SSF_FIELD_LIST'
    EXPORTING
      formname                = if_formname
*     VARIANT                 = ' '
    IMPORTING
      fieldlist               = lt_fieldlist
   EXCEPTIONS
     no_form                  = 1
     no_function_module       = 2
     OTHERS                   = 3.
  IF sy-subrc <> 0.
*  error handling
    cf_retcode = sy-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SET_PRINT_DATA_TO_READ

*&---------------------------------------------------------------------*
*&      Form  data_to_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*We take a look at the sales order header level to se
* what data to be displayed.
*when copy rule for field kvgr1 from quotation to orders is
*implemented, we should use this field from quotation.
*search help KVGR-ORDER (issue 2780)
*----------------------------------------------------------------------*
FORM data_to_display .

  CLEAR yse_sf_output.
* case wa_vbak-kvgr1.
  CASE wa_vbak_quot-kvgr1.
    WHEN '006'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_objects = 'X'.
    WHEN '007'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_objects = 'X'.
    WHEN '008'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_kwmeng = 'X'.
      yse_sf_output-v_vrkme = 'X'.
      yse_sf_output-v_netwr = 'X'.
      yse_sf_output-v_netpr = 'X'.
      yse_sf_output-v_objects = 'X'.
    WHEN '009'.
      yse_sf_output-v_tasklist = 'X'.
      yse_sf_output-v_objects = 'X'.
    WHEN '010'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_tasklist = 'X'.
      yse_sf_output-v_objects = 'X'.
    WHEN '011'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_tasklist = 'X'.
      yse_sf_output-v_objects = 'X'.
    WHEN space.  "we don't show any objects.
      CLEAR yse_sf_output.
    WHEN OTHERS.                                            "'012'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_kwmeng = 'X'.
      yse_sf_output-v_vrkme = 'X'.
      yse_sf_output-v_netwr = 'X'.
      yse_sf_output-v_netpr = 'X'.
      yse_sf_output-v_tasklist = 'X'.
      yse_sf_output-v_objects = 'X'.
  ENDCASE.

ENDFORM.                    " data_to_display
*&---------------------------------------------------------------------*
*&      Form  fill_discount_markup_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_discount_markup_table .

  DATA: wa_kschl          TYPE          yse_kschl.
*fill discount table
*Fill all the discount conditions
  wa_kschl-sign = 'I'.
  wa_kschl-option = 'EQ'.
*Z098
  wa_kschl-low = 'Z098'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z099
  wa_kschl-low = 'Z099'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z102
  wa_kschl-low = 'Z102'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z103
  wa_kschl-low = 'Z103'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z104
  wa_kschl-low = 'Z104'.
  APPEND wa_kschl TO s_kschl_discounts.
*ZK04
  wa_kschl-low = 'ZK04'.
  APPEND wa_kschl TO s_kschl_discounts.
*R101
  wa_kschl-low = 'RA01'.
  APPEND wa_kschl TO s_kschl_discounts.

*Fill markup table
  wa_kschl-sign = 'I'.
  wa_kschl-option = 'EQ'.

  wa_kschl-low = 'Z100'.
  APPEND wa_kschl TO s_kschl_markups.

  wa_kschl-low = 'Z101'.
  APPEND wa_kschl TO s_kschl_markups.

ENDFORM.                    " fill_discount_markup_table
*&---------------------------------------------------------------------*
*&      Form  fill_vat_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_vat_table .

  DATA: wa_vat  TYPE  yse_vat,
        l_vat_char  TYPE  char2.

  DATA: l_vat TYPE stceg.
  DATA: num TYPE p DECIMALS 2.
  REFRESH it_vat.

  REFRESH tkomv.
  CLEAR tkomv.
* begin of insertion MOD-003
  CLEAR: w_vat_total.
* end of insertion MOD-003
  SELECT * FROM konv INTO TABLE tkomv WHERE knumv = wa_vbrk-knumv.


  LOOP AT tkomv WHERE kschl = 'MWST'.
    num = tkomv-kbetr / 10.
    WRITE num TO wa_vat-vat LEFT-JUSTIFIED.
    IF nast-kschl = 'ZAM4'.
      READ TABLE tvbdpa INTO wa_tvbdpa_extra
      WITH KEY posnr = tkomv-kposn.
* begin of insertion MOD-004
      IF sy-subrc = 0.
* end of insertion MOD-004
        wa_vat-kawrt = wa_tvbdpa_extra-netwr.
        wa_vat-kwert =  wa_tvbdpa_extra-netwr * num / 100.
* begin of insertion MOD-004
      ELSE.
        wa_vat-kawrt = tkomv-kawrt.
        wa_vat-kwert = tkomv-kwert.
      ENDIF.
* end of insertion MOD-004
    ELSE.
      wa_vat-kawrt = tkomv-kawrt.
      wa_vat-kwert = tkomv-kwert.
    ENDIF.
    IF wa_vat-kwert IS INITIAL.
      CONTINUE.
    ENDIF.
    COLLECT wa_vat INTO it_vat.
  ENDLOOP.

  LOOP AT it_vat INTO wa_vat.
    w_vat_total = w_vat_total + wa_vat-kwert.
    l_vat = wa_vat-vat.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = l_vat
      IMPORTING
        output = l_vat_char.
    SHIFT l_vat_char RIGHT DELETING TRAILING ','.
    SHIFT l_vat_char RIGHT DELETING TRAILING '.'.
    wa_vat-vat = l_vat_char.

    WRITE wa_vat-kawrt TO wa_vat-kawrt_c LEFT-JUSTIFIED.
    WRITE wa_vat-kwert TO wa_vat-kwert_c LEFT-JUSTIFIED.
    MODIFY it_vat FROM wa_vat.
  ENDLOOP.

ENDFORM.                    " fill_vat_table
*&---------------------------------------------------------------------*
*&      Form  fill_lay_invoice_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_lay_invoice_table. "USING ls_bil_invoice TYPE lbbil_invoice.

  TYPES: BEGIN OF tp_coll_mat,
  posnr TYPE posnr,
  matnr TYPE vbrp-matnr,
  netwr TYPE vbrp-netwr,
  fkimg TYPE vbrp-fkimg,
  vrkme TYPE vbrp-vrkme,
  END OF tp_coll_mat.

  TYPES: it_coll_mat TYPE TABLE OF tp_coll_mat.
  DATA: wa_coll_mat TYPE  tp_coll_mat,
         it_coll_mat TYPE it_coll_mat.

  DATA: wa_it_gen TYPE lbbil_it_gen,
        l_mtart TYPE mtart,
        l_tabix TYPE sy-tabix,
        it_vbrp0 TYPE TABLE OF vbrp,
        wa_mara TYPE mara,
        lv_grmat  TYPE  char1,
        it_vbrp_grmat TYPE  TABLE OF vbrp.



*determine the flow (fixed rate or costs)
  CLEAR l_faktf.
  SELECT SINGLE faktf INTO l_faktf FROM vbkd
  WHERE vbeln = wa_vbak-vbeln
    AND faktf NE space.
  IF sy-subrc NE 0.                                         "X7 flow
    l_faktf = '01'.
  ENDIF.

* begin of deletion MOD-004
*  PERFORM get_vbap_data.
* end of deletion MOD-004
  PERFORM get_vbrp_data.
* begin of insertion MOD-004
  PERFORM get_vbap_data.
* end of insertion MOD-004

*get data fixed rate:
  IF l_faktf = faktf_fixedrate.                             "ZAM1
    CLEAR l_flow.
*check item category on sales order line 10
    READ TABLE ls_bil_invoice-it_gen INTO wa_it_gen
    WITH KEY itm_number = '00010'.

    CASE wa_it_gen-item_categ.
      WHEN 'ZO05'.
        l_flow = 'A'. "all flows except XB and X1 flow with billing form
        "02
      WHEN 'ZO01' OR 'ZO02'.
        "We decided to take the same logic for both flows
        l_flow = 'A'.  "Xb with billing form 01
* begin of insertion MOD-001
      WHEN 'ZD01' OR 'ZD02'.
        l_flow = 'A'.
* end of insertion MOD-001
    ENDCASE.

    REFRESH lay_am_invoice.
    IF l_flow = 'A'.
*The data is coming from the service order confirmation :
      PERFORM get_data_from_service_order.
    ELSEIF l_flow = 'B'.
*The data is coming from the DMR
      PERFORM get_data_from_dmr.
    ENDIF.

*the zmat materials should be grouped!
    LOOP AT lay_am_invoice INTO wa_lay_am_invoice.
      CLEAR l_mtart.
      SELECT SINGLE mtart INTO l_mtart FROM mara
      WHERE matnr = wa_lay_am_invoice-matnr.

      IF l_mtart = 'ZMAT'.
*an additional check has to be made for subcontracting:  we check if the
* material is also to be found in the sales order
        DESCRIBE TABLE it_vbap.
        IF sy-tfill > 0.
         READ TABLE it_vbap INTO wa_vbap WITH KEY matnr = wa_vbrp-matnr.
          IF sy-subrc NE 0.
            DELETE it_vbrp INDEX l_tabix.
            CONTINUE.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.


*-----------------------------------------------------------------------
*
*get data costs:
  IF l_faktf = faktf_costs.
    it_vbrp0[] = it_vbrp[].
    LOOP AT it_vbrp INTO wa_vbrp WHERE pstyv = 'ZD01'.
*Grouping necessary, remember ZD02 are the service items (visit)
      CLEAR wa_mara.
      SELECT SINGLE * FROM mara INTO wa_mara
      WHERE matnr EQ wa_vbrp-matnr.
      IF wa_mara-mtart EQ 'ZMAT'       "components
      OR wa_mara-matkl = '041010000'   "Labour
      OR wa_mara-matkl = '041020000'   "Mileage
      OR wa_mara-matkl = '041030000'   "Subcontr
      OR wa_mara-matkl = '041040000'.  "Expenses
        wa_coll_mat-posnr = wa_vbrp-uepos.
        wa_coll_mat-matnr = wa_vbrp-matnr.
        wa_coll_mat-netwr = wa_vbrp-netwr.
        wa_coll_mat-fkimg = wa_vbrp-fkimg.
        wa_coll_mat-vrkme = wa_vbrp-vrkme.
        COLLECT wa_coll_mat INTO it_coll_mat.
        DELETE TABLE it_vbrp FROM wa_vbrp.
        IF lv_grmat IS INITIAL.
          APPEND wa_vbrp TO it_vbrp_grmat.
          lv_grmat = 'X'.
        ENDIF.
      ENDIF.
      CLEAR wa_coll_mat.
    ENDLOOP.

    IF NOT it_coll_mat[] IS INITIAL.
      CLEAR wa_coll_mat.
      LOOP AT it_coll_mat INTO wa_coll_mat.
        CLEAR: wa_vbrp-arktx, wa_vbrp.
        READ TABLE it_vbrp0 INTO wa_vbrp0
        WITH KEY matnr = wa_coll_mat-matnr.
        wa_vbrp-posnr = wa_vbrp0-posnr.
        wa_vbrp-arktx = wa_vbrp0-arktx.
        CLEAR wa_vbrp-netwr.
        wa_vbrp-netwr = wa_coll_mat-netwr.
        wa_vbrp-fkimg = wa_coll_mat-fkimg.
        wa_vbrp-vrkme = wa_coll_mat-vrkme.
        APPEND wa_vbrp TO it_vbrp.
      ENDLOOP.
    ENDIF.
    SORT it_vbrp BY posnr.
  ENDIF.


ENDFORM.                    " fill_lay_invoice_table
*&---------------------------------------------------------------------*
*&      Form  get_data_from_service_order
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*Scenario 1: All flows except XB and X1 with billing form 02
*----------------------------------------------------------------------*
FORM get_data_from_service_order .

  DATA: l_vbeln LIKE vbfa-vbeln,
        l_vbelv TYPE vbelv,
        l_bstnk TYPE bstnk,
        l_qmnum TYPE qmnum,
        l_sernr TYPE gernr,
        l_equnr TYPE equnr,
        l_eqktx TYPE ktx01,
        teller(6) TYPE n,
        wa_afru TYPE afru,
        it_afru TYPE TABLE OF afru,
        it_afru1 TYPE TABLE OF afru,
        it_lips TYPE TABLE OF lips,
        wa_lips TYPE lips,
        l_aso TYPE vbeln.

  TYPES: BEGIN OF t_notif,
    posnr TYPE posnr,
    vbeln TYPE vbeln.
  TYPES: END OF t_notif.
  DATA: it_notif TYPE TABLE OF t_notif.
  DATA: wa_notif TYPE t_notif.

  DATA: BEGIN OF it_seo OCCURS 0,
    aufnr TYPE aufnr,
    vbeln TYPE vbeln,
    END OF it_seo.

  DATA: BEGIN OF it_mseg OCCURS 0,
       matnr TYPE matnr,
       sgtxt TYPE sgtxt,
       menge TYPE menge_d,
       meins TYPE meins,
       bwart TYPE bwart.
  DATA: END OF it_mseg.
  DATA: it_vbfa TYPE STANDARD TABLE OF vbfa WITH HEADER LINE.

  REFRESH it_seo.

  PERFORM get_equipment_data USING l_qmnum l_sernr l_equnr l_eqktx.


  SELECT posnv vbelv  INTO TABLE it_notif FROM vbfa
                   WHERE vbeln =  ls_bil_invoice-hd_gen-bil_number
                     AND vbtyp_v = 'C'.
  IF sy-subrc = 0.
    SELECT aufnr kdauf FROM aufk
      APPENDING TABLE it_seo
      FOR ALL ENTRIES IN it_notif
      WHERE kdauf = it_notif-vbeln.
  ENDIF.

  REFRESH it_mseg.
  LOOP AT it_seo.

    CLEAR wa_notif.
    READ TABLE it_notif INTO wa_notif WITH KEY vbeln = it_seo-vbeln.

    CLEAR wa_vbrp.
    READ TABLE it_vbrp INTO wa_vbrp WITH KEY posnr = wa_notif-posnr.


*first get the components:
*We get confirmed spare parts only from confirmations on line 10.
*Spare parts confirmations on other lines will not be considered.
*new logic: for the spareparts we have to look to the ASSO delivery:

*Get the ASO sales order:
*    CLEAR l_aso.
*    SELECT SINGLE vbeln INTO l_aso FROM vbak
*      WHERE aufnr = it_seo-aufnr.
*
*    CLEAR l_vbeln.
*    SELECT SINGLE vbeln INTO l_vbeln FROM vbfa
*        WHERE vbelv   = l_aso
*          AND vbtyp_n = 'J'.

    REFRESH it_lips.
    SELECT * FROM lips INTO TABLE it_lips
      WHERE aufnr = it_seo-aufnr
* begin of insertion MOD-002
        AND bwart IN ('261' , '262').
    IF NOT it_lips[] IS INITIAL.
* end of insertion MOD-002
      LOOP AT it_lips INTO wa_lips WHERE bwart = '261'
                                      OR bwart = '262'.

*endloop.
*    it_afru1[] = it_afru[].
*    DELETE it_afru1 WHERE NOT vornr = '0010'.
*    IF NOT it_afru1[] IS INITIAL.
*      SELECT matnr sgtxt menge meins bwart
*        FROM mseg INTO TABLE it_mseg
*        FOR ALL ENTRIES IN it_afru1
*        WHERE mblnr = it_afru1-wablnr
*          AND aufnr = it_seo-aufnr   "to avoid problems with mjahr
*          AND bwart IN ('261', '262')
*          AND bemot = '1E'.
*    ENDIF.
*    LOOP AT it_mseg.
*      wa_lay_am_invoice-posnr  = teller.
        wa_lay_am_invoice-posnr  = wa_vbrp-posnr.
        wa_lay_am_invoice-aufnr  = it_seo-aufnr.
        wa_lay_am_invoice-equnr  = l_qmnum.
        wa_lay_am_invoice-eqktx  = l_eqktx.
        wa_lay_am_invoice-sernr  = l_sernr.
        wa_lay_am_invoice-vbeln  = ls_bil_invoice-hd_gen-bil_number.
        wa_lay_am_invoice-matnr  = wa_lips-matnr.
        wa_lay_am_invoice-arktx  = wa_lips-arktx.
        IF wa_lips-bwart = '262'.
          wa_lips-lfimg = wa_lips-lfimg * -1.
        ENDIF.
        wa_lay_am_invoice-kwmeng = wa_lips-lfimg.
        wa_lay_am_invoice-vrkme  = wa_lips-vrkme.

        APPEND wa_lay_am_invoice TO lay_am_invoice.
        CLEAR wa_lay_am_invoice.
      ENDLOOP.
* begin of insertion MOD-002
* no records found in LIPS
    ELSE.
      wa_lay_am_invoice-posnr  = wa_vbrp-posnr.
      wa_lay_am_invoice-aufnr  = it_seo-aufnr.
      wa_lay_am_invoice-equnr  = l_qmnum.
      wa_lay_am_invoice-eqktx  = l_eqktx.
      wa_lay_am_invoice-sernr  = l_sernr.
      wa_lay_am_invoice-vbeln  = ls_bil_invoice-hd_gen-bil_number.

      APPEND wa_lay_am_invoice TO lay_am_invoice.
      CLEAR wa_lay_am_invoice.

    ENDIF.
* end of insertion MOD-002

*get the labour hours:
*******************************************************
    PERFORM sea_get_detail USING it_seo-aufnr.
*    CLEAR wa_operations.
* READ TABLE et_operations INTO wa_operations WITH KEY activity =
*'0010'.
    REFRESH it_afru.
    SELECT * FROM afru INTO TABLE it_afru WHERE aufnr = it_seo-aufnr.
*for the text we need the operation from line 10.
    LOOP AT it_afru INTO wa_afru.
      IF wa_afru-ismnw IS INITIAL.
        CONTINUE.
      ENDIF.
      IF wa_afru-ismne NE 'STD'.
        CONTINUE.
      ENDIF.
      CLEAR wa_operations.
      READ TABLE et_operations INTO wa_operations
        WITH KEY conf_no = wa_afru-rueck.
      wa_lay_am_invoice-posnr = teller.
      wa_lay_am_invoice-aufnr = it_seo-aufnr.
      wa_lay_am_invoice-equnr = l_qmnum.
      wa_lay_am_invoice-eqktx = l_eqktx.
*      wa_lay_am_invoice-sernr = l_sernr.
      wa_lay_am_invoice-vbeln = ls_bil_invoice-hd_gen-bil_number.
      wa_lay_am_invoice-arktx = wa_operations-description.
      wa_lay_am_invoice-kwmeng = wa_afru-ismnw.
      wa_lay_am_invoice-vrkme = wa_afru-ismne.
      APPEND wa_lay_am_invoice TO lay_am_invoice.
      CLEAR wa_lay_am_invoice.
* begin of insertion MOD-006
      CLEAR wa_lay_am_operation.
      wa_lay_am_operation-posnr = teller.
      wa_lay_am_operation-arktx = wa_operations-description.
      wa_lay_am_operation-kwmeng = wa_afru-ismnw.
      wa_lay_am_operation-vrkme = wa_afru-ismne.
      APPEND wa_lay_am_operation TO lay_am_operation.
      CLEAR wa_lay_am_operation.
* end of insertion MOD-006
    ENDLOOP.
    ADD 10 TO teller.
  ENDLOOP.
  PERFORM calculate_price_x7.

  READ TABLE it_seo INDEX 1.
  l_aufnr = it_seo-aufnr.

ENDFORM.                    " get_data_from_service_order
*&---------------------------------------------------------------------*
*&      Form  calculate_price_x7
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM calculate_price_x7 .

  DATA: l_vat TYPE  stceg,
        w_discount TYPE yse_dec4,
        wa_komv TYPE konv,
        l_freight TYPE kwert,
        l_kbetr TYPE kbetr,
        w_tot_line_netwr TYPE netwr.

  CLEAR: w_tot_freight,
         w_tot_discount,
         w_tot_netwr,
         l_freight,
         w_tot_line_netwr.


  LOOP AT it_vbap INTO wa_vbap.
*First calculate the VAT pct
    READ TABLE tkomv WITH KEY kposn = wa_vbap-posnr
    kschl = 'MWST'.
    IF sy-subrc = 0.
      l_vat = tkomv-kbetr / 1000.
    ENDIF.

*take the netwr and add the vat:
    w_tot_line_netwr = wa_vbap-netwr.
    w_tot_line_netwr =
    w_tot_line_netwr + w_tot_line_netwr * l_vat.

*extract the freight from every item and sum it together:
    SELECT SINGLE kwert INTO l_freight FROM konv
    WHERE knumv = wa_vbak-knumv
    AND kposn = wa_vbap-posnr
    AND kschl = 'ZD00'.

    l_freight = l_freight + l_freight * l_vat.
    ADD l_freight TO w_tot_freight.
    w_tot_line_netwr = w_tot_line_netwr - l_freight.

*add also the discount (before taxes)
    CLEAR: w_discount.
    LOOP AT tkomv INTO wa_komv
    WHERE kposn EQ wa_vbap-posnr
      AND kschl IN s_kschl_discounts.
      IF wa_komv-kwert < 0.
        w_discount = w_discount + wa_komv-kwert.
      ELSE.
        w_discount = w_discount - wa_komv-kwert.
      ENDIF.
    ENDLOOP.

    w_discount = w_discount + w_discount * l_vat.
    ADD w_discount TO w_tot_discount.
    w_tot_line_netwr  = w_tot_line_netwr - w_discount.
    ADD w_tot_line_netwr TO w_tot_netwr.

*for the net unit price we devide by the qty: issue 3528
    wa_vbap-netwr = w_tot_line_netwr /
    wa_vbap-kwmeng.
    l_kbetr = w_tot_line_netwr.
  ENDLOOP.

ENDFORM.                    " calculate_price_x7
*&---------------------------------------------------------------------*
*&      Form  get_seo_get_detail
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_IT_SEO_AUFNR  text
*----------------------------------------------------------------------*
FORM get_seo_get_detail  USING    p_it_seo_aufnr.

ENDFORM.                    " get_seo_get_detail
*&---------------------------------------------------------------------*
*&      Form  get_vbap_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_vbap_data .

  DATA: l_tabix TYPE sy-tabix.
  DATA: BEGIN OF it_vbeln OCCURS 0,
     vbeln TYPE vbeln_von.
  DATA: END OF it_vbeln.
  DATA: l_posnn TYPE posnr.

  DATA: l_vbelv TYPE vbeln.
*for ZAM4 we get the main data from the contract
*ELSE
  IF nast-kschl = 'ZAM4'.
*for ZAM4 we get the main data from the contract:  it is possible to
*have more than one contract.

    SELECT vbelv INTO TABLE it_vbeln
    FROM  vbfa
    WHERE  vbeln    = wa_vbrk-vbeln
    AND    vbtyp_v  = 'G'.

*Begin of delete MOD-005.
    DELETE ADJACENT DUPLICATES FROM it_vbeln.
*End of delete MOD-005.
    IF it_vbeln[] IS INITIAL.
      EXIT.
    ENDIF.
    SELECT * FROM vbap INTO TABLE it_vbap
    FOR ALL ENTRIES IN it_vbeln
    WHERE vbeln =  it_vbeln-vbeln.

*for ZAM4, we don't show any zero values; the values are taken from the
*invoice
    LOOP AT it_vbap INTO wa_vbap.
      l_tabix = sy-tabix.
*get the right posnr:
      CLEAR l_posnn.

      SELECT SINGLE posnn INTO l_posnn FROM vbfa
      WHERE vbelv = wa_vbap-vbeln
      AND vbeln = wa_vbrk-vbeln
      AND posnv = wa_vbap-posnr.

      CLEAR wa_vbrp.
      READ TABLE it_vbrp INTO wa_vbrp WITH KEY posnr = l_posnn.
      IF wa_vbrp-netwr IS INITIAL.
        DELETE it_vbap INDEX l_tabix.
      ENDIF.
    ENDLOOP.
  ELSE.
*air22296: 01/08/2007
*make sure to get the sales order
    CLEAR l_vbelv.
    SELECT SINGLE vbelv INTO l_vbelv FROM vbfa
    WHERE vbeln = wa_vbrk-vbeln
    AND vbtyp_v = 'C'.

    SELECT * FROM vbap INTO TABLE it_vbap
    WHERE vbeln = l_vbelv.

  ENDIF.
ENDFORM.                    " get_vbap_data
*&---------------------------------------------------------------------*
*&      Form  get_vbrp_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_vbrp_data .

  REFRESH it_vbrp.
  SELECT * FROM vbrp INTO TABLE it_vbrp WHERE vbeln = wa_vbrk-vbeln.

ENDFORM.                    " get_vbrp_data
*&---------------------------------------------------------------------*
*&      Form  get_data_from_DMR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_data_from_dmr .

  DATA: it_dmr TYPE STANDARD TABLE OF vbap.
  DATA: wa_dmr TYPE vbap.

  DATA: l_vbeln LIKE vbfa-vbeln,
        l_vbelv TYPE vbelv,
        l_bstnk TYPE bstnk,
        l_qmnum TYPE qmnum,
        l_sernr TYPE gernr,
        l_equnr TYPE equnr,
        l_eqktx TYPE ktx01,
        teller(6) TYPE n,
        wa_afru TYPE afru,
        it_afru TYPE TABLE OF afru.

  DATA: BEGIN OF it_seo OCCURS 0,
    aufnr TYPE aufnr,
    END OF it_seo.

  REFRESH it_seo.

  PERFORM get_equipment_data USING l_qmnum l_sernr l_equnr l_eqktx.

*get the service orders: we can have more than one service order:
  CLEAR l_vbeln.
  SELECT SINGLE vbelv INTO l_vbeln FROM vbfa
                   WHERE vbeln =  ls_bil_invoice-hd_gen-bil_number
                     AND vbtyp_v = 'C'.
  IF sy-subrc = 0.
    SELECT aufnr FROM aufk APPENDING TABLE it_seo WHERE kdauf = l_vbeln.
  ENDIF.


*get the DMR:
  CLEAR l_vbelv.
  SELECT SINGLE vbelv INTO l_vbelv FROM vbfa
     WHERE vbeln = wa_vbak-vbeln
       AND vbtyp_v = 'L'.

  REFRESH it_dmr.
  SELECT * FROM vbap INTO TABLE it_dmr WHERE vbeln = l_vbelv.
  teller = 10.

  LOOP AT it_dmr INTO wa_dmr.
    wa_lay_am_invoice-posnr  = teller.
    wa_lay_am_invoice-aufnr  = it_seo-aufnr.
    wa_lay_am_invoice-equnr  = l_qmnum.
    wa_lay_am_invoice-eqktx  = l_eqktx.
    wa_lay_am_invoice-sernr  = l_sernr.
    wa_lay_am_invoice-vbeln  = ls_bil_invoice-hd_gen-bil_number.
    wa_lay_am_invoice-matnr = wa_dmr-matnr.
    wa_lay_am_invoice-arktx = wa_dmr-arktx.
    wa_lay_am_invoice-kwmeng = wa_dmr-zmeng.
    wa_lay_am_invoice-vrkme = wa_dmr-zieme.
    wa_lay_am_invoice-netpr = wa_dmr-netpr.
    wa_lay_am_invoice-netwr = wa_dmr-netpr * wa_dmr-zmeng.
    ADD 10 TO teller.
    APPEND wa_lay_am_invoice TO lay_am_invoice.
    CLEAR wa_lay_am_invoice.
  ENDLOOP.

ENDFORM.                    " get_data_from_DMR
*&---------------------------------------------------------------------*
*&      Form  sea_get_detail
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_IT_SEO_AUFNR  text
*----------------------------------------------------------------------*
FORM sea_get_detail  USING lo_aufnr.

  DATA:
   l_aufnr  TYPE  bapi_alm_order_header_e-orderid,
   et_partner  LIKE  bapi_alm_order_partner OCCURS 0,
   et_relations  LIKE  bapi_alm_order_relation_export OCCURS 0,
   et_texts  LIKE  bapi_alm_text OCCURS 0,
   et_text_lines LIKE  bapi_alm_text_lines OCCURS 0,
   et_prts LIKE  bapi_alm_order_prt_e OCCURS 0,
   et_costs_sum  LIKE  bapi_alm_order_costs_sum_e OCCURS 0,
   et_costs_details  LIKE  bapi_alm_order_costs_detail_e OCCURS 0,
   return  LIKE  bapiret2 OCCURS 0,
   extension_in  LIKE  bapiparex,
   extension_out LIKE  bapiparex.



  CHECK NOT lo_aufnr IS INITIAL.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lo_aufnr
    IMPORTING
      output = lo_aufnr.


  CALL FUNCTION 'BAPI_ALM_ORDER_GET_DETAIL'
    EXPORTING
      number           = lo_aufnr
    TABLES
      et_partner       = et_partner
      et_operations    = et_operations
      et_components    = et_components
      et_relations     = et_relations
      et_texts         = et_texts
      et_text_lines    = et_text_lines
      et_prts          = et_prts
      et_costs_sum     = et_costs_sum
      et_costs_details = et_costs_details
      return           = return.

*  DELETE et_operations WHERE NOT control_key = 'ZCO3'.
*  DELETE et_operations WHERE NOT duration_normal_unit = 'STD'.

ENDFORM.                    " sea_get_detail
*&---------------------------------------------------------------------*
*&      Form  get_equipment_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_equipment_data USING lo_qmnum lo_sernr lo_equnr lo_eqktx.

  DATA: l_vbelv TYPE vbelv.
  DATA: it_vbfa TYPE STANDARD TABLE OF vbfa WITH HEADER LINE.
*we have to make this dynamic: in case of a consolidated invoice we have
* different service orders
*select an earlier document for wich you find a notification.

  CLEAR wa_vbrp.
  READ TABLE it_vbrp INTO wa_vbrp INDEX 1.
  SELECT * INTO TABLE it_vbfa FROM vbfa
  WHERE vbeln EQ wa_vbrp-vbeln
  AND posnn EQ wa_vbrp-posnr
  AND vbtyp_v IN ('A', 'B', 'C', 'K', 'L').

  LOOP AT it_vbfa.
    CLEAR l_vbelv.
    l_vbelv = it_vbfa-vbelv.
    CLEAR lo_qmnum.
    SELECT SINGLE qmnum INTO lo_qmnum FROM vbak WHERE vbeln = l_vbelv.
    IF NOT lo_qmnum IS INITIAL.
      EXIT.
    ENDIF.
  ENDLOOP.

  CLEAR l_aufnr.
  SELECT SINGLE aufnr INTO l_aufnr FROM viqmel
  WHERE qmnum = lo_qmnum.

  CLEAR: lo_sernr, lo_equnr.
  SELECT SINGLE serialnr equnr INTO (lo_sernr, lo_equnr)
  FROM viqmel WHERE qmnum = lo_qmnum.

  CLEAR lo_eqktx.
  SELECT SINGLE eqktx  INTO lo_eqktx
  FROM eqkt WHERE equnr = lo_equnr
  AND spras = nast-spras.

  IF sy-subrc NE 0.
    SELECT SINGLE eqktx  INTO lo_eqktx
    FROM eqkt WHERE equnr = lo_equnr.
  ENDIF.

ENDFORM.                    " get_equipment_data

*Selection text
*XSCREEN:        Output on screen (x=yes)
