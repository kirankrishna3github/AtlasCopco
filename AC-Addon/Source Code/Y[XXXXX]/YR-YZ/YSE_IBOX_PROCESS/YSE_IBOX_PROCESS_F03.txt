*----------------------------------------------------------------------*
***INCLUDE YSE_IBOX_PROCESS_F03.
*----------------------------------------------------------------------*

*eject
*&---------------------------------------------------------------------*
*&      Form  create_material
*&---------------------------------------------------------------------*
*       Create material
*----------------------------------------------------------------------*
form create_material.

  gv_matnr = gt_cre-matnr.
  gv_maktx = gt_cre-maktx.
  gv_lifnr = gt_cre-lifnr.
  gv_vkorg = gt_cre-vkorg.
  gv_famcd = gt_cre-rpccfm.

* Create material
  gv_ersda = gt_cre-ersda.
  gv_meins = gt_cre-meins.
  gv_vrkme = gt_cre-vrkme.
  gv_umren = gt_cre-yumren.
  gv_spart = gt_cre-spart.
  gv_gewei = gt_cre-gewei.
  gv_ntgew = gt_cre-ntgew.
  gv_brgew = gt_cre-brgew.
  gv_groes = gt_cre-groes.
  gv_dwerk = gt_cre-dwerk.
  gv_mtpos = gt_cre-mtpos.
  gv_mvgr4 = gt_cre-mvgr4.
  gv_sernp = gt_cre-sernp.
  gv_prat2 = gt_cre-prat2.
  gv_herkl = gt_cre-herkl.
*  gv_dismm = gt_cre-dismm.
  gv_zlcldescr = gt_cre-zlcldescr.
  gv_zlcllang  = gt_cre-zlcllang.
  gv_kondm = gt_cre-kondm.
  gv_lgrad = gt_cre-lgrad.
  gv_bstme = gt_cre-bstme.
  gv_pumren = gt_cre-ypumren.
  gv_plifz = gt_cre-plifz.
*  gv_mlprice = gt_cre-mlprice.
  gv_mlcurr = gt_cre-mlcurr.
  gv_evers = gt_cre-evers.

  gv_matkl = gt_cre-matkl.
  gv_prdha = gt_cre-prdha.
  gv_mvgr2 = gt_cre-mvgr2.
  gv_stprs = gt_cre-stprs.
  gv_mlprice = gv_stprs * 38 / 10.
  gv_waers = gt_cre-waers.
  gv_netpr = gt_cre-netpr.
  gv_tpcurr = gt_cre-tpcurr.
  gv_rpip   = gt_cre-rpip.
  gv_rpcurr = gt_cre-rpcurr.
  gv_datab = gt_cre-datab.
  gv_datbi = gt_cre-datbi.
  gv_lifnr2 = gt_cre-lifnr2.

  clear gv_errflg.

* Show screen so that user can change some fields
* in order to be able to create the material in background
  export gv_matnr gv_lifnr gv_vkorg gv_maktx gv_famcd
         gv_matkl gv_prdha gv_mvgr2 gv_stprs gv_waers gv_netpr gv_tpcurr
         gv_rpip  gv_rpcurr
         gv_datab gv_datbi gv_lifnr2
         gv_meins gv_vrkme gv_umren gv_spart gv_gewei gv_ntgew gv_brgew gv_groes
         gv_dwerk gv_mtpos gv_mvgr4 gv_sernp gv_prat2 gv_herkl gv_lgrad
         gv_bstme gv_pumren gv_plifz gv_mlprice gv_mlcurr gv_evers
         gv_zlcldescr gv_zlcllang gv_kondm
         g_output
       to memory id 'YSE_IBOX_PROCESS_CRE'.
  "MOD-001 begin
  if sy-ucomm = 'CRE'.
    call transaction 'YSE_IBOX_CRE'.
  elseif sy-ucomm = 'CRES'.
    perform create_massive.
    gv_ucomm = 'EXEC'.
    export gv_ucomm g_output gv_errflg to memory id 'YSE_IBOX_PROCESS_CRE'.
  endif.
  "Mod-001 end
  import gv_ucomm g_output gv_errflg from memory id 'YSE_IBOX_PROCESS_CRE'.
  check gv_ucomm = 'EXEC'.

  if gv_errflg is initial.
*.. Material &1 has been successfully created
    message s370 with gt_cre-matnr into gv_msg.
    perform add_message_to_log.
    if not g_output[] is initial.
      loop at g_output.
        message s147 with g_output-text into gv_msg.
        perform add_message_to_log.
*        EXIT.
      endloop.
    endif.
    gv_ok = gc_charx.
*.. Delete entry from table YSE_IBOX_CREATE
    delete from yse_ibox_create where matnr = gv_matnr
                                  and lifnr = gv_lifnr
                                  and vkorg = gv_vkorg.
  else.
*.. Creation failed for material &1
    message e371 with gt_cre-matnr into gv_msg.
    perform add_message_to_log.
    loop at g_output.
      message e147 with g_output-text into gv_msg.
      perform add_message_to_log.
    endloop.
  endif.

endform.                    " create_material

*eject
*&---------------------------------------------------------------------*
*&      Form  display_log
*&---------------------------------------------------------------------*
*       Display the already generated application log
*----------------------------------------------------------------------*
form display_log .

*.. Local variables
  data: ls_prof type bal_s_prof.

*.. Reset log indicator once displayed
  clear gv_log.

*.. Get a prepared profile
  call function 'BAL_DSP_PROFILE_POPUP_GET'
    importing
      e_s_display_profile = ls_prof
    exceptions
      others              = 1.

  if sy-subrc <> 0.
    message id sy-msgid type sy-msgty number sy-msgno
             with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  endif.

*.. Use grid for display if wanted
  ls_prof-use_grid = gc_charx.
  ls_prof-start_row = 1.
  ls_prof-end_row = 25.
  clear ls_prof-pop_adjst.

*.. When you use also other ALV lists in your report,
*.. please specify a handle to distinguish between the display
*.. variants of these different lists, e.g:
  ls_prof-disvariant-handle = 'LOG'.

*.. Call display function module
  call function 'BAL_DSP_LOG_DISPLAY'
    exporting
      i_s_display_profile = ls_prof
    exceptions
      others              = 1.

  if sy-subrc <> 0.
    message id sy-msgid type sy-msgty number sy-msgno
             with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  endif.

endform.                    " display_log

*&---------------------------------------------------------------------*
*&      Form  delete_lines_c
*&---------------------------------------------------------------------*
*       Delete selected line(s) from table YSE_IBOX_CREATE
*----------------------------------------------------------------------*
*  -->  r_matnr     material number
*  -->  r_lifnr     vendor number
*  -->  r_vkorg     sales organization
*----------------------------------------------------------------------*
form delete_lines_c using r_matnr r_lifnr r_vkorg.

* Delete entry from table YSE_IBOX_CREATE
  delete from yse_ibox_create where matnr = r_matnr
                                and lifnr = r_lifnr
                                and vkorg = r_vkorg.

endform.                    " delete_lines_c

*&---------------------------------------------------------------------*
*&      Form  delete_lines_u
*&---------------------------------------------------------------------*
*       Delete selected line(s) from table YSE_IBOX_ITI_UPD
*----------------------------------------------------------------------*
*  -->  r_matnr     material number
*  -->  r_vkorg     sales organization
*----------------------------------------------------------------------*
form delete_lines_u using r_matnr r_vkorg.

* Delete entry from table YSE_IBOX_ITI_UPD
  delete from yse_ibox_iti_upd where matnr = r_matnr
                                 and vkorg = r_vkorg.

endform.                    " delete_lines_u

*&---------------------------------------------------------------------*
*&      Form  delete_lines_s
*&---------------------------------------------------------------------*
*       Delete selected line(s) from table YSE_IBOX_SUP
*----------------------------------------------------------------------*
*  -->  r_pitmno    parent item number
*  -->  r_vkorg     sales organization
*----------------------------------------------------------------------*
form delete_lines_s using r_pitmno r_vkorg.

* Delete entry from table YSE_IBOX_SUP
  delete from yse_ibox_sup where pitmno = r_pitmno
                             and vkorg  = r_vkorg.

endform.                    " delete_lines_s

*&---------------------------------------------------------------------*
*&      Form  UPDATE_MATERIAL
*&---------------------------------------------------------------------*
*       Update material
*----------------------------------------------------------------------*
form update_material .

  gv_matnr = gt_upd-matnr.
  gv_vkorg = gt_upd-vkorg.
  gv_famcd = gt_upd-rpccfm.

* Update material
  gv_maktx = gt_upd-maktx.
  gv_lifnr = gt_upd-lifnr.
  gv_ersda = gt_upd-ersda.
  gv_meins = gt_upd-meins.
  gv_vrkme = gt_upd-vrkme.
  gv_umren = gt_upd-yumren.
  gv_spart = gt_upd-spart.
  gv_gewei = gt_upd-gewei.
  gv_ntgew = gt_upd-ntgew.
  gv_brgew = gt_upd-brgew.
  gv_groes = gt_upd-groes.
  gv_sernp = gt_upd-sernp.
  gv_herkl = gt_upd-herkl.
  gv_bstme = gt_upd-bstme.
  gv_pumren = gt_upd-ypumren.
  gv_plifz = gt_upd-plifz.
  gv_matkl = gt_upd-matkl.
  gv_prdha = gt_upd-prdha.
  gv_mvgr2 = gt_upd-mvgr2.
*  gv_stprs = gt_upd-stprs.
  gv_waers = gt_upd-waers.
  gv_kbetr  = gt_upd-kbetr.
  gv_lifnr2 = gt_upd-lifnr2.
  gv_vrkmex = gt_upd-zvrkmex.

  clear gv_errflg.

* Show screen so that user can change some fields
* in order to be able to update the material in background
  export gv_matnr gv_lifnr gv_vkorg gv_maktx gv_famcd
*         gv_matkl gv_prdha gv_mvgr2 gv_stprs gv_lifnr2
         gv_matkl gv_prdha gv_mvgr2 gv_waers gv_lifnr2
         gv_kbetr
         gv_meins gv_vrkme gv_umren gv_spart gv_gewei gv_ntgew gv_brgew gv_groes
         gv_sernp gv_herkl gv_bstme gv_pumren gv_plifz
         gv_vrkmex
         g_output gv_first
       to memory id 'YSE_IBOX_PROCESS_UPD'.

  call transaction 'YSE_IBOX_UPD'.

  import gv_ucomm g_output gv_errflg from memory id 'YSE_IBOX_PROCESS_UPD'.
  check gv_ucomm = 'EXEC'.

  if gv_errflg is initial.
*.. Material &1 has been successfully updated
    message s372 with gt_upd-matnr into gv_msg.
    perform add_message_to_log.
    if not g_output[] is initial.
      loop at g_output.
        message s147 with g_output-text into gv_msg.
        perform add_message_to_log.
*        EXIT.
      endloop.
    endif.
    gv_ok = gc_charx.
*.. Delete entry from table YSE_IBOX_ITI_UPD
    delete from yse_ibox_iti_upd where matnr = gv_matnr
                                   and vkorg = gv_vkorg.
  else.
*.. Update failed for material &1
    message e373 with gt_upd-matnr into gv_msg.
    perform add_message_to_log.
    loop at g_output.
      message e147 with g_output-text into gv_msg.
      perform add_message_to_log.
    endloop.
  endif.

endform.                    " UPDATE_MATERIAL

*&---------------------------------------------------------------------*
*&      Form  REPROCESS_SUPER
*&---------------------------------------------------------------------*
*       Reprocess the failed supersessions
*----------------------------------------------------------------------*
form reprocess_super .

  data: wa_segm1 like yse_e1_ibox_sup_in,
        wa_segm2 like yse_e2_ibox_sup_in.

  data: begin of lt_childs occurs 0,
          citmno like yse_e2_ibox_sup_in,
        end of lt_childs.

* Fill fields for Idoc
  wa_segm1-zrpstat = 'R'.
  wa_segm1-rpname  = sy-uname.
  wa_segm1-rpuser  = sy-uname.
  wa_segm1-rpjobn  = 'A'.
  wa_segm1-rpmtyp  = 'RIA'.
  wa_segm1-rpsloc  = gt_sup-rpdcfm.
  wa_segm1-rprloc  = gt_sup-rpdcfm.
  wa_segm1-rpseq   = '0'.
  wa_segm1-rpmsgd  = 'IBO'.
  wa_segm1-rpevnt  = '1'.
  wa_segm1-rpccfm  = gt_sup-rpccfm.
  wa_segm1-rpdcfm  = gt_sup-rpdcfm.
  wa_segm1-pitmno  = gt_sup-pitmno.
  wa_segm1-exhs    = gt_sup-exhs.

  refresh lt_childs.
  split gt_sup-znewmat at ',' into table lt_childs.


* Create Idoc
  clear : i_edidc_control_comm,
          wa_edidc,
          i_edidd_data.

* Find receiving partner
  select single rcvprn into wa_edidc-rcvprn
         from edp13
         where mestyp = c_mestyp.

* Polulate Control Record
  wa_edidc-mestyp = c_mestyp.
  wa_edidc-idoctp = c_idoc_type.
  wa_edidc-rcvprt = c_ls.

* Create Idoc
  clear i_edidd_data[] .
  i_edidd_data-segnam  = c_segm1.
  i_edidd_data-sdata   = wa_segm1.
  append i_edidd_data .

  loop at lt_childs.
    i_edidd_data-segnam  = c_segm2.
    wa_segm2-citmno  = lt_childs-citmno.
    wa_segm2-replqty = '1'.
    i_edidd_data-sdata   = wa_segm2.
    append i_edidd_data .
    clear i_edidd_data .
  endloop.

* Generate Idoc
  call function 'MASTER_IDOC_DISTRIBUTE'
    exporting
      master_idoc_control            = wa_edidc
    tables
      communication_idoc_control     = i_edidc_control_comm
      master_idoc_data               = i_edidd_data
    exceptions
      error_in_idoc_control          = 1
      error_writing_idoc_status      = 2
      error_in_idoc_data             = 3
      sending_logical_system_unknown = 4
      others                         = 5.

  call function 'BAPI_TRANSACTION_COMMIT'
    exporting
      wait = 'X'.

  call function 'EDI_DOCUMENT_DEQUEUE_LATER'
    exporting
      docnum                 = i_edidc_control_comm-docnum
    exceptions
      idoc_is_not_to_dequeue = 1
      others                 = 2.

* Delete entry from table YSE_IBOX_SUP
  delete from yse_ibox_sup where pitmno = gt_sup-pitmno
                             and vkorg  = gt_sup-vkorg.

endform.                    " REPROCESS_SUPER
*&---------------------------------------------------------------------*
*&      Form  create_massive
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form create_massive.
  constants: lc_ct(2)   value 'CT',
             lc_cr(2)   value 'CR'.

  data: ls_index    type lvc_s_row.
  data: lt_index    type lvc_t_row.
  data: ls_rowno    type lvc_s_roid.
  data: lt_rowno    type lvc_t_roid.
  data: ld_lines    like sy-tabix,
        lt_text like popuptext occurs 0 with header line,
        g_ekorg    type ekorg,
        g_bstae    type bstae,
        lv_whtype2 type zwhtype,
        gv_answer  type c.
  data:
      lt_yse_popic_werks like yse_popic_werks occurs 0 with header line,
      ls_yse_popic_werks type yse_popic_werks,
      lt_yse_popic_vkorg like yse_popic_vkorg occurs 0 with header line,
      ls_yse_popic_vkorg type yse_popic_vkorg,
      lt_werks           type werks occurs 0 with header line,
      ls_werks           type werks,
      wa_werks           type werks,
      lt_werks_eord      type werks occurs 0 with header line,
      f_i_eina           like eina,
      g_i_eina           like eina,
      lv_infnr           type infnr,
      lv_lifnr           type lifnr,
      lv_flifn           type flifn,
      lv_matnr           type matnr,
      lv_werks           type werks,
      lv_exec(1)         type c,                "function executed ?
      t_i_eine           like table of eine with header line,
      t_eordu            like eordu occurs 0 with header line,
      t_eord             like eord occurs 0 with header line.

  data: f_o_eina like eina,
        t_o_eine type table of eine with header line.
  data: ls_eine type eine.
  data: ls_o_eine type eine.

* General Data for Material
  data: begin of gt_mara occurs 0.
          include structure mara_ueb.
  data: end   of gt_mara.

* Plant Data for Material
  data: begin of gt_marc occurs 0.
          include structure marc_ueb.
  data: end   of gt_marc.

* Storage Data for Material
  data: begin of gt_mard occurs 0.
          include structure mard_ueb.
  data: end   of gt_mard.

* Forecast view for Material
  data: begin of gt_mpop occurs 0.
          include structure mpop_ueb.
  data: end   of gt_mpop.

* Sales Data for Material
  data: begin of gt_mvke occurs 0.
          include structure mvke_ueb.
  data: end   of gt_mvke.

* Units of Measure for Material
  data: begin of gt_marm occurs 0.
          include structure marm_ueb.
  data: end   of gt_marm.

* Material description
  data: begin of gt_makt occurs 0.
          include structure makt_ueb.
  data: end   of gt_makt.

* Tax info for Material
  data: begin of gt_mlan occurs 0.
          include structure steu_ueb.
  data: end   of gt_mlan.

* Accounting Data for Material
  data: begin of gt_mbew occurs 0.
          include structure mbew_ueb.
  data: end   of gt_mbew.

* Messages
  data: begin of gt_messtab occurs 0.
          include structure merrdat.
  data: end   of gt_messtab.

* Fields to be reset
  data: begin of gt_mfieldres occurs 0.
          include structure mfieldres.
  data: end   of gt_mfieldres.

* Applicable plants
  data: begin of lt_plants occurs 0.
          include structure yse_popic_werks.
  data:   matnr like yse_ibox_create-matnr.
  data: end of lt_plants.

* Applicable sales orgs/distr.channels
  data: begin of lt_slsorg occurs 0.
          include structure yse_popic_vkorg.
  data:   matnr like yse_ibox_create-matnr.
  data: end of lt_slsorg,
        ls_slsorg like line of lt_slsorg.

* Final information to be maintained
  data: begin of wa_maintain.
          include structure yse_popic_mat_maintain.
  data: end of wa_maintain.

  data: lv_zgsber type zgsber,
        ls_return      like bapiret2..
*----------------------------------------------------------------

  perform import_data.
* Preselect plants and sales organisations
  select * from yse_popic_werks
     into table lt_yse_popic_werks.

  select * from yse_popic_vkorg
     into table lt_yse_popic_vkorg.

  refresh: lt_plants,
           lt_slsorg.

  clear gv_errflg.

  if gv_prdha+0(2) = '43'.
    lv_zgsber = lc_cr.
  else.
    lv_zgsber = lc_ct.
  endif.

* Determine all distr.ch. applicable to each line
  loop at lt_yse_popic_vkorg into ls_yse_popic_vkorg
    where zccfam  = gv_famcd
      and zgsber = lv_zgsber.

    move ls_yse_popic_vkorg-zccfam to lt_slsorg-zccfam.
    move ls_yse_popic_vkorg-vkorg  to lt_slsorg-vkorg.
    move ls_yse_popic_vkorg-vtweg  to lt_slsorg-vtweg.
    move gv_matnr to lt_slsorg-matnr.
    append lt_slsorg.
    clear lt_slsorg.
  endloop.

* Determine all plants applicable to each line
  read table lt_slsorg into ls_slsorg index 1.

  loop at lt_yse_popic_werks into ls_yse_popic_werks
    where zccfam = ls_slsorg-zccfam
      and zgsber = 'CT'.

    move ls_yse_popic_werks-werks to lt_plants-werks.
    move gv_matnr to lt_plants-matnr.
    append lt_plants.
    clear lt_plants.
  endloop.

  if lt_plants[] is initial or
     lt_slsorg[] is initial.
*.. Add message to output table
    clear g_output.
    move 'X' to gv_errflg.
    move text-e04 to g_output-text.
    append g_output.
    return.
  endif.

* Maintain material for each selected entry
  sort lt_plants by werks.
  sort lt_slsorg by vkorg vtweg.

  clear: g_cnt_tranc,
         g_cnt_d_ind.

* Check first if basic data already exists or not
  clear: lv_matnr, gv_matnr2.
  select single matnr into gv_matnr2
    from mara where matnr = gv_matnr.

  if not gv_matnr2 is initial.
    clear g_output.
    move text-i02 to g_output-text.
    replace '&' in g_output-text with gv_matnr.
    append g_output.
  endif.

* Prepare plant data for FM
  loop at lt_plants.
    clear wa_maintain.
    move-corresponding lt_plants to wa_maintain.
    move gv_matnr to wa_maintain-matnr.

    perform prepare_plant_data_for_fm tables gt_mara gt_marc
                                       gt_mard
                                       gt_makt gt_mbew
                                       gt_marm
                                       gt_mfieldres
                                       gt_mpop
                                 using wa_maintain.
    if not gv_errflg is initial.
      return.
    endif.
  endloop.

* Prepare sales data for FM
  loop at lt_slsorg.
    clear wa_maintain.
    move-corresponding lt_slsorg to wa_maintain.
    move gv_matnr to wa_maintain-matnr.

    perform prepare_sales_data_for_fm tables gt_mara gt_mvke
                                       gt_marm gt_mlan
                                       gt_mfieldres
                                 using wa_maintain.
  endloop.

  if gt_mara[] is initial.
    gv_errflg = 'X'.
    return.
  endif.

* Maintain material via direct input FM
  perform material_create tables gt_mara gt_marc gt_mard
                                 gt_mpop gt_mvke gt_mbew
                                 gt_makt gt_mlan gt_marm
                                 gt_messtab
                                 gt_mfieldres
                           using gv_matnr
                        changing gv_errflg.

  if not gv_errflg is initial.
    return.
  endif.

  delete adjacent duplicates from lt_slsorg comparing vkorg.

*-----------------------------------------------------------------------
* Create purchase info records **
* for primary vendor

* Check if PIR exists
  clear: f_i_eina,
         f_o_eina.

  select single * into f_o_eina
     from eina
     where matnr = gv_matnr
       and lifnr = gv_lifnr
       and loekz = space.

  if sy-subrc = 0.
    f_i_eina = f_o_eina.
  endif.

  refresh: t_i_eine.

  clear g_ekorg.
  refresh lt_werks.

  select single ekorg into g_ekorg from
         yse_po_sorg_porg where vkorg = gv_vkorg.

  if sy-subrc = 0.
    loop at lt_plants.
*.... PIR¡¯s only need to be created for plants of the type central warehouse
      clear lv_whtype2.
      select single whtype into lv_whtype2
        from yse_em_plant where werks = lt_plants-werks.

      if lv_whtype2 = 'C'.
        lt_werks-werks = lt_plants-werks.
        append lt_werks.
      endif.
    endloop.

    f_i_eina-lifnr = gv_lifnr.
    f_i_eina-matnr = gv_matnr.
*      f_i_eina-wglif = <wa_trans>-saccode.

    if not gv_bstme is initial.
      f_i_eina-meins = gv_bstme.
      f_i_eina-lmein = gv_meins.   " =BUOM
    else.
      f_i_eina-meins = gv_meins.
      f_i_eina-lmein = gv_meins.
    endif.
    if not gv_herkl is initial.
      f_i_eina-urzla = gv_herkl.
    endif.

*    if NOT gv_bstme IS INITIAL AND
*       gv_bstme <> gv_meins.
    if not gv_pumren is initial.
      gv_dec = gv_pumren.
      if gv_dec+5(1) <> 0.
        f_i_eina-umren = gv_pumren * 1000.
        f_i_eina-umrez = 1000.
      else.
        if gv_dec+4(1) <> 0.
          f_i_eina-umren = gv_pumren * 100.
          f_i_eina-umrez = 100.
        else.
          if gv_dec+3(1) <> 0.
            f_i_eina-umren = gv_pumren * 10.
            f_i_eina-umrez = 10.
          else.
            f_i_eina-umren = gv_pumren.
            f_i_eina-umrez = 1.
          endif.
        endif.
      endif.
    else.
      f_i_eina-umrez = 1.
      f_i_eina-umren = 1.
    endif.

    if f_i_eina-infnr is initial.
      f_i_eina-mahn1 = 7.
      f_i_eina-mahn2 = 14.
      f_i_eina-mahn3 = 21.
    endif.

*.. fill fields for EINE
    loop at lt_werks into ls_werks.
      clear t_i_eine.

      select single * into t_i_eine
          from eine
          where infnr = f_i_eina-infnr
            and ekorg = g_ekorg
            and werks = ls_werks-werks.

      select single bstae into g_bstae
        from lfm1 where lifnr = gv_lifnr
                    and ekorg = g_ekorg.

      if t_i_eine-infnr is initial.
        t_i_eine-infnr = f_i_eina-infnr.
        t_i_eine-ekorg = g_ekorg.
        t_i_eine-werks = ls_werks-werks.
        t_i_eine-ekgrp = '001'.
        t_i_eine-norbm = 1.
        t_i_eine-uebto = 0.
        t_i_eine-untto = 99.
        t_i_eine-bstae = g_bstae.
      endif.

      if not gv_evers is initial.
        t_i_eine-evers = gv_evers.
      endif.

      if not gv_plifz is initial.
        t_i_eine-aplfz = gv_plifz.
      endif.
      t_i_eine-waers = gv_tpcurr.
      t_i_eine-netpr = gv_netpr.
      t_i_eine-erdat = gv_datab.
      append t_i_eine.
    endloop.
  endif.

  call function 'ME_INITIALIZE_INFORECORD'.

  loop at t_i_eine into ls_eine.
    g_i_eina = f_i_eina.
    clear g_i_eina-infnr.

    if not ls_eine-infnr is initial.           "update
      clear ls_o_eine.
      select single * into ls_o_eine
          from eine where infnr = ls_eine-infnr
                      and ekorg = ls_eine-ekorg
                      and werks = ls_eine-werks.

      call function 'ME_DIRECT_INPUT_INFORECORD'
         exporting
*            activity         = 'V'
            i_eina           = f_i_eina
            i_eine           = ls_eine
            o_eina           = f_o_eina
            o_eine           = ls_o_eine
            i_no_suppose     = 'X'
            i_vorga          = 'A'
*         TABLES
*            t_head           = t_head
*            t_line           = t_line
         exceptions
            textname_invalid = 1
            error_message    = 2
            others           = 3.
    else.                                       "create
      call function 'ME_DIRECT_INPUT_INFORECORD'
         exporting
            activity         = 'H'
            i_eina           = g_i_eina
            i_eine           = ls_eine
*            o_eina           = f_o_eina
*            o_eine           = t_o_eine
            i_no_suppose     = 'X'
            i_vorga          = 'A'
*         TABLES
*            t_head           = t_head
*            t_line           = t_line
         exceptions
            textname_invalid = 1
            error_message    = 2
            others           = 3.
    endif.

    if sy-subrc <> 0.
      if sy-msgty eq 'E' or sy-msgty eq 'A'.
        move 'X' to gv_errflg.
        rollback work.
        clear g_output.
        move gv_matnr to g_output-matnr.

        refresh gt_messtab.
        clear gt_messtab.

        move-corresponding syst to gt_messtab.

        append gt_messtab.
        perform prepare_message_text using    gt_messtab
                                     changing g_output-text.
        append g_output.
        exit.
      endif.
    endif.
  endloop.

  if not gv_errflg is initial.
    return.
  else.
    clear g_output.
    move text-s04      to g_output-text.
    replace '&1' in g_output-text with gv_matnr.
    replace '&2' in g_output-text with gv_lifnr.
    append g_output.
    call function 'ME_POST_INFORECORD'.
    commit work and wait.
  endif.

*----------------------------------------------------------------
* for evt. alternative vendor
  if not gv_lifnr2 is initial.

* Check if PIR exists
    clear: f_i_eina,
           f_o_eina.

    select single * into f_o_eina
       from eina
       where matnr = gv_matnr
         and lifnr = gv_lifnr2
         and loekz = space.

    if sy-subrc = 0.
      f_i_eina = f_o_eina.
    endif.

    f_i_eina-lifnr = gv_lifnr2.
    f_i_eina-matnr = gv_matnr.

    if not gv_bstme is initial.
      f_i_eina-meins = gv_bstme.
      f_i_eina-lmein = gv_meins.   " =BUOM
    else.
      f_i_eina-meins = gv_meins.
      f_i_eina-lmein = gv_meins.
    endif.
    if not gv_herkl is initial.
      f_i_eina-urzla = gv_herkl.
    endif.

    if not gv_pumren is initial.
      gv_dec = gv_pumren.
      if gv_dec+5(1) <> 0.
        f_i_eina-umren = gv_pumren * 1000.
        f_i_eina-umrez = 1000.
      else.
        if gv_dec+4(1) <> 0.
          f_i_eina-umren = gv_pumren * 100.
          f_i_eina-umrez = 100.
        else.
          if gv_dec+3(1) <> 0.
            f_i_eina-umren = gv_pumren * 10.
            f_i_eina-umrez = 10.
          else.
            f_i_eina-umren = gv_pumren.
            f_i_eina-umrez = 1.
          endif.
        endif.
      endif.
    else.
      f_i_eina-umrez = 1.
      f_i_eina-umren = 1.
    endif.

    if f_i_eina-infnr is initial.
      f_i_eina-mahn1 = 7.
      f_i_eina-mahn2 = 14.
      f_i_eina-mahn3 = 21.
    endif.

    call function 'ME_INITIALIZE_INFORECORD'.

    g_i_eina = f_i_eina.
    clear g_i_eina-infnr.

    if not f_i_eina-infnr is initial.           "update
      call function 'ME_DIRECT_INPUT_INFORECORD'
         exporting
*            activity         = 'V'
            i_eina           = f_i_eina
*            i_eine           = ls_eine
            o_eina           = f_o_eina
*            o_eine           = ls_o_eine
            i_no_suppose     = 'X'
            i_vorga          = 'A'
*         TABLES
*            t_head           = t_head
*            t_line           = t_line
         exceptions
            textname_invalid = 1
            error_message    = 2
            others           = 3.
    else.                                       "create
      call function 'ME_DIRECT_INPUT_INFORECORD'
           exporting
              activity         = 'H'
              i_eina           = g_i_eina
*            i_eine           = ls_eine
*            o_eina           = f_o_eina
*            o_eine           = t_o_eine
              i_no_suppose     = 'X'
              i_vorga          = 'A'
*         TABLES
*            t_head           = t_head
*            t_line           = t_line
           exceptions
              textname_invalid = 1
              error_message    = 2
              others           = 3.
    endif.

    if sy-subrc <> 0.
      if sy-msgty eq 'E' or sy-msgty eq 'A'.
        move 'X' to gv_errflg.
        rollback work.
        clear g_output.
        move gv_matnr to g_output-matnr.

        refresh gt_messtab.
        clear gt_messtab.

        move-corresponding syst to gt_messtab.

        append gt_messtab.
        perform prepare_message_text using    gt_messtab
                                     changing g_output-text.
        append g_output.
        exit.
      endif.
    endif.

    if not gv_errflg is initial.
      return.
    else.
      clear g_output.
      move text-s04      to g_output-text.
      replace '&1' in g_output-text with gv_matnr.
      replace '&2' in g_output-text with gv_lifnr2.
      append g_output.
      call function 'ME_POST_INFORECORD'.
      commit work and wait.
    endif.
  endif.

*-------------------------------------------------------------------
* Create source list records **

  refresh lt_werks_eord.
  clear lv_exec.

  call function 'ME_INITIALIZE_SOURCE_LIST'.

  clear g_ekorg.
  select single ekorg into g_ekorg from
         yse_po_sorg_porg where vkorg = gv_vkorg.

  if sy-subrc = 0.
    refresh lt_werks.

    loop at lt_plants.
*.... Source lists only need to be created for plants of the type central warehouse
      clear lv_whtype2.
      select single whtype into lv_whtype2
        from yse_em_plant where werks = lt_plants-werks.

      if lv_whtype2 = 'C'.
        lt_werks-werks = lt_plants-werks.
        append lt_werks.
      endif.
    endloop.

    loop at lt_werks into ls_werks.
*.... put plants in second table to check later on
*.... so doubles can be excluded
      read table lt_werks_eord
               with key werks = ls_werks-werks.

      if sy-subrc <> 0.
        move ls_werks-werks to lt_werks_eord.
        append lt_werks_eord.
      else.
        continue.
      endif.

      clear: t_eord.
      refresh t_eord.

*.... Check if source list already exists
      select single * into t_eord
         from eord where matnr = gv_matnr
                     and werks = ls_werks-werks.

      if sy-subrc <> 0.
        t_eord-werks = ls_werks-werks.
        t_eord-matnr = gv_matnr.
        t_eord-vdatu = sy-datum.
        t_eord-bdatu = '99991231'.
        t_eord-autet = 1.
        t_eord-ekorg = g_ekorg.

        t_eord-lifnr = gv_lifnr.

*        t_eord-meins = gv_bstme.
**...... get buom from inforecord, this one must exist
*        SELECT SINGLE meins INTO t_eord-meins
*           FROM eina
*           WHERE matnr = gv_matnr
*             AND lifnr = t_eord-lifnr.

        t_eord-flifn = 'X'.
        append t_eord.

        clear: t_eord.

        if not gv_lifnr2 is initial.
          t_eord-werks = ls_werks-werks.
          t_eord-matnr = gv_matnr.
          t_eord-vdatu = sy-datum.
          t_eord-bdatu = '99991231'.
          t_eord-ekorg = g_ekorg.

          t_eord-lifnr = gv_lifnr2.
*          t_eord-meins = gv_bstme.
          append t_eord.
        endif.

        clear t_eordu.
        refresh t_eordu.

        loop at t_eord.
          t_eordu = t_eord.
          t_eordu-kz = 'I'.
          append t_eordu.
        endloop.
        sort t_eordu by zeord.

        lv_exec = 'X'.

        call function 'ME_DIRECT_INPUT_SOURCE_LIST'
          exporting
            i_matnr          = gv_matnr
            i_werks          = t_eordu-werks
            i_vorga          = 'A'
*              I_LOGSY          =
          tables
            t_eord           = t_eordu
          exceptions
            plant_missing    = 1
            material_missing = 2
            error_message    = 4
            others           = 3.

        if sy-subrc <> 0.
          if sy-msgty eq 'E' or sy-msgty eq 'A'.
            rollback work.
            gv_errflg = 'X'.
            clear g_output.
            move gv_matnr to g_output-matnr.

            refresh gt_messtab.
            clear gt_messtab.

            move-corresponding syst to gt_messtab.

            append gt_messtab.
            perform prepare_message_text using    gt_messtab
                                         changing g_output-text.
            append g_output.
            exit.
          endif.
        endif.
      endif.
    endloop.

    if not gv_errflg is initial.
      exit.
    endif.
  endif.

  if not gv_errflg is initial.
    return.
  else.
    if lv_exec = 'X'.
      clear g_output.
      move text-s05 to g_output-text.
      replace '&1' in g_output-text with gv_matnr.
      append g_output.
      call function 'ME_POST_SOURCE_LIST_NEW'.
      commit work.
    else.
      clear g_output.
      move text-s07 to g_output-text.
      replace '&1' in g_output-text with gv_matnr.
      append g_output.
    endif.
  endif.

*----------------------------------------------------------------------
*.. Create ZPRO condition **

  clear: gt_bapicondct,
         gt_bapicondhd,
         gt_bapicondit,
         gt_bapiknumhs,
         gt_mem_initial,
         gt_return.

  refresh: gt_bapicondct,
           gt_bapicondhd,
           gt_bapicondit,
           gt_bapiknumhs,
           gt_mem_initial,
           gt_return.

  if not gv_mlprice is initial.
*.. get existing A954 records for later update
    refresh : gt_a954o.
    select * into corresponding fields of gt_a954o
        from a954 where kappl = 'V'
                    and kschl = 'ZPRO'
                    and vkorg = gv_vkorg
                    and spart = gv_spart
                    and matnr = gv_matnr.
      append gt_a954o.
      clear gt_a954o.
    endselect.

    gt_bapicondct-operation      = '009'.
    gt_bapicondct-cond_usage     = 'A'.
    gt_bapicondct-table_no       = '954'.
    gt_bapicondct-applicatio     = 'V'.
    gt_bapicondct-cond_type      = 'ZPRO'.
    concatenate gv_vkorg gv_spart gv_matnr
             into gt_bapicondct-varkey.
    gt_bapicondct-valid_to      = '99991231'.
    gt_bapicondct-valid_from    = sy-datum.
    gt_bapicondct-cond_no       = '$000000001'.
    append gt_bapicondct.

    move-corresponding gt_bapicondct to gt_bapicondhd.
    gt_bapicondhd-created_by = sy-uname.
    gt_bapicondhd-creat_date = sy-datum.
    append gt_bapicondhd.

    move-corresponding gt_bapicondct to gt_bapicondit.
    gt_bapicondit-cond_value = gv_mlprice.
    gt_bapicondit-condcurr   = gv_mlcurr.
    gt_bapicondit-cond_count = '01'.
    gt_bapicondit-scaletype  = 'A'.
    gt_bapicondit-calctypcon = 'C'.
    gt_bapicondit-cond_p_unt = '1'.

    if not gv_meins is initial.
      gt_bapicondit-cond_unit  = gv_meins.
    else.
      gt_bapicondit-cond_unit  = 'ST'.
    endif.
    gt_bapicondit-condcurren = gv_mlcurr.
    gt_bapicondit-conditidx = 1.
    append gt_bapicondit.

    call function 'BAPI_PRICES_CONDITIONS'
      exporting
        pi_initialmode = ' '
*        pi_blocknumber = pi_blocknumber
      tables
        ti_bapicondct  = gt_bapicondct
        ti_bapicondhd  = gt_bapicondhd
        ti_bapicondit  = gt_bapicondit
        ti_bapicondqs  = gt_bapicondqs
        ti_bapicondvs  = gt_bapicondvs
        to_bapiret2    = gt_return
        to_bapiknumhs  = gt_bapiknumhs
        to_mem_initial = gt_mem_initial
      exceptions
        others         = 1.

    if sy-subrc <> 0.
      if sy-msgty eq 'E' or sy-msgty eq 'A'.
        rollback work.
        gv_errflg = 'X'.
        clear g_output.
        move gt_mara-matnr to g_output-matnr.

        refresh gt_messtab.
        clear gt_messtab.

        move-corresponding syst to gt_messtab.

        append gt_messtab.
        perform prepare_message_text using    gt_messtab
                                     changing g_output-text.
        append g_output.
        exit.
      endif.
    else.
      if not gt_return[] is initial.
        loop at gt_return into ls_return.
          if ls_return-type eq 'E' or ls_return-type eq 'A'.
            move 'X' to gv_errflg.
            rollback work.
            clear g_output.
            move gv_matnr to g_output-matnr.

            perform prepare_message_text2 using    ls_return
                                          changing g_output-text.
            append g_output.
            exit.
          endif.
        endloop.
      else.
        call function 'BAPI_TRANSACTION_COMMIT'.
      endif.
    endif.

    if gv_errflg is initial.
*.... update table A954
      perform correct_a954.
      clear g_output.
      move text-s06 to g_output-text.
      replace '&1' in g_output-text with gv_matnr.
      append g_output.
    endif.
  endif. "mlprice filled in

*----------------------------------------------------------------------
* Create YIP0 condition **

  clear: gt_bapicondct,
         gt_bapicondhd,
         gt_bapicondit,
         gt_bapiknumhs,
         gt_mem_initial,
         gt_return.

  refresh: gt_bapicondct,
           gt_bapicondhd,
           gt_bapicondit,
           gt_bapiknumhs,
           gt_mem_initial,
           gt_return.

* get existing A969 records for later update
  refresh : gt_a969o.
  select * into corresponding fields of gt_a969o
      from a969 where kappl = 'V'
                  and kschl = 'YIP0'
                  and matnr = gv_matnr.
    append gt_a969o.
    clear gt_a969o.
  endselect.

  gt_bapicondct-operation      = '009'.
  gt_bapicondct-cond_usage     = 'A'.
  gt_bapicondct-table_no       = '969'.
  gt_bapicondct-applicatio     = 'V'.
  gt_bapicondct-cond_type      = 'YIP0'.
  gt_bapicondct-varkey        = gv_matnr.
  gt_bapicondct-valid_to      = '99991231'.
  gt_bapicondct-valid_from    = sy-datum.
  gt_bapicondct-cond_no       = '$000000001'.
  append gt_bapicondct.

  move-corresponding gt_bapicondct to gt_bapicondhd.
  gt_bapicondhd-created_by = sy-uname.
  gt_bapicondhd-creat_date = sy-datum.
  append gt_bapicondhd.

  move-corresponding gt_bapicondct to gt_bapicondit.
  gt_bapicondit-cond_value = gv_rpip.
  gt_bapicondit-condcurr   = gv_rpcurr.
  gt_bapicondit-cond_count = '01'.
  gt_bapicondit-scaletype  = 'A'.
  gt_bapicondit-calctypcon = 'C'.
  gt_bapicondit-cond_p_unt = '1'.

  if not gv_meins is initial.
    gt_bapicondit-cond_unit  = gv_meins.
  else.
    gt_bapicondit-cond_unit  = 'ST'.
  endif.
  gt_bapicondit-condcurren = gv_rpcurr.
  gt_bapicondit-conditidx = 1.
  append gt_bapicondit.

  call function 'BAPI_PRICES_CONDITIONS'
    exporting
      pi_initialmode = ' '
*      pi_blocknumber = pi_blocknumber
    tables
      ti_bapicondct  = gt_bapicondct
      ti_bapicondhd  = gt_bapicondhd
      ti_bapicondit  = gt_bapicondit
      ti_bapicondqs  = gt_bapicondqs
      ti_bapicondvs  = gt_bapicondvs
      to_bapiret2    = gt_return
      to_bapiknumhs  = gt_bapiknumhs
      to_mem_initial = gt_mem_initial
    exceptions
      others         = 1.

  if sy-subrc <> 0.
    if sy-msgty eq 'E' or sy-msgty eq 'A'.
      rollback work.
      gv_errflg = 'X'.
      clear g_output.
      move gt_mara-matnr to g_output-matnr.

      refresh gt_messtab.
      clear gt_messtab.

      move-corresponding syst to gt_messtab.

      append gt_messtab.
      perform prepare_message_text using    gt_messtab
                                   changing g_output-text.
      append g_output.
      exit.
    endif.
  else.
    if not gt_return[] is initial.
      loop at gt_return into ls_return.
        if ls_return-type eq 'E' or ls_return-type eq 'A'.
          move 'X' to gv_errflg.
          rollback work.
          clear g_output.
          move gv_matnr to g_output-matnr.

          perform prepare_message_text2 using    ls_return
                                        changing g_output-text.
          append g_output.
          exit.
        endif.
      endloop.
    else.
      call function 'BAPI_TRANSACTION_COMMIT'.
    endif.
  endif.

  if gv_errflg is initial.
*.. update table A969
    perform correct_a969.
    clear g_output.
    move text-s08 to g_output-text.
    replace '&1' in g_output-text with gv_matnr.
    append g_output.
  endif.
endform.                    "create_massive
*&---------------------------------------------------------------------*
*&      Form  prepare_message_text
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_MESSTAB  text
*      -->R_TEXT     text
*----------------------------------------------------------------------*
form prepare_message_text using    p_messtab like merrdat
                          changing r_text.

  data: g_msg_no    type msgnr,
        lv_tabname  type tabname,
        lv_rollname type rollname,
        lv_offset(2) type n,
        lv_ddtext   type as4text.

  clear r_text.
  g_msg_no = p_messtab-msgno.       "Type conflict!
  call function 'MESSAGE_PREPARE'
    exporting
      language               = sy-langu
      msg_id                 = p_messtab-msgid
      msg_no                 = g_msg_no
      msg_var1               = p_messtab-msgv1
      msg_var2               = p_messtab-msgv2
      msg_var3               = p_messtab-msgv3
      msg_var4               = p_messtab-msgv4
    importing
      msg_text               = r_text
    exceptions
      function_not_completed = 1
      message_not_found      = 2
      others                 = 3.

  if sy-subrc ne 0.
    concatenate p_messtab-msgty p_messtab-msgid p_messtab-msgno
                into r_text separated by space.
  else.
    write r_text to r_text.
  endif.

* Make message understandable for the endusers (no field names)
  if r_text cs 'MARA' or
     r_text cs 'MARC' or
     r_text cs 'MBEW' or
     r_text cs 'MVKE' or
     r_text cs 'MAKT' or
     r_text cs 'MLAN'.

    search r_text for 'MARA'.
    if sy-subrc = 0.
      lv_tabname = 'MARA'.
    else.
      search r_text for 'MARC'.
      if sy-subrc = 0.
        lv_tabname = 'MARC'.
      else.
        search r_text for 'MBEW'.
        if sy-subrc = 0.
          lv_tabname = 'MBEW'.
        else.
          search r_text for 'MVKE'.
          if sy-subrc = 0.
            lv_tabname = 'MVKE'.
          else.
            search r_text for 'MAKT'.
            if sy-subrc = 0.
              lv_tabname = 'MAKT'.
            else.
              search r_text for 'MLAN'.
              if sy-subrc = 0.
                lv_tabname = 'MLAN'.
              endif.
            endif.
          endif.
        endif.
      endif.
    endif.

    lv_offset = sy-fdpos + 5.

    select single rollname into lv_rollname
        from dd03l where tabname   = lv_tabname
                     and fieldname = r_text+lv_offset(5).

    if sy-subrc = 0.
      select single ddtext into lv_ddtext
          from dd04t where rollname   = lv_rollname
                       and ddlanguage = sy-langu.

      if sy-subrc = 0.
        replace section offset sy-fdpos length 10
              of r_text with lv_ddtext.
      endif.
    endif.
  endif.

endform.                    "prepare_message_text
*&---------------------------------------------------------------------*
*&      Form  prepare_message_text2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_RETURN   text
*      -->R_TEXT     text
*----------------------------------------------------------------------*
form prepare_message_text2 using    p_return type bapiret2
                           changing r_text.

  data: g_msg_no    type msgnr,
        lv_tabname  type tabname,
        lv_rollname type rollname,
        lv_ddtext   type as4text.

  clear r_text.
  g_msg_no = p_return-number.      "Type conflict!
  call function 'MESSAGE_PREPARE'
    exporting
      language               = sy-langu
      msg_id                 = p_return-id
      msg_no                 = g_msg_no
      msg_var1               = p_return-message_v1
      msg_var2               = p_return-message_v2
      msg_var3               = p_return-message_v3
      msg_var4               = p_return-message_v4
    importing
      msg_text               = r_text
    exceptions
      function_not_completed = 1
      message_not_found      = 2
      others                 = 3.

  if sy-subrc ne 0.
    concatenate p_return-type p_return-id p_return-number
                into r_text separated by space.
  else.
    write r_text to r_text.
  endif.

endform.                    "prepare_message_text2
*&---------------------------------------------------------------------*
*&      Form  material_create
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->GT_MARA       text
*      -->GT_MARC       text
*      -->GT_MARD       text
*      -->GT_MPOP       text
*      -->GT_MVKE       text
*      -->GT_MBEW       text
*      -->GT_MAKT       text
*      -->GT_MLAN       text
*      -->GT_MARM       text
*      -->GT_MESSTAB    text
*      -->GT_MFIELDRES  text
*      -->P_MATNR       text
*      -->P_ERRFLG      text
*----------------------------------------------------------------------*
form material_create tables gt_mara structure mara_ueb
                            gt_marc structure marc_ueb
                            gt_mard structure mard_ueb
                            gt_mpop structure mpop_ueb
                            gt_mvke structure mvke_ueb
                            gt_mbew structure mbew_ueb
                            gt_makt structure makt_ueb
                            gt_mlan structure steu_ueb
                            gt_marm structure marm_ueb
                            gt_messtab structure merrdat
                            gt_mfieldres structure mfieldres
                      using p_matnr
                   changing p_errflg.

  data: g_errors  type bierrnum.

  clear p_errflg.

  call function 'MATERIAL_MAINTAIN_DARK'
    exporting
      p_kz_no_warn              = 'N'
      kz_prf                    = 'W'
    importing
      number_errors_transaction = g_errors
    tables
      amara_ueb                 = gt_mara
      amakt_ueb                 = gt_makt
      amarc_ueb                 = gt_marc
      amard_ueb                 = gt_mard
      amarm_ueb                 = gt_marm
      ampop_ueb                 = gt_mpop
      amvke_ueb                 = gt_mvke
      ambew_ueb                 = gt_mbew
      asteu_ueb                 = gt_mlan
      amerrdat                  = gt_messtab
      amfieldres                = gt_mfieldres
    exceptions
      kstatus_empty             = 1
      tkstatus_empty            = 2
      t130m_error               = 3
      internal_error            = 4
      too_many_errors           = 5
      update_error              = 6
      others                    = 7.

  if sy-subrc <> 0.
    rollback work.
*.. Add message to output table
    clear g_output.
    move 'X' to p_errflg.
    move p_matnr to g_output-matnr.
    move text-e05 to g_output-text.
    append g_output.
  else.
*.. Check return parameters, Populate message output table
    if g_errors ne 0.
      loop at gt_messtab.
        if gt_messtab-msgty eq 'E' or gt_messtab-msgty eq 'A'.
          move 'X' to p_errflg.
          rollback work.
          clear g_output.
          move p_matnr to g_output-matnr.

          perform prepare_message_text using    gt_messtab
                                       changing g_output-text.
          append g_output.
        endif.
      endloop.
    else.
      clear g_output.
      move text-s03 to g_output-text.
      replace '&1' in g_output-text with p_matnr.
      append g_output.
      commit work and wait.
    endif .
  endif .

* Refresh interface tables
  clear: gt_mara, gt_marc, gt_mpop, gt_marm, gt_mard,
         gt_messtab, g_errors, gt_mvke, gt_mbew, gt_mfieldres,
         gt_makt, gt_mlan.

  refresh: gt_mara, gt_marc, gt_mpop, gt_marm, gt_mard,
           gt_messtab, gt_mvke, gt_mbew, gt_mfieldres,
           gt_makt, gt_mlan.

endform.                    "material_create
*&---------------------------------------------------------------------*
*&      Form  correct_a969
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form correct_a969.
  data: lv_ind type sy-tabix,
        lv_newend type sy-datum,
        ls_a969 type a969.

  if not gt_a969o[] is initial.

    read table gt_a969o index 1.
    if sy-subrc = 0.
*.... get current corresponding A969-records
      refresh : gt_a969n.
      select * into corresponding fields of gt_a969n
          from a969 where kappl = gt_a969o-kappl
                      and kschl = gt_a969o-kschl
                      and matnr = gt_a969o-matnr.
        append gt_a969n.
        clear gt_a969n.
      endselect.
    endif.

*.. compare gt_a969o and gt_a969n
    describe table gt_a969o lines g_lineso.
    describe table gt_a969n lines g_linesn.

    sort gt_a969o by kappl kschl matnr datbi.
    sort gt_a969n by kappl kschl matnr datbi.

    if g_lineso = g_linesn.

      loop at gt_a969o.
        lv_ind = sy-tabix.
        read table gt_a969n index lv_ind.
        if sy-subrc = 0.
          if gt_a969o-datab < gt_a969n-datab and
             gt_a969o-datbi = gt_a969n-datbi.
            clear ls_a969.
            lv_newend = gt_a969n-datab - 1.
            ls_a969-kappl = gt_a969n-kappl.
            ls_a969-kschl = gt_a969n-kschl.
            ls_a969-matnr = gt_a969n-matnr.
            ls_a969-datab = gt_a969o-datab.
            ls_a969-datbi = lv_newend.
            ls_a969-knumh = gt_a969o-knumh.
            insert into a969 values ls_a969.
            exit.
          endif.
          if gt_a969o-datab < gt_a969n-datab and
             gt_a969o-datbi < gt_a969n-datbi.
            lv_newend = gt_a969n-datab - 1.
            select single * into corresponding fields of ls_a969
                from a969 where kappl = gt_a969o-kappl
                            and kschl = gt_a969o-kschl
                            and matnr = gt_a969o-matnr
                            and datbi = gt_a969o-datbi.
            if sy-subrc = 0.
              ls_a969-datab = lv_newend.
              modify a969 from ls_a969.
              exit.
            endif.
          endif.
        endif.
      endloop.

    endif.

    if g_linesn > g_lineso.
      read table gt_a969n index g_linesn.
      read table gt_a969o index g_lineso.
      if gt_a969n-datab < gt_a969o-datbi.
*...... insert new record
        clear ls_a969.
        lv_newend = gt_a969n-datab - 1.
        ls_a969-kappl = gt_a969n-kappl.
        ls_a969-kschl = gt_a969n-kschl.
        ls_a969-matnr = gt_a969n-matnr.
        ls_a969-datab = gt_a969o-datab.
        ls_a969-datbi = lv_newend.
        ls_a969-knumh = gt_a969o-knumh.
        insert into a969 values ls_a969.
*...... delete old record
        clear ls_a969.
        ls_a969-kappl = gt_a969o-kappl.
        ls_a969-kschl = gt_a969o-kschl.
        ls_a969-matnr = gt_a969o-matnr.
        ls_a969-datab = gt_a969o-datab.
        ls_a969-datbi = gt_a969o-datbi.
        ls_a969-knumh = gt_a969o-knumh.
        delete a969 from ls_a969.
      endif.
    endif.

  endif.

endform.                    "correct_a969
*&---------------------------------------------------------------------*
*&      Form  correct_a954
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form correct_a954.
  data: lv_ind type sy-tabix,
        lv_newend type sy-datum,
        ls_a954 type a954.

  if not gt_a954o[] is initial.

    read table gt_a954o index 1.
    if sy-subrc = 0.
* get current corresponding A954-records
      refresh : gt_a954n.
      select * into corresponding fields of gt_a954n
          from a954 where kappl = gt_a954o-kappl
                      and kschl = gt_a954o-kschl
                      and vkorg = gt_a954o-vkorg
                      and spart = gt_a954o-spart
                      and matnr = gt_a954o-matnr.
        append gt_a954n.
        clear gt_a954n.
      endselect.
    endif.

* compare gt_a954o and gt_a954n

    describe table gt_a954o lines g_lineso.
    describe table gt_a954n lines g_linesn.

    sort gt_a954o by kappl kschl vkorg spart matnr datbi.
    sort gt_a954n by kappl kschl vkorg spart matnr datbi.

    if g_lineso = g_linesn.

      loop at gt_a954o.
        lv_ind = sy-tabix.
        read table gt_a954n index lv_ind.
        if sy-subrc = 0.
          if gt_a954o-datab < gt_a954n-datab and
             gt_a954o-datbi = gt_a954n-datbi.
            clear ls_a954.
            lv_newend = gt_a954n-datab - 1.
            ls_a954-kappl = gt_a954n-kappl.
            ls_a954-kschl = gt_a954n-kschl.
            ls_a954-vkorg = gt_a954n-vkorg.
            ls_a954-spart = gt_a954n-spart.
            ls_a954-matnr = gt_a954n-matnr.
            ls_a954-datab = gt_a954o-datab.
            ls_a954-datbi = lv_newend.
            ls_a954-knumh = gt_a954o-knumh.
            insert into a954 values ls_a954.
            exit.
          endif.
          if gt_a954o-datab < gt_a954n-datab and
             gt_a954o-datbi < gt_a954n-datbi.
            lv_newend = gt_a954n-datab - 1.
            select single * into corresponding fields of ls_a954
                from a954 where kappl = gt_a954o-kappl
                            and kschl = gt_a954o-kschl
                            and vkorg = gt_a954o-vkorg
                            and spart = gt_a954o-spart
                            and matnr = gt_a954o-matnr
                            and datbi = gt_a954o-datbi.
            if sy-subrc = 0.
              ls_a954-datab = lv_newend.
              modify a954 from ls_a954.
              exit.
            endif.
          endif.
        endif.
      endloop.

    endif.

    if g_linesn > g_lineso.
      read table gt_a954n index g_linesn.
      read table gt_a954o index g_lineso.
      if gt_a954n-datab < gt_a954o-datbi.
* insert new record
        clear ls_a954.
        lv_newend = gt_a954n-datab - 1.
        ls_a954-kappl = gt_a954n-kappl.
        ls_a954-kschl = gt_a954n-kschl.
        ls_a954-vkorg = gt_a954n-vkorg.
        ls_a954-spart = gt_a954n-spart.
        ls_a954-matnr = gt_a954n-matnr.
        ls_a954-datab = gt_a954o-datab.
        ls_a954-datbi = lv_newend.
        ls_a954-knumh = gt_a954o-knumh.
        insert into a954 values ls_a954.
* delete old record
        clear ls_a954.
        ls_a954-kappl = gt_a954o-kappl.
        ls_a954-kschl = gt_a954o-kschl.
        ls_a954-vkorg = gt_a954o-vkorg.
        ls_a954-spart = gt_a954o-spart.
        ls_a954-matnr = gt_a954o-matnr.
        ls_a954-datab = gt_a954o-datab.
        ls_a954-datbi = gt_a954o-datbi.
        ls_a954-knumh = gt_a954o-knumh.
        delete a954 from ls_a954.
      endif.
    endif.

  endif.

endform.                    "correct_a954
*&---------------------------------------------------------------------*
*&      Form  bdc_input
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form bdc_input.
  data: lv_price(12) type c,
        lv_plifz(3) type c,
        lv_pumren(5) type c,
        lv_lgrad(4) type c.

  commit work and wait.
  perform open_group.

  perform bdc_dynpro      using 'YSE_IBOX_CREATE' '9001'.
  perform bdc_field       using 'BDC_OKCODE'
                                '=EXEC'.
  perform bdc_field       using 'BDC_CURSOR'
                                'MARA-MEINS'.
  perform bdc_field       using 'MARA-MEINS'
                                gv_meins.
  perform bdc_field       using 'MARA-SPART'
                                gv_spart.
  perform bdc_field       using 'MARA-GEWEI'
                                gv_gewei.
  perform bdc_field       using 'MARA-GROES'
                                gv_groes.
  perform bdc_field       using 'MVKE-DWERK'
                                gv_dwerk.
  perform bdc_field       using 'MVKE-MTPOS'
                                gv_mtpos.
  perform bdc_field       using 'MVKE-MVGR4'
                                gv_mvgr4.
  perform bdc_field       using 'MARC-HERKL'
                                gv_herkl.
  lv_lgrad = gv_lgrad.
  perform bdc_field       using 'MARC-LGRAD'
                                lv_lgrad.
  perform bdc_field       using 'MARA-BSTME'
                                gv_bstme.
  lv_pumren = gv_pumren.
  perform bdc_field       using 'D9001_PUMREN'
                                lv_pumren.
  lv_plifz = gv_plifz.
  perform bdc_field       using 'MARC-PLIFZ'
                                lv_plifz.
  lv_price = gv_mlprice.
  perform bdc_field       using 'D9001_MLPRICE'
                                lv_price.
  perform bdc_field       using 'D9001_MLCURR'
                                gv_mlcurr.

  lv_price = gv_stprs.
  perform bdc_field       using 'D9001_STPRS'
                                lv_price.
  perform bdc_field       using 'D9001_ZLCLDESCR'
                                gv_zlcldescr.
  perform bdc_field       using 'MVKE-KONDM'
                                gv_kondm.
*perform bdc_dynpro      using 'SAPMSSY0' '0120'.
*perform bdc_field       using 'BDC_OKCODE'
*                              '/E&F03'.
  ctumode = 'E'.
  perform bdc_transaction using 'YSE_IBOX_CRE'.

  perform close_group.
endform.                    "bdc_input
*&---------------------------------------------------------------------*
*&      Form  prepare_plant_data_for_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->IT_MARA        text
*      -->IT_MARC        text
*      -->IT_MARD        text
*      -->IT_MAKT        text
*      -->IT_MBEW        text
*      -->IT_MARM        text
*      -->IT_MFIELDRES   text
*      -->IT_MPOP        text
*      -->P_WA_MAINTAIN  text
*----------------------------------------------------------------------*
form prepare_plant_data_for_fm tables it_mara structure mara_ueb
                                      it_marc structure marc_ueb
                                      it_mard structure mard_ueb
                                      it_makt structure makt_ueb
                                      it_mbew structure mbew_ueb
                                      it_marm structure marm_ueb
                                      it_mfieldres structure mfieldres
                                      it_mpop structure mpop_ueb
                               using  p_wa_maintain
                                        structure yse_popic_mat_maintain.

  data: lv_whtype        type yse_em_plant-whtype,
        lv_werks         type werks,
        lv_pnum1         like mapr-pnum1,
        lv_wertu         type wertu.

  data: lv_ekgrp type yrd_pg-ekgrp,
        lv_ekorg type yse_po_sorg_porg-ekorg.

* Check if material/plant exists
  clear lv_werks.
  select single werks into lv_werks
     from marc
     where matnr = p_wa_maintain-matnr
       and werks = p_wa_maintain-werks.

  if sy-subrc = 0.
    it_mara-tcode = 'MM02'.
  else.
    it_mara-tcode = 'MM01'.
    if gv_matnr2 is initial.
      it_mara-pstat = 'KCELDVBGP'.
      it_mara-vpsta = 'KCELDVBGP'.
    endif.
  endif.

  g_cnt_tranc = g_cnt_tranc + 1.
  g_cnt_d_ind = g_cnt_d_ind + 1.

  it_mara-mandt = sy-mandt.
  it_mara-tranc = g_cnt_tranc.
  it_mara-d_ind = g_cnt_d_ind.

  it_mara-matnr = p_wa_maintain-matnr.

  if not gv_matnr2 is initial.
    if gv_brgew is initial.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.
      move 'MARA-BRGEW' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
    if gv_ntgew is initial.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.
      move 'MARA-NTGEW' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
    if gv_groes is initial.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.
      move 'MARA-GROES' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
  else.
    move 'M'       to it_mara-mbrsh.
    move 'ZMAT'    to it_mara-mtart.
    move 'NORM'    to it_mara-mtpos_mara.
    move 'Z001'    to: it_mara-tragr, it_mara-ekwsl.
    move 'Z001'    to it_mara-magrv.
*    MOVE 'D'       TO it_mara-iprkz.
    move gv_meins  to it_mara-meins.
    move gv_matkl  to it_mara-matkl.
    move gv_matnr+8(10)  to it_mara-bismt.
    move gv_spart  to it_mara-spart.
    move gv_prdha  to it_mara-prdha.
    move gv_ntgew  to it_mara-ntgew.
    move gv_brgew  to it_mara-brgew.
    move gv_gewei  to it_mara-gewei.
    if not gv_groes is initial.
      move gv_groes  to it_mara-groes.
    endif.

*    IF NOT gv_bstme IS INITIAL.
*      MOVE gv_bstme TO it_mara-bstme.
*    ENDIF.
  endif.
  append it_mara.
  clear it_mara.

* Material decription
  if not gv_matnr2 is initial.
  else.
    it_makt-mandt = sy-mandt.
    it_makt-tranc = g_cnt_tranc.
    it_makt-d_ind = g_cnt_d_ind.

    it_makt-matnr = p_wa_maintain-matnr.
    it_makt-spras = sy-langu.
    it_makt-maktx = gv_maktx.

    append it_makt.
    clear it_makt.

    if not gv_zlcldescr is initial.
      it_makt-mandt = sy-mandt.
      it_makt-tranc = g_cnt_tranc.
      it_makt-d_ind = g_cnt_d_ind.

      it_makt-matnr = p_wa_maintain-matnr.
      it_makt-spras = gv_zlcllang.
      it_makt-maktx = gv_zlcldescr.

      append it_makt.
      clear it_makt.
    endif.
  endif.

* Plant Data for Material
  it_marc-mandt = sy-mandt.
  it_marc-tranc = g_cnt_tranc.
  it_marc-d_ind = g_cnt_d_ind.

  it_marc-matnr = p_wa_maintain-matnr.
  it_marc-werks = p_wa_maintain-werks.

  if lv_werks is initial.
    move 'Z2'   to it_marc-mtvfp.
    move 'Z001' to it_marc-ladgr.
    move 'X'    to it_marc-kautb.
    move '1'    to it_marc-webaz.
*    MOVE gv_dismm   TO it_marc-dismm.
    clear lv_whtype.
    select single whtype into lv_whtype
      from yse_em_plant where werks = p_wa_maintain-werks.
    if lv_whtype = 'B' or lv_whtype = 'C'.
      it_marc-dismm = 'Z7'.
    else.
      it_marc-dismm = 'ND'.
    endif.

    move 'EX'   to it_marc-disls.
    move '001'  to it_marc-dispo.
    if p_wa_maintain-werks+2(2) = '92'."'90'. MOD-002
      clear: it_marc-disls, it_marc-dispo.
    endif.
    move '0'    to it_marc-minbe.
    move 'F'    to it_marc-beskz.
    move gv_plifz to it_marc-plifz.
    move '0'    to it_marc-bstfe.
    move gv_sernp to it_marc-sernp.
    move gv_herkl to it_marc-herkl.
    move '1000' to it_marc-lgfsb.
    move '001'  to it_marc-fhori.
    move gv_lgrad  to it_marc-lgrad.
  endif.

  clear lv_wertu.
  select single wertu into lv_wertu
     from t134m
     where bwkey = p_wa_maintain-werks
       and mtart = 'ZMAT'.

  if p_wa_maintain-werks+2(2) <> '92'."'90'. MOD-002
    if lv_wertu = 'X'.
      select single disgr into it_marc-disgr from tmw00
          where mtart = 'ZMAT'
          and   werks = p_wa_maintain-werks.
    endif.
    move '1000' to it_marc-lgfsb.
  else.
    move '0001' to it_marc-lgfsb.
  endif.

* profit center must be derived from mara-prdha
  it_marc-prctr = gv_prdha+0(4).
  if it_marc-prctr co '0123456789 '.
    call function 'CONVERSION_EXIT_ALPHA_INPUT'
      exporting
        input  = it_marc-prctr
      importing
        output = it_marc-prctr.
  endif.

  if not lv_werks is initial.
    if not gv_sernp is initial.
      it_marc-sernp = gv_sernp.
    else.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.

      move 'MARC-SERNP' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
    if not gv_herkl is initial.
      it_marc-herkl = gv_herkl.
    else.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.

      move 'MARC-HERKL' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
    if not gv_plifz is initial.
      it_marc-plifz = gv_plifz.
    else.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.

      move 'MARC-PLIFZ' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
    if not gv_lgrad is initial.
      it_marc-lgrad = gv_lgrad.
    else.
      it_mfieldres-tranc = g_cnt_tranc.
      it_mfieldres-d_ind = g_cnt_d_ind.

      move 'MARC-LGRAD' to it_mfieldres-fname.
      append it_mfieldres.
    endif.
  endif.
  it_marc-ekgrp = '001'.

  select single ekorg into lv_ekorg from
         yse_po_sorg_porg where vkorg = gv_vkorg.

  select single ekgrp from yrd_pg into lv_ekgrp
    where ekorg = lv_ekorg and lifnr = gv_lifnr.
  if sy-subrc = 0.
    it_marc-ekgrp = lv_ekgrp.
  else.
    move 'X' to gv_errflg.
    move text-e06 to g_output-text.
    replace '&1' in g_output-text with gv_lifnr.
    append g_output.
    return.
  endif.

* special procurement
  if lv_whtype = 'B'.
    it_marc-sobsl = '40'.
  endif.

* create forecast view
  it_mpop-mandt = sy-mandt.
  it_mpop-matnr = it_marc-matnr.
  it_mpop-werks = it_marc-werks.

*    it_mpop-versp = '00'.
  it_mpop-modaw = 'A'.
  it_mpop-modav = '1'.
  it_mpop-kzpar = 'X'.
  it_mpop-opgra = 'F'.
  it_mpop-kzini = 'X'.
  it_mpop-prmod = 'J'.
  it_mpop-siggr = '4'.
  it_mpop-perkz = 'M'.
  it_mpop-peran = '12'.
  it_mpop-perio = '12'.
  it_mpop-anzpr = '12'.

  clear lv_pnum1.
  select single pnum1 into lv_pnum1
     from mapr where werks = it_marc-werks
                 and matnr = it_marc-matnr.
  it_mpop-pnum1 = lv_pnum1.
  it_mpop-tranc = g_cnt_tranc.
  it_mpop-d_ind = g_cnt_d_ind.
  append it_mpop.
  clear it_mpop.
  it_marc-autru = 'X'.

* update transaction in it_mara if mapr doesn't exist
  if lv_pnum1 is initial.
    loop at it_mara where tranc = g_cnt_tranc.
      it_mara-tcode = 'MM01'.
      modify it_mara.
    endloop.
  endif.
  append it_marc.
  clear it_marc.

* Accounting data for material
  if lv_werks is initial.
    it_mbew-mandt = sy-mandt.
    it_mbew-tranc = g_cnt_tranc.
    it_mbew-d_ind = g_cnt_d_ind.

    it_mbew-matnr = p_wa_maintain-matnr.
    it_mbew-bwkey = p_wa_maintain-werks.

    if gv_lifnr+1(3) = '102'.
      it_mbew-bklas = '3040'.
    elseif gv_lifnr+1(3) = '101'.
      it_mbew-bklas = '3060'.
    endif.

    it_mbew-vprsv = 'S'.
    it_mbew-peinh = '1'.
    it_mbew-stprs = gv_stprs.
*    it_mbew-hkmat = 'X'.
*    it_mbew-abwkz = '0'.
    append it_mbew.
    clear it_mbew.
  endif.

* Storage data for material
  if lv_werks is initial and
    p_wa_maintain-werks+2(2) <> '92'."'90'. MOD-002
    it_mard-mandt = sy-mandt.
    it_mard-tranc = g_cnt_tranc.
    it_mard-d_ind = g_cnt_d_ind.

    it_mard-matnr = p_wa_maintain-matnr.
    it_mard-werks = p_wa_maintain-werks.
    it_mard-lgort = '1000'.
    append it_mard.
    clear it_mard.
  endif.

** Units of Measure for Material
*  if NOT gv_bstme IS INITIAL AND
*     gv_bstme <> gv_meins.
*    it_marm-mandt = sy-mandt.
*    it_marm-tranc = g_cnt_tranc.
*    it_marm-d_ind = g_cnt_d_ind.
*
*    it_marm-matnr = p_wa_maintain-matnr.
*    it_marm-meinh = gv_bstme.
*
*    it_marm-umren = gv_umren.
*    it_marm-umrez = 1000.
*    APPEND it_marm.
*    CLEAR it_marm.
*  ENDIF.

endform.                    "prepare_plant_data_for_fm
*&---------------------------------------------------------------------*
*&      Form  prepare_sales_data_for_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->IT_MARA        text
*      -->IT_MVKE        text
*      -->IT_MARM        text
*      -->IT_MLAN        text
*      -->IT_MFIELDRES   text
*      -->P_WA_MAINTAIN  text
*----------------------------------------------------------------------*
form prepare_sales_data_for_fm tables it_mara structure mara_ueb
                                      it_mvke structure mvke_ueb
                                      it_marm structure marm_ueb
                                      it_mlan structure steu_ueb
                                      it_mfieldres structure mfieldres
                               using  p_wa_maintain
                                        structure yse_popic_mat_maintain.

  data: lv_bukrs   type bukrs,
        lv_vkorg   type vkorg.

* Check if material/sal.org/distr.ch. exists
  clear lv_vkorg.
  select single vkorg into lv_vkorg
     from mvke
     where matnr = p_wa_maintain-matnr
       and vkorg = p_wa_maintain-vkorg
       and vtweg = p_wa_maintain-vtweg.

  if sy-subrc = 0.
    it_mara-tcode = 'MM02'.
  else.
    it_mara-tcode = 'MM01'.
  endif.

  g_cnt_tranc = g_cnt_tranc + 1.
  g_cnt_d_ind = g_cnt_d_ind + 1.

  it_mara-mandt = sy-mandt.
  it_mara-tranc = g_cnt_tranc.
  it_mara-d_ind = g_cnt_d_ind.
  it_mara-matnr = p_wa_maintain-matnr.
  append it_mara.
  clear it_mara.

* Sales data for Material
  it_mvke-mandt = sy-mandt.
  it_mvke-tranc = g_cnt_tranc.
  it_mvke-d_ind = g_cnt_d_ind.

  it_mvke-matnr = p_wa_maintain-matnr.
  it_mvke-vkorg = p_wa_maintain-vkorg.
  it_mvke-vtweg = p_wa_maintain-vtweg.

  it_mvke-dwerk = gv_dwerk.
  it_mvke-ktgrm = p_wa_maintain-vtweg.
  it_mvke-mvgr2 = gv_mvgr2.
  it_mvke-prodh = gv_prdha.
  it_mvke-mtpos = gv_mtpos.
  it_mvke-kondm = gv_kondm.

  if not gv_mvgr4 is initial.
    it_mvke-mvgr4 = gv_mvgr4.
  else.
    it_mfieldres-tranc = g_cnt_tranc.
    it_mfieldres-d_ind = g_cnt_d_ind.
    move 'MVKE-MVGR4' to it_mfieldres-fname.
    append it_mfieldres.
  endif.

  if not gv_vrkme is initial and
     gv_vrkme <> gv_meins.
    it_mvke-vrkme = gv_vrkme.
  endif.

  if not gv_prat2 is initial.
    it_mvke-prat2 = gv_prat2.
  else.
    it_mfieldres-tranc = g_cnt_tranc.
    it_mfieldres-d_ind = g_cnt_d_ind.
    move 'MVKE-PRAT2' to it_mfieldres-fname.
    append it_mfieldres.
  endif.
  it_mvke-prat3 = 'X'.
  append it_mvke.
  clear it_mvke.

* Tax Classification for Material
  it_mlan-mandt = sy-mandt.
  it_mlan-tranc = g_cnt_tranc.
  it_mlan-d_ind = g_cnt_d_ind.

  select single bukrs into lv_bukrs
     from tvko where vkorg = p_wa_maintain-vkorg.

  if sy-subrc = 0.
    select single land1 into it_mlan-aland
       from t001 where bukrs = lv_bukrs.
  endif.

  it_mlan-matnr = p_wa_maintain-matnr.
  it_mlan-tatyp = 'MWST'.
  it_mlan-taxkm = '1'.
  append it_mlan.
  clear it_mlan.

* Units of Measure for Material
  if not gv_vrkme is initial and
     gv_vrkme <> gv_meins.
    it_marm-mandt = sy-mandt.
    it_marm-tranc = g_cnt_tranc.
    it_marm-d_ind = g_cnt_d_ind.

    it_marm-matnr = p_wa_maintain-matnr.
    it_marm-meinh = gv_vrkme.

    gv_dec = gv_umren.
    if gv_dec+5(1) <> 0.
      it_marm-umren = gv_umren * 1000.
      it_marm-umrez = 1000.
    else.
      if gv_dec+4(1) <> 0.
        it_marm-umren = gv_umren * 100.
        it_marm-umrez = 100.
      else.
        if gv_dec+3(1) <> 0.
          it_marm-umren = gv_umren * 10.
          it_marm-umrez = 10.
        else.
          it_marm-umren = gv_umren.
          it_marm-umrez = 1.
        endif.
      endif.
    endif.
    append it_marm.
    clear it_marm.
  endif.

endform.                    "prepare_sales_data_for_fm
*&---------------------------------------------------------------------*
*&      Form  import_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form import_data.

  import gv_matnr gv_lifnr gv_vkorg gv_maktx gv_famcd
         gv_matkl gv_prdha gv_mvgr2 gv_stprs gv_waers gv_netpr gv_tpcurr
         gv_rpip  gv_rpcurr
         gv_datab gv_datbi gv_lifnr2
         gv_meins gv_vrkme gv_umren gv_spart gv_gewei gv_ntgew gv_brgew gv_groes
         gv_dwerk gv_mtpos gv_mvgr4 gv_sernp gv_prat2 gv_herkl gv_lgrad
         gv_bstme gv_pumren gv_plifz gv_mlprice gv_mlcurr gv_evers
         gv_zlcldescr gv_zlcllang gv_kondm
         g_output
               from memory id 'YSE_IBOX_PROCESS_CRE'.

  mara-matnr = gv_matnr.
  makt-maktx = gv_maktx.
  eina-lifnr = gv_lifnr.
  mvke-vkorg = gv_vkorg.
  mvke-vtweg = '01'.
  mvke-prodh = gv_prdha.

  mara-meins = gv_meins.
  mvke-vrkme = gv_vrkme.
  d9001_umren = gv_umren.
  mara-spart = gv_spart.
  mara-gewei = gv_gewei.
  mara-ntgew = gv_ntgew.
  mara-brgew = gv_brgew.
  mara-groes = gv_groes.
  mvke-dwerk = gv_dwerk.
  mvke-mtpos = gv_mtpos.
  mvke-mvgr4 = gv_mvgr4.
  marc-sernp = gv_sernp.
  mvke-prat2 = gv_prat2.
  marc-herkl = gv_herkl.
*  marc-dismm = gv_dismm.
  d9001_zlcldescr = gv_zlcldescr.
  mvke-kondm = gv_kondm.
  marc-lgrad = gv_lgrad.
  mara-bstme = gv_bstme.
  d9001_pumren = gv_pumren.
  marc-plifz = gv_plifz.
  d9001_mlprice = gv_mlprice.
  d9001_mlcurr = gv_mlcurr.
  t405-evers = gv_evers.
  d9001_stprs = gv_stprs.
  d9001_waers = gv_waers.

* Vendor name
  select single name1 into lfa1-name1
      from lfa1
      where lifnr = gv_lifnr.

* Sales org. description
  select single vtext into tvkot-vtext
      from tvkot
      where vkorg = gv_vkorg
        and spras = sy-langu.

* Distr.Ch. description
  select single vtext into tvtwt-vtext
      from tvtwt
      where spras = sy-langu
        and vtweg = '01'.
endform.                    "import_data
