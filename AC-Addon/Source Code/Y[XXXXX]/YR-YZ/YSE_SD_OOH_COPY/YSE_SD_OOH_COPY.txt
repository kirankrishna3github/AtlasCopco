*----------------------------------------------------------------------*
* Author  : Anda Wu                                                    *
* Created : 12.11.2014                                                 *
* Dev.nbr: CR3329-CS/SDMM-OOH Reporting per Sales Order                *
*----------------------------------------------------------------------*
* This report  is CS/SDMM-OOH Reporting per Sales Order                *
* of China MR CC Project                                               *
************************************************************************
* Mod-xxx | xxxx.xx.xx | xxxx xxxx     | CD1Kxxxxxxxxxx  |   CRXXXX    *
************************************************************************
REPORT yse_sd_ooh_copy NO STANDARD PAGE HEADING LINE-SIZE 255.

*INCLUDE yse_ooh_rpt_lcl.                "Local class event handling
*INCLUDE yse_ooh_rpttop.                 "global Data
*INCLUDE yse_ooh_rptsel.                 "selection screen
*INCLUDE yse_ooh_rptev.                  "report events
*INCLUDE yse_ooh_rpt_f01.                "form routines
*INCLUDE yse_ooh_rpt_pbo01.              "PBO modules
*INCLUDE yse_ooh_rpt_pai01.              "PAI module

************************************************************************
* TYPE SPOOLS                                                          *
************************************************************************
TYPE-POOLS slis.

************************************************************************
* TABLES                                                               *
************************************************************************
TABLES:   mara,
          vbkd,
          vbpa,
          vbap,
          vbak,
          vbfa,
          ekko.

************************************************************************
* TYPES                                                                *
************************************************************************
TYPES:

  BEGIN OF  ty_alv_output,
    vbeln       TYPE char10,    "Sales Document
    posnr(6)    TYPE n,         "Sales Document Item
    auart       TYPE char4,     "Sales Document Type
    erdat       TYPE erdat,     "Date on Which Record Was Created(H)
    ernam       TYPE ernam,     "Name of Person who Created(H)
    erdat_sl    TYPE erdat,     "Date on Which Record Was Created(I)
    ernam_sl    TYPE ernam,     "Name of Person who Created(I)
    vkorg       TYPE vkorg,     "Sales Organization
    vtweg       TYPE vtweg,     "Distribution Channel
    matnr       TYPE char18,    "Material Number
    maktx       TYPE char40,    "Material Description
    stprs       TYPE stprs,     "Standard price
    netwr       TYPE netwr_ap,  "Net value of the order item
    werks       TYPE werks,     "Plant
    lgort       TYPE lgort_d,   "Storage Location
    labst       TYPE labst,     "Valuated Unrestricted-Use Stock
    vkbur       TYPE vkbur,     "Sales Office
    vkgrp       TYPE vkgrp,     "Sales Group
    bezei       TYPE bezei20,   "Description
    edatu       TYPE edatu,     "Schedule line date
    wadat       TYPE wadat,     "Credit block
    cmgst       TYPE zyse_cmgst,"Credit block
    lifsk       TYPE lifsk,     "Delivery block
    vsbed       TYPE vsbed,     "Shipping Conditions
    autlf       TYPE autlf,     "Complete delivery status
    kvgr4       TYPE kvgr4,     "Customer group 4
    zterm       TYPE dzterm,    "Terms of Payment Key
    alava       TYPE zyse_allava,"ALL Available
    avail       TYPE zyse_ava,  "Available
    pstyv       TYPE pstyv,     "Sales document item category
    dtc_sfs     TYPE yse_dtc_sfs,"DTC/SFS
    pgc         TYPE z_pgc,     "Product Group Code
    target1     TYPE rkeg_ww002,"PLC
    bstkd       TYPE bstkd,     "Customer purchase order number
    lifnr       TYPE lifnr,     "Account Number of Vendor or Creditor
    vbeln_po    TYPE char10,    "Subsequent PO number
    posnn_po    TYPE posnr_nach,"PO line number
    xblnr       TYPE xblnr_long,"Status in PO line description
    bmeng       TYPE bmeng,     "Confirmed quantity
    kwmeng      TYPE kwmeng,    "Ordered quantity
    niqty       TYPE yse_niqty, "Delivered QTY(Not Issued)
    isqty       TYPE yse_isqty, "Delivered QTY(Issued)
    ivqty       TYPE yse_ivqty, "Invoiced QTY
    aufnr       TYPE char12,    "Service Order
    quotation   TYPE yse_quotation,"Quotation number
    grdate      TYPE zgrdate,   "DTC last GR Date
    kunnr       TYPE kunag,     "Sold-to party
    name1       TYPE name1_gp,  "Sold-to name
  END OF ty_alv_output,

  BEGIN OF ty_vbpa,
    vbeln             TYPE vbpa-vbeln,            "Sales and Dist Doc
    posnr             TYPE vbpa-posnr,            "Item number
    parvw             TYPE vbpa-parvw,            "Partner Function
    kunnr             TYPE vbpa-kunnr,            "Customer Number 1
    pernr             TYPE vbpa-pernr,            "Personnel Number
    adrnr             TYPE vbpa-adrnr,            "Address
  END OF ty_vbpa,

  BEGIN OF ty_vbfa,
    vbelv             TYPE vbfa-vbelv,            "Preceding sales doc
    posnv             TYPE vbfa-posnv,            "Preceding item
    vbeln             TYPE vbfa-vbeln,            "Subsequent sale doc
    posnn             TYPE ekpo-ebelp,            "Subsequent item
    vbtyp_n           TYPE vbfa-vbtyp_n,          "Document category
  END OF ty_vbfa,

  BEGIN OF ty_vbak,
    vbeln             TYPE vbak-vbeln,            "Sales Document
    erdat             TYPE vbak-erdat,            "Record Create Date
    vkorg             TYPE vbak-vkorg,            "Sales Org.
    vkbur             TYPE vbak-vkbur,            "Sales Office
    bstnk             TYPE vbak-bstnk,            "Customer PO
    kunnr             TYPE vbak-kunnr,            "Sold-to party
  END OF ty_vbak,

  BEGIN OF ty_vbkd,
    vbeln             TYPE vbkd-vbeln,            "Sales Document
    posnr             TYPE vbkd-posnr,            "Sales Document Item
    kdgrp             TYPE vbkd-kdgrp,            "Customer group
  END OF ty_vbkd,

  BEGIN OF ty_vbap,
    vbeln             TYPE vbap-vbeln,            "Sales Document
    posnr             TYPE vbap-posnr,            "Sales Document Item
    matnr             TYPE vbap-matnr,            "Material Number
    matkl             TYPE vbap-matkl,            "Material Group 8
    arktx             TYPE vbap-arktx,            "Short text for item
    werks             TYPE vbap-werks,            "Plant
    erdat             TYPE vbap-erdat,            "Record Created Date
  END OF ty_vbap,

  BEGIN OF ty_ekko,
    ebeln             TYPE ekko-ebeln,            "Purchasing Doc
    lifnr             TYPE ekko-lifnr,            "Vendor Account Number
  END OF ty_ekko,

  BEGIN OF ty_ekpo,
    ebeln             TYPE ekpo-ebeln,            "Purchasing Document
    ebelp             TYPE ekpo-ebelp,            "Item Number
    netpr             TYPE ekpo-netpr,            "Net Price in Pur
  END OF ty_ekpo,

  BEGIN OF ty_ekbe,
    ebeln             TYPE ekbe-ebeln,            "Purchasing Documen
    ebelp             TYPE ekbe-ebelp,            "Item Number
    gjahr             TYPE ekbe-gjahr,            "Document Year
    belnr             TYPE ekbe-belnr,            "Material Documen
    bewtp             TYPE ekbe-bewtp,            "History Category
    menge             TYPE ekbe-menge,            "Quantity
    dmbtr             TYPE ekbe-dmbtr,            "Amount in LC
    wrbtr             TYPE ekbe-wrbtr,            "Amount in docu cur
    stblg             TYPE rbkp-stblg,            "Reversal documen
  END OF ty_ekbe,

  BEGIN OF ty_mbew,
    matnr	            TYPE mbew-matnr,            "Material Number
    bwkey	            TYPE mbew-bwkey	,           "Valuation Area
    bwtar	            TYPE mbew-bwtar,            "Valuation Type
    stprs             TYPE mbew-stprs,            "Standard price
  END OF ty_mbew,

  BEGIN OF ty_pa0001,
    pernr             TYPE pa0001-pernr,          "Personnel number
    ename             TYPE pa0001-ename,          "Format Employe Name
  END OF ty_pa0001,

  BEGIN OF ty_adrc,
    addrnumber        TYPE adrc-addrnumber,       "Address number
    name1             TYPE adrc-name1,            "Name 1
    name2             TYPE adrc-name2,            "Name 2
    name3             TYPE adrc-name3,            "Name 3
    name4             TYPE adrc-name4,            "Name 4
    region            TYPE adrc-region,           "Region
  END OF ty_adrc,

  BEGIN OF ty_lfa1,
    lifnr             TYPE lfa1-lifnr,            "Vendor/Creditor No
    name1             TYPE lfa1-name1,            "Name1
    name2             TYPE lfa1-name2,            "Name2
    name3             TYPE lfa1-name3,            "Name3
    name4             TYPE lfa1-name4,            "Name4
  END OF ty_lfa1,

  BEGIN OF ty_mara,
     matnr TYPE char18,
  END OF ty_mara,

  BEGIN OF ty_makt,
    matnr             TYPE makt-matnr,
    spras             TYPE makt-spras,
    maktx             TYPE makt-maktx,
  END OF ty_makt,

  BEGIN OF  ty_kna1,
    kunnr             TYPE kna1-kunnr,            "Customer Number 1
    bran1             TYPE kna1-bran1,            "Industry Code
  END OF ty_kna1.

************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:
  gt_vbak             TYPE STANDARD TABLE OF ty_vbak,
  gt_vbap             TYPE STANDARD TABLE OF ty_vbap,
  gt_vbpa             TYPE STANDARD TABLE OF ty_vbpa,
  gt_mara             TYPE STANDARD TABLE OF ty_mara,
  gt_vbfa             TYPE STANDARD TABLE OF ty_vbfa,
  gt_ekko             TYPE STANDARD TABLE OF ty_ekko,
  gt_makt             TYPE STANDARD TABLE OF ty_makt,
  gt_vbkd             TYPE STANDARD TABLE OF ty_vbkd,
  gt_ekbe             TYPE STANDARD TABLE OF ty_ekbe,
  gt_mbew             TYPE STANDARD TABLE OF ty_mbew,
  gt_tvkbt            TYPE STANDARD TABLE OF tvkbt,
  gt_t151t            TYPE STANDARD TABLE OF t151t,
  gt_kna1             TYPE STANDARD TABLE OF ty_kna1,
  gt_pa0001           TYPE STANDARD TABLE OF ty_pa0001,
  gt_adrc             TYPE STANDARD TABLE OF ty_adrc,
  gt_alvdata          TYPE STANDARD TABLE OF ty_alv_output,
  gt_lfa1             TYPE STANDARD TABLE OF ty_lfa1,
  gt_fieldcat         TYPE slis_t_fieldcat_alv,
  gt_rec_type         TYPE RANGE OF ce11000-vrgar.

************************************************************************
* WORKAREAS                                                            *
************************************************************************
DATA:
  gs_disvar           TYPE disvariant,
  gs_layout           TYPE slis_layout_alv.

************************************************************************
* VARIABLES                                                            *
************************************************************************
DATA:
  gv_text             TYPE string,
  gv_save             TYPE c,
  gv_callback         TYPE slis_formname.

************************************************************************
* CONSTANTS                                                            *
************************************************************************
CONSTANTS:
  gc_x                TYPE c VALUE 'X',
  gc_type_e           TYPE c VALUE 'E',
  gc_lang_zh(1)       TYPE c VALUE '1',
  gc_lang_en(1)       TYPE c VALUE 'E',
  gc_callback_routine TYPE slis_formname VALUE 'USER_COMMAND'.

************************************************************************
* SELECTION-SCREEN                                                     *
************************************************************************
* Alv variants
SELECTION-SCREEN BEGIN OF BLOCK b3 WITH FRAME TITLE text-t03.

PARAMETERS: p_vari TYPE disvariant-variant.       "Dispaly Variant
PARAMETERS: cb_mul   AS CHECKBOX DEFAULT space.   "ALV multi select

SELECTION-SCREEN END OF BLOCK b3.

SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-t02 .
SELECT-OPTIONS:
s_vbeln      FOR vbak-vbeln,            "Sales order number
s_auart      FOR vbak-auart,            "Sales order type
s_vkorg      FOR vbak-vkorg OBLIGATORY, "Sales Organisation
s_vtweg      FOR vbak-vtweg,            "Distribution Channel
s_vkbur      FOR vbak-vkbur,            "Sales Office
s_vkgrp      FOR vbak-vkgrp,            "Sales Group
s_kunnr      FOR vbak-kunnr,            "Sold-to party
s_matnr      FOR vbap-matnr,            "Material ID
s_erdat      FOR vbak-erdat OBLIGATORY. "SO creation date
*SELECTION-SCREEN BEGIN OF LINE.
*PARAMETERS: cb_or    AS CHECKBOX                  "Order Receive
*              DEFAULT 'X'   MODIF ID m1.
*SELECTION-SCREEN COMMENT 4(48) text-c01 FOR FIELD cb_or.
*SELECTION-SCREEN END OF LINE.
*
*SELECTION-SCREEN BEGIN OF LINE.
*PARAMETERS: cb_oif    AS CHECKBOX                "Order Invoiced
*              DEFAULT space   MODIF ID m1.
*SELECTION-SCREEN COMMENT 4(48) text-c02 FOR FIELD cb_oif.
*SELECTION-SCREEN END OF LINE.
*
*SELECTION-SCREEN BEGIN OF LINE.
*PARAMETERS: cb_oib    AS CHECKBOX                 "COGS Manul Adjustment
*              DEFAULT space   MODIF ID m1.
*SELECTION-SCREEN COMMENT 4(48) text-c03 FOR FIELD cb_oib.
*SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN END OF BLOCK b2.

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-t01.

PARAMETERS: rb1 RADIOBUTTON GROUP g1 DEFAULT 'X',
            rb2 RADIOBUTTON GROUP g1.

SELECTION-SCREEN END OF BLOCK b1.

*&---------------------------------------------------------------------*
*& INITIALIZATION                                                      *
*&---------------------------------------------------------------------*
INITIALIZATION.
* Do initilization
  PERFORM frm_init.

*&---------------------------------------------------------------------*
*& AT SELECTION-SCREEN OUTPUT                                          *
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN OUTPUT.
* screen initial set
  PERFORM frm_screen_set.

*&---------------------------------------------------------------------*
*& AT SELECTION-SCREEN                                                 *
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN.
* selection screen check
  PERFORM check_parameter.

*&---------------------------------------------------------------------*
*& AT SELECTION-SCREEN ON VALUE-REQUEST                                *
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_vari.
  PERFORM f4_for_variant.

*&---------------------------------------------------------------------*
*& START-OF-SELECTION                                                  *
*&---------------------------------------------------------------------*
START-OF-SELECTION.
* progress indicator
  PERFORM process_info.
* get data
  PERFORM get_alv_data.
* alv property set
  PERFORM alv_prop_set.

*&---------------------------------------------------------------------*
*& END-OF-SELECTION                                                    *
*&---------------------------------------------------------------------*
END-OF-SELECTION.
* ALV display
  PERFORM alv_display.

*&---------------------------------------------------------------------*
*&      Form  FRM_INIT
*&---------------------------------------------------------------------*
*       Do initilization
*----------------------------------------------------------------------*
FORM frm_init .

* initialize the internal table,workareas and variables
  REFRESH:
    gt_vbak             ,
    gt_vbap             ,
    gt_vbpa             ,
    gt_vbfa             ,
    gt_ekko             ,
    gt_tvkbt            ,
    gt_t151t            ,
    gt_kna1             ,
    gt_makt             ,
    gt_vbkd             ,
    gt_pa0001           ,
    gt_adrc             ,
    gt_alvdata          ,
    gt_lfa1             ,
    gt_fieldcat         ,
    gt_rec_type         .

  CLEAR:
    gs_disvar           ,
    gs_layout           ,
    gv_text             ,
    gv_save             ,
    gv_callback         .

  gv_save = 'A'.
* Set default alv layout
  gs_disvar-report = sy-repid.
  CALL FUNCTION 'REUSE_ALV_VARIANT_DEFAULT_GET'
    EXPORTING
      i_save        = gv_save
    CHANGING
      cs_variant    = gs_disvar
    EXCEPTIONS
      wrong_input   = 1
      not_found     = 2
      program_error = 3
      OTHERS        = 4.
  IF sy-subrc = 0.
    p_vari = gs_disvar-variant.
  ENDIF.

ENDFORM.                    " FRM_INIT
*&---------------------------------------------------------------------*
*&      Form  FRM_SCREEN_SET
*&---------------------------------------------------------------------*
*       screen initial set
*----------------------------------------------------------------------*
FORM frm_screen_set.

* Set PARAMETER cb_mul invisible
  LOOP AT SCREEN.
    IF screen-name = 'CB_MUL'.
      screen-invisible = '1'.
      MODIFY SCREEN.
    ENDIF.
    IF screen-name = 'CB_NAMES'.
      screen-invisible = '1'.
      MODIFY SCREEN.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " FRM_SCREEN_SET
*&---------------------------------------------------------------------*
*&      Form  CHECK_PARAMETER
*&---------------------------------------------------------------------*
*       selection screen check
*----------------------------------------------------------------------*
FORM check_parameter .

  DATA: ls_disvar TYPE disvariant.

* Check if record type is initial
*  IF    cb_or   IS INITIAL
*    AND cb_oif  IS INITIAL
*    AND cb_oib  IS INITIAL.
*    MESSAGE e000(yse_sales_log) WITH text-002.
*  ENDIF.

  IF p_vari IS NOT INITIAL.
    ls_disvar = gs_disvar.
    ls_disvar-variant = p_vari.
    CALL FUNCTION 'REUSE_ALV_VARIANT_EXISTENCE'
      EXPORTING
        i_save        = gv_save
      CHANGING
        cs_variant    = ls_disvar
      EXCEPTIONS
        wrong_input   = 1
        not_found     = 2
        program_error = 3
        OTHERS        = 4.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ELSE.
      gs_disvar = ls_disvar.
    ENDIF.
  ENDIF.

ENDFORM.                    " CHECK_PARAMETER
*&---------------------------------------------------------------------*
*&      Form  PROCESS_INFO
*&---------------------------------------------------------------------*
*       progress indicator
*----------------------------------------------------------------------*
FORM process_info .

  DATA: ls_rec_type LIKE LINE OF gt_rec_type.
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    CONCATENATE 'Start report:'(004) sy-repid
                  INTO gv_text SEPARATED BY space.
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-005.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 1
        text       = gv_text.
  ENDIF.

* [Order Received] is set
*  IF cb_or IS NOT INITIAL.
*    ls_rec_type-sign      = 'I'.
*    ls_rec_type-option    = 'EQ'.
*    ls_rec_type-low       = 'A'.
*    APPEND ls_rec_type TO gt_rec_type.
*  ENDIF.

* [Order Invoiced] is set
*  IF cb_oif IS NOT INITIAL.
*    ls_rec_type-sign      = 'I'.
*    ls_rec_type-option    = 'EQ'.
*    ls_rec_type-low       = 'F'.
*    APPEND ls_rec_type TO gt_rec_type.
*  ENDIF.

* [COGS Manul Adjustment] is set
*  IF cb_oib IS NOT INITIAL.
*    ls_rec_type-sign      = 'I'.
*    ls_rec_type-option    = 'EQ'.
*    ls_rec_type-low       = 'B'.
*    APPEND ls_rec_type TO gt_rec_type.
*  ENDIF.

ENDFORM.                    " PROCESS_INFO
*&---------------------------------------------------------------------*
*&      Form  GET_ALV_DATA
*&---------------------------------------------------------------------*
*       get data
*----------------------------------------------------------------------*
FORM get_alv_data .

* Gain data from table VBAK - Sales Document: Header Data
  PERFORM get_data_vbak.
* Gain data from table VBAP - Sales Document: Item Data
  PERFORM get_data_vbap.
* Gain data from table VBPA - Sales Document: Partner
  PERFORM get_data_vbpa.
* Gain data from table VBFA - Sales Document Flow
  PERFORM get_data_vbfa.
* Get other data
  PERFORM get_data_others.
* Generate ALV data for output
  PERFORM generate_alv_data.

ENDFORM.                    " GET_ALV_DATA
*&---------------------------------------------------------------------*
*&      Form  ALV_PROP_SET
*&---------------------------------------------------------------------*
*       alv property set
*----------------------------------------------------------------------*
FORM alv_prop_set .

* Display ALV process indicator
  PERFORM alv_progress_indicator.

* FIELDCAT set
  PERFORM alv_fieldcat_set.

* LAYOUT set
  PERFORM alv_layout_set.

* Set Others
  PERFORM alv_others_set.

ENDFORM.                    " ALV_PROP_SET
*&---------------------------------------------------------------------*
*&      Form  ALV_DISPLAY
*&---------------------------------------------------------------------*
*       ALV display
*----------------------------------------------------------------------*
FORM alv_display .

  DATA: lv_lines(10)  TYPE c.

  IF gt_alvdata IS INITIAL.
    CLEAR: gv_text.
    gv_text = text-060.
    MESSAGE s000(yse_sales_log) WITH gv_text
      DISPLAY LIKE gc_type_e.
    LEAVE LIST-PROCESSING.
  ENDIF.

  IF sy-batch IS INITIAL.
    CLEAR: gv_text.
    gv_text = text-010.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 80
        text       = gv_text.
  ELSE.
    CLEAR: gv_text.
    DESCRIBE TABLE gt_alvdata LINES lv_lines.
    CONCATENATE 'Totally'(015) lv_lines 'entries are generated'(020)
                  INTO gv_text SEPARATED BY space.
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ENDIF.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program      = sy-repid
      i_callback_user_command = gv_callback
      is_layout               = gs_layout
      it_fieldcat             = gt_fieldcat
      i_save                  = gv_save
      is_variant              = gs_disvar
    TABLES
      t_outtab                = gt_alvdata
    EXCEPTIONS
      program_error           = 1
      OTHERS                  = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " ALV_DISPLAY
*&---------------------------------------------------------------------*
*&      Form  ALV_FIELDCAT_SET
*&---------------------------------------------------------------------*
*       FIELDCAT set
*----------------------------------------------------------------------*
FORM alv_fieldcat_set .

  DATA:
     lv_linecnt  TYPE i,
     ls_fieldcat TYPE slis_fieldcat_alv.

  CLEAR lv_linecnt.
* 1 - CoCd
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'BUKRS'.
  ls_fieldcat-ref_fieldname = 'BUKRS'.
  ls_fieldcat-ref_tabname = 'CE11000'.
*  ls_fieldcat-seltext_m = 'ROW'.
  ls_fieldcat-fix_column = gc_x.
  APPEND ls_fieldcat TO gt_fieldcat.

* 2 - Period
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'PERIO'.
  ls_fieldcat-ref_fieldname = 'PERIO'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-fix_column = gc_x.
  APPEND ls_fieldcat TO gt_fieldcat.

* 3 - Sales Ord.
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'KAUFN'.
  ls_fieldcat-hotspot   = gc_x.
  ls_fieldcat-ref_fieldname = 'KAUFN'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-fix_column = gc_x.
*    ls_fieldcat-emphasize = 'C711'.
  APPEND ls_fieldcat TO gt_fieldcat.

*  SO Item
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'KDPOS'.
  ls_fieldcat-ref_fieldname = 'KDPOS'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-fix_column = gc_x.
  APPEND ls_fieldcat TO gt_fieldcat.

* PLC
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'WW002'.
  ls_fieldcat-ref_fieldname = 'WW002'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  APPEND ls_fieldcat TO gt_fieldcat.

* GAC
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'WW006'.
  ls_fieldcat-ref_fieldname = 'WW006'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  APPEND ls_fieldcat TO gt_fieldcat.

* PGC
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'WW007'.
  ls_fieldcat-ref_fieldname = 'WW007'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  APPEND ls_fieldcat TO gt_fieldcat.

* SDst
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'BZIRK'.
  ls_fieldcat-ref_fieldname = 'BZIRK'.
  ls_fieldcat-ref_tabname = 'VBKD'.
  APPEND ls_fieldcat TO gt_fieldcat.

* SOff.
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VKBUR'.
  ls_fieldcat-ref_fieldname = 'VKBUR'.
  ls_fieldcat-ref_tabname = 'VBAK'.
  APPEND ls_fieldcat TO gt_fieldcat.

* SOff. Description
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'BEZEI'.
  ls_fieldcat-seltext_s = 'Sale Off'(061).
  ls_fieldcat-seltext_m = 'Sales Office'(062).
  APPEND ls_fieldcat TO gt_fieldcat.

* --------------ADD BY LINS 2014/06/26 START-------
*SlsRep1Id
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'PERNR'.
  ls_fieldcat-seltext_s = 'SlsRep1Id'(110).
  ls_fieldcat-seltext_m = 'SlsRep1Id'(110).
  APPEND ls_fieldcat TO gt_fieldcat.
* --------------ADD BY LINS 2014/06/26 END-------


* SlsRep1Name
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'ENAME'.
  ls_fieldcat-seltext_s = 'Name'(063).
  ls_fieldcat-seltext_m = 'SlsRep1Name'(064).
  APPEND ls_fieldcat TO gt_fieldcat.

* Customer group
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'KDGRP'.
*  ls_fieldcat-ref_fieldname = 'KDGRP'.
*  ls_fieldcat-ref_tabname = 'VBKD'.
  ls_fieldcat-seltext_s = 'SoldTo Cus'(065).
  ls_fieldcat-seltext_m = 'SoldTo Cus'(065).
  APPEND ls_fieldcat TO gt_fieldcat.

* Customer group Name
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'KTEXT'.
*  ls_fieldcat-ref_fieldname = 'KTEXT'.
*  ls_fieldcat-ref_tabname = 'T151T'.
  ls_fieldcat-seltext_s = 'SoldTo Cus'(065).
  ls_fieldcat-seltext_m = 'SoldTo Cus'(065).
  APPEND ls_fieldcat TO gt_fieldcat.

* Sold-to pt
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SOT_KUNNR'.
  ls_fieldcat-seltext_s = 'So-to pt'(030).
  ls_fieldcat-seltext_m = 'Sold-to Party'(031).
  APPEND ls_fieldcat TO gt_fieldcat.

* Sold-to Name
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SOT_NAME'.
  ls_fieldcat-seltext_s = 'So-to nm'(032).
  ls_fieldcat-seltext_m = 'Sold-to Party Name'(033).
  APPEND ls_fieldcat TO gt_fieldcat.

* Sold-to Name2
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SOT_NAME2'.
  ls_fieldcat-seltext_s = 'So-to nm2'(044).
  ls_fieldcat-seltext_m = 'Sold-to Party Name2'(045).
  APPEND ls_fieldcat TO gt_fieldcat.

* Sold-to Name3
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SOT_NAME3'.
  ls_fieldcat-seltext_s = 'So-to nm3'(046).
  ls_fieldcat-seltext_m = 'Sold-to Party Name3'(047).
  APPEND ls_fieldcat TO gt_fieldcat.

* Sold-to Name4
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SOT_NAME4'.
  ls_fieldcat-seltext_s = 'So-to nm4'(048).
  ls_fieldcat-seltext_m = 'Sold-to Party Name4'(049).
  APPEND ls_fieldcat TO gt_fieldcat.

* Customer Industry Code
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'BRAN1'.
  ls_fieldcat-seltext_m = 'Cust.Indust.Code'(068).
  ls_fieldcat-seltext_l = 'Customer Industry Code'(067).
  ls_fieldcat-ref_fieldname = 'BRAN1'.
  ls_fieldcat-ref_tabname = 'KNA1'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Ship-to pt
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SPT_KUNNR'.
  ls_fieldcat-seltext_s = 'Sh-to pt'(034).
  ls_fieldcat-seltext_m = 'Ship-to Party'(035).
  APPEND ls_fieldcat TO gt_fieldcat.

* Ship-to pt name
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'SPT_NAME'.
  ls_fieldcat-seltext_s = 'Sh-to nm'(036).
  ls_fieldcat-seltext_m = 'Ship-to Party Name'(037).
  APPEND ls_fieldcat TO gt_fieldcat.

* Matl Group
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'REGION'.
  ls_fieldcat-seltext_s = 'Region'(084).
  ls_fieldcat-seltext_m = 'ShipTo Region'(085).
  APPEND ls_fieldcat TO gt_fieldcat.

* Matl Group
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'MATKL'.
  ls_fieldcat-ref_fieldname = 'MATKL'.
  ls_fieldcat-ref_tabname = 'VBAP'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Customer PO
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'BSTNK'.
  ls_fieldcat-ref_fieldname = 'BSTNK'.
  ls_fieldcat-ref_tabname = 'VBAK'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Purch.Doc.
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VBELN'.
  ls_fieldcat-ref_fieldname = 'EBELN'.
  ls_fieldcat-ref_tabname = 'EKKO'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Vendor
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'LIFNR'.
  ls_fieldcat-ref_fieldname = 'LIFNR'.
  ls_fieldcat-ref_tabname = 'EKKO'.
  APPEND ls_fieldcat TO gt_fieldcat.

* vendor name
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'V_NAME'.
*  ls_fieldcat-ref_fieldname = 'NAME1'.
*  ls_fieldcat-ref_tabname = 'LFA1'.
  ls_fieldcat-seltext_s = 'Vendor nm'(088).
  ls_fieldcat-seltext_m = 'Vendor Name'(089).
  APPEND ls_fieldcat TO gt_fieldcat.


* Purchase Price
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'STPRS'.
*  ls_fieldcat-ref_fieldname = 'STPRS'.
*  ls_fieldcat-ref_tabname = 'MBEW'.
  ls_fieldcat-seltext_s = 'Pur.Price'(098).
  ls_fieldcat-seltext_m = 'Purchase Price'(099).
  APPEND ls_fieldcat TO gt_fieldcat.

* Actual Purchase Price
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'NETPR'.
*  ls_fieldcat-ref_fieldname = 'NETPR'.
*  ls_fieldcat-ref_tabname = 'EKPO'.
  ls_fieldcat-seltext_m = 'Act.Price'(100).
  ls_fieldcat-seltext_l = 'Actual Purchase Price'(101).
  APPEND ls_fieldcat TO gt_fieldcat.

* Sales Org
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VKORG'.
  ls_fieldcat-ref_fieldname = 'VKORG'.
  ls_fieldcat-ref_tabname = 'VBAK'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Plant
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'WERKS'.
  ls_fieldcat-ref_fieldname = 'WERKS'.
  ls_fieldcat-ref_tabname = 'VBAP'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Material
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'MATNR'.
  ls_fieldcat-ref_fieldname = 'MATNR'.
  ls_fieldcat-ref_tabname = 'VBAP'.
  APPEND ls_fieldcat TO gt_fieldcat.

* MatDescr
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'ARKTX'.
*  ls_fieldcat-ref_fieldname = 'ARKTX'.
*  ls_fieldcat-ref_tabname = 'VBAP'.
  ls_fieldcat-seltext_m = 'MatDescr'(102).
  ls_fieldcat-seltext_l = 'Material Description'(103).
  APPEND ls_fieldcat TO gt_fieldcat.

* Order Creation Date
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'ERDAT'.
*  ls_fieldcat-ref_fieldname = 'ERDAT'.
*  ls_fieldcat-ref_tabname = 'VBAK'.
  ls_fieldcat-seltext_m = 'Ord.Date'(104).
  ls_fieldcat-seltext_l = 'Order Creation Date'(105).
  APPEND ls_fieldcat TO gt_fieldcat.

* Order Line Creation Date
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'ERDAT2'.
*  ls_fieldcat-ref_fieldname = 'ERDAT'.
*  ls_fieldcat-ref_tabname = 'VBAP'.
  ls_fieldcat-seltext_m = 'Line.Date'(106).
  ls_fieldcat-seltext_l = 'Order Line Date'(107).
  APPEND ls_fieldcat TO gt_fieldcat.

* AcctAssgGr
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'KTGRD'.
  ls_fieldcat-ref_fieldname = 'KTGRD'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Sales qty
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'ABSMG'.
  ls_fieldcat-ref_fieldname = 'ABSMG'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-qfieldname = 'ABSMG_ME'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Revenues
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VV100'.
  ls_fieldcat-ref_fieldname = 'VV100'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-cfieldname = 'REC_WAERS'.
  APPEND ls_fieldcat TO gt_fieldcat.

* Cash discount
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VV110'.
  ls_fieldcat-ref_fieldname = 'VV110'.
*  ls_fieldcat-ref_tabname = 'CE11000'.
*  ls_fieldcat-qfieldname = 'REC_WAERS'.
  ls_fieldcat-seltext_s = 'Discont'(108).
  ls_fieldcat-seltext_m = 'Cash discount'(109).
  APPEND ls_fieldcat TO gt_fieldcat.

* Unadjusted COS
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VV130'.
  ls_fieldcat-ref_fieldname = 'VV130'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-qfieldname = 'REC_WAERS'.
  APPEND ls_fieldcat TO gt_fieldcat.
*
* Freight charged
  CLEAR ls_fieldcat.
  lv_linecnt = lv_linecnt + 1.
  ls_fieldcat-col_pos = lv_linecnt.
  ls_fieldcat-fieldname = 'VV650'.
  ls_fieldcat-ref_fieldname = 'VV650'.
  ls_fieldcat-ref_tabname = 'CE11000'.
  ls_fieldcat-qfieldname = 'REC_WAERS'.
  APPEND ls_fieldcat TO gt_fieldcat.

ENDFORM.                    " ALV_FIELDCAT_SET
*&---------------------------------------------------------------------*
*&      Form  ALV_LAYOUT_SET
*&---------------------------------------------------------------------*
*       LAYOUT set
*----------------------------------------------------------------------*
FORM alv_layout_set .

  CLEAR: gs_layout.
  gs_layout-zebra = gc_x.               "ALV lines cross-color display
  gs_layout-colwidth_optimize = gc_x.   " Auto optimize column width
  gs_layout-detail_popup = gc_x.        " Show detail screen
  IF cb_mul IS NOT INITIAL.
    gs_layout-box_fieldname = 'XBOX'.
  ENDIF.

ENDFORM.                    " ALV_LAYOUT_SET
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_VBAK
*&---------------------------------------------------------------------*
*       Gain data from table VBAK - Sales Document: Header Data
*----------------------------------------------------------------------*
FORM get_data_vbak .

* Progress indicator/ Log info generate
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    gv_text ='Begin to retrieve table VBAK'(003).
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-003.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 10
        text       = gv_text.
  ENDIF.

  SELECT  vbeln                                  "Sales Document
          erdat                                  "Record Create Date
          vkorg                                  "Sales Org.
          vkbur                                  "Sales Office
          bstnk                                  "Customer PO
          kunnr                                  "Sold-to party
    FROM  vbak
    INTO TABLE gt_vbak
    WHERE vbeln IN s_vbeln
      AND erdat IN s_erdat
      AND auart IN s_auart
      AND vkorg IN s_vkorg
      AND vtweg IN s_vtweg
      AND vkgrp IN s_vkgrp
      AND vkbur IN s_vkbur
      AND kunnr IN s_kunnr.
* No data exist extract by selection screen
  IF sy-subrc <> 0.
    IF sy-batch IS NOT INITIAL.
      CLEAR: gv_text.
      gv_text ='No data exist in table VBAK'(014).
      MESSAGE i000(yse_sales_log) WITH gv_text.
*    ELSE.
*      CLEAR: gv_text.
*      gv_text = text-014.
*      MESSAGE s000(yse_sales_log) WITH gv_text
*        DISPLAY LIKE gc_type_e.
*      LEAVE LIST-PROCESSING.
    ENDIF.
  ENDIF.

  IF gt_mara IS NOT INITIAL.
    SELECT  matnr
           spras
           maktx
     FROM  makt
     INTO TABLE gt_makt
     FOR ALL ENTRIES IN gt_mara
     WHERE matnr = gt_mara-matnr
       AND  ( spras = gc_lang_zh
           OR spras = gc_lang_en ).
  ENDIF.

  SELECT   matnr                        "Material Number
           bwkey                        "Valuation Area
           bwtar                        "Valuation Type
           stprs                        "Standard price
    FROM mbew
    INTO TABLE gt_mbew
    FOR ALL ENTRIES IN gt_mara
    WHERE matnr = gt_mara-matnr.


  IF gt_vbak IS NOT INITIAL.
    SELECT   vbeln             "Sales Document
             posnr             "Sales Document Item
             kdgrp             "Customer group
      FROM vbkd
      INTO TABLE gt_vbkd
      FOR ALL ENTRIES IN gt_vbak
      WHERE vbeln = gt_vbak-vbeln.
    SORT gt_vbkd.
    DELETE ADJACENT DUPLICATES FROM gt_vbkd.
  ENDIF.

ENDFORM.                    " GET_DATA_VBAK
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_VBPA
*&---------------------------------------------------------------------*
*       Gain data from table VBPA - Sales Document: Partner
*----------------------------------------------------------------------*
FORM get_data_vbpa .

* Progress indicator/ Log info generate
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    gv_text ='Begin to retrieve table VBPA'(007).
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-007.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 25
        text       = gv_text.
  ENDIF.

  IF gt_vbak IS NOT INITIAL.
    SELECT    vbeln                               "Sales and Dist Doc
              posnr                               "Item number
              parvw                               "Partner Function
              kunnr                               "Customer Number 1
              pernr                               "Personnel Number
              adrnr                               "Address
      FROM vbpa
      INTO TABLE gt_vbpa
      FOR ALL ENTRIES IN gt_vbak
      WHERE vbeln = gt_vbak-vbeln
        AND (     parvw = 'WE'                    "Ship-to
              OR  parvw = 'AG'                    "Sold-to
              OR  parvw = 'VE').                  "Sales Employee
    IF sy-subrc <> 0.
      IF sy-batch IS NOT INITIAL.
        CLEAR: gv_text.
        gv_text ='No data exist in table VBPA'(017).
        MESSAGE i000(yse_sales_log) WITH gv_text.
*      ELSE.
*        CLEAR: gv_text.
*        gv_text = text-017.
*        MESSAGE s000(yse_sales_log) WITH gv_text
*          DISPLAY LIKE gc_type_e.
*        LEAVE LIST-PROCESSING.
      ENDIF.
    ELSE.

    ENDIF.
  ENDIF.

ENDFORM.                    " GET_DATA_VBPA
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_VBFA
*&---------------------------------------------------------------------*
*       Gain data from table VBFA - Sales Document Flow
*----------------------------------------------------------------------*
FORM get_data_vbfa .

* Progress indicator/ Log info generate
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    gv_text ='Begin to retrieve table VBFA'(008).
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-008.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 35
        text       = gv_text.
  ENDIF.
  IF gt_vbap IS NOT INITIAL.
    SELECT    vbelv                               "Preceding sales doc
              posnv                               "Preceding item
              vbeln                               "Subsequent sale doc
              posnn                               "Subsequent item
              vbtyp_n                             "Document category
      FROM vbfa
      INTO TABLE gt_vbfa
      FOR ALL ENTRIES IN gt_vbap
      WHERE vbelv = gt_vbap-vbeln
        AND posnv = gt_vbap-posnr
        AND vbeln IN s_vbeln
        AND vbtyp_n = 'V'
        AND rfmng > 0.
    IF sy-subrc <> 0.
      IF sy-batch IS NOT INITIAL.
        CLEAR: gv_text.
        gv_text ='No data exist in table VBFA'(018).
        MESSAGE i000(yse_sales_log) WITH gv_text.
*      ELSE.
*        IF s_vbeln IS NOT INITIAL.
*          CLEAR: gv_text.
*          gv_text = text-018.
*          MESSAGE s000(yse_sales_log) WITH gv_text
*            DISPLAY LIKE gc_type_e.
*          LEAVE LIST-PROCESSING.
*        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " GET_DATA_VBFA
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_VBAP
*&---------------------------------------------------------------------*
*       Gain data from table VBAP - Sales Document: Item Data
*----------------------------------------------------------------------*
FORM get_data_vbap .

  DATA: ls_vbap     TYPE ty_vbap.
* Progress indicator/ Log info generate
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    gv_text ='Begin to retrieve table VBAP'(006).
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-006.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 20
        text       = gv_text.
  ENDIF.

    SELECT  vbap~vbeln                            "Sales Document
            vbap~posnr                            "Sales Document Item
            vbap~matnr                            "Material Number
            vbap~matkl                            "Material Group 8
            vbap~arktx                            "Short text for item
            vbap~werks                            "Plant
            vbap~erdat                            "Record create date
*            vbkd~kdgrp                            "Customer group
*            vbkd~bzirk                            "Sales district
      FROM  vbap
*        LEFT JOIN vbkd
*        ON  vbap~vbeln = vbkd~vbeln
*        AND vbap~posnr = vbkd~posnr
      INTO TABLE gt_vbap
      FOR ALL ENTRIES IN gt_vbak
      WHERE vbap~vbeln = gt_vbak-vbeln.
*       AND  vbkd~kdgrp IN s_kdgrp.
*   No data exist extract by selection screen
    IF sy-subrc <> 0.
      IF sy-batch IS NOT INITIAL.
        CLEAR: gv_text.
        gv_text ='No data exist in table VBAP'(016).
        MESSAGE i000(yse_sales_log) WITH gv_text.
*      ELSE.
*        IF    s_matnr IS NOT INITIAL
*           OR s_kdgrp IS NOT INITIAL.
*          CLEAR: gv_text.
*          gv_text = text-016.
*          MESSAGE s000(yse_sales_log) WITH gv_text
*            DISPLAY LIKE gc_type_e.
*          LEAVE LIST-PROCESSING.
*        ENDIF.
      ENDIF.
    ENDIF.

ENDFORM.                    " GET_DATA_VBAP
*&---------------------------------------------------------------------*
*&      Form  GENERATE_ALV_DATA
*&---------------------------------------------------------------------*
*       Generate ALV data for output
*----------------------------------------------------------------------*
FORM generate_alv_data .

  DATA: ls_vbak       TYPE ty_vbak,
        ls_vbap       TYPE ty_vbap,
        ls_vbkd       TYPE ty_vbkd,
        ls_vbfa       TYPE ty_vbfa,
        ls_vbpa       TYPE ty_vbpa,
        ls_ekko       TYPE ty_ekko,
        ls_makt       TYPE ty_makt,
        ls_tvkbt      TYPE tvkbt,
        ls_t151t      TYPE t151t,
        ls_mbew       TYPE ty_mbew,
        ls_kna1       TYPE ty_kna1,
        ls_lfa1       TYPE ty_lfa1,
        ls_pa0001     TYPE ty_pa0001,
        ls_adrc       TYPE ty_adrc,
        ls_ekbe       TYPE ty_ekbe,
        lv_posnr      TYPE vbap-posnr,
        ls_alvdata    TYPE ty_alv_output,
        lv_sum_menge  TYPE ekbe-menge,
        lv_sum_dmbtr  TYPE ekbe-dmbtr.

* Progress indicator/ Log info generate
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    gv_text ='Begin to generate ALV data'(009).
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-009.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 40
        text       = gv_text.
  ENDIF.

  LOOP AT gt_vbap INTO ls_vbap.
    APPEND ls_alvdata TO gt_alvdata.
  ENDLOOP.

ENDFORM.                    " GENERATE_ALV_DATA
*&---------------------------------------------------------------------*
*&      Form  ALV_PROGRESS_INDICATOR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_progress_indicator .

* Progress indicator/ Log info generate
  IF sy-batch IS NOT INITIAL.
    CLEAR: gv_text.
    gv_text ='Begin to set ALV property'(011).
    MESSAGE i000(yse_sales_log) WITH gv_text.
  ELSE.
    CLEAR: gv_text.
    gv_text = text-011.
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = 75
        text       = gv_text.
  ENDIF.

ENDFORM.                    " ALV_PROGRESS_INDICATOR
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_OTHERS
*&---------------------------------------------------------------------*
*       Get other data
*----------------------------------------------------------------------*
FORM get_data_others .
  DATA: lt_vbpa TYPE STANDARD TABLE OF ty_vbpa,
        lt_vbap TYPE STANDARD TABLE OF ty_vbap,
        lt_vbkd TYPE STANDARD TABLE OF ty_vbkd.

* Get data from table EKKO - Purchasing Document Header
  IF gt_vbfa IS NOT INITIAL.
    SELECT      ebeln                             "Purchasing Doc
                lifnr                             "Vendor Account Number
      FROM ekko
      INTO TABLE gt_ekko
      FOR ALL ENTRIES IN gt_vbfa
      WHERE ebeln = gt_vbfa-vbeln.
*        AND lifnr IN s_lifnr.
    IF sy-batch IS NOT INITIAL.
      CLEAR: gv_text.
      gv_text ='No data exist in table EKKO'(071).
      MESSAGE i000(yse_sales_log) WITH gv_text.
*    ELSE.
*      IF s_lifnr IS NOT INITIAL.
*        CLEAR: gv_text.
*        gv_text = text-071.
*        MESSAGE s000(yse_sales_log) WITH gv_text
*          DISPLAY LIKE gc_type_e.
*        LEAVE LIST-PROCESSING.
*      ENDIF.
    ENDIF.
*    SELECT      ebeln                             "Purchasing Document
*                ebelp                             "Item Number
*                netpr                             "Net Price in Pur
*      FROM ekpo
*      INTO TABLE gt_ekpo
*      FOR ALL ENTRIES IN gt_vbfa
*      WHERE ebeln = gt_vbfa-vbeln
*        AND ebelp = gt_vbfa-posnn.

    SELECT  ekbe~ebeln                            "Purchasing Documen
            ekbe~ebelp                            "Item Number
            ekbe~gjahr                            "Document Year
            ekbe~belnr                            "Material Documen
            ekbe~bewtp                            "History Category
            ekbe~menge                            "Quantity
            ekbe~dmbtr                            "Amount in LC
            ekbe~wrbtr                            "Amount in docu cur
            rbkp~stblg                            "Reversal documen
      FROM ekbe
      INNER JOIN rbkp
      ON    ekbe~gjahr = rbkp~gjahr
        AND ekbe~belnr = rbkp~belnr
      INTO TABLE gt_ekbe
      FOR ALL ENTRIES IN gt_vbfa
      WHERE ekbe~ebeln = gt_vbfa-vbeln
        AND ekbe~ebelp = gt_vbfa-posnn
        AND ekbe~bewtp = 'Q'
        AND rbkp~stblg = space.
  ENDIF.

  IF gt_ekko IS NOT INITIAL.
    SELECT  lifnr                                 "Vendor/Creditor No
            name1                                 "Name1
            name2                                 "Name2
            name3                                 "Name3
            name4                                 "Name4
      FROM  lfa1
      INTO TABLE gt_lfa1
      FOR ALL ENTRIES IN gt_ekko
      WHERE  lifnr = gt_ekko-lifnr.
  ENDIF.

  IF gt_vbak IS NOT INITIAL.
    SELECT *
      FROM tvkbt
      INTO TABLE gt_tvkbt
      FOR ALL ENTRIES IN gt_vbak
      WHERE vkbur = gt_vbak-vkbur
        AND spras = sy-langu.
    IF sy-langu <> 'E'.
      SELECT *
        FROM tvkbt
        APPENDING TABLE gt_tvkbt
        FOR ALL ENTRIES IN gt_vbak
        WHERE vkbur = gt_vbak-vkbur
          AND spras = 'E'.
    ENDIF.
  ENDIF.

  lt_vbpa = gt_vbpa.
  SORT lt_vbpa BY pernr.
  DELETE ADJACENT DUPLICATES FROM lt_vbpa COMPARING pernr.
  IF lt_vbpa IS NOT INITIAL.
    SELECT    pernr               "Personnel number
              ename               "Format Employe Name.
      FROM    pa0001
      INTO TABLE gt_pa0001
      FOR ALL ENTRIES IN lt_vbpa
      WHERE pernr = lt_vbpa-pernr.
  ENDIF.

*  lt_vbap  = gt_vbap.
  lt_vbkd  = gt_vbkd.
  SORT lt_vbkd BY kdgrp.
  DELETE ADJACENT DUPLICATES FROM lt_vbkd COMPARING kdgrp.
  IF lt_vbkd  IS NOT INITIAL.
    SELECT *
      FROM t151t
      INTO TABLE gt_t151t
      FOR ALL ENTRIES IN lt_vbkd
      WHERE spras = sy-langu
        AND kdgrp = lt_vbkd-kdgrp.
    IF sy-langu <> 'E'.
      SELECT *
        FROM t151t
        APPENDING TABLE gt_t151t
        FOR ALL ENTRIES IN lt_vbkd
        WHERE spras = 'E'
          AND kdgrp = lt_vbkd-kdgrp.
    ENDIF.
  ENDIF.

  REFRESH: lt_vbpa.
  lt_vbpa = gt_vbpa.
  SORT lt_vbpa BY adrnr.
  DELETE ADJACENT DUPLICATES FROM lt_vbpa COMPARING adrnr.
  IF lt_vbpa IS NOT INITIAL.
    SELECT   addrnumber                   "Address number
             name1                        "Name 1
             name2                        "Name 2
             name3                        "Name 3
             name4                        "Name 4
             region                       "region
      FROM adrc
      INTO TABLE gt_adrc
      FOR ALL ENTRIES IN lt_vbpa
      WHERE addrnumber = lt_vbpa-adrnr.
  ENDIF.

  REFRESH: lt_vbpa.
  lt_vbpa = gt_vbpa.
  SORT lt_vbpa BY kunnr.
  DELETE ADJACENT DUPLICATES FROM lt_vbpa COMPARING kunnr.
  IF lt_vbpa IS NOT INITIAL.
    SELECT  kunnr                         "Customer Number 1
            bran1                         "Industry Code
    FROM    kna1
    INTO TABLE gt_kna1
    FOR ALL ENTRIES IN lt_vbpa
    WHERE kunnr = lt_vbpa-kunnr.
  ENDIF.

  REFRESH: lt_vbpa,
           lt_vbap,
           lt_vbkd.
ENDFORM.                    " GET_DATA_OTHERS

*&---------------------------------------------------------------------*
*&      Form  ALV_OTHERS_SET
*&---------------------------------------------------------------------*
*       Set Others
*----------------------------------------------------------------------*
FORM alv_others_set .

  gv_callback = gc_callback_routine.

ENDFORM.                    " ALV_OTHERS_SET
*&---------------------------------------------------------------------*
*&      Form  F4_FOR_VARIANT
*&---------------------------------------------------------------------*
*       F4 help for display variant
*----------------------------------------------------------------------*
FORM f4_for_variant .

  DATA: ls_disvar TYPE disvariant,
        lv_exit   TYPE c.

  ls_disvar-report = sy-repid.

  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      is_variant    = ls_disvar
      i_save        = gv_save
    IMPORTING
      e_exit        = lv_exit
      es_variant    = gs_disvar
    EXCEPTIONS
      not_found     = 1
      program_error = 2
      OTHERS        = 3.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ELSE.
    IF lv_exit = space.
      p_vari = gs_disvar-variant.
    ENDIF.
  ENDIF.

ENDFORM.                    " F4_FOR_VARIANT

*&---------------------------------------------------------------------*
*&      Form  ALV_OTHERS_SET
*&---------------------------------------------------------------------*
*       USER_COMMAND
*----------------------------------------------------------------------*
FORM user_command USING u_ucomm     LIKE sy-ucomm           "#EC CALLED
                        p_selfield  TYPE slis_selfield.

  CASE u_ucomm.
    WHEN '&IC1'.        " SAP standard code for double-clicking
      IF p_selfield-fieldname = 'KAUFN'.
        IF p_selfield-value IS NOT INITIAL.
          SET PARAMETER ID 'AUN' FIELD p_selfield-value.
          CALL TRANSACTION 'VA03'.
        ENDIF.
      ENDIF.
    WHEN OTHERS.
  ENDCASE.

ENDFORM.                    " USER_COMMAND

*Text symbol text
*000:FSE/Technician
*001:Repair
*010:Order type
*011:Document num
*012:Document item
*013:Sales org.
*014:Dist. channel
*015:Plant
*016:Material group
*017:Material Number
*018:PGC Code
*019:Stock policy
*020:Distribution mode
*022:Vendor
*023:DTC / SFS
*025:Requested delivery date
*026:Requested Qty
*027:Counter
*028:Document blocked
*031:Standard cost
*032:Warehouse type
*033:Storage Location
*034:Sold To
*035:Sales Office
*036:Sales Group
*037:Sales District
*039:UU Stock
*040:ShipCond
*041:All. stock
*042:Avai. stock
*043:Open PO
*044:Customer group 4
*045:SO Created by
*049:Include Safety Stock in Calculation of Allocations
*050:Calculation of allocations
*051:SD Item Category
*052:Credit block
*053:Ship to customer
*054:Availability
*T01:Selection Criteria
*T02:Selection Input

*T03:ALV Layout
*Selection text
*P_VARI:D       .
*RB1:        Open Sales orders
*RB2:        All orders
*S_AUART:D       .
*S_ERDAT:D       .
*S_KUNNR:D       .
*S_MATNR:D       .
*S_VBELN:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
*S_VKORG:D       .
*S_VTWEG:D       .
