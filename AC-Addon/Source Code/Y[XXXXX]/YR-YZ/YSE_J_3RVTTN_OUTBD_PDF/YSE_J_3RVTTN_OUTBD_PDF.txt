REPORT yse_j_3rvttn MESSAGE-ID vw
                LINE-SIZE 85
                NO STANDARD PAGE HEADING.

*--------------------------------------------------------------------- *
* MOD-002 |17/072012| Pratap Mada   | CD1K972586       | XXXXxxxxxx    *
*                                     CD1K972638                       *
*                                     CD1K972683                       *
* Description:                                                         *
* Changing the sender address of for some specific plants              *
*                                                                      *
*----------------------------------------------------------------------*
* MOD-003 |03/06/2015| Prakash | CD1K985749 | CR3626                   *
*        hard code text removal-ZU01,ZU03,ZU05,ZU06,ZU10,ZU11,ZU12,ZU13*
*----------------------------------------------------------------------*
* MOD-004 |26/06/2017| Valentin Rubinsky  | CD1K992481 | XXXXxxxxxx    *
* Description:                                                         *
* Changing address of the payer and the consignee                      *
*--------------------------------------------------------------------- *

* extended syntax checker should not detect any 'UNUSED VARIABLES'Error
SET EXTENDED CHECK OFF.

*------- Includes
INCLUDE vttkdata.                      "Shipment Header
INCLUDE vttsdata.                      "Shipment Stages
INCLUDE vttpdata.                      "Shipment Items
INCLUDE vbpadata.                      "Partner
INCLUDE vtfadata.                      "Flow
INCLUDE sadrdata.                      "Address
INCLUDE vtlfdata.                      "Deliveries selected
INCLUDE rvadtabl.                      "Messages
INCLUDE vsedata.                       "shipping units
INCLUDE rv56acom.                      "I/O-Structure

*------- Tables
TABLES: vbpla, t005, t005t, t604t, marc,
        vbdpl, marm, vbfa, vbdkl, tcurx,
        addr1_val, likp,
        spell, komser, usr03, bnka.

* reactivate extended syntax checker ...
SET EXTENDED CHECK ON.

*------- Types

TYPES: cmr_01_type       LIKE cmr_01,
       cmr_02_type       LIKE cmr_02,
       cmr_03_type       LIKE cmr_03,
       cmr_04_type       LIKE cmr_04,
       cmr_06ff_type     LIKE cmr_06ff,
       cmr_06ff_tab_type LIKE cmr_06ff OCCURS 0,
       cmr_06a_type      LIKE cmr_06a,
       cmr_14_type       LIKE cmr_14,
       cmr_15_type       LIKE cmr_15,
       cmr_16_type       LIKE cmr_16,
       cmr_17_type       LIKE cmr_17,
       cmr_20_type       LIKE cmr_20,
       cmr_21_type       LIKE cmr_21.

TYPES: BEGIN OF cmr_type,
         language LIKE t005-spras,
         country  LIKE t005-land1,
         cmr_01   TYPE cmr_01_type,
         cmr_02   TYPE cmr_02_type,
         cmr_03   TYPE cmr_03_type,
         cmr_04   TYPE cmr_04_type,
         cmr_06ff TYPE cmr_06ff_tab_type,
         cmr_06a  TYPE cmr_06a_type,
         cmr_14   TYPE cmr_14_type,
         cmr_15   TYPE cmr_15_type,
         cmr_16   TYPE cmr_16_type,
         cmr_17   TYPE cmr_17_type,
         cmr_20   TYPE cmr_20_type,
         cmr_21   TYPE cmr_21_type,
       END OF cmr_type.

TYPES: cmr_tab_typ TYPE cmr_type OCCURS 0.

CONSTANTS: c_posnr(6) TYPE c VALUE '000000'.
*------- General Data
DATA: retcode LIKE sy-subrc,           "Return code
      xscreen(1) TYPE c,               "Output on printer or screen
      x_open TYPE c.

DATA: "|CMR_FORM           TYPE CMR_TAB_TYP,     "Documents to print
      something_to_print TYPE boolean.         "Flag for printing

DATA: t_vbdpl  TYPE ehs_vbdpl_t,
      wa_vbdpl TYPE LINE OF ehs_vbdpl_t.

DATA: BEGIN OF protocol_tab OCCURS 0,
         msg_arbgb LIKE syst-msgid,
         msg_nr    LIKE syst-msgno,
         msg_ty    LIKE syst-msgty,
         msg_v1    LIKE syst-msgv1,
         msg_v2    LIKE syst-msgv2,
         msg_v3    LIKE syst-msgv3,
         msg_v4    LIKE syst-msgv4.
DATA: END OF protocol_tab.

* IMP RU Begin of insert Currency should always be RUB
DATA: lv_convert TYPE c,
      lv_kursk LIKE komk-kurrf.
* IMP RU End of insert Currency should always be RUB

*------- Constant values
CONSTANTS:
  tn               LIKE vbplk-gewei VALUE 'TO ',
  m                LIKE vbplk-gewei VALUE 'M  '.

DATA: gc_badi_name TYPE REF TO j_3rv_1t_badi,    "users' field filling
      gc_badi_descr TYPE REF TO j_3rv_afs_descr. "AFS-material description

DATA: language LIKE sy-langu,
      aland LIKE sadr-land1.

DATA: BEGIN OF ztrn.
* IMP RU Begin of delete
*      include structure J_3RT1_HEAD. "structure for header
* IMP RU End of delete
* IMP RU Begin of insert
        INCLUDE STRUCTURE yse_j_3rt1_head. "structure for header
* IMP RU End of insert

DATA: END OF ztrn.

DATA: ltrn TYPE yse_j_3rt1_pg1. "internal table for page 1
DATA: wa_ltrn LIKE LINE OF ltrn.

DATA: BEGIN OF z_ltrn OCCURS 0. "internal table for page 1
* IMP RU Begin of delete
*      include structure J_3RT1_LINE.
* IMP RU End of delete
* IMP RU Begin of insert
        INCLUDE STRUCTURE yse_j_3rt1_line.
* IMP RU End of insert
DATA: END OF z_ltrn.
DATA: tabnam TYPE yse_j_3rt1_pg2. "internal table for page 2
DATA: wa_tabnam LIKE LINE OF tabnam.

* IMP RU Begin of insert
TYPES: BEGIN OF wa_hu,
        venum LIKE vekp-venum,
       END OF wa_hu.
* IMP RU End of insert

TYPES: BEGIN OF wa_ltr,
        werks LIKE mseg-werks,
        lgort LIKE mseg-lgort,
        charg LIKE mseg-charg,
        key_field(105),
        matdet(100),
        wa_ltrn LIKE LINE OF ltrn,
       END OF wa_ltr.
DATA: tt_ltr TYPE STANDARD TABLE OF wa_ltr WITH HEADER LINE.

* IMP RU Begin of insert
DATA: tt_hu TYPE STANDARD TABLE OF wa_hu WITH HEADER LINE.
* IMP RU End of insert

DATA: sel LIKE addr1_sel.
DATA: totam     LIKE vbdpl-lfimg.      "material quantity TOTAL
DATA: totplc    TYPE i.                "place quantity TOTAL
* IMP RU Begin of insert
DATA: totcas    TYPE i.                "Case quantity TOTAL
* IMP RU Begin of insert
DATA: totwt     LIKE vbdpl-brgew.      "gross weight TOTAL
DATA: totnt     LIKE vbdpl-ntgew,      "net weight TOTAL
      p_totnt   LIKE vbdpl-ntgew.
DATA: totvol    LIKE vbdpl-netwr.      "Amount w/o VAT TOTAL
DATA: totsum    LIKE vbdpl-netwr.      "Amount TOTAL
DATA: totnds    LIKE vbdpl-netpr.      "VAT amount TOTAL
DATA: sum  TYPE p DECIMALS 3.       "Amount
* IMP RU Begin of insert
DATA: sum2  TYPE p DECIMALS 3.       "Cases
* IMP RU End of insert
DATA: mm TYPE i, onehundred TYPE i, pp(2).
DATA: num_line TYPE i, lin_cnt TYPE i, lines_v TYPE i,
      num_line2 TYPE i,
      spel_neto(100), num_lin TYPE i, cnt TYPE i,
      dec_net LIKE spell-decimal,
      spel_brto(100), save_bukrs TYPE t001-bukrs,
      dec_brt LIKE spell-decimal,
      spel_limfg(100). "OKPO(10), OKDP(14).
DATA: nn TYPE i, av_netpr LIKE vbap-kzwi3,
      zap TYPE i, numnakl TYPE i, seqnum TYPE n LENGTH 2,
      av_netwr LIKE vbap-kzwi3.
* IMP RU Begin of delete
* DATA: vkorg type VTRLK-vkorg, kunwe type VTRLK-kunwe,
* IMP RU End of delete

* IMP RU Begin of insert
DATA: vkorg TYPE vtrlk-vkorg, kunwe TYPE vtrlk-kunwe,
      lv_vbeln LIKE slk-vbeln,
      lv_tknum LIKE ztrn-tknum,
      lv_vhart TYPE vekp-vhart,
      lv_counter(3) TYPE n,
      lv_venum TYPE vekp-venum,
      it_venum TYPE TABLE OF vekp-venum WITH HEADER LINE,
      it_venum2 TYPE TABLE OF vekp-venum WITH HEADER LINE,
      it_venum3 TYPE TABLE OF vekp-venum WITH HEADER LINE,
      teller TYPE i,
      lv_gi_date TYPE likp-wadat,
      lv_year TYPE gjahr,
      lv_month TYPE char2,
      lv_day TYPE char2,
      adrnr_re LIKE slk-adrnr_ag,
      adrnr_vkorg LIKE slk-adrnr_ag,
      kunnr_re LIKE vbpa-kunnr,
      lv_tarag LIKE vekp-tarag,
      lv_tot_tarag LIKE vekp-tarag,
      lv_tot_tarag2 LIKE vekp-tarag,
      lv_gross LIKE vekp-brgew,
      lv_gewei LIKE vekp-gewei,
      lv_laeng LIKE vekp-laeng,
      lv_breit LIKE vekp-breit,
      lv_hoehe LIKE vekp-hoehe,
      lv_meabm LIKE vekp-meabm,
      lv_laeng_c(17) TYPE c,
      lv_breit_c(17) TYPE c,
      lv_hoehe_c(17) TYPE c,
      tot_tarag LIKE vekp-tarag,
      tot_gross LIKE vekp-tarag,
* IMP RU End of insert

     vstel TYPE vtrlk-vstel, kunag TYPE vtrlk-kunag.
DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
DATA: END   OF tkomser_print.

DATA: stuz  LIKE  marm-umrez,
      stun  LIKE  marm-umren,
      mseht LIKE t006a-mseht.

* IMP RU Begin of insert
DATA: lv_landx50 LIKE t005t-landx50,
      lv_region LIKE t005u-bezei,
      lv_bukrs LIKE tvko-bukrs,
      int1 TYPE i.
* IMP RU End of insert

DATA: BEGIN OF tvbdpl OCCURS 0.    "Internal table for items
        INCLUDE STRUCTURE vbdpl.
DATA: END OF tvbdpl.
DATA: BEGIN OF hdoc,
        vbtyp LIKE vbak-vbtyp,
        auart LIKE vbak-auart,
        waerk LIKE vbak-waerk,
        knumv LIKE vbak-knumv,
        kalsm LIKE vbak-kalsm,
        fkart LIKE vbrk-fkart,
      END OF hdoc.
DATA: BEGIN OF pdoc,
        lsmeng LIKE vbap-lsmeng,
        vrkme  LIKE vbap-vrkme,
        matnr  LIKE vbap-matnr,
        kzwi3  LIKE vbap-kzwi3,
        kzwi4  LIKE vbap-kzwi4,
        kzwi5  LIKE vbap-kzwi5,
        kzwi6  LIKE vbap-kzwi6,
* IMP RU Begin of insert  currency always RUB
        cmpre LIKE  vbap-cmpre,
* IMP RU End of insert currency always RUB
      END OF pdoc.

TYPES: BEGIN OF vend_bank,
         lifnr LIKE lfbk-lifnr,
         bankadat(140),
      END OF vend_bank.
TYPES: BEGIN OF partn_bank,
         kunnr LIKE knbk-kunnr,
         bankadat(140),
       END OF partn_bank.
DATA: eknam_bank TYPE vend_bank,
      payer_bank TYPE partn_bank.

*Begin of mod-001
DATA: g_ind TYPE char1.

DATA: gt_kpp TYPE TABLE OF yse_kpp,
      wa_kpp TYPE yse_kpp.
* End of mod-001

*----------------------------------------------------------------------*
*        Aufruf der Entry-Routine aus der Nachrichtensteuerung         *
*----------------------------------------------------------------------*
FORM entry USING return_code us_screen.                     "#EC *

  CLEAR retcode.
  xscreen = us_screen.
  PERFORM processing.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM processing.

  PERFORM initialize_data.

  PERFORM get_data.
*  * Begin of mod-001
  IF g_ind EQ 'X' AND ( nast-kschl EQ 'ZU11' OR nast-kschl EQ 'ZU12' ).
    CONCATENATE '"§°§Ò§à§ã§à§Ò§Ý§Ö§ß§ß§à§Ö §á§à§Õ§â§Ñ§Ù§Õ§Ö§Ý§Ö§ß§Ú§Ö §©§¡§° "§¡§ä§Ý§Ñ§ã §¬§à§á§Ü§à"'(002)
                  wa_kpp-address wa_kpp-address1
                  INTO ztrn-gonam SEPARATED BY space.
  ENDIF.
*  End of mod-001

  IF ( something_to_print = true ).
    IF NOT seqnum IS INITIAL.
      seqnum = seqnum + 1.
      CONCATENATE vttkvb-tknum '-' seqnum INTO ztrn-tknum.
      SHIFT ztrn-tknum LEFT DELETING LEADING '0'.
    ENDIF.
    PERFORM print_form.
  ELSE.
    LOOP AT protocol_tab.
      MOVE protocol_tab-msg_arbgb TO syst-msgid.
      MOVE protocol_tab-msg_nr    TO syst-msgno.
      MOVE protocol_tab-msg_ty    TO syst-msgty.
      MOVE protocol_tab-msg_v1    TO syst-msgv1.
      MOVE protocol_tab-msg_v2    TO syst-msgv2.
      MOVE protocol_tab-msg_v3    TO syst-msgv3.
      MOVE protocol_tab-msg_v4    TO syst-msgv4.
      PERFORM protocol_update.
    ENDLOOP.
    retcode = 1.
  ENDIF.
ENDFORM.                    "PROCESSING

*---------------------------------------------------------------------*
*       FORM INITIALIZE_DATA                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM initialize_data.

  CLEAR:   protocol_tab.
  REFRESH:   "CMR_FORM,
           protocol_tab.
  something_to_print = true.
  CLEAR x_open.
ENDFORM.                    "INITIALIZE_DATA

*---------------------------------------------------------------------*
*       FORM OPEN_FORM                                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  US_SCREEN                                                     *
*  -->  US_COUNTRY                                                    *
*---------------------------------------------------------------------*
FORM open_form USING  us_screen  LIKE xscreen
                      us_country LIKE sadr-land1.            "SADR40A

***INCLUDE RVADOPFO .

  DATA: lvf_device(30)    TYPE   c,
        lvf_dialog(1)     TYPE   c   VALUE ' ',
        lvs_recipient     LIKE   swotobjid,
        lvs_sender        LIKE   swotobjid,
        lvs_snast         TYPE   snast,
        lvf_program       LIKE   sy-repid,
        lvs_comm_type     TYPE   ad_comm,
        lvs_comm_values   TYPE   szadr_comm_values.


* reset return code
  retcode = 0.

* if there is a communication strategy used ...
  IF NOT nast-tcode IS INITIAL AND nast-nacha EQ '5'.

*   ... use stratagy to get communication type
    CALL FUNCTION 'ADDR_GET_NEXT_COMM_TYPE'
         EXPORTING
              strategy           = nast-tcode
*             ADDRESS_TYPE       =
*             ADDRESS_NUMBER     = VBDKA-ADRNR
*             PERSON_NUMBER      = VBDKA-ADRNP
              address_number     = addr_key-addrnumber
              person_number      = addr_key-persnumber
         IMPORTING
              comm_type          = lvs_comm_type
              comm_values        = lvs_comm_values
*        TABLES
*             STRATEGY_TABLE     =
         EXCEPTIONS
              address_not_exist  = 1
              person_not_exist   = 2
              no_comm_type_found = 3
              internal_error     = 4
              parameter_error    = 5
              OTHERS             = 6.
    IF sy-subrc <> 0.
      retcode = sy-subrc.
      syst-msgty = 'E'.
      PERFORM protocol_update.
    ENDIF.

  ENDIF.


* convert communication data
  MOVE-CORRESPONDING nast TO lvs_snast.
  MOVE sy-repid           TO lvf_program.
  CALL FUNCTION 'CONVERT_COMM_TYPE_DATA'
       EXPORTING
            pi_comm_type              = lvs_comm_type
            pi_comm_values            = lvs_comm_values
            pi_screen                 = us_screen
*           PI_NEWID                  =
            pi_country                = us_country
            pi_repid                  = lvf_program
            pi_snast                  = lvs_snast
       IMPORTING
            pe_itcpo                  = itcpo
            pe_device                 = lvf_device
            pe_mail_recipient         = lvs_recipient
            pe_mail_sender            = lvs_sender
       EXCEPTIONS
            comm_type_not_supported   = 1
            recipient_creation_failed = 2
            sender_creation_failed    = 3
            OTHERS                    = 4.
  IF sy-subrc <> 0.
    retcode = sy-subrc.
    syst-msgty = 'E'.
    PERFORM protocol_update.
  ENDIF.

  CHECK retcode EQ 0.

* if there is no communication type
  IF  lvs_comm_type IS INITIAL.
*   set device
    CASE nast-nacha.
      WHEN '1'.
        lvf_device = 'PRINTER'.
        itcpo-tdnewid = 'X'.
      WHEN '2'.
        lvf_device = 'TELEFAX'.
        itcpo-tdtelenum = nast-telfx.
        IF nast-tland IS INITIAL.
          itcpo-tdteleland = us_country.
        ELSE.
          itcpo-tdteleland = nast-tland.
        ENDIF.
        itcpo-tdsenddate = nast-vsdat.
        itcpo-tdsendtime = nast-vsura.
        itcpo-tdfaxuser  = nast-usnam.
      WHEN '3'.
        lvf_device = 'TELETEX'.
        itcpo-tdtelenum = nast-teltx.
        IF nast-tland IS INITIAL.
          itcpo-tdteleland = us_country.
        ELSE.
          itcpo-tdteleland = nast-tland.
        ENDIF.
        itcpo-tdsenddate = nast-vsdat.
        itcpo-tdsendtime = nast-vsura.
      WHEN '4'.
        lvf_device = 'TELEX'.
        itcpo-tdtelenum = nast-telx1.
        IF nast-tland IS INITIAL.
          itcpo-tdteleland = us_country.
        ELSE.
          itcpo-tdteleland = nast-tland.
        ENDIF.
        itcpo-tdsenddate = nast-vsdat.
        itcpo-tdsendtime = nast-vsura.
      WHEN OTHERS.
        lvf_device = 'PRINTER'.
    ENDCASE.
  ENDIF.

* OTF-Output, wenn Browser-Druck
  IF nast-sort1 = 'EBPP'.
    itcpo-tdgetotf = 'X'.
  ENDIF.

  PERFORM open_form_pdf.

ENDFORM.  "open_form

*&---------------------------------------------------------------------*
*&      Form  PRINT_FORM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM print_form.            "SADR40A

  PERFORM open_form USING xscreen slk-aland.

  PERFORM get_bank.

  CONCATENATE ztrn-eknam eknam_bank-bankadat INTO ztrn-eknam
     SEPARATED BY space.
  CONDENSE ztrn-eknam.

  IF nast-kschl <> 'ZU11' AND nast-kschl <> 'ZU12'.
    CLEAR ztrn-eknam.
  ENDIF.

* IMP RU Begin delete
*  concatenate ztrn-plnam payer_bank-bankadat into ztrn-plnam
*     separated by space.
*  condense ztrn-plnam.
* IMP RU End delete

* get BAdI instance
  TRY.
      GET BADI gc_badi_name.
    CATCH cx_badi_not_implemented.                      "#EC NO_HANDLER
    CATCH cx_badi_multiply_implemented.
      MESSAGE e001(j3r_legal_forms).
    CATCH cx_badi_initial_context.
      MESSAGE e002(j3r_legal_forms).
  ENDTRY.

* IMP RU Begin of delete
* BADI: update fields
*IF gc_badi_name IS BOUND.
*  CALL BADI gc_badi_name->UPDATE_PAGE1
*    changing
*       i_ztrn   = ztrn
*       i_ltrn   = ltrn
*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
*endif.
* IMP RU End of delete

  DATA: desc, sumrz TYPE flag,
        price(15), afs_detailes(100),
        cnt TYPE i, num TYPE i, key_field(105).

  DATA : BEGIN OF i_totcas OCCURS 0,
          venum LIKE vepo-venum,
          counter TYPE i,
         END OF i_totcas.

  CLEAR desc. CLEAR sumrz.

* Get BADI instance
  TRY.
      GET BADI gc_badi_descr.
    CATCH cx_badi_not_implemented.                      "#EC NO_HANDLER
    CATCH cx_badi_multiply_implemented.
      MESSAGE e001(j3r_legal_forms).
    CATCH cx_badi_initial_context.
      MESSAGE e002(j3r_legal_forms).
  ENDTRY.

  IF gc_badi_descr IS BOUND.
    desc = 'X'.
  ENDIF.

  SELECT SINGLE sumrz FROM j_3r_lo_output INTO sumrz
     WHERE kschl    = tnapr-kschl
       AND nacha    = tnapr-nacha
       AND kappl    = tnapr-kappl.

  LOOP AT tt_ltr.
    IF desc EQ 'X'.
      CLEAR afs_detailes.
      CALL BADI gc_badi_descr->material_details
        EXPORTING
          matnr    = tt_ltr-wa_ltrn-matnr
          werks    = tt_ltr-werks
          lgort    = tt_ltr-lgort
          charg    = tt_ltr-charg
        IMPORTING
          detailes = afs_detailes.
*        exceptions
*           OTHERS   = 1.
*      IF sy-subrc <> 0.
*        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*      else.
      tt_ltr-matdet = afs_detailes.
*      ENDIF.
    ENDIF.

    price = tt_ltr-wa_ltrn-netpr.
    CONCATENATE tt_ltr-wa_ltrn-matnr tt_ltr-werks tt_ltr-lgort tt_ltr-wa_ltrn-prejsk_num
       tt_ltr-wa_ltrn-artikul tt_ltr-wa_ltrn-vrkme tt_ltr-wa_ltrn-pack_type price
       tt_ltr-wa_ltrn-seq_num
          INTO tt_ltr-key_field.
    CONDENSE tt_ltr-key_field.
    MODIFY tt_ltr.
  ENDLOOP.

  IF NOT sumrz IS INITIAL.
    REFRESH ltrn. CLEAR wa_ltrn.
    SORT tt_ltr BY key_field.
    CLEAR cnt. CLEAR key_field. CLEAR num_line. CLEAR num.
    DESCRIBE TABLE tt_ltr LINES num_line.
    LOOP AT tt_ltr.
      num = num + 1.
      IF sy-tabix EQ 1.
        CLEAR tt_ltr-wa_ltrn-numlev.
        MOVE-CORRESPONDING tt_ltr-wa_ltrn TO wa_ltrn.
        key_field = tt_ltr-key_field.
        cnt = cnt + 1.
      ELSE.
        IF tt_ltr-key_field EQ key_field.
          wa_ltrn-brgew = wa_ltrn-brgew + tt_ltr-wa_ltrn-brgew.
          wa_ltrn-ntgew = wa_ltrn-ntgew + tt_ltr-wa_ltrn-ntgew.
          wa_ltrn-lfimg = wa_ltrn-lfimg + tt_ltr-wa_ltrn-lfimg.
          wa_ltrn-netwr = wa_ltrn-netwr + tt_ltr-wa_ltrn-netwr.
          wa_ltrn-place = wa_ltrn-place + tt_ltr-wa_ltrn-place.
          cnt = cnt + 1.
        ELSE.
          IF cnt = 1.
            CLEAR wa_ltrn-arktx.
            CONCATENATE tt_ltr-wa_ltrn-arktx tt_ltr-matdet INTO wa_ltrn-arktx.
          ENDIF.
          APPEND wa_ltrn  TO ltrn.
          CLEAR wa_ltrn. CLEAR cnt.
          CLEAR tt_ltr-wa_ltrn-numlev.
          MOVE-CORRESPONDING tt_ltr-wa_ltrn TO wa_ltrn.
          key_field = tt_ltr-key_field.
          cnt = cnt + 1.
        ENDIF.
      ENDIF.
      IF num = num_line.
        IF cnt = 1.
          CLEAR wa_ltrn-arktx.
          CONCATENATE tt_ltr-wa_ltrn-arktx tt_ltr-matdet INTO wa_ltrn-arktx.
        ENDIF.
        APPEND wa_ltrn  TO ltrn.
      ENDIF.
    ENDLOOP.
  ELSEIF desc EQ 'X'.
    REFRESH ltrn. CLEAR wa_ltrn.
    LOOP AT tt_ltr.
      MOVE-CORRESPONDING tt_ltr-wa_ltrn TO wa_ltrn.
      CLEAR wa_ltrn-arktx.
      CONCATENATE tt_ltr-wa_ltrn-arktx tt_ltr-matdet INTO wa_ltrn-arktx.
      APPEND wa_ltrn  TO ltrn.
      CLEAR wa_ltrn.
    ENDLOOP.
  ENDIF.
  REFRESH tt_ltr.

  MOVE ltrn[] TO z_ltrn[].
  CLEAR wa_ltrn. REFRESH ltrn. CLEAR zap.
  CLEAR num_line. CLEAR num_lin. CLEAR nn.
  DESCRIBE TABLE z_ltrn LINES num_line.
  CLEAR totwt. CLEAR totnt. CLEAR totsum. CLEAR totplc. CLEAR totcas. CLEAR tot_tarag. CLEAR tot_gross.
  CLEAR cnt. CLEAR numnakl.

  LOOP AT z_ltrn.
    cnt = cnt + 1.
    zap = zap + 1.  "number of records
    MOVE z_ltrn TO wa_ltrn.
    num_lin = num_lin + 1.
    nn = num_lin.
    AT END OF numlev.
      IF wa_ltrn-numlev IS INITIAL AND cnt NE num_line.
        nn = nn + wa_ltrn-lfimg.
        zap = zap - 1.
      ENDIF.
    ENDAT.
    IF nn > 10.
      num_lin = num_lin - 1.
      CLEAR wa_ltrn.
    ELSE.
***********
      totwt = totwt + wa_ltrn-brgew.       "gross weight TOTAL
      totnt = totnt + wa_ltrn-ntgew.       "net weight TOTAL
      totsum = totsum + wa_ltrn-netwr.     "amount with VAT  TOTAL
      totplc = totplc + wa_ltrn-place.  "??? number of places
      totcas = totcas + wa_ltrn-handl_nbr.  " number of cases
      tot_tarag = tot_tarag + wa_ltrn-brgew.
      tot_gross = tot_gross + wa_ltrn-brgew.
      IF NOT wa_ltrn-matnr IS INITIAL.
        wa_tabnam-matnr = wa_ltrn-matnr.
        wa_tabnam-place = wa_ltrn-place.
        wa_tabnam-arktx = wa_ltrn-arktx.
        COLLECT wa_tabnam INTO tabnam.
      ENDIF.
************
      APPEND wa_ltrn TO ltrn.
    ENDIF.
    mm = num_lin.
    IF num_line EQ cnt AND num_lin < 10
       OR nn > 10 AND num_lin < 10.
      CLEAR wa_ltrn.
      DO.
        IF mm < 10.
          APPEND wa_ltrn TO ltrn.
          mm = mm + 1.
        ELSE.
          EXIT.
        ENDIF.
      ENDDO.
    ENDIF.
    IF mm = 10.
      ztrn-brgew = totwt.
      ztrn-ntgew = totnt.
      IF nast-kschl = 'ZU11'.
        ztrn-netwr = totsum.
      ENDIF.
      CLEAR mm.
      CLEAR it_venum3[].
      LOOP AT ltrn INTO wa_ltrn.
        CLEAR it_venum2[].
        CLEAR lines_v.
        SELECT venum FROM vepo INTO TABLE it_venum2
           WHERE vbeln EQ wa_ltrn-vbeln
             AND matnr EQ wa_ltrn-matnr
             AND posnr EQ wa_ltrn-posnr.
        DESCRIBE TABLE it_venum2 LINES lines_v.
        IF NOT lines_v IS INITIAL.
          LOOP AT it_venum2.
            it_venum3 = it_venum2.
            APPEND it_venum3.
          ENDLOOP.
        ENDIF.
      ENDLOOP.

      SORT it_venum3.
      DELETE ADJACENT DUPLICATES FROM it_venum3.
      LOOP AT it_venum3.
        SELECT SINGLE gewei tarag FROM vekp INTO (lv_gewei, lv_tot_tarag2)
          WHERE venum = it_venum3.
        PERFORM unit_conversion_simple USING lv_gewei tn
                                       CHANGING lv_tot_tarag2.
        tot_tarag = tot_tarag + lv_tot_tarag2.
      ENDLOOP.

      ztrn-tot_tarag = tot_tarag.
      ztrn-tot_gross = tot_gross.
      PERFORM itogi.
      CLEAR wa_ltrn. CLEAR num_lin. CLEAR zap.
* IMP RU Begin of delete
* BADI: update page 2 and totals
*  IF gc_badi_name IS BOUND.
*    CALL BADI gc_badi_name->UPDATE_TOTALS
*      exporting
*         i_ltrn   = ltrn
*      changing
*         i_ztrn   = ztrn
*         i_tabnam = tabnam
*      exceptions
*         OTHERS   = 1.
*    IF sy-subrc <> 0.
*      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                  WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*    ENDIF.
*  endif.
* IMP RU End of delete
      PERFORM print_pdf.
      REFRESH ltrn. CLEAR wa_tabnam. REFRESH tabnam.
      CLEAR totwt. CLEAR totnt. CLEAR totsum. CLEAR totplc. CLEAR totcas. CLEAR tot_tarag. CLEAR tot_gross.
      numnakl = numnakl + 1.
      pp = numnakl.
      CONCATENATE ztrn-tknum '/' pp INTO ztrn-tknum.
      IF nn > 10.
        CLEAR nn.
        MOVE z_ltrn TO wa_ltrn.
        num_lin = num_lin + 1.
        nn = nn + 1.
***********
        totwt = totwt + wa_ltrn-brgew.
        totnt = totnt + wa_ltrn-ntgew.
        totsum = totsum + wa_ltrn-netwr.
        totplc = totplc + wa_ltrn-place.  "??? number of places
        totcas = totcas + wa_ltrn-handl_nbr.
        tot_tarag = tot_tarag + wa_ltrn-brgew.
        tot_gross = tot_gross + wa_ltrn-brgew.
        IF NOT wa_ltrn-matnr IS INITIAL.
          wa_tabnam-matnr = wa_ltrn-matnr.
          wa_tabnam-place = wa_ltrn-place.
          COLLECT wa_tabnam INTO tabnam.
        ENDIF.
************
        APPEND wa_ltrn TO ltrn.
      ENDIF.
    ENDIF.
  ENDLOOP.

  PERFORM close_form_pdf.
ENDFORM.                    "PRINT_FORM


*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM protocol_update.

  CHECK xscreen = false.               "output on printer

  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4.

ENDFORM.                    "PROTOCOL_UPDATE

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM get_data.

  DATA: shipment_num LIKE vttk-tknum,
        cmr_record   TYPE cmr_type,
        sadr_begin   LIKE sadr,
        sadr_end     LIKE sadr,
        cmr_xvtts    LIKE xvtts OCCURS 0 WITH HEADER LINE.
  "print relevant segments
  DATA: flag TYPE boolean, ln TYPE i.

  SELECT SINGLE spras FROM t002c INTO language
     WHERE spras = 'R'
       AND lainst = 'X'.
  IF sy-subrc EQ 0.
    SET LANGUAGE language.
  ELSE.
    language = sy-langu.
  ENDIF.

  shipment_num = nast-objky.
  CLEAR ztrn.


  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DELIVERY_PRINT_VIEW'
    EXPORTING
      comwa = vbco3
    IMPORTING
      kopf  = vbdkl
    TABLES
      pos   = tvbdpl.

  t_vbdpl[] = tvbdpl[].
  slk = vbdkl.
  APPEND slk.


* *  Begin of mod-001
  CLEAR g_ind.

  SELECT *
    FROM yse_kpp
    INTO TABLE gt_kpp
    WHERE spras EQ nast-spras.
*End of mod-001

  CLEAR slp[].
  LOOP AT t_vbdpl INTO wa_vbdpl.
    "Begin of mod-001
    IF g_ind NE  'X'.
      CLEAR wa_kpp.
      READ TABLE gt_kpp INTO wa_kpp
              WITH KEY werks = wa_vbdpl-werks
                       spras = nast-spras
               BINARY SEARCH.
      IF sy-subrc EQ 0.
        g_ind = 'X'.
      ENDIF.
    ENDIF.
    "End of mod-001

    MOVE-CORRESPONDING wa_vbdpl TO slp.
    APPEND slp.
  ENDLOOP.


*  CALL FUNCTION 'RV_SHIPMENT_PRINT_VIEW'
*       EXPORTING
*            SHIPMENT_NUMBER     = SHIPMENT_NUM
*            OPTION_TVTK         = TRUE          "Shipmenttype Y/N
*            OPTION_TTDS         = TRUE          "Disposition Y/N
*            LANGUAGE            = LANGUAGE
*            OPTION_ITEMS        = TRUE          "Transport Items Y/N
*            OPTION_SALES_ORDERS = TRUE          "Transport Segments Y/N
*            OPTION_EXPORT_DATA  = TRUE          "Partners Y/N
*            OPTION_SEGMENTS     = TRUE          "Sales orders Y/N
*            OPTION_PARTNERS     = TRUE          "Export data Y/N
*            OPTION_PACKAGES     = TRUE          "Packages Y/N
*            OPTION_FLOW         = TRUE          "Flow Y/N
*            OPTION_NO_REFRESH   = FALSE         "Refresh Tables Y/N
*       IMPORTING
*            F_VTTKVB            = VTTKVB        "Shipment Head
*            F_TVTK              = TVTK          "Shipmenttype
*            F_TVTKT             = TVTKT         "Description Shipmenttye
*            F_TTDS              = TTDS          "Disposition
*            F_TTDST             = TTDST         "Description Disposition
*            F_VBPLA             = VBPLA         "Packages
*       TABLES
*            F_VTTP              = XVTTP         "Shipment Items
*            F_TRLK              = SLK           "Delivery
*            F_TRLP              = SLP           "Delivery Item
*            F_VTTS              = XVTTS         "Shipment Segments
*            F_VTSP              = XVTSP         "Segments/Items
*            F_VBPA              = XVBPA         "Partner
*            F_VBADR             = XVBADR        "Address
*            F_VTFA              = XVTFA         "Flow
*            F_VBPLK             = XVBPLK        "Shipment Unit Header
*            F_VBPLP             = XVBPLP        "Shipment Unit
*            F_VBPLS             = XVBPLS        "Shipment Unit Sum
*       EXCEPTIONS
*            NOT_FOUND           = 1
*            OTHERS              = 2.

  IF NOT ( sy-subrc IS INITIAL ).
* save protocol record
    protocol_tab-msg_arbgb = 'VW'.
    protocol_tab-msg_nr    = '010'.
    protocol_tab-msg_ty    = 'E'.
    protocol_tab-msg_v1    = shipment_num.
    APPEND protocol_tab.
* set flag nothing to print
    something_to_print = false.
  ELSE.

    SELECT SINGLE wadat FROM likp INTO lv_gi_date
     WHERE vbeln = slk-vbeln.

*    ztrn-tknum = vttkvb-tknum.
    ztrn-erdat = lv_gi_date.
    ztrn-p_day = lv_gi_date+6.
    ztrn-p_month = lv_gi_date+4(2).
    ztrn-p_gjahr = lv_gi_date(4).
* expeditor adress
    SELECT SINGLE adrnr FROM lfa1 INTO sel-addrnumber
      WHERE lifnr EQ vttkvb-tdlnr.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = sel-addrnumber
      IMPORTING
        output = sel-addrnumber.
    CLEAR addr1_val.
    sel-nation = 'R'.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        address_selection = sel
      IMPORTING
        address_value     = addr1_val
      EXCEPTIONS
        parameter_error   = 1
        address_not_exist = 2
        version_not_exist = 3
        internal_error    = 4
        OTHERS            = 5.
    IF sy-subrc NE 0.
      CLEAR sel-nation.
      CALL FUNCTION 'ADDR_GET'
        EXPORTING
          address_selection = sel
        IMPORTING
          address_value     = addr1_val
        EXCEPTIONS
          parameter_error   = 1
          address_not_exist = 2
          version_not_exist = 3
          internal_error    = 4
          OTHERS            = 5.
    ENDIF.
    CONCATENATE ztrn-eknam addr1_val-name1 addr1_val-name2
       addr1_val-name3 addr1_val-post_code1 addr1_val-city1
       addr1_val-city2 addr1_val-street addr1_val-house_num1
       addr1_val-tel_number INTO ztrn-eknam SEPARATED BY space.

    CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
         EXPORTING
              user_name              = vttkvb-ernam
         IMPORTING
*            USER_ADDRESS           = USER_ADDRESS
              user_usr03             = usr03
         EXCEPTIONS
              user_address_not_found = 1
              OTHERS                 = 2.                   "USR0340A

    IF sy-subrc NE 0.
      CLEAR protocol_tab.
*    PROTOCOL_TAB-MSORT = '    '.
      protocol_tab-msg_arbgb = 'FB'.
      protocol_tab-msg_ty = 'I'.
      protocol_tab-msg_nr = '240'.
      protocol_tab-msg_v1 = vttkvb-ernam.
      APPEND protocol_tab.
    ENDIF.
    ztrn-name1 = usr03-name1.
    ztrn-name2 = usr03-name2.
    ztrn-telnr = usr03-telnr.

*the first line of leg
*    PERFORM GET_LEGS_TO_PRINT TABLES CMR_XVTTS.
*  CLEAR:   CMR_XVTTS.
*  REFRESH: CMR_XVTTS.

*  SORT XVTTS BY TSRFO.
* check legs
*  LOOP AT XVTTS.
*    PERFORM CHECK_PRINT_RELEVANCE USING    XVTTS
*                                  CHANGING FLAG.
* exit if the first print-relevant leg was found
*    move XVTTS TO CMR_XVTTS.
*    APPEND CMR_XVTTS.
*    EXIT.
*  ENDLOOP.

    flag = true.
*    LOOP AT CMR_XVTTS.   "the first line of leg
*      CLEAR: CMR_RECORD,
*             SADR_BEGIN,
*             SADR_END.
** get address data of leg (begin and end)
*      PERFORM GET_ADDRESS_DATA_OF_LEG USING CMR_XVTTS
*                                     SADR_BEGIN
*                                     SADR_END.
** set country and language
*      CMR_RECORD-COUNTRY  = SADR_BEGIN-LAND1.
*      CMR_RECORD-LANGUAGE = SY-LANGU.
*      SELECT SINGLE SPRAS INTO CMR_RECORD-LANGUAGE FROM T005
*                          WHERE LAND1 = CMR_RECORD-COUNTRY.
*      APPEND CMR_RECORD TO CMR_FORM.

*********

    seqnum = 0.
    CLEAR wa_ltrn. REFRESH ltrn.
    CLEAR wa_tabnam. REFRESH tabnam.
    CLEAR num_lin.
    CLEAR totplc. CLEAR totsum. CLEAR totcas. CLEAR tot_tarag. CLEAR tot_gross.
    CLEAR: ztrn-gewei, ztrn-brgew, ztrn-ntgew.
    CLEAR tt_ltr. REFRESH tt_ltr.
* IMP RU Begin of delete
*    clear: vkorg, kunwe, vstel, kunag.
*    sort slk by vkorg kunwe vstel kunag.
* IMP RU End of delete

* IMP RU Begin of insert
    CLEAR: vkorg, kunwe, vstel, kunag.
    SORT slk BY vkorg kunwe vstel kunag.
* IMP RU End of insert

    LOOP AT slk.  " delivery heads
      IF sy-tabix EQ 1.
        save_bukrs = slk-bukrs.
        SELECT SINGLE paval FROM t001z INTO ztrn-chief_acc
           WHERE bukrs EQ save_bukrs
             AND   party EQ 'SAPR15'.
      ENDIF.
*********************************************
      IF sy-tabix NE 1.
* IMP RU Begin of delete
*       if slk-vkorg ne vkorg or slk-kunwe ne kunwe or
*          slk-vstel ne vstel or slk-kunag ne kunag.
* IMP RU End of delete

        seqnum = seqnum + 1.
        CONCATENATE vttkvb-tknum '-' seqnum INTO ztrn-tknum.
        SHIFT ztrn-tknum LEFT DELETING LEADING '0'.
        PERFORM print_form.
        CLEAR wa_ltrn. REFRESH ltrn.
        CLEAR wa_tabnam. REFRESH tabnam.
        CLEAR num_lin.
        CLEAR totplc. CLEAR totsum. CLEAR totcas. CLEAR tot_tarag. CLEAR tot_gross.
        CLEAR: ztrn-gewei, ztrn-brgew, ztrn-ntgew.
        CLEAR tt_ltr. REFRESH tt_ltr.
* IMP RU Begin of delete
*       endif.
* IMP RU end of delete
      ENDIF.
**************************************************
* IMP RU Begin of delete
*  if vstel ne slk-vstel.
* departure point adress
*    vstel = slk-vstel.
* IMP RU End of delete

      sel-addrnumber = slk-adrnr_vst.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = sel-addrnumber
        IMPORTING
          output = sel-addrnumber.
      sel-nation = 'R'.
      CLEAR addr1_val.
      CALL FUNCTION 'ADDR_GET'
        EXPORTING
          address_selection = sel
        IMPORTING
          address_value     = addr1_val
        EXCEPTIONS
          parameter_error   = 1
          address_not_exist = 2
          version_not_exist = 3
          internal_error    = 4
          OTHERS            = 5.

      IF sy-subrc NE 0.
        CLEAR sel-nation.
        CALL FUNCTION 'ADDR_GET'
          EXPORTING
            address_selection = sel
          IMPORTING
            address_value     = addr1_val
          EXCEPTIONS
            parameter_error   = 1
            address_not_exist = 2
            version_not_exist = 3
            internal_error    = 4
            OTHERS            = 5.
      ENDIF.
* IMP RU Begin of delete
*    concatenate ztrn-ponam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*       ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*       ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*       ADDR1_VAL-TEL_NUMBER into ztrn-ponam separated by space.
*  endif.
* IMP RU End of delete

* IMP RU Begin of insert
      CLEAR lv_landx50.
      CLEAR lv_region.

      SELECT SINGLE landx50 FROM t005t INTO lv_landx50
         WHERE spras = language
           AND land1 = addr1_val-country.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
      SELECT SINGLE bezei FROM t005u INTO lv_region
        WHERE spras = language
          AND land1 = addr1_val-country
          AND bland = addr1_val-region.
*endif.

      CONCATENATE
          lv_landx50 addr1_val-post_code1 lv_region
          addr1_val-city2 addr1_val-city1 addr1_val-home_city
          addr1_val-street addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
          addr1_val-roomnumber addr1_val-tel_number INTO ztrn-ponam SEPARATED BY ', '.

      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-ponam WITH ','.
      REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-ponam WITH ','.
      CLEAR int1.
      int1 = STRLEN( ztrn-ponam ).
      IF int1 > 1.
        int1 = int1 - 1.
        ztrn-ponam = ztrn-ponam+0(int1).
      ENDIF.
* IMP RU End of insert


* IMP RU Begin of delete
*  if slk-kunwe ne kunwe.
*    kunwe = slk-kunwe.
* IMP RU End of delete



* IMP RU Begin of insert
* bill to partner

      SELECT SINGLE adrnr kunnr FROM vbpa INTO (adrnr_re, kunnr_re)
        WHERE parvw = 'RE' AND vbeln = slk-vbeln_vauf.

      sel-addrnumber = adrnr_re.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = sel-addrnumber
        IMPORTING
          output = sel-addrnumber.
      sel-nation = 'R'.
      CLEAR addr1_val.
      CALL FUNCTION 'ADDR_GET'
        EXPORTING
          address_selection = sel
        IMPORTING
          address_value     = addr1_val
        EXCEPTIONS
          parameter_error   = 1
          address_not_exist = 2
          version_not_exist = 3
          internal_error    = 4
          OTHERS            = 5.

      IF sy-subrc NE 0.
        CLEAR sel-nation.
        CALL FUNCTION 'ADDR_GET'
          EXPORTING
            address_selection = sel
          IMPORTING
            address_value     = addr1_val
          EXCEPTIONS
            parameter_error   = 1
            address_not_exist = 2
            version_not_exist = 3
            internal_error    = 4
            OTHERS            = 5.
      ENDIF.

      CLEAR lv_landx50.
      CLEAR lv_region.

      SELECT SINGLE landx50 FROM t005t INTO lv_landx50
            WHERE spras = language
              AND land1 = addr1_val-country.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
      SELECT SINGLE bezei FROM t005u INTO lv_region
        WHERE spras = language
          AND land1 = addr1_val-country
          AND bland = addr1_val-region.
*endif.

      CONCATENATE
          addr1_val-name1 addr1_val-name2 addr1_val-name3 addr1_val-name4 lv_landx50 addr1_val-post_code1 lv_region
          addr1_val-city2 addr1_val-city1 addr1_val-home_city
          addr1_val-street addr1_val-str_suppl1 addr1_val-str_suppl2 addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
          addr1_val-roomnumber addr1_val-tel_number INTO ztrn-renam SEPARATED BY ', '.

      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-renam WITH ','.
      CLEAR int1.
      int1 = STRLEN( ztrn-renam ).
      IF int1 > 1.
        int1 = int1 - 1.
        ztrn-renam = ztrn-renam+0(int1).
      ENDIF.

* IMP RU End of insert


* Destination address

      sel-addrnumber = slk-adrnr_we.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = sel-addrnumber
        IMPORTING
          output = sel-addrnumber.
      sel-nation = 'R'.
      CLEAR addr1_val.
      CALL FUNCTION 'ADDR_GET'
           EXPORTING
                address_selection = sel
           IMPORTING
                address_value     = addr1_val
*              SADR              = SADR
           EXCEPTIONS
                parameter_error   = 1
                address_not_exist = 2
                version_not_exist = 3
                internal_error    = 4
                OTHERS            = 5.
      IF sy-subrc NE 0.
        CLEAR sel-nation.
        CALL FUNCTION 'ADDR_GET'
          EXPORTING
            address_selection = sel
          IMPORTING
            address_value     = addr1_val
          EXCEPTIONS
            parameter_error   = 1
            address_not_exist = 2
            version_not_exist = 3
            internal_error    = 4
            OTHERS            = 5.
      ENDIF.

* IMP RU Begin of delete
*    concatenate ztrn-prnam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*       ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*       ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*       ADDR1_VAL-TEL_NUMBER into ztrn-prnam separated by space.
* IMP RU End of delete

      CLEAR ztrn-gpnam.
* goods receiver adress


* IMP RU BEGIN INSERT

      CLEAR lv_landx50.
      CLEAR lv_region.

      SELECT SINGLE landx50 FROM t005t INTO lv_landx50
               WHERE spras = language
                 AND land1 = addr1_val-country.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
      SELECT SINGLE bezei FROM t005u INTO lv_region
        WHERE spras = language
          AND land1 = addr1_val-country
          AND bland = addr1_val-region.
*endif.

      CONCATENATE
          lv_landx50 addr1_val-post_code1 lv_region
          addr1_val-city2 addr1_val-city1 addr1_val-home_city
          addr1_val-street addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
          addr1_val-roomnumber addr1_val-tel_number INTO ztrn-gpnam SEPARATED BY ','.

      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-gpnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-gpnam WITH ','.
      CLEAR int1.
      int1 = STRLEN( ztrn-gpnam ).
      IF int1 > 1.
        int1 = int1 - 1.
        ztrn-gpnam = ztrn-gpnam+0(int1).
      ENDIF.

      IF nast-kschl = 'ZU11' OR nast-kschl = 'ZU12'.
        CLEAR ztrn-gpnam.
      ENDIF.
* IMP RU END INSERT

* IMP RU Begin of delete
*  endif.
* IMP RU End of delete

* IMP RU Begin of delete
*  if slk-vkorg ne vkorg.
*      vkorg = slk-vkorg.
* IMP RU End of delete
* IMP RU Begin of insert
      SELECT SINGLE adrnr FROM tvko INTO adrnr_vkorg
        WHERE vkorg = slk-vkorg.
* IMP RU End of insert
* goods consignor adress

      sel-addrnumber = adrnr_vkorg.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = sel-addrnumber
        IMPORTING
          output = sel-addrnumber.

      sel-nation = 'R'.
      CLEAR addr1_val.
      CALL FUNCTION 'ADDR_GET'
        EXPORTING
          address_selection = sel
        IMPORTING
          address_value     = addr1_val
        EXCEPTIONS
          parameter_error   = 1
          address_not_exist = 2
          version_not_exist = 3
          internal_error    = 4
          OTHERS            = 5.
      IF sy-subrc NE 0.
        CLEAR sel-nation.
        CALL FUNCTION 'ADDR_GET'
          EXPORTING
            address_selection = sel
          IMPORTING
            address_value     = addr1_val
          EXCEPTIONS
            parameter_error   = 1
            address_not_exist = 2
            version_not_exist = 3
            internal_error    = 4
            OTHERS            = 5.
      ENDIF.

      CLEAR ztrn-gonam.
* IMP RU Begin of delete
*      concatenate ztrn-gonam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*         ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*         ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*         ADDR1_VAL-TEL_NUMBER into ztrn-gonam separated by space.
* IMP RU End of delete

* IMP RU BEGIN INSERT

      CLEAR lv_landx50.
      CLEAR lv_region.

      SELECT SINGLE landx50 FROM t005t INTO lv_landx50
               WHERE spras = language
                 AND land1 = addr1_val-country.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
      SELECT SINGLE bezei FROM t005u INTO lv_region
        WHERE spras = language
          AND land1 = addr1_val-country
          AND bland = addr1_val-region.
*endif.

      CONCATENATE
          addr1_val-name1 addr1_val-name2
          addr1_val-name3 addr1_val-name4 lv_landx50 addr1_val-post_code1 lv_region
          addr1_val-city2 addr1_val-city1 addr1_val-home_city
          addr1_val-street addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
          addr1_val-roomnumber addr1_val-tel_number INTO ztrn-gonam SEPARATED BY ', '.

      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-gonam WITH ','.
      REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-gonam WITH ','.
      CLEAR int1.
      int1 = STRLEN( ztrn-gonam ).
      IF int1 > 1.
        int1 = int1 - 1.
        ztrn-gonam = ztrn-gonam+0(int1).
      ENDIF.
* IMP RU END INSERT

* IMP RU Begin of delete
*  endif.
* IMP RU End of delete

* IMP RU Begin of delete
*  if slk-kunag ne kunag.
*     kunag = slk-kunag.
* IMP RU End of delete

* payer adress
      sel-addrnumber = slk-adrnr_ag.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = sel-addrnumber
        IMPORTING
          output = sel-addrnumber.
      sel-nation = 'R'.
      CLEAR addr1_val.
      CALL FUNCTION 'ADDR_GET'
        EXPORTING
          address_selection = sel
        IMPORTING
          address_value     = addr1_val
        EXCEPTIONS
          parameter_error   = 1
          address_not_exist = 2
          version_not_exist = 3
          internal_error    = 4
          OTHERS            = 5.
      IF sy-subrc NE 0.
        CLEAR sel-nation.
        CALL FUNCTION 'ADDR_GET'
          EXPORTING
            address_selection = sel
          IMPORTING
            address_value     = addr1_val
          EXCEPTIONS
            parameter_error   = 1
            address_not_exist = 2
            version_not_exist = 3
            internal_error    = 4
            OTHERS            = 5.
      ENDIF.

      CLEAR ztrn-plnam.
* IMP RU BEGIN DELETE
*        concatenate ztrn-plnam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*           ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*           ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*           ADDR1_VAL-TEL_NUMBER into ztrn-plnam separated by space.
* IMP RU BEGIN DELETE

* IMP RU BEGIN INSERT
      SELECT SINGLE landx50 FROM t005t INTO lv_landx50
               WHERE spras = language
                 AND land1 = addr1_val-country.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
      SELECT SINGLE bezei FROM t005u INTO lv_region
        WHERE spras = language
          AND land1 = addr1_val-country
          AND bland = addr1_val-region.
*endif.

      CONCATENATE
          addr1_val-name1 addr1_val-name2 addr1_val-name3 addr1_val-name4 lv_landx50 addr1_val-post_code1 lv_region
          addr1_val-city2 addr1_val-city1 addr1_val-home_city
          addr1_val-street addr1_val-str_suppl1 addr1_val-str_suppl2 addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
          addr1_val-roomnumber addr1_val-tel_number INTO ztrn-plnam SEPARATED BY ', '.

      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-renam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-plnam WITH ','.
      REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-plnam WITH ','.
      CLEAR int1.
      int1 = STRLEN( ztrn-plnam ).
      IF int1 > 1.
        int1 = int1 - 1.
        ztrn-plnam = ztrn-plnam+0(int1).
      ENDIF.
* IMP RU END INSERT

* IMP RU Begin of delete
*  endif.
* IMP RU End of delete

* IMP RU Begin insert
* Retrieve Header data: Sales Order Nbr

      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = slk-vbeln_vauf
        IMPORTING
          output = ztrn-salord.

* Retrieve Header data: Outbound Delivery Number + Shipment Number.
      CLEAR lv_vbeln.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = slk-vbeln
        IMPORTING
          output = lv_vbeln.

      CLEAR lv_tknum.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = ztrn-tknum
        IMPORTING
          output = lv_tknum.

      ztrn-outb_shipnr = lv_vbeln.

* Retrieve OKPO Code
      SELECT SINGLE bukrs FROM tvko INTO lv_bukrs WHERE vkorg = slk-vkorg.

      SELECT SINGLE paval FROM t001z INTO ztrn-sapr02
        WHERE bukrs EQ lv_bukrs
        AND   party EQ 'SAPR02'.

* Retrieve GI date (GI date not used anymore, now the creation date is used):

      SELECT SINGLE erdat FROM likp INTO lv_gi_date
       WHERE vbeln = slk-vbeln.

      ztrn-lv_day = lv_gi_date+6.
      ztrn-lv_month = lv_gi_date+4(2).
      ztrn-lv_year = lv_gi_date(4).
      ztrn-lv_gi_date = lv_gi_date.

* Retrieve VAT code AG (sold-to Partner)
      SELECT SINGLE stcd1 FROM kna1 INTO
         ztrn-stceg_ag
        WHERE kunnr EQ slk-kunag.

* Retrieve VAT code AG (sold-to Partner)
      SELECT SINGLE stcd3 FROM kna1 INTO
         ztrn-stceg_re
        WHERE kunnr EQ kunnr_re.

* IMP RU End insert

* convert all units to t
      PERFORM unit_conversion_simple USING slk-gewei tn
                                  CHANGING slk-brgew.

      PERFORM unit_conversion_simple USING slk-gewei tn
                                  CHANGING slk-ntgew.
      slk-gewei = tn.
      ztrn-gewei = slk-gewei.
      ztrn-brgew = ztrn-brgew + slk-brgew.
      ztrn-ntgew = ztrn-ntgew + slk-ntgew.
      PERFORM item_print.
    ENDLOOP.
  ENDIF.
ENDFORM.                    "GET_DATA

*&---------------------------------------------------------------------*
*&      Form  ITOGI
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM itogi.

* IMP RU Begin of insert
* Unique HU's
  SORT tt_hu BY venum.
  DELETE ADJACENT DUPLICATES FROM tt_hu COMPARING venum.
* retrieve Net weight/Gross weight in digits + wordings per HU

*Calculate total (unique) cases
*    clear i_totcas[].
*    select venum count(*) from vepo into table i_totcas
*    where vbeln eq slk-VBELN
*    group by venum.
*    describe table i_totcas lines totcas.


*  TOT_TARAG = TOT_TARAG / 10.
*
*clear ztrn-tot_tarag_w.
*if tot_tarag is not initial.
*  CALL FUNCTION 'SPELL_AMOUNT'
*       EXPORTING
*            AMOUNT    = TOT_TARAG
*            CURRENCY  = 'ZCURR'        "######### ###### ### #¨¤####¨¬-
*            FILLER    = ' '            "### ¨¤##### SPELL
*            LANGUAGE  = language
*       IMPORTING
*            IN_WORDS  = SPELL
*       EXCEPTIONS
*            NOT_FOUND = 1
*            TOO_LARGE = 2
*            OTHERS    = 3.
*  ztrn-tot_tarag_w = SPELL-WORD.
* endif.

*clear ztrn-tot_gross_w.
*if tot_gross is not initial.
*TOT_GROSS = TOT_GROSS / 10.
*
*  CALL FUNCTION 'SPELL_AMOUNT'
*       EXPORTING
*            AMOUNT    = TOT_GROSS
*            CURRENCY  = 'ZCURR'        "######### ###### ### #¨¤####¨¬-
*            FILLER    = ' '            "### ¨¤##### SPELL
*            LANGUAGE  = language
*       IMPORTING
*            IN_WORDS  = SPELL
*       EXCEPTIONS
*            NOT_FOUND = 1
*            TOO_LARGE = 2
*            OTHERS    = 3.
*  ztrn-tot_gross_w = SPELL-WORD.
*endif.




* IMP RU End of insert

*    describe table ltrn lines num_line.  "Number of records
  sum  = zap / 10.

  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = sum
      currency  = 'ZCURR'        "######### ###### ### #¨¤####¨¬-
      filler    = ' '            "### ¨¤##### SPELL
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  ztrn-totlin = spell-word.


  sum  = totplc / 10.
  ztrn-tot_plc_n = totplc.
  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = sum
      currency  = 'ZCURR'
      filler    = ' '
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  ztrn-totplc = spell-word.

* IMP RU Begin of insert
  sum2  = totcas / 10.

  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = sum2
      currency  = 'ZCURR'
      filler    = ' '
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  ztrn-totcas = spell-word.
* IMP RU End of insert

  IF totsum IS NOT INITIAL.
    CALL FUNCTION 'SPELL_AMOUNT'
      EXPORTING
        amount    = totsum
        currency  = hdoc-waerk     " ###### ######### ¨¢####
        filler    = ' '
        language  = language
      IMPORTING
        in_words  = spell
      EXCEPTIONS
        not_found = 1
        too_large = 2
        OTHERS    = 3.
    CONCATENATE spell-word spell-decimal(2) text-001
       INTO ztrn-totsum SEPARATED BY space.
  ENDIF.

  DESCRIBE TABLE tabnam LINES num_lin.  "Number of records
  sum  = num_lin / 10.
  "### ###### ######¨¢### ############
  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = sum
      currency  = 'ZCURR'        "######### ###### ### #¨¤####¨¬-
      filler    = ' '            "### ¨¤##### SPELL
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  ztrn-totnam = spell-word.

  CLEAR num_lin.
*    clear totplc. clear TOTSUM.

ENDFORM.                    "ITOGI

**---------------------------------------------------------------------*
**       FORM GET_ADDRESS_DATA_OF_LEG                                  *
**---------------------------------------------------------------------*
**       ........                                                      *
**---------------------------------------------------------------------*
**  -->  LEG                                                           *
**  -->  SADR_BEGIN                                                    *
**  -->  SADR_END                                                      *
**---------------------------------------------------------------------*
*FORM GET_ADDRESS_DATA_OF_LEG USING LEG          LIKE      XVTTS
*                                   SADR_BEGIN   STRUCTURE SADR  "SADR40A
*                                   SADR_END     STRUCTURE SADR. "SADR40A
*
*  DATA:
*    L_DEPT LIKE LOC_DEPT,
*    L_DEST LIKE LOC_DEST.
*
*  MOVE-CORRESPONDING LEG TO L_DEPT.
*  CALL FUNCTION 'ST_LOCATION_ADDR_READ'
*       EXPORTING
*            I_LOCATION         = L_DEPT
*       IMPORTING
*            E_SADR             = SADR_BEGIN
*       EXCEPTIONS
*            ADDRESS_NOT_FOUND  = 1
*            OTHERS             = 2.
*  IF SY-SUBRC NE 0.
*    SYST-MSGID = 'VW'.
*    SYST-MSGNO = '002'.
*    SYST-MSGTY = 'E'.
*    SYST-MSGV1 = TEXT-001.
*    SYST-MSGV2 = 'SADR'.
*    PERFORM PROTOCOL_UPDATE.
**    CLEAR SADR_BEGIN.
*  ENDIF.
*
*  MOVE-CORRESPONDING LEG TO L_DEST.
*  CALL FUNCTION 'ST_LOCATION_ADDR_READ'
*       EXPORTING
*            I_LOCATION         = L_DEST
*       IMPORTING
*            E_SADR             = SADR_END
*       EXCEPTIONS
*            ADDRESS_NOT_FOUND  = 1
*            OTHERS             = 2.
*  IF SY-SUBRC NE 0.
*    SYST-MSGID = 'VW'.
*    SYST-MSGNO = '002'.
*    SYST-MSGTY = 'E'.
*    SYST-MSGV1 = TEXT-001.
*    SYST-MSGV2 = 'SADR'.
*    PERFORM PROTOCOL_UPDATE.
*    CLEAR SADR_END.
*  ENDIF.
*
*ENDFORM.

*---------------------------------------------------------------------*
*       FORM UNIT_CONVERSION_SIMPLE                                   *
*---------------------------------------------------------------------*
FORM unit_conversion_simple USING value(unit_in)  LIKE t006-msehi
                                  value(unit_out) LIKE t006-msehi
                         CHANGING input TYPE any.
  IF NOT unit_in IS INITIAL.
    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = input
        unit_in  = unit_in
        unit_out = unit_out
      IMPORTING
        output   = input.
  ENDIF.
ENDFORM.                    "UNIT_CONVERSION_SIMPLE

**---------------------------------------------------------------------*
**       FORM GET_LEGS_TO_PRINT                                        *
**---------------------------------------------------------------------*
**       ........                                                      *
**---------------------------------------------------------------------*
**  -->  LEGS_TAB                                                      *
**---------------------------------------------------------------------*
*FORM GET_LEGS_TO_PRINT TABLES LEGS_TAB STRUCTURE XVTTS.
*
**  DATA: FLAG TYPE BOOLEAN.
*
*  CLEAR:   LEGS_TAB.
*  REFRESH: LEGS_TAB.
** save protocol record (general)
*  PROTOCOL_TAB-MSG_ARBGB = 'VW'.
*  PROTOCOL_TAB-MSG_NR    = '080'.
*  PROTOCOL_TAB-MSG_TY    = 'E'.
*  PROTOCOL_TAB-MSG_V1    = VTTKVB-TKNUM.
*  APPEND PROTOCOL_TAB.
*
** set there is nothing to print if there are no legs
**  SOMETHING_TO_PRINT = FALSE.
*
*  SORT XVTTS BY TSRFO.
** check legs
*  LOOP AT XVTTS.
**    PERFORM CHECK_PRINT_RELEVANCE USING    XVTTS
**                                  CHANGING FLAG.
** exit if the first print-relevant leg was found
**    IF ( FLAG = TRUE ).
*      APPEND XVTTS TO LEGS_TAB.
*      EXIT.
**    ENDIF.
*  ENDLOOP.
*
*ENDFORM.

**---------------------------------------------------------------------*
**       FORM CHECK_PRINT_RELEVANCE                                    *
**---------------------------------------------------------------------*
**       ........                                                      *
**---------------------------------------------------------------------*
**  -->  LEG                                                           *
**  -->  FLAG                                                          *
**---------------------------------------------------------------------*
*FORM CHECK_PRINT_RELEVANCE USING    LEG LIKE XVTTS
*                           CHANGING FLAG.
*
*  FLAG = FALSE.
*  SOMETHING_TO_PRINT = FALSE.
*
*  IF ( LEG-LAUFK = LAUFK-1 ) OR ( LEG-LAUFK = LAUFK-4 ).
*    IF ( LEG-TDLNR = NAST-PARNR ).
*      FLAG = TRUE.
*      SOMETHING_TO_PRINT = TRUE.
*    ELSE.
** save protocol record (wrong laufk)
*      PROTOCOL_TAB-MSG_ARBGB = 'VW'.
*      PROTOCOL_TAB-MSG_NR    = '082'.
*      PROTOCOL_TAB-MSG_TY    = 'I'.
*      PROTOCOL_TAB-MSG_V1    = LEG-TSNUM.
*      APPEND PROTOCOL_TAB.
*    ENDIF.
*  ELSE.
** save protocol record (wrong tdlnr)
*    PROTOCOL_TAB-MSG_ARBGB = 'VW'.
*    PROTOCOL_TAB-MSG_NR    = '081'.
*    PROTOCOL_TAB-MSG_TY    = 'I'.
*    PROTOCOL_TAB-MSG_V1    = LEG-TSNUM.
*    APPEND PROTOCOL_TAB.
*  ENDIF.
*
*ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_SHIPING_UNITS                                        *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VBPLK_TO_CHECK                                                *
*  -->  VBPLK_TO_PRINT                                                *
*---------------------------------------------------------------------*
FORM get_shiping_units TABLES vbplk_to_check STRUCTURE xvbplk
                              vbplk_to_print STRUCTURE xvbplk.

  DATA: lin     LIKE sy-tabix.
  DATA: h_vbplk LIKE vbplk OCCURS 0.

  DESCRIBE TABLE vbplk_to_check LINES lin.

  CHECK NOT ( lin IS INITIAL ).

* print-relevant shiping units
  LOOP AT vbplk_to_check WHERE ( veltp <> veltp_tpm ).
    APPEND vbplk_to_check TO vbplk_to_print.
    DELETE vbplk_to_check.
  ENDLOOP.

* get child shiping units to check
  LOOP AT vbplk_to_check.
    LOOP AT xvbplk WHERE ( uevel = vbplk_to_check-venum ).
      APPEND xvbplk TO h_vbplk.
    ENDLOOP.
  ENDLOOP.

  REFRESH: vbplk_to_check.
  vbplk_to_check[] = h_vbplk[].

* check child shiping units
  PERFORM get_shiping_units TABLES vbplk_to_check
                                   vbplk_to_print.

ENDFORM.                    "GET_SHIPING_UNITS

*&---------------------------------------------------------------------*
*&      Form  ITEM_PRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_print.

  DATA: lin TYPE i, pr TYPE i, pr1 TYPE i.
  DATA: lv_exidv TYPE exidv.

  LOOP AT slp WHERE vbeln EQ slk-vbeln.
    IF slp-charg <> ' ' AND slp-matkl <> '03'.
      CLEAR tkomser. REFRESH tkomser.
      CLEAR wa_ltrn. CLEAR tt_ltr.
      MOVE-CORRESPONDING slp TO wa_ltrn.

      IF wa_ltrn-lfimg = 0.           "If number of items = 0 then don't output
        CONTINUE.                   "go to the next step
      ENDIF.
      num_line = num_line + 1.

      SELECT SINGLE mseht FROM t006a      "Unit of Measurement for item
             INTO wa_ltrn-mseht
      WHERE spras EQ language AND msehi EQ wa_ltrn-vrkme.

      "coefficients for conversion to base units of measure
      SELECT SINGLE * FROM marm
         WHERE matnr EQ wa_ltrn-matnr AND meinh EQ wa_ltrn-vrkme.
      stuz = marm-umrez.     stun = marm-umren.

      SELECT * FROM vbfa        "find billing document number
       WHERE   vbelv EQ slk-vbeln
         AND vbtyp_v EQ slk-vgtyp
           AND posnv EQ slp-posnr
         AND vbtyp_n EQ 'M'.
      ENDSELECT.
      IF sy-subrc NE 0.
        SELECT SINGLE * FROM vbfa      "find sales document number
         WHERE   vbeln EQ slk-vbeln
           AND vbelv EQ slp-vgbel
           AND vbtyp_v EQ slp-vgtyp
           AND vbtyp_n EQ slk-vbtyp
             AND posnn EQ slp-posnr
             AND posnv EQ slp-vgpos.

        SELECT SINGLE vbtyp kalsm waerk knumv auart
                         FROM vbak INTO     "Header of Sales Document
           (hdoc-vbtyp, hdoc-kalsm, hdoc-waerk, hdoc-knumv, hdoc-auart)
        WHERE vbeln = vbfa-vbelv.

* IMP RU Begin of insert Currency should always be RUB

        IF hdoc-waerk <> 'RUB'.
          lv_convert = 'X'.
          hdoc-waerk = 'RUB'.
        ENDIF.

* IMP RU End of insert Currency should always be RUB

* IMP RU Begin of chane Currency should always be RUB

*    SELECT SINGLE MATNR VRKME LSMENG KZWI3 KZWI4 KZWI5 KZWI6
*                  FROM VBAP INTO     "Find sales document position
*      (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
*      PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6)
*    WHERE   VBELN EQ VBFA-VBELV
*        AND POSNR EQ VBFA-POSNV.
        SELECT SINGLE matnr vrkme lsmeng kzwi3 kzwi4 kzwi5 kzwi6 cmpre
                      FROM vbap INTO     "Find sales document position
          (pdoc-matnr, pdoc-vrkme, pdoc-lsmeng,
          pdoc-kzwi3, pdoc-kzwi4, pdoc-kzwi5, pdoc-kzwi6, pdoc-cmpre)
        WHERE   vbeln EQ vbfa-vbelv
            AND posnr EQ vbfa-posnv.
* IMP RU End of chane Currency should always be RUB
        IF sy-subrc = 0.
          SELECT SINGLE * FROM marm      "Required quantity in base unit
             WHERE matnr EQ pdoc-matnr AND meinh EQ pdoc-vrkme.
          pdoc-lsmeng =
                        pdoc-lsmeng * marm-umrez / marm-umren.
        ENDIF.

      ELSE.
        SELECT SINGLE vbtyp kalsm waerk knumv fkart
                         FROM vbrk INTO   "Header of Billing Document
           (hdoc-vbtyp, hdoc-kalsm, hdoc-waerk, hdoc-knumv, hdoc-fkart)
        WHERE vbeln = vbfa-vbeln.
* IMP RU Begin of insert Currency should always be RUB

        IF hdoc-waerk <> 'RUB'.
          lv_convert = 'X'.
          hdoc-waerk = 'RUB'.
        ENDIF.

* IMP RU End of insert Currency should always be RUB

        SELECT SINGLE matnr vrkme fkimg kzwi3 kzwi4 kzwi5 kzwi6
                          FROM vbrp INTO    "Item of Billing Document
          (pdoc-matnr, pdoc-vrkme, pdoc-lsmeng,
          pdoc-kzwi3, pdoc-kzwi4, pdoc-kzwi5, pdoc-kzwi6)
        WHERE   vbeln EQ vbfa-vbeln
            AND posnr EQ vbfa-posnn.
        IF sy-subrc = 0.
          SELECT SINGLE * FROM marm       "Required quantity in base unit
             WHERE matnr EQ pdoc-matnr AND meinh EQ pdoc-vrkme.
          pdoc-lsmeng =
                        pdoc-lsmeng * marm-umrez / marm-umren.
          slp-vgpos = vbfa-posnn.
        ENDIF.

      ENDIF.

* Retrieve the type of package + nbr of cases
* IMP RU Begin of insert
      CLEAR lv_venum.
      CLEAR lv_vhart.
      CLEAR lv_exidv.
      CLEAR lv_laeng.
      CLEAR lv_breit.
      CLEAR lv_hoehe.
      CLEAR lv_gewei.
      CLEAR it_venum[].

      SELECT venum FROM vepo INTO TABLE it_venum
         WHERE vbeln EQ slk-vbeln
           AND matnr EQ pdoc-matnr
           AND werks EQ slp-werks
           AND posnr EQ slp-posnr.
      CLEAR num_line2.
      DESCRIBE TABLE it_venum LINES num_line2.
* When more than 1 Handling Unit per batch
      IF num_line2 > 1.
        LOOP AT it_venum.
          tt_hu-venum = it_venum.
          APPEND tt_hu.
          SELECT SINGLE exidv FROM vekp INTO lv_exidv
            WHERE venum = it_venum.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
            EXPORTING
              input  = lv_exidv
            IMPORTING
              output = lv_exidv.
          CONCATENATE wa_ltrn-handl_ext lv_exidv INTO wa_ltrn-handl_ext SEPARATED BY ' '.
        ENDLOOP.
      ENDIF.
      SELECT SINGLE venum FROM vepo INTO lv_venum
         WHERE vbeln EQ slk-vbeln
           AND matnr EQ pdoc-matnr
           AND werks EQ slp-werks
           AND posnr EQ slp-posnr.
      IF sy-subrc EQ 0. "HU found for current item
        SELECT SINGLE vhart exidv laeng breit hoehe meabm FROM vekp INTO (lv_vhart, lv_exidv, lv_laeng, lv_breit, lv_hoehe, lv_meabm)
         WHERE venum = lv_venum.
        IF sy-subrc EQ 0.
          SELECT SINGLE vtext FROM tvtyt INTO wa_ltrn-vtext
           WHERE traty = lv_vhart AND spras = nast-spras.
          IF num_line2 = 1 .
            CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
              EXPORTING
                input  = lv_exidv
              IMPORTING
                output = lv_exidv.
            wa_ltrn-handl_ext = lv_exidv.
          ENDIF.
          PERFORM unit_conversion_simple USING lv_meabm m
                                    CHANGING lv_laeng.
          PERFORM unit_conversion_simple USING lv_meabm m
                                    CHANGING lv_breit.
          PERFORM unit_conversion_simple USING lv_meabm m
                                    CHANGING lv_hoehe.
          lv_laeng_c = lv_laeng.
          lv_breit_c = lv_breit.
          lv_hoehe_c = lv_hoehe.
          REPLACE ALL OCCURRENCES OF '.' IN lv_hoehe_c WITH ','.
          REPLACE ALL OCCURRENCES OF '.' IN lv_laeng_c WITH ','.
          REPLACE ALL OCCURRENCES OF '.' IN lv_breit_c WITH ','.
          CONCATENATE lv_laeng_c lv_breit_c lv_hoehe_c INTO wa_ltrn-l_b_h SEPARATED BY 'x'.
          CONDENSE wa_ltrn-l_b_h.
        ELSE.
          CLEAR wa_ltrn-vtext.
          CLEAR wa_ltrn-handl_ext.
          CLEAR wa_ltrn-l_b_h.
        ENDIF.
      ENDIF.

      lv_counter = 0.
      SELECT COUNT(*) FROM vepo INTO lv_counter
      WHERE vbeln EQ slk-vbeln
        AND matnr EQ pdoc-matnr
        AND werks EQ slp-werks
        AND posnr EQ slp-posnr.


      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = lv_counter
        IMPORTING
          output = lv_counter.


      wa_ltrn-handl_nbr = lv_counter.

* Retrieve all HU's to be able to identify the unique HU's
      IF NOT lv_venum IS INITIAL AND num_line2 = 1.
        tt_hu-venum = lv_venum.
        APPEND tt_hu.
      ENDIF.
* IMP RU End of insert




      "currency multiplier
      tcurx-currdec = 2.
      SELECT SINGLE * FROM tcurx WHERE currkey = hdoc-waerk.
      IF tcurx-currdec = 0.
        onehundred = 100.           "w/o decimal places
      ELSE.
        onehundred = 1.
      ENDIF.

* IMP RU Begin of insert currency always RUB
      CLEAR lv_kursk.
      SELECT SINGLE kursk FROM vbkd INTO lv_kursk
      WHERE vbeln = slp-vgbel AND posnr = slp-vgpos.
      IF sy-subrc <> 0.
        SELECT SINGLE kursk FROM vbkd INTO lv_kursk
        WHERE vbeln = slp-vgbel AND posnr = c_posnr.
      ENDIF.
* IMP RU End of insert currency always RUB


      """"""  Variant of subtotals use  """""""
      slp-netpr = pdoc-kzwi3.             "sum w/o VAT of order item
      av_netpr = pdoc-kzwi5.              "VAT sum for order item
* IMP RU Begin of change currency always RUB
*   AV_NETWR = PDOC-KZWI4.              "Sum with VAT for order item
      av_netwr = pdoc-cmpre.              "Sum with VAT for order item
* IMP RU End of change  currency always RUB

      IF NOT  pdoc-lsmeng IS INITIAL.
* IMP RU Begin of change currency always RUB
*     slp-NETWR =                      "sum w/o VAT of delivery item
*         slp-NETPR * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
*     AV_NETPR =                       "VAT sum for delivery item
*         AV_NETPR * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
*     AV_NETWR =                       "Sum with VAT for delivery item
*         AV_NETWR * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
*     slp-NETPR =                      "Price w/o VAT for delivery item
*                 slp-NETPR * STUZ / STUN / PDOC-LSMENG.

        slp-netwr =                      "Net Price Qty 1 with Freight
            av_netpr * stuz / stun / pdoc-lsmeng.
        av_netpr =                       "Total without Freight with VAT
            pdoc-kzwi5 * slp-lfimg * stuz / stun / pdoc-lsmeng.
        av_netwr =                       "Total price with Freight->CMPRE with VAT
            pdoc-cmpre * slp-lfimg.
        slp-netpr =                      "Net price qty 1 with Freight
                    slp-netpr * stuz / stun / pdoc-lsmeng.
* IMP RU End of change currency always RUB
      ENDIF.

      slp-netpr = slp-netpr * onehundred.  "Price w/o VAT
      slp-netwr = slp-netwr * onehundred.  "sum w/o VAT
      av_netpr = av_netpr * onehundred.    "VAT sum
      av_netwr = av_netwr * onehundred.    "Sum with VAT
      """""
* IMP RU Begin of insert currency always RUB
      IF nast-kschl = 'ZU11'.
        slp-netpr = slp-netpr * lv_kursk. " net price qty 1 with Freight
        slp-netwr = ( av_netwr * lv_kursk ). " total with Freight
      ELSEIF nast-kschl = 'ZU05'.
        slp-netpr = slp-netwr * lv_kursk. " net price qty 1 without Freight
        slp-netwr = ( av_netpr * 118 / 100 ) * lv_kursk. " total without Freight
      ENDIF.

* IMP RU End of insert currency always RUB
*************
* IMP RU End of delete currency always RUB
*    slp-NETWR = AV_NETWR.            "Sum with VAT
* IMP RU End of delete currency always RUB
      IF nast-kschl = 'ZU11'.
        wa_ltrn-netwr = slp-netwr.
        wa_ltrn-netpr = slp-netpr.       "Price w/o VAT
      ENDIF.



      SELECT SINGLE mseh3 FROM t006a
          INTO wa_ltrn-vrkme
        WHERE spras EQ language AND msehi EQ wa_ltrn-vrkme
          AND mseh3 > '  '.                             "#EC CI_GENBUFF

      PERFORM unit_conversion_simple USING slp-gewei tn
                                  CHANGING wa_ltrn-brgew.

      PERFORM unit_conversion_simple USING slp-gewei tn
                                  CHANGING wa_ltrn-ntgew.
      wa_ltrn-gewei = tn.
      slp-brgew = wa_ltrn-brgew.
      slp-ntgew = wa_ltrn-ntgew.
      wa_ltrn-place = wa_ltrn-lfimg.
      CLEAR tkomser.
      PERFORM get_serial_no.
      DESCRIBE TABLE tkomser LINES lin.
* IMP RU Begin of insert
      CLEAR wa_ltrn-serdes.
      CLEAR teller.

      LOOP AT tkomser.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = tkomser-sernr
          IMPORTING
            output = tkomser-sernr.

        IF teller = 0.
          wa_ltrn-serdes =  tkomser-sernr.
        ELSE.
          CONCATENATE wa_ltrn-serdes tkomser-sernr INTO wa_ltrn-serdes SEPARATED BY '-'.
        ENDIF.
        ADD 1 TO teller.
      ENDLOOP.


* IMP RU End of insert
      IF lin EQ 0 OR lin NE slp-lfimg.
        APPEND wa_ltrn TO ltrn.
      ELSEIF lin EQ 1.
        CONCATENATE wa_ltrn-arktx '(' tkomser-sernr ')' INTO wa_ltrn-arktx.
        APPEND wa_ltrn TO ltrn.
      ELSE.
        CLEAR wa_ltrn-brgew.
        CLEAR wa_ltrn-ntgew.
        APPEND wa_ltrn TO ltrn.
        CLEAR wa_ltrn-place.
        wa_ltrn-brgew = slp-brgew / lin.
        wa_ltrn-ntgew = slp-ntgew / lin.
        CLEAR wa_ltrn-lfimg.
        CLEAR wa_ltrn-matnr.
        CLEAR wa_ltrn-vrkme.
        CLEAR wa_ltrn-netpr.
        CLEAR wa_ltrn-netwr.
        wa_ltrn-numlev = 1. "num_lin.
        LOOP AT tkomser.
          wa_ltrn-arktx = tkomser-sernr.
          APPEND wa_ltrn TO ltrn.
        ENDLOOP.
      ENDIF.
*AFS items
      MOVE-CORRESPONDING wa_ltrn TO tt_ltr-wa_ltrn.
      tt_ltr-werks = slp-werks.
      tt_ltr-lgort = slp-lgort.
      tt_ltr-charg = slp-charg.
      APPEND tt_ltr.
    ENDIF. " charg
  ENDLOOP.

ENDFORM.                    "ITEM_PRINT

*---------------------------------------------------------------------*
*       FORM GET_SERIAL_NO                                            *
*---------------------------------------------------------------------*
*       In this routine the serialnumbers are fetched from the        *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM get_serial_no.

  CHECK slp-anzsn > 0.
* Read the Serialnumbers of a Position.
  REFRESH tkomser.
  CALL FUNCTION 'SERIAL_LS_PRINT'
    EXPORTING
      vbeln  = slk-vbeln
      posnr  = slp-posnr
    TABLES
      iserls = tkomser.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
    EXPORTING
      i_boundary_left             = '(_'
      i_boundary_right            = '_)'
      i_sep_char_strings          = ',_'
      i_sep_char_interval         = '_-_'
      i_use_interval              = 'X'
      i_boundary_method           = 'C'
      i_line_length               = 50
      i_no_zero                   = 'X'
      i_alphabet                  = sy-abcde
      i_digits                    = '0123456789'
      i_special_chars             = '-'
      i_with_second_digit         = ' '
    TABLES
      serials                     = tkomser
      serials_print               = tkomser_print
    EXCEPTIONS
      boundary_missing            = 01
      interval_separation_missing = 02
      length_to_small             = 03
      internal_error              = 04
      wrong_method                = 05
      wrong_serial                = 06
      two_equal_serials           = 07
      serial_with_wrong_char      = 08
      serial_separation_missing   = 09.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_SERIAL_NO
*&---------------------------------------------------------------------*
*&      Form  OPEN_FORM_pdf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM open_form_pdf .
  DATA: fp_outputparams   TYPE sfpoutputparams.

  fp_outputparams-pdftagged = 'X'.

  PERFORM fill_outputparams_pdf USING    itcpo
                                CHANGING fp_outputparams.

  CALL FUNCTION 'FP_JOB_OPEN'
    CHANGING
      ie_outputparams = fp_outputparams
    EXCEPTIONS
      cancel          = 1
      usage_error     = 2
      system_error    = 3
      internal_error  = 4
      OTHERS          = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  x_open = 'X'.

ENDFORM.                    " OPEN_FORM_pdf
*&---------------------------------------------------------------------*
*&      Form  print_pdf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM print_pdf .
  DATA: ls_function           TYPE rs38l_fnam.
  DATA: fp_docparams      TYPE sfpdocparams,
        l_errstr TYPE string.

*    Begin of insertion -MOD-003
    DATA :  wa_date_mrua TYPE yse_date_mrua,
            lv_wadat TYPE likp-wadat,
            lv_werks TYPE werks_d,
            wa_ltrn TYPE  yse_j_3rt1_line,
            wa_kpp TYPE yse_kpp1.
**  End of insertion MOD-003

*        form  TYPE FPNAME.
*data : w_cx_root  TYPE REF TO CX_ROOT,
*       mesg TYPE STRING.

  PERFORM read_fm USING tnapr-sform
                    CHANGING ls_function.



* Call the generated functional module
* set locale RU_ru
  IF language = 'R'.
    fp_docparams-langu = 'R'.
    fp_docparams-country = 'RU'.
*    Begin of insertion -MOD-003
    IF ( nast-kschl = 'ZU11' OR nast-kschl = 'ZU12') .
      SELECT SINGLE * FROM yse_date_mrua INTO wa_date_mrua.
      READ TABLE ltrn INTO wa_ltrn INDEX 1 .
        if sy-subrc = 0.
      SELECT SINGLE wadat FROM likp INTO lv_wadat
         WHERE vbeln = wa_ltrn-vbeln.
      SELECT SINGLE werks FROM lips INTO lv_werks
         WHERE vbeln = wa_ltrn-vbeln.
        endif.
      IF  lv_wadat LE wa_date_mrua-t_gate .
        SELECT SINGLE * FROM yse_kpp1 INTO wa_kpp WHERE werks = lv_werks.
          if sy-subrc = 0.
            CONCATENATE wa_kpp-address1 wa_kpp-address INTO ztrn-gonam SEPARATED BY ' '.
            endif.
      ELSEIF lv_wadat GT wa_date_mrua-t_gate .
        SELECT SINGLE * FROM yse_kpp INTO wa_kpp WHERE werks = lv_werks.
          if sy-subrc = 0.
            CONCATENATE wa_kpp-address1 wa_kpp-address INTO ztrn-gonam SEPARATED BY ' '.
            endif.

      ENDIF.
    ENDIF.
*** end of insertion -MOD-003
  ENDIF.

**** AVOID EMPTY PAGE IN OUTPUT BY MADHU B
  DELETE ltrn WHERE vbeln = space.

  IF NOT ltrn[] IS INITIAL.
    CALL FUNCTION ls_function
      EXPORTING
        /1bcdwb/docparams   = fp_docparams
        f_ztrn              = ztrn
        f_ltrn              = ltrn
        f_tnam              = tabnam
*  IMPORTING
*    /1bcdwb/formoutput   =
      EXCEPTIONS
        usage_error     = 1
        system_error    = 2
        internal_error  = 3.

    IF sy-subrc <> 0.
      CALL FUNCTION 'FP_GET_LAST_ADS_ERRSTR'
        IMPORTING
          e_adserrstr = l_errstr.
    ENDIF.
  ENDIF.
ENDFORM.                    " print_pdf
*&---------------------------------------------------------------------*
*&      Form  CLOSE_FORM_pdf
*&---------------------------------------------------------------------*
*----------------------------------------------------------------------*
FORM close_form_pdf .
  CHECK NOT x_open IS INITIAL.
*Close the spool job
  CALL FUNCTION 'FP_JOB_CLOSE'
*           IMPORTING
*             E_RESULT             =
   EXCEPTIONS
     usage_error          = 1
     system_error         = 2
     internal_error       = 3
     OTHERS               = 4
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  CLEAR x_open.
ENDFORM.                    " CLOSE_FORM_pdf

*&---------------------------------------------------------------------*
*&      Form  read_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM read_fm USING    p_tnapr_sform
                   CHANGING p_fm_name.

* determine the name of the generated function module
*
  TRY.
      CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
        EXPORTING
          i_name     = p_tnapr_sform
        IMPORTING
          e_funcname = p_fm_name.
    CATCH cx_fp_api.
  ENDTRY.

  IF p_fm_name IS INITIAL.
*        MESSAGE e848 WITH t001f-fornr_pdf save_bukrs
*           save_repid save_forid.
    MESSAGE ID 'FB' TYPE 'I' NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " read_fm
*&---------------------------------------------------------------------*
*&      Form  FILL_OUTPUTPARAMS_PDF
*&---------------------------------------------------------------------*
*      -->IS_ITCPO TYPE ITCPO
*      <--XS_OUTPUTPARAMS TYPE SFPOUTPUTPARAMS
*----------------------------------------------------------------------*
FORM fill_outputparams_pdf
                      USING    is_itcpo TYPE itcpo
                      CHANGING xs_outputparams TYPE sfpoutputparams.
  CLEAR xs_outputparams-noprint.
  xs_outputparams-nopributt = xs_outputparams-nodialog = xscreen.
  xs_outputparams-device     = is_itcpo-tdprinter.
  xs_outputparams-preview    = is_itcpo-tdpreview.
  xs_outputparams-dest       = is_itcpo-tddest.
  xs_outputparams-reqnew     = is_itcpo-tdnewid.
  xs_outputparams-reqimm     = is_itcpo-tdimmed.
  xs_outputparams-reqdel     = is_itcpo-tddelete.
  xs_outputparams-reqfinal   = is_itcpo-tdfinal.
  xs_outputparams-senddate   = is_itcpo-tdsenddate.
  xs_outputparams-sendtime   = is_itcpo-tdsendtime.
  xs_outputparams-schedule   = is_itcpo-tdschedule.
  xs_outputparams-copies     = is_itcpo-tdcopies.
  xs_outputparams-dataset    = is_itcpo-tddataset.
  xs_outputparams-suffix1    = is_itcpo-tdsuffix1.
  xs_outputparams-suffix2    = is_itcpo-tdsuffix2.
  xs_outputparams-covtitle   = is_itcpo-tdcovtitle.
  xs_outputparams-cover      = is_itcpo-tdcover.
  xs_outputparams-receiver   = is_itcpo-tdreceiver.
  xs_outputparams-division   = is_itcpo-tddivision.
  xs_outputparams-lifetime   = is_itcpo-tdlifetime.
  xs_outputparams-authority  = is_itcpo-tdautority.
  xs_outputparams-rqposname  = is_itcpo-rqposname.
  xs_outputparams-arcmode    = is_itcpo-tdarmod.
  xs_outputparams-noarmch    = is_itcpo-tdnoarmch.
  xs_outputparams-title      = is_itcpo-tdtitle.
  xs_outputparams-nopreview  = is_itcpo-tdnoprev.

ENDFORM.                    " fill_outputparams_PDF


*&---------------------------------------------------------------------*
*&      Form  GET_BANK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_bank.
  DATA answer.
* bank data:
* 1. eknam (f_ztrn-eknam) vttkvb-tdlnr
* 2. payer (f_ztrn-plnam) likp-kunag

  CLEAR answer.

  SELECT SINGLE paval FROM t001z INTO answer
    WHERE bukrs EQ save_bukrs
    AND   party EQ 'SAPRB1'.


  IF answer EQ '1'.

    eknam_bank-lifnr = vttkvb-tdlnr.
    payer_bank-kunnr = likp-kunag.

    PERFORM vend_bank_data USING eknam_bank-lifnr
                        CHANGING eknam_bank-bankadat.

    PERFORM partn_bank_data USING payer_bank-kunnr
                        CHANGING payer_bank-bankadat.

  ELSE.
    CLEAR eknam_bank.
    CLEAR payer_bank.
  ENDIF.
ENDFORM.                    " GET_BANK

*&---------------------------------------------------------------------*
*&      Form  partn_bank_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM partn_bank_data  USING    p_kunnr
                      CHANGING p_bankadat.

  DATA: addr1_val TYPE addr1_val.
  DATA: banks LIKE knbk-banks,   "Bank country key
        bankl LIKE knbk-bankl,       "Bank Key
        bankn LIKE knbk-bankn,       "Bank Account Number
        bkont LIKE knbk-bkont.       "Bank Control Key

  CLEAR p_bankadat.

  SELECT  SINGLE banks bankl bankn bkont FROM knbk
     INTO (banks, bankl, bankn, bkont)
     WHERE  kunnr = p_kunnr.

  SELECT  SINGLE * FROM  bnka
     WHERE  banks  = banks
     AND    bankl  = bankl.

  CLEAR sel.
  sel-addrnumber = bnka-adrnr.
  CLEAR addr1_val. sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.

  IF sy-subrc EQ 0.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3
      addr1_val-name4 addr1_val-city1 INTO p_bankadat SEPARATED BY space.
  ELSE.
    CONCATENATE bnka-banka bnka-ort01 INTO p_bankadat SEPARATED BY space.
  ENDIF.

  CONCATENATE p_bankadat text-003 bnka-bnklz text-004 bnka-brnch
     text-005 bkont INTO p_bankadat SEPARATED BY space.
  CONCATENATE p_bankadat bankn INTO p_bankadat.

ENDFORM.                    " partn_bank_data

*&---------------------------------------------------------------------*
*&      Form  vend_bank_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM vend_bank_data  USING p_lifnr
                  CHANGING p_bankadat.

  DATA: addr1_val TYPE addr1_val.
  DATA: banks LIKE lfbk-banks,       "Bank country key
        bankl LIKE lfbk-bankl,       "Bank Key
        bankn LIKE lfbk-bankn,       "Bank Account Number
        bkont LIKE lfbk-bkont.       "Bank Control Key

  CLEAR p_bankadat.

  SELECT  SINGLE banks bankl bankn bkont FROM lfbk
     INTO (banks, bankl, bankn, bkont)
     WHERE  lifnr = p_lifnr.

  SELECT  SINGLE * FROM  bnka
     WHERE  banks  = banks
     AND    bankl  = bankl.

  CLEAR sel.
  sel-addrnumber = bnka-adrnr.
  CLEAR addr1_val. sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.

  IF sy-subrc EQ 0.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3
      addr1_val-name4 addr1_val-city1 INTO p_bankadat SEPARATED BY space.
  ELSE.
    CONCATENATE bnka-banka bnka-ort01 INTO p_bankadat SEPARATED BY space.
  ENDIF.

  CONCATENATE p_bankadat text-003 bnka-bnklz text-004 bnka-brnch
     text-005 bkont INTO p_bankadat SEPARATED BY space.
  CONCATENATE p_bankadat bankn INTO p_bankadat.

ENDFORM.                    " vend_bank_data

*Text symbol text£º
*001:kop.
*002:"§°§Ò§à§ã§à§Ò§Ý§Ö§ß§ß§à§Ö §á§à§Õ§â§Ñ§Ù§Õ§Ö§Ý§Ö§ß§Ú§Ö §©§¡§° "§¡§ä§Ý§Ñ§ã §¬§à§á§Ü§à"
*003:BIK
*004:cor/acc
*005:set/acc
