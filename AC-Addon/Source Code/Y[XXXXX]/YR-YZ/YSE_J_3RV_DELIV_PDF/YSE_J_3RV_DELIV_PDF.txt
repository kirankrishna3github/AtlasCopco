*----------------------------------------------------------------------*
*              Print of a delivery note TORG-12                        *
*----------------------------------------------------------------------*
*--------------------------------------------------------------------- *
* Mod. no.|  Date    | Name           | Correction Number | Change Ref *
*--------------------------------------------------------------------- *
* MOD-001 |18/06/2012| Pratap Mada   | CD1K972232        | XXXXxxxxxx  *
*                                      CD1K972254                      *
*                                      CD1K972774                      *
*                                      CD1K972778                      *
* Description:                                                         *
* Quatation form text copied to OD outputs ZU01,ZU03,ZU05_             *
* Incident_22895                                                       *
*----------------------------------------------------------------------*
*--------------------------------------------------------------------- *
* MOD-002 |17/072012| Pratap Mada   | CD1K972586       | XXXXxxxxxx    *
*                                     CD1K972638                       *
*                                     CD1K972683                       *
* Description:                                                         *
* Changing the sender address of for some specific plants              *
*                                                                      *
*----------------------------------------------------------------------*
*--------------------------------------------------------------------- *
* MOD-001 |13/08/2012| Pratap Mada   | CD1K972887        | XXXXxxxxxx  *
*                                       CD1K972943                     *
* Description:                                                         *
* Quatation form text copied to OD outputs ZU01,ZU03,ZU05_             *
* Incident_22895  , 25929                                              *
*----------------------------------------------------------------------*
*--------------------------------------------------------------------- *
* MOD-004 |12/12/2012| D.V.S.Raghavendra Rao| CD1K974225 | CR-2759     *
* Description:                                                         *
* Fix for Material with Alpha numeric value having conversion issue    *
*--------------------------------------------------------------------- *
* MOD-005 |11/01/2013| D.V.S.Raghavendra Rao| CD1K974637 | CR-2776     *
* Description:                                                         *
* Fix for Material with preceeding zeroes.                             *
*--------------------------------------------------------------------- *
* MOD-006 |01/04/2014| D.V.S.Raghavendra Rao| CD1K980722 | CR-3112     *
* Description:                                                         *
* Add the bank account details in the company  header                  *
*--------------------------------------------------------------------- *
* MOD-007 |11/06/2014| Anda Wu              | CD1K981874 | CR-3279     *
* Description:                                                         *
* change source field  for purchase order field  for  ZU01 output      *
*--------------------------------------------------------------------- *
* MOD-008 |4/06/2015| Prakash              | CD1K985885 | CR-3626      *
* -hard code text removal-ZU01,ZU03,ZU05,ZU06,ZU10,ZU11,ZU12,ZU13      *
*                                                                      *
*--------------------------------------------------------------------- *
* MOD-009 |16/05/2017| Yang Lei            | CD1K992002 | CR-XXXX      *
* -hard code                                                           *
*                                                                      *
*--------------------------------------------------------------------- *
* MOD-010 |26/06/2017| Valentin Rubinsky   | CD1K992482 |              *
* Description:                                                         *
* Changing address of the payer and the consignee                      *
************************************************************************


REPORT rvaddn01 LINE-COUNT 100.

TABLES: vbco3,                         "Communicationarea for view
        vbdkl,                         "Headerview
        vbdpl,                         "Itemview
        komser,                        "Communicationarea Serialnumber
        conf_out,                      "Configuration data
        tvko,                           "Sales organization
        addr1_val,                     "Address
        t001,                          "Company Code
        bnka,
        tcurx,                         "Decimal Places in Currencies
        spell, thead,
        vbfa,                          "Sales Document Flow
        t683s,                   "Conditions (Transaction Data)
        komk, komp,
        vbak,
        vbap,                          "Sales Document: Item Data
        ekko, ekpo,
        vbrk, vbrp,
        t006a,
        marm,                          "Units of Measure
        kna1.                          "General Data in Customer Master
INCLUDE rvadtabl.

TABLES yse_ens.
* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
TYPES: BEGIN OF own_bank,
         bukrs LIKE t012k-bukrs,
*         hbkid like t012k-hbkid,
*         hktid like t012k-hktid,
         bankadat(140),
      END OF own_bank.
TYPES: BEGIN OF partn_bank,
         kunnr LIKE knbk-kunnr,
*         BANKS like knbk-BANKS,
*         BANKL like knbk-BANKL,
         bankadat(140),
       END OF partn_bank.
DATA: consignor_bank TYPE own_bank,
      supplier_bank TYPE own_bank,
      ship_to_bank TYPE partn_bank,
      payer_bank TYPE partn_bank.

DATA: txt_invoice TYPE yse_j_3rf_txt. "internal table for texts
DATA: wa_txt LIKE LINE OF txt_invoice.

DATA: BEGIN OF tbvat OCCURS 0,
      znvat LIKE komvd-stunr,  "Step number
      END OF tbvat.

DATA: lv_quotnr LIKE vbak-xblnr,
      lv_vbeln  TYPE vbeln_va,  " mod-001
      lv_salorder LIKE vbrp-aubel,
      lv_kunre TYPE kunnr,
      lv_kunrg TYPE kunnr.

DATA: BEGIN OF i_lines OCCURS 0.
        INCLUDE STRUCTURE tline.
DATA: END OF i_lines.

DATA: lv_salord LIKE thead-tdname.

DATA: BEGIN OF tkomv OCCURS 50.
        INCLUDE STRUCTURE komv.
DATA: END OF tkomv.

DATA: lv_ens TYPE c.

* IMP RU BEGIN INSERT
DATA: lv_anzsn LIKE lips-anzsn,
      tkomser2 TYPE TABLE OF riserls WITH HEADER LINE,
      teller TYPE i,
      lv_venum TYPE vekp-venum,
      lv_vhart TYPE vekp-vhart,
      lv_counter(3) TYPE n,
      lv_counter2(3) TYPE n,
      lv_flag TYPE c.
* IMP RU END INSERT

DATA: lv_adrnr TYPE adrnr.

* Begin of insert final remarks - punt 10
*DATA: lv_matnr TYPE char46.
*DATA: lv_matnr2 TYPE char35.
*DATA: lv_matnr3 TYPE char10.
* Begin of MOD-004.
DATA: lv_matnr TYPE matnr.
DATA: lv_matnr2 TYPE matnr.
DATA: lv_matnr3 TYPE matnr.
* End of MOD-004
DATA: it_yse_ens TYPE TABLE OF yse_ens,
      wa_yse_ens LIKE LINE OF it_yse_ens.
* End of insert final remarks - punt 10

DATA: BEGIN OF tkomvd OCCURS 50.
        INCLUDE STRUCTURE komvd.
DATA: END OF tkomvd.
DATA: st_nds(3).  " like komvd-kbetr.
DATA: nn TYPE f, av_netpr LIKE vbap-kzwi3, av_netwr LIKE vbap-kzwi3.
DATA: mm TYPE i, onehundred TYPE i, pp(13), pp1(13),
      gew LIKE vbplk-gewei,
      spel_neto(100),
      dec_net LIKE spell-decimal,
      spel_brto(100),
      dec_brt LIKE spell-decimal,
      spel_limfg(100).
DATA: stuz  LIKE  marm-umrez,
      stun  LIKE  marm-umren,
      mseht LIKE t006a-mseht,
      mseh3 LIKE t006a-mseht.
DATA: kol_pos LIKE vbdpl-lfimg,
      totkol LIKE vbdpl-lfimg.
DATA: sel LIKE addr1_sel,
      language LIKE addr1_val-langu.
DATA: telf1(18), telfx(18).
DATA: totam     LIKE vbdpl-lfimg.      "quantity in total
DATA: totwt     LIKE vbdpl-brgew.      "Gross weight in total
DATA: totnt     LIKE vbdpl-ntgew.      "Net weight
DATA: totvol    LIKE vbdpl-netwr.      "Volume in total
DATA: totsum    LIKE vbdpl-netwr.      "Amount in total
DATA: totnds    LIKE vbdpl-netpr.      "VAT Amount in total

DATA: lv_name(140) TYPE c.

DATA: lv_uni_freight TYPE wrbtr.

* IMP RU BEGIN DELETE
* DATA: SUM  TYPE VBDPL-NETWR.           "Amounts for SPELL_AMOUNT
* IMP RU END DELETE

* IMP RU BEGIN INSERT
DATA: sum  TYPE vbdpl-brgew,             "Amounts for SPELL_AMOUNT
      lv_hbkid TYPE hbkid,
      lv_landx50 LIKE t005t-landx50,
      lv_region LIKE t005u-bezei.


* IMP RU END INSERT
DATA: BEGIN OF line OCCURS 0.          "Text Lines
        INCLUDE STRUCTURE tline.
DATA: END OF line.
DATA: zvname LIKE thead-tdname.
DATA: zvid LIKE thead-tdid.
DATA: num_line TYPE i.

DATA: retcode   LIKE sy-subrc,         "Returncode
      x_open TYPE c.
DATA: xscreen(1) TYPE c.               "Output on printer or screen

DATA: BEGIN OF tvbdpl OCCURS 0.        "Internal table for items
        INCLUDE STRUCTURE vbdpl.
DATA: END OF tvbdpl.
DATA: t_vbdpl  TYPE ehs_vbdpl_t.

DATA: BEGIN OF tkomcon OCCURS 50.      "...  for configuration data
        INCLUDE STRUCTURE conf_out.
DATA: END OF tkomcon.

DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
DATA: END   OF tkomser_print.

DATA: BEGIN OF tkombat OCCURS 50.      " configuration data for batches
        INCLUDE STRUCTURE conf_out.
DATA: END   OF tkombat.
DATA: sytvar1(70), lgnumt(18).
DATA: BEGIN OF hdoc,
        vbtyp LIKE vbak-vbtyp,
        auart LIKE vbak-auart,
        waerk LIKE vbak-waerk,
        knumv LIKE vbak-knumv,
        kalsm LIKE vbak-kalsm,
        fkart LIKE vbrk-fkart,
      END OF hdoc.
DATA: BEGIN OF pdoc,
        lsmeng LIKE vbap-lsmeng,
        vrkme  LIKE vbap-vrkme,
        matnr  LIKE vbap-matnr,
        kzwi3  LIKE vbap-kzwi3,
        kzwi4  LIKE vbap-kzwi4,
        kzwi5  LIKE vbap-kzwi5,
        kzwi6  LIKE vbap-kzwi6,
      END OF pdoc.
* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
DATA: BEGIN OF h_doc.  "structure for header
        INCLUDE STRUCTURE yse_j_3rv_ht12.
DATA: END OF h_doc.

DATA: items  TYPE yse_j_3rv_tt12. "internal table for line items

* IMP RU Begin of insert - check options / also for freight with options(ZU06)
DATA: items_opt  TYPE yse_j_3rv_tt12. "internal table for line items

DATA wa_matkl TYPE matkl.
DATA wa_uepos TYPE uepos.
DATA: wa_items_opt LIKE LINE OF items. " to calulate options totals
DATA: wa_items_opt2 LIKE LINE OF items. " to calulate options totals

* IMP RU End of insert - check options / also for freight with options(ZU06)

DATA: wa_item LIKE LINE OF items.
* IMP RU Begin of insert - subtract freight of previous lines
DATA: wa_item_frght LIKE LINE OF items.
DATA: lv_convert TYPE c.
* IMP RU End of insert - subtract freight

TYPES: BEGIN OF wa_it,
        key_field(62),
        matdet(100),
        wa_item TYPE yse_j_3rv_pt12,
       END OF wa_it.
DATA: tt_it TYPE STANDARD TABLE OF wa_it WITH HEADER LINE.

DATA: gc_badi_descr TYPE REF TO j_3rv_afs_descr.
* IMP_RU_BEGIN_DELETE
* data: gc_badi_TORG12 type ref to J_3R_TORG12_BADI.
* IMP_RU_BEGIN_DELETE
DATA: torg12 TYPE c, mm_pr TYPE c, tot_qnt, vrkme LIKE vbdpl-vrkme.

DATA: lv_bstkd TYPE bstkd.

* IMP RU Begin of insert - add freight ZU05/ZU06
DATA: ps_items LIKE LINE OF items.
DATA: lv_calc_vat LIKE wa_item-vat.
DATA: lv_calc_wrbtr LIKE wa_item-wrbtr.
DATA: lv_calc_netwr LIKE wa_item-netwr,
      lv_kursk LIKE komk-kurrf.

* IMP RU End of insert - add freight

*Begin of mod-001
DATA: w_tdname TYPE tdobname.

DATA: gt_lines TYPE TABLE OF tline,
      wa_lines TYPE tline.
*    end of mod-001

*Begin of mod-002
DATA: g_ind TYPE char1.

DATA: gt_kpp TYPE TABLE OF yse_kpp,
      wa_kpp TYPE yse_kpp.
* End of mod-002
*-----------------------------------------------------------------------
*
*-----------------------------------------------------------------------

FORM entry USING return_code us_screen.

  CLEAR retcode.
  xscreen = us_screen.
  PERFORM processing USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  PROC_SCREEN                                                   *
*---------------------------------------------------------------------*
FORM processing USING proc_screen.
**Begin fo insertion -MOD-008
  DATA : wa_date_mrua TYPE yse_date_mrua,
         wa_kpp1      TYPE yse_kpp1.
**End fo insertion -MOD-008
  PERFORM get_data.

  CLEAR torg12.
  CLEAR lv_ens.
* Get BADI instance
* IMP_RU_BEGIN_DELETE

*  TRY.
*    get badi gc_badi_torg12.
*    CATCH cx_badi_not_implemented. "#EC NO_HANDLER
*    CATCH cx_badi_multiply_implemented.
*      MESSAGE e001(J3R_LEGAL_FORMS).
*    CATCH cx_badi_initial_context.
*      MESSAGE e002(J3R_LEGAL_FORMS).
*  ENDTRY.

* IMP_RU_BEGIN_DELETE

* IMP_RU_BEGIN_DELETE
*  IF gc_badi_torg12 IS BOUND.
*    torg12 = 'X'.
*  ENDIF.
* IMP_RU_BEGIN_DELETE

  SELECT SINGLE spras FROM t001 INTO language
     WHERE bukrs = vbdkl-bukrs.
  SELECT SINGLE spras FROM t002c INTO language
     WHERE spras = language
       AND lainst = 'X'.
  IF sy-subrc EQ 0.
    SET LANGUAGE language.
  ELSE.
    language = sy-langu.
  ENDIF.

  CLEAR h_doc. CLEAR mm_pr.
  PERFORM vendor_address_data_print.
  PERFORM addresses_data_print.
  PERFORM get_bank.
* IMP RU begin of delete
*  concatenate h_doc-CC_NAME consignor_bank-bankadat into h_doc-CC_NAME
*     separated by space.
*  condense h_doc-CC_NAME.
*  concatenate h_doc-SUPPLIER supplier_bank-bankadat into h_doc-SUPPLIER
*     separated by space.
*  condense h_doc-SUPPLIER.
*  concatenate h_doc-CONSIGNEE ship_to_bank-bankadat into h_doc-CONSIGNEE
*     separated by space.
*  condense h_doc-CONSIGNEE.
*  concatenate h_doc-PAYER payer_bank-bankadat into h_doc-PAYER
*     separated by space.
*  condense h_doc-PAYER.
* IMP RU end of delete

* IMP RU begin of insert



  IF consignor_bank-bankadat IS NOT INITIAL.
    CONCATENATE h_doc-cc_name consignor_bank-bankadat INTO h_doc-cc_name SEPARATED BY ', '.
  ENDIF.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', , ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ', ,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,' IN h_doc-cc_name WITH ','.
  REPLACE ALL OCCURRENCES OF ',,' IN h_doc-cc_name WITH ','.

* Check if it is a Norilsk Customer
  SELECT SINGLE * INTO wa_yse_ens FROM yse_ens
  WHERE vkorg = vbdkl-vkorg
    AND vtweg = tvbdpl-vtweg
    AND kunnr = vbdkl-kunag.
  IF sy-subrc = 0.
    lv_ens = 'X'.
  ENDIF.

  IF supplier_bank-bankadat IS NOT INITIAL AND lv_ens <> 'X'.
    CONCATENATE h_doc-supplier supplier_bank-bankadat INTO h_doc-supplier SEPARATED BY ', '.
  ENDIF.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', , ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ', ,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,' IN h_doc-supplier WITH ','.
  REPLACE ALL OCCURRENCES OF ',,' IN h_doc-supplier WITH ','.
  IF ship_to_bank-bankadat IS NOT INITIAL.
    CONCATENATE h_doc-consignee ship_to_bank-bankadat INTO h_doc-consignee SEPARATED BY ', '.
  ENDIF.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', , ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ', ,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,' IN h_doc-consignee WITH ','.
  REPLACE ALL OCCURRENCES OF ',,' IN h_doc-consignee WITH ','.
  IF payer_bank-bankadat IS NOT INITIAL.
    CONCATENATE h_doc-payer payer_bank-bankadat INTO h_doc-payer SEPARATED BY ', '.
  ENDIF.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', , ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ', ,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,,' IN h_doc-payer WITH ','.
  REPLACE ALL OCCURRENCES OF ',,' IN h_doc-payer WITH ','.

* IMP RU end of insert

****!
*select single lnumt from t300t into lgnumt
*    where lgnum = vbdkl-lgnum
*      and spras = nast-spras.
****!

*Order's number from Sales Document Flow
  SELECT SINGLE * FROM vbfa
    WHERE vbelv EQ vbdkl-vgbel
      AND vbeln EQ vbdkl-vbeln
      AND vbtyp_v EQ vbdkl-vgtyp.                       "#EC CI_NOFIRST
*IMP_RU_BEGIN_DELETE Quotation and Salesorder number
*******
*  if sy-subrc eq 0.
*    SELECT SINGLE * FROM VBAK            "Sales Order Header Data
*      WHERE VBELN = VBFA-VBELV.
*    if sy-subrc = 0 and not vbak-vbeln is initial.
*      CONCATENATE vbak-audat+6(2) vbak-audat+4(2)
*                  vbak-audat(4)
*             INTO h_doc-ground
*        SEPARATED BY '.'  .
*      concatenate text-005 vbak-vbeln text-004 h_doc-ground
*             into h_doc-ground separated by space.
*    endif.
********
*  else.
*    clear vbak.
*    select SINGLE * from ekko            "Purchase order
*      WHERE EBELN = VBDKL-VGBEL.
*
*    if sy-subrc = 0 and not ekko-ebeln is initial.
*      vbak-waerk = ekko-waers.
*      CONCATENATE ekko-aedat+6(2) ekko-aedat+4(2)
*                  ekko-aedat(4)
*             INTO h_doc-ground
*        SEPARATED BY '.'  .
*      concatenate text-005 ekko-ebeln text-004 h_doc-ground
*             into h_doc-ground separated by space.
*    endif.
*
*  endif.
*IMP_RU_END_DELETE


* IMP_RU_BEGIN_INSERT - quotation and salesorder number
  SELECT SINGLE xblnr INTO lv_quotnr FROM vbak
    WHERE vbeln = vbdkl-vbeln_vauf.

  CLEAR lv_bstkd.
  SELECT SINGLE bstkd FROM vbkd INTO lv_bstkd
  WHERE vbeln = vbdkl-vbeln_vauf AND posnr = vbdpl-posnr_vauf.


  IF lv_quotnr IS INITIAL.
    lv_quotnr = '/'.
  ENDIF.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = vbdkl-vbeln_vauf
    IMPORTING
      output = lv_salorder.

  CONCATENATE text-009 lv_quotnr ' ' text-010 lv_salorder text-011 lv_bstkd
             INTO h_doc-given SEPARATED BY space.

*IMP_RU_END_INSERT

******
  h_doc-waerk = vbdkl-waerk.
  h_doc-vbeln = vbdkl-vbeln.
  h_doc-erdat = vbdkl-erdat.
  h_doc-wadat = vbdkl-wadat.

*  *  Begin of mod-001
  CONDENSE lv_quotnr NO-GAPS.
  CLEAR lv_vbeln.
  lv_vbeln = lv_quotnr+0(10).
  IF nast-spras EQ 'R' AND lv_vbeln NE '/'
     AND nast-kschl EQ 'ZU01' OR nast-kschl EQ 'ZU03' OR
         nast-kschl EQ 'ZU05'.
    REFRESH gt_lines.
    CLEAR: wa_lines,
           h_doc-given.
    CONCATENATE '§³§é§Ö§ä-§á§â§Ö§Õ§Ý§à§Ø§Ö§ß§Ú§Ö ¡í:'(013) lv_quotnr ' ' '§¯§à§Þ§Ö§â §Ù§Ñ§Ü§Ñ§Ù§Ñ SAP:'(014) lv_salorder
                '§¥§à§Ô§à§Ó§à§â:'(015) INTO h_doc-given SEPARATED BY space.

    CATCH SYSTEM-EXCEPTIONS arithmetic_errors = 4
                            OTHERS = 8.
      UNPACK lv_vbeln TO lv_vbeln.
    ENDCATCH.
*  *  Begin of mod-007
*    MOVE lv_vbeln TO w_tdname.
*    CALL FUNCTION 'READ_TEXT'
*      EXPORTING
*        id                      = '0001'
*        language                = nast-spras
*        name                    = w_tdname
*        object                  = 'VBBK'
*      TABLES
*        lines                   = gt_lines
*      EXCEPTIONS
*        id                      = 1
*        language                = 2
*        name                    = 3
*        not_found               = 4
*        object                  = 5
*        reference_check         = 6
*        wrong_access_to_archive = 7
*        OTHERS                  = 8.
    MOVE vbdkl-vbeln_vauf TO w_tdname.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        id                      = 'SL03'
        language                = nast-spras
        name                    = w_tdname
        object                  = 'VBBK'
      TABLES
        lines                   = gt_lines
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.

*  *  End of mod-007
    IF sy-subrc <> 0.
    ELSE.
      LOOP AT gt_lines INTO wa_lines.
        CONCATENATE h_doc-given wa_lines-tdline INTO h_doc-given
                  SEPARATED BY space.
      ENDLOOP.
    ENDIF.

  ENDIF.

*end of mod-001

  PERFORM item_print.

*   Begin of insertion by -MOD-008
  IF  ( nast-kschl EQ 'ZU01' OR nast-kschl EQ 'ZU03' OR
        nast-kschl EQ 'ZU05' OR nast-kschl EQ 'ZU06' OR
                                nast-kschl EQ 'ZU10' ).

** table yse_date_mrua  will have single record i the table
    SELECT SINGLE * FROM yse_date_mrua INTO wa_date_mrua.

    IF h_doc-wadat LE wa_date_mrua-t_gate.
      SELECT SINGLE * FROM yse_kpp1  INTO wa_kpp1 WHERE  werks  = vbdpl-werks.
      IF sy-subrc = 0.
        CONCATENATE wa_kpp1-address1 ' '
             wa_kpp1-address ' ' consignor_bank-bankadat
           INTO h_doc-cc_name SEPARATED BY space.
      ENDIF.

    ELSEIF h_doc-wadat GT wa_date_mrua-t_gate.
      SELECT SINGLE * FROM yse_kpp  INTO wa_kpp WHERE  werks  = vbdpl-werks.
      IF sy-subrc = 0.
        CONCATENATE wa_kpp-address1 ' '
                    wa_kpp-address ' ' consignor_bank-bankadat
           INTO h_doc-cc_name SEPARATED BY space.
      ENDIF.
    ENDIF.

  ENDIF.
*  End of insertion MOD-008

  "texts
  zvname = vbdkl-vbeln.                "delivery number
  DO 8 TIMES.
    CASE sy-index.
      WHEN 1. zvid = '0002'.           "take_name
      WHEN 2. zvid = '0003'.           "allow_name
      WHEN 3. zvid = '0004'.           "chief_acc
      WHEN 4. zvid = '0005'.           "give_name
      WHEN 5. zvid = '0012'.           "rec_name
      WHEN 6. zvid = '0013'.           "dover
      WHEN 7. zvid = '0014'.           "dover
      WHEN 8. zvid = '0015'.           "given
    ENDCASE.
    CLEAR line. REFRESH line.
    CALL FUNCTION 'READ_TEXT'          "read texts
      EXPORTING
         id         =  zvid
         language   = language
         name       =  zvname
         object     = 'VBBK'
      IMPORTING
         header     = thead
      TABLES
         lines      = line
      EXCEPTIONS OTHERS = 8.
    READ TABLE line INDEX 1.
    IF line-tdline <> space.
      CASE sy-index.
        WHEN 1.
          sytvar1 = line-tdline.      "take_name
          h_doc-take_name = line-tdline.
        WHEN 2.
          sy-tvar2 = line-tdline.     "allow_name
          h_doc-allow_name = line-tdline.
        WHEN 3.
          sy-tvar3 = line-tdline.     "chief_acc
          h_doc-chief_acc = line-tdline.
        WHEN 4.
          sy-tvar4 = line-tdline.     "give_name
          h_doc-give_name = line-tdline.
        WHEN 5.
          sy-tvar5 = line-tdline.     "rec_name
          h_doc-rec_name = line-tdline.
        WHEN 6.
          sy-tvar6 = line-tdline.     "dover
          h_doc-dover = line-tdline.
        WHEN 7.
          sy-tvar7 = line-tdline.     "dover
          CONCATENATE h_doc-dover text-004 line-tdline
             INTO h_doc-dover SEPARATED BY space.
*       WHEN 8. SY-TVAR8 = LINE-TDLINE.     "given
*                h_doc-given = LINE-TDLINE.
      ENDCASE.
    ELSE.
      IF sy-index = 3.
        SELECT SINGLE paval FROM t001z INTO h_doc-chief_acc
              WHERE bukrs EQ tvko-bukrs
                AND party EQ 'SAPR15'.
      ENDIF.
    ENDIF.
  ENDDO.                               """""

* BAdI allows to change all fields of the form (items and h_doc)
  IF torg12 EQ 'X'.
* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->DOC_DETAILS
*    exporting
*       i_vbdkl    = vbdkl
*       t_vbdpl   = T_VBDPL
*    changing
*       hdoc = h_doc
*       items = items.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
  ENDIF.

  PERFORM open_form_sammel.
  IF x_open EQ 'X'.
    PERFORM print_form.
  ENDIF.
  PERFORM close_form.

ENDFORM.                    "PROCESSING

***********************************************************************
*       S U B R O U T I N E S                                         *
***********************************************************************

*---------------------------------------------------------------------*
*       FORM CHECK_REPEAT                                             *
*---------------------------------------------------------------------*
*       A text is printed, if it is a repeat print for the document.  *
*---------------------------------------------------------------------*

FORM check_repeat.

  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'.
    CHECK *nast-vstat = '1'.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'REPEAT'
        window  = 'REPEAT'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*

FORM get_data.

  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DELIVERY_PRINT_VIEW'
    EXPORTING
      comwa = vbco3
    IMPORTING
      kopf  = vbdkl
    TABLES
      pos   = tvbdpl.
  t_vbdpl[] = tvbdpl[].
ENDFORM.                    "GET_DATA

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS                                 *
*---------------------------------------------------------------------*
*       In this routine the configuration data item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

*form get_item_characteristics.

*  refresh tkomcon.
*  check not vbdpl-cuobj is initial.

*  call function 'CUD0_GET_CONFIGURATION'
*       exporting
*            instance      = vbdpl-cuobj
*            language      = nast-spras
*       tables
*            configuration = tkomcon
*       exceptions
*            others        = 4.


*endform.

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS_BATCH                           *
*---------------------------------------------------------------------*
*       In this routine the configuration data for batches is fetched *
*       from the database                                             *
*---------------------------------------------------------------------*

FORM get_item_characteristics_batch.

  REFRESH tkombat.
  CHECK NOT vbdpl-charg IS INITIAL.

  CALL FUNCTION 'VB_BATCH_VALUES_FOR_OUTPUT'
    EXPORTING
      material       = vbdpl-matnr
      plant          = vbdpl-werks
      batch          = vbdpl-charg
      language       = nast-spras
    TABLES
      classification = tkombat
    EXCEPTIONS
      OTHERS         = 4.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS_BATCH

*---------------------------------------------------------------------*
*       FORM GET_SERIAL_NO                                            *
*---------------------------------------------------------------------*
*       In this routine the serialnumbers are fetched from the        *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM get_serial_no.

  CHECK vbdpl-anzsn > 0.
* Read the Serialnumbers of a Position.
  REFRESH tkomser.
  CALL FUNCTION 'SERIAL_LS_PRINT'
    EXPORTING
      vbeln  = vbdkl-vbeln
      posnr  = vbdpl-posnr
    TABLES
      iserls = tkomser.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
    EXPORTING
      i_boundary_left             = '(_'
      i_boundary_right            = '_)'
      i_sep_char_strings          = ',_'
      i_sep_char_interval         = '_-_'
      i_use_interval              = 'X'
      i_boundary_method           = 'C'
      i_line_length               = 50
      i_no_zero                   = 'X'
      i_alphabet                  = sy-abcde
      i_digits                    = '0123456789'
      i_special_chars             = '-'
      i_with_second_digit         = ' '
    TABLES
      serials                     = tkomser
      serials_print               = tkomser_print
    EXCEPTIONS
      boundary_missing            = 01
      interval_separation_missing = 02
      length_to_small             = 03
      internal_error              = 04
      wrong_method                = 05
      wrong_serial                = 06
      two_equal_serials           = 07
      serial_with_wrong_char      = 08
      serial_separation_missing   = 09.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_SERIAL_NO

*&---------------------------------------------------------------------*
*&     Form CLIENT_ADDRESS_DATA_print.              #8
*&---------------------------------------------------------------------*
*       Printing of the address data of client                         *
*----------------------------------------------------------------------*

FORM vendor_address_data_print.

  SELECT SINGLE * FROM tvko  WHERE vkorg = vbdkl-vkorg.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'TVKO'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
    EXIT.
  ENDIF.

  SELECT SINGLE paval FROM t001z INTO h_doc-okpo
    WHERE bukrs EQ tvko-bukrs
    AND   party EQ 'SAPR02'.
  SELECT SINGLE paval FROM t001z INTO h_doc-okdp
    WHERE bukrs EQ tvko-bukrs
    AND   party EQ 'SAPR04'.

  CLEAR addr1_val.
  CLEAR sel. sel-nation = 'R'.
  sel-addrnumber = tvko-adrnr.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.

  IF sy-subrc NE 0.
    CLEAR sel-nation.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        address_selection = sel
      IMPORTING
        address_value     = addr1_val
      EXCEPTIONS
        parameter_error   = 1
        address_not_exist = 2
        version_not_exist = 3
        internal_error    = 4
        OTHERS            = 5.
    IF sy-subrc NE 0.
      syst-msgid = 'VN'.
      syst-msgno = '203'.
      syst-msgty = 'E'.
      syst-msgv1 = 'SADR'.
      syst-msgv2 = syst-subrc.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.
  IF sy-subrc EQ 0.
    CLEAR telf1. CLEAR telfx.
    IF NOT addr1_val-tel_number IS INITIAL.
      CONCATENATE text-001 addr1_val-tel_number INTO telf1.
    ENDIF.
    IF NOT addr1_val-fax_number IS INITIAL.
      CONCATENATE text-002 addr1_val-fax_number INTO telfx.
    ENDIF.
* IMP RU begin of delete
*    concatenate addr1_val-name1 addr1_val-name2
*      addr1_val-CITY1 addr1_val-POST_CODE1 addr1_val-CITY2
*      addr1_val-street addr1_val-HOUSE_NUM1 text-001
*      addr1_val-TEL_NUMBER text-002 addr1_val-FAX_NUMBER
*          into h_doc-cc_name separated by space.
* IMP RU end of delete
    CLEAR lv_landx50.
    SELECT SINGLE landx50 FROM t005t INTO lv_landx50
    WHERE spras = nast-spras
         AND land1 = addr1_val-country.

    CLEAR lv_region.
    SELECT SINGLE bezei FROM t005u INTO lv_region
    WHERE spras = nast-spras
         AND bland = addr1_val-region
         AND land1 = addr1_val-country.

    CLEAR lv_name.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3 addr1_val-name4 INTO lv_name SEPARATED BY ' '.
    CONDENSE lv_name.

    CONCATENATE
      lv_name lv_landx50 addr1_val-post_code1 lv_region
      addr1_val-city2 addr1_val-city1 addr1_val-home_city
      addr1_val-street addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
      addr1_val-roomnumber telf1 telfx INTO h_doc-cc_name SEPARATED BY ', '.
* IMP RU end of insert
  ENDIF.
  vbdkl-sland = addr1_val-country.

ENDFORM.                               "VENDOR_ADDRESS_DATA_PRINT


*&---------------------------------------------------------------------*
*&     Form SHIP_TO_ADDRESS_DATA_print.              #10
*&---------------------------------------------------------------------*
*       Printing of the address data of ship-to debtor                 *
*----------------------------------------------------------------------*

FORM addresses_data_print.

* Begin of change billing instead of shipping partner
*  SELECT SINGLE * FROM KNA1            "Search ship-to
*    WHERE KUNNR EQ VBDKL-KUNNR.

  CLEAR lv_adrnr.
  CLEAR lv_kunre.
  SELECT SINGLE adrnr kunnr FROM vbpa INTO (lv_adrnr, lv_kunre)
                WHERE vbeln EQ vbdkl-vgbel AND
                      posnr EQ '000000' AND
                      parvw EQ 'RE'.

  SELECT SINGLE * FROM kna1            "Search ship-to
    WHERE kunnr EQ lv_kunre.
* End of change billing instead of shipping partner

  CLEAR sel. CLEAR addr1_val.
  sel-addrnumber = lv_adrnr.
  sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.
  IF sy-subrc NE 0.
    CLEAR sel-nation.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        address_selection = sel
      IMPORTING
        address_value     = addr1_val
      EXCEPTIONS
        parameter_error   = 1
        address_not_exist = 2
        version_not_exist = 3
        internal_error    = 4
        OTHERS            = 5.
  ENDIF.
  IF sy-subrc EQ 0.
    CLEAR telf1. CLEAR telfx.
    IF NOT addr1_val-tel_number IS INITIAL.
      CONCATENATE text-001 addr1_val-tel_number INTO telf1.
    ENDIF.
    IF NOT addr1_val-fax_number IS INITIAL.
      CONCATENATE text-002 addr1_val-fax_number INTO telfx.
    ENDIF.
    CLEAR h_doc-consignee.
* IMP RU begin of delete
*    concatenate addr1_val-name1 addr1_val-name2
*      addr1_val-CITY1 addr1_val-POST_CODE1 addr1_val-CITY2
*      addr1_val-street addr1_val-HOUSE_NUM1 TELF1
*      TELFX into h_doc-CONSIGNEE separated by space.
* IMP RU end of delete
* IMP RU begin of insert
    CLEAR lv_landx50.
    SELECT SINGLE landx50 FROM t005t INTO lv_landx50
    WHERE spras = nast-spras
         AND land1 = addr1_val-country.

    CLEAR lv_region.
    SELECT SINGLE bezei FROM t005u INTO lv_region
    WHERE spras = nast-spras
         AND bland = addr1_val-region
         AND land1 = addr1_val-country.

    CLEAR lv_name.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3 addr1_val-name4 INTO lv_name SEPARATED BY ' '.
    CONDENSE lv_name.

    CONCATENATE
      lv_name lv_landx50 addr1_val-post_code1 lv_region
      addr1_val-city2 addr1_val-city1 addr1_val-home_city
      addr1_val-street addr1_val-str_suppl1 addr1_val-str_suppl2 addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
      addr1_val-roomnumber telf1 telfx INTO h_doc-consignee SEPARATED BY ', '.
* IMP RU end of insert

  ENDIF.
  h_doc-consigneeokpo = kna1-stcd2.

  CLEAR lv_adrnr.
  CLEAR lv_kunrg.
  SELECT SINGLE adrnr kunnr FROM vbpa INTO (lv_adrnr, lv_kunrg)
                WHERE vbeln EQ vbdkl-vgbel AND
                      posnr EQ '000000' AND
                      parvw EQ 'RG'.

  SELECT SINGLE * FROM kna1            "Payer
    WHERE kunnr EQ vbdkl-kunag.
  CLEAR sel. CLEAR addr1_val.
  sel-addrnumber = lv_adrnr.
  sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.
  IF sy-subrc NE 0.
    CLEAR sel-nation.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        address_selection = sel
      IMPORTING
        address_value     = addr1_val
      EXCEPTIONS
        parameter_error   = 1
        address_not_exist = 2
        version_not_exist = 3
        internal_error    = 4
        OTHERS            = 5.
  ENDIF.
  IF sy-subrc EQ 0.
    CLEAR telf1. CLEAR telfx.
    IF NOT addr1_val-tel_number IS INITIAL.
      CONCATENATE text-001 addr1_val-tel_number INTO telf1.
    ENDIF.
    IF NOT addr1_val-fax_number IS INITIAL.
      CONCATENATE text-002 addr1_val-fax_number INTO telfx.
    ENDIF.
    CLEAR h_doc-payer.
* IMP RU begin of delete
*    concatenate addr1_val-name1 addr1_val-name2
*      addr1_val-CITY1 addr1_val-POST_CODE1 addr1_val-CITY2
*      addr1_val-street addr1_val-HOUSE_NUM1 TELF1
*      TELFX into h_doc-PAYER separated by space.
* IMP RU end of delete
* IMP RU begin of insert
    CLEAR lv_landx50.
    SELECT SINGLE landx50 FROM t005t INTO lv_landx50
    WHERE spras = nast-spras
         AND land1 = addr1_val-country.

    CLEAR lv_region.
    SELECT SINGLE bezei FROM t005u INTO lv_region
    WHERE spras = nast-spras
         AND bland = addr1_val-region
         AND land1 = addr1_val-country.

    CLEAR lv_name.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3 addr1_val-name4 INTO lv_name SEPARATED BY ' '.
    CONDENSE lv_name.

    CONCATENATE
         lv_name lv_landx50 addr1_val-post_code1 lv_region
         addr1_val-city2 addr1_val-city1 addr1_val-home_city
         addr1_val-street addr1_val-str_suppl1 addr1_val-str_suppl2 addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
         addr1_val-roomnumber telf1 telfx INTO h_doc-payer SEPARATED BY ', '.
* IMP RU end of insert
  ENDIF.
  h_doc-payerokpo = kna1-stcd2.

  SELECT SINGLE * FROM t001 WHERE bukrs EQ tvko-bukrs. "SUPPLIER
  CLEAR sel. CLEAR addr1_val.
  sel-addrnumber = t001-adrnr.         "SADR40A
  sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.
  IF sy-subrc NE 0.
    CLEAR sel-nation.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        address_selection = sel
      IMPORTING
        address_value     = addr1_val
      EXCEPTIONS
        parameter_error   = 1
        address_not_exist = 2
        version_not_exist = 3
        internal_error    = 4
        OTHERS            = 5.
  ENDIF.
  IF sy-subrc EQ 0.
    CLEAR h_doc-supplier.
    CLEAR telf1. CLEAR telfx.
    IF NOT addr1_val-tel_number IS INITIAL.
      CONCATENATE text-001 addr1_val-tel_number INTO telf1.
    ENDIF.
    IF NOT addr1_val-fax_number IS INITIAL.
      CONCATENATE text-002 addr1_val-fax_number INTO telfx.
    ENDIF.
* IMP RU begin of delete
*    concatenate addr1_val-name1 addr1_val-name2
*      addr1_val-CITY1 addr1_val-POST_CODE1 addr1_val-CITY2
*      addr1_val-street addr1_val-HOUSE_NUM1 TELF1
*      TELFX into h_doc-SUPPLIER separated by space.
* IMP RU end of delete

* IMP RU begin of insert
    CLEAR lv_landx50.
    SELECT SINGLE landx50 FROM t005t INTO lv_landx50
             WHERE spras = nast-spras
               AND land1 = addr1_val-country.

    CLEAR lv_region.
    SELECT SINGLE bezei FROM t005u INTO lv_region
    WHERE spras = nast-spras
         AND bland = addr1_val-region
         AND land1 = addr1_val-country.
    IF addr1_val-name3 EQ '§©§¡§° "§¡§´§­§¡§³ §¬§°§±§¬§°"'.
      addr1_val-name3 = '§©§¡§° "§¡§ä§Ý§Ñ§ã §¬§à§á§Ü§à"'.
    ENDIF.

    CONCATENATE
         addr1_val-name3 lv_landx50 addr1_val-post_code1 lv_region
         addr1_val-city2 addr1_val-city1 addr1_val-home_city
         addr1_val-street addr1_val-str_suppl3 addr1_val-location addr1_val-house_num1 addr1_val-house_num2
         addr1_val-roomnumber telf1 telfx INTO h_doc-supplier SEPARATED BY ', '.

* IMP RU end of insert
  ELSE.
    CONCATENATE t001-butxt t001-ort01 INTO
      h_doc-supplier SEPARATED BY space.
  ENDIF.
*       Begin of insertion by -MOD-008
*break-point.
*    IF ( nast-kschl = 'ZU01' OR nast-kschl = 'ZU03' OR
*         nast-kschl = 'ZU05' OR nast-kschl = 'ZU06'
*                             OR nast-kschl = 'ZU10').
*
*      CONCATENATE  wa_kpp-address1  wa_kpp-address INTO h_doc-supplier SEPARATED BY ' '.
*
*    ENDIF.
*  End of insertion by -MOD-008
  SELECT SINGLE paval FROM t001z INTO h_doc-supplierokpo
    WHERE bukrs EQ tvko-bukrs
    AND   party EQ 'SAPR02'.

ENDFORM.                               " ADDRESSes_DATA_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_TEXT_PRINT                                        *
*---------------------------------------------------------------------*
*       Printout of the headertexts                                   *
*---------------------------------------------------------------------*

*FORM HEADER_TEXT_PRINT.
*
*  CALL FUNCTION 'WRITE_FORM'
*       EXPORTING  ELEMENT = 'HEADER_TEXT'
*       EXCEPTIONS ELEMENT = 1
*                  WINDOW  = 2.
*  IF SY-SUBRC NE 0.
*    PERFORM PROTOCOL_UPDATE.
*  ENDIF.
*
*ENDFORM.

*---------------------------------------------------------------------*
*       FORM ITEM_PRINT                                               *
*---------------------------------------------------------------------*
*       Printout of the items                                         *
*---------------------------------------------------------------------*

FORM item_print.

  DATA: desc, sumrz TYPE flag,
        price(15), in1pl(4), afs_detailes(100).
  DATA: lv_posnr TYPE posnr.

* IMP RU Begin of insert - add freight ZU05/ZU06
  DATA: lv_index LIKE sy-tabix,
        total_lines LIKE sy-tabix,
        current_index LIKE sy-tabix,
        lv_kposn LIKE komp-kposn.
* IMP RU End of insert - add freight

  totam = 0.
  totwt = 0.  mm = 0.
  totvol = 0.
  totsum = 0.
  totnds = 0.
  totkol = 0.

  CLEAR num_line.
  REFRESH items.
  CLEAR desc. CLEAR sumrz.
  REFRESH tt_it.

* Get BADI instance
  TRY.
      GET BADI gc_badi_descr.
    CATCH cx_badi_not_implemented.                      "#EC NO_HANDLER
    CATCH cx_badi_multiply_implemented.
      MESSAGE e001(j3r_legal_forms).
    CATCH cx_badi_initial_context.
      MESSAGE e002(j3r_legal_forms).
  ENDTRY.

  IF gc_badi_descr IS BOUND.
    desc = 'X'.
  ENDIF.

  SELECT SINGLE sumrz FROM j_3r_lo_output INTO sumrz
     WHERE kschl    = tnapr-kschl
       AND nacha    = tnapr-nacha
       AND kappl    = tnapr-kappl.

  CLEAR vrkme. CLEAR tot_qnt.
  LOOP AT tvbdpl.
    IF sy-tabix = 1.
      vrkme = tvbdpl-vrkme.
      tot_qnt = 'X'.
    ELSEIF vrkme <> tvbdpl-vrkme.
      CLEAR tot_qnt.
    ENDIF.
  ENDLOOP.

* IMP RU Begin of insert - check options
  CLEAR items_opt. REFRESH items_opt.
* IMP RU End of insert - check options

*  Begin of mod-002
  CLEAR g_ind.

  SELECT *
    FROM yse_kpp
    INTO TABLE gt_kpp
    WHERE spras EQ nast-spras.
*End of mod-002

  LOOP AT tvbdpl.
    vbdpl = tvbdpl.

    "Begin of mod-002
    IF g_ind NE  'X'.
      CLEAR wa_kpp.
      READ TABLE gt_kpp INTO wa_kpp
              WITH KEY werks = vbdpl-werks
                       spras = nast-spras
               BINARY SEARCH.
      IF sy-subrc EQ 0.
        g_ind = 'X'.
      ENDIF.
    ENDIF.
    "End of mod-002

* IMP RU begin of insert
    IF vbdpl-charg IS NOT INITIAL.
      CLEAR lv_flag.
* IMP RU end of insert
      CLEAR wa_item.
      CLEAR tt_it.
      CLEAR pdoc. CLEAR hdoc.
      CLEAR : av_netpr, av_netwr.
      IF vbdpl-lfimg = 0.                  "if quantity = 0
        CONTINUE.
      ENDIF.
      num_line = num_line + 1.

      CLEAR marm.
      SELECT SINGLE * FROM marm         "coeff. for conversion to base units of measure
         WHERE matnr EQ vbdpl-matnr AND meinh EQ vbdpl-vrkme.
      stuz = marm-umrez.     stun = marm-umren.

      SELECT * FROM vbfa                  "billing doc. number
       WHERE   vbelv EQ vbdkl-vbeln
         AND vbtyp_v EQ vbdkl-vbtyp
           AND posnv EQ vbdpl-posnr
         AND vbtyp_n IN ('M', '5').
      ENDSELECT.
      IF sy-subrc NE 0.
*Order's number from Sales Document Flow
        SELECT SINGLE * FROM vbfa           "sales order number
         WHERE vbelv EQ vbdpl-vgbel
           AND vbeln EQ vbdkl-vbeln
           AND vbtyp_v EQ vbdkl-vgtyp
*      AND VBTYP_N EQ VBDKL-VBTYP
             AND posnn EQ vbdpl-posnr
             AND posnv EQ vbdpl-vgpos.
        IF sy-subrc EQ 0.
*      SELECT SINGLE VBTYP KALSM WAERK KNUMV AUART
*                   FROM VBAK INTO       "sales doc. header
*       (HDOC-VBTYP, HDOC-KALSM, HDOC-WAERK, HDOC-KNUMV, HDOC-AUART)
          SELECT SINGLE * FROM vbak
              WHERE vbeln = vbfa-vbelv.
*      SELECT SINGLE MATNR VRKME LSMENG KZWI3 KZWI4 KZWI5 KZWI6
*                  FROM VBAP INTO        "sales doc. line item
*       (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
*       PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6)
          SELECT SINGLE * FROM vbap
              WHERE   vbeln EQ vbfa-vbelv
                AND posnr EQ vbfa-posnv.
          IF sy-subrc = 0.
            hdoc-vbtyp = vbak-vbtyp.
            hdoc-kalsm = vbak-kalsm.
            hdoc-waerk = vbak-waerk.
            hdoc-knumv = vbak-knumv.
            hdoc-auart = vbak-auart.
            pdoc-matnr = vbap-matnr.
            pdoc-vrkme = vbap-vrkme.
            pdoc-lsmeng = vbap-lsmeng.
            pdoc-kzwi3 = vbap-kzwi3.
* IMP RU BEGIN DELETE
*      PDOC-KZWI4 = VBAP-KZWI4.
*      PDOC-KZWI5 = VBAP-KZWI5.
* IMP RU END DELETE
* IMP RU BEGIN INSERT
*      PDOC-KZWI4 = VBAP-CMPRE.
            pdoc-kzwi5 = vbap-mwsbp.
            lv_flag = 'X'.
* IMP RU END INSERT


            CLEAR mm_pr.
            IF torg12 EQ 'X'.
* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->sales_order_item_amounts
*    exporting
*       i_vbak   = vbak
*       i_vbap   = vbap
*    changing
*       i_KZWI3  = PDOC-KZWI3
*       i_KZWI4  = PDOC-KZWI4
*       i_KZWI5  = PDOC-KZWI5.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
            ENDIF.
            PERFORM item_details.

            IF torg12 EQ 'X'.
* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->sales_order_item
*    exporting
*       i_vbdkl  = vbdkl
*       i_vbdpl  = TVBDPL
*       i_vbak   = vbak
*       i_vbap   = vbap
*    changing
*       item  = wa_item.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
            ENDIF.
          ENDIF.
        ELSE.
*      SELECT SINGLE BSTYP KALSM WAERS KNUMV BSART
*                   FROM ekko INTO       "pusch. order header
*       (HDOC-VBTYP, HDOC-KALSM, HDOC-WAERK, HDOC-KNUMV, HDOC-AUART)
          SELECT SINGLE * FROM ekko
              WHERE ebeln = vbdpl-vgbel.
**      SELECT SINGLE MATNR meins menge KZWI3 KZWI4 KZWI5 brtwr
*      SELECT SINGLE MATNR meins menge brtwr
*                  FROM ekpo INTO        "pusch. order line item
*       (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
**       PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6)
*       PDOC-KZWI4)
          SELECT SINGLE * FROM ekpo
              WHERE ebeln EQ vbdpl-vgbel
                AND ebelp EQ vbdpl-vgpos.
          IF sy-subrc = 0.
            hdoc-vbtyp = ekko-bstyp.
            hdoc-kalsm = ekko-kalsm.
            hdoc-waerk = ekko-waers.
            hdoc-knumv = ekko-knumv.
            hdoc-auart = ekko-bsart.
            pdoc-matnr = ekpo-matnr.
            pdoc-vrkme = ekpo-meins.
            pdoc-lsmeng = ekpo-menge.
            pdoc-kzwi3 = ekpo-kzwi3.
*      PDOC-KZWI4 = EKPO-kzwi4.
*      PDOC-KZWI5 = EKPO-KZWI5.
            vbdpl-vgpos = ekpo-ebelp.
            IF torg12 EQ 'X'.

* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->purch_order_item_amounts
*    exporting
*       i_ekko   = ekko
*       i_ekpo   = ekpo
*    changing
*       i_KZWI3  = PDOC-KZWI3
*       i_KZWI4  = PDOC-KZWI4
*       i_KZWI5  = PDOC-KZWI5.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
            ENDIF.
            mm_pr = 'X'.
            PERFORM item_details.
* when the delivery note is created with reference to purchase order
* the method allows to put amount w/o VAT, VAT amount and Aamount with VAT
* into PDOC-KZWI3, PDOC-KZWI4 and PDOC-KZWI5 correspondingly
            IF torg12 EQ 'X'.

* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->purch_order_item
*    exporting
*       i_vbdkl  = vbdkl
*       i_vbdpl  = TVBDPL
*       i_ekko   = ekko
*       i_ekpo   = ekpo
*    changing
*       item  = wa_item.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
*      IF SY-SUBRC = 0.
*        CLEAR MARM.
*        SELECT SINGLE * FROM MARM        "quantity in Base Units of Measure
*          WHERE MATNR EQ PDOC-MATNR AND MEINH EQ PDOC-VRKME.
*        IF NOT MARM-UMREN IS INITIAL.
*          PDOC-LSMENG =
*                   PDOC-LSMENG * MARM-UMREZ / MARM-UMREN.
*        ELSE.
*          CLEAR PDOC-LSMENG.
*        ENDIF.
*      ENDIF.
      ELSE.
*    SELECT SINGLE VBTYP KALSM WAERK KNUMV FKART
*                   FROM VBRK INTO     "billing doc. header
*        (HDOC-VBTYP, HDOC-KALSM, HDOC-WAERK, HDOC-KNUMV, HDOC-FKART)
        SELECT SINGLE * FROM vbrk
           WHERE vbeln = vbfa-vbeln.
*    SELECT SINGLE MATNR VRKME FKIMG KZWI3 KZWI4 KZWI5 KZWI6
*                      FROM VBRP INTO    "billing doc. item data
*      (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
*       PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6)
        SELECT SINGLE * FROM vbrp
        WHERE   vbeln EQ vbfa-vbeln
            AND posnr EQ vbfa-posnn.
        IF sy-subrc = 0.
          hdoc-vbtyp = vbrk-vbtyp.
          hdoc-kalsm = vbrk-kalsm.
          hdoc-waerk = vbrk-waerk.
          hdoc-knumv = vbrk-knumv.
          hdoc-fkart = vbrk-fkart.
          pdoc-matnr = vbrp-matnr.
          pdoc-vrkme = vbrp-vrkme.
          pdoc-lsmeng = vbrp-fkimg.
          pdoc-kzwi3 = vbrp-kzwi3.
* IMP RU BEGIN DELETE
*     PDOC-KZWI4 = VBRP-KZWI4.
*     PDOC-KZWI5 = VBRP-KZWI5.
* IMP RU END DELETE

* IMP RU BEGIN INSERT
          pdoc-kzwi4 = vbrp-skfbp.
          pdoc-kzwi5 = vbrp-mwsbp.
* IMP RU END INSERT
          CLEAR mm_pr.
          IF torg12 EQ 'X'.

* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->billing_item_amounts
*    exporting
*       i_vbrk   = vbrk
*       i_vbrp   = vbrp
*    changing
*       i_KZWI3  = PDOC-KZWI3
*       i_KZWI4  = PDOC-KZWI4
*       i_KZWI5  = PDOC-KZWI5.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
          ENDIF.
          PERFORM item_details.
          IF torg12 EQ 'X'.

* IMP_RU_BEGIN_DELETE
*  CALL BADI gc_badi_torg12->billing_item
*    exporting
*       i_vbdkl  = vbdkl
*       i_vbdpl  = TVBDPL
*       i_vbrk   = vbrk
*       i_vbrp   = vbrp
*    changing
*       item  = wa_item.
* IMP_RU_END_DELETE

*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
          ENDIF.
        ENDIF.

      ENDIF.


*    TOTVOL = TOTVOL + VBDPL-NETWR.     "total amount w/o vat

      totam = totam + wa_item-lfimg.       "total act.quan. in SalesUnit
      totwt = totwt + wa_item-brgew.       "total Gross weight
      totnt = totnt + wa_item-ntgew.       "total Net weight
      totvol = totvol + wa_item-netwr.     "total amount w/o vat
      totsum = totsum + wa_item-wrbtr.     "total amount with vat
      totnds = totnds + wa_item-vat.       "total VAT
**********************

* IMP RU Begin of insert - subtract freight from previous lines ZU05
      IF nast-kschl = 'ZU05' OR nast-kschl = 'ZU06'.
* take the freight from the specific batch line
        IF NOT vbrk-vbeln IS INITIAL.
          CLEAR lv_posnr.
          SELECT SINGLE posnr FROM vbrp INTO lv_posnr
            WHERE vbeln = vbrk-vbeln AND vgpos = vbdpl-posnr.

          LOOP AT tkomv
            WHERE kschl = 'ZD00' AND knumv = komk-knumv AND kposn = lv_posnr.
          ENDLOOP.
        ELSE.
          CLEAR lv_kposn.
          LOOP AT tkomv
            WHERE kschl = 'ZD00' AND knumv = komk-knumv AND kposn = komp-kposn.
            lv_kposn = komp-kposn.
          ENDLOOP.
          IF tkomv-kwert EQ 0.
            lv_kposn = lv_kposn + 1.
            LOOP AT tkomv
            WHERE kschl = 'ZD00' AND knumv = komk-knumv AND kposn = lv_kposn.
            ENDLOOP.
          ENDIF.
        ENDIF.
* first take exchange rate from invoice if exists

        CLEAR lv_kursk.
        SELECT SINGLE kurrf FROM vbrk INTO lv_kursk
        WHERE vbeln = vbrk-vbeln.
* if no invoice exchange rate-> take it from the sales order
        IF lv_kursk IS INITIAL.
          CLEAR lv_kursk.
          SELECT SINGLE kursk FROM vbkd INTO lv_kursk
          WHERE vbeln = vbdkl-vbeln_vauf AND posnr = vbdpl-posnr_vauf.
        ENDIF.

        CLEAR lv_uni_freight.
        IF lv_convert = 'X'.
          lv_uni_freight =  tkomv-kwert / wa_item-lfimg.
          wa_item-price =  wa_item-price - lv_uni_freight.
          wa_item-price = wa_item-price * lv_kursk.
*           wa_item-netwr = ( wa_item-netwr - tkomv-kwert ) * lv_kursk .
          IF wa_item-lfimg = 0.
            wa_item-netwr = wa_item-price .
          ELSE.
            wa_item-netwr = wa_item-price * wa_item-lfimg.
          ENDIF.
        ELSE.
          wa_item-netwr =  wa_item-netwr - tkomv-kwert.
          lv_uni_freight = tkomv-kwert / wa_item-lfimg.
          wa_item-price =  wa_item-price -  lv_uni_freight.
        ENDIF.

*           wa_item-netwr = wa_item-netwr - tkomv-kwert. "also other way to calculate net price
        wa_item-vat = wa_item-netwr * st_nds / 100.
        wa_item-wrbtr = wa_item-netwr + wa_item-vat.
      ENDIF.
* IMP RU End of insert - add freight
* IMP RU Begin of insert - check options / also for freight with options(ZU06)
      IF nast-kschl = 'ZU03' OR nast-kschl = 'ZU06'.
        IF vbdpl-matkl = '01' OR vbdpl-matkl = '02'.
          APPEND wa_item  TO items.
        ELSE.
          APPEND wa_item  TO items_opt.
        ENDIF.
      ELSE.
        APPEND wa_item  TO items.
      ENDIF.
* IMP RU End of insert - check options




      IF desc EQ 'X'.
        CLEAR afs_detailes.
* IMP_RU_BEGIN_DELETE
*      CALL BADI gc_badi_descr->MATERIAL_DETAILS
*        exporting
*           MATNR    = VBDPL-MATNR
*           WERKS    = VBDPL-WERKS
*           LGORT    = VBDPL-LGORT
*           CHARG    = VBDPL-CHARG
*        importing
*           DETAILES = AFS_DETAILES.
* IMP_RU_END_DELETE

*        exceptions
*           OTHERS   = 1.
*      IF sy-subrc <> 0.
*        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*      else.
        tt_it-matdet = afs_detailes.
*      ENDIF.
      ENDIF.

      MOVE-CORRESPONDING wa_item TO tt_it-wa_item.
      price = wa_item-price.
      in1pl = wa_item-in1pl.
      CONCATENATE vbdpl-matnr vbdpl-werks vbdpl-lgort wa_item-vrkme price
         wa_item-magrv in1pl wa_item-st_vat
            INTO tt_it-key_field.
      CONDENSE tt_it-key_field.
      APPEND tt_it.
* IMP RU begin of insert
    ENDIF.
* IMP RU end of insert
  ENDLOOP.

* IMP RU Begin of insert - check options / also for freight with options (ZU06)
  IF nast-kschl = 'ZU03' OR nast-kschl = 'ZU06'.
    CLEAR wa_items_opt.
    LOOP AT items INTO wa_items_opt.
*     clear gt_smtot.
*     clear gt_smvat.
      CLEAR wa_items_opt2.
      LOOP AT items_opt INTO wa_items_opt2 WHERE uepos = wa_items_opt-uepos.
        wa_items_opt-netwr = wa_items_opt-netwr + wa_items_opt2-netwr.
        wa_items_opt-price = wa_items_opt-price + wa_items_opt2-price.
        wa_items_opt-vat = wa_items_opt-vat + wa_items_opt2-vat.
        wa_items_opt-wrbtr = wa_items_opt-wrbtr + wa_items_opt2-wrbtr.
*        gt_smtot = gt_smtot + wa_invoice_opt-total.
*        gt_smvat = gt_smvat + wa_invoice_opt-smvat.
      ENDLOOP.
      MODIFY items FROM wa_items_opt.
      CLEAR wa_items_opt.
*      hd_invoice-smvat = gt_smvat.
*      hd_invoice-smtot = gt_smtot.
    ENDLOOP.
  ENDIF.
* IMP RU End of insert - check options


* IMP RU Begin of insert - add freight ZU05/ZU06
* if nast-kschl = 'ZU05'.
*
*    clear wa_item.
*
*    loop at tkomv
*        where kschl = 'ZD00' and KNUMV = KOMK-KNUMV.
*        wa_item-netwr = tkomv-kbetr.
*    endloop.
*   if wa_item-netwr is not initial.
** add freight line on invoice
*    SELECT SINGLE MSEH3 FROM T006A into wa_item-MSEH3
*    WHERE MSEHI EQ 'ST' AND SPRAS EQ nast-spras .
*     wa_item-MATNR = ' '.
*     wa_item-LFIMG = '1'.
*     wa_item-st_vat = ST_NDS.
*     wa_item-vat = wa_item-netwr * ST_NDS / 100.
*     wa_item-wrbtr = wa_item-vat + wa_item-netwr.
*    describe table items lines lv_index.
*    read table items into ps_items index lv_index.
**
*     ps_items-posnum = ps_items-posnum + 1.
*
*      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*      EXPORTING
*        input  = ps_items-posnum
*      IMPORTING
*        output = ps_items-posnum.
*     wa_item-BRGEW = ' '.
*     wa_item-POSNUM = ps_items-posnum.
*     wa_item-ARKTX = text-t01.
*     wa_item-SERDES = ' '.
*     wa_item-LGPBE = ' '.
*     wa_item-vtext = ' '.
*     wa_item-HANDL_NBR = ' '.
*     wa_item-price = wa_item-netwr.
*   append wa_item  to items.
*   endif.
* Change last line before freight... to avoid differences because of rounding
  DESCRIBE TABLE items LINES total_lines.
*    total_lines = total_lines - 1. " line before last line(freight)
**   clear wa_invoice_opt.
  CLEAR lv_calc_wrbtr.
  CLEAR lv_calc_vat.
  CLEAR lv_calc_netwr.
*
  LOOP AT items INTO wa_item_frght.
    current_index = sy-tabix.
    lv_calc_vat = lv_calc_vat + wa_item_frght-vat.
    lv_calc_wrbtr = lv_calc_wrbtr + wa_item_frght-wrbtr.
    lv_calc_netwr = lv_calc_netwr + wa_item_frght-netwr.
  ENDLOOP.
*
*    clear wa_item_frght.
*    loop at items into wa_item_frght.
*        current_index = sy-tabix.
*         if current_index = total_lines.
*          clear: wa_item_frght-vat, wa_item_frght-wrbtr.
*           wa_item_frght-vat = TOTNDS - lv_calc_vat.
*           wa_item_frght-wrbtr = TOTSUM - lv_calc_wrbtr.
*           MODIFY items from wa_item_frght index current_index.
*         endif.
*    endloop.
* endif.
* IMP RU End of insert - add freight




  DATA: cnt TYPE i, lin TYPE i, num TYPE i, key_field(62).
  IF NOT sumrz IS INITIAL.
    REFRESH items. CLEAR wa_item.
    SORT tt_it BY key_field.
    CLEAR cnt. CLEAR lin. CLEAR num_line. CLEAR key_field. CLEAR num.
    DESCRIBE TABLE tt_it LINES num_line.
    LOOP AT tt_it.
      num = num + 1.
      IF sy-tabix EQ 1.
        CLEAR tt_it-wa_item-posnum.
        MOVE-CORRESPONDING tt_it-wa_item TO wa_item.
        lin = lin + 1.
        wa_item-posnum = lin.
        key_field = tt_it-key_field.
        cnt = cnt + 1.
      ELSE.
        IF tt_it-key_field EQ key_field.
          wa_item-places = wa_item-places + tt_it-wa_item-places.
          wa_item-lsmeng = wa_item-lsmeng + tt_it-wa_item-lsmeng.
          wa_item-lfimg = wa_item-lfimg + tt_it-wa_item-lfimg.
          wa_item-brgew = wa_item-brgew + tt_it-wa_item-brgew.
          wa_item-ntgew = wa_item-ntgew + tt_it-wa_item-ntgew.
          wa_item-netwr = wa_item-netwr + tt_it-wa_item-netwr.
          wa_item-vat = wa_item-vat + tt_it-wa_item-vat.
          wa_item-wrbtr = wa_item-wrbtr + tt_it-wa_item-wrbtr.
          cnt = cnt + 1.
        ELSE.
          IF cnt = 1.
            CLEAR wa_item-arktx.
            CONCATENATE tt_it-wa_item-arktx tt_it-matdet INTO wa_item-arktx.
          ENDIF.
          APPEND wa_item  TO items.
          CLEAR wa_item. CLEAR cnt.
          CLEAR tt_it-wa_item-posnum.
          MOVE-CORRESPONDING tt_it-wa_item TO wa_item.
          lin = lin + 1.
          wa_item-posnum = lin.
          key_field = tt_it-key_field.
          cnt = cnt + 1.
        ENDIF.
      ENDIF.
      IF num = num_line.
        IF cnt = 1.
          CLEAR wa_item-arktx.
          CONCATENATE tt_it-wa_item-arktx tt_it-matdet INTO wa_item-arktx.
        ENDIF.
        APPEND wa_item  TO items.
      ENDIF.
    ENDLOOP.
    DESCRIBE TABLE items LINES num_line.
  ELSEIF desc EQ 'X'.
    REFRESH items. CLEAR wa_item.
    LOOP AT tt_it.
      MOVE-CORRESPONDING tt_it-wa_item TO wa_item.
      CLEAR wa_item-arktx.
      CONCATENATE tt_it-wa_item-arktx tt_it-matdet INTO wa_item-arktx.
      APPEND wa_item  TO items.
      CLEAR wa_item.
    ENDLOOP.
  ENDIF.
  REFRESH tt_it.

  CLEAR mseh3.
* IMP RU BEGIN DELETE
*  if tot_qnt is initial.
*    clear h_doc-tot_quant.
*  else.
* IMP RU END DELETE
  h_doc-tot_quant = totam.
* IMP RU BEGIN DELETE
*  endif.
* IMP RU END DELETE
  SELECT SINGLE mseh3
    INTO mseh3
    FROM t006a
    WHERE spras EQ language AND msehi EQ vbdkl-gewei.   "#EC CI_GENBUFF
  IF sy-subrc NE 0.
    SELECT SINGLE mseh3
      INTO mseh3
      FROM t006a
      WHERE spras EQ vbdkl-spras AND msehi EQ vbdkl-gewei. "#EC CI_GENBUFF
  ENDIF.
  IF NOT mseh3 IS INITIAL.
    MOVE mseh3 TO h_doc-gewei.
  ELSE.
    h_doc-gewei = vbdkl-gewei.
  ENDIF.
  h_doc-brgew = totwt.
  h_doc-ntgew = totnt.
  h_doc-tot_netwr = lv_calc_netwr.
  h_doc-tot_sum = lv_calc_wrbtr.
  h_doc-tot_vat = lv_calc_vat.
* IMP RU BEGIN INSERT
  h_doc-totplace = lv_counter2.
* IMP RU END INSERT
* IMP RU BEGIN CHANGE
*  SUM  = NUM_LINE.
  sum  = num_line / 10.
* IMP RU END CHANGE
  "### ###### ##¨¦### ######¨¢### ¡Á###¨¢##
  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = sum
      currency  = 'ZCURR'        "######### ###### ### #¨¤####¨¬-
      filler    = ' '            "### ¨¤##### SPELL
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  h_doc-totlin = spell-word.

  sum = vbdkl-ntgew / 1000 * 100.
  nn = vbdkl-ntgew / 1000.
  mm = TRUNC( nn ).               "  rub.
  nn = FRAC( nn ).
  mm = TRUNC( nn * 1000 ).        "  kop.
  dec_net = mm.

  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = sum
      currency  = 'ZCURR'
      filler    = ' '
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  spel_neto = spell-word.
*dec_net = spell-decimal.

  sum = totwt.
*  NN = VBDKL-BRGEW.
*  MM = TRUNC( NN ).
*  NN = FRAC( NN ).
*  DEC_BRT = TRUNC( NN * 1000 ).
*  SUM = MM.

  CALL FUNCTION 'SPELL_AMOUNT'
       EXPORTING
            amount    = sum
* IMP RU BEGIN INSERT
            currency  = '3'
* IMP RU END INSERT
* IMP RU BEGIN DELETE
*           CURRENCY  = 'ZCURR'
* IMP RU END DELETE

            filler    = ' '
            language  = language
       IMPORTING
            in_words  = spell
       EXCEPTIONS
            not_found = 1
            too_large = 2
            OTHERS    = 3.
  spel_brto = spell-word.
  dec_brt = spell-decimal.
* IMP RU BEGIN INSERT
* For salesorganisation IT everything is displayed in grams
  IF vbdkl-vkorg = 'RU03' OR vbdkl-vkorg = 'RU04' .
    CONCATENATE spel_brto  '§Ô§â'
         INTO h_doc-w_brgew
    SEPARATED BY space.
    h_doc-gewei = '§Ô§â'.
  ELSE.
    CONCATENATE spel_brto  h_doc-gewei dec_brt '§Ô§â'
           INTO h_doc-w_brgew
      SEPARATED BY space.
  ENDIF.
* IMP RU END INSERT

  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      amount    = lv_calc_wrbtr
      currency  = 'RUB'     " ###### ######### ¨¢####
      filler    = ' '
      language  = language
    IMPORTING
      in_words  = spell
    EXCEPTIONS
      not_found = 1
      too_large = 2
      OTHERS    = 3.
  CONCATENATE spell-word spell-decword(6)
         INTO h_doc-w_tot_sum
    SEPARATED BY space.

ENDFORM.                    "ITEM_PRINT

*&---------------------------------------------------------------------*
*&      Form  ITEM_DETAILS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM item_details .

  DATA: pr TYPE i.

  IF h_doc-waerk <> 'RUB'.
    lv_convert = 'X'.
    h_doc-waerk = 'RUB'.
  ENDIF.


  "Decimal Places in Currency
  tcurx-currdec = 2.
  SELECT SINGLE * FROM tcurx WHERE currkey = hdoc-waerk.
  IF tcurx-currdec = 0.
    onehundred = 100.                  "w/o decimal places
  ELSE.
    onehundred = 1.
  ENDIF.

  CLEAR marm.
  SELECT SINGLE * FROM marm        "quantity in Base Units of Measure
    WHERE matnr EQ pdoc-matnr AND meinh EQ pdoc-vrkme.
  IF NOT marm-umren IS INITIAL.
    pdoc-lsmeng =
             pdoc-lsmeng * marm-umrez / marm-umren.
  ELSE.
    CLEAR pdoc-lsmeng.
  ENDIF.
*      VBDPL-VGPOS = VBFA-POSNN.   "to take care of material with more than 1 batch linked to it.

*if mm_pr is initial.
  SELECT   * FROM t683s
  WHERE kalsm EQ hdoc-kalsm AND kvewe EQ 'A' AND ( kappl EQ 'V' OR kappl EQ 'M' ).
    IF t683s-kzwiw EQ '5'.
      tbvat-znvat = t683s-stunr.
      APPEND tbvat.
    ENDIF.
  ENDSELECT.

******************  **************
*   select single * from lips      "##### ####¨¤ ¡Á##. # ###. ##¡Á. ¡Á##.
*      where vbeln = vbdkl-vbeln and posnr = vbdpl-posnr.
  CLEAR: komp, tkomv, st_nds.
  IF komk-knumv NE hdoc-knumv.
    CLEAR komk.
    komk-mandt = sy-mandt.
    komk-kalsm = hdoc-kalsm.
    komk-auart = hdoc-auart.
    komk-fkart = hdoc-fkart.
*    komk-autyp = vbak-vbtyp.
*    komk-kappl = pr_kappl.
*    if vbdkr-kappl ne space.
    komk-kappl = t683s-kappl. "'V'.
*    endif.
    komk-waerk = hdoc-waerk.
    komk-knumv = hdoc-knumv.
    komk-vbtyp = hdoc-vbtyp.
  ENDIF.
*  komp-kposn = lips-vgpos.
  komp-kposn = vbdpl-vgpos.

  CALL FUNCTION 'RV_PRICE_PRINT_ITEM'
    EXPORTING
      comm_head_i = komk
      comm_item_i = komp
      language    = ' '    "NAST-SPRAS
    IMPORTING
      comm_head_e = komk
      comm_item_e = komp
    TABLES
      tkomv       = tkomv
      tkomvd      = tkomvd.

  CLEAR komp-kzwi2.
  CLEAR sy-tvar0.

* IMP RU BEGIN INSERT
  CLEAR sy-tvar1.

  LOOP AT tkomv
            WHERE kschl = 'MWR1' AND knumv = komk-knumv AND kposn = komp-kposn.
    sy-tvar0 = tkomv-kbetr.
  ENDLOOP.

  IF lv_flag = 'X'.

    LOOP AT tkomv
              WHERE kschl = 'SKTO' AND knumv = komk-knumv AND kposn = komp-kposn.
      pdoc-kzwi4 = tkomv-kawrt. "total with vat (VBAP - without invoice)
    ENDLOOP.
  ENDIF.

* IMP RU END INSERT

  LOOP AT tbvat.
    pr = 0.
    LOOP AT tkomvd.
*    if tkomvd-kposn eq lips-vgpos and tkomvd-stunr eq tbvat-znvat.
      IF tkomvd-kposn EQ komp-kposn AND tkomvd-stunr EQ tbvat-znvat.
        sy-tvar0 = tkomvd-kbetr.
        pr = 1.
        EXIT.
      ENDIF.
    ENDLOOP.
    IF pr = 1.
      EXIT.
    ENDIF.
  ENDLOOP.
  st_nds = sy-tvar0+12(3).
  IF st_nds IS INITIAL.
    st_nds = '0'.
  ENDIF.
  wa_item-st_vat = st_nds.
*endif.
  """""" Variant of subtotals use """""""
  vbdpl-netpr = pdoc-kzwi3.           "sum w/o VAT of order item
* IMP RU Begin of insert
*    AV_NETPR = lv_kwert.              "VAT sum for order item
*    AV_NETWR = lv_kawrt. "Sum with VAT for order item
* IMP RU End of insert
* IMP RU Begin of delete
  av_netpr = pdoc-kzwi5.              "VAT sum for order item
  av_netwr = pdoc-kzwi4. "Sum with VAT for order item
* IMP RU End of delete

  IF NOT  pdoc-lsmeng IS INITIAL.
    IF NOT stun IS INITIAL.
      vbdpl-netwr =                    "sum w/o VAT
        vbdpl-netpr * vbdpl-lfimg * stuz / stun / pdoc-lsmeng.
      av_netpr =                       "VAT sum
        av_netpr * vbdpl-lfimg * stuz / stun / pdoc-lsmeng.
      av_netwr =                       "Sum with VAT
        av_netwr * vbdpl-lfimg * stuz / stun / pdoc-lsmeng.
      vbdpl-netpr =                    "Price w/o VAT
                vbdpl-netpr * stuz / stun / pdoc-lsmeng.
    ELSE.
      CLEAR: vbdpl-netwr, av_netpr, av_netwr, vbdpl-netpr.
    ENDIF.
  ENDIF.

  vbdpl-netpr = vbdpl-netpr * onehundred.  "Price w/o VAT
  wa_item-price = vbdpl-netpr.
  vbdpl-netwr = vbdpl-netwr * onehundred.  "sum w/o VAT
  wa_item-netwr = vbdpl-netwr.
  av_netpr = av_netpr * onehundred.        "VAT sum
  wa_item-vat = av_netpr.
  av_netwr = av_netwr * onehundred.        "Sum with VAT
  wa_item-wrbtr = av_netwr.
  wa_item-waerk = hdoc-waerk.
  wa_item-arktx = vbdpl-arktx.
* IMP RU Begin of insert - check options / also for freight with options(ZU06)
  wa_item-uepos = vbdpl-uepos.
* IMP RU End of insert - check options / also for freight with options(ZU06)
* first take exchange rate from invoice if exists
  CLEAR lv_kursk.
  SELECT SINGLE kurrf FROM vbrk INTO lv_kursk
  WHERE vbeln = vbrk-vbeln.
* if no invoice exchange rate-> take it from the sales order
  IF lv_kursk IS INITIAL.
    CLEAR lv_kursk.
    SELECT SINGLE kursk FROM vbkd INTO lv_kursk
    WHERE vbeln = vbdkl-vbeln_vauf AND posnr = vbdpl-posnr_vauf.
  ENDIF.
  IF lv_convert = 'X' AND ( nast-kschl <> 'ZU05' AND nast-kschl <> 'ZU06' ).

*       wa_item-netwr = wa_item-netwr * lv_kursk.
*       wa_item-price = wa_item-price * lv_kursk.
*       wa_item-wrbtr = wa_item-wrbtr * lv_kursk.
*       wa_item-vat = wa_item-vat * lv_kursk.
    wa_item-price = wa_item-price * lv_kursk.
    IF vbdpl-lfimg = 0.
      wa_item-netwr = wa_item-price .
    ELSE.
      wa_item-netwr = wa_item-price * vbdpl-lfimg.
    ENDIF.
    wa_item-vat = wa_item-netwr * st_nds / 100.
    wa_item-wrbtr = wa_item-netwr + wa_item-vat.
  ENDIF.

* Begin of change final remarks - punt 10
*    wa_item-matnr = vbdpl-matnr.

  CLEAR lv_matnr.
  CLEAR lv_matnr2.
  CLEAR lv_matnr3.
*** Begin of ENS Number check for CMT


  SELECT SINGLE * INTO wa_yse_ens FROM yse_ens
  WHERE vkorg = vbdkl-vkorg
    AND vtweg = vbdpl-vtweg
    AND kunnr = vbdkl-kunag.


  IF sy-subrc = 0.
    lv_ens = 'X'.
    SELECT SINGLE kdmat INTO lv_matnr2 FROM knmt
            WHERE vkorg = vbdkl-vkorg
            AND kunnr = vbdkl-kunag
            AND vtweg = vbdpl-vtweg
            AND matnr = vbdpl-matnr.
  ELSE.
    CLEAR lv_matnr2.
  ENDIF.


  lv_matnr = vbdpl-matnr.
* Begin of MOD-004
*  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*    EXPORTING
*      input  = lv_matnr
*    IMPORTING
*      output = lv_matnr3.
  IF STRLEN( lv_matnr ) = 18.
*  CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'   " MOD-005
    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'  " MOD-005
     EXPORTING
       input        = lv_matnr
     IMPORTING
       output       = lv_matnr3
     EXCEPTIONS
       length_error = 1
       OTHERS       = 2.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.
  ELSE.
    lv_matnr3 = lv_matnr.
  ENDIF.
  CASE strlen( lv_matnr3 ).
    WHEN 6.
      CONCATENATE '0000' lv_matnr3 INTO lv_matnr3.
    WHEN 7.
      CONCATENATE  '000' lv_matnr3 INTO lv_matnr3.
    WHEN 8.
      CONCATENATE  '00'  lv_matnr3 INTO lv_matnr3.
    WHEN 9.
      CONCATENATE   '0'  lv_matnr3 INTO lv_matnr3.
  ENDCASE.
* End of MOD-004
  CLEAR wa_item-matnr.
  wa_item-matnr = lv_matnr3.


  IF lv_matnr2 IS NOT INITIAL.
    wa_item-mat_ens = lv_matnr2.
  ENDIF.
*** End of ENS Number check for CMT
* End of change final remarks - punt 10

  CLEAR: mseht, mseh3.
  SELECT SINGLE
        mseht  mseh3 mseh6
  INTO (mseht, mseh3, wa_item-vrkme)
  FROM t006a
  WHERE spras EQ language AND msehi EQ vbdpl-vrkme.     "#EC CI_GENBUFF
  IF sy-subrc NE 0.
    SELECT SINGLE
        mseht  mseh3 mseh6
    INTO (mseht, mseh3, wa_item-vrkme)
    FROM t006a
    WHERE spras EQ vbdkl-spras AND msehi EQ vbdpl-vrkme. "#EC CI_GENBUFF
  ENDIF.


  IF wa_item-vrkme IS INITIAL.
    MOVE mseh3 TO wa_item-vrkme.
  ENDIF.
*IMP_RU_BEGIN_INSERT
  MOVE mseh3 TO wa_item-mseh3.
* Bin Location
  SELECT SINGLE lgpbe INTO wa_item-lgpbe FROM mard
    WHERE werks = vbdpl-werks AND lgort = vbdpl-lgort AND matnr = vbdpl-matnr.

* Retrieve Serial numbers
  lv_anzsn = 0.
  SELECT SINGLE anzsn INTO lv_anzsn FROM lips WHERE vbeln = vbdpl-vbeln
                           AND posnr = vbdpl-posnr.
  IF sy-subrc = 0.
    IF lv_anzsn > 0.
      CLEAR tkomser2[].
* READ THE SERIALNUMBERS OF A POSITION.
      CALL FUNCTION 'SERIAL_LS_PRINT'
        EXPORTING
          vbeln  = vbdpl-vbeln
          posnr  = vbdpl-posnr
        TABLES
          iserls = tkomser2.

      CLEAR wa_item-serdes.
      CLEAR teller.

      LOOP AT tkomser2.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = tkomser2-sernr
          IMPORTING
            output = tkomser2-sernr.

        IF teller = 0.
          wa_item-serdes =  tkomser2-sernr.
        ELSE.
          CONCATENATE wa_item-serdes tkomser2-sernr INTO wa_item-serdes SEPARATED BY '-'.
        ENDIF.
        ADD 1 TO teller.
      ENDLOOP.

    ENDIF.
  ENDIF.

* retrieve the handling units
  lv_vhart = ' '.
  SELECT SINGLE venum FROM vepo INTO lv_venum
     WHERE vbeln EQ vbdpl-vbeln
       AND matnr EQ vbdpl-matnr
       AND werks EQ vbdpl-werks
       AND posnr EQ vbdpl-posnr.
  IF sy-subrc EQ 0. "HU found for current item
    SELECT SINGLE vhart FROM vekp INTO lv_vhart
     WHERE venum = lv_venum.
    IF sy-subrc EQ 0.
      SELECT SINGLE vtext FROM tvtyt INTO wa_item-vtext
       WHERE traty = lv_vhart AND spras = nast-spras.
    ELSE.
      wa_item-vtext = ' '.
    ENDIF.
  ENDIF.

  lv_counter = 0.
  lv_counter2 = 0.
  SELECT COUNT(*) FROM vepo INTO lv_counter
  WHERE vbeln EQ vbdpl-vbeln
    AND matnr EQ vbdpl-matnr
    AND werks EQ vbdpl-werks
    AND posnr EQ vbdpl-posnr.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = lv_counter
    IMPORTING
      output = lv_counter.


  wa_item-handl_nbr = lv_counter.

  lv_counter2 = lv_counter2 + lv_counter.

*IMP_RU_END_INSERT

  wa_item-mseht = mseht.
  wa_item-lsmeng =
        pdoc-lsmeng * stun / stuz.  "requested amount in sales unit
*    wa_item-lsmeng = VBAP-LSMENG.
  wa_item-lfimg = vbdpl-lfimg.
* convert lines' units to delivery unit
  PERFORM unit_conversion_simple USING vbdpl-gewei
                                       vbdkl-gewei
                              CHANGING vbdpl-brgew.
  wa_item-brgew = vbdpl-brgew.
  PERFORM unit_conversion_simple USING vbdpl-gewei
                                       vbdkl-gewei
                              CHANGING vbdpl-ntgew.
  wa_item-ntgew = vbdpl-ntgew.
  wa_item-gewei = vbdkl-gewei.
*    wa_item-gewei = vbdpl-gewei.
  wa_item-posnum = num_line.
*    IF VBDPL-UECHA IS INITIAL.
**     call function 'CONTROL_FORM'
**          exporting
**               command = 'PROTECT'.
*      perform get_item_characteristics_batch.
*      PERFORM ITEM_CHARACTERISTICS_BATCH.
*      CALL FUNCTION 'WRITE_FORM'
*           EXPORTING
*                ELEMENT = 'ITEM_LINE'.
**     call function 'CONTROL_FORM'
**          exporting
**               command = 'ENDPROTECT'.
*    ELSE.
*      PERFORM GET_ITEM_CHARACTERISTICS_BATCH.
*      PERFORM ITEM_CHARACTERISTICS_BATCH.
*      CALL FUNCTION 'WRITE_FORM'
*           EXPORTING
*                ELEMENT = 'ITEM_LINE'.
*    endif.
ENDFORM.                    " ITEM_DETAILS


*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_BATCH                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics for batches              *
*---------------------------------------------------------------------*

FORM item_characteristics_batch.

  LOOP AT tkombat.
    conf_out = tkombat.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_BATCH_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_BATCH'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_BATCH

*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_PRINT                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics -> configuration         *
*---------------------------------------------------------------------*

FORM item_characteristics_print.

  LOOP AT tkomcon.
    conf_out = tkomcon.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_SERIAL_NO_PRINT                                     *
*---------------------------------------------------------------------*
*       Printout of the item serialnumbers                            *
*---------------------------------------------------------------------*

FORM item_serial_no_print.

  LOOP AT tkomser_print.
    komser = tkomser_print.
    IF sy-tabix = 1.
*     Output of the Headerline
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_NO_HEADER'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
*     Output of the following printlines
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_NO'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
    AT LAST.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'NEW-LINE'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDAT.
  ENDLOOP.

ENDFORM.                    "ITEM_SERIAL_NO_PRINT

*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*

FORM protocol_update.

  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE

*&---------------------------------------------------------------------*
*&      Form  OPEN_FORM_SAMMEL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM open_form_sammel.
  DATA: fp_outputparams   TYPE sfpoutputparams.

*Sets output parameters and opens the spool job
  fp_outputparams-pdftagged = 'X'.

  PERFORM itcpo_fuellen.
  PERFORM fill_outputparams_pdf USING    itcpo
                                CHANGING fp_outputparams.

  CALL FUNCTION 'FP_JOB_OPEN'
    CHANGING
      ie_outputparams = fp_outputparams
    EXCEPTIONS
      cancel          = 1
      usage_error     = 2
      system_error    = 3
      internal_error  = 4
      OTHERS          = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* TNAPR-FORMTYPE = 2
* NAST-SPRAS
  x_open = 'X'.
ENDFORM.                    "OPEN_FORM_SAMMEL

*&---------------------------------------------------------------------*
*&      Form  print_FORM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM print_form .
  DATA: func_module_name     TYPE rs38l_fnam.
  DATA: fp_docparams      TYPE sfpdocparams,
        l_errstr TYPE string.



  IF lv_ens = 'X'.
* Overwrite Bankdata of Supplier / Company Code Customer Norilisk
    CONCATENATE h_doc-supplier text-th3 INTO h_doc-supplier SEPARATED BY ', '.

* Overwrite Name, Address, Bank Data for Sales Organisation Data Customer Norilisk
    IF g_ind NE 'X'.
      CONCATENATE text-th1 text-th2 INTO h_doc-cc_name.
    ENDIF.
    tnapr-sform = 'YSE_J_3RV_T12_PDF_NOR'.
    CLEAR lv_salord.
    lv_salord = vbdkl-vgbel.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        id                      = 'SL06'
        language                = language
        name                    = lv_salord
        object                  = 'VBBK'
      TABLES
        lines                   = i_lines
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.
    IF sy-subrc = 0.
      LOOP AT i_lines.
        CONCATENATE wa_txt-text i_lines-tdline INTO wa_txt-text SEPARATED BY ' '.
      ENDLOOP.
    ENDIF.

    CONCATENATE  wa_txt-text text-t10 lv_salorder text-t11 lv_bstkd
              INTO h_doc-given SEPARATED BY space.
  ENDIF.


  PERFORM read_fm USING tnapr-sform
                    CHANGING func_module_name.

* Call the generated functional module
* set locale RU_ru
  IF language = 'R'.
    fp_docparams-langu = 'R'.
    fp_docparams-country = 'RU'.

*   Begin of insertion by -MOD-008
*BREAK-POINT.
    IF ( nast-kschl = 'ZU01' OR nast-kschl = 'ZU03' OR
         nast-kschl = 'ZU05' OR nast-kschl = 'ZU06'
                             OR nast-kschl = 'ZU10').
DATA : wa_date_mrua1 TYPE yse_date_mrua,
       WA_KPP_2 TYPE YSE_KPP.
 SELECT SINGLE * FROM yse_date_mrua INTO wa_date_mrua1.
* begin of change MOD-009
    IF VBDKL-BUKRS = 'XRAA'.
        IF h_doc-wadat LE wa_date_mrua1-t_gate.
        SELECT SINGLE * FROM yse_kpp1  INTO wa_kpp_2 WHERE  werks  = 'XR70'.

      ELSEIF h_doc-wadat GT wa_date_mrua1-t_gate.
        SELECT SINGLE * FROM yse_kpp  INTO wa_kpp_2 WHERE  werks  = 'XR70'.

      ENDIF.
    ELSE.
* end of change MOD-009
        IF h_doc-wadat LE wa_date_mrua1-t_gate.
        SELECT SINGLE * FROM yse_kpp1  INTO wa_kpp_2 WHERE  werks  = 'RU01'.

      ELSEIF h_doc-wadat GT wa_date_mrua1-t_gate.
        SELECT SINGLE * FROM yse_kpp  INTO wa_kpp_2 WHERE  werks  = 'RU01'.

      ENDIF.
* begin of change MOD-009
    ENDIF.
* end of change MOD-009

      CONCATENATE  wa_kpp_2-address1  wa_kpp_2-address supplier_bank-bankadat INTO h_doc-supplier SEPARATED BY ' '.

    ENDIF.
*  End of insertion by -MOD-008

  ENDIF.
  CALL FUNCTION func_module_name
    EXPORTING
      /1bcdwb/docparams   = fp_docparams
      h_item              = items
      h_header            = h_doc
*  IMPORTING
*    /1bcdwb/formoutput   =
    EXCEPTIONS
      usage_error     = 1
      system_error    = 2
      internal_error  = 3.

  IF sy-subrc <> 0.
    CALL FUNCTION 'FP_GET_LAST_ADS_ERRSTR'
      IMPORTING
        e_adserrstr = l_errstr.
  ENDIF.

ENDFORM.                    " print_FORM

*&---------------------------------------------------------------------*
*&      Form  read_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_TNAPR_SFORM  text
*      <--P_FUNC_MODULE_NAME  text
*----------------------------------------------------------------------*
FORM read_fm USING    p_tnapr_sform
                   CHANGING p_func_module_name.

* determine the name of the generated function module
*
  TRY.
      CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
        EXPORTING
          i_name     = p_tnapr_sform
        IMPORTING
          e_funcname = p_func_module_name.
    CATCH cx_fp_api.                                    "#EC NO_HANDLER
  ENDTRY.

  IF p_func_module_name IS INITIAL.
*        MESSAGE e848 WITH t001f-fornr_pdf save_bukrs
*           save_repid save_forid.
    MESSAGE ID 'FB' TYPE 'I' NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " read_pdf_form

*&---------------------------------------------------------------------*
*&      Form  CLOSE_FORM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM close_form.
  CHECK NOT x_open IS INITIAL.
*Close the spool job
  CALL FUNCTION 'FP_JOB_CLOSE'
*           IMPORTING
*             E_RESULT             =
   EXCEPTIONS
     usage_error          = 1
     system_error         = 2
     internal_error       = 3
     OTHERS               = 4
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  CLEAR x_open.
ENDFORM.                    "CLOSE_FORM

*---------------------------------------------------------------------*
*       FORM UNIT_CONVERSION_SIMPLE                                   *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VALUE(INPUT)                                                  *
*  -->  OUTPUT                                                        *
*  -->  VALUE(UNIT_IN)                                                *
*  -->  VALUE(UNIT_OUT)                                               *
*---------------------------------------------------------------------*
FORM unit_conversion_simple USING value(unit_in)  LIKE t006-msehi
                                  value(unit_out) LIKE t006-msehi
                         CHANGING input TYPE any.
  IF NOT unit_in IS INITIAL AND NOT unit_out IS INITIAL.
    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = input
        unit_in  = unit_in
        unit_out = unit_out
      IMPORTING
        output   = input.
  ENDIF.

ENDFORM.                    "UNIT_CONVERSION_SIMPLE
*&---------------------------------------------------------------------*
*&      Form  FILL_OUTPUTPARAMS_PDF
*&---------------------------------------------------------------------*
*      -->IS_ITCPO TYPE ITCPO
*      <--XS_OUTPUTPARAMS TYPE SFPOUTPUTPARAMS
*----------------------------------------------------------------------*
FORM fill_outputparams_pdf
                      USING    is_itcpo TYPE itcpo
                      CHANGING xs_outputparams TYPE sfpoutputparams.
  CLEAR xs_outputparams-noprint.
  xs_outputparams-nopributt = xs_outputparams-nodialog = xscreen.
  xs_outputparams-device     = is_itcpo-tdprinter.
  xs_outputparams-preview    = is_itcpo-tdpreview.
  xs_outputparams-dest       = is_itcpo-tddest.
  xs_outputparams-reqnew     = is_itcpo-tdnewid.
  xs_outputparams-reqimm     = is_itcpo-tdimmed.
  xs_outputparams-reqdel     = is_itcpo-tddelete.
  xs_outputparams-reqfinal   = is_itcpo-tdfinal.
  xs_outputparams-senddate   = is_itcpo-tdsenddate.
  xs_outputparams-sendtime   = is_itcpo-tdsendtime.
  xs_outputparams-schedule   = is_itcpo-tdschedule.
  xs_outputparams-copies     = is_itcpo-tdcopies.
  xs_outputparams-dataset    = is_itcpo-tddataset.
  xs_outputparams-suffix1    = is_itcpo-tdsuffix1.
  xs_outputparams-suffix2    = is_itcpo-tdsuffix2.
  xs_outputparams-covtitle   = is_itcpo-tdcovtitle.
  xs_outputparams-cover      = is_itcpo-tdcover.
  xs_outputparams-receiver   = is_itcpo-tdreceiver.
  xs_outputparams-division   = is_itcpo-tddivision.
  xs_outputparams-lifetime   = is_itcpo-tdlifetime.
  xs_outputparams-authority  = is_itcpo-tdautority.
  xs_outputparams-rqposname  = is_itcpo-rqposname.
  xs_outputparams-arcmode    = is_itcpo-tdarmod.
  xs_outputparams-noarmch    = is_itcpo-tdnoarmch.
  xs_outputparams-title      = is_itcpo-tdtitle.
  xs_outputparams-nopreview  = is_itcpo-tdnoprev.

ENDFORM.                    " fill_outputparams_PDF
*---------------------------------------------------------------------*
*       FORM ITCPO_FUELLEN                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM itcpo_fuellen.
  IF xscreen NE space.
*- Testausgabe auf Bildschirm ----------------------------------------
    itcpo-tdpreview = 'X'.
    itcpo-tdnoprint = 'X'.
  ELSE.
    CLEAR: itcpo-tdpreview,
           itcpo-tdnoprint.
  ENDIF.
  MOVE-CORRESPONDING nast TO itcpo.
  itcpo-tdcover   = nast-tdocover.
  itcpo-tddest    = nast-ldest.
  itcpo-tddataset = nast-dsnam.
  itcpo-tdsuffix1 = nast-dsuf1.
  itcpo-tdsuffix2 = nast-dsuf2.
  itcpo-tdimmed   = nast-dimme.
  itcpo-tddelete  = nast-delet.
  itcpo-tdcopies  = nast-anzal.
  itcpo-tdprogram = sy-repid.
* ITCPO-TDTELELAND = US_COUNTRY.
  itcpo-tdsenddate = nast-vsdat.
  itcpo-tdsendtime = nast-vsura.
  itcpo-tdnewid   = 'X'.
ENDFORM.                    "ITCPO_FUELLEN

*&---------------------------------------------------------------------*
*&      Form  BANK_DATA
*&---------------------------------------------------------------------*
*       get bank data
*----------------------------------------------------------------------*
FORM get_bank.
  DATA answer.
* bank data:
* 1.consignor of goods (sales organization) (sadr)
* vbdkl-vkorg = tvko-bukrs
* 2. ship-to party (we-sadr) vbdkl-kunnr
* 3. supplier (f_sadr) tvko-bukrs
* 4. payer (ag_sadr) vbdkl-kunag

  CLEAR answer.

  SELECT SINGLE paval FROM t001z INTO answer
    WHERE bukrs EQ tvko-bukrs
    AND   party EQ 'SAPRB1'.

  IF answer EQ '1'.

    consignor_bank-bukrs = tvko-bukrs.
    supplier_bank-bukrs = tvko-bukrs.
* Begin of Change Billing instead of shipping partner
*  ship_to_bank-kunnr = vbdkl-kunnr.
    ship_to_bank-kunnr = lv_kunre.
* End of Change Billing instead of shipping partner
    IF lv_kunrg IS NOT INITIAL.
      payer_bank-kunnr = lv_kunrg.
    ELSE.
      payer_bank-kunnr = vbdkl-kunag.
    ENDIF.

* IMP RU BEGIN INSERT
* per business area pick up the bank detail
    SELECT SINGLE hbkid INTO lv_hbkid FROM yse_sd_ru_torg12
      WHERE vkorg = vbdkl-vkorg.

* IMP RU END INSERT

* clear consignor_bank-bankadat.
    PERFORM home_bank_data USING consignor_bank-bukrs
* IMP RU BEGIN UNDELETE
                               lv_hbkid
* IMP RU END UNDELETE
*                              consignor_bank-hktid
                       CHANGING consignor_bank-bankadat.

    PERFORM home_bank_data USING supplier_bank-bukrs
* IMP RU BEGIN INSERT
                                lv_hbkid
* IMP RU END INSERT
                        CHANGING supplier_bank-bankadat.

    PERFORM partn_bank_data USING ship_to_bank-kunnr
                        CHANGING ship_to_bank-bankadat.

    PERFORM partn_bank_data USING payer_bank-kunnr
                        CHANGING payer_bank-bankadat.

  ELSE.
    CLEAR consignor_bank.
    CLEAR supplier_bank.
    CLEAR ship_to_bank.
    CLEAR payer_bank.
  ENDIF.
ENDFORM.                    " GET_BANK

*&---------------------------------------------------------------------*
*&      Form  home_bank_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_BUKRS    text
*      -->P_HBKID    text
*      -->P_BANKADAT text
*----------------------------------------------------------------------*
FORM home_bank_data USING p_bukrs "like t012k-bukrs
* IMP RU BEGIN DELETE
                          p_hbkid LIKE t012k-hbkid
* IMP RU END DELETE
*                          p_hktid like t012k-hktid
                 CHANGING p_bankadat.
  DATA: addr1_val TYPE addr1_val.
  DATA: hbkid LIKE t012k-hbkid,  "Short key for a house bank
        banks LIKE t012-banks,   "Bank country key
        bankl LIKE t012-bankl,   "Bank Key
        bankn LIKE t012k-bankn,  "Bank Account Number
        bkont LIKE t012k-bkont.  "Bank Control Key

  CLEAR p_bankadat.

  SELECT  SINGLE hbkid banks bankl FROM t012
     INTO (hbkid, banks, bankl)
     WHERE  bukrs = p_bukrs
* IMP RU BEGIN INSERT
     AND  hbkid = p_hbkid.
* IMP RU END INSERT

  SELECT SINGLE bankn bkont FROM t012k
     INTO (bankn, bkont)
      WHERE  bukrs = p_bukrs
      AND    hbkid = hbkid.

  SELECT  SINGLE * FROM  bnka
     WHERE  banks  = banks
     AND    bankl  = bankl.

  CLEAR sel.
  sel-addrnumber = bnka-adrnr.
  CLEAR addr1_val. sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.

  IF sy-subrc EQ 0.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3
      addr1_val-name4 addr1_val-city1 INTO p_bankadat SEPARATED BY space.
  ELSE.
    CONCATENATE bnka-banka bnka-ort01 INTO p_bankadat SEPARATED BY space.
  ENDIF.

  CONCATENATE p_bankadat text-008 bnka-bnklz bnka-bankl text-006 bnka-stras bnka-brnch
     text-007 bkont INTO p_bankadat SEPARATED BY space.
  CONCATENATE p_bankadat bankn INTO p_bankadat.
  REPLACE ALL OCCURRENCES OF ' ,' IN p_bankadat WITH ','.
  REPLACE ALL OCCURRENCES OF '  ,' IN p_bankadat WITH ','.

ENDFORM.                    "home_bank_data
*&---------------------------------------------------------------------*
*&      Form  partn_bank_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM partn_bank_data  USING    p_kunnr
                      CHANGING p_bankadat.

  DATA: addr1_val TYPE addr1_val.
  DATA: banks LIKE knbk-banks,   "Bank country key
        bankl LIKE knbk-bankl,       "Bank Key
        bankn LIKE knbk-bankn,       "Bank Account Number
        bkont LIKE knbk-bkont.       "Bank Control Key
*      BVTYP like KNBK-BVTYP.       "Partner bank type

  CLEAR p_bankadat.

  SELECT  SINGLE banks bankl bankn bkont FROM knbk
     INTO (banks, bankl, bankn, bkont)
     WHERE  kunnr = p_kunnr.

  SELECT  SINGLE * FROM  bnka
     WHERE  banks  = banks
     AND    bankl  = bankl.

  CLEAR sel.
  sel-addrnumber = bnka-adrnr.
  CLEAR addr1_val. sel-nation = 'R'.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = sel
    IMPORTING
      address_value     = addr1_val
    EXCEPTIONS
      parameter_error   = 1
      address_not_exist = 2
      version_not_exist = 3
      internal_error    = 4
      OTHERS            = 5.

  IF sy-subrc EQ 0.
    CONCATENATE addr1_val-name1 addr1_val-name2 addr1_val-name3
      addr1_val-name4 addr1_val-city1 INTO p_bankadat SEPARATED BY space.
  ELSE.
    CONCATENATE bnka-banka bnka-ort01 INTO p_bankadat SEPARATED BY space.
  ENDIF.

  CONCATENATE p_bankadat text-008 bnka-bnklz bnka-bankl text-006 bnka-stras bnka-brnch
     text-007 bkont INTO p_bankadat SEPARATED BY space.
  CONCATENATE p_bankadat bankn INTO p_bankadat.
  REPLACE ALL OCCURRENCES OF ' ,' IN p_bankadat WITH ','.

ENDFORM.                    " partn_bank_data

*Text symbol text£º
*001:t.
*002:f.
*003:kop.
*004:of
*005:Order No
*006:cor/acc
*007:set/acc
*008:BIK
*009:Quotation:
*010:Sales Order:
*011:PO:
*012:"§°§Ò§à§ã§à§Ò§Ý§Ö§ß§ß§à§Ö §á§à§Õ§â§Ñ§Ù§Õ§Ö§Ý§Ö§ß§Ú§Ö §©§¡§° "§¡§ä§Ý§Ñ§ã §¬§à§á§Ü§à"
*013:§³§é§Ö§ä-§á§â§Ö§Õ§Ý§à§Ø§Ö§ß§Ú§Ö ¡í:
*014:§¯§à§Þ§Ö§â §Ù§Ñ§Ü§Ñ§Ù§Ñ SAP:
*015:§¥§à§Ô§à§Ó§à§â:
*016:§©§¡§° "§¡§ä§Ý§Ñ§ã §¬§à§á§Ü§à"
*T01:§´§â§Ñ§ß§ã§á§à§â§ä§ß§à-§ï§Ü§ã§á.§å§ã§Ý
*T02:§¬§à§Õ §¦§¯§³:
*T09:contract
*T10:sales order
*T11:PO
*TH1:§©§¡§° "§¡§ä§Ý§Ñ§ã §¬§à§á§Ü§à", 141402, §²§à§ã§ã§Ú§Û§ã§Ü§Ñ§ñ §¶§Ö§Õ§Ö§â§Ñ§è§Ú§ñ, §®§à§ã§Ü§à§Ó§ã§Ü§Ñ§ñ §à§Ò§Ý., §Ô.§·§Ú§Þ§Ü§Ú, §£§Ñ§ê§å§ä§Ú§ß§ã§Ü§à§Ö §ê§à§ã§ã§Ö, §Õ.15, §ä§Ö§Ý.: +7 495 933 55 52
*TH2:, §ª§¯§¯ 7710218759/504701001, §â/§ã 40702810100700922014, §¢§Ñ§ß§Ü §©§¡§° §¬§¢ "§³§Ú§ä§Ú§Ò§Ñ§ß§Ü" §Ô.§®§à§ã§Ü§Ó§Ñ, §¢§ª§¬ 044525202, §Ü/c 30101810300000000202
*TH3:§¢§Ñ§ß§Ü §©§¡§° §¬§¢ "§³§Ú§ä§Ú§Ò§Ñ§ß§Ü" §Ô.§®§à§ã§Ü§Ó§Ñ, §¢§ª§¬ 044525202, §Ü/c 30101810300000000202
