*&---------------------------------------------------------------------*
*& Report  YSE_FI_RR_PROV_CALC
*&
*&---------------------------------------------------------------------*
*&                                                                     *
*& Revenue Recognition vs. Revenue Recognition POC                     *
*&                                                                     *
*&---------------------------------------------------------------------*
*  Author                : Jules Smets
*  Date                  : 27.07.2011
*  Change Request Number : CR2012
*  Transport request Nr. : CD1K966825
*----------------------------------------------------------------------*
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD.NR. | DATE       | NAME           | CORRECTION NR. | CHANGE REF. *
*----------------------------------------------------------------------*
* MOD-001 | 26.03.2012 | J. Smets       | CD1K970935     | CR2012      *
*         | Selection dates POC adjustment                             *
*----------------------------------------------------------------------*
* MOD-002 | 03.04.2012 | J. Smets       | CD1K971100     | CR2012      *
*         | Final POC adjustments                                      *
*----------------------------------------------------------------------*
* MOD-003 | 17/10/2012 | Jules Smets    | CD1K973562     | CR2702      *
*         | Consider customer account assignment group                 *
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
* MOD-004 | 19/11/2012 | Pratap Mada    | CD1K973562     | CR2728      *
*                                         CD1K974044                   *
*                                         CD1K974050                   *
*                                         CD1K974119                   *
*                                         CD1K974204                   *
*                                         CD1K974270                   *
*                                         CD1K974427                   *
*         | Avoid wrong posting of FI doc from POC program whene       *
*            when revenue recognition poste with positive value        *
*----------------------------------------------------------------------*
* MOD-005 | 18/04/2013 | Raghu D.V.S.   | CD1K975509     |CR2732       *
*         | CD1K975871 | CD1K975678     | CD1K975855     |CD1K976255   *
*         | CD1K976568 | CD1K976572     | CD1K976622     |CD1K976715   *
*         | G/L account posting and reversal logic changes.            *
*----------------------------------------------------------------------*
* MOD-006 | 01/07/2013 | Raghu D.V.S.   | CD1K976780     |CR2966       *
*         | CD1K976980 | CD1K976978     | CD1K976826     |CD1K976972   *
*         | CD1K977023 | CD1K977021     | CD1K977000     |CD1K977017   *
*         | CD1K977049 | CD1K977027     | CD1K977025     |CD1K977033   *
*         | CD1K977168 | CD1K977121     | CD1K977051     |CD1K977103   *
*         |            |                | CD1K977181     |             *
*         | Postings logic change for POC before Invoice/RR            *
*----------------------------------------------------------------------*
* MOD-007 | 22/11/2013 | Raghu D.V.S.   | CD1K978560     |CR3093       *
*                        CD1K978616     | CD1K978586     |CD1K981066   *
*         |Difference between VF44 and Plan revenue derived            *
************************************************************************

REPORT  yse_fi_rr_prov_calc NO STANDARD PAGE HEADING
                            LINE-SIZE 520.

*TABLES:                                                   " Commented by MOD-006
*  Begin of Comment MOD-005
*        vbak,
*        vbap,
*        veda,
*        vbpa,
*        vbkd,
*        kna1,
*        bsis,
*        bsas,
*        konv,
*        coep,
*        cobk,
*        tcurr,
*        t001,
**        vbrk,                                               "MOD-005
* End of Comment MOD-005
*        yse_fi_poc_matkl.                                   "MOD-002 " Commented by MOD-006
*        yam_ctam_ccodes.                                   " MOD-006

TYPES: BEGIN OF ty_vbap,
         vbeln     TYPE vbeln,
         posnr     TYPE posnr,
         netwr     TYPE netwr,
         matnr     TYPE matnr,
         prctr_c   TYPE prctr,
         prodh     TYPE prodh_d,
         objnr     TYPE j_objnr,
         waerk     TYPE waers,
         kunnr     TYPE kunnr,
         vkorg     TYPE vkorg,
         vtweg     TYPE vtweg,
         spart     TYPE spart,
         vkbur     TYPE vkbur,
         knumv     TYPE knumv,
       END OF ty_vbap.

TYPES: BEGIN OF ty_veda,
         vbeln     TYPE vbeln,
         vposn     TYPE posnr,
         vbegdat   TYPE datum,
         venddat   TYPE datum,
         vkuegru   TYPE kuegru,
       END OF ty_veda.

TYPES: BEGIN OF ty_vbpa,
         vbeln     TYPE vbeln,
         posnr     TYPE posnr,
         parvw     TYPE parvw,
         kunnr     TYPE kunnr,
         land1     TYPE land1,
       END OF ty_vbpa.

TYPES: BEGIN OF ty_kna1,
         kunnr     TYPE kunnr,
         name1     TYPE name1,
       END OF ty_kna1.

TYPES: BEGIN OF ty_bsis,
         belnr     TYPE belnr_d,
         gjahr     TYPE gjahr,
         hkont     TYPE hkont,
         zuonr     TYPE dzuonr,
         budat     TYPE budat,
         waers     TYPE waers,
         prctr     TYPE prctr,
         segment   TYPE fb_segment,
         bldat     TYPE bldat,
         mwskz     TYPE mwskz,
       END OF ty_bsis.

TYPES: BEGIN OF ty_konv,
         knumv     TYPE knumv,
         kposn     TYPE kposn,
         zaehk     TYPE dzaehk,
         kwert     TYPE kwert,
         waers     TYPE waers,
       END OF ty_konv.

TYPES: BEGIN OF ty_curr,
         kurst     TYPE kurst,
         fcurr     TYPE fcurr,
         tcurr     TYPE tcurr_curr,
         gdatu     TYPE gdatu_inv,
         ukurs     TYPE ukurs_curr,
       END OF ty_curr.

TYPES: BEGIN OF ty_coep,
         objnr     TYPE j_objnr,
         beltp     TYPE beltp,
         twaer     TYPE twaer,
         owaer     TYPE owaer,                              " MOD-005
         wtgbtr    TYPE wtgxxx,
         wogbtr    TYPE wogxxx,
         wkgbtr    TYPE wogxxx,                             "MOD-005
         belnr     TYPE co_belnr,
         buzei     TYPE co_buzei,
         awtyp     TYPE awtyp,                              "MOD-002
       END OF ty_coep.

*** MOD-002 * begin ***
TYPES: BEGIN OF ty_final,
         zuonr     TYPE dzuonr,
         belnr     TYPE belnr_d,
         gjahr     TYPE gjahr,
       END OF ty_final.
*** MOD-002 * end ***

*** MOD-003 * begin ***
TYPES: BEGIN OF ty_knvv,
         kunnr     TYPE kunnr,
         vkorg     TYPE vkorg,
         vtweg     TYPE vtweg,
         spart     TYPE spart,
         ktgrd     TYPE ktgrd,
       END OF ty_knvv.

TYPES: BEGIN OF ty_c001,
         vkorg     TYPE vkorg,
         ktgrd     TYPE ktgrd,
         ktgrm     TYPE ktgrm,
         sakn1     TYPE saknr,
       END OF ty_c001.

TYPES: BEGIN OF ty_ska1,
         saknr     TYPE saknr,
         func_area TYPE fkber,
       END OF ty_ska1.
* Begin of MOD-005.
TYPES: BEGIN OF ty_vbrp,
        vbeln       TYPE vbeln_vf,      " Billing Document
        posnr       TYPE posnr_vf,      " Billing item
        netwr       TYPE netwr_fp,      " Net value of the billing item in document currency
        vgbel	      TYPE vgbel,         " Document number of the reference document
        vgpos	      TYPE vgpos,         " Item number of the reference item
        matnr	      TYPE matnr,         " Material Number
        shkzg	      TYPE shkzg_vf,      "	Returns item
       END OF ty_vbrp.
TYPES: BEGIN OF ty_vbfa,
        vbelv	      TYPE vbeln_von,	    " Preceding sales and distribution document
        posnv	      TYPE posnr_von,	    " Preceding item of an SD document
        vbeln       TYPE vbeln_nach,    " Subsequent sales and distribution document
        posnn	      TYPE posnr_nach,    " Subsequent item of an SD document
        vbtyp_n	    TYPE vbtyp_n,       " Document category of subsequent document
        vbtyp_v	    TYPE vbtyp_v,       " Document category of preceding SD document
       END OF ty_vbfa .
*TYPES: BEGIN OF ty_lips,
*        VBELN        type VBELN_VL,      " Delivery
*        POSNR        type POSNR_VL,      " Delivery Item
*        MATNR        type MATNR,         " Material Number
*        VGBEL        type VGBEL,         " Document number of the reference document
*        VGPOS        type VGPOS,         " Item number of the reference item
*       end of ty_lips.
TYPES: BEGIN OF ty_bsis_new,
        bukrs       TYPE bukrs,         "   Company Code
        hkont       TYPE hkont,         "   General Ledger Account
        augdt       TYPE augdt,         "   Clearing Date
        augbl       TYPE augbl,         "   Document Number of the Clearing Document
        zuonr       TYPE dzuonr,        "   Assignment Number
        gjahr       TYPE gjahr,         "   Fiscal Year
        belnr       TYPE belnr_d,       "   Accounting Document Number
        buzei       TYPE buzei,         "   Number of Line Item Within Accounting Document
        xblnr       TYPE xblnr1,        "   Reference Document Number
        bschl       TYPE bschl,         "   Posting Key
        dmbtr       TYPE dmbtr,         "   Amount in Local Currency
        wrbtr       TYPE wrbtr,         "   Amount in document currency
       END OF ty_bsis_new.
TYPES: BEGIN OF ty_vbak_new,
        vbeln	    TYPE vbeln_va,      " Sales Document
        waerk	    TYPE waerk,         " SD Document Currency
        vbtyp	    TYPE vbtyp,         " SD document category
        vkorg	    TYPE vkorg,         " Sales Organization
        vtweg	    TYPE vtweg,         " Distribution Channel
        spart	    TYPE spart,         " Division
        vkbur	    TYPE vkbur,         " Sales Office
        knumv	    TYPE knumv,         " Number of the document condition
        kunnr	    TYPE kunag,         " Sold-to party
        bukrs_vf  TYPE bukrs_vf,      " Company code to be billed
      END OF ty_vbak_new.
TYPES: BEGIN OF ty_vbap_new,
         vbeln  TYPE vbeln_va,          " Sales Document
         posnr  TYPE posnr_va,          " Sales Document Item
         matnr  TYPE matnr,             " Material Number
         matkl  TYPE matkl,             " Material Group
         prodh  TYPE prodh_d,           " Product hierarchy
         netwr  TYPE netwr_ap,          " Net value of the order item in document currency
         prctr  TYPE prctr,             " Profit Center
         objnr  TYPE objpo,             " Object number at item level
       END OF ty_vbap_new.
TYPES: BEGIN OF ty_veda_new,
         vbeln    TYPE vbeln_va,          " Sales Document
         vposn    TYPE posnr_va,          " Sales Document Item
         vbegdat  TYPE vbdat_veda,        " Contract start date
         vkuegru  TYPE vkgru_veda,        " Reason for Cancellation of Contract
         venddat  TYPE vndat_veda,        " Contract end date
       END OF ty_veda_new.

DATA: gt_vbrp TYPE STANDARD TABLE OF ty_vbrp,
      wa_vbrp TYPE ty_vbrp,
      gt_vbfa TYPE STANDARD TABLE OF ty_vbfa,
      wa_vbfa TYPE ty_vbfa,
*      gt_lips type STANDARD TABLE OF ty_lips,
*      wa_lips type ty_lips,
      gt_bsis_new TYPE STANDARD TABLE OF ty_bsis_new,
      wa_bsis_new TYPE ty_bsis_new,
      wa_vbap TYPE ty_vbap,                         " MOD-006
      gt_vbrp2 TYPE STANDARD TABLE OF ty_vbrp,       " MOD-006,
      wa_vbrp1 TYPE ty_vbrp.                         " MOD-006.

DATA: gt_bsis_new1 TYPE STANDARD TABLE OF ty_bsis_new,
      gt_bsis_new2 TYPE STANDARD TABLE OF ty_bsis_new.

DATA: gt_vbap TYPE STANDARD TABLE OF ty_vbap
                       WITH KEY vbeln posnr.
*                       WITH HEADER LINE.       " Commented by MOD-006
DATA: wa_vbap_new1 TYPE ty_vbap.                " MOD-006
DATA: gt_veda  TYPE STANDARD TABLE OF ty_veda.   " mod-006
*                    WITH HEADER LINE.          " Commented by MOD-006
DATA: wa_veda  TYPE ty_veda.                   " Mod-006
*DATA: gt_vbap  TYPE HASHED TABLE OF ty_vbap
*                    WITH UNIQUE KEY vbeln posnr
*                    WITH HEADER LINE.
* End of MOD-005.
*** MOD-003 * end ***

DATA: gt_vbpa  TYPE HASHED TABLE OF ty_vbpa
                    WITH UNIQUE KEY vbeln posnr parvw,
*                    WITH HEADER LINE.                        " Commented by MOD-006
      wa_vbpa  TYPE ty_vbpa.                                  " MOD-006

DATA: gt_kna1  TYPE HASHED TABLE OF ty_kna1
                    WITH UNIQUE KEY kunnr,
*                    WITH HEADER LINE,                         " Commented by MOD-006
      gt_kna1i TYPE TABLE OF ty_kna1,
*                    WITH HEADER LINE.                        " Commented by MOD-006
      wa_kna1  TYPE ty_kna1.                                   " Mod-006

*DATA: gt_bsis  TYPE TABLE OF ty_bsis     " Commented by MOD-006
*                    WITH HEADER LINE.

DATA: gt_konv  TYPE HASHED TABLE OF ty_konv
                    WITH UNIQUE KEY knumv kposn,
*                    WITH HEADER LINE,             " Commented by MOD-006
      gt_konvi TYPE TABLE OF ty_konv,
*                    WITH HEADER LINE.              " Commented by MOD-006
      wa_konv  TYPE ty_konv.                        " MOD-006

DATA: gt_curr  TYPE HASHED TABLE OF ty_curr
                    WITH UNIQUE KEY kurst fcurr tcurr,
*                    WITH HEADER LINE,               " Commented by MOD-006
      gt_curri TYPE TABLE OF ty_curr,
*                    WITH HEADER LINE.                " Commented by MOD-006
      wa_curr   TYPE ty_curr.                         " MOD-006
* Begin of MOD-006.
*DATA: gt_coep  TYPE SORTED TABLE OF ty_coep
*                    WITH NON-UNIQUE KEY objnr beltp
*                    WITH HEADER LINE.
DATA: gt_coep TYPE STANDARD TABLE OF ty_coep,
      wa_coep TYPE ty_coep.
* End of MOD-006.

*** MOD-002 * begin ***
DATA: gt_final TYPE HASHED TABLE OF ty_final
                    WITH UNIQUE KEY zuonr,
*                    WITH HEADER LINE,                        " Commented by MOD-006
      gt_fini  TYPE TABLE OF ty_final,
*                    WITH HEADER LINE.                        " Commented by MOD-006
      wa_final TYPE ty_final.                                 " MOD-006
*** MOD-002 * end ***

*** MOD-003 * begin ***
DATA: gt_knvv  TYPE HASHED TABLE OF ty_knvv
                    WITH UNIQUE KEY kunnr vkorg vtweg spart,
*                    WITH HEADER LINE,                         " Commented by MOD-006
      gt_knvvi TYPE TABLE OF ty_knvv,
*                    WITH HEADER LINE.                          " Commented by MOD-006
      wa_knvv  TYPE ty_knvv.

DATA: gt_c001  TYPE HASHED TABLE OF ty_c001
                    WITH UNIQUE KEY vkorg ktgrd ktgrm,
*                    WITH HEADER LINE,                          " Commented by MOD-006
      gt_c001i TYPE TABLE OF ty_c001,
*                    WITH HEADER LINE.                           " Commented by MOD-006
      wa_c001  TYPE ty_c001.                                     " MOD-006

DATA: gt_ska1  TYPE HASHED TABLE OF ty_ska1
                    WITH UNIQUE KEY saknr,
*                    WITH HEADER LINE,                           " Commented by MOD-006
      gt_ska1i TYPE TABLE OF ty_ska1,
*                    WITH HEADER LINE.                           " Commented by MOD-006
      wa_ska1  TYPE ty_ska1.                                     " MOD-006
*** MOD-003 * end ***

*DATA: BEGIN OF gt_seed  OCCURS 0,                " Commented by MOD-006
TYPES: BEGIN OF ty_seed,
         vbeln       TYPE vbeln,
         posnr       TYPE posnr,
         pl_cost_so  TYPE wtgxxx,
         pl_cost_lc  TYPE wogxxx,
         pl_rev_so   TYPE wtgxxx,
         pl_rev_lc   TYPE wogxxx,
         act_cost_so TYPE wtgxxx,
         act_cost_lc TYPE wogxxx,
         act_rev_so  TYPE wtgxxx,
         act_rev_lc  TYPE wogxxx,
         rr_poc_so   TYPE wtgxxx,
         rr_poc_lc   TYPE wogxxx,
         diff_rr_so  TYPE wtgxxx,
         diff_rr_lc  TYPE wogxxx,
         waers       TYPE waers,          "Doc. curr.
         waerk       TYPE waers,          "SO curr.
         waers_cc    TYPE waers,          "Local curr.
         kunnr       TYPE kunnr,
         name1_ag    TYPE name1,
         vkorg       TYPE vkorg,
         vtweg       TYPE vtweg,
         spart       TYPE spart,
         vkbur       TYPE vkbur,
         land1_we    TYPE land1,
         matnr       TYPE matnr,
         prctr_c     TYPE prctr,
         prodh       TYPE prodh_d,
         belnr       TYPE belnr_d,
         gjahr       TYPE gjahr,
         hkont       TYPE hkont,
         prctr       TYPE prctr,
         segment     TYPE fb_segment,
         bldat       TYPE bldat,
         mwskz       TYPE mwskz,
         belnr_n     TYPE belnr_d,
         gjahr_n     TYPE gjahr,
*** MOD-002 * begin ***
         bschl1      TYPE bschl,
         bschl2      TYPE bschl,
         xblnr       TYPE xblnr,
         stext       TYPE j_stext,
         bschl_new   TYPE bschl,        " MOD-005
         hkont_new   TYPE hkont,        " MOD-005
         waerk_new   TYPE wtgxxx,       " MOD-005
         wrbtr_new   TYPE wtgxxx,       " MOD-005
         waerk_new1  TYPE wtgxxx,       " MOD-005
         wrbtr_new1  TYPE wtgxxx,       " MOD-005
*         flag        TYPE c,           " MOD-005         " Commented by MOD-006
         flag        TYPE char1,        " MOD-006
         bschl_flag  TYPE bschl,        " MOD-005
         p           TYPE wtgxxx,       " MOD-005
         q           TYPE wtgxxx,       " MOD-005
         p1          TYPE wtgxxx,       " MOD-005
         q1          TYPE wtgxxx,       " MOD-005
         netwr       TYPE netwr,        " MOD-005
         diff_rr_so1 TYPE wtgxxx,       " MOD-005
         diff_rr_lc1 TYPE wogxxx,       " MOD-005
         saknr       TYPE saknr,        " MOD-005
*** MOD-002 * end ***
*      END OF gt_seed.                  " Commented by MOD-006
       END OF ty_seed.

DATA: gt_seed TYPE STANDARD TABLE OF ty_seed, " MOD-006
      wa_seed TYPE ty_seed.                   " MOD-006

* Begin of MOD-006
*DATA: i_bdcdata LIKE bdcdata  OCCURS 0  WITH HEADER LINE,
*      struct_bdcdata TYPE bdcdata,
*      gt_err    LIKE bdcmsgcoll  OCCURS 0  WITH HEADER LINE.
DATA: i_bdcdata       TYPE STANDARD TABLE OF bdcdata,
      struct_bdcdata  TYPE bdcdata,
      gt_err          TYPE STANDARD TABLE OF bdcmsgcoll,
      wa_err          TYPE bdcmsgcoll.
* End of MOD-006
DATA: gv_waers_cc    TYPE waers,
      gv_waers_int   TYPE waers,
*** MOD-001 * begin ***
      gv_per_b       TYPE datum,
      gv_per_e       TYPE datum,
*** MOD-001 * end ***
      gv_gdatu       TYPE gdatu_inv,
      gv_kurst       TYPE kurst,
*      gv_ctam        TYPE xfeld,           " Commented by MOD-006
      gv_seed        TYPE xfeld,
      gv_zuonr       TYPE dzuonr,
      gv_act_cc      TYPE wogxxx,
      gv_act_so      TYPE wogxxx,
      gv_act_lc      TYPE wogxxx,
*** MOD-002 * begin ***
      gv_act_rr_so   TYPE wtgxxx,
      gv_act_rr_lc   TYPE wogxxx,
*** MOD-002 * end ***
      gv_pl_cost_so  TYPE wtgxxx,
      gv_pl_cost_lc  TYPE wogxxx,
      gv_xintb       TYPE xfeld,
      gv_hkont       TYPE hkont,
*      gv_msgtxt      LIKE t100-text,       " Comment MOD-005
      gv_msgtxt      TYPE natxt,            " MOD-005
      gv_errlst      TYPE xfeld  VALUE 'X',
      gv_mode(1)     TYPE c      VALUE 'N'.

*** MOD-003 * begin ***
DATA: gv_ktgrd     TYPE ktgrd,              "Customer account assignment group
      gv_saknr     TYPE saknr,              "Account number
      gv_fkber     TYPE fkber.              "Functional area
*** MOD-003 * end ***

CONSTANTS:
*           gc_a(1)    TYPE c      VALUE 'A',             Commented bY MOD-006
           gc_g(1)    TYPE c      VALUE 'G',
           gc_zek2    TYPE kschl  VALUE 'ZEK2',
           gc_we      TYPE parvw  VALUE 'WE',
           gc_sa      TYPE blart  VALUE 'SA',
           gc_poc     TYPE xblnr  VALUE 'POC',
           gc_pocf    TYPE xblnr  VALUE 'POC FINAL'.        "MOD-002

DATA: ind1 TYPE sytabix.                                    " MOD-006
*RANGES: r_zuonr  FOR  bsis-zuonr.                           " Commented by MOD-006
* Begin of MOD-005.
DATA: lv_matkl TYPE matkl,
      lv_vbeln TYPE vbeln_va,
      lv1_zuonr TYPE dzuonr.                                " MOD-006

* End of MOD-005.
* Selections
SELECTION-SCREEN  BEGIN OF BLOCK sel  WITH FRAME  TITLE text-s01.
PARAMETERS:     p_bukrs    TYPE bukrs  OBLIGATORY
                                       MEMORY ID buk.
*SELECT-OPTIONS: so_matkl   FOR vbap-matkl
SELECT-OPTIONS: so_matkl   FOR lv_matkl                     " MOD-005
                               NO INTERVALS,                "MOD-002
*                so_vbeln   FOR vbak-vbeln.
                so_vbeln   FOR lv_vbeln.                    " MOD-005
SELECTION-SCREEN SKIP.
PARAMETERS:     p_budat    TYPE budat OBLIGATORY  DEFAULT sy-datum.
SELECTION-SCREEN SKIP.
PARAMETERS:     p_blart    TYPE blart  DEFAULT 'ZZ'  OBLIGATORY
                                       MODIF ID nup,
                p_acc1     TYPE hkont  DEFAULT '0002997901'  OBLIGATORY
                                       MODIF ID nup,
                p_acc2     TYPE hkont  DEFAULT '0001780002'  OBLIGATORY
                                       MODIF ID nup.
*** MOD-003 * begin ***
*                p_acc3     TYPE hkont  DEFAULT '0003210901'
*                                       NO-DISPLAY.
*** MOD-003 * end ***
SELECTION-SCREEN SKIP.
PARAMETERS:     p_test     AS CHECKBOX  DEFAULT 'X'.
SELECT-OPTIONS: r_zuonr for lv1_zuonr no-DISPLAY.                                    " MOD-006
SELECTION-SCREEN  END OF BLOCK sel.

DATA: w_zuonr LIKE LINE OF r_zuonr.                   " MOD-006
*----------------------------------------------------------------------*
* On the selection screen                                              *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN OUTPUT.

  LOOP AT SCREEN.
    IF screen-group1 = 'NUP'.
      screen-input = 0.
      MODIFY SCREEN.
    ENDIF.
  ENDLOOP.

*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON p_bukrs.

  PERFORM  check_authorization.

*** MOD-002 * begin ***
*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON so_matkl.

  PERFORM  check_matkl.
*** MOD-002 * end ***


*&---------------------------------------------------------------------*
*&  Main program                                                       *
*&---------------------------------------------------------------------*

INITIALIZATION.

* Propose last day of the month
  CALL FUNCTION 'DATE_GET_MONTH_LASTDAY'
    EXPORTING
      i_date = sy-datum
    IMPORTING
      e_date = p_budat.

*----------------------------------------------------------------------*
START-OF-SELECTION.
  DATA: lv_bukrs TYPE bukrs.    " MOD-006.
  PERFORM initial.

* Determine procedure
*  SELECT SINGLE * FROM yam_ctam_ccodes       "Commented by MOD-006
*         WHERE bukrs = p_bukrs.
  SELECT SINGLE bukrs FROM  yam_ctam_ccodes   " MOD-006
                      INTO  lv_bukrs
                      WHERE bukrs = p_bukrs.

  IF sy-subrc = 0.
*   CT/AM
*   CT/AM
    " This is a CTAM Company code.
*    gv_ctam = 'X'.             " Commented by MOD-005
***    PERFORM procedure_ctam.
  ELSE.
*   SEED
    gv_seed = 'X'.
    PERFORM procedure_seed.
  ENDIF.


*----------------------------------------------------------------------*
TOP-OF-PAGE.

  WRITE: /01 text-r01, sy-datum,      " 'Date:',
         125 text-r02,                " 'Revenue Recognition vs. Revenue Recognition POC',
         225 text-r03, p_bukrs,       " 'Company:'
         497(4) sy-pagno.
  ULINE.

  IF NOT gv_errlst IS INITIAL.
    WRITE: /01 text-r04.              "'Errors'.
  ELSE.
    IF gv_seed = 'X'.
      WRITE: /01 text-r05,              "'Contract',
              12 text-r06,              "'Item',
              20 text-r07,              "'  Plan.Cost(SO)',
              36 text-r08,              "'  Plan.Cost(LC)',
              52 text-r09,              "'  Plan.Rev.(SO)',
              68 text-r10,              "'  Plan.Rev.(LC)',
              84 text-r11,              "'   Act.Cost(SO)',
             100 text-r12,              "'   Act.Cost(LC)',
             116 text-r13,              "'   Rev.Rec.(SO)',
             132 text-r14,              "'   Rev.Rec.(LC)',
             148 text-r15,              "'Rev.Rec.POC(SO)',
             164 text-r16,              "'Rev.Rec.POC(LC)',
             180 text-r17,              "'Diff.RR-POC(SO)',
             196 text-r18,              "'Diff.RR-POC(LC)',
             213 text-r19,              "'S.O.',
             219 text-r20,              "'Local',
             225 text-r21,              "'Doc.',
             232 text-r22,              "'Ref.Doc.nr.',
             245 text-r23,              "'Year',
             251 text-r24,              "'Account',
             263 text-r25,              "'ProfitCtr.',
             275 text-r26,              "'Segment',
             287 text-r27,              "'Doc. date',
             299 text-r28,              "'Tax',
             304 text-r29,              "'Adj.Doc.nr.',
             317 text-r30,              "'Year',
             323 text-r31,              "'Sold-to',
             334 text-r32,              "'Name',
             366 text-r33,              "'S.Org',
             372 text-r34,              "'DC',
             376 text-r35,              "'Dv',
             380 text-r36,              "'S.Off',
             386 text-r37,              "'Cntry',
             393 text-r38,              "'Material',
             413 text-r39,              "'ProfitCtr.',
             425 text-r40,              "'Prod. Hierarchy',
*** MOD-002 * begin ***
             445 text-r41,              "'Reference',
             458 text-r42,              "'Status',
*** MOD-002 * end ***
*  Begin of MOD-006.
             470 text-r43.              "'Invoice(SO)'.
*  End of MOD-006.
    ENDIF.
  ENDIF.

  ULINE.


*----------------------------------------------------------------------*
*       FORMS
*----------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*&      FORM  CHECK_AUTHORIZATION
*&---------------------------------------------------------------------*
*       Check authorizations
*----------------------------------------------------------------------*
FORM check_authorization .

  AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
           ID 'ACTVT' DUMMY
           ID 'BUKRS' FIELD p_bukrs.

  IF sy-subrc = 4.
*     No authorisation to display data
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '008' WITH p_bukrs.
    EXIT.
  ELSEIF sy-subrc <> 0.
*     Error checking authorization.
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
    EXIT.
  ENDIF.

ENDFORM.                    " CHECK_AUTHORIZATION

*&---------------------------------------------------------------------*
*&      Form  CHECK_MATKL                                   "MOD-002
*&---------------------------------------------------------------------*
*       Check selection for material group
*----------------------------------------------------------------------*
FORM check_matkl .

  DATA: lwa_yse_fi_poc_matkl TYPE yse_fi_poc_matkl.          " MOD-006
  CHECK NOT so_matkl-low IS INITIAL.

  SELECT SINGLE * FROM yse_fi_poc_matkl
         INTO  lwa_yse_fi_poc_matkl                        " Inserted by MOD-006
         WHERE bukrs = p_bukrs
           AND matkl = so_matkl-low
           AND sign  = so_matkl-sign.

  IF sy-subrc NE 0.
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '000'
            WITH 'Selection on material group not allowed'(e03).
  ENDIF.
  CLEAR lwa_yse_fi_poc_matkl.                               " MOD-006

ENDFORM.                    " CHECK_MATKL

*&---------------------------------------------------------------------*
*&      Form  INITIAL
*&---------------------------------------------------------------------*
*       Initialization.
*----------------------------------------------------------------------*
FORM initial .
*  Begin of MOD-005
  DATA: it_yse_fi_poc_matkl TYPE STANDARD TABLE OF yse_fi_poc_matkl,
        wa_yse_fi_poc_matkl TYPE yse_fi_poc_matkl,
        wa_matkl LIKE LINE OF so_matkl.
*  End of MOD-005
* Company currency
  SELECT SINGLE waers INTO gv_waers_cc
         FROM t001
         WHERE bukrs = p_bukrs.
*  IF sy-subrc NE 0.     " Commented by MOD-006
*  ENDIF.                " Commented by MOD-006

* Invert posting date date
  CONVERT DATE p_budat INTO INVERTED-DATE gv_gdatu.

* Exchange rate type
  CASE p_bukrs.
    WHEN 'MRUA'.
      gv_kurst = 'DRU'.
    WHEN 'POLA'.
      gv_kurst = 'D'.
    WHEN OTHERS.
      gv_kurst = 'EURX'.
  ENDCASE.

* Intermediate currency
  CASE p_bukrs.
    WHEN 'MRUA'.
      gv_waers_int = gv_waers_cc.
    WHEN 'POLA'.
      gv_waers_int = gv_waers_cc.
    WHEN OTHERS.
      gv_waers_int = 'EUR'.
  ENDCASE.

*** MOD-001 * begin ***
* Begin of period
  gv_per_b = p_budat.
  gv_per_b+6(2) = '01'.
* End of period
  CALL FUNCTION 'DATE_GET_MONTH_LASTDAY'
    EXPORTING
      i_date = p_budat
    IMPORTING
      e_date = gv_per_e.
*** MOD-001 * end ***

*** MOD-002 * begin ***
* Selection on material group
  IF so_matkl[] IS INITIAL.
    CLEAR so_matkl.
    SELECT * FROM yse_fi_poc_matkl
             INTO TABLE it_yse_fi_poc_matkl             " Inserted by MOD-006
             WHERE bukrs = p_bukrs.
*   Begin of MOD-006.
    LOOP AT it_yse_fi_poc_matkl INTO wa_yse_fi_poc_matkl.
*      so_matkl-low    = yse_fi_poc_matkl-matkl.     "
*      so_matkl-sign   = yse_fi_poc_matkl-sign.
*      so_matkl-option = 'EQ'.
*      APPEND so_matkl.
      wa_matkl-low    = wa_yse_fi_poc_matkl-matkl.     "
      wa_matkl-sign   = wa_yse_fi_poc_matkl-sign.
      wa_matkl-option = 'EQ'.
      APPEND wa_matkl TO so_matkl.
    ENDLOOP.
*    ENDSELECT.                                    " Commented by MOD-006
*    End of MOD-006.
  ENDIF.
*** MOD-002 * end ***

ENDFORM.                    " INITIAL

*&---------------------------------------------------------------------*
*&      Form  PROCEDURE_SEED
*&---------------------------------------------------------------------*
*       Procedure for SEED countries
*----------------------------------------------------------------------*
FORM procedure_seed .

* Select data
  PERFORM select_data_seed.
* Check anything selected
  IF gt_vbap[] IS INITIAL.
    MESSAGE ID 'YSE_GENERAL' TYPE 'S' NUMBER '000'
            WITH 'No contracts selected'(e01).
    RETURN.
  ENDIF.
* Begin of MOD-006.
*  IF gt_bsis[] IS INITIAL.
*    MESSAGE ID 'YSE_GENERAL' TYPE 'S' NUMBER '000'
*            WITH 'No documents selected'(e02).
*    RETURN.
*  ENDIF.
* End Of MOD-006.
* Process data
  PERFORM process_data_seed.

* Do postings
  IF p_test IS INITIAL.
    PERFORM postings_seed.
  ENDIF.
  IF gt_seed[] IS NOT INITIAL.
* List data
    PERFORM list_data_seed.
  ENDIF.

  WAIT UP TO '180' SECONDS.

CALL FUNCTION 'DEQUEUE_E_TABLE'
 EXPORTING
   MODE_RSTABLE       = 'E'
   TABNAME            = 'VBAK'
*   VARKEY             =
*   X_TABNAME          = ' '
*   X_VARKEY           = ' '
*   _SCOPE             = '3'
*   _SYNCHRON          = ' '
*   _COLLECT           = ' '
          .

ENDFORM.                    " PROCEDURE_SEED

*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA_SEED
*&---------------------------------------------------------------------*
*       Select data (SEED countries)
*----------------------------------------------------------------------*
FORM select_data_seed .
*  Begin of mod-005.
  DATA: it_veda_new TYPE STANDARD TABLE OF ty_veda_new,
        it_vbap_new TYPE STANDARD TABLE OF ty_vbap_new,
        it_vbak_new TYPE STANDARD TABLE OF ty_vbak_new,
        wa_vbap_new TYPE ty_vbap_new,
        wa_vbak_new TYPE ty_vbak_new.

  SELECT
    vbeln
    vposn
    vbegdat
    vkuegru
    venddat
    FROM veda
    INTO TABLE it_veda_new
    WHERE vbeln IN so_vbeln
    AND vposn = 0
    AND vbegdat LE gv_per_e
    AND venddat GE gv_per_b.

  IF it_veda_new[] IS NOT INITIAL.
    SELECT
      vbeln
      waerk
      vbtyp
      vkorg
      vtweg
      spart
      vkbur
      knumv
      kunnr
      bukrs_vf
      FROM vbak
      INTO TABLE it_vbak_new
      FOR ALL ENTRIES IN it_veda_new
      WHERE vbeln = it_veda_new-vbeln
      AND bukrs_vf = p_bukrs
      AND vbtyp = gc_g.
  ENDIF.
* Begin of Changes by EXTIBMDCA
  CALL FUNCTION 'ENQUEUE_E_TABLE'
   EXPORTING
     MODE_RSTABLE         = 'E'
     TABNAME              = 'VBAK'
*     VARKEY               =
*     X_TABNAME            = ' '
*     X_VARKEY             = ' '
*     _SCOPE               = '2'
*     _WAIT                = ' '
*     _COLLECT             = ' '
   EXCEPTIONS
     FOREIGN_LOCK         = 1
     SYSTEM_FAILURE       = 2
     OTHERS               = 3
            .
  IF sy-subrc <> 0.
 MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

* End of Changes by EXTIBMDCA
  SORT it_vbak_new BY vbeln.
  IF it_vbak_new[] IS NOT INITIAL.
    SELECT
       vbeln
       posnr
       matnr
       matkl
       prodh
       netwr
       prctr
       objnr
       FROM vbap
       INTO TABLE it_vbap_new
       FOR ALL ENTRIES IN it_vbak_new
       WHERE vbeln = it_vbak_new-vbeln
       AND matkl IN so_matkl.
  ENDIF.

* Contracts
  LOOP AT it_vbap_new INTO wa_vbap_new.
    wa_vbap-vbeln     = wa_vbap_new-vbeln.
    wa_vbap-posnr     = wa_vbap_new-posnr.
    wa_vbap-netwr     = wa_vbap_new-netwr.
    wa_vbap-matnr     = wa_vbap_new-matnr.
    wa_vbap-prctr_c   = wa_vbap_new-prctr.
    wa_vbap-prodh     = wa_vbap_new-prodh.
    wa_vbap-objnr     = wa_vbap_new-objnr.

    READ TABLE it_vbak_new INTO wa_vbak_new WITH KEY vbeln = wa_vbap_new-vbeln.
    wa_vbap-waerk     = wa_vbak_new-waerk.
    wa_vbap-kunnr     = wa_vbak_new-kunnr.
    wa_vbap-vkorg     = wa_vbak_new-vkorg.
    wa_vbap-vtweg     = wa_vbak_new-vtweg.
    wa_vbap-spart     = wa_vbak_new-spart.
    wa_vbap-vkbur     = wa_vbak_new-vkbur.
    wa_vbap-knumv     = wa_vbak_new-knumv.
    APPEND wa_vbap TO gt_vbap.
  ENDLOOP.
*  Begin of comment mod-005
*  SELECT h~vbeln i~posnr i~netwr i~matnr i~prctr i~prodh i~objnr
*         h~waerk h~kunnr h~vkorg h~vtweg h~spart h~vkbur h~knumv
*         INTO TABLE gt_vbap
*         FROM vbak AS h
*         INNER JOIN vbap AS i
*                    ON h~vbeln = i~vbeln
*         INNER JOIN veda AS c
*                    ON h~vbeln = c~vbeln
*         WHERE h~vbeln    IN so_vbeln
*           AND h~bukrs_vf =  p_bukrs
*           AND h~vbtyp    =  gc_g
*           AND i~matkl    IN so_matkl
*           AND c~vposn    = 0
**** MOD-001 * begin ***
**           AND c~vbegdat  LE p_budat
**           AND c~venddat  GE p_budat
*           AND c~vbegdat  LE gv_per_e
*           AND c~venddat  GE gv_per_b
**** MOD-001 * end ***
*           AND c~vkuegru  =  '  '.
* End of comment MOD-005.

  CHECK NOT gt_vbap[] IS INITIAL.

** Check contract data
  SELECT vbeln vposn vbegdat venddat vkuegru
         INTO TABLE gt_veda
         FROM veda
         FOR ALL ENTRIES IN gt_vbap
         WHERE vbeln = gt_vbap-vbeln.

*** Canceled
* Begin of MOD-006
*  LOOP AT gt_veda WHERE ( vkuegru NE space OR vbegdat > gv_per_e OR venddat < gv_per_b ).
*    DELETE gt_vbap WHERE vbeln = gt_veda-vbeln
*                     AND posnr = gt_veda-vposn.
*  ENDLOOP.
  LOOP AT gt_veda INTO wa_veda
                  WHERE ( vkuegru NE space
                     OR vbegdat > gv_per_e
                     OR venddat < gv_per_b ).
    DELETE gt_vbap WHERE vbeln = wa_veda-vbeln
                     AND posnr = wa_veda-vposn.
  ENDLOOP.
* End of MOD-006
** Not yet started
**** MOD-001 * begin ***
**  LOOP AT gt_veda WHERE vbegdat > p_budat.
*  LOOP AT gt_veda WHERE vbegdat > gv_per_e.
**** MOD-001 * end ***
*    DELETE gt_vbap WHERE vbeln = gt_veda-vbeln
*                     AND posnr = gt_veda-vposn.
*  ENDLOOP.
*** Finished
***** MOD-001 * begin ***
***  LOOP AT gt_veda WHERE venddat < p_budat.
*  LOOP AT gt_veda WHERE venddat < gv_per_b.
**** MOD-001 * end ***
*    DELETE gt_vbap WHERE vbeln = gt_veda-vbeln
*                     AND posnr = gt_veda-vposn.
*  ENDLOOP.
*
*  LOOP AT gt_veda WHERE venddat < gv_per_b.
**** MOD-001 * end ***
*    DELETE gt_vbap WHERE vbeln = gt_veda-vbeln
*                     AND posnr = gt_veda-vposn.
*  ENDLOOP.
**  FREE gt_veda. " MOD-005.
* End of MOD-005.
  IF gt_vbap[] IS NOT INITIAL.
* Partner data
    SELECT vbeln posnr parvw kunnr land1 INTO TABLE gt_vbpa
           FROM vbpa
           FOR ALL ENTRIES IN gt_vbap
           WHERE vbeln = gt_vbap-vbeln
             AND ( posnr = gt_vbap-posnr  OR
                   posnr = 0 )
             AND parvw = gc_we.

* Sold-to names
    SELECT kunnr name1 INTO TABLE gt_kna1i
           FROM kna1
           FOR ALL ENTRIES IN gt_vbap
           WHERE kunnr = gt_vbap-kunnr.
    SORT gt_kna1i BY kunnr.
    DELETE ADJACENT DUPLICATES FROM gt_kna1i COMPARING kunnr.
    gt_kna1[] = gt_kna1i[].
    FREE gt_kna1i.

* Conditions
    SELECT knumv kposn zaehk kwert waers INTO TABLE gt_konvi
           FROM konv
           FOR ALL ENTRIES IN gt_vbap
           WHERE knumv = gt_vbap-knumv
             AND kposn = gt_vbap-posnr
             AND kschl = gc_zek2
             AND kinak = ' '.
    SORT gt_konvi BY knumv kposn zaehk DESCENDING.
    DELETE ADJACENT DUPLICATES FROM gt_konvi COMPARING knumv kposn.
    gt_konv[] = gt_konvi[].

* Exchange rates
    SELECT kurst fcurr tcurr gdatu ukurs INTO TABLE gt_curri
           FROM tcurr
           WHERE kurst =  gv_kurst
             AND tcurr =  gv_waers_int
             AND gdatu GE gv_gdatu.
    SORT gt_curri BY kurst fcurr tcurr gdatu.
    DELETE ADJACENT DUPLICATES FROM gt_curri COMPARING kurst fcurr tcurr.
    gt_curr[] = gt_curri[].
    FREE gt_curri.

* Costs
    SELECT ci~objnr ci~beltp ci~twaer
           ci~owaer                                           "MOD-005
           ci~wtgbtr ci~wogbtr
           ci~wkgbtr                                          "MOD-005
           ci~belnr ci~buzei
           ch~awtyp                                           "MOD-002
           INTO TABLE gt_coep
           FROM coep AS ci
           INNER JOIN cobk AS ch
                      ON ci~kokrs = ch~kokrs  AND
                         ci~belnr = ch~belnr
           FOR ALL ENTRIES IN gt_vbap
           WHERE ci~lednr =  '00'
             AND ci~objnr =  gt_vbap-objnr
             AND ci~wrttp =  '04'             "Actual costs
             AND ci~versn =  '000'
             AND ci~beknz IN ('H', 'S')
             AND ch~budat LE p_budat.

* Begin OF MOD-006.
    PERFORM gl_account_condition.
** Build range for assignments (contract nr + item)
    clear w_zuonr.                                                    " MOD-006
*    r_zuonr-sign = 'I'.                                              " Comemnted by MOD-006
*    r_zuonr-option = 'EQ'.                                           " Commented by MOD-006
    w_zuonr-sign = 'I'.                                               " MOD-006
    w_zuonr-option = 'EQ'.                                            " MOD-006
*    LOOP AT gt_vbap.                                                 " Commented by MOD-006
    LOOP AT gt_vbap INTO wa_vbap.                                     " MOD-006
*      CONCATENATE gt_vbap-vbeln gt_vbap-posnr INTO r_zuonr-low.      " Commented by MOD-006
      CONCATENATE wa_vbap-vbeln wa_vbap-posnr INTO w_zuonr-low.       " MOD-006
*      APPEND r_zuonr.                                                 " Commented by MOD-006
      APPEND w_zuonr to r_zuonr.                                      " MOD-006
    ENDLOOP.
** Open G/L accounting documents
*    SELECT belnr gjahr hkont zuonr budat waers prctr segment bldat mwskz
*           INTO TABLE gt_bsis
*           FROM bsis
*           WHERE bukrs = p_bukrs
*             AND hkont IN (p_acc1, p_acc2)
*             AND zuonr IN r_zuonr
*             AND blart =  p_blart
*             AND budat LE p_budat.
*
** Cleared G/L accounting documents
*    SELECT belnr gjahr hkont zuonr budat waers prctr segment bldat mwskz
*           APPENDING TABLE gt_bsis
*           FROM bsas
*           WHERE bukrs = p_bukrs
*             AND hkont IN (p_acc1, p_acc2)
*             AND zuonr IN r_zuonr
*             AND blart =  p_blart
*             AND budat LE p_budat.
*
** Get the most recent documents per contract item
*    SORT gt_bsis BY zuonr budat DESCENDING hkont DESCENDING.
*    DELETE ADJACENT DUPLICATES FROM gt_bsis
*           COMPARING zuonr.
* End of MOD-006.
* Begin OF MOD-005.
* End of MOD-005.
*** MOD-002 * begin ***
* Get the final POC postings (Per contract item)
    CLEAR gt_fini[].
* Open G/L accounting documents
    SELECT zuonr belnr gjahr
           INTO TABLE gt_fini
           FROM bsis
           WHERE bukrs = p_bukrs
             AND hkont IN (p_acc1, p_acc2)
             AND zuonr IN r_zuonr
             AND xblnr =  gc_pocf
             AND blart =  gc_sa
             AND budat LE p_budat.
* Cleared G/L accounting documents
    SELECT zuonr belnr gjahr
           APPENDING TABLE gt_fini
           FROM bsas
           WHERE bukrs = p_bukrs
             AND hkont IN (p_acc1, p_acc2)
             AND zuonr IN r_zuonr
             AND xblnr =  gc_pocf
             AND blart =  gc_sa
             AND budat LE p_budat.
    SORT gt_fini BY zuonr.
    DELETE ADJACENT DUPLICATES FROM gt_fini
           COMPARING zuonr.
    gt_final[] = gt_fini[].
    FREE gt_fini.
*** MOD-002 * end ***
  ENDIF.
ENDFORM.                    " SELECT_DATA_SEED

*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA_SEED
*&---------------------------------------------------------------------*
*       Process data (SEED countries)
*----------------------------------------------------------------------*
FORM process_data_seed .
  DATA: lv1_posnr TYPE posnr.
* Begin of MOD-005.
  DATA: c1 TYPE sy-tabix.
  REFRESH: gt_bsis_new1, gt_bsis_new2.
  PERFORM reversal_gl_account_logic USING p_acc1.
  gt_bsis_new1[] = gt_bsis_new[].
  PERFORM reversal_gl_account_logic USING p_acc2.
  gt_bsis_new2[] = gt_bsis_new[].
* End of MOD-005.
* Begin of MOD-006.


*  LOOP AT gt_bsis.

*  LOOP AT gt_vbap.                                                 " Commented by MOD-006
  LOOP AT gt_vbap INTO wa_vbap_new1.                                " MOD-006
*    CONCATENATE gt_vbap-vbeln gt_vbap-posnr INTO gt_bsis-zuonr.   " Commented by MOD-006
    CONCATENATE wa_vbap_new1-vbeln wa_vbap_new1-posnr INTO gv_zuonr.   " MOD-006
* End of mod-006.
*** MOD-002 * begin ***
*   Check if the final POC posting is already made
*    READ TABLE gt_final WITH TABLE KEY zuonr = gt_bsis-zuonr.       " Commented by MOD-006
    READ TABLE gt_final INTO wa_final WITH TABLE KEY zuonr = gv_zuonr.       " Commented by MOD-006
    IF sy-subrc = 0.
      CONTINUE.
    ENDIF.
*** MOD-002 * end ***

*    CLEAR gt_seed.                    " Commented by MOD-006
    CLEAR wa_seed.                     " MOD-006
*   Get contract data
*   Begin of MOD-006.
*    READ TABLE gt_vbap WITH TABLE KEY vbeln = gt_bsis-zuonr(10)
*                                      posnr = gt_bsis-zuonr+10(6).
*    CHECK sy-subrc = 0.
*    MOVE-CORRESPONDING gt_vbap TO gt_seed.
    wa_seed-vbeln     = wa_vbap_new1-vbeln.
    wa_seed-posnr     = wa_vbap_new1-posnr.
    wa_seed-netwr     = wa_vbap_new1-netwr.
    wa_seed-matnr     = wa_vbap_new1-matnr.
    wa_seed-prctr_c   = wa_vbap_new1-prctr_c.
    wa_seed-prodh     = wa_vbap_new1-prodh.
    wa_seed-waerk     = wa_vbap_new1-waerk.
    wa_seed-kunnr     = wa_vbap_new1-kunnr.
    wa_seed-vkorg     = wa_vbap_new1-vkorg.
    wa_seed-vtweg     = wa_vbap_new1-vtweg.
    wa_seed-spart     = wa_vbap_new1-spart.
    wa_seed-vkbur     = wa_vbap_new1-vkbur.
*   End of MOD-006.

*** MOD-002 * begin ***
*   Status
    CALL FUNCTION 'STATUS_TEXT_EDIT'
      EXPORTING
*        CLIENT                  = SY-MANDT
        objnr                   = wa_vbap_new1-objnr
*        ONLY_ACTIVE             = 'X'
        spras                   = sy-langu
      IMPORTING
        line                    = wa_seed-stext
*        USER_LINE               =
      EXCEPTIONS
        object_not_found        = 1
        OTHERS                  = 2
              .
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
*** MOD-002 * end ***

*   Ref. document data
*   Ref. document data
* Begin of MOD-006.
    wa_seed-waers  = wa_vbap_new1-waerk.
    wa_seed-mwskz  = 'ZS'.
    wa_seed-prctr  =  wa_vbap_new1-prctr_c.
    wa_seed-bldat  = sy-datum.
    SELECT SINGLE segment FROM yse_prctr_bl INTO wa_seed-segment WHERE prctr = wa_seed-prctr.
*    MOVE-CORRESPONDING gt_bsis TO gt_seed.
* End of MOD-006.
    wa_seed-waers_cc = gv_waers_cc.

*   Name Sold-to
    CLEAR wa_kna1.                                                              " MOD-006
*    READ TABLE gt_kna1 WITH TABLE KEY kunnr = wa_vbap_new1-kunnr.              " Commented by MOD-006
    READ TABLE gt_kna1 INTO wa_kna1 WITH TABLE KEY kunnr = wa_vbap_new1-kunnr.  " MOD-006
    IF sy-subrc = 0.
*      wa_seed-name1_ag = gt_kna1-name1.                                        " Commented by MOD-006
      wa_seed-name1_ag = wa_kna1-name1.                                         " MOD-006
    ENDIF.

*   Land Ship-to
    CLEAR wa_vbpa.                                                               " MOD-006
*    READ TABLE gt_vbpa WITH TABLE KEY vbeln = wa_vbap_new1-vbeln                " Commented by MOD-006
    READ TABLE gt_vbpa INTO wa_vbpa WITH TABLE KEY vbeln = wa_vbap_new1-vbeln                "  MOD-006
                                                           posnr = wa_vbap_new1-posnr
                                                           parvw = gc_we.
    IF sy-subrc NE 0.
*      READ TABLE gt_vbpa WITH TABLE KEY vbeln = wa_vbap_new1-vbeln
*                                        posnr = 0
*                                        parvw = gc_we.
*      READ TABLE gt_vbpa WITH TABLE KEY vbeln = wa_vbap_new1-vbeln              " Commented by MOD-006
      READ TABLE gt_vbpa INTO wa_vbpa WITH TABLE KEY vbeln = wa_vbap_new1-vbeln                "  MOD-006
                                                             posnr = lv1_posnr
                                                             parvw = gc_we.
    ENDIF.
    IF sy-subrc = 0.
*      wa_seed-land1_we = gt_vbpa-land1.                                         " Commented by MOD-006
      wa_seed-land1_we = wa_vbpa-land1.                                          " MOD-006
    ENDIF.

*   Planned Cost
    PERFORM calc_plan_cost_seed.

*   Planned Revenue
    wa_seed-pl_rev_so = wa_vbap_new1-netwr * -1.
*   begin of mod-005
    CLEAR wa_vbrp1.
    READ TABLE gt_vbrp2 INTO wa_vbrp1 WITH KEY vgbel = wa_vbap_new1-vbeln vgpos = wa_vbap_new1-posnr.
    IF sy-subrc = 0.
      wa_seed-pl_rev_so = wa_seed-pl_rev_so  +  wa_vbrp1-netwr.
    ENDIF.
*   end of mod-005.
*   Convert to local currency
    PERFORM convert_amount_int USING wa_seed-pl_rev_so
                                     wa_seed-waerk
                                     wa_seed-pl_rev_lc
                                     gv_waers_cc.

*   Actual Cost
    PERFORM calc_actual_seed USING '1'
                                   wa_seed-act_cost_so
                                   wa_seed-act_cost_lc.

*  Begin of Mod-007
    if wa_seed-act_cost_so < 0.
     wa_seed-act_cost_so = 0.
    endif.
    if wa_seed-act_cost_lc < 0.
     wa_seed-act_cost_lc = 0.
    endif.
*  End of MOD-007
*   Revenue Recognition (actual)
*** MOD-002 * begin ***
    CLEAR: gv_act_rr_so,
           gv_act_rr_lc.
*** MOD-002 * end ***
    PERFORM calc_actual_seed USING '2'
                                   wa_seed-act_rev_so
                                   wa_seed-act_rev_lc.
*   Revenue Recognition POC
*   SO currency
    gv_pl_cost_so = wa_seed-pl_cost_so.
    IF gv_pl_cost_so = 0.
      gv_pl_cost_so = 1.
    ENDIF.
    wa_seed-rr_poc_so = ( wa_seed-act_cost_so / gv_pl_cost_so ) *
                         wa_seed-pl_rev_so.
*   Begin of MOD-006.
*    IF ABS( gt_seed-rr_poc_so ) > ABS( gt_seed-pl_rev_so ).
*      gt_seed-rr_poc_so = gt_seed-pl_rev_so.
*    ENDIF.

    IF ( ( ABS( wa_seed-rr_poc_so ) > ABS( wa_seed-pl_rev_so ) ) OR ( ABS( wa_seed-act_cost_so ) > ABS( wa_seed-pl_cost_so ) ) ) .
      wa_seed-rr_poc_so = wa_seed-pl_rev_so.
    ENDIF.
*   End of MOD-006.
**   Begin OF MOD-005.
*    READ TABLE gt_veda WITH KEY vbeln = gt_bsis-zuonr(10)       " Commented by MOD-006
*                                vposn = gt_bsis-zuonr+10(6).
    CLEAR wa_veda.                                                " MOD-006
    READ TABLE gt_veda INTO wa_veda WITH KEY vbeln = gv_zuonr(10)             " MOD-006
                                             vposn = wa_vbap_new1-posnr.
    IF sy-subrc = 0.
      IF wa_veda-venddat LE sy-datum.                         " MOD-006
        wa_seed-rr_poc_so = wa_seed-pl_rev_so.
      ENDIF.
    ELSE.
*      READ TABLE gt_veda WITH KEY vbeln = gt_bsis-zuonr(10)    " Commented by MOD-006
*                                  vposn = ''.
      READ TABLE gt_veda INTO wa_veda WITH KEY vbeln = gv_zuonr(10)    " MOD-006
                                               vposn = lv1_posnr.
      IF sy-subrc = 0.
        IF wa_veda-venddat LE sy-datum AND wa_veda-venddat GE gv_per_b.   " MOD-006
          wa_seed-rr_poc_so = wa_seed-pl_rev_so.
        ENDIF.
      ENDIF.
    ENDIF.
*   End of MOD-005.
*   Local currency
    gv_pl_cost_lc = wa_seed-pl_cost_lc.
    IF gv_pl_cost_lc = 0.
      gv_pl_cost_lc = 1.
    ENDIF.
    wa_seed-rr_poc_lc = ( wa_seed-act_cost_lc / gv_pl_cost_lc ) *
                         wa_seed-pl_rev_lc.
*   Begin of MOD-006.
*    IF ABS( gt_seed-rr_poc_lc ) > ABS( gt_seed-pl_rev_lc ).
*      gt_seed-rr_poc_lc = gt_seed-pl_rev_lc.
*    ENDIF.

    IF ( ( ABS( wa_seed-rr_poc_lc ) > ABS( wa_seed-pl_rev_lc ) ) OR ( ABS( wa_seed-act_cost_lc ) > ABS( wa_seed-pl_cost_lc ) ) ) .
      wa_seed-rr_poc_lc = wa_seed-pl_rev_lc.
    ENDIF.
*   End of MOD-005.
*   Begin of MOD-005
*    READ TABLE gt_veda WITH KEY vbeln = gt_bsis-zuonr(10)      " Commented by MOD-006
*                                vposn = gt_bsis-zuonr+10(6).
    CLEAR wa_veda.
    READ TABLE gt_veda INTO wa_veda WITH KEY vbeln = gv_zuonr(10)      " MOD-006
                                             vposn = wa_vbap_new1-posnr.
    IF sy-subrc = 0.
      IF wa_veda-venddat LE sy-datum.                               " MOD-006
        wa_seed-rr_poc_lc = wa_seed-pl_rev_lc.
      ENDIF.
    ELSE.
*      READ TABLE gt_veda WITH KEY vbeln = gt_bsis-zuonr(10)    " Commented by MOD-006
*                                  vposn = ''.
      READ TABLE gt_veda INTO wa_veda WITH KEY vbeln = gv_zuonr(10)     " mod-006
                                               vposn = lv1_posnr.
      IF sy-subrc = 0.
        IF wa_veda-venddat LE sy-datum AND wa_veda-venddat GE gv_per_b. " MOD-006
          wa_seed-rr_poc_lc = wa_seed-pl_rev_lc.
        ENDIF.
      ENDIF.
    ENDIF.
*   End of MOD-005.
    CLEAR wa_vbrp.                                                            " Mod-006
*    READ TABLE gt_vbrp INTO wa_vbrp WITH KEY vgbel = gt_bsis-zuonr(10)       " Commented by MOD-006
*                                             vgpos = gt_bsis-zuonr+10(6).
    READ TABLE gt_vbrp INTO wa_vbrp WITH KEY vgbel = gv_zuonr(10)             " MOD-006
                                             vgpos = wa_vbap_new1-posnr.
    wa_seed-netwr = ABS( wa_vbrp-netwr ).
*   End of MOD-005.
*** MOD-002 * begin ***
*   Check if final POC adjustment
* Begin of MOD-006.
*    IF gv_act_rr_so = gt_seed-pl_rev_so.
    IF gv_act_rr_so = wa_seed-pl_rev_so AND ABS( wa_seed-rr_poc_so ) = ABS( wa_seed-netwr ).
*   End of MOD-006.
      IF wa_seed-act_rev_so = wa_seed-pl_rev_so.
*       Do nothing
        CONTINUE.
      ELSE.
*       FINAL
*       Reference
        wa_seed-xblnr = gc_pocf.
*       Difference Planned Revenue & Revenue
        wa_seed-diff_rr_so = wa_seed-act_rev_so  - wa_seed-pl_rev_so .
        wa_seed-diff_rr_lc = wa_seed-act_rev_lc  - wa_seed-pl_rev_lc .
*       Posting keys
        IF wa_seed-pl_rev_so LE 0.
          IF wa_seed-act_rev_so LE 0.
            IF ABS( wa_seed-act_rev_so ) > ABS( wa_seed-pl_rev_so ).
              wa_seed-bschl1 = '40'.
              wa_seed-bschl2 = '50'.

*              begin of mod-004
              IF wa_seed-diff_rr_so EQ  wa_seed-act_rev_so.
                IF wa_seed-diff_rr_so GT 0.
                  wa_seed-bschl1 = '50'.
                  wa_seed-bschl2 = '40'.
                ELSE.
                  wa_seed-bschl1 = '40'.
                  wa_seed-bschl2 = '50'.
                ENDIF.
              ENDIF.
*             end of mod-004
            ELSE.
              wa_seed-bschl1 = '50'.
              wa_seed-bschl2 = '40'.
            ENDIF.
          ELSE.
            wa_seed-bschl1 = '50'.
            wa_seed-bschl2 = '40'.
          ENDIF.
        ELSE.
          IF wa_seed-act_rev_so > 0.
            IF ABS( wa_seed-act_rev_so ) > ABS( wa_seed-pl_rev_so ).
              wa_seed-bschl1 = '50'.
              wa_seed-bschl2 = '40'.
            ELSE.
              wa_seed-bschl1 = '40'.
              wa_seed-bschl2 = '50'.
            ENDIF.
          ELSE.
            wa_seed-bschl1 = '40'.
            wa_seed-bschl2 = '50'.

*            *          begin of mod-004
            IF wa_seed-diff_rr_so GE 0.
              wa_seed-bschl1 = '50'.  " Mod-004
              wa_seed-bschl2 = '40'.  " mod-004
            ELSE.
              wa_seed-bschl1 = '40'.
              wa_seed-bschl2 = '50'.
            ENDIF.
*          end of mod-004
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
*     NOT FINAL
*     Reference
      wa_seed-xblnr = gc_poc.
*** MOD-002 * end ***
*     Difference Revenue & Revenue POC
      wa_seed-diff_rr_so = wa_seed-act_rev_so -  wa_seed-rr_poc_so .
      wa_seed-diff_rr_lc = wa_seed-act_rev_lc -  wa_seed-rr_poc_lc .
*** MOD-002 * begin ***
*     Posting keys
      IF wa_seed-act_rev_so LE 0.
        IF wa_seed-rr_poc_so LE 0.
          IF ABS( wa_seed-act_rev_so ) > ABS( wa_seed-rr_poc_so ).
            wa_seed-bschl1 = '40'.
            wa_seed-bschl2 = '50'.
*            begin of mod-004
            IF wa_seed-diff_rr_so EQ  wa_seed-act_rev_so.
              IF wa_seed-diff_rr_so GE 0.
                wa_seed-bschl1 = '50'.
                wa_seed-bschl2 = '40'.
              ELSE.
                wa_seed-bschl1 = '40'.
                wa_seed-bschl2 = '50'.
              ENDIF.
            ENDIF.
*             end of mod-004
          ELSE.
            wa_seed-bschl1 = '50'.
            wa_seed-bschl2 = '40'.
          ENDIF.
        ELSE.
          wa_seed-bschl1 = '50'.
          wa_seed-bschl2 = '40'.
        ENDIF.
      ELSE.
        IF wa_seed-rr_poc_so > 0.
          IF ABS( wa_seed-act_rev_so ) > ABS( wa_seed-rr_poc_so ).
            wa_seed-bschl1 = '50'.
            wa_seed-bschl2 = '40'.
          ELSE.
            wa_seed-bschl1 = '40'.
            wa_seed-bschl2 = '50'.
          ENDIF.
        ELSE.
*          begin of mod-004
          IF wa_seed-diff_rr_so GE 0.
            wa_seed-bschl1 = '50'.  " Mod-004
            wa_seed-bschl2 = '40'.  " mod-004
          ELSE.
            wa_seed-bschl1 = '40'.
            wa_seed-bschl2 = '50'.
          ENDIF.
*          end of mod-004
        ENDIF.
      ENDIF.
    ENDIF.
*** MOD-002 * end ***
*    Begin of mod-005
    wa_seed-bschl_flag = wa_seed-bschl2.
    wa_seed-q =  ABS( wa_seed-rr_poc_so ) - ABS( wa_vbrp-netwr ).
    PERFORM convert_amount_int USING wa_seed-q
                                     wa_seed-waers
                                     wa_seed-q1
                                     wa_seed-waers_cc.
    IF ( ABS( wa_seed-rr_poc_so ) < ABS( wa_vbrp-netwr ) AND wa_seed-xblnr NE gc_pocf ).
      CLEAR wa_bsis_new.
*      READ TABLE gt_bsis_new1 INTO wa_bsis_new WITH KEY zuonr = gt_bsis-zuonr.    " Commented by MOD-006
      READ TABLE gt_bsis_new1 INTO wa_bsis_new WITH KEY zuonr = gv_zuonr.    " MOD-006
      IF sy-subrc = 0.
        wa_seed-belnr     = wa_bsis_new-belnr.
        wa_seed-gjahr     = wa_bsis_new-gjahr.
        IF wa_bsis_new-bschl = '50'.
          wa_seed-bschl2     = '40'.
        ELSEIF wa_bsis_new-bschl = '40'.
          wa_seed-bschl2     = '50'.
        ENDIF.
        wa_seed-waerk_new1 = ABS( wa_bsis_new-dmbtr ).
        wa_seed-wrbtr_new1 = ABS( wa_bsis_new-wrbtr ).
      ENDIF.
      wa_seed-hkont = p_acc1.
      CLEAR wa_bsis_new.
*      READ TABLE gt_bsis_new2 INTO wa_bsis_new WITH KEY zuonr = gt_bsis-zuonr.     " Commented by MOD-006
      READ TABLE gt_bsis_new2 INTO wa_bsis_new WITH KEY zuonr = gv_zuonr.     " Commented by MOD-006
      IF sy-subrc = 0.
        wa_seed-belnr     = wa_bsis_new-belnr.
        wa_seed-gjahr     = wa_bsis_new-gjahr.
        wa_seed-bschl_new = wa_bsis_new-bschl.
        wa_seed-waerk_new = ABS( wa_bsis_new-dmbtr ).
        wa_seed-wrbtr_new = ABS( wa_bsis_new-wrbtr ).
      ENDIF.
      wa_seed-hkont_new = p_acc2.
    ELSEIF ( ABS( wa_seed-rr_poc_so ) > ABS( wa_vbrp-netwr ) AND wa_seed-xblnr NE gc_pocf ).

      CLEAR wa_bsis_new.
*      READ TABLE gt_bsis_new2 INTO wa_bsis_new WITH KEY zuonr = gt_bsis-zuonr.  " Commented by MOD-006
      READ TABLE gt_bsis_new2 INTO wa_bsis_new WITH KEY zuonr = gv_zuonr.        " MOD-006
      IF sy-subrc = 0.
        wa_seed-belnr     = wa_bsis_new-belnr.
        wa_seed-gjahr     = wa_bsis_new-gjahr.
        IF wa_bsis_new-bschl = '50'.
          wa_seed-bschl2     = '40'.
        ELSEIF wa_bsis_new-bschl = '40'.
          wa_seed-bschl2     = '50'.
        ENDIF.
        wa_seed-waerk_new1 = ABS( wa_bsis_new-dmbtr ).
        wa_seed-wrbtr_new1 = ABS( wa_bsis_new-wrbtr ).
      ENDIF.
      wa_seed-hkont = p_acc2.
      CLEAR wa_bsis_new.
*      READ TABLE gt_bsis_new1 INTO wa_bsis_new WITH KEY zuonr = gt_bsis-zuonr.     " Commented by MOD-006
      READ TABLE gt_bsis_new1 INTO wa_bsis_new WITH KEY zuonr = gv_zuonr.           " MOD-006
      IF sy-subrc = 0.
        wa_seed-belnr     = wa_bsis_new-belnr.
        wa_seed-gjahr     = wa_bsis_new-gjahr.
        wa_seed-bschl_new = wa_bsis_new-bschl.
        wa_seed-waerk_new = ABS( wa_bsis_new-dmbtr ).
        wa_seed-wrbtr_new = ABS( wa_bsis_new-wrbtr ).
      ENDIF.
      wa_seed-hkont_new = p_acc1.
    ELSE.

      CLEAR wa_bsis_new.
*      READ TABLE gt_bsis_new2 INTO wa_bsis_new WITH KEY zuonr = gt_bsis-zuonr.    " Commented by MOD-006
      READ TABLE gt_bsis_new2 INTO wa_bsis_new WITH KEY zuonr = gv_zuonr.          " Mod-006
      IF sy-subrc = 0.
        wa_seed-belnr     = wa_bsis_new-belnr.
        wa_seed-gjahr     = wa_bsis_new-gjahr.
        IF wa_bsis_new-bschl = '50'.
          wa_seed-bschl2     = '40'.
        ELSEIF wa_bsis_new-bschl = '40'.
          wa_seed-bschl2     = '50'.
        ENDIF.
        wa_seed-bschl_flag = wa_bsis_new-bschl.
        wa_seed-waerk_new1 = ABS( wa_bsis_new-dmbtr ).
        wa_seed-wrbtr_new1 = ABS( wa_bsis_new-wrbtr ).
      ENDIF.
      wa_seed-hkont = p_acc2.
      CLEAR wa_bsis_new.
*      READ TABLE gt_bsis_new1 INTO wa_bsis_new WITH KEY zuonr = gt_bsis-zuonr. " Commented by MOD-006
      READ TABLE gt_bsis_new1 INTO wa_bsis_new WITH KEY zuonr = gv_zuonr.       " MOD-006
      IF sy-subrc = 0.
        wa_seed-belnr     = wa_bsis_new-belnr.
        wa_seed-gjahr     = wa_bsis_new-gjahr.
        wa_seed-bschl_new = wa_bsis_new-bschl.
        wa_seed-waerk_new = ABS( wa_bsis_new-dmbtr ).
        wa_seed-wrbtr_new = ABS( wa_bsis_new-wrbtr ).
      ENDIF.
      wa_seed-hkont_new = p_acc1.
    ENDIF.
    IF ( wa_seed-bschl_new = '50' AND wa_seed-bschl2 = '50' ).
      wa_seed-p = ABS( wa_seed-waerk_new ) - ABS( wa_seed-waerk_new1 ).
      wa_seed-p1 = ABS( wa_seed-wrbtr_new ) - ABS( wa_seed-wrbtr_new1 ).
    ELSEIF ( wa_seed-bschl_new = '40' AND wa_seed-bschl2 = '40' ).
      wa_seed-p = ABS( wa_seed-waerk_new1 ) - ABS( wa_seed-waerk_new ).
      wa_seed-p1 = ABS( wa_seed-wrbtr_new1 ) - ABS( wa_seed-wrbtr_new ).
    ELSE.
      wa_seed-p = ABS( wa_seed-waerk_new ) + ABS( wa_seed-waerk_new1 ).
      wa_seed-p1 = ABS( wa_seed-wrbtr_new ) + ABS( wa_seed-wrbtr_new1 ).
      IF wa_seed-bschl2 = '50'.
        wa_seed-p  = wa_seed-p  * -1.
        wa_seed-p1 = wa_seed-p1 * -1.
      ENDIF.
    ENDIF.
    IF wa_seed-xblnr = gc_pocf.
      wa_seed-q  = 0.
      wa_seed-q1 = 0.
    ENDIF.
    CLEAR wa_seed-flag.
    IF wa_seed-diff_rr_so NE 0.
      wa_seed-flag = 'X'.
*      APPEND gt_seed.      " Commented by MOD-006
      APPEND wa_seed TO gt_seed.      " mod-006
    ELSE.
      IF wa_seed-wrbtr_new IS INITIAL AND wa_seed-wrbtr_new1 IS NOT INITIAL AND wa_seed-q IS INITIAL .
        CONTINUE.
      ELSEIF wa_seed-wrbtr_new1 IS INITIAL AND wa_seed-wrbtr_new IS NOT INITIAL AND wa_seed-q IS INITIAL .
        CONTINUE.
      ELSEIF wa_seed-q NE wa_seed-p1 AND wa_seed-q IS INITIAL .
        CONTINUE.
      ELSEIF wa_seed-wrbtr_new1 IS INITIAL AND wa_seed-wrbtr_new IS INITIAL AND wa_seed-q IS INITIAL.
        CONTINUE.
      ELSEIF wa_seed-q IS NOT INITIAL AND wa_seed-wrbtr_new IS INITIAL.
        CONTINUE.
      ELSEIF wa_seed-q EQ wa_seed-p1 AND wa_seed-q IS INITIAL.
        wa_seed-flag = 'X'.
*        APPEND gt_seed.                           " Commented by MOD-006
        APPEND wa_seed TO gt_seed.                 " MOD-006
      ELSEIF wa_seed-q IS NOT INITIAL AND wa_seed-wrbtr_new IS NOT INITIAL.
        wa_seed-flag = 'X'.
*        APPEND gt_seed.                           " Commented by MOD-006
        APPEND wa_seed TO gt_seed.                 " MOD-006
      ENDIF.
    ENDIF.
*   End of MOD-005.
*** MOD-003 * end ***
  ENDLOOP.
*  begin of mod-005.
  IF gt_seed[] IS INITIAL.
    CLEAR gv_errlst.
    NEW-PAGE.
    WRITE: /01 'No differences calculated (to be posted)'(i01).
    ULINE.
    p_test = 'X'.
    RETURN.
  ENDIF.
*  LOOP AT gt_seed WHERE flag = 'X'.                            " Commented by MOD-006
  LOOP AT gt_seed INTO wa_seed WHERE flag = 'X'.               " MOD-006.
    IF ( ( wa_seed-p1 =  wa_seed-q AND wa_seed-diff_rr_so IS INITIAL ) OR ( wa_seed-p1 = 0 AND wa_seed-diff_rr_so IS INITIAL ) ).
      wa_seed-saknr = wa_seed-hkont_new.
      IF wa_seed-diff_rr_so IS INITIAL.
        wa_seed-diff_rr_so = wa_seed-wrbtr_new.
        wa_seed-diff_rr_so1 = wa_seed-wrbtr_new .
        wa_seed-bschl1 = wa_seed-bschl_new.
        IF wa_seed-bschl1 = '40'.
          wa_seed-bschl_flag = '50'.
        ELSEIF wa_seed-bschl1 = '50'.
          wa_seed-bschl_flag = '40'.
        ENDIF.
        CLEAR wa_seed-bschl_new.
      ENDIF.
    ELSE.
      IF wa_seed-diff_rr_so IS INITIAL.
        wa_seed-diff_rr_so = wa_seed-wrbtr_new.
        wa_seed-diff_rr_so1 = wa_seed-wrbtr_new .
        wa_seed-bschl1 = wa_seed-bschl_new.
        IF wa_seed-bschl1 = '40'.
          wa_seed-bschl_flag = '50'.
        ELSEIF wa_seed-bschl1 = '50'.
          wa_seed-bschl_flag = '40'.
        ENDIF.
        CLEAR wa_seed-bschl_new.
      ENDIF.
      IF  wa_seed-q = wa_seed-p1 AND wa_seed-q = 0.
        wa_seed-diff_rr_so1 = wa_seed-wrbtr_new1 .
      ELSE.
        IF wa_seed-bschl_new = ''.
          wa_seed-diff_rr_so1 = ABS( wa_seed-diff_rr_so ).
        ENDIF.
        IF wa_seed-bschl1 = '50'.
          IF wa_seed-bschl_new = '50'.
            wa_seed-diff_rr_so1 = ABS( wa_seed-diff_rr_so ) + ABS( wa_seed-wrbtr_new ).
          ELSEIF wa_seed-bschl_new = '40'.
            IF ABS( wa_seed-diff_rr_so )  <  ABS( wa_seed-wrbtr_new ).
              wa_seed-bschl_flag = '50'.
            ELSE.
              wa_seed-bschl_flag = '40'.
            ENDIF.
            wa_seed-diff_rr_so1 = ABS( wa_seed-diff_rr_so )  -  ABS( wa_seed-wrbtr_new ) .
          ENDIF.
        ELSEIF wa_seed-bschl1 = '40'.
          IF wa_seed-bschl_new = '50'.
            IF ABS( wa_seed-diff_rr_so )  <  ABS( wa_seed-wrbtr_new ).
              wa_seed-bschl_flag = '40'.
            ELSE.
              wa_seed-bschl_flag = '50'.
            ENDIF.
            wa_seed-diff_rr_so1 = ABS( wa_seed-diff_rr_so ) - ABS( wa_seed-wrbtr_new ).
          ELSEIF wa_seed-bschl_new = '40'.
            wa_seed-diff_rr_so1 = ABS( wa_seed-diff_rr_so )  +  ABS( wa_seed-wrbtr_new ) .
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
    CLEAR c1.
    c1 = sy-tabix.
    PERFORM convert_amount_int USING wa_seed-diff_rr_so
                                 wa_seed-waers
                                 wa_seed-diff_rr_lc
                                 wa_seed-waers_cc.
*    MODIFY gt_seed INDEX c1.       " Commented by MOD-006
    MODIFY gt_seed FROM wa_seed INDEX c1.     " MOD-006
  ENDLOOP.
ENDFORM.                    " PROCESS_DATA_SEED

*&---------------------------------------------------------------------*
*&      Form  CONVERT_AMOUNT_INT
*&---------------------------------------------------------------------*
*       Convert amount via intermediate currency
*----------------------------------------------------------------------*
*      -->P_KWERT_IN  : Given Value
*      -->P_WAERS_IN  : Given Currency
*      -->P_KWERT_OUT : Converted Value
*      -->P_WAERS_RES : Result Currency
*----------------------------------------------------------------------*
FORM convert_amount_int  USING    p_kwert_in
                                  p_waers_in
                                  p_kwert_out
                                  p_waers_res.

  DATA: lv_value_int   TYPE wtgxxx.

* Input Currency = Result currency -> NO conversion
  IF p_waers_in = p_waers_res.
    p_kwert_out = p_kwert_in.
    RETURN.
  ENDIF.

* Intermediate exchange rate
  IF p_waers_in = gv_waers_int.
    lv_value_int = p_kwert_in.
  ELSE.
*    CLEAR gt_curr.                                                " Commented by MOD-006
    CLEAR wa_curr.                                                 " MOD-006
*    READ TABLE gt_curr WITH TABLE KEY kurst = gv_kurst             " Commented by MOD-006
    READ TABLE gt_curr INTO wa_curr WITH TABLE KEY kurst = gv_kurst             "  MOD-006
                                                   fcurr = p_waers_in
                                                   tcurr = gv_waers_int.
    CHECK sy-subrc = 0.
*     Calculate ammount in intermediate currency
    IF wa_curr-ukurs = 0.
      wa_curr-ukurs = 1.
    ENDIF.
    lv_value_int = p_kwert_in * wa_curr-ukurs.
  ENDIF.

* Result exchange rate
  IF p_waers_res = gv_waers_int.
    p_kwert_out = lv_value_int.
  ELSE.
*    CLEAR gt_curr.                                                          " Commented by MOD-006
    CLEAR wa_curr.                                                           " MOD-006
*    READ TABLE gt_curr WITH TABLE KEY kurst = gv_kurst                      " Commented by MOD-006
    READ TABLE gt_curr INTO wa_curr WITH TABLE KEY kurst = gv_kurst          " MOD-006
                                                   fcurr = p_waers_res
                                                   tcurr = gv_waers_int.
    CHECK sy-subrc = 0.
*     Calculate ammount in result currency
    IF wa_curr-ukurs = 0.
      wa_curr-ukurs = 1.
    ENDIF.
    p_kwert_out = lv_value_int / wa_curr-ukurs.
  ENDIF.

ENDFORM.                    " CONVERT_AMOUNT_INT

*&---------------------------------------------------------------------*
*&      Form  CALC_PLAN_COST_SEED
*&---------------------------------------------------------------------*
*       Calculate Planned Cost (SEED countries)
*----------------------------------------------------------------------*
FORM calc_plan_cost_seed .

* Get condition data
  CLEAR wa_konv.                                                             " MOD-006
*  READ TABLE gt_konv WITH TABLE KEY knumv = wa_vbap_new1-knumv              " Commented by MOD-006
  READ TABLE gt_konv INTO wa_konv WITH TABLE KEY knumv = wa_vbap_new1-knumv  " MOD-006
                                                 kposn = wa_vbap_new1-posnr.

  IF sy-subrc = 0.
    wa_seed-pl_cost_so = wa_konv-kwert.
*   Convert to local currency
    PERFORM convert_amount_int USING wa_konv-kwert
                                     wa_seed-waerk
                                     wa_seed-pl_cost_lc
                                     gv_waers_cc.
  ENDIF.

ENDFORM.                    " CALC_PLAN_COST_SEED

*&---------------------------------------------------------------------*
*&      Form  CALC_ACTUAL_SEED
*&---------------------------------------------------------------------*
*       Calculate Actual Cost / Revenue (SEED countries)
*----------------------------------------------------------------------*
*      -->P_BELTP  : Debit type (0,1 = Cost / 2 = Revenue)
*      -->P_ACT_SO : Actual Value in Sales Order Currency
*      -->P_ACT_LC : Actual Value in Local Currency
*----------------------------------------------------------------------*
FORM calc_actual_seed  USING    p_beltp
                                p_act_so
                                p_act_lc.

  CLEAR: gv_act_so,
         gv_act_lc.

  IF p_beltp = '0'  OR
     p_beltp = '1'.
*   Cost
*    LOOP AT gt_coep WHERE objnr = gt_vbap-objnr                   " Comment by MOD-006
    LOOP AT gt_coep INTO wa_coep WHERE objnr = wa_vbap_new1-objnr        " MOD-006
                                   AND ( beltp = '0' OR beltp = '1' ).
*     Get actual values
      PERFORM get_act_seed.
    ENDLOOP.

  ELSEIF p_beltp = '2'.
*   Revenue
*    LOOP AT gt_coep WHERE objnr = gt_vbap-objnr                   " Comment by MOD-006
    LOOP AT gt_coep INTO wa_coep WHERE objnr = wa_vbap_new1-objnr        " MOD-006
                                   AND beltp = '2'.
*     Get actual values
      PERFORM get_act_seed.
    ENDLOOP.
  ENDIF.

  p_act_so = gv_act_so.
  p_act_lc = gv_act_lc.

ENDFORM.                    " CALC_ACTUAL_SEED

*&---------------------------------------------------------------------*
*&      Form  GET_ACT_SEED
*&---------------------------------------------------------------------*
*       Get Actual Values Cost / Revenue (SEED countries)
*----------------------------------------------------------------------*
FORM get_act_seed .

* SO Currency
* Begin of MOD-005.
*  IF gt_coep-twaer = gt_vbap-waerk.
*   Transaction Currency = SO Currency
*  IF gt_coep-owaer = gt_vbap-waerk.         " Comment by MOD-006
  IF wa_coep-owaer = wa_vbap_new1-waerk.          " MOD-006
*    Object Currency = SO Currency.
* End of Mod-005.
*    gv_act_so = gv_act_so + gt_coep-wogbtr.  " Comment by MOD-006
    gv_act_so = gv_act_so + wa_coep-wogbtr.   " MOD-006
*** MOD-002 * begin ***
*  Begin of MOD-006
*    IF gt_coep-beltp = '2'    AND
*       gt_coep-awtyp = 'VBRR'.
*      gv_act_rr_so = gv_act_rr_so + gt_coep-wogbtr.
*    ENDIF.
    IF wa_coep-beltp = '2'    AND
       wa_coep-awtyp = 'VBRR'.
      gv_act_rr_so = gv_act_rr_so + wa_coep-wogbtr.
    ENDIF.
*  End of MOD-006
*** MOD-002 * end ***
  ELSE.
*   Convert to SO Currency (via intermediate currency)
    CLEAR gv_act_cc.
*    begin of mod-005
*    Begin of Mod-006
*    IF ( ( gt_coep-owaer = gt_coep-twaer AND gt_vbap-waerk = 'EUR' ) OR ( gt_coep-beltp = '2' AND gt_vbap-waerk = 'EUR' ) ).
*      gv_act_cc = gt_coep-wkgbtr.
*    ELSE.
*      PERFORM convert_amount_int USING gt_coep-wogbtr
*                                       gt_coep-owaer
*                                       gv_act_cc
*                                       gt_vbap-waerk.
*
*    ENDIF.
    IF ( ( wa_coep-owaer = wa_coep-twaer AND wa_vbap_new1-waerk = 'EUR' ) OR ( wa_coep-beltp = '2' AND wa_vbap_new1-waerk = 'EUR' ) ).
      gv_act_cc = wa_coep-wkgbtr.
    ELSE.
      PERFORM convert_amount_int USING wa_coep-wogbtr
                                       wa_coep-owaer
                                       gv_act_cc
                                       wa_vbap_new1-waerk.

    ENDIF.
*    End of MOD-006
*    ENDIF.
    gv_act_so = gv_act_so + gv_act_cc.
*** MOD-002 * begin ***
*    Begin of MOD-006
*    IF gt_coep-beltp = '2'    AND
*       gt_coep-awtyp = 'VBRR'.
*      gv_act_rr_so = gv_act_rr_so + gv_act_cc.
*    ENDIF.
    IF wa_coep-beltp = '2'    AND
       wa_coep-awtyp = 'VBRR'.
      gv_act_rr_so = gv_act_rr_so + gv_act_cc.
    ENDIF.
*   End of MOD-006
*** MOD-002 * end ***
  ENDIF.

* Local Currency
* Begin of MOD-006
*  gv_act_lc = gv_act_lc + gt_coep-wogbtr.
**** MOD-002 * begin ***
*  IF gt_coep-beltp = '2'    AND
*     gt_coep-awtyp = 'VBRR'.
*    gv_act_rr_lc = gv_act_rr_lc + gt_coep-wogbtr.
*  ENDIF.
  gv_act_lc = gv_act_lc + wa_coep-wogbtr.
*** MOD-002 * begin ***
  IF wa_coep-beltp = '2'    AND
     wa_coep-awtyp = 'VBRR'.
    gv_act_rr_lc = gv_act_rr_lc + wa_coep-wogbtr.
  ENDIF.
* End of MOD-006
*** MOD-002 * end ***

ENDFORM.                    " GET_ACT_SEED

*&---------------------------------------------------------------------*
*&      Form  POSTINGS_SEED
*&---------------------------------------------------------------------*
*       Postings (SEED countries)
*----------------------------------------------------------------------*
FORM postings_seed .

*** MOD-003 * begin ***
  PERFORM get_accounts.
*** MOD-003 * end ***

  IF gt_seed[] IS NOT INITIAL. "mod-004
* Open accounts
    gv_xintb = ' '.
    PERFORM update_accounts.
  ENDIF. "mod-004
* Process
  CLEAR ind1.                                                        " MOD-006
*  LOOP AT gt_seed.
*  LOOP AT gt_seed WHERE flag = 'X'. " MOD-005          " Commented by MOD-006
  LOOP AT gt_seed INTO wa_seed WHERE flag = 'X'.                     " MOD-006
    ind1 = sy-tabix.                                                 " MOD-006
*   Prepare transaction FB01
    PERFORM prepare_fb01_seed.

*   Post (via transaction FB01)
    PERFORM call_fb01_seed.

  ENDLOOP.

  IF gt_seed[] IS NOT INITIAL. "mod-004
* Close accounts
    gv_xintb = 'X'.
    PERFORM update_accounts.
  ENDIF. "mod-004

ENDFORM.                    " POSTINGS_SEED

*&---------------------------------------------------------------------*
*&      Form  GET_ACCOUNTS                                  "MOD-003
*&---------------------------------------------------------------------*
*       Get account data for postings
*----------------------------------------------------------------------*
FORM get_accounts .

  IF gt_seed[] IS NOT INITIAL. "mod-004
* Get customer account assignment groups
    SELECT kunnr vkorg vtweg spart ktgrd
           INTO TABLE gt_knvvi
           FROM knvv
           FOR ALL ENTRIES IN gt_seed
           WHERE kunnr = gt_seed-kunnr
             AND vkorg = gt_seed-vkorg
             AND vtweg = gt_seed-vtweg
             AND spart = gt_seed-spart.
*             AND KTGRD <> 'Z1'.               " MOD-005.
    SORT gt_knvvi BY kunnr vkorg vtweg spart.
    DELETE ADJACENT DUPLICATES FROM gt_knvvi
           COMPARING kunnr vkorg vtweg spart.
    gt_knvv[] = gt_knvvi[].
    FREE gt_knvvi.
  ENDIF. "mod-004

  IF gt_knvv[] IS NOT INITIAL. " mod-004
* Get reposting accounts
    SELECT vkorg ktgrd ktgrm sakn1
           INTO TABLE gt_c001i
           FROM c001
           FOR ALL ENTRIES IN gt_knvv
           WHERE kappl  = 'V '
             AND kschl IN ('KOFI', 'KOFK')
             AND ktopl  = 'SCOA'
             AND vkorg  = gt_knvv-vkorg
             AND ktgrd  = gt_knvv-ktgrd
             AND ktgrm  = gt_knvv-vtweg
             AND kvsl1  = 'ERL'.
    SORT gt_c001i BY vkorg ktgrd ktgrm.
    DELETE ADJACENT DUPLICATES FROM gt_c001i
           COMPARING vkorg ktgrd ktgrm.
    gt_c001[] = gt_c001i[].
    FREE gt_c001i.
  ENDIF. "mod-004

  IF gt_c001[] IS NOT INITIAL. " mod-004
* Get functional areas for the reposting accounts
    SELECT saknr func_area
           INTO TABLE gt_ska1i
           FROM ska1
           FOR ALL ENTRIES IN gt_c001
           WHERE ktopl  = 'SCOA'
             AND saknr  = gt_c001-sakn1.
    SORT gt_ska1i BY saknr.
    DELETE ADJACENT DUPLICATES FROM gt_ska1i
           COMPARING saknr.
    gt_ska1[] = gt_ska1i[].
    FREE gt_ska1i.
  ENDIF. "mod-004

ENDFORM.                    " GET_ACCOUNTS

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ACCOUNTS
*&---------------------------------------------------------------------*
*       Update accounts (Open / Close)
*----------------------------------------------------------------------*
FORM update_accounts .

  gv_hkont = p_acc1.
  PERFORM call_fss0.

  gv_hkont = p_acc2.
  PERFORM call_fss0.

*** MOD-003 * begin ***
*  gv_hkont = p_acc3.
*  PERFORM call_fss0.
*  LOOP AT gt_ska1.                           " Commented by MOD-006
  LOOP AT gt_ska1 INTO wa_ska1.               " MOD-006
*    gv_hkont = gt_ska1-saknr.                 " Commented by MOD-006
    gv_hkont = wa_ska1-saknr.
    PERFORM call_fss0.
  ENDLOOP.
*** MOD-003 * end ***

ENDFORM.                    " UPDATE_ACCOUNTS

*&---------------------------------------------------------------------*
*&      Form  CALL_FSS0
*&---------------------------------------------------------------------*
*       Prepare & Call transaction FSS0
*----------------------------------------------------------------------*
FORM call_fss0 .

  REFRESH: i_bdcdata, gt_err.

  PERFORM bdc_dynpro      USING 'SAPLGL_ACCOUNT_MASTER_MAINTAIN' '2001'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=ACC_MOD'.
  PERFORM bdc_field       USING 'GLACCOUNT_SCREEN_KEY-SAKNR' gv_hkont.
  PERFORM bdc_field       USING 'GLACCOUNT_SCREEN_KEY-BUKRS' p_bukrs.

  PERFORM bdc_dynpro      USING 'SAPLGL_ACCOUNT_MASTER_MAINTAIN' '2001'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=TAB02'.

  PERFORM bdc_dynpro      USING 'SAPLGL_ACCOUNT_MASTER_MAINTAIN' '2001'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=SAVE'.
  PERFORM bdc_field       USING 'GLACCOUNT_SCREEN_CCODE-XINTB' gv_xintb.

  CALL TRANSACTION 'FSS0' USING i_bdcdata
                          MODE gv_mode
                          UPDATE 'S'
                          MESSAGES INTO gt_err.

* Check for errors
*Begin of MOD-006
*  LOOP AT gt_err WHERE msgtyp = 'E'
*                    OR msgtyp = 'A'.
*    CALL FUNCTION 'RH_MESSAGE_GET'
*      EXPORTING
**        SPRSL                   = SY-LANGU
*        arbgb                   = gt_err-msgid
*        msgnr                   = gt_err-msgnr
*        msgv1                   = gt_err-msgv1
*        msgv2                   = gt_err-msgv2
*        msgv3                   = gt_err-msgv3
*        msgv4                   = gt_err-msgv4
*      IMPORTING
*        msgtext                 = gv_msgtxt
*      EXCEPTIONS
*        message_not_found       = 1
*        OTHERS                  = 2.
  LOOP AT gt_err INTO wa_err  WHERE msgtyp = 'E'
                              OR msgtyp = 'A'.
    CALL FUNCTION 'RH_MESSAGE_GET'
      EXPORTING
*        SPRSL                   = SY-LANGU
        arbgb                   = wa_err-msgid
        msgnr                   = wa_err-msgnr
        msgv1                   = wa_err-msgv1
        msgv2                   = wa_err-msgv2
        msgv3                   = wa_err-msgv3
        msgv4                   = wa_err-msgv4
      IMPORTING
        msgtext                 = gv_msgtxt
      EXCEPTIONS
        message_not_found       = 1
        OTHERS                  = 2.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      WRITE: / gv_msgtxt.
    ENDIF.
*    WRITE: / gv_msgtxt.
* End of MOD-006
  ENDLOOP.

ENDFORM.                    " CALL_FSS0

*&---------------------------------------------------------------------*
*&      Form  PREPARE_FB01_SEED
*&---------------------------------------------------------------------*
*       Prepare transaction FB01 (SEED countries)
*----------------------------------------------------------------------*
FORM prepare_fb01_seed .

  DATA: lv_date_p(10)   TYPE c,
        lv_date_d(10)   TYPE c,
        lv_wrbtr_so(16) TYPE c,
*        lv_wrbtr_lc(16) TYPE c,            " Commented by MOD-006
        lv_zuonr        TYPE dzuonr.



  REFRESH: i_bdcdata, gt_err.
  WRITE p_budat       TO lv_date_p.
  WRITE sy-datum TO lv_date_d.

  WRITE wa_seed-diff_rr_so TO lv_wrbtr_so
                              CURRENCY wa_seed-waerk NO-SIGN.
*  WRITE gt_seed-diff_rr_lc TO lv_wrbtr_lc
*                              CURRENCY gt_seed-waers_cc NO-SIGN.
  CONCATENATE wa_seed-vbeln wa_seed-posnr INTO lv_zuonr.

*** MOD-003 * begin ***
  gv_saknr = wa_seed-saknr.
  CLEAR gv_fkber.
* Account number & functional area
  IF gv_saknr IS INITIAL.
    PERFORM get_account_data.
  ENDIF.
*** MOD-003 * end ***

* Header
  PERFORM bdc_dynpro      USING 'SAPMF05A' '0100'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '/00'.
  PERFORM bdc_field       USING 'BKPF-BLDAT' lv_date_d.
  PERFORM bdc_field       USING 'BKPF-BLART' gc_sa.
  PERFORM bdc_field       USING 'BKPF-BUKRS' p_bukrs.
  PERFORM bdc_field       USING 'BKPF-BUDAT' lv_date_p.
  PERFORM bdc_field       USING 'BKPF-WAERS' wa_seed-waerk.
*** MOD-002 * begin ***
*  PERFORM bdc_field       USING 'BKPF-XBLNR' gc_poc.
  PERFORM bdc_field       USING 'BKPF-XBLNR' wa_seed-xblnr.
*** MOD-002 * end ***

* Posting key
*** MOD-002 * begin ***
*  IF gt_seed-act_rev_so LE 0.
*    IF gt_seed-rr_poc_so LE 0.
*      IF ABS( gt_seed-act_rev_so ) > ABS( gt_seed-rr_poc_so ).
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '40'.
*      ELSE.
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '50'.
*      ENDIF.
*    ELSE.
*      PERFORM bdc_field     USING 'RF05A-NEWBS' '40'.
*    ENDIF.
*  ELSE.
*    IF gt_seed-rr_poc_so > 0.
*      IF ABS( gt_seed-act_rev_so ) > ABS( gt_seed-rr_poc_so ).
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '50'.
*      ELSE.
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '40'.
*      ENDIF.
*    ELSE.
*      PERFORM bdc_field     USING 'RF05A-NEWBS' '50'.
*    ENDIF.
*  ENDIF.
  PERFORM bdc_field     USING 'RF05A-NEWBS' wa_seed-bschl1.
*** MOD-002 * end ***
*** MOD-003 * begin ***
*  PERFORM bdc_field       USING 'RF05A-NEWKO' p_acc3.

  PERFORM bdc_field       USING 'RF05A-NEWKO' gv_saknr.
*** MOD-003 * end ***

  IF wa_seed-diff_rr_so IS NOT INITIAL.
* Item 1
    PERFORM bdc_dynpro      USING 'SAPMF05A' '0300'.
    PERFORM bdc_field       USING 'BDC_OKCODE' '=ZK'.
    PERFORM bdc_field       USING 'BSEG-WRBTR' lv_wrbtr_so.
*    IF gt_seed-waerk NE gt_seed-waers_cc.
*      PERFORM bdc_field     USING 'BSEG-DMBTR' lv_wrbtr_lc.
*    ENDIF.
    PERFORM bdc_field       USING 'BSEG-MWSKZ' wa_seed-mwskz.
    PERFORM bdc_field       USING 'BSEG-ZUONR' lv_zuonr.
    PERFORM bdc_field       USING 'DKACB-FMORE' 'X'.

* Item 1: more date
    PERFORM bdc_dynpro      USING 'SAPLKACB' '0002'.
    PERFORM bdc_field       USING 'BDC_OKCODE' 'ENTE'.
    PERFORM bdc_field       USING 'COBL-PRCTR'   wa_seed-prctr.
    PERFORM bdc_field       USING 'COBL-SEGMENT' wa_seed-segment.
*** MOD-003 * begin ***
    PERFORM bdc_field       USING 'COBL-FKBER'   gv_fkber.
*** MOD-003 * end ***
    PERFORM bdc_field       USING 'COBL-KDAUF'   wa_seed-vbeln.
    PERFORM bdc_field       USING 'COBL-KDPOS'   wa_seed-posnr.
  ENDIF.

*  CLEAR: lv_wrbtr_so, lv_wrbtr_lc.   " Commented by MOD-006
*  CLEAR: lv_wrbtr_so.                " MOD-006
  IF wa_seed-diff_rr_so1 IS INITIAL AND wa_seed-wrbtr_new IS INITIAL.
    wa_seed-diff_rr_so1 = wa_seed-diff_rr_so.
  ENDIF.
  WRITE wa_seed-diff_rr_so1 TO lv_wrbtr_so
                              CURRENCY wa_seed-waerk NO-SIGN.
*  WRITE gt_seed-diff_rr_lc1 TO lv_wrbtr_lc
*                              CURRENCY gt_seed-waers_cc NO-SIGN.
  IF wa_seed-diff_rr_so1 IS NOT INITIAL.

* Item 2
    PERFORM bdc_dynpro      USING 'SAPMF05A' '0330'.
    PERFORM bdc_field       USING 'BDC_OKCODE' '/00'.

* Posting key
*** MOD-002 * begin ***
*  IF gt_seed-act_rev_so LE 0.
*    IF gt_seed-rr_poc_so LE 0.
*      IF ABS( gt_seed-act_rev_so ) > ABS( gt_seed-rr_poc_so ).
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '50'.
*      ELSE.
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '40'.
*      ENDIF.
*    ELSE.
*      PERFORM bdc_field     USING 'RF05A-NEWBS' '50'.
*    ENDIF.
*  ELSE.
*    IF gt_seed-rr_poc_so > 0.
*      IF ABS( gt_seed-act_rev_so ) > ABS( gt_seed-rr_poc_so ).
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '40'.
*      ELSE.
*        PERFORM bdc_field     USING 'RF05A-NEWBS' '50'.
*      ENDIF.
*    ELSE.
*      PERFORM bdc_field     USING 'RF05A-NEWBS' '40'.
*    ENDIF.
*  ENDIF.
    PERFORM bdc_field     USING 'RF05A-NEWBS' wa_seed-bschl_flag.
*** MOD-002 * end ***
    PERFORM bdc_field       USING 'RF05A-NEWKO' wa_seed-hkont.

    PERFORM bdc_dynpro      USING 'SAPMF05A' '0300'.
    PERFORM bdc_field       USING 'BDC_OKCODE' '=ZK'.
    PERFORM bdc_field       USING 'BSEG-WRBTR' lv_wrbtr_so.
*    IF gt_seed-waerk NE gt_seed-waers_cc.
*      PERFORM bdc_field     USING 'BSEG-DMBTR' lv_wrbtr_lc.
*    ENDIF.
    PERFORM bdc_field       USING 'BSEG-ZUONR' lv_zuonr.
    PERFORM bdc_field       USING 'DKACB-FMORE' 'X'.

* Item 2: more date
    PERFORM bdc_dynpro      USING 'SAPLKACB' '0002'.
    PERFORM bdc_field       USING 'BDC_OKCODE' 'ENTE'.
    PERFORM bdc_field       USING 'COBL-PRCTR'   wa_seed-prctr.
    PERFORM bdc_field       USING 'COBL-SEGMENT' wa_seed-segment.
    PERFORM bdc_field       USING 'COBL-KDAUF'   wa_seed-vbeln.
    PERFORM bdc_field       USING 'COBL-KDPOS'   wa_seed-posnr.
  ENDIF.
* Begin of MOD-005.
*  if gt_seed-waerk_new is not INITIAL and gt_seed-wrbtr_new is not INITIAL.
  IF wa_seed-bschl_new NE ''.
*    CLEAR: lv_wrbtr_so, lv_wrbtr_lc.      " Commented by MOD-006
    CLEAR: lv_wrbtr_so.                    " MOD-006
    WRITE wa_seed-wrbtr_new TO lv_wrbtr_so
                                CURRENCY wa_seed-waerk NO-SIGN.
*    WRITE gt_seed-waerk_new TO lv_wrbtr_lc
*                                CURRENCY gt_seed-waers_cc NO-SIGN.
    IF wa_seed-wrbtr_new IS NOT INITIAL.
* Item 3
      PERFORM bdc_dynpro      USING 'SAPMF05A' '0330'.
      PERFORM bdc_field       USING 'BDC_OKCODE' '/00'.
      PERFORM bdc_field     USING 'RF05A-NEWBS' wa_seed-bschl_new.
      PERFORM bdc_field       USING 'RF05A-NEWKO' wa_seed-hkont_new.

      PERFORM bdc_dynpro      USING 'SAPMF05A' '0300'.
      PERFORM bdc_field       USING 'BDC_OKCODE' '=ZK'.
      PERFORM bdc_field       USING 'BSEG-WRBTR' lv_wrbtr_so.
*      IF gt_seed-waerk NE gt_seed-waers_cc.
*        PERFORM bdc_field       USING 'BSEG-DMBTR' lv_wrbtr_lc.
*      endif.
      PERFORM bdc_field       USING 'BSEG-ZUONR' lv_zuonr.
      PERFORM bdc_field       USING 'DKACB-FMORE' 'X'.

* Item 3: more date
      PERFORM bdc_dynpro      USING 'SAPLKACB' '0002'.
      PERFORM bdc_field       USING 'BDC_OKCODE' 'ENTE'.
      PERFORM bdc_field       USING 'COBL-PRCTR'   wa_seed-prctr.
      PERFORM bdc_field       USING 'COBL-SEGMENT' wa_seed-segment.
      PERFORM bdc_field       USING 'COBL-KDAUF'   wa_seed-vbeln.
      PERFORM bdc_field       USING 'COBL-KDPOS'   wa_seed-posnr.
    ENDIF.
  ENDIF.
* End of MOD-005.
* Save
  PERFORM bdc_dynpro      USING 'SAPMF05A' '0330'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=BU'.

ENDFORM.                    " PREPARE_FB01_SEED

*&---------------------------------------------------------------------*
*&      Form  GET_ACCOUNT_DATA                              "MOD-003
*&---------------------------------------------------------------------*
*       Get account data: number & functional area
*----------------------------------------------------------------------*
FORM get_account_data .

* Get the customer account assignment group
  CLEAR gv_ktgrd.
  CLEAR wa_knvv.                                                                    " MOD-006
*  READ TABLE gt_knvv WITH TABLE KEY kunnr = wa_seed-kunnr                          " Commented by MOD-006
  READ TABLE gt_knvv INTO wa_knvv WITH TABLE KEY kunnr = wa_seed-kunnr              " MOD-006
                                                 vkorg = wa_seed-vkorg
                                                 vtweg = wa_seed-vtweg
                                                 spart = wa_seed-spart.
  IF sy-subrc = 0.
*    gv_ktgrd = gt_knvv-ktgrd.                                                       " Commented by MOD-006
    gv_ktgrd = wa_knvv-ktgrd.                                                        " MOD-006
  ENDIF.

* Get the account
  CLEAR gv_saknr.
*  READ TABLE gt_c001 WITH TABLE KEY vkorg = wa_seed-vkorg                           " Commented by MOD-006
  READ TABLE gt_c001 INTO wa_c001 WITH TABLE KEY vkorg = wa_seed-vkorg               " MOD-005
                                                 ktgrd = gv_ktgrd
                                                 ktgrm = wa_seed-vtweg.
  IF sy-subrc = 0.
*    gv_saknr = gt_c001-sakn1.                                                       " Commented by MOD-006
    gv_saknr = wa_c001-sakn1.                                                        " MOD-006
  ENDIF.

* Get the functional area
  CLEAR gv_fkber.
  CLEAR wa_ska1.                                                                    " MOD-006
*  READ TABLE gt_ska1 WITH TABLE KEY saknr = gv_saknr.                               " Commented by MOD-006
  READ TABLE gt_ska1 INTO wa_ska1 WITH TABLE KEY saknr = gv_saknr.                   " MOD-06
  IF sy-subrc = 0.
*    gv_fkber = gt_ska1-func_area.                                                   " Commented by MOD-006
    gv_fkber = wa_ska1-func_area.                                                    " MOD-006
  ENDIF.

ENDFORM.                    " GET_ACCOUNT_DATA

*----------------------------------------------------------------------*
*        Start new screen                                              *
*----------------------------------------------------------------------*
FORM bdc_dynpro USING program dynpro.
* Begin of MOD-006
*  CLEAR i_bdcdata.
*  i_bdcdata-program  = program.
*  i_bdcdata-dynpro   = dynpro.
*  i_bdcdata-dynbegin = 'X'.
*  APPEND i_bdcdata.
  CLEAR struct_bdcdata.
  struct_bdcdata-program  = program.
  struct_bdcdata-dynpro   = dynpro.
  struct_bdcdata-dynbegin = 'X'.
  APPEND struct_bdcdata TO i_bdcdata.
* End of MOD-006
ENDFORM.                    "BDC_DYNPRO

*----------------------------------------------------------------------*
*        Insert field                                                  *
*----------------------------------------------------------------------*
FORM bdc_field USING fnam fval.
* Begin of MOD-006
*  CLEAR i_bdcdata.
*  i_bdcdata-fnam = fnam.
*  i_bdcdata-fval = fval.
*  APPEND i_bdcdata.
  CLEAR struct_bdcdata.
  struct_bdcdata-fnam = fnam.
  struct_bdcdata-fval = fval.
  APPEND struct_bdcdata TO i_bdcdata.
* End of MOD-006
ENDFORM.                    "bdc_field

*&---------------------------------------------------------------------*
*&      Form  CALL_FB01_SEED
*&---------------------------------------------------------------------*
*       Post (via transaction FB01)
*----------------------------------------------------------------------*
FORM call_fb01_seed .

  CALL TRANSACTION 'FB01' USING i_bdcdata
                          MODE gv_mode
                          UPDATE 'S'
                          MESSAGES INTO gt_err.

* Check for errors
*Begin of MOD-006
*  LOOP AT gt_err WHERE msgtyp = 'E'
*                    OR msgtyp = 'A'.
*    CALL FUNCTION 'RH_MESSAGE_GET'
*      EXPORTING
**        SPRSL                   = SY-LANGU
*        arbgb                   = gt_err-msgid
*        msgnr                   = gt_err-msgnr
*        msgv1                   = gt_err-msgv1
*        msgv2                   = gt_err-msgv2
*        msgv3                   = gt_err-msgv3
*        msgv4                   = gt_err-msgv4
*      IMPORTING
*        msgtext                 = gv_msgtxt
*      EXCEPTIONS
*        message_not_found       = 1
*        OTHERS                  = 2.
  LOOP AT gt_err INTO wa_err WHERE msgtyp = 'E'
                             OR msgtyp = 'A'.
    CALL FUNCTION 'RH_MESSAGE_GET'
      EXPORTING
*        SPRSL                   = SY-LANGU
        arbgb                   = wa_err-msgid
        msgnr                   = wa_err-msgnr
        msgv1                   = wa_err-msgv1
        msgv2                   = wa_err-msgv2
        msgv3                   = wa_err-msgv3
        msgv4                   = wa_err-msgv4
      IMPORTING
        msgtext                 = gv_msgtxt
      EXCEPTIONS
        message_not_found       = 1
        OTHERS                  = 2.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      WRITE: / gv_msgtxt.
    ENDIF.
*    WRITE: / gv_msgtxt.
* End of MOD-006
  ENDLOOP.

* No errors
  IF sy-subrc NE 0.
*   Get document number & year
    GET PARAMETER ID 'BLN' FIELD wa_seed-belnr_n.
    GET PARAMETER ID 'GJR' FIELD wa_seed-gjahr_n.
*    MODIFY gt_seed.                                      " Commented by MOD-006
    MODIFY gt_seed FROM wa_seed INDEX ind1 TRANSPORTING belnr_n gjahr_n.           " MOD-006
  ELSE.
    CLEAR: wa_seed-belnr_n, wa_seed-gjahr_n.              " MOD-006
    MODIFY gt_seed FROM wa_seed INDEX ind1 TRANSPORTING belnr_n gjahr_n.           " MOD-006
  ENDIF.

ENDFORM.                    " CALL_FB01_SEED

*&---------------------------------------------------------------------*
*&      Form  LIST_DATA_SEED
*&---------------------------------------------------------------------*
*       List data (SEED countries)
*----------------------------------------------------------------------*
FORM list_data_seed .

  CLEAR gv_errlst.
  NEW-PAGE.
* begin of mod-005.
*  IF gt_seed[] IS INITIAL.
*    WRITE: /01 'No differences calculated (to be posted)'(i01).
*    ULINE.
*    RETURN.
*  ENDIF.

*  LOOP AT gt_seed.
*  LOOP AT gt_seed WHERE flag = 'X'.                           " Commented by MOD-006
  LOOP AT gt_seed INTO wa_seed WHERE flag = 'X'.              " MOD-006
    WRITE: /01     wa_seed-vbeln,
            12     wa_seed-posnr,
            20(15) wa_seed-pl_cost_so  CURRENCY wa_seed-waerk,
            36(15) wa_seed-pl_cost_lc  CURRENCY wa_seed-waers_cc,
            52(15) wa_seed-pl_rev_so   CURRENCY wa_seed-waerk,
            68(15) wa_seed-pl_rev_lc   CURRENCY wa_seed-waers_cc,
            84(15) wa_seed-act_cost_so CURRENCY wa_seed-waerk,
           100(15) wa_seed-act_cost_lc CURRENCY wa_seed-waers_cc,
           116(15) wa_seed-act_rev_so  CURRENCY wa_seed-waerk,
           132(15) wa_seed-act_rev_lc  CURRENCY wa_seed-waers_cc,
           148(15) wa_seed-rr_poc_so   CURRENCY wa_seed-waerk,
           164(15) wa_seed-rr_poc_lc   CURRENCY wa_seed-waers_cc,
           180(15) wa_seed-diff_rr_so  CURRENCY wa_seed-waerk,
           196(15) wa_seed-diff_rr_lc  CURRENCY wa_seed-waers_cc,
           213     wa_seed-waerk,           "SO curr.
           219     wa_seed-waers_cc,        "Local curr.
           225     wa_seed-waers,           "Doc. curr.
           232     wa_seed-belnr,
           245     wa_seed-gjahr,
           251     wa_seed-hkont,
           263     wa_seed-prctr,
           275     wa_seed-segment,
           287     wa_seed-bldat,
           299     wa_seed-mwskz,
           304     wa_seed-belnr_n,
           317     wa_seed-gjahr_n,
           323     wa_seed-kunnr,
           334     wa_seed-name1_ag,
           366     wa_seed-vkorg,
           372     wa_seed-vtweg,
           376     wa_seed-spart,
           380     wa_seed-vkbur,
           386     wa_seed-land1_we,
           393     wa_seed-matnr,
           413     wa_seed-prctr_c,
           425     wa_seed-prodh,
*** MOD-002 * begin ***
           445(10) wa_seed-xblnr,
           458     wa_seed-stext,
*** MOD-002 * end ***
*  Begin of MOD-006.
          470      wa_seed-netwr  CURRENCY wa_seed-waerk.
*  End of MOD-006.
  ENDLOOP.
*  if sy-subrc ne 0.
**    IF gt_seed[] IS INITIAL.
*    WRITE: /01 'No differences calculated (to be posted)'(i01).
*    ULINE.
*    RETURN.
**  ENDIF.
*  endif.
* end of mod-005.
  ULINE.

ENDFORM.                    " LIST_DATA_SEED
*&---------------------------------------------------------------------*
*&      Form  G/L_ACCOUNT_CONDITION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM gl_account_condition .
  DATA: lv_netwr TYPE netwr,
        flag1 TYPE vbeln,
        flag2 TYPE posnr,
        lv_p TYPE i,        " MOD-006 " The variable name is given with naming convension from P to lv_p
        lv_q TYPE i.        " MOD-006
  DATA: gt_vbrp1 TYPE STANDARD TABLE OF ty_vbrp.

*  refresh gt_lips.
*  select
*    VBELN
*    POSNR
*    MATNR
*    VGBEL
*    VGPOS
*    from lips
*    into table gt_lips
*    for ALL ENTRIES IN gt_vbap
*    where vbelv = gt_vbap-vbeln
*    and   posnv = gt_vbap-posnr
*    and   matnr = gt_vbap-matnr.

  REFRESH gt_vbrp1.
  SELECT
   vbelv
   posnv
   vbeln
   posnn
   vbtyp_n
   vbtyp_v
   FROM vbfa
   INTO TABLE gt_vbfa
   FOR ALL ENTRIES IN gt_vbap
   WHERE vbelv = gt_vbap-vbeln
   AND posnv = gt_vbap-posnr
   AND vbtyp_v = 'G'.

  IF gt_vbfa[] IS NOT INITIAL.
    SELECT
      vbeln
      posnr
      netwr
      aubel
      aupos
      matnr
      shkzg
      FROM vbrp
      INTO TABLE gt_vbrp
      FOR ALL ENTRIES IN gt_vbfa
      WHERE vbeln = gt_vbfa-vbeln
      AND posnr = gt_vbfa-posnn.
  ENDIF.
  SORT gt_vbrp BY vgbel vgpos.
*  clear: flag1, flag2,wa_vbrp,P.                     " Commented by MOD-006
  CLEAR: flag1, flag2,wa_vbrp,lv_p.                   " MOD-006 " variable name has been changed from P to lv_P
  LOOP AT gt_vbrp INTO wa_vbrp.
    IF flag1 NE wa_vbrp-vgbel.
      flag1 = wa_vbrp-vgbel.
      CLEAR: lv_netwr, wa_vbrp,flag2.
      LOOP AT gt_vbrp INTO wa_vbrp WHERE vgbel = flag1.
        IF flag2 NE wa_vbrp-vgpos.
          CLEAR lv_netwr.
          flag2     = wa_vbrp-vgpos.
*          p = p + 1.                                 " Commented by MOD-006
          lv_p = lv_p + 1.                            " MOD-006
*  Begin of MOD-006.
*          lv_netwr  = wa_vbrp-netwr.
          IF wa_vbrp-shkzg = 'X'.
            lv_netwr = lv_netwr - wa_vbrp-netwr.
          ELSE.
            lv_netwr = lv_netwr + wa_vbrp-netwr.
          ENDIF.
          wa_vbrp-netwr = lv_netwr.
*  End of MOD-006.
          APPEND wa_vbrp TO gt_vbrp1.
        ELSE.
          IF wa_vbrp-shkzg = 'X'.
            lv_netwr = lv_netwr - wa_vbrp-netwr.
          ELSE.
            lv_netwr = lv_netwr + wa_vbrp-netwr.
          ENDIF.
          wa_vbrp-netwr = lv_netwr.
*          modify gt_vbrp1 from wa_vbrp index p TRANSPORTING netwr.     " Commented by MOD-006
          MODIFY gt_vbrp1 FROM wa_vbrp                                 " MOD-006
                          INDEX lv_p
                          TRANSPORTING netwr.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDLOOP.

*  Begin of MOD-005.
*  refresh gt_vbrp.
*  gt_vbrp[] = gt_vbrp1[].
  CLEAR wa_vbfa.
  SORT gt_vbrp1 BY vbeln posnr  .
  LOOP AT gt_vbfa INTO wa_vbfa WHERE vbtyp_n = 'O' OR vbtyp_n = 'P'.
    CLEAR: wa_vbrp.
    READ TABLE gt_vbrp1 INTO wa_vbrp
                        WITH KEY vbeln = wa_vbfa-vbeln
                                 posnr = wa_vbfa-posnn
                        BINARY SEARCH.
    IF sy-subrc = 0.
      IF wa_vbrp-shkzg EQ 'X'.
        wa_vbrp-netwr = wa_vbrp-netwr * -1.
      ENDIF.
      wa_vbrp-vbeln = ''.
      wa_vbrp-posnr = ''.
      wa_vbrp-vgbel = wa_vbfa-vbelv.
      wa_vbrp-vgpos = wa_vbfa-posnv.
      wa_vbrp-matnr = ''.
      wa_vbrp-shkzg = ''.
      COLLECT wa_vbrp INTO gt_vbrp2.
    ENDIF.
  ENDLOOP.
  CLEAR: lv_q, wa_vbrp1.
  SORT gt_vbrp2 BY vgbel vgpos.
  LOOP AT gt_vbrp1 INTO wa_vbrp1.
    lv_q = sy-tabix.
    CLEAR wa_vbrp.
    READ TABLE gt_vbrp2 INTO wa_vbrp
                        WITH KEY vgbel = wa_vbrp1-vgbel
                                 vgpos = wa_vbrp1-vgpos
                        BINARY SEARCH.
    IF sy-subrc = 0.
      wa_vbrp1-netwr = wa_vbrp1-netwr - wa_vbrp-netwr.
      MODIFY gt_vbrp1 FROM wa_vbrp1
                      INDEX lv_q
                      TRANSPORTING netwr.
    ENDIF.
  ENDLOOP.
  REFRESH gt_vbrp.
  gt_vbrp[] = gt_vbrp1[].
  REFRESH gt_vbrp1.
*  End of MOD-005.

ENDFORM.                    " GL_ACCOUNT_CONDITION
*&---------------------------------------------------------------------*
*&      Form  REVERSAL_GL_ACCOUNT_LOGIC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_ACC1  text
*      <--P_GT_SEED  text
*----------------------------------------------------------------------*
FORM reversal_gl_account_logic  USING    p_p_acc.

  DATA: lv_dmbtr TYPE dmbtr,
        lv_wrbtr TYPE wrbtr,
        flag3 TYPE dzuonr,
        ref1 TYPE xblnr1,
        q TYPE i,
        gt_bsis_new3 TYPE STANDARD TABLE OF ty_bsis_new.
  ref1 =  'RECL.SEGM'.
  REFRESH: gt_bsis_new, gt_bsis_new3.

  SELECT
    bukrs
    hkont
    augdt
    augbl
    zuonr
    gjahr
    belnr
    buzei
    xblnr
    bschl
    dmbtr
    wrbtr
    FROM bsis
    INTO TABLE gt_bsis_new
    WHERE hkont = p_p_acc
    AND bukrs = p_bukrs
    AND zuonr IN r_zuonr
    AND budat LE p_budat
    AND xblnr NE ref1.
  SORT gt_bsis_new BY zuonr.
  CLEAR: wa_bsis_new, q.
  LOOP AT gt_bsis_new INTO wa_bsis_new.
    IF flag3 NE wa_bsis_new-zuonr.
      CLEAR lv_dmbtr.
      flag3 = wa_bsis_new-zuonr.
      q = q + 1.
      IF wa_bsis_new-bschl = '50'.
        lv_dmbtr = wa_bsis_new-dmbtr * -1.
        lv_wrbtr = wa_bsis_new-wrbtr * -1.
      ELSEIF wa_bsis_new-bschl = '40'.
        lv_dmbtr = wa_bsis_new-dmbtr.
        lv_wrbtr = wa_bsis_new-wrbtr.
      ENDIF.
      IF wa_bsis_new-bschl = '40'.
        wa_bsis_new-bschl = '50'.
      ELSEIF wa_bsis_new-bschl = '50'.
        wa_bsis_new-bschl = '40'.
      ENDIF.
      APPEND wa_bsis_new TO gt_bsis_new3.
    ELSE.
      IF wa_bsis_new-bschl = '40'.
        lv_dmbtr = lv_dmbtr + wa_bsis_new-dmbtr.
        lv_wrbtr = lv_wrbtr + wa_bsis_new-wrbtr.
      ELSEIF wa_bsis_new-bschl = '50'.
        lv_dmbtr = lv_dmbtr - wa_bsis_new-dmbtr.
        lv_wrbtr = lv_wrbtr - wa_bsis_new-wrbtr.
      ENDIF.
      wa_bsis_new-dmbtr = lv_dmbtr.
      wa_bsis_new-wrbtr = lv_wrbtr.
      IF lv_dmbtr < 0.
        wa_bsis_new-bschl = '40'.
      ELSE.
        wa_bsis_new-bschl = '50'.
      ENDIF.
      MODIFY gt_bsis_new3 FROM wa_bsis_new INDEX q TRANSPORTING bschl dmbtr wrbtr.
    ENDIF.
  ENDLOOP.
  gt_bsis_new[] = gt_bsis_new3[].
  REFRESH gt_bsis_new3.
ENDFORM.                    " REVERSAL_GL_ACCOUNT_LOGIC

*Text symbol text
*E01:No contracts selected
*E03:Selection on material group not allowed
*I01:No differences calculated (to be posted)
*R01:Date:
*R02:Revenue Recognition vs. Revenue Recognition POC
*R03:Company:
*R04:Errors
*R05:Contract
*R06:Item
*R07:  Plan.Cost(SO)
*R08:  Plan.Cost(LC)
*R09:  Plan.Rev.(SO)
*R10:  Plan.Rev.(LC)
*R11:   Act.Cost(SO)
*R12:   Act.Cost(LC)
*R13:   Rev.Rec.(SO)
*R14:   Rev.Rec.(LC)
*R15:Rev.Rec.POC(SO)
*R16:Rev.Rec.POC(LC)
*R17:Diff.RR-POC(SO)
*R18:Diff.RR-POC(LC)
*R19:S.O.
*R20:Local
*R21:Doc.
*R22:Ref.Doc.nr.
*R23:Year
*R24:Account
*R25:ProfitCtr.
*R26:Segment
*R27:Doc. date
*R28:Tax
*R29:Adj.Doc.nr.
*R30:Year
*R31:Sold-to
*R32:Name
*R33:S.Org
*R34:DC
*R35:Dv
*R36:S.Off
*R37:Cntry
*R38:Material
*R39:ProfitCtr.
*R40:Prod. Hierarchy
*R41:Reference
*R42:Status
*R43:Invoice(SO)

*S01:Selection
*Selection text
*P_ACC1:        Account 1
*P_ACC2:        Account 2
*P_BLART:        Document Type
*P_BUDAT:        Posting Date
*P_BUKRS:        Company Code
*P_TEST:        Test run
*SO_MATKL:        Material Group
*SO_VBELN:        Sales Document
