*----------------------------------------------------------------------
* PROGRAM ID           : YSE_SERVICE_CONTRACT_BTCI                     *
* PROGRAM TITLE        : DATA UPLOAD PROGRAM FOR SERVICE CONTRACTS     *
* AUTHOR               : LUC MERTENS                                   *
* DATE                 : 30/07/2007                                    *
* DEVELOPMENT ID       :                                               *
* CHANGE REQUEST NUMBER: CD1K918390                                    *
* PROGRAM DESCRIPTION  : THIS IS A DATA CONVERSION PROGRAM TO UPLOAD   *
*                        SERVICE CONTRACTS FOR SEED.                   *
*                        1. China                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE #
*----------------------------------------------------------------------*
*         |          |                 |          |
************************************************************************

REPORT yse_service_contract_btci
       NO STANDARD PAGE HEADING
       LINE-SIZE 270
       MESSAGE-ID yam_dc.

*---------------------------------------------------------------------*
* TABLE DECLARATION
*---------------------------------------------------------------------*
Tables  /sapdmc/lsmemory.     " DEFAULT VALUES FOR PROJ,SUBPROJ,OBJECT

*---------------------------------------------------------------------*
* TYPE DEFINITIONS
*---------------------------------------------------------------------*
* - DECLARATION FOR STRUCTURE TO READ THE FLAT FILE STRING PER STRING
TYPES: BEGIN OF ty_upload,
         v_text(500)   TYPE c,            " FILE UPLOAD TEXT
       END OF ty_upload.

* - DECLARATION FOR THE CORRESPONDING TARGET FIELDS
TYPES : BEGIN OF ty_final_record,
            reclink_c(020),             " IDENTIFIER
            vkorg      type vkorg,      " sales org.
            vtweg      type vtweg,      " distr. channel
            spart      type spart,      " division
            vkgrp      TYPE vkgrp,      " SALES GROUP
            vkbur      TYPE vkbur,      " SALES OFFICE
            cccntp     TYPE auart,      " SALES DOCUMENT TYPE
            cccust     TYPE kunnr,      " SOLD-TO PARTY
            ccoref     TYPE bstkd,      " CUSTOMER PURCHASE ORDER
            ccsdat     TYPE vbdat_veda, " CONTRACT START DATE
            ccedat     TYPE vndat_veda, " CONTRACT END DATE
            ccscon     TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
            ccsdat1    TYPE vudat_veda, " DATE ON WHICH CONTRACT IS
                                        " SIGNED
            ccperiocat TYPE vlauk_veda, " VALIDITY PERIOD CATEGORY OF
                                        " CONTRACT
            ccdurn     TYPE vlauf_veda, " VALIDITY PERIOD OF CONTRACT
            vlauez     type VLAUE_VEDA, " Unit of val.period of contract
            perio      type ZCHAR_1,    " Period (2 char)
            autte      TYPE  autte,     " BILLING/INVOICE CREATION IN
                                        " ADVANCE
            mssprd     TYPE matnr,      " MATERIAL NUMBER
            msmsno     TYPE sernr,      " SERIAL NUMBER
            msmpno     TYPE matnr,      " MATERIAL NUMBER
            equnr      TYPE equnr,      " EQUIPMENT NUMBER
            vbeln      TYPE vbeln,      " SALES ORDER NUMBER
            vasdr      TYPE vasdr,      " Date rule for action
            vasda      type vasda,      " Date for action
            vakt       type VASCH_VEDA, " Action at end of contract
            bpstadat   type bedat_fp,   " BP start date
            bpenddat   type endat_fp,   " BP end date
            anws       type J_TXT04,    " user status
            fpart      type fpart,      " Billing plan/invoice plan type
            zmeng      type zdzmeng,    " Target Quantity field
            ffprf      type AD01PROFNR, " Dynamic Item Processor Profile
            kunn2      type kunwe,      " Branch Ship-to
            ktext      type ktext_v,    " Contract type description
            zterm      type dzterm,     " Payment term
            zlsch      type schzw_bseg, " Payment method
            horiz      type HORIZ_FP,   " Horizon
            name       type bname_v,    " contact name
            telf       type telf1_vp,   " contact telephone
            pstyv      type pstyv,      " Item category
            afdat      type fkdat,      " Next billing date
            landtx     type landtx,     " Tax departure country
            stceg_l    type land1tx,    " Tax destination country
            zzbbs      type zzbbs,      " Back-billing scenario
            zzbbt(3)   type n,          " Back-billing thresh.value
            zzipf(3)   type n,          " Index. percentage - fixed
            zzipm(3)   type n,          " Index. percentage - material
            zzipl(3)   type n,          " Index. percentage - labour
            arktx      type arktx,      " Contract Item description
            vbegreg    type VBREG_VEDA, " Rule for calc.contr. startdate
            vendreg    type RGVTE,      " Rule for contract end date
            autte2     type autte,      " Bill./invoice creat in advance
            bedar      type BEDAT_FPK,  " Rule origin startdate bill.pl.
            endar      type ENDAT_FPK,  " Rule origin enddate bill.plan
        END OF ty_final_record.


* - DECLARATION FOR THE HEADER DATA
TYPES : BEGIN OF ty_header,
            reclink_c(020),             " IDENTIFIER
            vkorg      type vkorg,      " sales org.
            vtweg      type vtweg,      " distr. channel
            spart      type spart,      " division
            vkgrp      TYPE vkgrp,      " SALES GROUP
            vkbur      TYPE vkbur,      " SALES OFFICE
            cccntp     TYPE auart,      " SALES DOCUMENT TYPE
            cccust     TYPE kunnr,      " SOLD-TO PARTY
            ccoref     TYPE bstkd,      " CUSTOMER PURCHASE ORDER
            ccsdat     TYPE vbdat_veda, " CONTRACT START DATE
            ccedat     TYPE vndat_veda, " CONTRACT END DATE
            ccscon     TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
            ccsdat1    TYPE vudat_veda, " DATE ON WHICH CONTRACT IS
                                        " SIGNED
            ccperiocat TYPE vlauk_veda, " VALIDITY PERIOD CATEGORY OF
                                        " CONTRACT
            ccdurn     TYPE vlauf_veda, " VALIDITY PERIOD OF CONTRACT
            vlauez     type VLAUE_VEDA, " Unit of val.period of contract
            perio      type ZCHAR_1,    " Period (2 char)
            autte      TYPE autte,      " BILLING/INVOICE CREATION IN
                                        " ADVANCE
            vbeln      TYPE vbeln,      " SALES ORDER NUMBER
            vasdr      TYPE vasdr,      " Date rule for action
            vasda      type vasda,      " Date for action
            vakt       type VASCH_VEDA, " Action at end of contract
            bpstadat   type bedat_fp,   " BP start date
            bpenddat   type endat_fp,   " BP end date
            anws       type J_TXT04,    " user status
            fpart      type fpart,      " Billing plan/invoice plan type
            ffprf      type AD01PROFNR, " Dynamic Item Processor Profile
            kunn2      type kunwe,      " Branch Ship-to
            ktext      type ktext_v,    " Contract type description
            zterm      type dzterm,     " Payment term
            zlsch      type schzw_bseg, " Payment method
            horiz      type HORIZ_FP,   " Horizon
            name       type bname_v,    " contact name
            telf       type telf1_vp,   " contact telephone
            afdat      type fkdat,      " Next billing date
            landtx     type landtx,     " Tax departure country
            stceg_l    type land1tx,    " Tax destination country
            vbegreg    type VBREG_VEDA, " Rule for calc.contr. startdate
            vendreg    type RGVTE,      " Rule for contract end date
            autte2     type autte,      " Bill./invoice creat in advance
            bedar      type BEDAT_FPK,  " Rule origin startdate bill.pl.
            endar      type ENDAT_FPK,  " Rule origin enddate bill.plan
        END OF ty_header.


* - DECLARATION FOR THE ITEM DATA
TYPES : BEGIN OF ty_detail,
            reclink_c(020),             " IDENTIFIER
            mssprd     TYPE matnr,      " MATERIAL NUMBER
            msmsno     TYPE gernr,      " SERIAL NUMBER
            msmpno     TYPE matnr,      " MATERIAL NUMBER
            equnr      TYPE equnr,      " EQUIPMENT NUMBER
            zmeng      type zdzmeng,    " Target Quantity field
            pstyv      type pstyv,      " Item category
            zzbbs      type zzbbs,      " Back-billing scenario
            zzbbt(3)   type n,          " Back-billing thresh.value
            zzipf(3)   type n,          " Index. percentage - fixed
            zzipm(3)   type n,          " Index. percentage - material
            zzipl(3)   type n,          " Index. percentage - labour
            arktx      type arktx,      " Contract Item description
        END OF ty_detail.


*---------------------------------------------------------------------*
* INTERNAL TABLE DECLARATIONS                                         *
*---------------------------------------------------------------------*
* - INTERNAL TABLE FOR THE FILE OF LEGACY DATA UPLOAD FOR CONTRACTS
DATA : i_upload TYPE STANDARD TABLE OF ty_upload
                       INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE LEGACY DATA
DATA : i_final_record TYPE STANDARD TABLE OF ty_final_record
                       INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE HEADER DATA
DATA : i_header TYPE STANDARD TABLE OF ty_header
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE DETAIL DATA
DATA : i_detail TYPE STANDARD TABLE OF ty_detail
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE MANIPULATING DETAIL FOR EQUIPMENT.
DATA : i_detail_equip LIKE i_detail
                            OCCURS 0 WITH HEADER LINE.

DATA : begin of i_bp_det occurs 0,
         afdat     like fplt-afdat,
       end of i_bp_det.

*---------------------------------------------------------------------*
* INTERNAL TABLE FOR BDC AND CONTRACT DETAILS                         *
*---------------------------------------------------------------------*
DATA : i_bdcdata LIKE bdcdata OCCURS 0 WITH HEADER LINE,
       struct_bdcdata TYPE bdcdata.

*---------------------------------------------------------------------*
* VARIABLE DECLARATIONS                                               *
*---------------------------------------------------------------------*
DATA :  g_count   TYPE sy-tabix,                " COUNT
        p_infile  LIKE /sapdmc/lsoinp-filename, " FILE
        g_lin     TYPE i,                       " TOTAL EQUIPM LINES
        g_scr_fld(20) TYPE c,
        v_indx(2) TYPE n,
        g_per(3)  type n,                       " total periods
        g_months(2) type n,                     " nr. of months
        g_mth(3)    type n,
        g_cnt(3)    type n,
        g_afdat   type d,                       " date in user format
        g_inv_date type bedat_fp,
        g_autte(1) type c,
        g_diff(2)  type n,
        g_pos(2)  type n.                       " position of user stat

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS                                               *
*---------------------------------------------------------------------*
CONSTANTS : c_rb_pre         TYPE c VALUE  ' ',      " SPACE
            c_filetype(10)   TYPE c VALUE 'ASC',     " FILE TYPE
            c_x              TYPE c VALUE 'X',       " CHECKED
            c_vsbed(2)       type c value '01',      " Ship conditions
            c_stat_v(4)      type c value 'V   ',    " Distributor
            c_stat_h(4)      type c value 'H   '.    " Hold status

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS FOR BDC
*
*---------------------------------------------------------------------*
CONSTANTS : c_group     LIKE apqi-groupid VALUE 'Y_VA41_BTCI',
            c_trans     LIKE tstc-tcode   VALUE 'VA41'.

*--------- S T A R T   O F   M A I N   P R O C E S S I N G -----------*

*---------------------------------------------------------------------*
* START-OF-SELECTION             - START OF DATABASE ACCESS           *
*---------------------------------------------------------------------*
START-OF-SELECTION.

* - GET THE FILENAME OF THE CONVERT FILE AND
* - IMPORT /SAPDMC/LSMEMORY FROM MEMORY ID '/SAPDMC/LSMW'.

  IMPORT /sapdmc/lsmemory FROM MEMORY ID '/SAPDMC/LSMW'.

  PERFORM get_lsmw IN PROGRAM yam_common_routines
                    USING  /sapdmc/lsmemory-project
                           /sapdmc/lsmemory-subproj
                           /sapdmc/lsmemory-object
                           c_x
                   CHANGING p_infile.

  IF sy-subrc <> 0.
    MESSAGE e007.
  ENDIF.


* - READ INPUT FILE FROM PRES/APPL SERVER INTO INTERNAL TABLE
  PERFORM get_input_file.

* - SPILT INTERNAL TABLE RECORDS INTO HEADER AND DETAIL RECORDS
  PERFORM split_file.


*---------------------------------------------------------------------*
* END-OF-SELECTION               - END OF DATABASE ACCESS             *
*---------------------------------------------------------------------*
END-OF-SELECTION.

*&---------------------------------------------------------------------*
*&      FORM  GET_INPUT_FILE
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM get_input_file .

  IF c_rb_pre = c_x.
* - FILE READ FROM PRESENTATION SERVER
    PERFORM get_from_pres IN PROGRAM yam_common_routines
                                     TABLES  i_upload
                                     USING   p_infile
                                             c_filetype
                                             c_x.

  ELSE.
* - FILE READ FROM APPLICATION SERVER
    PERFORM get_from_appl IN PROGRAM yam_common_routines
                                     TABLES i_upload
                                     USING  p_infile.

  ENDIF.

ENDFORM.                    " GET_INPUT_FILE

*&---------------------------------------------------------------------*
*&      FORM  SPLIT_FILE
*&---------------------------------------------------------------------*
*   SPLIT DATA FILE INTO HEADER AND DETAIL LEVEL FILES
*   HEADER FILE STORES THE TOTAL NUMBER OF LINE ITEMS WITHIN
*   THE RECORD.
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM split_file .

* - PASS THE RECORDS FROM FILE TO A COMMON INTERNAL TABLE
  LOOP AT i_upload.

    MOVE i_upload-v_text+13(20)    TO i_final_record-reclink_c.
    move i_upload-v_text+33(4)     to i_final_record-vkorg.
    move i_upload-v_text+37(2)     to i_final_record-vtweg.
    move i_upload-v_text+39(2)     to i_final_record-spart.
    MOVE i_upload-v_text+41(3)     TO i_final_record-vkgrp.
    MOVE i_upload-v_text+44(4)     TO i_final_record-vkbur.
    MOVE i_upload-v_text+48(4)     TO i_final_record-cccntp.
    MOVE i_upload-v_text+52(10)    TO i_final_record-cccust.
    MOVE i_upload-v_text+62(35)    TO i_final_record-ccoref.
    MOVE i_upload-v_text+97(8)     TO i_final_record-ccsdat.
    MOVE i_upload-v_text+105(8)    TO i_final_record-ccedat.
    MOVE i_upload-v_text+113(4)    TO i_final_record-vakt.
    MOVE i_upload-v_text+117(12)   TO i_final_record-ccscon.
    MOVE i_upload-v_text+129(8)    TO i_final_record-ccsdat1.
    MOVE i_upload-v_text+137(2)    TO i_final_record-ccperiocat.
    MOVE i_upload-v_text+139(3)    TO i_final_record-ccdurn.
    move i_upload-v_text+142(1)    TO i_final_record-vlauez.
    MOVE i_upload-v_text+143(2)    TO i_final_record-fpart.
    MOVE i_upload-v_text+145(2)    TO i_final_record-perio.
    MOVE i_upload-v_text+147(1)    TO i_final_record-autte.
    MOVE i_upload-v_text+148(18)   TO i_final_record-mssprd.
    MOVE i_upload-v_text+166(16)   TO i_final_record-zmeng.
    MOVE i_upload-v_text+182(8)    TO i_final_record-ffprf.
    MOVE i_upload-v_text+190(18)   TO i_final_record-msmpno.
    MOVE i_upload-v_text+208(18)   TO i_final_record-msmsno.
    MOVE i_upload-v_text+226(18)   TO i_final_record-equnr.
    MOVE i_upload-v_text+244(2)    TO i_final_record-vasdr.
    MOVE i_upload-v_text+246(10)   TO i_final_record-vbeln.
    move i_upload-v_text+256(8)    to i_final_record-vasda.
    move i_upload-v_text+264(8)    to i_final_record-bpstadat.
    move i_upload-v_text+272(8)    to i_final_record-bpenddat.
    move i_upload-v_text+280(4)    to i_final_record-anws.
    move i_upload-v_text+284(10)   to i_final_record-kunn2.
    move i_upload-v_text+294(40)   to i_final_record-ktext.
    move i_upload-v_text+334(4)    to i_final_record-zterm.
    move i_upload-v_text+338(1)    to i_final_record-zlsch.
    move i_upload-v_text+339(2)    to i_final_record-horiz.
    move i_upload-v_text+341(35)   to i_final_record-name.
    move i_upload-v_text+376(16)   to i_final_record-telf.
    move i_upload-v_text+392(4)    to i_final_record-pstyv.
    move i_upload-v_text+396(8)    to i_final_record-afdat.
    move i_upload-v_text+404(3)    to i_final_record-landtx.
    move i_upload-v_text+407(3)    to i_final_record-stceg_l.
    move i_upload-v_text+410(1)    to i_final_record-zzbbs.
    move i_upload-v_text+411(3)    to i_final_record-zzbbt.
    move i_upload-v_text+414(3)    to i_final_record-zzipf.
    move i_upload-v_text+417(3)    to i_final_record-zzipm.
    move i_upload-v_text+420(3)    to i_final_record-zzipl.
    move i_upload-v_text+423(40)   to i_final_record-arktx.
    move i_upload-v_text+463(2)    to i_final_record-vbegreg.
    move i_upload-v_text+465(2)    to i_final_record-vendreg.
    move i_upload-v_text+467(1)    to i_final_record-autte2.
    move i_upload-v_text+468(2)    to i_final_record-bedar.
    move i_upload-v_text+470(2)    to i_final_record-endar.
    APPEND i_final_record.

* - PASS THE HEADER DETAILS TO THE HEADER INTERNAL TABLE
    MOVE-CORRESPONDING i_final_record TO i_header.
    APPEND i_header.
    CLEAR  i_header.

* - PASS THE ITEM DETAILS TO THE DETAIL INTERNAL TABLE
    MOVE-CORRESPONDING i_final_record TO i_detail.
    APPEND i_detail.
    CLEAR  i_detail.

  ENDLOOP.

* - SORT THE HEADER INTERNAL TABLE AND DELETE THE DUPLICATES
  SORT i_header BY reclink_c.
  DELETE ADJACENT DUPLICATES FROM i_header COMPARING reclink_c.


* - CHECK IF HEADER IS NOT BLANK
  IF NOT i_header[] IS INITIAL.

    perform open_group.

    LOOP AT i_header WHERE reclink_c NE space.

* -   CHECK FOR THE EXISTING SERVICE CONTRACTS
      PERFORM sales_contract_doc.

    ENDLOOP.

    perform close_group.

  ENDIF.

ENDFORM.                    " SPLIT_FILE

*&---------------------------------------------------------------------*
*&   FORM SALES_CONTRACT_DOC
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM sales_contract_doc .

  CLEAR: g_count.

* - CHECK FOR THE MULTIPLE SALES DOCUMENT VERSION
  SELECT COUNT( * ) FROM vbak
          INTO (g_count) WHERE
                         vsnmr_v EQ i_header-ccscon
                           GROUP BY vsnmr_v .
  ENDSELECT.

* - CHECK IF 1 ENTRY EXISTS FOR THE VERSION
  IF g_count = 1.

    write: / text-023, i_header-ccscon.

* - CHECK IF NO ENTRY EXIST THEN CREATE SERVICE CONTRACTS
  ELSEIF g_count < 1.

    PERFORM prep_data.
    PERFORM bdc_filldata.
    perform bdc_transaction using c_trans.
    refresh i_bdcdata.

* IF MULTIPLE ENTRIES FOUND THEN DO NOT PROCESS
  ELSEIF g_count > 1.

    WRITE : / text-024, i_header-ccscon.

  ENDIF.

ENDFORM.                    "SALES_CONTRACT_DOC

*&---------------------------------------------------------------------*
*&      FORM  PREP_DATA
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM prep_data.

* prepare user status
  case i_header-anws.
    when 'A   ' or 'L   '.
      g_pos = 1.
    when 'C   ' or 'O   '.
      g_pos = 2.
    when 'D   ' or 'R   '.
      g_pos = 3.
    when 'F   ' or 'S   '.
      g_pos = 4.
* begin of change MOD-004
*   when 'H   ' or 'V   '.
    when 'H   ' or 'V   ' or 'X   '.
* end of change MOD-004
      g_pos = 5.
    when others.
      g_pos = 1.
  endcase.

* prepare equipments
  refresh i_detail_equip.

  LOOP AT i_detail WHERE
          reclink_c EQ i_header-reclink_c.

    MOVE i_detail-mssprd    TO   i_detail_equip-mssprd.
    MOVE i_detail-msmpno    TO   i_detail_equip-msmpno.
    MOVE i_detail-msmsno    TO   i_detail_equip-msmsno.
    MOVE i_detail-equnr     TO   i_detail_equip-equnr.
*    MOVE i_detail-zterm     to   i_detail_equip-zterm.
*    MOVE i_detail-zlsch     to   i_detail_equip-zlsch.
    APPEND i_detail_equip.
    CLEAR i_detail_equip.

  ENDLOOP.

ENDFORM.                    " PREP_DATA

*&---------------------------------------------------------------------*
*&      Form  bdc_filldata
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM bdc_filldata .

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '0101' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-AUART' i_header-cccntp
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VKORG' i_header-vkorg
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VTWEG' i_header-vtweg
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-SPART' i_header-spart
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Overview
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VBELN' i_header-vbeln
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBKD-BSTKD' i_header-ccoref
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VSBED' c_vsbed
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'KUAGV-KUNNR' i_header-cccust
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'KUWEV-KUNNR' i_header-kunn2
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-KTEXT' i_header-ktext
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=KVER'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Contract data
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLV45W' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  if i_header-ccsdat is initial.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VBEGDAT' '!'
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VBEGREG' i_header-vbegreg
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.
  else.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VBEGDAT' i_header-ccsdat
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VBEGREG' '!'
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.
  endif.

  if i_header-ccedat is initial.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VENDDAT' '!'
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VENDREG' i_header-vendreg
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.
  else.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VENDDAT' i_header-ccedat
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VENDREG' '!'
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.
  endif.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VEDA-VLAUFK' i_header-ccperiocat
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VEDA-VLAUFZ' i_header-ccdurn
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VEDA-VLAUEZ' i_header-vlauez
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VEDA-VUNTDAT' i_header-ccsdat1
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VEDA-VAKTSCH' i_header-vakt
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  if not i_header-vasda is initial.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VEDA-VASDA' i_header-vasda
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.
  endif.

  if i_header-vasdr is initial.
    move '!' to i_header-vasdr.
  endif.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VEDA-VASDR' i_header-vasdr
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=T\01'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Header Sales
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4002' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VKBUR' i_header-vkbur
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VKGRP' i_header-vkgrp
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VSNMR_V' i_header-ccscon
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=T\11'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4002' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-SUBMI' i_header-ccscon
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAK-BNAME' i_header-name
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAK-TELF1' i_header-telf
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=T\04'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* payment term and method.
*************************

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPMV45A' '4002' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBKD-ZTERM' i_header-zterm
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAK-LANDTX' i_header-landtx
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAK-STCEG_L' i_header-stceg_l
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=T\06'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPMV45A' '4002' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBKD-zlsch' i_header-zlsch
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=T\05'
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.
*************************

* Billing plan
* enter to let SAP default the necessary values and
* clear these fields
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLV60F' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-BEDAT' '!'
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-BEDAR' '!'
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-ENDAT' '!'
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-ENDAR' '!'
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLV60F' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.
********************
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-PERIO' i_header-perio
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

*  if i_header-bpstadat is initial.
*    move '!' to i_header-bpstadat.
*  endif.
*  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                     USING: '' '' '' 'FPLA-BEDAT' i_header-bpstadat
*                     CHANGING struct_bdcdata.
*
*  APPEND struct_bdcdata TO i_bdcdata.
*  CLEAR  struct_bdcdata.

*  if i_header-bedar is initial.
*    move '!' to i_header-bedar.
*  endif.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-BEDAR' i_header-bedar
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

*  if i_header-bpenddat is initial.
*    move '!' to i_header-bpenddat.
*  endif.
*  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                     USING: '' '' '' 'FPLA-ENDAT' i_header-bpenddat
*                     CHANGING struct_bdcdata.
*
*  APPEND struct_bdcdata TO i_bdcdata.
*  CLEAR  struct_bdcdata.

*  if i_header-endar is initial.
*    move '!' to i_header-endar.
*  endif.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-ENDAR' i_header-endar
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Fill in Horizon in the billing plan
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-HORIZ' i_header-horiz
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

** <enter> to let SAP clear the defaulted enddate rule
*  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                      USING: '' '' '' 'BDC_OKCODE' '/00'
*                      CHANGING struct_bdcdata.
*
*  APPEND struct_bdcdata TO i_bdcdata.
*  CLEAR  struct_bdcdata.
*
*  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                     USING: 'SAPLV60F' '4001' 'X' ' ' ' '
*                     CHANGING struct_bdcdata.
*
*  APPEND struct_bdcdata TO i_bdcdata.
*  CLEAR  struct_bdcdata.
*
*  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                     USING: '' '' '' 'FPLA-ENDAR' '09'
*                     CHANGING struct_bdcdata.
*
*  APPEND struct_bdcdata TO i_bdcdata.
*  CLEAR  struct_bdcdata.

*  if not i_header-afdat is initial.
*
*   first <enter> to let SAP generate the settlement periods
*    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                        USING: '' '' '' 'BDC_OKCODE' '/00'
*                        CHANGING struct_bdcdata.
*
*    APPEND struct_bdcdata TO i_bdcdata.
*    CLEAR  struct_bdcdata.
*
*    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                       USING: 'SAPLV60F' '4001' 'X' ' ' ' '
*                       CHANGING struct_bdcdata.
*
*    APPEND struct_bdcdata TO i_bdcdata.
*    CLEAR  struct_bdcdata.
*
*    if i_header-bpstadat+4(2) = i_header-afdat+4(2).
*     no action anymore - periods generated by SAP are OK
*    else.
*      g_diff = i_header-afdat - i_header-bpstadat.
*      if g_diff <= 14.
*       no action anymore - periods generated by SAP are OK
*      else.
*        i_header-afdat+6(2) = i_header-bpstadat+6(2).
*        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                           USING: '' '' '' 'FPLA-AUTTE' ' '
*                           CHANGING struct_bdcdata.
*
*        APPEND struct_bdcdata TO i_bdcdata.
*        CLEAR  struct_bdcdata.
*
*        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                    USING: '' '' '' 'BDC_OKCODE' '/00'
*                    CHANGING struct_bdcdata.
*
*        APPEND struct_bdcdata TO i_bdcdata.
*        CLEAR  struct_bdcdata.
*
*        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                           USING: 'SAPLV60F' '4001' 'X' ' ' ' '
*                           CHANGING struct_bdcdata.
*
*        APPEND struct_bdcdata TO i_bdcdata.
*        CLEAR  struct_bdcdata.
*
*   prepare int. table with calculated invoice dates
*        case i_header-perio.
*          when 'Z0'.
*            g_months = 1.
*          when 'Z1'.
*            g_months = 4.
*          when 'Z2'.
*            g_months = 6.
*          when 'Z3'.
*            g_months = 12.
*          when 'Z4'.
*            g_months = 3.
*        endcase.
*
*        refresh i_bp_det.
*        i_bp_det-afdat = i_header-afdat.
*        append i_bp_det.
*        clear i_bp_det.
*
*        clear g_cnt.
*        g_inv_date = i_header-afdat.
*
*        while g_inv_date < i_header-bpenddat.
*
*          g_cnt = g_cnt + 1.
*          g_mth = g_months * g_cnt.
*
*          CALL FUNCTION 'RELATIVE_DATE_CALCULATE'
*            EXPORTING
*              DAYS        = '0'
*              MONTHS      = g_mth
*              START_DATE  = i_header-afdat
*              YEARS       = '0'
*            IMPORTING
*              RESULT_DATE = g_inv_date.
*
*          i_bp_det-afdat = g_inv_date.
*          append i_bp_det.
*          clear i_bp_det.
*
*        endwhile.
*
*        sort i_bp_det.
*        describe table i_bp_det lines g_per.
*        g_per = g_per - 1.                     "one too much
*        g_lin = g_per.
*        clear v_indx.
*
*        do g_per times.
*
*          read table i_bp_det index sy-index.
*          write i_bp_det-afdat to g_afdat.
*
*          v_indx  = v_indx + 1.
*
*          if v_indx < 6.
*            clear g_scr_fld.
*            concatenate 'FPLT-AFDAT(' v_indx ')' into g_scr_fld.
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                               USING: '' '' '' g_scr_fld g_afdat
*                               CHANGING struct_bdcdata.
*
*            APPEND struct_bdcdata TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*          else.
*            g_lin = g_lin - 5.
*
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                                USING: '' '' '' 'BDC_OKCODE' '=S\P+'
*                                CHANGING struct_bdcdata.
*
*            APPEND struct_bdcdata TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                               USING: 'SAPLV60F' '4001' 'X' ' ' ' '
*                               CHANGING struct_bdcdata.
*
*            APPEND struct_bdcdata TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*
*            if g_lin < 5.
*              case g_lin.
*                when 4.
*                  v_indx = 2.
*                when 3.
*                  v_indx = 3.
*                when 2.
*                  v_indx = 4.
*                when 1.
*                  v_indx = 5.
*              endcase.
*            else.
*              v_indx = 1.
*            endif.
*
*            clear g_scr_fld.
*            concatenate 'FPLT-AFDAT(' v_indx ')' into g_scr_fld.
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                               USING: '' '' '' g_scr_fld g_afdat
*                               CHANGING struct_bdcdata.
*
*            APPEND struct_bdcdata TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*          endif.
*
*        enddo.
*
*      endif.
*    endif.
*
* endif.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'FPLA-AUTTE' i_header-autte2
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=T\12'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Status
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4002' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=KSTC'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  if i_header-anws > c_stat_h.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPLBSVA' '0300' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING: '' '' '' 'BDC_CURSOR' 'JOSTD-OBJNR'
                        CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING: '' '' '' 'BDC_OKCODE' '=A+'
                        CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    if i_header-anws > c_stat_v.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: 'SAPLBSVA' '0300' 'X' ' ' ' '
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                          USING: '' '' '' 'BDC_CURSOR' 'JOSTD-OBJNR'
                          CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                          USING: '' '' '' 'BDC_OKCODE' '=A+'
                          CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.
    endif.
  endif.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLBSVA' '0300' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  clear g_scr_fld.
  concatenate 'J_STMAINT-ANWS(' g_pos ')' into g_scr_fld.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' g_scr_fld 'X'
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=BACK'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4002' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/EBACK'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Overview : materials
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  clear: v_indx, g_lin.
  loop at i_detail where
               reclink_c eq i_header-reclink_c.

    g_lin = g_lin + 1.

    IF v_indx = 2.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=POAN'
                       CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: '' '' '' 'RV45A-MABNR(02)'
                                         i_detail-mssprd
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: '' '' '' 'VBAP-ZMENG(02)'
                                         i_detail-zmeng
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: '' '' '' 'VBAP-ARKTX(02)'
                                         i_detail-arktx
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      if not i_detail-pstyv is initial.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                           USING: '' '' '' 'VBAP-PSTYV(02)'
                                           i_detail-pstyv
                           CHANGING struct_bdcdata.

        APPEND struct_bdcdata TO i_bdcdata.
        CLEAR  struct_bdcdata.
      endif.
    Else.
      v_indx = v_indx + 1.

      clear g_scr_fld.
      concatenate 'RV45A-MABNR(' v_indx ')' into g_scr_fld.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: '' '' '' g_scr_fld i_detail-mssprd
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      clear g_scr_fld.
      concatenate 'VBAP-ZMENG(' v_indx ')' into g_scr_fld.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: '' '' '' g_scr_fld i_detail-zmeng
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      clear g_scr_fld.
      concatenate 'VBAP-ARKTX(' v_indx ')' into g_scr_fld.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                         USING: '' '' '' g_scr_fld i_detail-arktx
                         CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      if not i_detail-pstyv is initial.
        clear g_scr_fld.
        concatenate 'VBAP-PSTYV(' v_indx ')' into g_scr_fld.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                           USING: '' '' '' g_scr_fld i_detail-pstyv
                           CHANGING struct_bdcdata.

        APPEND struct_bdcdata TO i_bdcdata.
        CLEAR  struct_bdcdata.
      endif.
    endif.

  endloop.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=MKAL'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Technical objects : equipments
  CLEAR: v_indx.

  DO g_lin TIMES.

    v_indx = v_indx + 1.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=POTO'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: 'SAPLIWOL' '0220' 'X' ' ' ' '
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    READ TABLE i_detail_equip index v_indx.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'RIWOL-EQUNR(01)'
                               i_detail_equip-equnr
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: '' '' '' 'BDC_OKCODE' '=BACK'
                    CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

  ENDDO.

* Additional data B
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: '' '' '' 'BDC_OKCODE' '=MKAL'
                    CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  CLEAR: v_indx.

  DO g_lin TIMES.

    v_indx = v_indx + 1.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=PZKU'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPMV45A' '4003' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    READ TABLE i_detail_equip index v_indx.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAP-ZZBBS'
                               i_detail-zzbbs
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAP-ZZBBT'
                               i_detail-zzbbt
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAP-ZZIPF'
                               i_detail-zzipf
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAP-ZZIPM'
                               i_detail-zzipm
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAP-ZZIPL'
                               i_detail-zzipl
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/EBACK'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

  ENDDO.

* Save
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=SICH'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

ENDFORM.        "bdc_filldata

*&---------------------------------------------------------------------*
*&      Form  BDC_TRANSACTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_TRANS  text
*----------------------------------------------------------------------*
FORM bdc_transaction USING p_c_trans.

  CALL FUNCTION 'BDC_INSERT'
    EXPORTING
      tcode            = p_c_trans
    TABLES
      dynprotab        = i_bdcdata
    EXCEPTIONS
      internal_error   = 1
      not_open         = 2
      queue_error      = 3
      tcode_invalid    = 4
      printing_invalid = 5
      posting_invalid  = 6
      OTHERS           = 7.
  .
  IF sy-subrc <> 0.
    MESSAGE e014.
  ENDIF.

ENDFORM.                    " BDC_TRANSACTION

*&---------------------------------------------------------------------*
*&      Form  open_group
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM open_group .

  CALL FUNCTION 'BDC_OPEN_GROUP'
    EXPORTING
      client = sy-mandt
      group  = c_group
      user   = sy-uname
      keep   = ' '.
  .
  IF sy-subrc <> 0.
    MESSAGE e013. " OPEN SESSION FAILED
  ENDIF.

ENDFORM.                    " open_group

*&---------------------------------------------------------------------*
*&      Form  close_group
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM close_group .

  CALL FUNCTION 'BDC_CLOSE_GROUP'.

ENDFORM.                    " close_group

*Text symbol text
*023:Error !!! Service Contract already exists for this entry

*024:Error !!! Multiple Service Contracts found for this entry
*Selection text
*P_FILE:D       File name
