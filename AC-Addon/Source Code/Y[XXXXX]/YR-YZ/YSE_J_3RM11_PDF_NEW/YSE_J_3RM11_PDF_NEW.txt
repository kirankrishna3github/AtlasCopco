REPORT YSE_J_3RM11_PDF_NEW .
*
INCLUDE J_3RM07DRPDF.

TABLES: SKA1.
data: begin of h_head11.            "structure for head M-11
* IMP RU BEGIN DELETE
*      include structure J_3RM11_head.
* IMP RU END DELETE

* IMP RU BEGIN INSERT
        include structure YSE_J_3RM11_head.
* IMP RU END INSERT
data: end of h_head11.

* IMP RU BEGIN INSERT
DATA: lv_anzsn like lips-anzsn,
      lv_obknr like ser03-obknr,
      TKOMSER2 TYPE TABLE OF RISERLS with header line,
      teller TYPE I.

DATA: LV_KDAUF TYPE KDAUF,
      LV_KDPOS TYPE KDPOS,
      LV_ASSO TYPE VBELN,
      LV_AUFNR TYPE AUFNR.

DATA:  wa_name1 TYPE T001W-name1,
       wa_stras TYPE T001W-stras,
       wa_pstlz TYPE T001W-pstlz,
       wa_ort01 TYPE T001W-ort01,
       wa_name1_r TYPE T001W-name1,
       wa_stras_r TYPE T001W-stras,
       wa_pstlz_r TYPE T001W-pstlz,
       wa_ort01_r TYPE T001W-ort01,
       wa_adrnr   TYPE T001w-ADRNR.

DATA: lv_txtmd_in TYPE CHAR30,
      lv_txtmd_out TYPE CHAR30.

DATA: lv_vaplz TYPE GEWRK,
      lv_lgort TYPE LGORT_D,
      lv_objid TYPE OBJID,
      gv_konwa TYPE KONWA,
      gv_kbetr TYPE KBETR,
      gv_knumh TYPE KNUMH,
      lv_vkorg TYPE VKORG.


* IMP RU END INSERT

* IMP RU BEGIN DELETE
*data: h_line11 type J_3RM11_table . "internal table for items M-11
* IMP RU END DELETE

* IMP RU BEGIN INSERT
data: h_line11 type YSE_J_3RM11_table . "internal table for items M-11
* IMP RU END INSERT
data: wa_line11 like line of h_line11.

data: begin of h_head15.            "structure for head M-15
        include structure J_3RV_HM15.
data: end of h_head15.

data: h_line15 type J_3RV_TM15 . "internal table for items M-15
data: wa_line15 like line of h_line15.

DATA: desc(1) TYPE C.
data: gc_badi_descr type ref to J_3RV_AFS_DESCR, "AFS-material description
      gc_badi_m15 type ref to J_3R_M15_BADI, m15.
*---------------------------------------------------------------------*
*       FORM ENTRY_RU                                                 *
*---------------------------------------------------------------------*
*      printing form for Russian Request Delivery Note                *
*---------------------------------------------------------------------*
*  -->  ENT_RETCO                                                     *
*  -->  ENT_SCREEN                                                    *
*---------------------------------------------------------------------*
FORM ENTRY_RU USING ENT_RETCO ENT_SCREEN.
  XSCREEN = ENT_SCREEN.
  CLEAR ENT_RETCO.
  PERFORM LESEN_WAS USING NAST-OBJKY.
  ENT_RETCO = RETCO.
ENDFORM.                    "ENTRY_RU

*---------------------------------------------------------------------*
*       FORM LESEN_WAS                                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  OBJKY                                                         *
*---------------------------------------------------------------------*
FORM LESEN_WAS USING OBJKY.

  REFRESH TRAPTAB. refresh h_line15. refresh h_line11.
  clear h_head15. clear h_head11.
  clear totsum. clear sum.
  NAST_KEY = OBJKY.
  LANGUAGE = sy-langu.
  CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
    EXPORTING
      USER_NAME    = SY-UNAME
    IMPORTING
      USER_ADDRESS = USR
    EXCEPTIONS
      OTHERS       = 2.
  IF SY-SUBRC <> 0.
    USR-NAME_FIRST = SY-UNAME.
  ENDIF.
  CONCATENATE USR-NAME_FIRST USR-NAME_LAST INTO STR2
           SEPARATED BY ' '.
  CLEAR RETCO.
  CLEAR XKOPFDR.
  SELECT SINGLE * FROM MKPF WHERE MBLNR = NAST_KEY-MBLNR
                            AND   MJAHR = NAST_KEY-MJAHR.

  MOVE-CORRESPONDING MKPF TO TRAPTAB.
  SELECT * FROM MSEG WHERE MBLNR = MKPF-MBLNR
                     AND   MJAHR = MKPF-MJAHR.
    CHECK MSEG-XAUTO IS INITIAL.
    PERFORM TAB001W_LESEN.
    sgtxt = mseg-sgtxt.
    MOVE-CORRESPONDING MSEG TO TRAPTAB.
    APPEND TRAPTAB.
  ENDSELECT.
  IF SY-SUBRC NE 0.
    RETCO = SY-SUBRC.
    EXIT.
  ENDIF.
  PERFORM OPEN_FORM_SAMMEL.
  SORT TRAPTAB BY WERKS ZEILE.

  clear m15.
* Get BADI instance
  TRY.
      get badi gc_badi_m15.
    CATCH cx_badi_not_implemented.                      "#EC NO_HANDLER
    CATCH cx_badi_multiply_implemented.
      MESSAGE e001(J3R_LEGAL_FORMS).
    CATCH cx_badi_initial_context.
      MESSAGE e002(J3R_LEGAL_FORMS).
  ENDTRY.

  IF gc_badi_m15 IS BOUND.
    m15 = 'X'.
  ENDIF.

  CLEAR desc.
* Get BADI instance
  TRY.
      get badi gc_badi_descr.
    CATCH cx_badi_not_implemented.                      "#EC NO_HANDLER
    CATCH cx_badi_multiply_implemented.
      MESSAGE e001(J3R_LEGAL_FORMS).
    CATCH cx_badi_initial_context.
      MESSAGE e002(J3R_LEGAL_FORMS).
  ENDTRY.

  IF gc_badi_descr IS BOUND.
    desc = 'X'.
  ENDIF.

  sum = 0.
  LOOP AT TRAPTAB.
    clear wa_line11. clear wa_line15.
    CURRENT_LINE = SY-TABIX.
    MOVE-CORRESPONDING TRAPTAB TO MKPF.
    MOVE-CORRESPONDING TRAPTAB TO MSEG.
    PERFORM TAB156_LESEN.
    CHECK NOT T156-KZDRU IS INITIAL.                        " 108942
    XSKKZ = T156-RSTYP.
    PERFORM TAB001W_LESEN_2.
    PERFORM TAB001L_LESEN.
    PERFORM REF_DEFINITION.
    IF NOT MSEG-MATNR IS INITIAL.
      PERFORM MATERIAL_LESEN.
    ENDIF.
    PERFORM NEW_NAMES.
    PERFORM RU_AUSGABE.
  ENDLOOP.
  if XKOPFDR eq 'X'.
    PERFORM print_FORM.
  endif.
  PERFORM CLOSE_FORM.
ENDFORM.                    "LESEN_WAS

*---------------------------------------------------------------------*
*       FORM OPEN_FORM_SAMMEL                                         *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM OPEN_FORM_SAMMEL.
  data: fp_outputparams   type sfpoutputparams.

  PERFORM LESEN_T159P.
  PERFORM ITCPO_FUELLEN.
*Sets output parameters and opens the spool job
  fp_outputparams-PDFTAGGED = 'X'.

  PERFORM FILL_OUTPUTPARAMS_PDF USING    ITCPO
                                CHANGING FP_OUTPUTPARAMS.

  call function 'FP_JOB_OPEN'
    CHANGING
      ie_outputparams = fp_outputparams
    EXCEPTIONS
      cancel          = 1
      usage_error     = 2
      system_error    = 3
      internal_error  = 4
      others          = 5.
  if sy-subrc <> 0.
    message id sy-msgid type sy-msgty number sy-msgno
            with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  endif.
  X_OPEN = 'X'.
ENDFORM.                    "OPEN_FORM_SAMMEL

*---------------------------------------------------------------------*
*       FORM TAB156_LESEN                                             *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM TAB156_LESEN.
  IF NOT T156-BWART = MSEG-BWART.
    SELECT SINGLE * FROM T156 WHERE BWART = MSEG-BWART.
  ENDIF.
ENDFORM.                    "TAB156_LESEN

*---------------------------------------------------------------------*
*       FORM LESEN_T159P                                              *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM LESEN_T159P.
  IF NOT T159P-TDDEST = NAST-LDEST.
    SELECT SINGLE * FROM T159P WHERE TDDEST = NAST-LDEST.
  ENDIF.
ENDFORM.                    "LESEN_T159P

*---------------------------------------------------------------------*
*       FORM TAB001W_LESEN_2                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM TAB001W_LESEN_2.
  IF NOT MSEG-WERKS = T001W-WERKS.
    SELECT SINGLE * FROM T001W WHERE WERKS = MSEG-WERKS.
  ENDIF.
ENDFORM.                    "TAB001W_LESEN_2

*---------------------------------------------------------------------*
*       FORM MATERIAL_LESEN                                           *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM MATERIAL_LESEN.
  CLEAR MTCOM.
  MTCOM-KENNG = 'MABDR'.
  MTCOM-MATNR = MSEG-MATNR.
  MTCOM-WERKS = MSEG-WERKS.
  MTCOM-LGORT = MSEG-LGORT.
  MTCOM-SPRAS = LANGUAGE.
  MTCOM-NOMUS = 'X'.
  CALL FUNCTION 'MATERIAL_LESEN'
    EXPORTING
      SCHLUESSEL = MTCOM
    IMPORTING
      MATDATEN   = MABDR
      RETURN     = MTCOR
    TABLES
      SEQMAT01   = DUMMY.
  IF NOT T156-KZMHD IS INITIAL.
    IF NOT MABDR-MHDLP IS INITIAL.
      IF T001W-VLFKZ = 'B'.            "Zentrale ?
        PERFORM MHD_BERECHNEN.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    "MATERIAL_LESEN

*---------------------------------------------------------------------*
*       FORM MHD_BERECHNEN                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM MHD_BERECHNEN.
  IF NOT EKPO-MHDRZ IS INITIAL.
    AM07M-MHDAT = MSEG-VFDAT - ( EKPO-MHDRZ * MABDR-MHDLP / 100 ).
  ELSEIF NOT MABDR-MHDRZ IS INITIAL.
    AM07M-MHDAT = MSEG-VFDAT - ( MABDR-MHDRZ * MABDR-MHDLP / 100 ).
  ENDIF.
ENDFORM.                    "MHD_BERECHNEN

*---------------------------------------------------------------------*
*       FORM ITCPO_FUELLEN                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM ITCPO_FUELLEN.
  IF XSCREEN NE SPACE.
*- Testausgabe auf Bildschirm ----------------------------------------
    ITCPO-TDPREVIEW = 'X'.
    ITCPO-TDNOPRINT = 'X'.
  ELSE.
    CLEAR: ITCPO-TDPREVIEW,
           ITCPO-TDNOPRINT.
  ENDIF.
  MOVE-CORRESPONDING NAST TO ITCPO.
  ITCPO-TDCOVER   = NAST-TDOCOVER.
  ITCPO-TDDEST    = NAST-LDEST.
  ITCPO-TDDATASET = NAST-DSNAM.
  ITCPO-TDSUFFIX1 = NAST-DSUF1.
  ITCPO-TDSUFFIX2 = NAST-DSUF2.
  ITCPO-TDIMMED   = NAST-DIMME.
  ITCPO-TDDELETE  = NAST-DELET.
  ITCPO-TDCOPIES  = NAST-ANZAL.
  ITCPO-TDPROGRAM = SY-REPID.
* ITCPO-TDTELELAND = US_COUNTRY.
  ITCPO-TDSENDDATE = NAST-VSDAT.
  ITCPO-TDSENDTIME = NAST-VSURA.
  ITCPO-TDNEWID   = 'X'.
ENDFORM.                    "ITCPO_FUELLEN

*---------------------------------------------------------------------*
*       FORM RU_AUSGABE                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM RU_AUSGABE.

  DATA: fl_change(1) TYPE C, afs_detailes(100).

  CLEAR fl_change.
  ON CHANGE OF MKPF-MBLNR OR MSEG-EBELN OR MSEG-BWART OR MSEG-WERKS.
    PERFORM ON_CHANGE.
    fl_change = 'X'.
    CLEAR XKOPFDR.
  ENDON.
  ON CHANGE OF MSEG-SAKTO.
    IF MSEG-BWART = '291' AND fl_change IS INITIAL.
      PERFORM ON_CHANGE.
      fl_change = 'X'.
      CLEAR XKOPFDR.
    ENDIF.
  ENDON.

  IF XKOPFDR IS INITIAL.
    PERFORM FILL_HEADER.
    XKOPFDR = 'X'.
  ENDIF.

  PERFORM ACCOUNT_NUMBER.
*  PRICE = MSEG-DMBTR / MSEG-MENGE.
  PERFORM PRICE_CALCULATION.
  PERFORM UNIT_NAME.
  clear wa_line11. clear wa_line15.

*IMP RU BEGIN INSERT
  select single ALTKT from SKB1 into wa_line11-HKONTH
        where BUKRS eq mseg-bukrs
          and SAKNR eq HKONTh.
*IMP RU END INSERT

*IMP RU BEGIN DELETE
*  wa_line11-HKONTH = HKONTh.
*IMP RU BEGIN DELETE
  h_head11-hkonth = hkonth.
  wa_line15-corr_sub = HKONTh.
*  wa_line11-ANCOD = .
*  wa_line15-corr_an = .
  wa_line11-MAKTX = MABDR-MAKTX.
  wa_line15-arktx = MABDR-MAKTX.
  IF desc eq 'X'.
    clear AFS_DETAILES.
    CALL BADI gc_badi_descr->MATERIAL_DETAILS
      EXPORTING
        MATNR    = mseg-MATNR
        WERKS    = mseg-WERKS
        LGORT    = mseg-LGORT
        CHARG    = mseg-CHARG
      IMPORTING
        DETAILES = AFS_DETAILES.
*        exceptions
*           OTHERS   = 1.
*      IF sy-subrc <> 0.
*        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*      else.

    concatenate wa_line11-maktx AFS_DETAILES into wa_line11-maktx.
    concatenate wa_line15-arktx AFS_DETAILES into wa_line15-arktx.
*      ENDIF
  ENDIF.
  wa_line11-MATNR = MATNR.
  wa_line15-MATNR = MATNR.

* Bin Location
  select single lgpbe into wa_line11-LGPBE from MARD
    where werks = MSEG-WERKS and LGORT = MSEG-LGORT and MATNR = MATNR.

*IMP RU BEGIN INSERT
* Retrieve Serial numbers
  lv_anzsn = 0.
  SELECT SINGLE ANZSN OBKNR INTO (lv_ANZSN, lv_OBKNR) FROM SER03 WHERE MBLNR = MSEG-MBLNR and
                                                       MJAHR = MSEG-MJAHR and
                                                       ZEILE = MSEG-ZEILE.
  IF SY-SUBRC = 0.
    if lv_anzsn > 0.
      clear tkomser2[].
* READ THE SERIALNUMBERS OF A POSITION.
      clear wa_line11-serdes.
      clear teller.


      SELECT  SERNR INTO TKOMSER2-SERNR FROM OBJK
        where obknr EQ lv_OBKNR.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = TKOMSER2-SERNR
          IMPORTING
            OUTPUT = TKOMSER2-SERNR.

        if teller = 0.
          wa_line11-SERDES =  TKOMSER2-SERNR.
        else.
          concatenate wa_line11-SERDES TKOMSER2-SERNR into wa_line11-SERDES separated by '-'.
        endif.
        add 1 to teller.
      ENDSELECT.

    endif.
  ENDIF.
*IMP RU END INSERT



  IF NOT T006A-MSEH3 IS INITIAL.
    wa_line11-DOC_UNIT = T006A-MSEH3. "DOC_UNIT.
    wa_line15-vrkme = T006A-MSEH3. "DOC_UNIT.
  ELSE.
    wa_line11-DOC_UNIT = DOC_UNIT.
    wa_line15-vrkme = DOC_UNIT.
  ENDIF.
  wa_line11-MSEHT = T006A-MSEHT.
  wa_line15-MSEHT = T006A-MSEHT.
  wa_line11-REQ_QTY = REQUESTED_QUANTITY.
  wa_line15-lsmeng = REQUESTED_QUANTITY.
  wa_line11-WITHDRAWN_QTY = Quantity_withdrawn.
  wa_line15-lfimg = Quantity_withdrawn.
  wa_line11-PRICE = PRICE.
  wa_line15-PRICE = PRICE.
  wa_line11-VALUE = Value.
  wa_line15-netwr = value.
*  wa_line15-wrbtr = value.
  wa_line11-GOODS_CHARGE = Goods_charge.
  wa_line15-charg = Goods_charge.
  wa_line11-WAERS = MSEG-WAERS.

* BAdI for line item modification
  IF m15 eq 'X'.
    CALL BADI gc_badi_m15->mm_line_item
      exporting
         i_mkpf   = mkpf
         i_mseg   = mseg
*       i_ekko   = ekko
*       i_ekpo   = ekpo
*       i_ekbe   = ekbe
      changing
         item  = wa_line15.
*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
  ENDIF.
  append wa_line11 to h_line11.
  append wa_line15 to h_line15.
  sum = sum + 1.

  if wa_line15-wrbtr is initial.
    TOTSUM = TOTSUM + wa_line15-netwr.
  else.
    TOTSUM = TOTSUM + wa_line15-wrbtr.
    totvat = totvat + wa_line15-vat.
  endif.
ENDFORM.                    "RU_AUSGABE

*---------------------------------------------------------------------*
*       FORM CLOSE_FORM                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM CLOSE_FORM.
  CHECK NOT X_OPEN IS INITIAL.
*Close the spool job
  call function 'FP_JOB_CLOSE'
*           IMPORTING
*             E_RESULT             =
   exceptions
     usage_error          = 1
     system_error         = 2
     internal_error       = 3
     others               = 4
            .
  if sy-subrc <> 0.
    message id sy-msgid type sy-msgty number sy-msgno
            with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  endif.

  CLEAR X_OPEN.
ENDFORM.                    "CLOSE_FORM

*---------------------------------------------------------------------*
*       FORM TAB001W_LESEN                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM TAB001W_LESEN.
  IF NOT T001W-WERKS = MSEG-WERKS.
    SELECT SINGLE * FROM T001W WHERE WERKS = MSEG-WERKS.
  ENDIF.
  select single spras from T002C into LANGUAGE
* IMP RU BEGIN DELETE
*     where spras = T001W-SPRAS
* IMP RU BEGIN DELETE

* IMP RU BEGIN INSERT
      where spras = 'R'
* IMP RU BEGIN INSERT
       and LAINST = 'X'.
  if sy-subrc eq 0.
    SET LANGUAGE LANGUAGE.
  else.
    LANGUAGE = sy-langu.
  endif.
ENDFORM.                    "TAB001W_LESEN

*---------------------------------------------------------------------*
*      Form  ACCOUNT_NUMBER
*---------------------------------------------------------------------*
*      account number definition
*---------------------------------------------------------------------*
FORM ACCOUNT_NUMBER.
* ##идид#ив#####ид##иж## ив### #ид# ####ив## # #ид##б┴###ив### ## б┴#######
  IF  NOT MSEG-SAKTO IS INITIAL.
    HKONTH = MSEG-SAKTO .
  ELSE.
* ############### ###ив##### #######
* #ид####им ###### - б┴####, ####ид### ############### ###ив##### ######
* ####ид#### BWMOD
    SELECT  SINGLE      * FROM  T001K
           WHERE  BWKEY  = MSEG-UMWRK.
* Table mbew - ###### ####ид####, ####ид### ###ивив ###### - BKLAS
    SELECT  SINGLE      * FROM  MBEW
           WHERE  MATNR  = MSEG-MATNR
           AND    BWKEY  = MSEG-UMWRK
           AND    BWTAR  = MSEG-BWTAR.

    CALL FUNCTION 'FI_STANDARD_ACCOUNT_DETERMINE'
         EXPORTING
             I_BKLAS              =  MBEW-BKLAS
             I_BUKRS              = T001K-BUKRS
             I_BWMOD              = T001K-BWMOD
*         I_KOMOK              = ' '
*         I_KTOPL              = ''
              I_KTOSL              = 'BSX'
*         I_MWSKZ              = ' '
*         X_TAXIT              = ' '
*         X_NO_ACCT            = ' '
*         X_NO_RULE            = ' '
        IMPORTING
             E_BSCHH              = BSCHH
             E_BSCHS              = BSCHS
             E_KONTH              = HKONTH
             E_KONTS              = HKONTS
         EXCEPTIONS
              INVALID_INPUT        = 1
              MISSING_ACCOUNT      = 2
              MISSING_POSTING_KEYS = 3
              MISSING_RULE         = 4
              MISSING_TAX_ACCOUNT  = 5
              OTHERS               = 6.
  ENDIF.
ENDFORM.                               " ACCOUNT_NUMBER
*---------------------------------------------------------------------*
*      Form  ADDRESS_WERKS
*---------------------------------------------------------------------*
*      Plant address definition
*----------------------------------------------------------------------*
FORM ADDRESS_WERKS.
  SELECT SINGLE * FROM T001 WHERE BUKRS EQ MSEG-BUKRS.
  if t001-LAND1 = 'UA'.
    select single paval from t001z into h_head11-okpo
         where bukrs eq  MSEG-BUKRS
           and   party eq 'SAPU03'.
  endif.
  if t001-LAND1 = 'KZ'.
    select single paval from t001z into h_head11-okpo
         where bukrs eq  MSEG-BUKRS
          and   party eq 'SAPK40'.
  endif.
  if t001-LAND1 = 'RU'.
    select single paval from t001z into h_head11-okpo
          where bukrs eq  MSEG-BUKRS
            and   party eq 'SAPR02'.
    select single paval from t001z into h_head15-CHIEF_ACC
          where bukrs eq  MSEG-BUKRS
            and   party eq 'SAPR15'.
  endif.
  h_head15-okpo = h_head11-okpo.
  SEL-ADDRNUMBER = t001-adrnr.

  if t001-LAND1 = 'RU'.
    sel-nation = 'R'.
  endif.
  if t001-LAND1 = 'UA'.
    sel-nation = '8'.
  endif.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      ADDRESS_SELECTION = SEL
    IMPORTING
      ADDRESS_VALUE     = ADDR_VAL
    EXCEPTIONS
      ADDRESS_NOT_EXIST = 1
      OTHERS            = 2.

  IF SY-SUBRC NE 0.
    clear SEL-NATION.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        ADDRESS_SELECTION = SEL
      IMPORTING
        ADDRESS_VALUE     = ADDR_VAL
      EXCEPTIONS
        ADDRESS_NOT_EXIST = 1
        OTHERS            = 2.
  ENDIF.

* IMP RU BEGIN DELETE
*  IF SY-SUBRC EQ 0.
*    concatenate ADDR_VAL-NAME1 ADDR_VAL-NAME2 ADDR_VAL-city1
*      ADDR_VAL-POST_CODE1 ADDR_VAL-city2 ADDR_VAL-STREET
*      addr_val-HOUSE_NUM1 text-001 ADDR_VAL-TEL_NUMBER text-002
*      ADDR_VAL-FAX_NUMBER into h_head11-CC_NAME separated by space.
*    h_head15-CC_NAME = h_head11-CC_NAME.
*
*  ELSE.
*    h_head11-CC_NAME = t001-butxt.
*    h_head15-CC_NAME = t001-butxt.
*      SYST-MSGID = 'VN'.
*      SYST-MSGNO = '203'.
*      SYST-MSGTY = 'E'.
*      SYST-MSGV1 = 'SADR'.
*      SYST-MSGV2 = SYST-SUBRC.
*      PERFORM PROTOCOL_UPDATE.
*  ENDIF.
* IMP RU END DELETE

* IMP RU BEGIN INSERT
* Seller's name

  select single adrnr into wa_adrnr from T001W
     where WERKS = MSEG-WERKS.

  select single name1 into h_head11-CC_NAME from adrc
    where ADDRNUMBER = wa_adrnr and nation = ' '.


* Recipient's Address
  SELECT SINGLE name1 stras pstlz ort01
       INTO (wa_name1, wa_stras, wa_pstlz,
                       wa_ort01)
      FROM T001W
      WHERE WERKS = MSEG-UMWRK.

  concatenate wa_name1 wa_stras wa_pstlz wa_ort01 into h_head11-RECIPIENT_ADRES separated by ','.

* Dispatcher's Address
  SELECT SINGLE name1 stras pstlz ort01
       INTO (wa_name1_r, wa_stras_r, wa_pstlz_r,
                       wa_ort01_r)
      FROM T001W
      WHERE WERKS = MSEG-WERKS.

  concatenate wa_name1_r wa_stras_r wa_pstlz_r wa_ort01_r into h_head11-DISPATCHER_ADRES separated by ','.
* IMP RU END INSERT

ENDFORM.                               " ADDRESS_WERKS
*---------------------------------------------------------------------*
*      Form  UNIT_NAME
*---------------------------------------------------------------------*
*       unit name definition
*----------------------------------------------------------------------*
FORM UNIT_NAME.
  CLEAR T006A.
  SELECT   SINGLE     * FROM  T006A
         WHERE  SPRAS  = language
         AND    MSEHI  = MSEG-MEINS .
*       and    mseht  = ___.

ENDFORM.                               " UNIT_NAME
*---------------------------------------------------------------------*
*      Form  PRICE_CALCULATION
*---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM PRICE_CALCULATION.


  if nast-kschl <> 'ZR03'.
    VALUE = MSEG-DMBTR.
  endif.

  IF  MSEG-DMBTR  IS INITIAL.
** ив#### ##б┴ ##### ### # ####
    VALUE = MSEG-SALK3 / MSEG-LBKUM * MSEG-MENGE.
  ENDIF.
  IF MSEG-MENGE = 0.
* message
  ELSE.

    if nast-kschl <> 'ZR03'.
      PRICE = VALUE / MSEG-MENGE.
    else.
      clear lv_vkorg.
      select single vkorg from t001w into lv_vkorg
      where werks = MSEG-WERKS.

      clear gv_kbetr. clear gv_konwa. clear gv_knumh.
      SELECT SINGLE knumh INTO gv_knumh FROM a954
        WHERE kappl = 'V'
          AND kschl = 'ZPRO'
          AND vkorg = lv_vkorg
          AND spart = t001w-spart
          AND matnr = mseg-matnr
          and datab <= sy-datum
          AND datbi >= sy-datum.
      IF sy-subrc = 0.
        SELECT SINGLE kbetr konwa INTO (gv_kbetr, gv_konwa)
          FROM konp WHERE knumh = gv_knumh.
        PRICE = gv_kbetr.
        VALUE = REQUESTED_QUANTITY * gv_kbetr.
      ELSE.
        PRICE = 0.
        VALUE = 0.
      ENDIF.
    endif.

  ENDIF.
ENDFORM.                               " PRICE_CALCULATION
*---------------------------------------------------------------------*
*      Form  TAB001L_LESEN
*---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM TAB001L_LESEN.
  CLEAR: STOCK_IN, STOCK_OUT, lv_txtmd_in, lv_txtmd_out.

  IF NOT T001L-WERKS = MSEG-WERKS AND NOT T001L-LGORT = MSEG-LGORT.
    SELECT    SINGLE  LGOBE FROM  T001L INTO STOCK_OUT
           WHERE  WERKS  = MSEG-WERKS
           AND    LGORT  = MSEG-LGORT.
* IMP RU begin insert
    select single TXTMD from t001w_biw into lv_txtmd_OUT
      where werks = MSEG-WERKS.
* IMP RU end insert
*      and    lgobe  = ___.
    IF NOT MSEG-UMLGO IS INITIAL.
      SELECT    SINGLE  LGOBE FROM  T001L INTO STOCK_IN
             WHERE  WERKS  = MSEG-UMWRK
             AND    LGORT  = MSEG-UMLGO.
* IMP RU begin insert
      select single TXTMD from t001w_biw into lv_txtmd_IN
        where werks = MSEG-UMWRK.
* IMP RU end insert
    ENDIF.
  ENDIF.
ENDFORM.                               " TAB001L_LESEN
*---------------------------------------------------------------------*
*      Form  REF_DEFINITION
*---------------------------------------------------------------------*
*      Reference definition for movement type
*----------------------------------------------------------------------*
* ------   RSTYP for movement type
*   A   Asset
*   U   Stock transfer
*   W   Without account assignment
*   K   Cost center
*   P   Project
*   V   Sales document
*   F   Order
*   N   Network
*   addition codes for movement types:
*   R   goods receipt 101, 521, 531
*--------------------------------------------
FORM REF_DEFINITION.
  CASE MSEG-BWART.
    WHEN '101'.
* goods receipt for order
      XSKKZ = 'R'.
    WHEN '291'.
* all account assigments
      PERFORM CHECK_REFERENCE.
    WHEN '521'.
* goods receipt w/o production order
      XSKKZ = 'R'.
    WHEN '531'.
* goods receipt of by product
      XSKKZ = 'R'.
  ENDCASE.
  IF MSEG-BWART(1) = '3' or MSEG-BWART(2) = '64'.
    XSKKZ = 'U'.
  endif.
  CASE XSKKZ.
    WHEN 'A'.
*  receiver  - number and name of fixed asset
      PERFORM ASSETTEXT_LESEN.
    WHEN 'U'.
*  receiver  - number and description of Storage Location
      PERFORM TAB001L_LESEN.
    WHEN 'W'.
*  receiver  - vendor's number and name
      PERFORM KREDITOR_LESEN.
    WHEN 'K'.
* receiver  - number and description of cost center
      PERFORM COSTCENTER_LESEN.
    WHEN 'P'.
* receiver  - number and description of WBS element
      PERFORM PROJECT_LESEN.
    WHEN 'V'.
* receiver  - customer's order number and item
    WHEN 'F'.
* receiver - order number and description
      PERFORM ORDERNUMBER_LESEN.
    WHEN 'R'.
* material receipt for  Production Order
* receiver - plant/stock,  sender - order number and description
      PERFORM ORDERNUMBER_LESEN.
    WHEN 'G'.
      PERFORM ACCOUNT_ASSIGNMENT.
  ENDCASE.
ENDFORM.                               " REF_DEFINITION

*---------------------------------------------------------------------*
*      Form  KREDITOR_LESEN
*---------------------------------------------------------------------*
*       kreditor name definition
*----------------------------------------------------------------------*
FORM KREDITOR_LESEN.
  CLEAR NAME_SUPPL.
  SELECT SINGLE  NAME1   FROM  LFA1 INTO NAME_SUPPL
         WHERE  LIFNR  = MSEG-LIFNR.

ENDFORM.                               " KREDITOR_LESEN
*&---------------------------------------------------------------------*
*&      Form  COSTCENTER_LESEN
*&---------------------------------------------------------------------*
*       cost center definition
*----------------------------------------------------------------------*
FORM COSTCENTER_LESEN.
  CLEAR COST_TEXT.
  SELECT SINGLE   KTEXT  FROM  CSKT INTO COST_TEXT
         WHERE  SPRAS  = SY-LANGU
         AND    KOKRS  = MSEG-KOKRS
         AND    KOSTL  = MSEG-KOSTL.

ENDFORM.                               " COSTCENTER_LESEN
*&---------------------------------------------------------------------*
*&      Form  PROJECT_LESEN
*&---------------------------------------------------------------------*
*       Work breakdown structure element (WBS element) - text
*----------------------------------------------------------------------*
FORM PROJECT_LESEN.
  CLEAR: PROJECT_NUMBER, PROJECT_TEXT.
  SELECT SINGLE  POSID POST1
    INTO  (PROJECT_NUMBER, PROJECT_TEXT)
    FROM  PRPS
    WHERE  PSPNR = MSEG-PS_PSP_PNR.
ENDFORM.                               " PROJECT_LESEN
*---------------------------------------------------------------------*
*      Form  ORDERNUMBER_LESEN
*---------------------------------------------------------------------*
*      order number definition
*----------------------------------------------------------------------*
FORM ORDERNUMBER_LESEN.
  CLEAR ORDER_TEXT.
  SELECT SINGLE  KTEXT  FROM  AUFK INTO ORDER_TEXT
         WHERE  AUFNR  = MSEG-AUFNR.

ENDFORM.                               " ORDERNUMBER_LESEN
*---------------------------------------------------------------------*
*      Form  ASSETTEXT_LESEN
*---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM ASSETTEXT_LESEN.
  CLEAR ASSET_TXT.
  SELECT   SINGLE  ANLHTXT  FROM  ANLH INTO ASSET_TXT
         WHERE  BUKRS    = MSEG-BUKRS
         AND    ANLN1    = MSEG-ANLN1 .

ENDFORM.                    " ASSETTEXT_LESEN

*---------------------------------------------------------------------*
*      Form  CHECK_REFERENCE
*---------------------------------------------------------------------*
*      all account assigments
*----------------------------------------------------------------------*
FORM CHECK_REFERENCE.
  XSKKZ = 'A'.
  CHECK MSEG-ANLN1 IS INITIAL.
  XSKKZ = 'F'.
  CHECK MSEG-AUFNR IS INITIAL.
  XSKKZ = 'K'.
  CHECK MSEG-KOSTL IS INITIAL.
  XSKKZ = 'P'.
  CHECK MSEG-PS_PSP_PNR IS INITIAL.
  XSKKZ = 'V'.
  CHECK MSEG-KDAUF IS INITIAL.
  CHECK NOT MSEG-SAKTO IS INITIAL.
  XSKKZ = 'G'.
ENDFORM.                    " CHECK_REFERENCE

*---------------------------------------------------------------------*
*      Form  NEW_NAMES
*---------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
FORM NEW_NAMES.
*---------  header info  ---------------
  DOC_NUMBER           = MKPF-MBLNR.
  if nast-kschl = 'ZR03'.
    DOC_DATA             = MKPF-BUDAT.
  else.
    DOC_DATA             = MKPF-BLDAT.
  endif.
  MOVEMENT_TYPE        = MSEG-BWART.
  STOCK                = MSEG-LGORT.
  PLANT                = MSEG-WERKS.
  INSTOCK              = MSEG-UMLGO.
  INPLANT              = MSEG-UMWRK.
  ASSET_NUMBER         = MSEG-ANLN1.
  SUPPLIER             = MSEG-LIFNR.
  COST_CENTER          = MSEG-KOSTL.
*PROJECT_NUMBER       = MSEG-PS_PSP_PNR.
  CUSTOMER_ORDER       = MSEG-KDAUF.
  ORDER_POS            = MSEG-KDPOS.
  ORDER                = MSEG-AUFNR.
*---------  lines  info  ---------------
  MATNR                = MSEG-MATNR.
  DOC_UNIT             = MSEG-MEINS.
  REQUESTED_QUANTITY   = MSEG-MENGE.
  QUANTITY_WITHDRAWN   = MSEG-MENGE.
  VALUE                = MSEG-DMBTR.
  GOODS_CHARGE         = MSEG-CHARG.


ENDFORM.                    " NEW_NAMES

*&---------------------------------------------------------------------*
*&      Form  print_FORM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM print_FORM .
  DATA: func_module_name     TYPE rs38l_fnam.
  DATA: fp_docparams      type sfpdocparams,
        l_errstr type string.
*data : w_cx_root  TYPE REF TO CX_ROOT,
*       mesg TYPE STRING.

  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      AMOUNT    = totsum
      CURRENCY  = mseg-waers
      FILLER    = ' '
      LANGUAGE  = language
    IMPORTING
      IN_WORDS  = SPELL
    EXCEPTIONS
      NOT_FOUND = 1
      TOO_LARGE = 2
      OTHERS    = 3.
  if ( mseg-waers = 'RUR' or mseg-waers = 'RUB' ).
    concatenate SPELL-WORD SPELL-DECIMAL(2) text-010
       into h_head15-tot_sum separated by space.
  endif.
  if mseg-waers = 'KZT'.
    concatenate SPELL-WORD text-011 SPELL-DECIMAL(2) text-012
       into h_head15-tot_sum separated by space.
  endif.
*******  number of lines for M-15
  CALL FUNCTION 'SPELL_AMOUNT'
    EXPORTING
      AMOUNT    = SUM
      CURRENCY  = 'ZCURR'        "Oeeoeaiay aae?oa aey i?aaeeu-
      FILLER    = ' '            "iie ?aaiou SPELL
      LANGUAGE  = language
    IMPORTING
      IN_WORDS  = SPELL
    EXCEPTIONS
      NOT_FOUND = 1
      TOO_LARGE = 2
      OTHERS    = 3.
  h_head15-TOT_NAMES = SPELL-WORD.
*******
  if not totsum is initial.
    MM = TRUNC( TOTVAT ).    "rub
    CONDENSE MM NO-GAPS.
    NN(2) = FRAC( TOTVAT ).  "kop
    CONDENSE NN NO-GAPS.

    concatenate mm text-011 nn text-012
      into h_head15-tot_vat separated by space.
  endif.

* BAdI for header line modification
  IF m15 eq 'X'.
    CALL BADI gc_badi_m15->mm_header_line
      exporting
         i_mkpf   = mkpf
*           i_mseg   = mseg
*           i_ekko   = ekko
*           i_ekpo   = ekpo
*           i_ekbe   = ekbe
      changing
         head  = h_head15.
*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
  ENDIF.

  perform read_fm using TNAPR-SFORM
                    changing func_module_name.

* Call the generated functional module
* set locale RU_ru
  if language = 'R'.
    fp_docparams-langu = 'R'.
    fp_docparams-country = 'RU'.
  endif.
  call function func_module_name
    EXPORTING
      /1bcdwb/docparams   = fp_docparams
      headm15              = h_head15
      itemsm15             = h_line15
      headm11              = h_head11
      itemsm11             = h_line11
*  IMPORTING
*    /1bcdwb/formoutput   =
    EXCEPTIONS
      usage_error     = 1
      system_error    = 2
      internal_error  = 3.

  if sy-subrc <> 0.
    CALL FUNCTION 'FP_GET_LAST_ADS_ERRSTR'
      IMPORTING
        E_ADSERRSTR = l_errstr.
  endif.

ENDFORM.                    " print_FORM

*&---------------------------------------------------------------------*
*&     Form SHIP_TO_ADDRESS_DATA_print.              #10
*&---------------------------------------------------------------------*
*       Printing of the address data of ship-to debtor                 *
*----------------------------------------------------------------------*

FORM SHIP_TO_ADDRESS_DATA.

  clear sel.
  SELECT SINGLE ADRNR FROM KNA1 into SEL-ADDRNUMBER "Search ship-to
  WHERE KUNNR EQ mseg-KUNNR.

  if t001-land1 = 'RU'.
    sel-nation = 'R'.
  endif.
  if t001-land1 = 'UA'.
    sel-nation = '8'.
  endif.
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      ADDRESS_SELECTION = SEL
    IMPORTING
      address_value     = addr_val
    EXCEPTIONS
      PARAMETER_ERROR   = 1
      ADDRESS_NOT_EXIST = 2
      VERSION_NOT_EXIST = 3
      INTERNAL_ERROR    = 4
      OTHERS            = 5.
  if sy-subrc ne 0.
    clear sel-nation.
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        ADDRESS_SELECTION = SEL
      IMPORTING
        address_value     = addr_val
      EXCEPTIONS
        PARAMETER_ERROR   = 1
        ADDRESS_NOT_EXIST = 2
        VERSION_NOT_EXIST = 3
        INTERNAL_ERROR    = 4
        OTHERS            = 5.
  endif.
  if sy-subrc eq 0.
    concatenate addr_val-name1 addr_val-name2
      addr_val-CITY1 addr_val-POST_CODE1 addr_val-CITY2
      addr_val-street addr_val-HOUSE_NUM1 text-001
      addr_val-TEL_NUMBER text-002 addr_val-FAX_NUMBER
            into h_head15-kn_name separated by space.
  endif.

ENDFORM.                               " SHIP_TO_ADDRESS_DATA

*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*

FORM PROTOCOL_UPDATE.

  CHECK XSCREEN = SPACE.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      MSG_ARBGB = SYST-MSGID
      MSG_NR    = SYST-MSGNO
      MSG_TY    = SYST-MSGTY
      MSG_V1    = SYST-MSGV1
      MSG_V2    = SYST-MSGV2
      MSG_V3    = SYST-MSGV3
      MSG_V4    = SYST-MSGV4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE

*&---------------------------------------------------------------------*
*&      Form  read_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_TNAPR_SFORM  text
*      <--P_FUNC_MODULE_NAME  text
*----------------------------------------------------------------------*
FORM read_fm USING    P_TNAPR_SFORM
                   CHANGING P_FUNC_MODULE_NAME.

* determine the name of the generated function module
*
  TRY.
      CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
        EXPORTING
          i_name     = P_TNAPR_SFORM
        IMPORTING
          e_funcname = P_FUNC_MODULE_NAME.
    CATCH cx_fp_api.
  ENDTRY.

  IF P_FUNC_MODULE_NAME IS INITIAL.
    message id 'FB' type 'I' number sy-msgno
            with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " read_smart_fm
*&---------------------------------------------------------------------*
*&      Form  ON_CHANGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM ON_CHANGE .
  if XKOPFDR eq 'X'.
    PERFORM print_FORM.
    clear h_head15. clear h_line15. refresh h_line15.
    clear h_head11. clear h_line11. refresh h_line11.
    clear totsum. clear sum. clear totvat.
  endif.
ENDFORM.               " ON_CHANGE

*&---------------------------------------------------------------------*
*&      Form  FILL_HEADER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM FILL_HEADER.
  PERFORM ADDRESS_WERKS.
  clear ekko.
  select SINGLE * from ekko
    WHERE EBELN = MSEG-EBELN.
  if sy-subrc eq 0.
    concatenate text-008 ekko-ebeln text-009 ekko-aedat
       into h_head15-ground separated by space.
  endif.
  CASE XSKKZ.
    WHEN 'A'.
*fixed asset number expenses
*receiver  - fixed asset number and text
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*      h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change
      h_head11-RECIPIENT = ASSET_number.
      h_head11-RECIP_ACT = ASSET_txt.
    WHEN  'U'.
*stock transfer
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*     h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change

      concatenate INSTOCK text-003 INPLANT into h_head11-RECIPIENT.
* IMP RU begin change
*     h_head11-RECIP_ACT = STOCK_in.
      concatenate  lv_txtmd_in '/' stock_in into h_head11-RECIP_ACT.
* IMP RU end change
    WHEN  'W'.
*goods receipt w/o order
      h_head11-SENDER = SUPPLIER.
      h_head11-SENDER_ACT = NAME_SUPPL.
      concatenate STOCK text-003 PLANT into h_head11-RECIPIENT.
* IMP RU begin change
*      h_head11-RECIP_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-RECIP_ACT.
* IMP RU end change
    WHEN  'K'.
*cost center expenses
*sender - plant/stock, storage location description
*receiver - cost center, description
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*      h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change
      concatenate text-004 COST_CENTER into h_head11-RECIPIENT.
      h_head11-RECIP_ACT = COST_text.
    WHEN  'P'.
*expenses for project
*sender - plant/stock, storage location description
*receiver  - number and description of WBS element
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*      h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change

      h_head11-RECIPIENT = PROJECT_NUMBER.
      h_head11-RECIP_ACT = PROJECT_TEXT.
    WHEN  'V'.
*expenses for customer order
*sender - plant/stock, storage location description
*receiver - customer's order number and item
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*     h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change
      h_head11-RECIPIENT = CUSTOMER_ORDER.
      h_head11-RECIP_ACT = ORDER_POS.
    WHEN  'F'.
*expenses for production order
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*     h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change
      if nast-kschl = 'ZR03'.
        clear lv_vaplz.
        select single vaplz from aufk into (lv_vaplz)
          where aufnr = mseg-aufnr.
*     select single lgort from crhd into lv_lgort
*       where werks = mseg-werks and arbpl = lv_vaplz.
        select single objid from crhd into lv_objid
          where arbpl = lv_vaplz and werks = mseg-werks.
*
        select single ktext from crtx into h_head11-RECIP_ACT
          where  objid = lv_objid and spras = 'R'.

        concatenate PLANT text-003 lv_vaplz into h_head11-RECIPIENT.

*     select single LGOBE from t001l into h_head11-RECIP_ACT
*       where werks = mseg-werks and LGORT = lv_lgort.
      else.
        concatenate text-005 ORDER into h_head11-RECIPIENT.
        h_head11-RECIP_ACT = ORDER_text.
      endif.
    WHEN  'R'.
*goods receipt of by production order:
*receiver - plant/stock,  sender - order number and description
      concatenate text-005 ORDER into h_head11-SENDER.
      h_head11-SENDER_ACT = ORDER_text.
      concatenate STOCK text-003 PLANT into h_head11-RECIPIENT.
* IMP RU begin change
*      h_head11-RECIP_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-RECIP_ACT.
* IMP RU end change
    WHEN 'G'.
      concatenate STOCK text-003 PLANT into h_head11-SENDER.
* IMP RU begin change
*      h_head11-SENDER_ACT = STOCK_out.
      concatenate  lv_txtmd_out '/' stock_out into h_head11-SENDER_ACT.
* IMP RU end change

      h_head11-RECIP_ACT = ACCOUNT_TXT.
      h_head11-RECIPIENT = MSEG-SAKTO.
    WHEN OTHERS.

  ENDCASE.
  if not mseg-kunnr is initial.
    perform ship_to_address_data.
  endif.
  if nast-kschl = 'ZR03'.
* find ASSO, so and seo number

    CLEAR LV_KDAUF.
    CLEAR LV_KDPOS.
    CLEAR LV_ASSO.
    CLEAR LV_AUFNR.

    SELECT single KDAUF KDPOS INTO (LV_KDAUF, LV_KDPOS) FROM AUFK
          WHERE AUFNR = MSEG-AUFNR.

    SELECT SINGLE vbeln INTO lv_ASSO FROM vbfa
          WHERE vbelv =  LV_KDAUF
          AND posnv = LV_KDPOS
          AND vbtyp_n = 'C'.


CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = LV_ASSO
          IMPORTING
            OUTPUT = LV_ASSO.

CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = LV_KDAUF
          IMPORTING
            OUTPUT = LV_KDAUF.

CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = MSEG-AUFNR
          IMPORTING
            OUTPUT = LV_AUFNR.

    if  LV_ASSO is initial.
      concatenate 'Service Order: ' LV_AUFNR ', Service Sales Order: ' LV_KDAUF   into h_head11-THROUGH.
    else.
      concatenate 'Service Order: ' LV_AUFNR ', Service Sales Order: ' LV_KDAUF ', ASSO: ' LV_ASSO   into h_head11-THROUGH.
    endif.
  endif.

  h_head15-SEND_SUB = h_head11-SENDER.
  h_head15-SEND_ACT = h_head11-SENDER_ACT.
  h_head15-REC_SUB = h_head11-RECIPIENT.
  h_head15-REC_ACT = h_head11-RECIP_ACT.
  h_head11-MBLNR = DOC_NUMBER.
  h_head15-vbeln = DOC_NUMBER.
  h_head11-BUKRS = MSEG-BUKRS.
  h_head11-BUDAT = DOC_DATA.
  h_head15-wadat = DOC_DATA.
  h_head11-LAND1 = t001-LAND1.
  h_head15-LAND1 = t001-LAND1.
  h_head11-BWART = MOVEMENT_TYPE.
  h_head15-oper = MOVEMENT_TYPE.
  h_head11-DOC_NUMBER = DOC_NUMBER.
  IF ( MSEG-WAERS = 'RUR' OR MSEG-WAERS = 'RUB' ).
    h_head11-P_VAL = text-006.
    h_head15-P_VAL = text-006.
  ENDIF.
  IF MSEG-WAERS = 'KZT'.
    h_head11-P_VAL = text-007.
    h_head15-P_VAL = text-007.
  ENDIF.
  h_head11-USER_NAME = USER_NAME.

* IMP RU BEGIN INSERT

  select single le_vbeln into h_head11-outbound_NBR from mkpf
    where mblnr = MSEG-mblnr and
          mjahr = MSEG-mjahr.

  if   h_head11-outbound_NBR is initial.
    select single vbeln into h_head11-outbound_NBR from lips
    where vgbel = MSEG-EBELN and
          vgpos = MSEG-EBELP.
  endif.

* IMP RU END INSERT

ENDFORM.                    " FILL_HEADER
*&---------------------------------------------------------------------*
*&      Form  ACCOUNT_ASSIGNMENT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM ACCOUNT_ASSIGNMENT .
  DATA spras TYPE SKAT-SPRAS.
  SELECT SINGLE * FROM SKA1
    WHERE KTOPL = T001-KTOPL
      AND SAKNR = MSEG-SAKTO.
  CLEAR ACCOUNT_TXT.
  SELECT SINGLE TXT20
  INTO ACCOUNT_TXT
  FROM SKAT
    WHERE SPRAS = LANGUAGE
      AND KTOPL = T001-KTOPL
      AND SAKNR = SKA1-SAKNR.
  IF SY-SUBRC NE 0.
    IF NOT NAST-SPRAS IS INITIAL.
      SELECT SINGLE TXT20
        INTO ACCOUNT_TXT
        FROM SKAT
       WHERE SPRAS = NAST-SPRAS
         AND KTOPL = T001-KTOPL
         AND SAKNR = SKA1-SAKNR
         AND TXT20 > SPACE .
    ENDIF.

    IF SY-SUBRC NE 0 OR NAST-SPRAS IS INITIAL.
      SELECT SINGLE TXT20
      INTO ACCOUNT_TXT
      FROM SKAT
        WHERE SPRAS = SY-LANGU
          AND KTOPL = T001-KTOPL
          AND SAKNR = SKA1-SAKNR.
      IF SY-SUBRC NE 0.
*     Ersatzsprache D bzw. E
        IF SY-LANGU = 'D'.
          SPRAS = 'E'.
        ELSE.
          SPRAS = 'D'.
        ENDIF.
        SELECT SINGLE TXT20
        INTO ACCOUNT_TXT
        FROM SKAT
          WHERE SPRAS = SPRAS
            AND KTOPL = T001-KTOPL
            AND SAKNR = SKA1-SAKNR.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    " ACCOUNT_ASSIGNMENT
*&---------------------------------------------------------------------*
*&      Form  FILL_OUTPUTPARAMS_PDF
*&---------------------------------------------------------------------*
*      -->IS_ITCPO TYPE ITCPO
*      <--XS_OUTPUTPARAMS TYPE SFPOUTPUTPARAMS
*----------------------------------------------------------------------*
FORM FILL_OUTPUTPARAMS_PDF
                      USING    IS_ITCPO TYPE ITCPO
                      CHANGING XS_OUTPUTPARAMS TYPE SFPOUTPUTPARAMS.
  CLEAR XS_OUTPUTPARAMS-NOPRINT.
  XS_OUTPUTPARAMS-NOPRIBUTT = XS_OUTPUTPARAMS-NODIALOG = xscreen.
  XS_OUTPUTPARAMS-DEVICE     = IS_ITCPO-TDPRINTER.
  XS_OUTPUTPARAMS-PREVIEW    = IS_ITCPO-TDPREVIEW.
  XS_OUTPUTPARAMS-DEST       = IS_ITCPO-TDDEST.
  XS_OUTPUTPARAMS-REQNEW     = IS_ITCPO-TDNEWID.
  XS_OUTPUTPARAMS-REQIMM     = IS_ITCPO-TDIMMED.
  XS_OUTPUTPARAMS-REQDEL     = IS_ITCPO-TDDELETE.
  XS_OUTPUTPARAMS-REQFINAL   = IS_ITCPO-TDFINAL.
  XS_OUTPUTPARAMS-SENDDATE   = IS_ITCPO-TDSENDDATE.
  XS_OUTPUTPARAMS-SENDTIME   = IS_ITCPO-TDSENDTIME.
  XS_OUTPUTPARAMS-SCHEDULE   = IS_ITCPO-TDSCHEDULE.
  XS_OUTPUTPARAMS-COPIES     = IS_ITCPO-TDCOPIES.
  XS_OUTPUTPARAMS-DATASET    = IS_ITCPO-TDDATASET.
  XS_OUTPUTPARAMS-SUFFIX1    = IS_ITCPO-TDSUFFIX1.
  XS_OUTPUTPARAMS-SUFFIX2    = IS_ITCPO-TDSUFFIX2.
  XS_OUTPUTPARAMS-COVTITLE   = IS_ITCPO-TDCOVTITLE.
  XS_OUTPUTPARAMS-COVER      = IS_ITCPO-TDCOVER.
  XS_OUTPUTPARAMS-RECEIVER   = IS_ITCPO-TDRECEIVER.
  XS_OUTPUTPARAMS-DIVISION   = IS_ITCPO-TDDIVISION.
  XS_OUTPUTPARAMS-LIFETIME   = IS_ITCPO-TDLIFETIME.
  XS_OUTPUTPARAMS-AUTHORITY  = IS_ITCPO-TDAUTORITY.
  XS_OUTPUTPARAMS-RQPOSNAME  = IS_ITCPO-RQPOSNAME.
  XS_OUTPUTPARAMS-ARCMODE    = IS_ITCPO-TDARMOD.
  XS_OUTPUTPARAMS-NOARMCH    = IS_ITCPO-TDNOARMCH.
  XS_OUTPUTPARAMS-TITLE      = IS_ITCPO-TDTITLE.
  XS_OUTPUTPARAMS-NOPREVIEW  = IS_ITCPO-TDNOPREV.

ENDFORM.                    " fill_outputparams_PDF

*Text symbol textг║
*001:t.
*002:f.
*003:/
*004:CostC
*005:Ord.
*006:rub.kop.
*007:tenge,tiyn
*008:Order No
*009:of
*010:kop.
*011:tenge
*012:tiyn
