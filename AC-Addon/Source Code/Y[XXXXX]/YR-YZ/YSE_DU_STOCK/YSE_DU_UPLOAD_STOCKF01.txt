*----------------------------------------------------------------------*
*   INCLUDE YSE_DU_UPLOAD_STOCKF01                                     *
*----------------------------------------------------------------------*
*
************************************************************************
* Program ID           : yse_du_stock                                  *
* Program Title        : DATA Upload stock                             *
* Author               : air22210                                      *
* Date                 : 05.02.2007                                    *
* Development Number:    D246- S500 - Stock upload                     *
* Description          :                                               *
*----------------------------------------------------------------------*

FORM initialize.

  REFRESH: i_stock,
           i_stock_tmp,
           i_stock_fig,
           i_gm_item_all,
           i_dummy_so,
*           i_conv_mat,   air22210
           i_conv_pc,
           i_ser,
           i_spa,
           i_bmseg,
           i_ldk33,
           i_mard,
           i_marc,
           i_mchb,
           i_mslb,
           i_mkol,
           i_mska,
           i_mbew,
           i_mseg_ok,
           i_mseg_er.

  CLEAR:   i_stock,
           i_stock_tmp,
           i_stock_fig,
           i_gm_item_all,
           i_dummy_so,
*           i_conv_mat,      air22210
           i_conv_pc,
           i_ser,
           i_spa,
           i_bmseg,
           i_ldk33,
           i_mard,
           i_marc,
           i_mchb,
           i_mslb,
           i_mkol,
           i_mska,
           i_mbew,
           i_mseg_ok,
           i_mseg_er.

  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system = v_own_logsys.

  SELECT *
    INTO TABLE i_dummy_so
    FROM yse_du_ph_dumyso.
*    FROM yph_dummy_so.      air22210
*
*  SELECT *
*    INTO TABLE i_conv_mat             air2210
*    FROM zcimatconv_mat.

  SELECT *
    INTO TABLE i_conv_pc
    FROM yse_du_prof_ctr.

ENDFORM.                    "initialize

*&---------------------------------------------------------------------*
*&      Form  AT_SELECTION_SCREEN
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM at_selection_screen.

*  IF p_error = c_true.
*    MESSAGE e000 WITH 'Fill out the selection screen correctly'
*                      '!'
*                      ' '
*                      ' '.
*  ENDIF.

*  IF ( p_im = c_true OR p_spa = c_true OR p_clr = c_true ) AND
*      p_wm = c_false.
*    IF p_unres = c_false AND p_cons = c_false AND p_sub = c_false AND
*       p_cust  = c_false.
*      MESSAGE e000 WITH 'Fill out the selection screen correctly'
*                        '!'
*                        ' '
*                        ' '.
*    ENDIF.
*
*    IF p_logsys IS INITIAL OR p_gmcode IS INITIAL.
*      MESSAGE e000 WITH 'Fill out the selection screen correctly'
*                        '!'
*                        ' '
*                        ' '.
*    ENDIF.
*  ENDIF.
*
*  IF p_wm = c_true AND p_im = c_false AND
*     p_spa = c_false AND p_clr = c_false.
*    IF p_group = c_false OR p_file = c_false.
*      MESSAGE e000 WITH 'Fill out the selection screen correctly'
*                        '!'
*                        ' '
*                        ' '.
*    ENDIF.
*  ENDIF.
ENDFORM.                    " AT_SELECTION_SCREEN

*&---------------------------------------------------------------------*
*&      Form  START_OF_SELECTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM start_of_selection.

  PERFORM initialize.

  IF p_im = c_true OR p_spa = c_true.

    IF p_error = c_false.
*     Download IM Stock figures
      PERFORM download_im_stock.
    ELSE.
*     Re-process IM stock errors
      PERFORM re_process_im_errors.
    ENDIF.

  ELSEIF p_ufig = c_true.

*   Use Stock Figures Table for the selection
    PERFORM use_stock_fig_table.

  ELSEIF p_clr = c_true.

*   Clear IM stock figures
    PERFORM clear_im_stock.

  ELSEIF p_wm = c_true.

*   Download WM Stock figures
    PERFORM download_wm_stock.

  ELSEIF p_clr_fg = c_true.

*   Clear YSE_DU_STOCKFIG table
    DELETE FROM yse_du_stockfig CLIENT SPECIFIED
      WHERE mandt  EQ sy-mandt
        AND logsys EQ v_own_logsys
        AND matnr  IN s_matnr
        AND charg  IN s_charg
        AND werks  IN s_werks
        AND lgort  IN s_lgort
        AND prdha  IN s_prdha.

  ELSEIF p_clr_st = c_true.

*   Clear YSE_DU_STOCKLIST table
    DELETE FROM yse_du_stocklist CLIENT SPECIFIED
      WHERE mandt = sy-mandt
        AND logsys EQ v_own_logsys
        AND matnr  IN s_matnr
        AND charg  IN s_charg
        AND werks  IN s_werks
        AND lgort  IN s_lgort
        AND prdha  IN s_prdha
        AND test   EQ p_test.

  ENDIF.

ENDFORM.                    " START_OF_SELECTION

*&---------------------------------------------------------------------*
*&      Form  INITIALIZATION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM initialization.

  PERFORM initialize_s_werks.

  PERFORM initialize_s_lgort.

ENDFORM.                    " INITIALIZATION

*&---------------------------------------------------------------------*
*&      Form  download_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_im_stock.

  IF p_spa = c_true.
    PERFORM select_spare_parts.
  ENDIF.

  IF p_ufile = c_true.
*   PERFORM upload_file USING 'ABEC'.
    PERFORM upload_file USING 'FLAT'.                       " AIR21777
    PERFORM update_stockfig_from_file.
  ELSE.
    PERFORM download_normal_im_stock.

    PERFORM download_subcontractor_im_stoc.

    PERFORM download_customer_stock.

    PERFORM fill_stock_figures_table.
  ENDIF.

ENDFORM.                    " download_im_stock

*&---------------------------------------------------------------------*
*&      Form  download_wm_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_wm_stock.

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE i_lqua
    FROM mara INNER JOIN lqua
                ON lqua~matnr = mara~matnr
    WHERE mara~mtart IN s_mtart
      AND mara~matnr IN s_matnr
      AND mara~prdha IN s_prdha
      AND lqua~charg IN s_charg
      AND lqua~werks IN s_werks
      AND lqua~lgort IN s_lgort
      AND lqua~lgnum IN s_lgnum
      AND lqua~gesme GT 0.

  LOOP AT i_lqua ASSIGNING <fx_lqua>.
    MOVE-CORRESPONDING <fx_lqua> TO i_ldk33.

    i_ldk33-lsonr = <fx_lqua>-sonum.

    APPEND i_ldk33.
  ENDLOOP.

  PERFORM create_output_file_wm_stock.

ENDFORM.                    " download_wm_stock

*&---------------------------------------------------------------------*
*&      Form  initialize_s_werks
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM initialize_s_werks.

*  s_werks-sign = 'I'.
*  s_werks-option = 'EQ'.
*
*  s_werks-low = '73AG'.
*  APPEND s_werks.
*
*  s_werks-low = 'AGW1'.
*  APPEND s_werks.

ENDFORM.                    " initialize_s_werks

*&---------------------------------------------------------------------*
*&      Form  initialize_s_lgort
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM initialize_s_lgort.

*  s_lgort-sign = 'I'.
*  s_lgort-option = 'EQ'.
*
*  s_lgort-low = 'GE04'.
*  APPEND s_lgort.

ENDFORM.                    " initialize_s_lgort

*&---------------------------------------------------------------------*
*&      Form  download_other_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_other_im_stock.

  CLEAR: i_bmseg.

  i_bmseg-mappe = p_group.
  i_bmseg-tcode = 'MB1C'.
  i_bmseg-bldat = p_date.
  i_bmseg-budat = p_date.
  i_bmseg-matnr = <fx_mard>-matnr.
  i_bmseg-werks = <fx_mard>-werks.
  i_bmseg-lgort = <fx_mard>-lgort.
  i_bmseg-erfme = <fx_mard>-meins.

* Unrestricted stock
  IF <fx_mard>-labst NE 0 AND p_unres = c_true.
    i_bmseg-erfmg = <fx_mard>-labst.
    i_bmseg-bwart = p_bwart.

    CLEAR: i_bmseg-insmk.

    PERFORM append_i_bmseg.
  ENDIF.

* Quality and Blocked stock
  IF ( <fx_mard>-insme NE 0 OR <fx_mard>-speme NE 0 ) AND
     p_unres = c_true.
    i_bmseg-erfmg = <fx_mard>-insme + <fx_mard>-speme.
    i_bmseg-bwart = p_bwartb.
    i_bmseg-insmk = 'S'.

    PERFORM append_i_bmseg.
  ENDIF.

* Consignment stock
  IF <fx_mard>-klabs NE 0.
    PERFORM download_consignment_im_stock.
  ENDIF.

ENDFORM.                    " download_other_im_stock

*&---------------------------------------------------------------------*
*&      Form  download_batch_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_batch_im_stock.

  CHECK: p_unres = c_true.

  CLEAR: i_bmseg.

  i_bmseg-mappe = p_group.
  i_bmseg-tcode = 'MB1C'.
  i_bmseg-bldat = p_date.
  i_bmseg-budat = p_date.

  LOOP AT i_mchb ASSIGNING <fx_mchb> WHERE matnr = <fx_mard>-matnr
                                       AND werks = <fx_mard>-werks
                                       AND lgort = <fx_mard>-lgort.
    i_bmseg-matnr = <fx_mchb>-matnr.
    i_bmseg-werks = <fx_mchb>-werks.
    i_bmseg-lgort = <fx_mchb>-lgort.
    i_bmseg-charg = <fx_mchb>-charg.
    i_bmseg-erfme = <fx_mard>-meins.

*   Unrestricted stock
    IF <fx_mchb>-clabs NE 0.
      i_bmseg-erfmg = <fx_mchb>-clabs.
      i_bmseg-bwart = p_bwart.

      CLEAR: i_bmseg-insmk.

      PERFORM append_i_bmseg.
    ENDIF.

*   Quality and Blocked stock
    IF <fx_mchb>-cinsm NE 0 OR <fx_mchb>-cspem NE 0.
      i_bmseg-erfmg = <fx_mchb>-cinsm + <fx_mchb>-cspem.
      i_bmseg-bwart = p_bwartb.
      i_bmseg-insmk = 'S'.

      PERFORM append_i_bmseg.
    ENDIF.
  ENDLOOP.
ENDFORM.                    " download_batch_im_stock

*&---------------------------------------------------------------------*
*&      Form  download_consignment_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_consignment_im_stock.

  CHECK: p_cons = c_true.

  CLEAR: i_bmseg.

  i_bmseg-mappe = p_group.
  i_bmseg-tcode = 'MB1C'.
  i_bmseg-bldat = p_date.
  i_bmseg-budat = p_date.
  i_bmseg-sobkz = 'K'.
  i_bmseg-erfme = <fx_mard>-meins.

  LOOP AT i_mkol ASSIGNING <fx_mkol> WHERE matnr = <fx_mard>-matnr
                                       AND werks = <fx_mard>-werks
                                       AND lgort = <fx_mard>-lgort.

    i_bmseg-matnr = <fx_mkol>-matnr.
    i_bmseg-werks = <fx_mkol>-werks.
    i_bmseg-lgort = <fx_mkol>-lgort.
    i_bmseg-charg = <fx_mkol>-charg.
    i_bmseg-lifnr = <fx_mkol>-lifnr.

*   Unrestricted consignment stock
    IF <fx_mkol>-slabs NE 0.
      i_bmseg-erfmg = <fx_mkol>-slabs.
      i_bmseg-bwart = p_bwart.

      CLEAR: i_bmseg-insmk.

      PERFORM append_i_bmseg.
    ENDIF.

*   Quality and blocked consignment stock
    IF <fx_mkol>-sinsm NE 0 OR <fx_mkol>-sspem NE 0.
      i_bmseg-erfmg = <fx_mkol>-sinsm + <fx_mkol>-sspem.
      i_bmseg-bwart = p_bwartb.
      i_bmseg-insmk = 'S'.

      PERFORM append_i_bmseg.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " download_consignment_im_stock

*&---------------------------------------------------------------------*
*&      Form  download_normal_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_normal_im_stock.

  IF p_ufile = c_true.
    PERFORM upload_file USING 'UNRES'.

    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_mard
      FROM mara INNER JOIN mard
                  ON mard~matnr = mara~matnr
      FOR ALL entries IN i_unres
      WHERE mara~mtart IN s_mtart
        AND mara~prdha IN s_prdha
        AND mara~matnr EQ i_unres-matnr
        AND mard~werks EQ i_unres-werks
        AND mard~lgort EQ i_unres-lgort
        AND ( mard~labst NE 0 OR
              mard~insme NE 0 OR
              mard~speme NE 0 OR
              mard~klabs NE 0 ).
  ELSE.
    IF p_spa = c_false.
      SELECT *
        INTO CORRESPONDING FIELDS OF TABLE i_mard
        FROM mara INNER JOIN mard
                    ON mard~matnr = mara~matnr
        WHERE mara~mtart IN s_mtart
          AND mara~matnr IN s_matnr
          AND mara~prdha IN s_prdha
          AND mard~werks IN s_werks
          AND mard~lgort IN s_lgort
          AND ( mard~labst NE 0 OR
                mard~insme NE 0 OR
                mard~speme NE 0 OR
                mard~klabs NE 0 ).
    ELSEIF p_spa = c_true.
      CHECK NOT i_spa[] IS INITIAL.

      SELECT *
        INTO CORRESPONDING FIELDS OF TABLE i_mard
        FROM mara INNER JOIN mard
                    ON mard~matnr = mara~matnr
        FOR ALL entries IN i_spa
        WHERE mara~mtart IN s_mtart
          AND mara~matnr EQ i_spa-matnr
          AND mara~matnr IN s_matnr
          AND mara~prdha IN s_prdha
          AND mard~werks IN s_werks
          AND mard~lgort IN s_lgort
          AND ( mard~labst NE 0 OR
                mard~insme NE 0 OR
                mard~speme NE 0 OR
                mard~klabs NE 0 ).
    ENDIF.
  ENDIF.

  IF sy-subrc = 0.
    SELECT *
      INTO TABLE i_marc
      FROM marc
      FOR ALL ENTRIES IN i_mard
      WHERE matnr = i_mard-matnr
        AND werks = i_mard-werks.

    IF p_cons = c_true.
      SELECT *
        INTO TABLE i_mkol
        FROM mkol
        FOR ALL ENTRIES IN i_mard
        WHERE matnr = i_mard-matnr
          AND werks = i_mard-werks.
    ENDIF.

    SELECT *
      INTO TABLE i_mchb
      FROM mchb
      FOR ALL ENTRIES IN i_mard
      WHERE matnr = i_mard-matnr
        AND werks = i_mard-werks.
  ENDIF.

* Normal stock
  LOOP AT i_mard ASSIGNING <fx_mard>.
    READ TABLE i_marc WITH KEY matnr = <fx_mard>-matnr
                               werks = <fx_mard>-werks
      BINARY SEARCH ASSIGNING <fx_marc>.

    IF sy-subrc = 0.
*     Batch managed materials
      IF <fx_marc>-xchar = c_true.

        PERFORM download_batch_im_stock.

*     Other materials
      ELSE.

        PERFORM download_other_im_stock.

      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " download_normal_im_stock

*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD_SUBCONTRACTOR_IM_STOC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_subcontractor_im_stoc.

  CHECK: p_sub = c_true.

* Subcontractor stock has to be uploaded
  IF p_ufile = c_true.
    PERFORM upload_file USING 'SUBCON'.

    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_mslb
      FROM mara INNER JOIN mslb
      ON mslb~matnr = mara~matnr
      FOR ALL entries IN i_subcon
      WHERE mara~mtart IN s_mtart
        AND mara~matnr EQ i_subcon-matnr
        AND mslb~werks EQ i_subcon-werks
        AND mslb~lifnr EQ i_subcon-lifnr
        AND ( mslb~lblab NE 0 OR
              mslb~lbins NE 0 ).
  ELSE.
*   stock at subcontractor
    IF p_spa = c_false.
      SELECT *
        INTO CORRESPONDING FIELDS OF TABLE i_mslb
        FROM mara INNER JOIN mslb
                    ON mslb~matnr = mara~matnr
        WHERE mara~mtart IN s_mtart
          AND mara~matnr IN s_matnr
          AND mslb~werks IN s_werks
          AND ( mslb~lblab NE 0 OR
                mslb~lbins NE 0 ).
    ELSEIF p_spa = c_true.
      CHECK NOT i_spa[] IS INITIAL.

      SELECT *
        INTO CORRESPONDING FIELDS OF TABLE i_mslb
        FROM mara INNER JOIN mslb
                    ON mslb~matnr = mara~matnr
        FOR ALL entries IN i_spa
        WHERE mara~mtart IN s_mtart
          AND mara~matnr EQ i_spa-matnr
          AND mara~matnr IN s_matnr
          AND mslb~werks IN s_werks
          AND ( mslb~lblab NE 0 OR
                mslb~lbins NE 0 ).
    ENDIF.
  ENDIF.

  IF sy-subrc = 0.
    CLEAR: i_bmseg.

    i_bmseg-mappe = p_group.
    i_bmseg-tcode = 'MB1C'.
    i_bmseg-bldat = p_date.
    i_bmseg-budat = p_date.
    i_bmseg-sobkz = 'O'.

    LOOP AT i_mslb ASSIGNING <fx_mslb>.
      i_bmseg-matnr = <fx_mslb>-matnr.
      i_bmseg-werks = <fx_mslb>-werks.
      i_bmseg-charg = <fx_mslb>-charg.
      i_bmseg-erfme = <fx_mslb>-meins.
      i_bmseg-lifnr = <fx_mslb>-lifnr.

*     Unrestricted stock
      IF <fx_mslb>-lblab NE 0.
        i_bmseg-erfmg = <fx_mslb>-lblab.
        i_bmseg-bwart = p_bwart.

        CLEAR: i_bmseg-insmk.

        PERFORM append_i_bmseg.
      ENDIF.

*     Quality and Blocked stock
      IF <fx_mslb>-lbins NE 0.
        i_bmseg-erfmg = <fx_mslb>-lbins.
        i_bmseg-bwart = p_bwartb.
        i_bmseg-insmk = 'S'.

        PERFORM append_i_bmseg.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " DOWNLOAD_SUBCONTRACTOR_IM_STOC

*&---------------------------------------------------------------------*
*&      Form  download_customer_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_customer_stock.

  CHECK: p_cust = c_true.

  IF p_spa = c_false.
*   Stock at subcontractor
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_mska
      FROM mara INNER JOIN mska
                  ON mska~matnr = mara~matnr
      WHERE mara~mtart IN s_mtart
        AND mara~matnr IN s_matnr
        AND mska~werks IN s_werks
        AND mska~lgort IN s_lgort
        AND ( mska~kalab NE 0 OR
              mska~kains NE 0 OR
              mska~kaspe NE 0 ).
  ELSEIF p_spa = c_true.
    CHECK NOT i_spa[] IS INITIAL.

    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_mska
      FROM mara INNER JOIN mska
                  ON mska~matnr = mara~matnr
      FOR ALL entries IN i_spa
      WHERE mara~mtart IN s_mtart
        AND mara~matnr IN s_matnr
        AND mara~matnr EQ i_spa-matnr
        AND mska~werks IN s_werks
        AND mska~lgort IN s_lgort
        AND ( mska~kalab NE 0 OR
              mska~kains NE 0 OR
              mska~kaspe NE 0 ).
  ENDIF.

  IF sy-subrc = 0.
    SELECT *
      INTO TABLE i_marc
      FROM marc
      FOR ALL ENTRIES IN i_mska
      WHERE matnr = i_mska-matnr
        AND werks = i_mska-werks.

    CLEAR: i_bmseg.

    i_bmseg-mappe = p_group.
    i_bmseg-tcode = 'MB1C'.
    i_bmseg-bldat = p_date.
    i_bmseg-budat = p_date.
    i_bmseg-sobkz = 'E'.

    LOOP AT i_mska ASSIGNING <fx_mska>.
      i_bmseg-matnr = <fx_mska>-matnr.
      i_bmseg-werks = <fx_mska>-werks.
      i_bmseg-lgort = <fx_mska>-lgort.
      i_bmseg-charg = <fx_mska>-charg.
      i_bmseg-kdauf = <fx_mska>-vbeln.
      i_bmseg-kdpos = <fx_mska>-posnr.
      i_bmseg-erfme = <fx_mska>-meins.

*     Unrestricted stock
      IF <fx_mska>-kalab NE 0.
        i_bmseg-erfmg = <fx_mska>-kalab.
        i_bmseg-bwart = p_bwart.

        CLEAR: i_bmseg-insmk.

        PERFORM append_i_bmseg.
      ENDIF.

*     Quality and Blocked stock
      IF <fx_mska>-kains NE 0 OR <fx_mska>-kaspe NE 0.
        i_bmseg-erfmg = <fx_mska>-kains + <fx_mska>-kaspe.
        i_bmseg-bwart = p_bwartb.
        i_bmseg-insmk = 'S'.

        PERFORM append_i_bmseg.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " download_customer_stock

*&---------------------------------------------------------------------*
*&      Form  create_output_file_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM create_output_file_im_stock.

*  DELETE DATASET p_file.
*
*  OPEN DATASET p_file FOR OUTPUT IN TEXT MODE.
*
*  IF sy-subrc = 0.
*    LOOP AT i_bmseg.
*      IF p_conv = c_true.
*     º™  PERFORM convert_value USING    'WERKS'
*                              CHANGING i_bmseg-werks.
*      ENDIF.
*
*      TRANSFER i_bmseg TO p_file.
*    ENDLOOP.
*
*    CLOSE DATASET p_file.
*  ELSE.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.

ENDFORM.                    " create_output_file_im_stock

*&---------------------------------------------------------------------*
*&      Form  CREATE_OUTPUT_FILE_WM_STOCK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM create_output_file_wm_stock.

  DELETE DATASET p_file.

  OPEN DATASET p_file FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.

  IF sy-subrc = 0.
    LOOP AT i_ldk33.
      PERFORM convert_value USING    'WERKS'
                            CHANGING i_ldk33-werks.

      TRANSFER i_ldk33 TO p_file.
    ENDLOOP.

    CLOSE DATASET p_file.
  ELSE.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " CREATE_OUTPUT_FILE_WM_STOCK


*&---------------------------------------------------------------------*
*&      Form  convert_value
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM convert_value USING    pv_type TYPE zgen_conv_type
                   CHANGING pv_value.

  CALL FUNCTION 'YSE_DU_CONVERT'
    EXPORTING
      v_type               = pv_type
      v_direction          = '01'
      v_from_field         = pv_value
    IMPORTING
      e_to_field           = pv_value
    EXCEPTIONS
      conversion_not_found = 1
      OTHERS               = 2.

ENDFORM.                    " convert_value

*&---------------------------------------------------------------------*
*&      Form  APPEND_I_BMSEG
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM append_i_bmseg.
  DATA: lv_value LIKE mseg-erfmg.

  lv_value = i_bmseg-erfmg.

  IF p_neg = c_false.
    CHECK: lv_value GT 0.
  ELSE.
    IF lv_value LT 0.
      i_bmseg-bwart = '562'.
    ENDIF.
  ENDIF.

  IF p_ufile = c_true.
    IF i_bmseg-lifnr IS INITIAL.
      READ TABLE i_unres WITH KEY matnr = i_bmseg-matnr
                                  werks = i_bmseg-werks
                                  lgort = i_bmseg-lgort.

      IF sy-subrc = 0.
        i_bmseg-erfmg = i_unres-erfmg.
        i_bmseg-erfme = i_unres-erfme.
      ENDIF.
    ELSE.
      READ TABLE i_subcon WITH KEY matnr = i_bmseg-matnr
                                   werks = i_bmseg-werks
                                   lifnr = i_bmseg-lifnr.

      IF sy-subrc = 0.
        i_bmseg-erfmg = i_subcon-erfmg.
        i_bmseg-erfme = i_subcon-erfme.
      ENDIF.
    ENDIF.
  ENDIF.

  x_gm_item-material       = i_bmseg-matnr.
  x_gm_item-plant          = i_bmseg-werks.
  x_gm_item-stge_loc       = i_bmseg-lgort.
  x_gm_item-batch          = i_bmseg-charg.
  x_gm_item-move_type      = i_bmseg-bwart.
  x_gm_item-spec_stock     = i_bmseg-sobkz.
  x_gm_item-vendor         = i_bmseg-lifnr.
  x_gm_item-customer       = i_bmseg-kunnr.
  x_gm_item-sales_ord      = i_bmseg-kdauf.
  x_gm_item-s_ord_item     = i_bmseg-kdpos.
  x_gm_item-val_sales_ord  = i_bmseg-kdauf.
  x_gm_item-val_s_ord_item = i_bmseg-kdpos.
  x_gm_item-entry_qnt      = i_bmseg-erfmg.
  x_gm_item-entry_uom      = i_bmseg-erfme.
  x_gm_item-stck_type      = i_bmseg-insmk.

  APPEND x_gm_item TO i_gm_item_all.

  APPEND i_bmseg.

ENDFORM.                    " APPEND_I_BMSEG

*&---------------------------------------------------------------------*
*&      Form  check_stock_list_table
*&----------------------------------------------------------------º™----
*
*       text
*----------------------------------------------------------------------*
FORM check_stock_list_table USING    px_gm_item   LIKE x_gm_item_all
                                     px_stock_fig LIKE yse_du_stockfig
                            CHANGING pv_send.

  CLEAR: pv_send.

  READ TABLE i_stock WITH KEY logsys = v_own_logsys
                              matnr  = px_gm_item-material
                              werks  = px_gm_item-plant
                              lgort  = px_gm_item-stge_loc
                              charg  = px_gm_item-batch
                              sernr  = px_stock_fig-sernr
                              sobkz  = px_gm_item-spec_stock
                              kunnr  = px_gm_item-customer
                              lifnr  = px_gm_item-vendor
                              vbeln  = px_gm_item-sales_ord
                              posnr  = px_gm_item-s_ord_item
                              bwart  = px_gm_item-move_type
                              test   = p_test
    BINARY SEARCH ASSIGNING <fx_stock>.

  IF sy-subrc <> 0.
    pv_send = c_true.
  ENDIF.

  IF sy-subrc = 0 AND <fx_stock>-error = c_true .
    pv_send = c_true.
  ENDIF.

  IF p_resend = c_true.
    pv_send = c_true.
  ENDIF.

*  IF p_test = c_true.
*    pv_send = c_true.
*  ENDIF.

ENDFORM.                    " check_stock_list_table

*&---------------------------------------------------------------------*
*&      Form  at_selection_screen_output
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM at_selection_screen_output.

*  LOOP AT SCREEN.
*    WRITE: / screen-name(50), screen-group4.
*  ENDLOOP.

* Fill STOCKFIG table
  IF p_im = c_true.
    LOOP AT SCREEN.
      IF screen-group4 = '028' OR
         screen-group4 = '038' OR
         screen-group4 = '039' OR
         screen-group4 = '040'.

        screen-active  = '0'.
        MODIFY SCREEN.

      ENDIF.

      IF p_error = c_false.
        IF screen-group4 = '012' OR
           screen-group4 = '037'.
          screen-active  = '0'.
          MODIFY SCREEN.

        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.

* Use STOCKFIG table
  IF p_ufig = c_true.
    LOOP AT SCREEN.
      IF screen-group4 = '013' OR
*         screen-group4 = '022' OR
         screen-group4 = '028' OR
         screen-group4 = '035' OR
         screen-group4 = '036' OR
*         screen-group4 = '037' OR
         screen-group4 = '038' OR
         screen-group4 = '039' OR
         screen-group4 = '040'.
        screen-active  = '0'.
        MODIFY SCREEN.
      ENDIF.
    ENDLOOP.
  ENDIF.

* Clear IM stock
  IF p_clr = c_true.
    LOOP AT SCREEN.
      IF screen-group4 = '028' OR
*         screen-group4 = '037' OR
         screen-group4 = '038' OR
         screen-group4 = '039'.
        screen-active  = '0'.
        MODIFY SCREEN.
      ENDIF.
    ENDLOOP.
  ENDIF.

* Clear STOCKFIG and STOCKLIST
  IF p_clr_fg = c_true OR p_clr_st = c_true.
    LOOP AT SCREEN.
      IF screen-group4 = '013' OR
*         screen-group4 = '022' OR
         screen-group4 = '028' OR
         screen-group4 = '031' OR
         screen-group4 = '032' OR
         screen-group4 = '033' OR
         screen-group4 = '034' OR
         screen-group4 = '035' OR
         screen-group4 = '036' OR
         screen-group4 = '037' OR
         screen-group4 = '038' OR
         screen-group4 = '039' OR
         screen-group4 = '040'.
        screen-active  = '0'.
        MODIFY SCREEN.

      ENDIF.
    ENDLOOP.

*   Hide TEST flag for STOCKFIG table
    IF p_clr_fg = c_true.
      LOOP AT SCREEN.
        IF screen-group4 = '012'.
          screen-active  = '0'.
          MODIFY SCREEN.

        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDIF.

* Hide file option
  IF NOT p_im  = c_true.
    LOOP AT SCREEN.
      IF screen-group4 = '009' OR
         screen-group4 = '010'.
        screen-active  = '0'.
        MODIFY SCREEN.

      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " at_selection_screen_output

*&---------------------------------------------------------------------*
*&      Form  select_spare_parts
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM select_spare_parts.
  DATA: li_subclasses  TYPE TABLE OF clsel_r_clint  WITH HEADER LINE,
        li_objecttypes TYPE TABLE OF mcls_r_tabelle WITH HEADER LINE,
        li_selection   TYPE TABLE OF comw           WITH HEADER LINE,
        li_objects     TYPE TABLE OF clsel_search_objects
                                                    WITH HEADER LINE,
        lx_klah  LIKE klah,
        lv_atinn LIKE cabn-atinn.

  DATA: BEGIN OF li_spa OCCURS 0,
          matnr LIKE mard-matnr,
        END OF li_spa.

  SELECT SINGLE *
    INTO lx_klah
    FROM klah
    WHERE class = 'SPARE_PART'.                         "#EC CI_NOFIRST

  SELECT SINGLE atinn
    FROM cabn
    INTO lv_atinn
    WHERE atnam EQ 'SPART'.

  li_subclasses-sign   = 'I'.
  li_subclasses-option = 'EQ'.
  li_subclasses-low    = lx_klah-clint.
  APPEND li_subclasses.

  li_objecttypes-sign   = 'I'.
  li_objecttypes-option = 'EQ'.
  li_objecttypes-low    = 'MARA'.
  APPEND li_objecttypes.

  li_selection-atinn  = lv_atinn.
  li_selection-atwrt  = '14'.
  li_selection-atcod  = '1'.
  li_selection-statu  = 'H'.
  li_selection-atfor  = 'CHAR'.
  li_selection-slcod  = '1'.
  li_selection-catwrt = '14'.
  APPEND li_selection.

  li_selection-atinn  = lv_atinn.
  li_selection-atwrt  = 'C1'.
  li_selection-atcod  = '1'.
  li_selection-statu  = 'H'.
  li_selection-atfor  = 'CHAR'.
  li_selection-slcod  = '1'.
  li_selection-catwrt = 'C1'.
  APPEND li_selection.

  CALL FUNCTION 'CLSC_SEARCH_OBJECTS'
    EXPORTING
      i_classtype              = '001'
      i_top_class_struc        = lx_klah
      i_keydate                = sy-datum
      i_language               = sy-langu
      i_ctms_ddb_loaded        = 'X'
    TABLES
      i_r_subclasses_tab       = li_subclasses
      i_r_objecttypes_tab      = li_objecttypes
      i_selection_criteria_tab = li_selection
      i_e_objects_tab          = li_objects
    EXCEPTIONS
      no_objects_found         = 1
      inconsistent_parameters  = 2
      no_authority_classtype   = 3
      no_valid_classes         = 4
      internal_error           = 5
      OTHERS                   = 6.

  IF sy-subrc = 0.
    IF NOT li_objects[] IS INITIAL.
      LOOP AT li_objects.
        i_spa-matnr = li_objects-object.

        IF i_spa-matnr IN s_matnr.
          APPEND i_spa.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDIF.

ENDFORM.                    " select_spare_parts

*&---------------------------------------------------------------------*
*&      Form  file_lookup
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM file_lookup USING p_file.
  DATA: lv_filesel LIKE ibipparms-path.

  CALL FUNCTION 'F4_FILENAME'
    EXPORTING
      program_name  = syst-repid
      dynpro_number = syst-dynnr
    IMPORTING
      file_name     = lv_filesel
    EXCEPTIONS
      OTHERS        = 1.

  p_file = lv_filesel.
ENDFORM.                    " file_lookup

*&---------------------------------------------------------------------*
*&      Form  check_selection_screen
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM check_selection_screen.

*  IF p_wm = c_false AND p_logsys IS INITIAL.
*    MESSAGE i000 WITH 'Fill out the selection screen correctly'
*                            '!'
*         º™                  ' '
*                            ' '.
*
*  ENDIF.

ENDFORM.                    " check_selection_screen

*&---------------------------------------------------------------------*
*&      Form  upload_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM upload_file USING pv_type.
  DATA: lv_file1 TYPE string,
        lv_xchar LIKE marc-xchar,
        it_filect    TYPE STANDARD TABLE OF sdokcntasc, " sdokcntbin
        ls_filect    TYPE sdokcntasc. " sdokcntbin

  lv_file1 = p_suf.

  CLEAR:   i_upload, i_unres, i_subcon.
  REFRESH: i_upload, i_unres, i_subcon.

* BREAK-POINT.  " at file load

* Read the file from the frontend
  CALL METHOD cl_gui_frontend_services=>gui_upload
    EXPORTING
      filename                = lv_file1
      filetype                = 'ASC'
*      HAS_FIELD_SEPARATOR     = 'X'   " File is tab delimited
    CHANGING
      data_tab                = it_filect
    EXCEPTIONS
      file_open_error         = 1
      file_read_error         = 2
      no_batch                = 3
      gui_refuse_filetransfer = 4
      invalid_type            = 5
      no_authority            = 6
      unknown_error           = 7
      bad_data_format         = 8
      header_not_allowed      = 9
      separator_not_allowed   = 10
      header_too_long         = 11
      unknown_dp_error        = 12
      access_denied           = 13
      dp_out_of_memory        = 14
      disk_full               = 15
      dp_timeout              = 16
      not_supported_by_gui    = 17
      error_no_gui            = 18
      OTHERS                  = 19.

  IF sy-subrc NE '0'.
    WRITE /
'Unable to open/read the input file -( Please check file is clos' &
'ed, not empty ... )'(102)
    . "#EC*
  ENDIF.
*  CALL FUNCTION 'GUI_UPLOAD'
*       EXPORTING
*            filename = lv_file1
*            filetype = 'ASC'
*       TABLES
*            data_tab = i_upload.

  CLASS cl_abap_char_utilities DEFINITION LOAD.
  CONSTANTS:
      con_tab  TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.

* LOOP AT i_upload.
  LOOP AT it_filect INTO ls_filect.
    CASE pv_type.
      WHEN 'FLAT'.                    " air22210 new when for ATLAS file
*       SPLIT i_upload-string AT CON_TAB
        SPLIT ls_filect AT con_tab
         INTO i_flat-werks                                  " air22210
              i_flat-lgort
              i_flat-matnr
              i_flat-sernr
              i_flat-erfmg
              i_flat-erfme
              i_flat-sobkz
* begin of deletion MOD-001
*              i_flat-kunnr
* end of deletion MOD-001
* begin of insertion MOD-001
              i_flat-sortl
* end of insertion MOD-001
              i_flat-waers_clr
              i_flat-peinh_clr
              i_flat-value_clr
              i_flat-value_tot_clr.

        TRANSLATE i_flat-erfmg USING ',.'.
        TRANSLATE i_flat-value_clr USING ',.'.
        TRANSLATE i_flat-value_tot_clr USING ',.'.
*
*        x_unres-matnr  = i_abec-cart+1(5).
*        x_unres-hvpemu = i_abec-hvpemu.
*        x_unres-erfmg  = i_abec-rabav1.
*        x_unres-werks  = 'A600'.
*        x_unres-lgort  = 'MAG'.
*        x_unres-erfme  = 'ST'.
*
*        SELECT SINGLE prctr xchar sernp
*          INTO (x_unres-prctr,x_unres-xchar,x_unres-sernp)
*          FROM marc
*          WHERE matnr = x_unres-matnr
*            AND werks = x_unres-werks.
*
*        CLEAR: x_unres-hvpemu.
* begin of insertion MOD-002
        DATA : g_matnr LIKE mara-matnr.
* end of insertion MOD-002
* begin of insertion MOD-003
        IF i_flat-matnr+0(1) = 'W'.
          i_flat-matnr = i_flat-matnr+1(17).
        ENDIF.
* end of insertion MOD-003
* break. at data loading
        SELECT SINGLE  matnr FROM  mara
                             INTO  x_unres-matnr
                             WHERE bismt = i_flat-matnr.
* begin of insertion MOD-002
* if not found , try to find the material number with matnr
        IF NOT sy-subrc = '0'.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              input  = i_flat-matnr
            IMPORTING
              output = g_matnr.
          SELECT SINGLE  matnr FROM  mara
                             INTO  x_unres-matnr
                             WHERE matnr = g_matnr.
        ENDIF.
* end of insertion MOD-002
*
*added on 13/03/07  on request from Bart WELLENS by air22210
        IF sy-subrc NE '0'.
*           move i_flat-matnr  to  x_unres-matnr.
          CONCATENATE '?' i_flat-matnr INTO x_unres-matnr.
        ENDIF.
* end of addition
*
        x_unres-werks      =   i_flat-werks.
        x_unres-lgort      =   i_flat-lgort.
*
        CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT'
                           EXPORTING
                             input                = i_flat-erfme
*                            LANGUAGE             = SY-LANGU
                           IMPORTING
                             output               = x_unres-erfme.
*                          EXCEPTIONS
*                            UNIT_NOT_FOUND       = 1
*                            OTHERS               = 2
        .
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
*
        x_unres-erfmg      =   i_flat-erfmg.
*
        x_unres-sernr      =   i_flat-sernr.
*
        x_unres-waers_clr  =   i_flat-waers_clr.  "curreny ????
*
        x_unres-sobkz      = i_flat-sobkz.

* begin of deletion MOD-001
*        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*          EXPORTING
*            input  = i_flat-kunnr
*          IMPORTING
*            output = x_unres-kunnr.
* end of deletion MOD-001
* begin of insertion MOD-001
        CLEAR x_unres-kunnr.
        SELECT SINGLE kunnr INTO x_unres-kunnr
          FROM kna1 WHERE sortl = i_flat-sortl.
* end of insertion MOD-001

        x_unres-peinh_clr  =   i_flat-peinh_clr.
        x_unres-value_clr  =   i_flat-value_clr.
        x_unres-value_tot_clr = i_flat-value_tot_clr.

        SELECT SINGLE prctr sernp
          INTO (x_unres-prctr,x_unres-sernp)
          FROM marc
          WHERE matnr = x_unres-matnr
            AND werks = x_unres-werks.
* begin of insertion NEWGL
        SELECT SINGLE bukrs INTO gv_bukrs
          FROM t001k WHERE bwkey =  x_unres-werks.
        CALL FUNCTION 'YSE_CONVERT_PRCTR_BL'
          EXPORTING
            prctr_in    = x_unres-prctr
            bukrs       = gv_bukrs
          IMPORTING
            segment_out = x_unres-prctr.
* end of insertion NEWGL

        MOVE-CORRESPONDING x_unres TO i_unres.

        COLLECT i_unres.

        CLEAR: i_unres, x_unres, i_abec , i_flat.

      WHEN 'ABEC'.
        SPLIT i_upload-string AT c_abec
         INTO i_abec-cart
              i_abec-hvpemu
              i_abec-cpablk
              i_abec-rabav1
              i_abec-rvbhb2
              i_abec-cbaeen
              i_abec-reohv3
              i_abec-cbaeca
              i_abec-fpavtv.

        TRANSLATE i_abec-rabav1 USING ',.'.
        TRANSLATE i_abec-rvbhb2 USING ',.'.
        TRANSLATE i_abec-reohv3 USING ',.'.

        x_unres-matnr  = i_abec-cart+1(5).
        x_unres-hvpemu = i_abec-hvpemu.
        x_unres-erfmg  = i_abec-rabav1.
        x_unres-werks  = 'PL01'.                            " air22210
        x_unres-lgort  = '1000'.
        x_unres-erfme  = 'ST'.

        SELECT SINGLE prctr xchar sernp
          INTO (x_unres-prctr,x_unres-xchar,x_unres-sernp)
          FROM marc
          WHERE matnr = x_unres-matnr
            AND werks = x_unres-werks.
* begin of insertion NEWGL
        SELECT SINGLE bukrs INTO gv_bukrs
          FROM t001k WHERE bwkey =  x_unres-werks.
        CALL FUNCTION 'YSE_CONVERT_PRCTR_BL'
          EXPORTING
            prctr_in    = x_unres-prctr
            bukrs       = gv_bukrs
          IMPORTING
            segment_out = x_unres-prctr.
* end of insertion NEWGL
        CLEAR: x_unres-hvpemu.

*        IF x_unres-sernp IS INITIAL OR
*           x_unres-sernp = 'Z999'.
*          CLEAR: x_unres-hvpemu.
*        ENDIF.

*        IF x_unres-xchar = c_true.
*          CLEAR: x_unres-hvpemu.
*        ENDIF.

        MOVE-CORRESPONDING x_unres TO i_unres.

        COLLECT i_unres.

        CLEAR: i_unres, x_unres, i_abec.

      WHEN 'UNRES'.
* start air22210
*        SPLIT i_upload-string AT c_tab
*         INTO x_unres-matnr
*              x_unres-werks
*              x_unres-lgort
*              x_unres-hvpemu
*              x_unres-erfmg
*              x_unres-erfme.
* end of *

        TRANSLATE x_unres-erfmg USING ',.'.

        MOVE-CORRESPONDING x_unres TO i_unres.

        APPEND i_unres.

        CLEAR: i_unres, x_unres.
      WHEN 'SUBCON'.
* start air22210
*        SPLIT i_upload-string AT c_tab
*        INTO i_subcon-matnr
*             i_subcon-werks
*             i_subcon-lifnr
*             i_subcon-erfmg
*             i_subcon-erfme.
* end of *
        TRANSLATE i_subcon-erfmg USING ',.'.

        APPEND i_subcon.

        CLEAR i_subcon.
    ENDCASE.
  ENDLOOP.

ENDFORM.                    " upload_file

*&---------------------------------------------------------------------*
*&      Form  fill_stock_figures_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_stock_figures_table.
*  DATA: lv_subrc LIKE sy-subrc,
*        lv_lines(10) TYPE n,
*        lv_count(10) TYPE n,
*        lv_perc(10)  TYPE n,
*        lv_text(100),
*        lv_error(184),
*        lv_send.
*
*  x_gm_header-pstng_date = p_date.
*  x_gm_header-pr_uname   = sy-uname.
*  x_gm_header-doc_date   = p_date.
*
*  IF NOT i_gm_item_all[] IS INITIAL.
*    REFRESH: i_mbew, i_marc.
*
*    SELECT *
*      INTO TABLE i_mbew
*      FROM mbew
*      FOR ALL ENTRIES IN i_gm_item_all
*      WHERE matnr = i_gm_item_all-material
*        AND bwkey = i_gm_item_all-plant
*        AND ( bwtar = i_gm_item_all-batch OR bwtar = space ).
*
*    SELECT *
*      INTO TABLE i_marc
*      FROM marc
*      FOR ALL ENTRIES IN i_gm_item_all
*      WHERE matnr = i_gm_item_all-material
*        AND werks = i_gm_item_all-plant.
*
**   Select stock table
*    SELECT *
*      INTO CORRESPONDING FIELDS OF TABLE i_stock_fig
*   º™  FROM zatpstockfig
*      WHERE logsys EQ v_own_logsys
*        AND matnr  IN s_matnr
*        AND werks  IN s_werks.
*
*    DESCRIBE TABLE i_gm_item_all LINES lv_lines.
*
*    LOOP AT i_gm_item_all INTO x_gm_item_all.
**     Update Stock Figures Table
*      PERFORM update_stock_fig_table USING x_gm_item_all.
*
*      MOVE-CORRESPONDING x_gm_item_all TO i_mseg_ok.
*
*      MOVE x_gm_headret-mat_doc  TO i_mseg_ok-mat_doc.
*      MOVE x_gm_headret-doc_year TO i_mseg_ok-doc_year.
*
*      APPEND i_mseg_ok.
*    ENDLOOP.
*
*    IF NOT i_stock_fig[] IS INITIAL.
*      MODIFY zatpstockfig FROM TABLE i_stock_fig.
*    ENDIF.
*  ENDIF.
*
*  LOOP AT i_mseg_ok.
*    WRITE:/ icon_green_light AS ICON,
*            'O',
*            i_mseg_ok-material,
*            i_mseg_ok-plant,
*            i_mseg_ok-stge_loc,
*            i_mseg_ok-batch,
*            i_mseg_ok-move_type,
*            i_mseg_ok-spec_stock,
*            i_mseg_ok-entry_qnt,
*            i_mseg_ok-entry_uom,
*            i_mseg_ok-mat_doc,
*            i_mseg_ok-doc_year.
*  ENDLOOP.

ENDFORM.                    " fill_stock_figures_table

*&---------------------------------------------------------------------*
*&      Form  clear_im_stock
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM clear_im_stock.

  IF p_error = c_false.
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_stock
      FROM yse_du_stocklist
      WHERE logsys EQ v_own_logsys
        AND matnr  IN s_matnr
        AND mtart  IN s_mtart
        AND charg  IN s_charg
        AND werks  IN s_werks
        AND lgort  IN s_lgort
        AND prdha  IN s_prdha
        AND test   EQ p_test
        AND error  EQ c_false.
  ELSE.
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_stock
      FROM yse_du_stocklist
      WHERE logsys    EQ v_own_logsys
        AND matnr     IN s_matnr
        AND mtart     IN s_mtart
        AND charg     IN s_charg
        AND werks     IN s_werks
        AND lgort     IN s_lgort
        AND prdha     IN s_prdha
        AND test      EQ p_test
        AND error     EQ c_false
        AND error_clr EQ c_true.
  ENDIF.

  i_stock_tmp[] = i_stock[].

  x_gm_header-pstng_date = p_date.
  x_gm_header-pr_uname   = sy-uname.
  x_gm_header-doc_date   = p_date.

  IF NOT i_stock[] IS INITIAL.
    PERFORM proces_i_stock_table.
  ENDIF.

  LOOP AT i_mseg_ok.
    WRITE:/ icon_green_light AS ICON,
            'O',
            i_mseg_ok-material,
            i_mseg_ok-plant,
            i_mseg_ok-stge_loc,
            i_mseg_ok-batch,
            i_mseg_ok-move_type,
            i_mseg_ok-spec_stock,
            i_mseg_ok-entry_qnt UNIT i_mseg_ok-entry_uom,
            i_mseg_ok-entry_uom,
            i_mseg_ok-mat_doc,
            i_mseg_ok-doc_year.
  ENDLOOP.

  SKIP.

  LOOP AT i_mseg_er.
    WRITE:/ icon_red_light AS ICON,
            'E',
            i_mseg_er-material,
            i_mseg_er-plant,
            i_mseg_er-stge_loc,
            i_mseg_er-batch,
            i_mseg_er-move_type,
            i_mseg_er-spec_stock,
            i_mseg_er-entry_qnt UNIT i_mseg_er-entry_uom,
            i_mseg_er-entry_uom,
            i_mseg_er-error.
  ENDLOOP.
ENDFORM.                    " clear_im_stock

*&---------------------------------------------------------------------*
*&      Form  proces_i_stock_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM proces_i_stock_table.
  DATA: lv_subrc      LIKE sy-subrc,
        lv_index      LIKE sy-tabix,
        lv_menge      LIKE mchb-clabs,
        lv_rest_menge LIKE mchb-clabs,
        lv_lines(10)  TYPE n,
        lv_count(10)  TYPE n,
        lv_perc(10)   TYPE n,
        lv_text(100),
        lv_error(184),
        lv_clr_ok,
        lv_send.

  DATA: li_mchb TYPE TABLE OF mchb WITH HEADER LINE.

  DESCRIBE TABLE i_stock LINES lv_lines.

  LOOP AT i_stock ASSIGNING <fx_stock>.
    lv_index = sy-tabix.

    ADD 1 TO lv_count.

    lv_perc = lv_count / lv_lines * 100.

    CONCATENATE lv_count '/' lv_lines INTO lv_text SEPARATED BY space.

    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = lv_perc
        text       = lv_text.

*   APPEND X_GM_ITEM structure
    PERFORM fill_x_gm_item_structure USING <fx_stock>.

    PERFORM convert_gt_item CHANGING x_gm_item_all.

    CLEAR: lv_subrc, lv_clr_ok.

    IF <fx_stock>-xchar = 'X' AND p_clr = c_true.
      CLEAR: lv_menge, lv_rest_menge.

      CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
        EXPORTING
          i_matnr              = <fx_stock>-matnr
          i_in_me              = <fx_stock>-erfme
          i_out_me             = <fx_stock>-meins_clr
          i_menge              = <fx_stock>-erfmg
        IMPORTING
          e_menge              = lv_menge
        EXCEPTIONS
          error_in_application = 1
          error                = 2
          OTHERS               = 3.

      IF sy-subrc = 0.
        lv_rest_menge = lv_menge.

        SELECT *
          INTO TABLE li_mchb
          FROM mchb
          WHERE matnr =  <fx_stock>-matnr
            AND werks =  'PL01'                             " air22210
            AND charg <> '1'
            AND lgort =  '1000'
            AND clabs >  0.

        LOOP AT li_mchb.
          REFRESH: i_gm_item, i_return.
          CLEAR:   x_gm_item, x_return.

          lv_menge = lv_menge - li_mchb-clabs.

          IF lv_menge => 0.
            x_gm_item_all-entry_qnt = li_mchb-clabs.
          ELSE.
            x_gm_item_all-entry_qnt = lv_rest_menge.
          ENDIF.

          x_gm_item_all-entry_uom = <fx_stock>-meins_clr.
          x_gm_item_all-batch     = li_mchb-charg.

          APPEND x_gm_item_all TO i_gm_item.

          REFRESH: i_return. CLEAR: i_return, x_gm_headret.


          lv_goodsmvt_code = p_gmcode.

          CATCH SYSTEM-EXCEPTIONS remote_call_errors = 5.
            CALL FUNCTION 'BAPI_GOODSMVT_CREATE'
*              DESTINATION p_logsys
                EXPORTING
                      goodsmvt_header       = x_gm_header
*                      goodsmvt_code         = p_gmcode
                      goodsmvt_code         = lv_goodsmvt_code
                      testrun               = p_test
                 IMPORTING
                      goodsmvt_headret      = x_gm_headret
                 TABLES
                      goodsmvt_item         = i_gm_item
                      goodsmvt_serialnumber = i_gm_sernr
                      return                = i_return.
          ENDCATCH.

          CLEAR: lv_subrc.

          LOOP AT i_return INTO x_return.
            CHECK x_return-type = 'E' OR x_return-type = 'A'.
            lv_subrc = 1.
          ENDLOOP.

          IF NOT lv_subrc IS INITIAL.
*           Errors in the BAPI call
            CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*              DESTINATION p_logsys.

            READ TABLE i_return INTO x_return WITH KEY type = 'E'.

            MOVE x_return-message TO lv_error.

            MOVE-CORRESPONDING  x_gm_item_all TO i_mseg_er.

            MOVE lv_error TO i_mseg_er-error.

            APPEND i_mseg_er.

            <fx_stock>-error_clr   = c_true.
            <fx_stock>-err_msg_clr = lv_error.

            MODIFY yse_du_stocklist FROM <fx_stock>.

            COMMIT WORK AND WAIT.

            EXIT.
          ELSE.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*              DESTINATION p_logsys
                     EXPORTING
                      wait = 'X'.
          ENDIF.

          lv_rest_menge = lv_rest_menge - li_mchb-clabs.

          IF lv_menge <= 0.
            lv_clr_ok = c_true.

            CLEAR: lv_subrc.

            EXIT.
          ENDIF.
        ENDLOOP.

        REFRESH: i_gm_item, i_return.
        CLEAR:   x_gm_item, x_return.

        x_gm_item_all-entry_qnt = lv_menge.
        x_gm_item_all-entry_uom = <fx_stock>-meins_clr.
        x_gm_item_all-batch     = '1'.
      ELSE.
        MOVE 'Error when converting to BUM'(100) TO lv_error.

        MOVE-CORRESPONDING  x_gm_item_all TO i_mseg_er.

        MOVE lv_error TO i_mseg_er-error.

        APPEND i_mseg_er.

        <fx_stock>-error_clr   = c_true.
        <fx_stock>-err_msg_clr = lv_error.

        MODIFY yse_du_stocklist FROM <fx_stock>.

        COMMIT WORK AND WAIT.

        lv_subrc = 99.
      ENDIF.

      APPEND x_gm_item_all TO i_gm_item.
    ELSE.
      APPEND x_gm_item_all TO i_gm_item.
    ENDIF.

    IF lv_clr_ok = c_false.
      IF lv_subrc IS INITIAL.
        REFRESH: i_return. CLEAR: i_return, x_gm_headret.


        lv_goodsmvt_code = p_gmcode.


        CALL FUNCTION 'BAPI_GOODSMVT_CREATE'
*          DESTINATION p_logsys
            EXPORTING
                  goodsmvt_header       = x_gm_header
*                  goodsmvt_code         = p_gmcode
                  goodsmvt_code          = lv_goodsmvt_code
                  testrun               = p_test
             IMPORTING
                  goodsmvt_headret      = x_gm_headret
             TABLES
                  goodsmvt_item         = i_gm_item
                  goodsmvt_serialnumber = i_gm_sernr
                  return                = i_return.

        CLEAR: lv_subrc.

        LOOP AT i_return INTO x_return.
          CHECK x_return-type = 'E' OR x_return-type = 'A'.
          lv_subrc = 1.
        ENDLOOP.
      ENDIF.

      IF lv_subrc IS INITIAL.
*       Everything OK
        IF p_test = c_false.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*            DESTINATION p_logsys
                   EXPORTING
                    wait = 'X'.

        ELSEIF p_test = c_true.
          CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*            DESTINATION p_logsys.
        ENDIF.

        MOVE-CORRESPONDING x_gm_item_all TO i_mseg_ok.

        MOVE x_gm_headret-mat_doc  TO i_mseg_ok-mat_doc.
        MOVE x_gm_headret-doc_year TO i_mseg_ok-doc_year.

        APPEND i_mseg_ok.

        IF p_clr = c_true.
          IF p_test = c_false.
            DELETE yse_du_stocklist FROM <fx_stock>.
          ENDIF.

          DELETE i_stock INDEX lv_index.
        ELSE.
          CLEAR: <fx_stock>-error, <fx_stock>-err_msg.

          MODIFY yse_du_stocklist FROM <fx_stock>.
        ENDIF.

        COMMIT WORK AND WAIT.
      ELSEIF sy-subrc <> 99.
*       Errors in the BAPI call
        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*          DESTINATION p_logsys.

        CLEAR lv_error.

        READ TABLE i_return INTO x_return WITH KEY type = 'E'.

        MOVE x_return-message TO lv_error.

        MOVE-CORRESPONDING  x_gm_item_all TO i_mseg_er.

        MOVE lv_error TO i_mseg_er-error.

        APPEND i_mseg_er.

        IF p_clr = c_true.
          <fx_stock>-error_clr   = c_true.
          <fx_stock>-err_msg_clr = lv_error.
        ELSE.
          <fx_stock>-error   = c_true.
          <fx_stock>-err_msg = lv_error.
        ENDIF.

        MODIFY yse_du_stocklist FROM <fx_stock>.

        COMMIT WORK AND WAIT.
      ENDIF.
    ELSE.
*     Everything ok
      IF p_test = c_false.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*          DESTINATION p_logsys
                 EXPORTING
                  wait = 'X'.

      ELSEIF p_test = c_true.
        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*          DESTINATION p_logsys.
      ENDIF.

      MOVE-CORRESPONDING x_gm_item_all TO i_mseg_ok.

      MOVE x_gm_headret-mat_doc  TO i_mseg_ok-mat_doc.
      MOVE x_gm_headret-doc_year TO i_mseg_ok-doc_year.

      APPEND i_mseg_ok.

      IF p_clr = c_true.
        IF p_test = c_false.
          DELETE yse_du_stocklist FROM <fx_stock>.
        ENDIF.

        DELETE i_stock INDEX lv_index.
      ELSE.
        CLEAR: <fx_stock>-error, <fx_stock>-err_msg.

        MODIFY yse_du_stocklist FROM <fx_stock>.
      ENDIF.

      COMMIT WORK AND WAIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " proces_i_stock_table

*&---------------------------------------------------------------------*
*&      Formº™ re_process_im_errors
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM re_process_im_errors.

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE i_stock
    FROM yse_du_stocklist
    WHERE logsys EQ v_own_logsys
      AND matnr  IN s_matnr
      AND mtart  IN s_mtart
      AND charg  IN s_charg
      AND werks  IN s_werks
      AND lgort  IN s_lgort
      AND prdha  IN s_prdha
      AND test   EQ p_test
      AND error  EQ c_true.

  x_gm_header-pstng_date = p_date.
  x_gm_header-pr_uname   = sy-uname.
  x_gm_header-doc_date   = p_date.

  IF NOT i_stock[] IS INITIAL.
    PERFORM proces_i_stock_table.
  ENDIF.

  LOOP AT i_mseg_ok.
    WRITE:/ icon_green_light AS ICON,
            'O',
            i_mseg_ok-material,
            i_mseg_ok-plant,
            i_mseg_ok-stge_loc,
            i_mseg_ok-batch,
            i_mseg_ok-move_type,
            i_mseg_ok-spec_stock,
            i_mseg_ok-entry_qnt UNIT i_mseg_ok-entry_uom,
            i_mseg_ok-entry_uom,
            i_mseg_ok-mat_doc,
            i_mseg_ok-doc_year.
  ENDLOOP.

  SKIP.

  LOOP AT i_mseg_er.
    WRITE:/ icon_red_light AS ICON,
            'E',
            i_mseg_er-material,
            i_mseg_er-plant,
            i_mseg_er-stge_loc,
            i_mseg_er-batch,
            i_mseg_er-move_type,
            i_mseg_er-spec_stock,
            i_mseg_er-entry_qnt UNIT i_mseg_er-entry_uom,
            i_mseg_er-entry_uom,
            i_mseg_er-error.
  ENDLOOP.

ENDFORM.                    " re_process_im_errors

*&---------------------------------------------------------------------*
*&      Form  use_stock_fig_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM use_stock_fig_table.

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE i_stock_fig
    FROM yse_du_stockfig
    WHERE logsys EQ v_own_logsys
      AND matnr  IN s_matnr
      AND mtart  IN s_mtart
      AND charg  IN s_charg
      AND werks  IN s_werks
      AND lgort  IN s_lgort
      AND prdha  IN s_prdha.
* begin of deletion MOD-002
*      AND erfmg  GT 0.
* end of deletion MOD-002

  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE i_stock
    FROM yse_du_stocklist
    WHERE logsys EQ v_own_logsys
      AND matnr  IN s_matnr
      AND mtart  IN s_mtart
      AND charg  IN s_charg
      AND werks  IN s_werks
      AND lgort  IN s_lgort
      AND prdha  IN s_prdha
      AND test   EQ p_test.

  x_gm_header-pstng_date = p_date.
  x_gm_header-pr_uname   = sy-uname.
  x_gm_header-doc_date   = p_date.

  IF NOT i_stock_fig[] IS INITIAL.
    PERFORM proces_i_stock_fig_table.
  ENDIF.

  LOOP AT i_mseg_ok.
    WRITE:/ icon_green_light AS ICON,
            'O',
            i_mseg_ok-material,
            i_mseg_ok-plant,
            i_mseg_ok-stge_loc,
            i_mseg_ok-batch,
            i_mseg_ok-move_type,
            i_mseg_ok-spec_stock,
            i_mseg_ok-entry_qnt UNIT i_mseg_ok-entry_uom,
            i_mseg_ok-entry_uom,
            i_mseg_ok-mat_doc,
            i_mseg_ok-doc_year.
  ENDLOOP.

  SKIP.

  LOOP AT i_mseg_er.
    WRITE:/ icon_red_light AS ICON,
            'E',
            i_mseg_er-material,
            i_mseg_er-plant,
            i_mseg_er-stge_loc,
            i_mseg_er-batch,
            i_mseg_er-move_type,
            i_mseg_er-spec_stock,
            i_mseg_er-entry_qnt UNIT i_mseg_er-entry_uom,
            i_mseg_er-entry_uom,
            i_mseg_er-error.
  ENDLOOP.

ENDFORM.                    " use_stock_fig_table

*&---------------------------------------------------------------------*
*&      Form  update_stock_fig_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM update_stock_fig_table USING px_gm_item LIKE x_gm_item_all.

*  DATA: lv_index TYPE sy-index.
*
*  CLEAR: i_stock_fig.
*
*  READ TABLE i_stock_fig WITH KEY logsys = v_owº™_logsys
*                                  matnr  = px_gm_item-material
*                                  werks  = px_gm_item-plant
*                                  lgort  = px_gm_item-stge_loc
*                                  charg  = px_gm_item-batch
*                                  sobkz  = px_gm_item-spec_stock
*                                  kunnr  = px_gm_item-customer
*                                  lifnr  = px_gm_item-vendor
*                                  vbeln  = px_gm_item-sales_ord
*                                  posnr  = px_gm_item-s_ord_item
*                                  bwart  = px_gm_item-move_type
*    BINARY SEARCH.
*
*  IF sy-subrc <> 0.
*    CLEAR: lv_index.
*
*    i_stock_fig-logsys = v_own_logsys.
*    i_stock_fig-matnr  = px_gm_item-material.
*    i_stock_fig-werks  = px_gm_item-plant.
*    i_stock_fig-lgort  = px_gm_item-stge_loc.
*    i_stock_fig-charg  = px_gm_item-batch.
*    i_stock_fig-sobkz  = px_gm_item-spec_stock.
*    i_stock_fig-kunnr  = px_gm_item-customer.
*    i_stock_fig-lifnr  = px_gm_item-vendor.
*    i_stock_fig-vbeln  = px_gm_item-sales_ord.
*    i_stock_fig-posnr  = px_gm_item-s_ord_item.
*    i_stock_fig-bwart  = px_gm_item-move_type.
*    i_stock_fig-insmk  = px_gm_item-stck_type.
*  ELSE.
*    lv_index = sy-tabix.
*  ENDIF.
*
*  i_stock_fig-erfmg = px_gm_item-entry_qnt.
*  i_stock_fig-erfme = px_gm_item-entry_uom.
*  i_stock_fig-waers = 'EUR'.
*
** Update MARC fields
*  READ TABLE i_marc WITH KEY matnr = i_stock_fig-matnr
*                             werks = i_stock_fig-werks
*    BINARY SEARCH ASSIGNING <fx_marc>.
*
*  IF sy-subrc = 0.
*    i_stock_fig-prctr = <fx_marc>-prctr.
*    i_stock_fig-sernp = <fx_marc>-sernp.
*  ENDIF.
*
** Read MARD fields
*  READ TABLE i_mard WITH KEY matnr = i_stock_fig-matnr
*                             werks = i_stock_fig-werks
*                             lgort = i_stock_fig-lgort
*    BINARY SEARCH ASSIGNING <fx_mard>.
*
*  IF sy-subrc = 0.
*    i_stock_fig-prdha = <fx_mard>-prdha.
*    i_stock_fig-meins = <fx_mard>-meins.
*  ENDIF.
*
** Convert profit center
**  READ TABLE i_conv_mat WITH KEY artnr = i_stock_fig-matnr.
**
**  IF sy-subrc EQ 0.
**    i_stock_fig-prctr2 = i_conv_mat-prctr.
**  ELSE.
**    READ TABLE i_conv_pc WITH KEY prctr_old = i_stock_fig-prctr.
**
**    IF sy-subrc EQ 0.
**      i_stock_fig-prctr2 = i_conv_pc-prctr_new.
**    ELSE.
**      i_stock_fig-prctr2 = i_stock_fig-prctr.
**    ENDIF.
**  ENDIF.
*
*  IF i_stock_fig-sobkz <> 'K'.
**   Update MBEW fields
*    READ TABLE i_mbew WITH KEY matnr = i_stock_fig-matnr
*                               bwkey = i_stock_fig-werks
*                               bwtar = i_stock_fig-charg
*      BINARY SEARCH ASSIGNING <fx_mbew>.
*
*
*    IF sy-subrc <> 0.
*      READ TABLE i_mbew WITH KEY matnr = i_stock_fig-matnr
*                                 bwkey = i_stock_fig-werks
*                                 bwtar = ' '
*        BINARY SEARCH ASSIGNING <fx_mbew>.
*    ENDIF.
*
*    IF sy-subrc = 0.
*      i_stock_fig-bklas = <fx_mbew>-bklas.
*      i_stock_fig-bwprs = <fx_mbew>-bwprs.
*      i_stock_fig-bwprh = <fx_mbew>-bwprh.
*      i_stock_fig-bwph1 = <fx_mbew>-bwph1.
*      i_stock_fig-abwkz = <fx_mbew>-abwkz.
*      i_stock_fig-bwpei = <fx_mbew>-bwpei.
*
**      IF <fx_mbew>-vprsv = 'S'.
**        i_stock_fig-value = <fx_mbew>-stprs.
**      ELSEIF <fx_mbew>-vprsv = 'V'.
**        i_stock_fig-value = <fx_mbew>-verpr.
**      ENDIF.
*
*      i_stock_fig-value = <fx_mbew>-zplpr.
*      i_stock_fig-peinh = <fx_mbew>-peinh.
*
*      IF i_stock_fig-erfme <> i_stock_fig-meins.
*        CALL FUNCTION 'MATERIAL_UNIT_CONVERSION'
*             EXPORTING
*                  input                = i_stock_fig-value
*                  matnr                = i_stock_fig-matnr
*                  meinh                = i_stock_fig-erfme
*                  meins                = i_stock_fig-meins
*             IMPORTING
*                  output           º™   = i_stock_fig-value
*             EXCEPTIONS
*                  conversion_not_found = 1
*                  input_invalid        = 2
*                  material_not_found   = 3
*                  meinh_not_found      = 4
*                  meins_missing        = 5
*                  no_meinh             = 6
*                  output_invalid       = 7
*                  overflow             = 8
*                  OTHERS               = 9.
*      ENDIF.
*
*      IF NOT i_stock_fig-peinh IS INITIAL.
*        i_stock_fig-value_tot = i_stock_fig-erfmg * i_stock_fig-value /
*                                i_stock_fig-peinh.
*      ELSE.
*        CLEAR: i_stock_fig-value_tot.
*      ENDIF.
*    ENDIF.
*  ELSE.
*    CLEAR: i_stock_fig-bklas,
*           i_stock_fig-bwprs,
*           i_stock_fig-bwprh,
*           i_stock_fig-bwph1,
*           i_stock_fig-abwkz,
*           i_stock_fig-bwpei,
*           i_stock_fig-value,
*           i_stock_fig-peinh,
*           i_stock_fig-value_tot,
*           i_stock_fig-waers.
*  ENDIF.
*
*  IF lv_index IS INITIAL.
*    INSERT i_stock_fig INTO TABLE i_stock_fig.
*  ELSE.
*    MODIFY i_stock_fig INDEX lv_index.
*  ENDIF.

ENDFORM.                    " update_stock_fig_table

*&---------------------------------------------------------------------*
*&      Form  proces_i_stock_fig_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM proces_i_stock_fig_table.
  DATA: lv_subrc LIKE sy-subrc,
        lv_index LIKE sy-tabix,
        lv_lines(10) TYPE n,
        lv_count(10) TYPE n,
        lv_perc(10)  TYPE n,
        lv_text(100),
        lv_error(184),
        lv_send.

  DATA: lx_stock LIKE yse_du_stocklist.

  DESCRIBE TABLE i_stock_fig LINES lv_lines.

  LOOP AT i_stock_fig ASSIGNING <fx_stock_fig>.
    ADD 1 TO lv_count.

    lv_perc = lv_count / lv_lines * 100.

    CONCATENATE lv_count '/' lv_lines INTO lv_text SEPARATED BY space.

    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        percentage = lv_perc
        text       = lv_text.

    MOVE-CORRESPONDING <fx_stock_fig> TO lx_stock.

*   FILL X_GM_ITEM_STRUCTURE
    PERFORM fill_x_gm_item_structure USING lx_stock.

*   Check Stock List Table
    PERFORM check_stock_list_table USING    x_gm_item_all
                                            <fx_stock_fig>
                                   CHANGING lv_send.

    IF lv_send = c_true.
      PERFORM convert_gt_item CHANGING x_gm_item_all.

      APPEND x_gm_item_all TO i_gm_item.

      lv_goodsmvt_code = p_gmcode.

      CATCH SYSTEM-EXCEPTIONS remote_call_errors = 5.
        CALL FUNCTION 'BAPI_GOODSMVT_CREATE'
*          DESTINATION p_logsys
             EXPORTING
                  goodsmvt_header       = x_gm_header
*                  goodsmvt_code         = p_gmcode
                  goodsmvt_code         = lv_goodsmvt_code
                  testrun               = p_test
             IMPORTING
                  goodsmvt_headret      = x_gm_headret
             TABLES
                  goodsmvt_item         = i_gm_item
                  goodsmvt_serialnumber = i_gm_sernr
                  return                = i_return.
      ENDCATCH.

      IF sy-subrc <> 5.
        CLEAR: lv_subrc.

        LOOP AT i_return INTO x_return.
          CHECK x_return-type = 'E' OR x_return-type = 'A'.
          lv_subrc = 1.
        ENDLOOP.

        IF lv_subrc IS INITIAL.
*         Everything OK
          IF p_test = c_false.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*              DESTINATION p_logsys
                 EXPORTING
                      wait = 'X'.

          ELSEIF p_test = c_true.
            CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*              DESTINATION p_logsys.
          ENDIF.

          MOVE-CORRESPONDING x_gm_item_all TO i_mseg_ok.

          MOVE x_gm_headret-mat_doc  TO i_mseg_ok-mat_doc.
          MOVE x_gm_headret-doc_year TO i_mseg_ok-doc_year.

          APPEND i_mseg_ok.

*         Update Stock List Table from stock figures table
          PERFORM update_stock_list_from_fig USING <fx_stock_fig>
                                                   x_gm_item_all
                                                   lv_subrc
                                                   space.
        ELSE.
*         Errors in the BAPI call
          CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*            DESTINATION p_logsys.

          CLEAR lv_error.

          READ TABLE i_return INTO x_return WITH KEY type = 'E'.

          MOVE x_return-message TO lv_error.

          MOVE-CORRESPONDING  x_gm_item_all TO i_mseg_er.

          MOVE lv_error TO i_mseg_er-error.

          APPEND i_mseg_er.

*         Update Stock List Table from stock figures table
          PERFORM update_stock_list_from_fig USING <fx_stock_fig>
                                                   x_gm_item_all
                                                   lv_subrc
                                                   lv_error.
        ENDIF.
      ELSE.
        MOVE-CORRESPONDING  x_gm_item_all TO i_mseg_er.

        lv_error = 'Remote call error'(101).

        MOVE lv_error TO i_mseg_er-error.

        APPEND i_mseg_er.

*       Update Stock List Table from stock figures table
        PERFORM update_stock_list_from_fig USING <fx_stock_fig>
                                                 x_gm_item_all
                                                 lv_subrc
                                                 lv_error.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " proces_i_stock_fig_table

*&---------------------------------------------------------------------*
*&      Form  update_stock_list_from_fig
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM update_stock_list_from_fig USING px_stock_fig   LIKE
yse_du_stockfig
                                      px_gm_item_all LIKE
                                                 bapi2017_gm_item_create
                                      pv_subrc
                                      pv_error.
  DATA: lv_index TYPE sy-index,
        lv_erfmg TYPE erfmg,
        lv_value TYPE zstock_value_tot.

  CLEAR: i_stock.

  READ TABLE i_stock WITH KEY logsys = v_own_logsys
                              matnr  = px_stock_fig-matnr
                              werks  = px_stock_fig-werks
                              lgort  = px_stock_fig-lgort
                              charg  = x_gm_item_all-batch
                              sernr  = px_stock_fig-sernr
                              sobkz  = px_stock_fig-sobkz
                              kunnr  = px_stock_fig-kunnr
                              lifnr  = px_stock_fig-lifnr
                              vbeln  = px_stock_fig-vbeln
                              posnr  = px_stock_fig-posnr
                              bwart  = px_stock_fig-bwart
                              test   = p_test
    BINARY SEARCH.

  IF sy-subrc <> 0.
    CLEAR: lv_index.

    MOVE-CORRESPONDING px_stock_fig TO i_stock.

    i_stock-charg = px_gm_item_all-batch.

    i_stock-test = p_test.
  ELSE.
    lv_index = sy-tabix.

    IF i_stock-error = c_false.
      CLEAR: lv_erfmg, lv_value.

      lv_erfmg  = i_stock-erfmg + px_stock_fig-erfmg.

      IF NOT px_stock_fig-peinh IS INITIAL.
        lv_value = lv_erfmg * px_stock_fig-value / px_stock_fig-peinh.
      ELSE.
        CLEAR: lv_value.
      ENDIF.
    ENDIF.

    MOVE-CORRESPONDING px_stock_fig TO i_stock.

    i_stock-charg = px_gm_item_all-batch.

    IF i_stock-error = c_false.
      i_stock-erfmg     = lv_erfmg.
      i_stock-value_tot = lv_value.
    ENDIF.
  ENDIF.

  IF NOT pv_subrc IS INITIAL.
    i_stock-error   = c_true.
    i_stock-err_msg = pv_error.

    CLEAR: i_stock-error_clr, i_stock-err_msg_clr.
  ELSE.
    CLEAR: i_stock-error, i_stock-err_msg, i_stock-error_clr,
           i_stock-err_msg_clr.
  ENDIF.

  IF lv_index IS INITIAL.
    INSERT i_stock INTO TABLE i_stock.
  ELSE.
    MODIFY i_stock INDEX lv_index.
  ENDIF.

  MODIFY yse_du_stocklist FROM i_stock.

  COMMIT WORK AND WAIT.

ENDFORM.                    " update_stock_list_from_fig

*&---------------------------------------------------------------------*
*&      Form  convert_gt_item
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM convert_gt_item CHANGING px_gm_item LIKE bapi2017_gm_item_create.

* Convert Plant to DEPT
  IF p_conv = c_true AND p_clr = c_false.
    PERFORM convert_value USING    'WERKS'
                          CHANGING px_gm_item-plant.
  ENDIF.

*  IF px_gm_item-entry_uom = 'ST' AND p_logsys <> v_own_logsys.
*    px_gm_item-entry_uom = 'PC'.
*  ENDIF.

ENDFORM.                    " convert_gt_item

*&---------------------------------------------------------------------*
*&      Form  select_serial_numbers
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM select_serial_numbers USING pv_matnr LIKE mseg-matnr
                                 pv_werks LIKE mseg-werks
                                 pv_lgort LIKE mseg-lgort
                                 pv_charg LIKE mseg-charg
                                 pv_bwart LIKE mseg-bwart
                                 pv_sobkz LIKE mseg-sobkz.
  DATA: li_jest  TYPE TABLE OF jest WITH HEADER LINE,
        lv_lbbsa LIKE eqbs-lbbsa.

  CLEAR: i_ser. REFRESH: i_ser.

* Select serial number
  SELECT equi~matnr  eqbs~b_werk eqbs~b_lager equi~charge
         equi~sernr  eqbs~lbbsa  equi~objnr   eqbs~sobkz
    INTO TABLE i_ser
    FROM equi INNER JOIN eqbs
                ON eqbs~equnr = equi~equnr
    WHERE equi~matnr    = pv_matnr
      AND eqbs~b_werk   = pv_werks
      AND eqbs~b_lager  = pv_lgort
      AND eqbs~b_charge = pv_charg.

  IF pv_bwart = p_bwart.
    lv_lbbsa = '01'.
  ELSEIF pv_bwart = p_bwartb.
    lv_lbbsa = '07'.
  ENDIF.

  LOOP AT i_ser WHERE matnr = pv_matnr
                  AND werks = pv_werks
                  AND lgort = pv_lgort
                  AND charg = pv_charg
                  AND lbbsa = lv_lbbsa
                  AND sobkz = pv_sobkz.
*   Check serial number status
    SELECT *
      INTO TABLE li_jest
      FROM jest
      WHERE objnr EQ i_ser-objnr
        AND stat IN ('I0184','I0076').

*   In wharehouse
    READ TABLE li_jest WITH KEY stat  = 'I0184'
                                inact = space.

    IF sy-subrc = 0.
*     Not deleted
      READ TABLE li_jest WITH KEY stat  = 'I0076'
                                  inact = space.

      IF sy-subrc <> 0.
        x_gm_sernr-matdoc_itm  = 1.
        x_gm_sernr-serialno    = i_ser-sernr.

        APPEND x_gm_sernr TO i_gm_sernr.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " select_serial_numbers

*&---------------------------------------------------------------------*
*&      Form  update_stockfig_from_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM update_stockfig_from_file.
  DATA: lv_index TYPE sy-index,
        lv_werks LIKE marc-werks.

*  DATA: lx_table LIKE yse_du_t_table_str.   air22210
  DATA: lx_table LIKE yse_du_table_str.

  DATA: li_input    TYPE TABLE OF yse_du_selection,
        li_output   TYPE TABLE OF yse_du_selection,
        li_mara_tmp TYPE TABLE OF mara WITH HEADER LINE,
        li_marm_tmp TYPE TABLE OF marm WITH HEADER LINE,
        li_mbew_tmp TYPE TABLE OF mbew WITH HEADER LINE.

  DATA:  lx_selection TYPE yse_du_selection.

  RANGES: lr_matnr FOR mara-matnr.

  CLEAR: lx_selection.

  REFRESH: i_mara, i_mbew, i_marc, li_mbew_tmp.

  IF NOT i_unres[] IS INITIAL.
    SELECT *
      INTO TABLE i_mara
      FROM mara
      FOR ALL ENTRIES IN i_unres
      WHERE matnr = i_unres-matnr.

    SELECT *
      INTO TABLE i_mbew
      FROM mbew
      FOR ALL ENTRIES IN i_unres
      WHERE matnr = i_unres-matnr
        AND bwkey = i_unres-werks
        AND bwtar = space.

*   Read MARA data on destination system
    REFRESH: lx_selection-s_matnr, lr_matnr, li_mara_tmp.
*BREAK AIR22210.  " update_stockfig_from_file
    LOOP AT i_unres.
      lr_matnr-sign   = 'I'.
      lr_matnr-option = 'EQ'.
      lr_matnr-low    = i_unres-matnr.

      APPEND lr_matnr TO lx_selection-s_matnr.
    ENDLOOP.

    lx_selection-tabname = 'MARA'.

    APPEND lx_selection TO li_input.

    lx_selection-tabname = 'MBEW'.

    APPEND lx_selection TO li_input.

*   Select MBEW table on the target system
    CALL FUNCTION 'YSE_DU_READ_TABLES'
*      DESTINATION p_logsys
         EXPORTING
              i_selection = li_input
         IMPORTING
              e_selection = li_output.

    LOOP AT li_output INTO lx_selection.
      CASE lx_selection-tabname.
        WHEN 'MARA'.
          LOOP AT lx_selection-table INTO lx_table.
            MOVE-CORRESPONDING lx_table TO li_mara_tmp.

            APPEND li_mara_tmp.
          ENDLOOP.
        WHEN 'MBEW'.
          LOOP AT lx_selection-table INTO lx_table.
            MOVE-CORRESPONDING lx_table TO li_mbew_tmp.

            APPEND li_mbew_tmp.
          ENDLOOP.
      ENDCASE.
    ENDLOOP.

*   Select stock table
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE i_stock_fig
      FROM yse_du_stockfig
      WHERE logsys EQ v_own_logsys
        AND matnr  IN s_matnr
        AND werks  IN s_werks.

    LOOP AT i_unres.
      CLEAR: i_stock_fig.

      i_stock_fig-prctr = i_unres-prctr.
      i_stock_fig-sernr = i_unres-sernr.                    "air22210
      i_stock_fig-sernp = i_unres-sernp.
      i_stock_fig-xchar = i_unres-xchar.

*      CLEAR: i_stock_fig-charg, i_stock_fig-sernr.          " air22210
      CLEAR: i_stock_fig-charg.

      READ TABLE i_stock_fig WITH KEY logsys = v_own_logsys
                                      matnr  = i_unres-matnr
                                      werks  = i_unres-werks
                                      lgort  = i_unres-lgort
                                      charg  = i_stock_fig-charg
                                      sernr  = i_stock_fig-sernr
* begin of deletion MOD-001
*                                      sobkz  = space
*                                      kunnr  = space
* end of deletion MOD-001
* begin of insertion MOD-001
                                      sobkz  = i_unres-sobkz
                                      kunnr  = i_unres-kunnr
* end of insertion MOD-001
                                      lifnr  = space
                                      vbeln  = space
                                      posnr  = space
                                      bwart  = p_bwart.

      IF sy-subrc <> 0.
        CLEAR: lv_index.

        i_stock_fig-logsys = v_own_logsys.
        i_stock_fig-matnr  = i_unres-matnr.
        i_stock_fig-werks  = i_unres-werks.
        i_stock_fig-lgort  = i_unres-lgort.
        i_stock_fig-bwart  = p_bwart.

        CLEAR: i_stock_fig-insmk.
      ELSE.
        lv_index = sy-tabix.
      ENDIF.

      i_stock_fig-erfmg = i_unres-erfmg.
      i_stock_fig-erfme = i_unres-erfme.
*      i_stock_fig-waers = 'EUR'.                " air22210
*      i_stock_fig-waers = to be derived from tables T001 for cocd...
      SELECT SINGLE     bukrs
             FROM       t001k
             INTO       gv_bukrs
             WHERE      bwkey =  i_unres-werks.
      SELECT SINGLE    waers
      FROM       t001
      INTO       i_stock_fig-waers
      WHERE      bukrs = gv_bukrs.
**********************************
*     Read MARA fields
      READ TABLE i_mara WITH KEY matnr = i_stock_fig-matnr
        BINARY SEARCH ASSIGNING <fx_mara>.

      IF sy-subrc = 0.
        i_stock_fig-prdha     = <fx_mara>-prdha.
        i_stock_fig-mtart     = <fx_mara>-mtart.
        i_stock_fig-meins_clr = <fx_mara>-meins.
      ENDIF.

*     Update MBEW fields from original system
      READ TABLE i_mbew WITH KEY matnr = i_stock_fig-matnr
                                 bwkey = i_stock_fig-werks
                                 bwtar = space
        ASSIGNING <fx_mbew>.

      IF sy-subrc = 0.
        i_stock_fig-bklas = <fx_mbew>-bklas.
        i_stock_fig-bwprs = <fx_mbew>-bwprs.
        i_stock_fig-bwprh = <fx_mbew>-bwprh.
        i_stock_fig-bwph1 = <fx_mbew>-bwph1.
        i_stock_fig-abwkz = <fx_mbew>-abwkz.
        i_stock_fig-bwpei = <fx_mbew>-bwpei.
*       i_stock_fig-value = <fx_mbew>-zplpr.

*       Stock value's for clearing (Offload)
*i_stock_fig-peinh_clr     = <fx_mbew>-peinh.        " <= air22210 ?
        i_stock_fig-peinh_clr     = i_unres-peinh_clr.
* In comment from by air22210
*        IF <fx_mbew>-vprsv = 'S'.
*          i_stock_fig-value_clr = <fx_mbew>-stprs.
*        ELSEIF <fx_mbew>-vprsv = 'V'.
*          i_stock_fig-value_clr = <fx_mbew>-verpr.
*        ENDIF.
        i_stock_fig-value_clr = i_unres-value_clr.
* end of comment
* air2221O TO : i_stock_fig-value_clr <= from  input
        IF i_stock_fig-meins_clr <> i_stock_fig-erfme.
          CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
            EXPORTING
              i_matnr              = i_stock_fig-matnr
              i_in_me              = i_stock_fig-erfme
              i_out_me             = i_stock_fig-meins_clr
              i_menge              = i_stock_fig-value_clr
            IMPORTING
              e_menge              = i_stock_fig-value_clr
            EXCEPTIONS
              error_in_application = 1
              error                = 2
              OTHERS               = 3.
        ENDIF.

* In comment from by air22210
*        IF NOT i_stock_fig-peinh_clr IS INITIAL.
*          i_stock_fig-value_tot_clr = i_stock_fig-erfmg *
*                                      i_stock_fig-value_clr /
*                                      i_stock_fig-peinh_clr.
*        ELSE.
*          CLEAR: i_stock_fig-value_tot_clr.
*        ENDIF.
* end of comment
        i_stock_fig-value_tot_clr = i_unres-value_tot_clr.  " air22210
        i_stock_fig-waers_clr = i_unres-waers_clr.
        "  added air22210
      ENDIF.

*      Break air22210.

*     Update MBEW fields from destination system
      lv_werks = i_stock_fig-werks.

      PERFORM convert_value USING 'WERKS'
                            CHANGING lv_werks.

      READ TABLE li_mara_tmp WITH KEY matnr = i_stock_fig-matnr
        ASSIGNING <fx_mara_tmp>.

      IF sy-subrc = 0.
        i_stock_fig-meins = <fx_mara_tmp>-meins.
      ENDIF.

      READ TABLE li_mbew_tmp WITH KEY matnr = i_stock_fig-matnr
                                      bwkey = lv_werks
                                      bwtar = space
        ASSIGNING <fx_mbew_tmp>.



      IF sy-subrc = 0.
*       Stock value's for stockload from destination system
        i_stock_fig-peinh = <fx_mbew_tmp>-peinh.

        IF <fx_mbew_tmp>-vprsv = 'S'.
          i_stock_fig-value = <fx_mbew_tmp>-stprs.
        ELSEIF <fx_mbew_tmp>-vprsv = 'V'.
          i_stock_fig-value = <fx_mbew_tmp>-verpr.
        ENDIF.

        IF i_stock_fig-meins <> i_stock_fig-erfme.
*          CALL FUNCTION 'YSE_DU_CONVERT_MATERIAL_UNIT'
**            DESTINATION p_logsys
*               EXPORTING
*                    i_matnr              = i_stock_fig-matnr
*                    i_in_me              = i_stock_fig-erfme
*                    i_out_me             = i_stock_fig-meins
*                    i_menge              = i_stock_fig-value
*               IMPORTING
*                    e_menge              = i_stock_fig-value
*               EXCEPTIONS
*                    error_in_application = 1
*                    error                = 2
*                    OTHERS               = 3.

          CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
*            DESTINATION p_logsys
               EXPORTING
                    i_matnr              = i_stock_fig-matnr
                    i_in_me              = i_stock_fig-erfme
                    i_out_me             = i_stock_fig-meins
                    i_menge              = i_stock_fig-value
               IMPORTING
                    e_menge              = i_stock_fig-value
               EXCEPTIONS
                    error_in_application = 1
                    error                = 2
                    OTHERS               = 3.

        ENDIF.

        IF NOT i_stock_fig-peinh IS INITIAL.
          i_stock_fig-value_tot = i_stock_fig-erfmg *
                                  i_stock_fig-value /
                                  i_stock_fig-peinh.
        ELSE.
          CLEAR: i_stock_fig-value_tot.
        ENDIF.
      ENDIF.

      IF i_stock_fig-mtart = 'ZADV' OR i_stock_fig-mtart = 'ZLAG'.
        CLEAR: i_stock_fig-value_tot, i_stock_fig-value_tot_clr.
      ELSEIF i_stock_fig-mtart = 'ZREK'.
        CLEAR: i_stock_fig-value_tot.
      ENDIF.

      i_stock_fig-sobkz = i_unres-sobkz.
      i_stock_fig-kunnr = i_unres-kunnr.

      IF lv_index IS INITIAL.
        INSERT i_stock_fig INTO TABLE i_stock_fig.
      ELSE.
        MODIFY i_stock_fig INDEX lv_index.
      ENDIF.
    ENDLOOP.

*    INSERT LINES OF i_stock_fig_ser INTO TABLE i_stock_fig.

    IF NOT i_stock_fig[] IS INITIAL.
      MODIFY yse_du_stockfig FROM TABLE i_stock_fig.
    ENDIF.
  ENDIF.

ENDFORM.                    " update_stockfig_from_file

*&---------------------------------------------------------------------*
*&      Form  FILL_X_GM_ITEM_STRUCTURE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_x_gm_item_structure USING px_stock LIKE yse_du_stocklist.

  CLEAR x_gm_headret.

  REFRESH: i_gm_item, i_gm_sernr, i_return, i_ser.
  CLEAR:   x_gm_item, x_gm_sernr, x_return, i_ser.

  IF NOT px_stock-sernp IS INITIAL AND px_stock-sernp <> 'Z999'.
    x_gm_sernr-matdoc_itm  = 1.
    x_gm_sernr-serialno    = px_stock-sernr.

    APPEND x_gm_sernr TO i_gm_sernr.
  ENDIF.

  x_gm_item_all-material       = px_stock-matnr.
  x_gm_item_all-plant          = px_stock-werks.
  x_gm_item_all-stge_loc       = px_stock-lgort.
  x_gm_item_all-spec_stock     = px_stock-sobkz.
  x_gm_item_all-vendor         = px_stock-lifnr.
  x_gm_item_all-customer       = px_stock-kunnr.
  x_gm_item_all-sales_ord      = px_stock-vbeln.
  x_gm_item_all-s_ord_item     = px_stock-posnr.
  x_gm_item_all-val_sales_ord  = px_stock-vbeln.
  x_gm_item_all-val_s_ord_item = px_stock-posnr.
  x_gm_item_all-entry_qnt      = px_stock-erfmg.
  x_gm_item_all-entry_uom      = px_stock-erfme.

  IF p_clr = c_true.
    x_gm_item_all-costcenter = p_kostl.
  ENDIF.

  IF px_stock-xchar = 'X'.
    x_gm_item_all-batch = '1'.

    SHIFT x_gm_item_all-batch LEFT DELETING LEADING space.
  ENDIF.
* begin of deletion MOD-002 (error is coming back from bapi)
*  IF x_gm_item_all-entry_qnt LT 0.
*    x_gm_item_all-entry_qnt = x_gm_item_all-entry_qnt * -1.
*  ENDIF.
* end of deletion MOD-002
  IF p_clr = c_true.
    IF px_stock-insmk IS INITIAL.
      x_gm_item_all-move_type = p_bwart.
    ELSEIF px_stock-insmk = 'S'.
      x_gm_item_all-move_type = p_bwartb.
    ENDIF.
  ELSE.
    x_gm_item_all-move_type = px_stock-bwart.
  ENDIF.

ENDFORM.                    " APPEND_X_GM_ITEM_STRUCTURE
