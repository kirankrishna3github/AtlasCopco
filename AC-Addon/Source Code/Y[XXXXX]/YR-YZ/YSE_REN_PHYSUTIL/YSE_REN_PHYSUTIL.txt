************************************************************************
* Program ID           : YSE_REN_PHYSUTIL                              *
* Program Title        : Physical utilization report                   *
* Author               : Erik Walravens                                *
* Date                 : 26.12.2006                                    *
* Development Number   : D025                                          *
* Change Request Number: CD1K908962                                    *
* Description          : Reports the number of days the equipment is   *
*                        rented out compared to the number of days     *
*                        the equipment could have been rented out      *
************************************************************************
* Note: Utilisation is calculated based on entries in SME-table. If a  *
*       service order is booked during a same period as a rental contr *
*       this period will be counted in double. To change.              *
*     * Material descr. should be replaced by Equipment descr.         *
************************************************************************
* Change History Log                                                   *
*----------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number | Change Ref *
*----------------------------------------------------------------------*
* MOD-001 |13/03/2007| Erik Walravens | CD1K912199        | 001        *
* Description: Add selection parameters in report header.              *
*              Fix extra day error in periods.                         *
*              Add PGC GAC information.                                *
*              Use storage plant instead of maintenance plant.         *
*              Fix double distr. channel entry (default and own data). *
************************************************************************
* MOD-002 |17/03/2007| Erik Walravens | CD1K912446        | 002        *
* Description: Optimization of main data selection.                    *
************************************************************************
* MOD-003 |28/03/2007| Erik Walravens | CD1K913318        | 003        *
* Description: Remove plant from selection parameters.                 *
*              Split inefficiency in transport, service and yard.      *
*----------------------------------------------------------------------*
* MOD-004 |29/03/2007| Erik Walravens | CD1K913340        | 004        *
* Description: Fix selection on Serial, Equipment and model.           *
*              Fix Ineff in Yard error.                                *
*              Cosmetic changes.                                       *
*----------------------------------------------------------------------*
* MOD-005 |29/03/2007| Erik Walravens | CD1K913368        | 005        *
* Description: Fix data type error.                                    *
*----------------------------------------------------------------------*
* MOD-006 |30/03/2007| Erik Walravens | CD1K913407        | 006        *
* Description: Changed formula Inefficiency without availability.      *
*              Cosmetic changes.                                       *
*              Fixed acquistion date.                                  *
*----------------------------------------------------------------------*
* MOD-007 |30/03/2007| Erik Walravens | CD1K913409        | 007        *
* Description: Fixed PGC GAC selection option.                         *
*---------------------------------------------------------------------*
* MOD-016 |12/04/2007| Pieter Jespers | CD1K913810        | 017       *
* Description: Authorisation check                                    *
************************************************************************
REPORT yse_ren_physutil MESSAGE-ID yse_rental.

************************************************************************
* FIELD-SYMBOLS                                                        *
************************************************************************
FIELD-SYMBOLS: <fieldcat> TYPE lvc_s_fcat.

************************************************************************
* OBJECTS                                                              *
************************************************************************
DATA:  obj_container     TYPE REF TO cl_gui_docking_container,
       obj_alv           TYPE REF TO cl_gui_alv_grid.

************************************************************************
* TABLES                                                               *
************************************************************************
TABLES: mvke, mara, equi, iloa, yse_pgc_gac, t179.

************************************************************************
* TYPE-POOLS                                                           *
************************************************************************
TYPE-POOLS slis.

************************************************************************
* INTERNAL TYPES                                                       *
************************************************************************
TYPES:  BEGIN OF str_equ_a,
               equnr       TYPE equi-equnr,   " Equipment number
        END OF str_equ_a,

        BEGIN OF str_equ_b,
          equnr TYPE equnr,
          matnr TYPE matnr,
          sernr TYPE gernr,
          shtxt TYPE ktx01,
          iloan TYPE iloan,
          werk  TYPE werks_d,
        END OF str_equ_b,

        BEGIN OF str_equ_c,
          iloan TYPE iloan,
          bukrs TYPE bukrs,
          vkorg TYPE vkorg,
          vtweg TYPE vtweg,
        END OF str_equ_c,

        BEGIN OF str_eq,
               bukrs        TYPE iloa-bukrs,  " Company code
               werk         TYPE eqbs-b_werk, " Stock Plant
               equnr        TYPE equi-equnr,  " Equipment nr
               matnr        TYPE equi-matnr,  " Material nr
               sernr        TYPE equi-sernr,  " Serial nr
               pmatn        TYPE mvke-pmatn,  " Model
               prodh        TYPE mvke-prodh,  " Product hierarchy
               eqktx        TYPE eqkt-eqktx,  " Equipment description
               prdha        TYPE mara-prdha,  " Product hierarchy
        END OF str_eq,

        BEGIN OF str_sme,
               zzequnr      TYPE yse_rent_sme-zzequnr,  " Equipment nr
               matnr        TYPE yse_rent_sme-matnr,    " Material nr
               zzsernr      TYPE yse_rent_sme-zzsernr,  " Serial nr
               angdt        TYPE yse_rent_sme-angdt,    " Start date
               bnddt        TYPE yse_rent_sme-bnddt,    " End date
               auart        TYPE yse_rent_sme-auart,    " Doc type
        END OF str_sme,

  BEGIN OF str_mvke,
    matnr     TYPE mvke-matnr,
    pmatn     TYPE mvke-pmatn,
    prodh     TYPE mvke-prodh,
  END OF str_mvke,

  BEGIN OF str_result,
    bukrs        TYPE iloa-bukrs,    " Company Code
    werk         TYPE equi-werk,     " Stock Plant
    gac          TYPE zgac,          " GAC
    pgc          TYPE zpgc,          " PGC
    model        TYPE zmodel,        " Model number
    modesc       TYPE makt-maktx,    " Model description
    matnr        TYPE matnr,         " Material number
    mater        TYPE makt-maktx,    " Material description
    equnr        TYPE yse_rent_sme-zzequnr,  " Equipment nr
    sernr        TYPE yse_rent_sme-zzsernr,  " Serial nr
    absuse       TYPE int2,          " Abolute nr of days in use
    period       TYPE int2,          " Nr of reporting days
    peruse       TYPE p DECIMALS 2,  " Phys util Over Time Period
    mtduse       TYPE p DECIMALS 2,  " Phys util Month to Date
    ytduse       TYPE p DECIMALS 2,  " Phys util Year to Date
    roluse       TYPE p DECIMALS 2,  " Phys util 12 Months Rolling
    comuse       TYPE p DECIMALS 2,  " Phys util Month comparison
    in_tra_ab    TYPE int2,          " Absolute ineff. due to transport
    in_tra_pr    TYPE p DECIMALS 2,  " Percentile ineff "        "
    in_ser_ab    TYPE int2,          " Abs ineff due to service orders
    in_ser_pr    TYPE p DECIMALS 2,  " Perc. ineff
    in_una_ab    TYPE int2,          " Abs ineff due to unavailibility
    in_una_pr    TYPE p DECIMALS 2,  " Perc ineff
    infabs       TYPE int2,          " Absolute inefficiency
    infper       TYPE p DECIMALS 2,  " Percentile inefficiency
    rolinf       TYPE p DECIMALS 2,
    " Percentile ineff 12 Months Rolling
  END OF str_result,

        BEGIN OF str_mara,
              matnr     TYPE mara-matnr,          " Material number
              prdha     TYPE mara-prdha,          " Product hierarchy
        END OF str_mara,

        BEGIN OF str_invest,
              equnr     TYPE equz-equnr,          " Equipment number
              zugdt     TYPE anla-zugdt,          " Acquisition date
        END OF str_invest,

        BEGIN OF str_makt,
               matnr        TYPE makt-matnr,
               maktx        TYPE makt-maktx,
        END OF str_makt.

************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:
  it_equ_a    TYPE TABLE OF str_equ_a   WITH HEADER LINE,
  it_equ_b    TYPE TABLE OF str_equ_b   WITH HEADER LINE,
  it_equ_c    TYPE TABLE OF str_equ_c   WITH HEADER LINE,
  it_eq       TYPE TABLE OF str_eq      WITH HEADER LINE,
  it_mvke     TYPE TABLE OF str_mvke    WITH HEADER LINE,
*  it_equ_d    TYPE TABLE OF str_eq      WITH HEADER LINE,
  it_sme      TYPE TABLE OF str_sme     WITH HEADER LINE,
  it_result   TYPE TABLE OF str_result  WITH HEADER LINE,
  it_pgc      TYPE TABLE OF yse_pgc_gac WITH HEADER LINE,
  it_mara     TYPE TABLE OF str_mara    WITH HEADER LINE,
  it_makt     TYPE TABLE OF str_makt    WITH HEADER LINE,
  it_invest   TYPE TABLE OF str_invest  WITH HEADER LINE,
  it_fieldcat TYPE lvc_t_fcat,     " ALV grid field catalog

  BEGIN OF it_matnr OCCURS 0,
     matnr    TYPE matnr,
  END OF it_matnr,
  wa_matnr    LIKE LINE OF it_matnr,

  BEGIN OF it_models OCCURS 0,
    matnr     TYPE matnr,
    model     TYPE matnr,
  END OF it_models.

************************************************************************
* CONSTANTS                                                            *
************************************************************************
CONSTANTS: lc_true TYPE char1       VALUE 'X',    " true
           lc_engl LIKE tvagt-spras VALUE 'E',    " english
           lc_rent TYPE iloa-vtweg  VALUE '21',   " rental distr.
           lc_quot TYPE vbak-auart  VALUE 'ZQT',  " rental quotation
           lc_cont TYPE vbak-auart  VALUE 'ZQP',  " rental contract
           lc_deli TYPE vbak-auart  VALUE 'LR',   " inbound delivery
           lc_delo TYPE vbak-auart  VALUE 'ZLF',  " outbound delivery
           lc_serv TYPE vbak-auart  VALUE 'ZAM1', " service order
           lc_catx TYPE equi-eqtyp  VALUE 'X',    " Financed by lease
           lc_caty TYPE equi-eqtyp  VALUE 'Y'.
" Not financed by lease

************************************************************************
* VARIABLES                                                            *
************************************************************************
* Own data
DATA: lv_bukrs     TYPE iloa-bukrs,    " Company code
      lv_werks     TYPE equi-werk,     " Plant
      lv_vkorg     TYPE vbak-vkorg,    " Sales organisation
      lv_vtweg     TYPE vbak-vtweg,    " Distribution channel
      lv_matnr     TYPE vbap-matnr,    " Material nr
      lv_equnr     TYPE equi-equnr,    " Equipment nr
      lv_sernr     TYPE equi-sernr.    " Serial nr
* Display
DATA: gv_repid     LIKE sy-repid,
      lv_records   TYPE p,             " Record counter
      lv_inloop    TYPE char1,         " Loop checker
      okcode       LIKE sy-ucomm,      " return param screen 100
      gs_layout    TYPE lvc_s_layo,    " ALV grid layout
      gs_variant   TYPE disvariant,    " ALV grid variant
      o_bukrs(4)   TYPE c,             " Output field Company Code
      o_werks(4)   TYPE c,             " Output field Plant
      o_vkorg(4)   TYPE c,             " Output field Sales Org.
      o_angdt(10)  TYPE c,             " Output field Start date
      o_bnddt(10)  TYPE c.             " Output field End date
* Process
DATA: lv_title     TYPE string,        " ALV grid title

      lv_dtms      TYPE sy-datum,      " Month start date
      lv_dtys      TYPE sy-datum,      " Year start date
      lv_dtya      TYPE sy-datum,      " Year ago date
      lv_dtme      TYPE sy-datum,      " Month end date
      lv_dtma      TYPE sy-datum,      " Month ago date
      lv_dtym      TYPE sy-datum,      " Year and month ago date
      lv_angdt     TYPE yse_rent_sme-angdt,    " Start date
      lv_bnddt     TYPE yse_rent_sme-bnddt,    " End date

      lv_period    TYPE int4,          " Day counter
      lv_angmtd    LIKE lv_angdt,      " Start date MtD period
      lv_bndmtd    LIKE lv_bnddt,      " End date MtD period
      lv_mtduse    TYPE int2,          " Absolute usage MtD
      lv_angytd    LIKE lv_angdt,      " Start date YtD period
      lv_bndytd    LIKE lv_bnddt,      " End date YtD period
      lv_ytduse    TYPE int2,          " Absolute usage YtD
      lv_angrol    LIKE lv_angdt,      " Start date 12 months rol
      lv_bndrol    LIKE lv_bnddt,      " End date 12 months rol
      lv_roluse    TYPE int2,          " Absolute usage 12 months rol
      lv_angmc1    LIKE lv_angdt,      " Start date month comparison 1
      lv_bndmc1    LIKE lv_bnddt,      " End date month comparison 1
      lv_mc1use    TYPE int2,          " Absolute usage month 1
      lv_angmc2    LIKE lv_angdt,      " Start date month comparison 2
      lv_bndmc2    LIKE lv_bnddt,      " End date month comparison 2
      lv_mc2use    TYPE int2.          " Absolute usage month 2

************************************************************************
* RANGES                                                               *
************************************************************************
RANGES r_auart FOR vbak-auart.        " AUART codes according to status

************************************************************************
* SELECTION SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-s01.
PARAMETERS: p_angdt     TYPE dats             " Date start period
                        OBLIGATORY,
            p_bnddt     TYPE dats             " Date end period
                        OBLIGATORY,
            p_bukrs     TYPE iloa-bukrs       " Company code
                        OBLIGATORY,
*            p_werk      TYPE equi-werk        " Stock plant
*                        OBLIGATORY,
            p_vkorg     TYPE iloa-vkorg       " Sales org
                        OBLIGATORY,
            p_vtweg     TYPE iloa-vtweg       " Distr. chan.
                        OBLIGATORY.
*SELECT-OPTIONS: so_bukrs FOR iloa-bukrs,      " company code
*                so_werk  FOR equi-werk,       " stock plant
*                so_vkorg FOR iloa-vkorg,      " sales org
*                so_vtweg FOR iloa-vtweg DEFAULT lc_rent,
SELECT-OPTIONS: so_werk  FOR equi-werk,       " Stock plant
                so_gac   FOR yse_pgc_gac-gac, " GAC
                so_pgc   FOR t179-prodh,      " PGC
                so_model FOR mvke-pmatn,      " model
                so_matnr FOR mara-matnr,      " material nr
                so_equnr FOR equi-equnr,      " equipment
                so_sernr FOR equi-sernr.      " serial nr
SELECTION-SCREEN END OF BLOCK b1.

*SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-s02.
*PARAMETER: cb_cont AS CHECKBOX DEFAULT lc_true,
*           cb_delx AS CHECKBOX,
*           cb_serv AS CHECKBOX.
*SELECTION-SCREEN END OF BLOCK b2.

************************************************************************
* INITIALIZATION                                                       *
************************************************************************
INITIALIZATION.
  gv_repid = sy-repid.

  PERFORM load_own_data.


************************************************************************
* AT SELECTION SCREEN                                                  *
************************************************************************
AT SELECTION-SCREEN.
* Test at least one check box checked
*  IF cb_cont IS INITIAL AND                     " at least one status
*     cb_delx IS INITIAL AND                     " option should be
*     cb_serv IS INITIAL.                        " selected
*    MESSAGE e017.
*  ENDIF.

  PERFORM check_authorization.

* Check if dates are chronologic
  IF ( NOT p_angdt IS INITIAL AND NOT p_bnddt IS INITIAL ).
    IF p_angdt > p_bnddt.
      MESSAGE e033.
    ENDIF.
  ENDIF.

************************************************************************
* START OF SELECTION                                                   *
************************************************************************
START-OF-SELECTION.

  PERFORM preselect_material.

* Select all basic equipment information

*  SELECT iloa~bukrs equi~equnr equi~matnr equi~sernr
*         eqbs~b_werk AS werk
*      INTO CORRESPONDING FIELDS OF TABLE it_eq
*      FROM equi
*     INNER JOIN equz
*        ON equz~equnr   EQ equi~equnr
*     INNER JOIN iloa
*        ON equz~iloan   EQ iloa~iloan
*     INNER JOIN eqbs
*        ON eqbs~equnr   EQ equi~equnr
*     WHERE iloa~bukrs   EQ p_bukrs
*       AND iloa~vkorg   EQ p_vkorg
*       AND iloa~vtweg   EQ p_vtweg
*       AND eqbs~b_werk  EQ p_werk
*       AND equi~equnr   IN so_equnr
*       AND equi~matnr   IN so_matnr
*       AND equi~sernr   IN so_sernr
*       AND ( equi~eqtyp EQ lc_catx
*        OR   equi~eqtyp EQ lc_caty ).

  SELECT equnr
      INTO TABLE it_equ_a
      FROM equi
     WHERE equnr IN so_equnr AND
         ( eqtyp EQ lc_catx   OR
           eqtyp EQ lc_caty ).


* If equipments found
  IF NOT it_equ_a[] IS INITIAL.

*   Second: obtain iloan code for selected equipments
    SELECT equi~equnr
           equi~matnr
           equi~sernr
           eqkt~eqktx
           equz~iloan
           eqbs~b_werk AS werk
        FROM equi
        JOIN equz
          ON equi~equnr = equz~equnr
        JOIN eqkt
          ON equi~equnr = eqkt~equnr
        JOIN eqbs
          ON equi~equnr = eqbs~equnr
        INTO TABLE it_equ_b
         FOR ALL ENTRIES IN it_equ_a
       WHERE equi~equnr EQ it_equ_a-equnr
         AND equz~datbi EQ '99991231'
         AND eqkt~spras EQ 'EN'
         AND equi~equnr  IN so_equnr                " added,
         AND equi~sernr IN so_sernr                 " check with
         AND equi~matnr IN so_matnr.                " Rob Imans
  ENDIF.    " equipments in it_equ_a

* If any entries remain, select the corresponding ILOA lines
  IF NOT it_equ_b[] IS INITIAL.
*   Third: obtain Company Code, Sales Org and Distr. Channel
    SELECT iloan
           bukrs
           vkorg
           vtweg
        INTO TABLE it_equ_c
        FROM iloa
         FOR ALL ENTRIES IN it_equ_b
       WHERE iloan = it_equ_b-iloan.
    SORT it_equ_c.

*   Fourth: Load models and product hierarchies
    SELECT matnr pmatn prodh
        INTO TABLE it_mvke
        FROM mvke
         FOR ALL ENTRIES IN it_equ_b
       WHERE matnr EQ it_equ_b-matnr
         AND vkorg EQ p_vkorg
         AND vtweg EQ p_vtweg.

    SORT it_mvke.
    DELETE ADJACENT DUPLICATES FROM it_mvke.

  ENDIF.    " entries in it_equ_b

  SORT it_equ_b BY iloan.

  LOOP AT it_equ_b.
*   If the plant is the selected depot
    IF it_equ_b-werk IN so_werk.       " EQ p_werk
*Check if the SalesOrg, Distr. chan and sales off. is in the selection
      READ TABLE it_equ_c WITH KEY iloan = it_equ_b-iloan BINARY SEARCH.
      IF sy-subrc EQ 0.
        IF it_equ_c-vkorg EQ p_vkorg AND
           it_equ_c-vtweg EQ p_vtweg AND
           it_equ_c-bukrs EQ p_bukrs.
*         Check model (and read product hierarchy)
          READ TABLE it_mvke WITH KEY matnr = it_equ_b-matnr.
          IF it_mvke-pmatn IN so_model.
            MOVE-CORRESPONDING it_equ_b TO it_eq.
*           Copy model and product hierarchy
            it_eq-pmatn = it_mvke-pmatn.
            it_eq-prodh = it_mvke-prodh.
*           Copy company code
            it_eq-bukrs = it_equ_c-bukrs.
*           Add record
            APPEND it_eq.
          ENDIF.    " Check model
        ENDIF.    " Check VKORG VTWEG BUKRS
      ENDIF.    "  Check ILOA record exists
    ENDIF.    " Check WERK
  ENDLOOP.  " it_equ_b

  SORT it_eq.
  DELETE ADJACENT DUPLICATES FROM it_eq.

* Build PGC/GAC conversion table
  PERFORM load_pgc_gac.

* Check if PGC/GAC codes are as selected
  LOOP AT it_eq.
    READ TABLE it_pgc WITH KEY pgc = it_eq-prodh.
    IF NOT ( it_pgc-pgc IN so_pgc ) OR
       NOT ( it_pgc-gac IN so_gac ).
      DELETE it_eq.
    ENDIF.    " check PGC GAC
  ENDLOOP.  " it_eq

* Count selected records
  DESCRIBE TABLE it_eq LINES lv_records.
  IF lv_records > 0.

*   Get all equipments' acquisition dates
    SELECT equz~equnr anla~zugdt
        INTO TABLE it_invest
        FROM equz
        JOIN iloa
          ON equz~iloan EQ iloa~iloan
        JOIN anla
          ON iloa~anlnr EQ anla~anln1
         FOR ALL entries IN it_eq
       WHERE equz~equnr EQ it_eq-equnr
         AND anla~bukrs EQ p_bukrs.
*         AND equz~equzn EQ '000'
*         AND anlc~afabe EQ '30'.

*   Create list of unique material numbers from itob
    LOOP AT it_eq.
      wa_matnr-matnr = it_eq-matnr.
      APPEND wa_matnr TO it_matnr.
    ENDLOOP.
    SORT it_matnr BY matnr.
    DELETE ADJACENT DUPLICATES FROM it_matnr.

*   Get material description for selected materials
    SELECT matnr maktx
        INTO TABLE it_makt
        FROM makt
         FOR ALL ENTRIES IN it_matnr
       WHERE matnr = it_matnr-matnr
         AND spras = lc_engl.

*   Description should be equipment description according
*   to Stefan Debois. There is no descr. is spec on 15/03/2007.
*   To change: EQKT-EQUNR, EQKT-SPRAS, EQKT-EQKTX

*   Get models for all selected materials
    SELECT matnr pmatn
        INTO TABLE it_models
        FROM mvke
        FOR ALL ENTRIES IN it_eq
       WHERE matnr EQ it_eq-matnr
         AND pmatn NE space.

    SORT it_models.
    DELETE ADJACENT DUPLICATES FROM it_models.

*   Get material description for selected models
    SELECT matnr maktx
        APPENDING TABLE it_makt
        FROM makt
         FOR ALL ENTRIES IN it_models
       WHERE matnr = it_models-model
         AND spras = lc_engl.

*   Get product hierarch for all materials
    SELECT matnr prdha
        INTO TABLE it_mara
        FROM mara
         FOR ALL ENTRIES IN it_eq
       WHERE matnr = it_eq-matnr.

    SORT it_mara.
    DELETE ADJACENT DUPLICATES FROM it_mara.

    LOOP AT it_eq.
      READ TABLE it_mara WITH KEY matnr = it_eq-matnr.
      it_eq-prdha = it_mara-prdha.
      MODIFY it_eq.
    ENDLOOP.

  ENDIF.    " IT_ITOB not empty

* Build sales doc type option list
  r_auart-sign = 'I'.
  r_auart-option = 'EQ'.
  r_auart-low = lc_cont.
  APPEND r_auart.
  r_auart-low = lc_deli.
  APPEND r_auart.
  r_auart-low = lc_delo.
  APPEND r_auart.
  r_auart-low = lc_serv.
  APPEND r_auart.

  SELECT zzequnr matnr zzsernr angdt bnddt auart
      FROM yse_rent_sme
      INTO TABLE it_sme
       FOR ALL ENTRIES IN it_eq
     WHERE zzequnr EQ it_eq-equnr
       AND auart IN r_auart.

* Fill table with PGC codes
  SORT it_eq BY prdha.
  LOOP AT it_eq.
    IF it_eq-prdha <> it_pgc-pgc.
      it_pgc-pgc = it_eq-prdha.
      APPEND it_pgc.
    ENDIF.
  ENDLOOP.  " it_eq

* Get the corresponding GAC codes for the PGC codes
  CALL FUNCTION 'YSE_CONVERT_PGC_GAC'
    TABLES
      it_pgc_gac = it_pgc.
  SORT it_pgc BY pgc.

***********************************************************
*                      LOOP                               *
***********************************************************
* Sort it_sme by unique equipment number and by start date
  SORT it_sme BY zzequnr angdt.

* Initialization
  CLEAR it_result.
  CLEAR lv_inloop.

* Calculate first of month
  lv_dtms = sy-datum.
  lv_dtms+6(2) = '01'.                " first of month
* Calculate first of year
  lv_dtys = sy-datum.
  lv_dtys+4(4) = '0101'.              " first of January
* Calculate one year ago
  lv_dtya = sy-datum - 365.           " day to day one year ago
* Calculate end of this month
  lv_dtme = lv_dtms.                  " first of month
  lv_dtme+4(2) = lv_dtme+4(2) + 1.    " add 1 month
  lv_dtme = lv_dtme - 1.              " substract 1 day
* Calculate one month ago
  lv_dtma = sy-datum.
  lv_dtma+4(2) = lv_dtma+4(2) - 1.    " one month ago
  IF lv_dtma+4(2) = '00'.
    lv_dtma+4(2) = '12'.
  ENDIF.
  lv_dtma+6(2) = '01'.                " first of month
* Calculate one month and a year ago
  lv_dtym = sy-datum.
  lv_dtym(4) = lv_dtym(4) - 1.        " substract 1 year
  lv_dtym+6(2) = '01'.                " first of that month
  lv_dtym+4(2) = lv_dtym+4(2) - 1.    " substract a month
  IF lv_dtym+4(2) = '00'.
    lv_dtym+4(2) = '12'.
  ENDIF.

* Scan through all unique equipments
  SORT it_eq BY equnr.
  LOOP AT it_eq.
*   Copy static data
    it_result-bukrs  = it_eq-bukrs.    " Company Code
    it_result-werk   = it_eq-werk.      " Plant
    READ TABLE it_pgc
      WITH KEY pgc   = it_eq-prdha
      BINARY SEARCH.
    it_result-gac    = it_pgc-gac.
    it_result-pgc    = it_pgc-pgc.

*   Model description
    READ TABLE it_models
      WITH KEY matnr = it_eq-matnr.
    READ TABLE it_makt
      WITH KEY matnr = it_models-model.
    it_result-model  = it_models-model.
    it_result-modesc = it_makt-maktx.

*   Material description
    READ TABLE it_makt
      WITH KEY matnr = it_eq-matnr.
    it_result-matnr = it_eq-matnr.
    it_result-mater = it_makt-maktx.

*   Equipment's Equipment & Serial number
    it_result-equnr = it_eq-equnr.
    it_result-sernr = it_eq-sernr.

*   Get acquisition date
    READ TABLE it_invest WITH KEY equnr = it_eq-equnr.

*   Add days used per rental record
    LOOP AT it_sme
      WHERE zzequnr = it_eq-equnr.

      lv_inloop = lc_true.            " passed through the it_sme loop

*     Within selection period
      IF it_sme-angdt < p_angdt.          " start date
        lv_angdt = p_angdt.
      ELSE.
        lv_angdt = it_sme-angdt.
      ENDIF.
      IF it_invest-zugdt > lv_angdt.        " recent investment date
        lv_angdt = it_invest-zugdt.
      ENDIF.
      IF it_sme-bnddt > p_bnddt.          " end date
        lv_bnddt = p_bnddt.
      ELSE.
        lv_bnddt = it_sme-bnddt.
      ENDIF.
*     If dates within range...
      lv_period = lv_bnddt - lv_angdt + 1.
      IF lv_period > 0.
*       Contract
        IF it_sme-auart = lc_cont.
          it_result-absuse = it_result-absuse + lv_period.
        ENDIF.
*       Delivery
        IF it_sme-auart = lc_deli OR
           it_sme-auart = lc_delo.
          it_result-in_tra_ab = it_result-in_tra_ab + lv_period.
        ENDIF.
*       Service Order
        IF it_sme-auart = lc_serv.
          it_result-in_ser_ab = it_result-in_ser_ab + lv_period.
        ENDIF.
      ENDIF.

*     Within month to date
      IF it_sme-angdt < lv_dtms.          " first of month
        lv_angmtd = lv_dtms.
      ELSE.
        lv_angmtd = it_sme-angdt.
      ENDIF.
      IF it_invest-zugdt > lv_angmtd.       " recent investment date
        lv_angmtd = it_invest-zugdt.
      ENDIF.
      IF it_sme-bnddt > sy-datum.         " today's date
        lv_bndmtd = sy-datum.
      ELSE.
        lv_bndmtd = it_sme-bnddt.
      ENDIF.
*     If dates within range...
      lv_period = lv_bndmtd - lv_angmtd + 1.
      IF lv_period > 0.
*       Contract
        IF it_sme-auart = lc_cont.
          lv_mtduse = lv_mtduse + lv_period.
        ENDIF.
      ENDIF.

*     Within year to date
      IF it_sme-angdt < lv_dtys.         " start of year
        lv_angytd = lv_dtys.
      ELSE.
        lv_angytd = it_sme-angdt.
      ENDIF.
      IF it_invest-zugdt > lv_angytd.       " recent investment date
        lv_angytd = it_invest-zugdt.
      ENDIF.
      IF it_sme-bnddt > lv_dtme.         " end of month
        lv_bndytd = lv_dtme.
      ELSE.
        lv_bndytd = it_sme-bnddt.
      ENDIF.
*     If dates within range...
      lv_period = lv_bndytd - lv_angytd + 1.
      IF lv_period > 0.
*       Contract
        IF it_sme-auart = lc_cont.
          lv_ytduse = lv_ytduse + lv_period.
        ENDIF.
      ENDIF.

*     Within 12 months rolling
      IF it_sme-angdt < lv_dtya.
        lv_angrol = lv_dtya.
      ELSE.
        lv_angrol = it_sme-angdt.
      ENDIF.
      IF it_invest-zugdt > lv_angrol.       " recent investment date
        lv_angrol = it_invest-zugdt.
      ENDIF.
      IF it_sme-bnddt > sy-datum.        " today's date
        lv_bndrol = sy-datum.
      ELSE.
        lv_bndrol = it_sme-bnddt.
      ENDIF.
*     If dates within range...
      lv_period = lv_bndrol - lv_angrol + 1.
      IF lv_period > 0.
*       Contract
        IF it_sme-auart = lc_cont.
          lv_roluse = lv_roluse + lv_period.
        ENDIF.
      ENDIF.

*     Compare with same month last year
*     Month this year...
      IF it_sme-angdt < lv_dtma.
        lv_angmc1 = lv_dtma.
      ELSE.
        lv_angmc1 = it_sme-angdt.
      ENDIF.
      IF it_invest-zugdt > lv_angmc1.       " recent investment date
        lv_angmc1 = it_invest-zugdt.
      ENDIF.
      IF it_sme-bnddt > sy-datum.         " today's date
        lv_bndrol = sy-datum.
      ELSE.
        lv_bndrol = it_sme-bnddt.
      ENDIF.
*     If dates within range...
      lv_period = lv_bndrol - lv_angrol + 1.
      IF lv_period > 0.
*       Contract
        IF it_sme-auart = lc_cont.
          lv_mc1use = lv_mc1use + lv_period.
        ENDIF.
      ENDIF.

*     Month last year...
      IF it_sme-angdt < lv_dtym.          " one year and a month ago
        lv_angmc2 = lv_dtym.
      ELSE.
        lv_angmc2 = it_sme-angdt.
      ENDIF.
      IF it_invest-zugdt > lv_angmc2.       " recent investment date
        lv_angmc2 = it_invest-zugdt.
      ENDIF.
      IF it_sme-bnddt > lv_dtya.          " date one year ago
        lv_bndmc2 = lv_dtya.
      ELSE.
        lv_bndmc2 = it_sme-bnddt.
      ENDIF.
*     If dates within range...
      lv_period = lv_bndmc2 - lv_angmc2 + 1.
      IF lv_period > 0.
*       Contract
        IF it_sme-auart = lc_cont.
          lv_mc2use = lv_mc2use + lv_period.
        ENDIF.
      ENDIF.

    ENDLOOP.    " it_sme

*   Determine selected period
    IF it_invest-zugdt > p_angdt.         " recent investment date
      lv_period = p_bnddt - it_invest-zugdt + 1.
    ELSE.
      lv_period = p_bnddt - p_angdt + 1.
    ENDIF.
    it_result-period = lv_period.
    IF lv_period > 0.
*     Absolute usage
      it_result-peruse = it_result-absuse * 100 / lv_period.
*     Ineficency due to transport
      it_result-in_tra_pr = it_result-in_tra_ab * 100 / lv_period.
*     Inefficienct due to service
      it_result-in_ser_pr = it_result-in_ser_ab * 100 / lv_period.
    ELSE.
      it_result-peruse = 0.
    ENDIF.

*   Total Inefficiency
*    it_result-infabs = it_result-period - it_result-absuse.
*   Note: Inefficiency does no longer comprise availability in yard.
    it_result-infabs = it_result-in_tra_ab + it_result-in_ser_ab.
*    IF it_result-infabs < 0.
*      it_result-infabs = 0.
*    ENDIF.
    IF lv_period > 0.
      it_result-infper = it_result-infabs * 100 / lv_period.
    ENDIF.
*    it_result-infper = 100 - it_result-peruse.
*    IF it_result-infper < 0.
*      it_result-infper = 0.
*    ENDIF.

*   Inefficiency due to availibility (Yard)
    it_result-in_una_ab = lv_period - it_result-absuse -
                          it_result-in_tra_ab - it_result-in_ser_ab.
    IF it_result-in_una_ab < 0.
      it_result-in_una_ab = 0.
    ENDIF.
    IF lv_period > 0.
      it_result-in_una_pr = it_result-in_una_ab / lv_period * 100.
    ELSE.
      it_result-in_una_pr = 0.
    ENDIF.

*   If values have changed
    IF lv_inloop = lc_true.

*     Month to date
      IF it_invest-zugdt > lv_dtms.         " recent investment date
        lv_period = sy-datum - it_invest-zugdt + 1.
      ELSE.
        lv_period = sy-datum - lv_dtms + 1.
      ENDIF.
      IF lv_period > 0.
        it_result-mtduse = lv_mtduse * 100 / lv_period.
      ELSE.
        it_result-mtduse = 0.
      ENDIF.

*     Year to date
      IF it_invest-zugdt > lv_dtys.         " recent investment date
        lv_period = lv_dtme - it_invest-zugdt + 1.
      ELSE.
        lv_period = lv_dtme - lv_dtys + 1.
      ENDIF.
      IF lv_period > 0.
        it_result-ytduse = lv_ytduse * 100 / lv_period.
      ELSE.
        it_result-ytduse = 0.
      ENDIF.

*     12 months rolling
      IF it_invest-zugdt > lv_dtya.         " recent investment date
        lv_period = sy-datum - it_invest-zugdt + 1.
      ELSE.
        lv_period = sy-datum - lv_dtya + 1.
      ENDIF.
      IF lv_period > 0.
        it_result-roluse = lv_roluse * 100 / lv_period.
      ELSE.
        it_result-roluse = 0.
      ENDIF.
      it_result-rolinf = 100 - it_result-roluse.

*     Month comparison
      IF lv_mc2use > 0.
        it_result-comuse = lv_mc1use * 100 / lv_mc2use.
      ELSE.
        it_result-comuse = 999999.        " to infinity and beyond!
      ENDIF.

    ENDIF.   " went through it_sme loop

    APPEND it_result.

    CLEAR lv_inloop.
    CLEAR lv_period.
    CLEAR lv_mtduse.
    CLEAR lv_ytduse.
    CLEAR lv_angmtd.
    CLEAR lv_bndmtd.
    CLEAR lv_angytd.
    CLEAR lv_bndytd.
    CLEAR lv_roluse.
    CLEAR it_result.

  ENDLOOP.    " it_itob

* Prepare header data
  PERFORM build_header.
* Display results
  CALL SCREEN 100.



************************************************************************
* FORM: LOAD_OWN_DATA                                                  *
************************************************************************
* User's own parameters are retrieved and entered in select options.   *
************************************************************************
FORM load_own_data.

* Load user's parameters
* Company Code
  GET PARAMETER ID 'BUK' FIELD lv_bukrs.
  p_bukrs = lv_bukrs.

* Plant
*  GET PARAMETER ID 'WRK' FIELD lv_werks.
*  p_werk = lv_werks.

* Sales organisation
  GET PARAMETER ID 'VKO' FIELD lv_vkorg.
  p_vkorg = lv_vkorg.

* Distribution Channel
  GET PARAMETER ID 'VTW' FIELD lv_vtweg.
  p_vtweg = lv_vtweg.

* Material number
  GET PARAMETER ID 'MAT' FIELD lv_matnr.
  IF NOT lv_matnr IS INITIAL.
    so_matnr-sign = 'I'.
    so_matnr-option = 'EQ'.
    so_matnr-low = lv_matnr.
    APPEND so_matnr.
  ENDIF.

* Equipment number
  GET PARAMETER ID 'EQN' FIELD lv_equnr.
  IF NOT lv_equnr IS INITIAL.
    so_equnr-sign = 'I'.
    so_equnr-option = 'EQ'.
    so_equnr-low = lv_equnr.
    APPEND so_equnr.
  ENDIF.

* Serial number
  GET PARAMETER ID 'SER' FIELD lv_sernr.
  IF NOT lv_sernr IS INITIAL.
    so_sernr-sign = 'I'.
    so_sernr-option = 'EQ'.
    so_sernr-low = lv_sernr.
    APPEND so_sernr.
  ENDIF.

ENDFORM.  " load_own_data


************************************************************************
* FORM: PRESELECT MATERIAL                                             *
************************************************************************
FORM preselect_material.

  DATA: BEGIN OF lt_matnr OCCURS 0,
          matnr TYPE matnr,
        END OF lt_matnr.

  IF NOT so_model IS INITIAL.

*   Note: if materials in so_matnr should also be included, remove
*         next CLEAR/REFRESH and append materials from model instead.
    CLEAR so_matnr.
    REFRESH so_matnr.

*   Get all material numbers for selected models...
    SELECT matnr
        INTO TABLE lt_matnr
        FROM mvke
       WHERE pmatn IN so_model
         AND vkorg EQ p_vkorg
         AND vtweg EQ p_vtweg.

    SORT lt_matnr.
    DELETE ADJACENT DUPLICATES FROM lt_matnr.

    so_matnr-sign = 'I'.
    so_matnr-option = 'EQ'.
    so_matnr-high = space.

*   and add them to the list of selected materials.
    LOOP AT lt_matnr.
      so_matnr-low = lt_matnr-matnr.
      APPEND so_matnr.
    ENDLOOP.

    SORT so_matnr.
    DELETE ADJACENT DUPLICATES FROM so_matnr.
  ENDIF.    " so_model NOT INITIAL
ENDFORM.  " preselect_material


************************************************************************
*  Form LOAD_PGC_GAC                                                   *
************************************************************************
FORM load_pgc_gac.

  IF NOT it_eq[] IS INITIAL.

*   Fill table with PGC codes from it_eq
    SORT it_eq BY prodh.
    LOOP AT it_eq.
      IF it_eq-prodh <> it_pgc-pgc.
        it_pgc-pgc = it_eq-prodh.
        APPEND it_pgc.
      ENDIF.
    ENDLOOP.  " it_vbap

*   Get the corresponding GAC codes for the PGC codes
    CALL FUNCTION 'YSE_CONVERT_PGC_GAC'
      TABLES
        it_pgc_gac = it_pgc.
    SORT it_pgc BY pgc.
  ENDIF.    " records in it_eq

ENDFORM.    " load_pgc_gac


************************************************************************
**
** FORM  BUILD_HEADER
**
************************************************************************
**
*Prepares selection parameters to be displayed in header banner.       *
************************************************************************
**
FORM build_header.

  o_bukrs = p_bukrs.
*  o_werks = p_werk.
  o_vkorg = p_vkorg.
* Start date
  o_angdt(2)   = p_angdt+6(2).
  o_angdt+2    = '.'.
  o_angdt+3(2) = p_angdt+4(2).
  o_angdt+5    = '.'.
  o_angdt+6(4) = p_angdt(4).
* End date
  o_bnddt(2)   = p_bnddt+6(2).
  o_bnddt+2    = '.'.
  o_bnddt+3(2) = p_bnddt+4(2).
  o_bnddt+5    = '.'.
  o_bnddt+6(4) = p_bnddt(4).

ENDFORM.  " build_header


************************************************************************
**
** Module STATUS_0100 OUTPUT
**
************************************************************************
**
MODULE status_0100 OUTPUT.
  SET TITLEBAR '100' .
  SET PF-STATUS 'STATUS100'.
ENDMODULE.                 " STATUS_0100  OUTPUT

************************************************************************
**
** Module USER_COMMAND_0100 INPUT
**
************************************************************************
**
MODULE user_command_0100 INPUT.
  CASE okcode.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
  ENDCASE.  " okcode
ENDMODULE.  " USER_COMMAND_0100 INPUT

************************************************************************
**
** Module PREPARE_SCREEN OUTPUT
**
************************************************************************
**
MODULE prepare_screen OUTPUT.

  IF obj_container IS INITIAL.

*   Create the container
    CREATE OBJECT obj_container
      EXPORTING
          repid           =  sy-repid
          dynnr           =  sy-dynnr
          lifetime        =  cntl_lifetime_dynpro
*          ratio           =  90.
          extension       =  285
          side  = cl_gui_docking_container=>dock_at_bottom.

*   Create the ALV control
    CREATE OBJECT obj_alv
      EXPORTING
          i_parent  =  obj_container.

    PERFORM build_alv.
  ENDIF.    " obj_container INITIAL

ENDMODULE.                 " PREPARE_SCREEN  OUTPUT


************************************************************************
***
*** Form BUILD_ALV
**
************************************************************************
***
FORM build_alv.

  REFRESH: it_fieldcat.

* Build field catalog
  CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
    EXPORTING
      i_buffer_active  = ' '
      i_structure_name = 'YSE_REN_ALV_PHYSUTIL'
    CHANGING
      ct_fieldcat      = it_fieldcat.

* Column descriptions and widths
  LOOP AT it_fieldcat ASSIGNING <fieldcat>.
    CASE <fieldcat>-fieldname.
      WHEN  'BUKRS'.
        <fieldcat>-scrtext_l = 'Company code'(001).
        <fieldcat>-scrtext_m = 'Comp.code'(002).
        <fieldcat>-scrtext_s = 'CCode'(003).
        <fieldcat>-outputlen = 5.
      WHEN  'WERK'.
        <fieldcat>-scrtext_l = 'Plant'(004).
        <fieldcat>-scrtext_m = 'Plant'(005).
        <fieldcat>-scrtext_s = 'Plant'(006).
        <fieldcat>-outputlen = 4.
      WHEN  'GAC'.
        <fieldcat>-scrtext_l = 'GAC'(007).
        <fieldcat>-scrtext_m = 'GAC'(008).
        <fieldcat>-scrtext_s = 'GAC'(009).
        <fieldcat>-outputlen = 4.
      WHEN  'PGC'.
        <fieldcat>-scrtext_l = 'PGC'(010).
        <fieldcat>-scrtext_m = 'PGC'(011).
        <fieldcat>-scrtext_s = 'PGC'(012).
        <fieldcat>-outputlen = 6.
      WHEN  'MODEL'.
        <fieldcat>-scrtext_l = 'Model number'(013).
        <fieldcat>-scrtext_m = 'Model nr'(014).
        <fieldcat>-scrtext_s = 'Model'(015).
        <fieldcat>-outputlen = 5.
      WHEN  'MODESC'.
        <fieldcat>-scrtext_l = 'Model description'(071).
        <fieldcat>-scrtext_m = 'Model desc'(072).
        <fieldcat>-scrtext_s = 'Desc'(073).
        <fieldcat>-outputlen = 5.
      WHEN  'MATNR'.
        <fieldcat>-scrtext_l = 'Material number'(074).
        <fieldcat>-scrtext_m = 'Material'(075).
        <fieldcat>-scrtext_s = 'Mat nr'(076).
        <fieldcat>-outputlen = 10.
      WHEN  'MATER'.
        <fieldcat>-scrtext_l = 'Material description'(016).
        <fieldcat>-scrtext_m = 'Mat desc'(017).
        <fieldcat>-scrtext_s = 'Desc'(018).
        <fieldcat>-outputlen = 25.
      WHEN  'EQUNR'.
        <fieldcat>-scrtext_l = 'Equipment number'(019).
        <fieldcat>-scrtext_m = 'Equipment'(020).
        <fieldcat>-scrtext_s = 'Equ'(021).
        <fieldcat>-outputlen = 12.
      WHEN  'SERNR'.
        <fieldcat>-scrtext_l = 'Serial number'(022).
        <fieldcat>-scrtext_m = 'Serial'(023).
        <fieldcat>-scrtext_s = 'Ser'(024).
        <fieldcat>-outputlen = 12.
      WHEN  'ABSUSE'.
        <fieldcat>-scrtext_l = 'Physical Utilization'(025).
        <fieldcat>-scrtext_m = 'Phys Util'(026).
        <fieldcat>-scrtext_s = 'Phys'(027).
        <fieldcat>-outputlen = 9.
      WHEN  'PERIOD'.
        <fieldcat>-scrtext_l = 'Period in days'(028).
        <fieldcat>-scrtext_m = 'Period'(029).
        <fieldcat>-scrtext_s = 'Per'(030).
        <fieldcat>-outputlen = 9.
      WHEN  'PERUSE'.
        <fieldcat>-scrtext_l = 'Usage (percent)'(031).
        <fieldcat>-scrtext_m = 'Perc use'(032).
        <fieldcat>-scrtext_s = 'Use(%)'(033).
        <fieldcat>-outputlen = 9.
      WHEN  'MTDUSE'.
        <fieldcat>-scrtext_l = 'Month to Day usage (percent)'(034).
        <fieldcat>-scrtext_m = 'Month to Day (%)'(035).
        <fieldcat>-scrtext_s = 'MtD(%)'(036).
        <fieldcat>-outputlen = 9.
      WHEN  'YTDUSE'.
        <fieldcat>-scrtext_l = 'Year to Day usage (percent)'(037).
        <fieldcat>-scrtext_m = 'Year to Day (%)'(038).
        <fieldcat>-scrtext_s = 'YtD(%)'(039).
        <fieldcat>-outputlen = 9.
      WHEN  'ROLUSE'.
        <fieldcat>-scrtext_l = 'Rolling Month usage (percent)'(040).
        <fieldcat>-scrtext_m = 'Rolling Month (%)'(041).
        <fieldcat>-scrtext_s = 'RM(%)'(042).
        <fieldcat>-outputlen = 9.
      WHEN  'COMUSE'.
        <fieldcat>-scrtext_l = 'Month comparison (percent)'(043).
        <fieldcat>-scrtext_m = 'Month comp (%)'(044).
        <fieldcat>-scrtext_s = 'MC(%)'(045).
        <fieldcat>-outputlen = 9.
      WHEN  'INFABS'.
        <fieldcat>-scrtext_l = 'Total Inefficiency (in days)'(046).
        <fieldcat>-scrtext_m = 'Tot Ineff (days)'(047).
        <fieldcat>-scrtext_s = 'Ineff (days)'(048).
        <fieldcat>-outputlen = 9.
      WHEN  'INFPER'.
        <fieldcat>-scrtext_l = 'Total Inefficiency (percent)'(049).
        <fieldcat>-scrtext_m = 'Tot Ineff (%)'(050).
        <fieldcat>-scrtext_s = 'Ineff (%)'(051).
        <fieldcat>-outputlen = 9.
      WHEN  'IN_TRA_AB'.
        <fieldcat>-scrtext_l =
        'Inefficiency due to Transport (in days)'(052).
        <fieldcat>-scrtext_m = 'Ineff Transport (days)'(053).
        <fieldcat>-scrtext_s = 'Ineff Tra (days)'(054).
        <fieldcat>-outputlen = 9.
      WHEN  'IN_TRA_PR'.
        <fieldcat>-scrtext_l =
        'Inefficiency due to Transport (percent)'(055).
        <fieldcat>-scrtext_m = 'Ineff Transp (%)'(056).
        <fieldcat>-scrtext_s = 'Ineff(%)'(057).
        <fieldcat>-outputlen = 9.
      WHEN  'IN_SER_AB'.
        <fieldcat>-scrtext_l =
        'Inefficiency due to Service (in days)'(058).
        <fieldcat>-scrtext_m = 'Ineff Service (days)'(059).
        <fieldcat>-scrtext_s = 'Ineff Serv (days)'(060).
        <fieldcat>-outputlen = 9.
      WHEN  'IN_SER_PR'.
        <fieldcat>-scrtext_l =
        'Inefficiency due to Service (percent)'(061).
        <fieldcat>-scrtext_m = 'Ineff Service (%)'(062).
        <fieldcat>-scrtext_s = 'Ineff(%)'(063).
        <fieldcat>-outputlen = 9.
      WHEN  'IN_UNA_AB'.
        <fieldcat>-scrtext_l = 'Inefficiency Avail. (in days)'(064).
        <fieldcat>-scrtext_m = 'Ineff Avail (days)'(065).
        <fieldcat>-scrtext_s = 'Avail (days)'(066).
        <fieldcat>-outputlen = 9.
      WHEN  'IN_UNA_PR'.
        <fieldcat>-scrtext_l = 'Inefficiency Avail. (percent)'(067).
        <fieldcat>-scrtext_m = 'Ineff Avail (%)'(068).
        <fieldcat>-scrtext_s = 'Avail(%)'(069).
        <fieldcat>-outputlen = 9.
      WHEN  'ROLINF'.
        <fieldcat>-scrtext_l =
        'Inefficiency 12 Month Rolling (percent)'(070).
        <fieldcat>-scrtext_m = 'Inefficency 12m Rolling (%)'(071).
        <fieldcat>-scrtext_s = 'Ineff 12m Rol (%)'(072).
        <fieldcat>-outputlen = 9.
    ENDCASE.
  ENDLOOP.

* Build layout, including default variant with subtotals
*  gs_variant-report = sy-repid.
*  gs_variant-variant = '/SUB_TOTALS'.
*  gs_layout-no_toolbar = lc_true.
*  gs_layout-sel_mode   = 'B'.        " single row selectable
*   gs_layout-smalltitle = lc_true.
*   lv_title = 'Status options:'(052).
*   IF cb_cont = lc_true.
*     CONCATENATE lv_title
*                 'rental'
*            INTO lv_title
*       SEPARATED BY space.
*   ENDIF.
*   IF cb_delx = lc_true.
*     CONCATENATE lv_title
*                 'transport'
*            INTO lv_title
*       SEPARATED BY space.
*   ENDIF.
*   IF cb_serv = lc_true.
*     CONCATENATE lv_title
*                 'service'
*            INTO lv_title
*       SEPARATED BY space.
*   ENDIF.
*   gs_layout-grid_title = lv_title.

  gs_layout-cwidth_opt = lc_true.

  CALL METHOD obj_alv->set_table_for_first_display
    EXPORTING
      i_structure_name              = 'YSE_REN_ALV_PHYSUTIL'
      is_layout                     = gs_layout
*      is_variant                    = gs_variant
*      i_save                        = 'A'
    CHANGING
      it_outtab                     = it_result[]
      it_fieldcatalog               = it_fieldcat
    EXCEPTIONS
      invalid_parameter_combination = 1
      program_error                 = 2
      too_many_lines                = 3
      OTHERS                        = 4.

  IF sy-subrc <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*     WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.
ENDFORM.                    "build_alv
*&---------------------------------------------------------------------*
*&      Form  Check_Authorization
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_authorization .

  DATA: it_t001k TYPE STANDARD TABLE OF t001k WITH HEADER LINE.

*get the plants for this company code.
  SELECT        * FROM  t001k
        INTO TABLE it_t001k
         WHERE  bukrs  = p_bukrs.

  LOOP AT it_t001k.
    AUTHORITY-CHECK OBJECT 'I_SWERK'
             ID 'TCD' DUMMY
             ID 'SWERK' FIELD it_t001k-bwkey.

    IF sy-subrc = 4.
*   No authorisation to display data from Sales Organisation p_vkorg
     MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '008' WITH p_bukrs.
      EXIT.
    ELSEIF sy-subrc <> 0.
*   Error checking authorization.
      MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " Check_Authorization

*Text symbol text£º
*001:Company code
*002:Comp code
*003:CCode
*004:Plant
*005:Plant
*006:Plant
*007:GAC
*008:GAC
*009:GAC
*010:PGC
*011:PGC
*012:PGC
*013:Model number
*014:Model nr
*015:Model
*016:Material description
*017:Mat desc
*018:Desc
*019:Equipment number
*020:Equipment
*021:Equ
*022:Serial number
*023:Serial
*024:Ser
*025:Physical Utilization
*026:Phys Util
*027:Phys
*028:Period in days
*029:Period
*030:Per
*031:Usage (percent)
*032:Perc use
*033:Use(%)
*034:Month to Day usage (percent)
*035:Month to Day (%)
*036:MtD(%)
*037:Year to Day usage (percent)
*038:Year to Day (%)
*039:YtD(%)
*040:Rolling Month usage (percent)
*041:Rolling Month (%)
*042:RM(%)
*043:Month comparison (percent)
*044:Month comp (%)
*045:MC(%)
*046:Total Inefficiency (in days)
*047:Tot Ineff (days)
*048:Ineff (days)
*049:Total Inefficiency (percent)
*050:Tot Ineff (%)
*051:Ineff (%)
*052:Inefficiency due to Transport (in days)
*053:Ineff Transport (days)
*054:Ineff Tra (days)
*055:Inefficiency due to Transport (percent)
*056:Ineff Transp (%)
*057:Ineff(%)
*058:Inefficiency due to Service (in days)
*059:Ineff Service (days)
*060:Ineff Serv (days)
*061:Inefficiency due to Service (percent)
*062:Ineff Service (%)
*063:Ineff(%)
*064:Inefficiency Avail. (in days)
*065:Ineff Avail (days)
*066:Avail (days)
*067:Inefficiency Avail. (percent)
*068:Ineff Avail (%)
*069:Avail(%)
*070:Inefficiency 12 Month Rolling (percent)
*071:Inefficency 12m Rolling (%)
*072:Ineff 12m Rol (%)
*073:Desc
*074:Material number
*075:Material
*076:Mat nr
*P01:Over Time Period
*P02:Month to Date
*P03:Year to Date
*P04:12 Months Rolling
*S01:Selection parameters

*S02:Status
*Selection text£º
*P_ANGDT:        Start date
*P_BNDDT:        End date
*P_BUKRS:        Company code
*P_VKORG:        Sales organisation
*P_VTWEG:        Distribution channel
*SO_EQUNR:        Equipment number
*SO_GAC:        GAC
*SO_MATNR:        Material
*SO_MODEL:        Model
*SO_PGC:        PGC
*SO_SERNR:        Serial number
*SO_WERK:        Plant
