*********************************************************************
* Report  : YSE_SD_SALES                                            *
*-------------------------------------------------------------------*
* Author  : Kurt Clement                                            *
* Company : Atlas Copco                                             *
* Created : 27.12.2006                                              *
* Dev.nbr : D065 - Sales reporting                                  *
*-------------------------------------------------------------------*
* This program will cover a lot of different sales reports          *
*********************************************************************
*********************************************************************
* Amendment to Report by Dips Naik, 11th December 2007.
* Dev.nbr : D405 - End Customer Report
* This report now allows a user to process in the background whilst
* picking up end customer information. The file will reside on the
* application server then they may retrieve the file and import
* into Microsoft Excel using the deliminator as |
* The standard ALV report now has 3 extra fields
*-------------------------------------------------------------------*
* 2008.03.27 Issue: 4426 PDudas air23037                            *
*     Add new columns sold to, bill to, ship to, endcust name       *
*-------------------------------------------------------------------*
* 2008.04.16 Issue: 4601 PDudas air23037                            *
*     Add new columns: ship to NAICS, mat group, sold to cust grp   *
*-------------------------------------------------------------------*
* 2008.04.22 Issue: 4244 PDudas air23037                            *
*     New stuff: D065 section 3.1.3                                 *
*-------------------------------------------------------------------*
* 2008.04.22 Issue: 4727 PDudas air23037                            *
*     bugfix           still to be done                             *
*-------------------------------------------------------------------*
*-------------------------------------------------------------------*
* 2008.05.30 Issue: CR0128 Addition of 2 new fields                 *
* Uzzawal Vemparala    Transport # CD1K940912
*-------------------------------------------------------------------*
* 2008.06.24 Issue:  PROE-7FQ3FX::Addition of Accounting Document   *
* Uzzawal Vemparala    Transport # CD1K941515                       *
*-------------------------------------------------------------------*
* 2008.06.25 Issue:  CR0273:: Invoice is missing for  Debit Memo Req*
* CVM      Transport #                                              *
*-------------------------------------------------------------------*
* 2008.06.25 Issue:  CR0273:: Accounting Doc is missing             *
* CVM      Transport #                                              *
*-------------------------------------------------------------------*
* 2008.07.17 Issue:  CR0271: Set InvoiceCost field to negative      *
* CVM      Transport #                                              *
*-------------------------------------------------------------------*
* 2008.09.26 Issue:  Limit selection on creation date (s_erdat3)    *
* LME                                                               *
*-------------------------------------------------------------------*
* 2008.10.09 Issue: Limit selection expanded to 3 months (92 days)  *
* MJ                                                                *
*-------------------------------------------------------------------*
* 2008.10.09 Issue: CR0409 select more records of VBFA              *
* MJ                                                                *
*-------------------------------------------------------------------*
* 2008.12.01 Incident 1291: adjust sign to show on screen           *
* LME                                                               *
*-------------------------------------------------------------------*
* 2009.01.20 Issue: CR0465 + CR0393:                                *
*                   Performance improvements + extra fields         *
*            Indication: js-001     Transport: CD1K945778           *
*-------------------------------------------------------------------*
* 2009.04.02 Issue: 3579 JPY Currency Issue                         *
* Uzzawal Vemparala    Transport # CD1K947414                       *
*-------------------------------------------------------------------*
* 2009.04.10 Issue: CR0756: Changes for YSE_SL_REPORTING            *
*                   New table for invoiced orders + extra fields    *
*            Indication: js-002     Transport: CD1K947589           *
*-------------------------------------------------------------------*
* 2009.08.05 CR0905-MATERIAL short text from VA03                   *
* Uzzawal Vemparala    Transport # CD1K949589                       *
*-------------------------------------------------------------------*
* 2009.08.12 Issue: CR0101: Extra fields for AC Connect             *
*            Indication: js-003     Transport: CD1K949744           *
*-------------------------------------------------------------------*
* 2009.11.05 CR0391 EXTN JPY Currency Issue                         *
* Uzzawal Vemparala    Transport # CD1K951626                       *
*-------------------------------------------------------------------*
* 2009.12.18 CR1120 Issue with cost and profit, batch management    *
* Luc Mertens USG Innotiv Transport # CD1K952975      lme001        *
*-------------------------------------------------------------------*
* 2010.02.26 CR1249 Exchange rate of document                       *
* Luc Mertens USG Innotiv Transport # CD1K954976      lme002        *
*-------------------------------------------------------------------*
* 2010.03.04 CR814 Remove Authorisation Check P_ORGIN               *
* Geert Rutten  Transport # CD1K955101             gru001           *
*-------------------------------------------------------------------*
* 2010.04.02 CR1249 Exchange rate of document                       *
* Luc Mertens USG Innotiv Transport # CD1K952975      lme003        *
*-------------------------------------------------------------------*
* 2010.04.07 Performance tuning                                     *
* Luc Mertens USG Innotiv Transport # CD1K955845      lme004        *
*-------------------------------------------------------------------*
* 2010.04.20 CR1181 Load ASSO in Sales report tables (BO reporting) *
* Jules Smets USG Innotiv Transport  #  CD1K956150  #   js-004      *
*                                    #  CD1K956568  #               *
*                                    #  CD1K957301  #               *
*-------------------------------------------------------------------*
* 2010.11.18 CR1349 Request delivery date                           *
* Geert Rutten  #  CD1K960170  #   gru001                           *
*-------------------------------------------------------------------*
* 2010.11.12 CR1515 BUG FIX for incident 9975 THE SO LINE CREATE    *
*                       DATE INCORRECT IN SE_SL_REPORTING           *
* Mod - 00027  Nanda (RSN)         Transport req: CD1K960942        *
*-------------------------------------------------------------------*
* 2011.02.18 Issue: CR1943 : Performance improvements               *
*                            (CPU consumption issue)                *
*            Indication: js-005     Transport: CD1K963106           *
*-------------------------------------------------------------------*
* 2011.03.15 Issue: CR1413 : YSE_SL_Reporting: Mismatch with CO-PA  *
*            Indication: js-006     Transport: CD1K963749           *
*-------------------------------------------------------------------*
*-------------------------------------------------------------------*
* 2014.01.26 Issue: CR3022 : YSE_SL_Reporting: Mismatch with CO-PA  *
*            Indication: MOD-001     Transport: CD1K963749         *
*-------------------------------------------------------------------*



REPORT   YSE_SD_SALES1
            NO STANDARD PAGE HEADING.


*-------------------------------------------------------------------*
* Data declarations                                                 *
*-------------------------------------------------------------------*
*--- Include (ALV output)
*include yse_sd_rep_include.

*--- Dictionary tables
TABLES: MARA, ADRC, FPLT.
TABLES: CE41000.                     " Atlas Copco Operatin
TABLES: CE41000_ACCT.                " Atlas Copco Operatin
TABLES: EKKO.                        " Purchasing Document Header
TABLES: KNA1.                        " Customer Master Data
TABLES: KNVH.                        " Customer Hierarchies
TABLES: KONV.                        " Conditions
TABLES: KNVP.                        " Customer Master Partner Funcs
TABLES: LIKP.                        " SD Doc: Delivery Header Data
TABLES: LIPS.                        " SD Doc: Delivery Item Data
TABLES: LFA1.                        " Vendor Master
TABLES: MAKT.                        " Material Descriptions
TABLES: MVKE.                        " Sales Data for Material
TABLES: PA0003.                      " HR Master Record: Pers.numbers
TABLES: TVFK.                        " Billing: Document Types
TABLES: TVGRT.                       " Sales Groups: Texts
TABLES: TVKBT.                       " Sales Offices: Texts
TABLES: VBAK.                        " Sales Document: Header Data
TABLES: VBAP.                        " Sales Document: Item Data
TABLES: VBEP.                        " Sales Doc.: Schedule Line Data
TABLES: VBFA.                        " Sales Document Flow
TABLES: VBKD.                        " Sales Document: Business Data
TABLES: VBPA.                        " Sales Document: Partner
TABLES: VBRK.                        " Billing Document: Header Data
TABLES: VBRP.                        " Billing Document: Item Data
TABLES: VBUK.                        " SD Doc: Sales & Admin. Data
TABLES: VBUP.                        " Sales Document: Item Status
TABLES: YSE_SD_BILLRELEV.            " Billing relevancy sales orders
TABLES: BKPF, BSEG, DD03L.

*** js-001 * begin ***
TABLES: MARC,
        EKPO,
        YSE_SD_SALES_OPN.
*** js-001 * end ***

*** js-002 * begin ***
TABLES: YSE_SD_SALES_INV.
*** js-002 * end ***

TYPES: BEGIN OF XTYP_ADRNR,
          ADRNR LIKE ADRC-ADDRNUMBER,
       END OF XTYP_ADRNR,

       BEGIN OF XTYP_KDGRP,
          KDGRP LIKE KNVV-KDGRP,
          SPRAS LIKE T151T-SPRAS,
          KTEXT LIKE T151T-KTEXT,
       END OF XTYP_KDGRP,

       BEGIN OF XTYP_KNA1,
          KUNNR LIKE KNA1-KUNNR,
          ADRNR LIKE KNA1-ADRNR,
          BRAN1 LIKE KNA1-BRAN1,
          NAME1 LIKE KNA1-NAME1,
*          LIKE kna1-,
*          LIKE kna1-,
       END OF XTYP_KNA1,

       BEGIN OF XTYP_VBAP.
        INCLUDE STRUCTURE VBAP.
TYPES: END OF XTYP_VBAP,

      BEGIN OF XTYP_VBRP,
        VBELN LIKE VBRP-VBELN,
        POSNR LIKE VBRP-POSNR,
        NETWR LIKE VBRP-NETWR,
        VRKME LIKE VBRP-VRKME,
        KZWI3 LIKE VBRP-KZWI3,
        FAREG LIKE VBRP-FAREG,
        FKIMG LIKE VBRP-FKIMG,
        FPLNR LIKE VBRP-FPLNR ,
        AUBEL LIKE VBRP-AUBEL,
        AUPOS LIKE VBRP-AUPOS,
* LME insert
        PSTYV LIKE VBRP-PSTYV,
* LME insert
      END OF XTYP_VBRP,

      BEGIN OF XTYP_VBPA_SHORT,
         VBELN   LIKE VBPA-VBELN,
         POSNR   LIKE VBPA-POSNR,
         PARVW   LIKE VBPA-PARVW,
         KUNNR   LIKE VBPA-KUNNR,
         ADRNR   LIKE VBPA-ADRNR,
      END OF XTYP_VBPA_SHORT,

      BEGIN OF XTYP_DD07,
        DOMNAME    LIKE DD07T-DOMNAME,
        DDLANGUAGE LIKE DD07T-DDLANGUAGE,
        DOMVALUE_L LIKE DD07L-DOMVALUE_L,
        DOMVALUE_H LIKE DD07L-DOMVALUE_H,
        DDTEXT     LIKE DD07T-DDTEXT,
      END OF XTYP_DD07.

TYPES: BEGIN OF XTYP_KUNNR,
          KUNNR LIKE VBPA-KUNNR,
       END OF XTYP_KUNNR.

*** js-005 * begin ***
TYPES: BEGIN OF XTYP_TVAP,
          PSTYV  LIKE TVAP-PSTYV,
          SHKZG  LIKE TVAP-SHKZG,
       END OF XTYP_TVAP.

TYPES: BEGIN OF XTYP_PA0001,
          PERNR  LIKE PA0001-PERNR,
          ENAME  LIKE PA0001-ENAME,
       END OF XTYP_PA0001.
*** js-005 * end ***

*--- Internal tables
*** js-005 * begin ***
*DATA: xt_adrc      TYPE TABLE OF adrc   WITH HEADER LINE,
DATA: XT_ADRCI      TYPE TABLE OF ADRC   WITH HEADER LINE,
      XT_ADRC      TYPE HASHED TABLE OF ADRC
                        WITH UNIQUE KEY ADDRNUMBER
                        WITH HEADER LINE,
*** js-005 * end ***
      XV_ADRC      TYPE ADRC,
* begin of change lme004
*      it_ekko      LIKE ekko           OCCURS 0 WITH HEADER LINE,
*** js-005 * begin ***
*      it_ekko TYPE SORTED TABLE OF ekko
*        WITH NON-UNIQUE KEY ebeln
      IT_EKKOI TYPE TABLE OF EKKO,
      IT_EKKO TYPE HASHED TABLE OF EKKO
                   WITH UNIQUE KEY EBELN
*** js-005 * end ***
                   WITH HEADER LINE,
* end of change lme004
      XT_KNA1      TYPE HASHED TABLE OF XTYP_KNA1
                        WITH UNIQUE KEY KUNNR,
      XV_KNA1_AG   TYPE XTYP_KNA1 ,
* begin of change lme004
*      it_kna1_hl   TYPE xtyp_kna1 OCCURS 0 WITH HEADER LINE,
*** js-005 * begin ***
*      it_kna1_hl TYPE SORTED TABLE OF xtyp_kna1
*        WITH NON-UNIQUE KEY kunnr
      IT_KNA1_HLI TYPE TABLE OF XTYP_KNA1,
      IT_KNA1_HL TYPE HASHED TABLE OF XTYP_KNA1
                      WITH UNIQUE KEY KUNNR
*** js-005 * end ***
                      WITH HEADER LINE,
* end of change lme004
      XV_KNA1_RE   TYPE XTYP_KNA1 ,
      XV_KNA1_WE   TYPE XTYP_KNA1 ,
* begin of change lme004
*      it_knvh      LIKE knvh    OCCURS 0 WITH HEADER LINE ,
*      xt_konv     TYPE TABLE OF konv,
*** js-005 * begin ***
*      it_knvh TYPE SORTED TABLE OF knvh
*        WITH NON-UNIQUE KEY hityp kunnr vkorg vtweg spart
      IT_KNVHI TYPE TABLE OF KNVH,
      IT_KNVH TYPE HASHED TABLE OF KNVH
                   WITH UNIQUE KEY HITYP KUNNR VKORG VTWEG SPART
*** js-005 * end ***
                   WITH HEADER LINE,
*** js-005 * begin ***
*      xt_konv TYPE SORTED TABLE OF konv
*        WITH NON-UNIQUE KEY knumv kposn kschl
      XT_KONVI TYPE TABLE OF KONV,
      XT_KONV TYPE HASHED TABLE OF KONV
                   WITH UNIQUE KEY KNUMV KPOSN KSCHL
*** js-005 * end ***
                   WITH HEADER LINE,
* end of change lme004
      XV_KONV1     TYPE KONV,
      XV_KONV2     TYPE KONV,
      XV_KONVF     TYPE KONV,                               "js-002
* begin of change lme004
*      it_likp      LIKE likp           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*      it_likp TYPE SORTED TABLE OF likp
*        WITH NON-UNIQUE KEY vbeln
      IT_LIKPI TYPE TABLE OF LIKP,
      IT_LIKP TYPE HASHED TABLE OF LIKP
              WITH UNIQUE KEY VBELN
*** js-005 * end ***
              WITH HEADER LINE.
* end of change lme004
DATA: IT_LIKP2     LIKE LIKP           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_lips      LIKE lips           OCCURS 0 WITH HEADER LINE.
DATA: IT_LIPS TYPE SORTED TABLE OF LIPS
                   WITH NON-UNIQUE KEY VBELN POSNR
                   WITH HEADER LINE.
*DATA: it_lips2     LIKE lips           OCCURS 0 WITH HEADER LINE.
DATA: IT_LIPS2 TYPE SORTED TABLE OF LIPS
                    WITH NON-UNIQUE KEY VGBEL VGPOS
                    WITH HEADER LINE.
*** js-005 * end ***
* begin of change lme004
*DATA: it_lfa1      LIKE lfa1           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_lfa1 TYPE SORTED TABLE OF lfa1
*        WITH NON-UNIQUE KEY lifnr
DATA: IT_LFA1I TYPE TABLE OF LFA1,
      IT_LFA1 TYPE HASHED TABLE OF LFA1
                   WITH UNIQUE KEY LIFNR
*** js-005 * end ***
                   WITH HEADER LINE.
* end of change lme004
*DATA: it_makt      LIKE makt           OCCURS 0 WITH HEADER LINE.
* begin of change lme004
*DATA: it_mvke      LIKE mvke           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_mvke TYPE SORTED TABLE OF mvke
*        WITH NON-UNIQUE KEY matnr vkorg vtweg
DATA: IT_MVKEI TYPE TABLE OF MVKE.
DATA: IT_MVKE TYPE HASHED TABLE OF MVKE
                   WITH UNIQUE KEY MATNR VKORG VTWEG
*** js-005 * end ***
                   WITH HEADER LINE.
* end of change lme004
*** js-005 * begin ***
*DATA: it_tvfk      LIKE tvfk           OCCURS 0 WITH HEADER LINE.
DATA: IT_TVFK TYPE HASHED TABLE OF TVFK
                   WITH UNIQUE KEY FKART
                   WITH HEADER LINE.
*** js-005 * end ***
* begin of change lme004
*DATA: it_tvgrt     LIKE tvgrt          OCCURS 0 WITH HEADER LINE.
*DATA: it_tvkbt     LIKE tvkbt          OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_tvgrt TYPE SORTED TABLE OF tvgrt
*        WITH NON-UNIQUE KEY vkgrp spras
DATA: IT_TVGRTI TYPE TABLE OF TVGRT.
DATA: IT_TVGRT TYPE HASHED TABLE OF TVGRT
        WITH UNIQUE KEY SPRAS VKGRP
*** js-005 * end ***
        WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_tvkbt TYPE SORTED TABLE OF tvkbt
*        WITH NON-UNIQUE KEY vkbur spras
DATA: IT_TVKBTI TYPE TABLE OF TVKBT.
DATA: IT_TVKBT TYPE HASHED TABLE OF TVKBT
        WITH UNIQUE KEY SPRAS VKBUR
*** js-005 * end ***
        WITH HEADER LINE.
* end of change lme004
*DATA: it_vbak      LIKE vbak    OCCURS 0 WITH HEADER LINE.
*>>>>>>>> START OF INSERT EXTUVE
DATA: BEGIN OF  IT_MAKT OCCURS 0,
       MATNR     TYPE MAKT-MATNR,
*       maktx     TYPE makt-maktx, "EXTUVE 019
       ARKTX     TYPE VBAP-ARKTX,                           "EXTUVE 019
       END OF IT_MAKT.
DATA : WA_MAKT LIKE IT_MAKT.
*>>>>>>>> END OF INSERT EXTUVE
DATA: IT_VBAK   TYPE HASHED TABLE OF VBAK  WITH HEADER LINE
                      WITH UNIQUE KEY VBELN.

*DATA: it_vbap      LIKE vbap           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbap      TYPE TABLE OF xtyp_vbap  WITH HEADER LINE,
DATA: IT_VBAP      TYPE SORTED TABLE OF XTYP_VBAP
                        WITH NON-UNIQUE KEY VBELN POSNR
                        WITH HEADER LINE,
*** js-005 * end ***
      XT_KDGRP TYPE HASHED TABLE OF XTYP_KDGRP
                          WITH UNIQUE KEY KDGRP SPRAS
                          WITH HEADER LINE,
*** js-005 * begin ***
*      it_vbep      LIKE vbep           OCCURS 0 WITH HEADER LINE,
      IT_VBEP  TYPE SORTED TABLE OF VBEP
                    WITH NON-UNIQUE KEY VBELN POSNR ETENR
                    WITH HEADER LINE,
*** js-005 * end ***
*** begin gru001
*** js-005 * begin ***
*      it_vbepr     LIKE vbep           OCCURS 0 WITH HEADER LINE,
      IT_VBEPR  TYPE SORTED TABLE OF VBEP
                     WITH NON-UNIQUE KEY VBELN POSNR ETENR
                     WITH HEADER LINE,
*** js-005 * end ***
*** end gru001
      XT_DD07      TYPE TABLE OF XTYP_DD07      WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbfa1     LIKE vbfa           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbfa2     LIKE vbfa           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbfa3     LIKE vbfa           OCCURS 0 WITH HEADER LINE.
DATA: IT_VBFA1  TYPE SORTED TABLE OF VBFA
                WITH NON-UNIQUE KEY VBELV POSNV VBELN POSNN
                WITH HEADER LINE.
DATA: IT_VBFA2  TYPE SORTED TABLE OF VBFA
                WITH NON-UNIQUE KEY VBELV POSNV VBELN POSNN
                WITH HEADER LINE.
DATA: IT_VBFA3I TYPE TABLE OF VBFA  WITH HEADER LINE.
DATA: IT_VBFA3  TYPE HASHED TABLE OF VBFA
                WITH UNIQUE KEY VBELV POSNV VBTYP_N VBTYP_V
                WITH HEADER LINE.
*** js-005 * end ***
* begin of change lme004
*DATA: it_vbkd      LIKE vbkd           OCCURS 0 WITH HEADER LINE,
*** js-005 * begin ***
*DATA: it_vbkd TYPE SORTED TABLE OF vbkd
*        WITH NON-UNIQUE KEY vbeln posnr
*        WITH HEADER LINE,
DATA: IT_VBKDI  TYPE TABLE OF VBKD.
DATA: IT_VBKD  TYPE HASHED TABLE OF VBKD
                    WITH UNIQUE KEY VBELN POSNR
                    WITH HEADER LINE,
*** js-005 * end ***
* end of change lme004

     BEGIN OF IT_VBPA1 OCCURS 0,
         VBELN   LIKE VBPA-VBELN,
         POSNR   LIKE VBPA-POSNR,
         PARVW   LIKE VBPA-PARVW,
         KUNNR   LIKE VBPA-KUNNR,
         ADRNR   LIKE VBPA-ADRNR,
         KDGRP   LIKE KNVV-KDGRP,        " customer group
      END OF IT_VBPA1.

DATA: XT_VBPA2 TYPE HASHED TABLE OF XTYP_VBPA_SHORT
                      WITH UNIQUE KEY VBELN POSNR PARVW .
DATA: XT_VBPA3 TYPE HASHED TABLE OF XTYP_VBPA_SHORT
                      WITH UNIQUE KEY VBELN POSNR PARVW .

* DATA: it_vbpa4     LIKE vbpa           OCCURS 0 WITH HEADER LINE.
DATA: IT_VBPA4     TYPE HASHED TABLE OF VBPA
                   WITH HEADER LINE
                   WITH UNIQUE KEY VBELN POSNR PARVW.

*dips Naik below
*DATA: it_vbpa5     LIKE vbpa           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbpa5_temp LIKE vbpa          OCCURS 0 WITH HEADER LINE.
*end dips naik

TYPES: BEGIN OF XTYP_FPLT,
        FPLNR LIKE FPLT-FPLNR,
        FPLTR LIKE FPLT-FPLTR,
        FPROZ LIKE FPLT-FPROZ,
        FAKWR LIKE FPLT-FAKWR,
        FAKSP LIKE FPLT-FAKSP,
      END OF XTYP_FPLT,

      BEGIN OF XTYP_VBRK,
        VBELN LIKE VBRK-VBELN,
        BUKRS LIKE VBRK-BUKRS,
        FKART LIKE VBRK-FKART,
        WAERK LIKE VBRK-WAERK,
        FKDAT LIKE VBRK-FKDAT,
        ERDAT LIKE VBRK-ERDAT,
        VBTYP LIKE VBRK-VBTYP,
        FKTYP LIKE VBRK-FKTYP,
*** lme002 * begin ***
        KURRF LIKE VBRK-KURRF,
*** lme002 * end ***
      END OF XTYP_VBRK.

DATA: IT_FPLT      TYPE HASHED TABLE OF XTYP_FPLT WITH HEADER LINE
                          WITH UNIQUE KEY FPLNR FPLTR.

* begin of change lme004
*DATA: it_vbrk      TYPE TABLE OF xtyp_vbrk WITH HEADER LINE.
*DATA: it_vbrk2     TYPE TABLE OF xtyp_vbrk WITH HEADER LINE.
DATA: IT_VBRK TYPE SORTED TABLE OF XTYP_VBRK
        WITH NON-UNIQUE KEY VBELN
        WITH HEADER LINE.
DATA: IT_VBRK2 TYPE SORTED TABLE OF XTYP_VBRK
        WITH NON-UNIQUE KEY VBELN
        WITH HEADER LINE.
* end of change lme004

* actually this should be hashed, but there a loop, why??
* must check first in CQ if dumps with unique key.
*DATA: it_vbrp      TYPE SORTED TABLE OF xtyp_vbrp
*** js-005 * begin ***
*DATA: it_vbrp      TYPE TABLE OF xtyp_vbrp
DATA: IT_VBRP      TYPE SORTED TABLE OF XTYP_VBRP
                   WITH NON-UNIQUE KEY VBELN POSNR
                   WITH HEADER LINE.
*                    WITH UNIQUE KEY vbeln posnr.
*DATA: it_vbrp2     LIKE vbrp           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbrp2      TYPE TABLE OF xtyp_vbrp
DATA: IT_VBRP2 TYPE SORTED TABLE OF XTYP_VBRP
                    WITH NON-UNIQUE KEY AUBEL AUPOS
                    WITH HEADER LINE.
*** js-005 * end ***

DATA: BEGIN OF IT_VBUK1  OCCURS 0 ,
          VBELN    LIKE VBUK-VBELN,
          GBSTK    LIKE VBUK-GBSTK,
          FKSAK    LIKE VBUK-FKSAK,
          CMGST    LIKE DD07L-DOMVALUE_L,      " vbuk-cmgst,
      END OF IT_VBUK1.

* begin of change lme004
*DATA: it_vbuk2     LIKE vbuk           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbup      LIKE vbup           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbuk2 TYPE SORTED TABLE OF vbuk
*        WITH NON-UNIQUE KEY vbeln
DATA: IT_VBUK2I TYPE TABLE OF VBUK.
DATA: IT_VBUK2 TYPE HASHED TABLE OF VBUK
        WITH UNIQUE KEY VBELN
*** js-005 * end ***
        WITH HEADER LINE.
*** js-005 * begin ***
DATA: IT_VBUPI TYPE TABLE OF VBUP.
DATA: IT_VBUP TYPE SORTED TABLE OF VBUP
        WITH NON-UNIQUE KEY VBELN POSNR
*** js-005 * end ***
        WITH HEADER LINE.

* end of change lme004
DATA: IT_BILLRELEV LIKE YSE_SD_BILLRELEV
                                       OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF IT_CE41000 OCCURS 0,
        AKTBO      LIKE CE41000-AKTBO,
        PAOBJNR    LIKE CE41000-PAOBJNR,
        PASUBNR    LIKE CE41000-PASUBNR,
        PRCTR      LIKE CE41000-PRCTR,
        WW002      LIKE CE41000-WW002,
        WW006      LIKE CE41000-WW006,
        WW007      LIKE CE41000-WW007,
*** js-001 * begin ***
        WW009      LIKE CE41000-WW009,
        KTGRD      LIKE CE41000-KTGRD.
*** js-001 * end ***
DATA: END OF IT_CE41000.

DATA: BEGIN OF IT_ACCT OCCURS 0,
        AKTBO      LIKE CE41000_ACCT-AKTBO,
        PAOBJNR    LIKE CE41000_ACCT-PAOBJNR,
        PASUBNR    LIKE CE41000_ACCT-PASUBNR,
        CE4KEY     LIKE CE41000_ACCT-CE4KEY.
DATA: END OF IT_ACCT.

*** js-001 * begin ***
DATA: BEGIN OF IT_EKPO  OCCURS 0,
        EBELN      LIKE EKPO-EBELN,
        EBELP      LIKE EKPO-EBELP,
      END OF IT_EKPO.

DATA: BEGIN OF IT_MARA  OCCURS 0,
        MATNR      LIKE MARA-MATNR,
        MSTAV      LIKE MARA-MSTAV,
      END OF IT_MARA.

DATA: BEGIN OF IT_MARC  OCCURS 0,
        MATNR      LIKE MARC-MATNR,
        WERKS      LIKE MARC-WERKS,
        MMSTA      LIKE MARC-MMSTA,
        KZAUS      LIKE MARC-KZAUS,
      END OF IT_MARC.

DATA: BEGIN OF IT_ADR  OCCURS 0,
        KUNNR   TYPE KUNNR,
        ADRNR   TYPE ADRNR,
        NAME1   TYPE NAME1_GP,
      END OF IT_ADR.
DATA: BEGIN OF IT_KDGRP  OCCURS 0,
        KUNNR   TYPE KUNNR,
        KDGRP   TYPE KDGRP,
      END OF IT_KDGRP.
*** js-001 * end ***

*** js-003 * begin ***
DATA: BEGIN OF IT_VBAK_ACC  OCCURS 0,
        VBELN   TYPE VBELN_VA,
        BSARK   TYPE BSARK,
        IHREZ   TYPE IHREZ,
*** lme001 * begin ***
        XBLNR   TYPE VBAK-XBLNR,
*** lme001 * end ***
      END OF IT_VBAK_ACC.
*** js-003 * end ***

*** js-005 * begin ***
DATA: IT_TVAP TYPE HASHED TABLE OF XTYP_TVAP
                   WITH UNIQUE KEY PSTYV
                   WITH HEADER LINE.

DATA: IT_PA0001 TYPE HASHED TABLE OF XTYP_PA0001
                     WITH UNIQUE KEY PERNR
                     WITH HEADER LINE.
*** js-005 * end ***

**********************************************************************
*** !!! In case of changes on IT_DATA :                          !!! *
*** If fields are added, removed or changed in the field-sequence,   *
*** please check the field catalogue for the ALV-grid because there  *
*** the column-number is used for every field with their own titles  *
***                                                                  *
*** Also update structure: YSE_SD_SALES_OU1 for background export    *
*** (must be equal to IT_DATA)                                       *
***                                                                  *
*** + Update table YSE_SD_SALES_OPN for batch processing (js-001)    *
***   (if needed)                                                    *
***                                                                  *
*** + Update table YSE_SD_SALES_INV for batch processing (js-002)    *
***   (if needed)                                                    *
**********************************************************************
DATA: BEGIN OF IT_DATA OCCURS 0,
        VKORG        LIKE VBAK-VKORG,
        VTWEG        LIKE VBAK-VTWEG,
        SPART        LIKE VBAK-SPART,
        SPARTD       LIKE VBAP-SPART,
        VKBUR        LIKE VBAK-VKBUR,
        VKBUR_TXT    LIKE TVKBT-BEZEI,
        VKGRP        LIKE VBAK-VKGRP,
        VKGRP_TXT    LIKE TVGRT-BEZEI,
        PRCTR        LIKE CE41000-PRCTR,
        WW002        LIKE CE41000-WW002,
        WW006        LIKE CE41000-WW006,          "PGC
        WW007        LIKE CE41000-WW007,          "pgc
        CMGST        LIKE VBUK-CMGST,        " credit status
        CMGSTT       LIKE DD07T-DDTEXT,      " credit status text
        BSTKD        LIKE VBKD-BSTKD,
        BZIRK        LIKE VBKD-BZIRK,
        VDATU        LIKE VBAK-VDATU,
        EDATU        LIKE VBEP-EDATU,
        EBELN        LIKE EKKO-EBELN,
        EBELP        LIKE EKPO-EBELP,                       "js-001
        ERDAT_ORD    LIKE VBAK-ERDAT,
        ERNAM        LIKE VBAK-ERNAM,
        AUART        LIKE VBAK-AUART,
        BNDDT        LIKE VBAK-BNDDT,
        WERKS        LIKE VBAP-WERKS,
        MATNR        LIKE VBAP-MATNR,
        MATKL        LIKE MARA-MATKL,
        MAKTX        LIKE MAKT-MAKTX,
        PSTYV        LIKE VBAP-PSTYV,
        MTPOS        LIKE MVKE-MTPOS,
        KUNAG        LIKE VBAK-KUNNR,
        NAME1_AG     LIKE KNA1-NAME1,    "SOLD TO name'
        KDGRP_AG     LIKE KNVV-KDGRP,    "SOLD TO customer group
        KDGRPT_AG    LIKE T151T-KTEXT,   "SOLD TO customer group text
*       addr_ag(80)  TYPE c,
        REGION_AG    LIKE ADRC-REGION,
        CITY1_AG     LIKE ADRC-CITY1,
        POST_CODE1_AG LIKE ADRC-POST_CODE1,
        "Begin MOD-001
        STREET       LIKE ADRC-STREET,         "Sales WE address
        "End MOD-001
        KUNWE        LIKE LIKP-KUNNR,          " ship to name 1
        SH_NAICS     LIKE KNA1-BRAN1,
        NAME1_WE     LIKE KNA1-NAME1,
        SHNAME2      LIKE KNA1-NAME2,          " SHIP TO
        SHNAME3      LIKE ADRC-NAME3,                       "20080327
        SHNAME4      LIKE ADRC-NAME4,                       "20080327
*       addr_we(80)  TYPE c,
        REGION_WE    LIKE ADRC-REGION,  " If region description is
                                        " required, see table T005U
        CITY1_WE     LIKE ADRC-CITY1,
        POST_CODE1_WE LIKE ADRC-POST_CODE1,
        KUNRE        LIKE VBPA-KUNNR,
        NAME1_RE     LIKE KNA1-NAME1,            " Bill to name 1
        BPNAME2      LIKE KNA1-NAME2,            " BILL TO
        BPNAME3      LIKE ADRC-NAME3,                       "20080327
        BPNAME4      LIKE ADRC-NAME4,                       "20080327
        HKUNNR       LIKE KNVH-HKUNNR,                      "HierLvl1ld
        NAME1_HL     LIKE KNA1-NAME1,
        NAME3_HL     LIKE ADRC-NAME3,                       "20080327
        NAME4_HL     LIKE ADRC-NAME4,                       "20080327
        SORT1        LIKE ADRC-SORT1,            " CR0128  2008052008
        BRAN1        LIKE KNA1-BRAN1,
        LFSTA_TXT    LIKE VBMTV-STATU,
        FKSAK_TXT    LIKE VBMTV-STATU,
        GBSTK_TXT    LIKE VBMTV-STATU,
        GBSTA_TXT    LIKE VBMTV-STATU,
        FAKSK        LIKE VBAK-FAKSK,
        LIFSK        LIKE VBAK-LIFSK,
        VBELN_ORD    LIKE VBAK-VBELN,
        POSNR_ORD    LIKE VBAP-POSNR,
        ERDAT        LIKE VBAP-ERDAT,
        PARVW_VE     LIKE VBPA-PARVW,
        PERNR_VE     LIKE PA0003-PERNR,
        ENAME_VE     LIKE PERNR_LIST_STRUCTURE-ENAME,
        PARVW_ZX     LIKE VBPA-PARVW,
        PERNR_ZX     LIKE PA0003-PERNR,
        ENAME_ZX     LIKE PERNR_LIST_STRUCTURE-ENAME,
        PARVW_ZY     LIKE VBPA-PARVW,
        PERNR_ZY     LIKE PA0003-PERNR,
        ENAME_ZY     LIKE PERNR_LIST_STRUCTURE-ENAME,
        KWERT_ZPRO   LIKE KOMV-KWERT,
        WAERK_ZPRO   LIKE VBAP-WAERK,
        KZWI3_ORD    LIKE VBAP-KZWI3,
        WAERK_ORD    LIKE VBAP-WAERK,
        KZWI3_ORD_CC    LIKE VBAP-KZWI3, "Order Item Net Value in CC
        ZUNITPR      LIKE VBAP-KZWI3,
        ZUNITPRCURR  LIKE VBAP-WAERK,
        ZUNITPR_CC      LIKE VBAP-KZWI3, " Order on Hand value in CC
        KWERT_ZPRS   LIKE KOMV-KWERT,
        WAERK_ZPRS   LIKE VBAP-WAERK,
        ZPROFIT      LIKE VBAP-KZWI3,
        ZPROFCURR    LIKE VBAP-WAERK,
        ZPROFPERC(16) TYPE P DECIMALS 2, "air22296 runtime error
        KWMENG       LIKE VBAP-KWMENG,
        VRKME_ORD    LIKE VBAP-VRKME,
        LIFNR        LIKE EKKO-LIFNR,
        NAME1_VEND   LIKE LFA1-NAME1,
        VBELN_DEL    LIKE LIKP-VBELN,
        POSNR_DEL    LIKE LIPS-POSNR,
        WBSTK_TXT    LIKE VBMTV-STATU,
        LFIMG        LIKE LIPS-LFIMG,
        VRKME_DEL    LIKE LIPS-VRKME,
        ZQUANT_DEL   LIKE LIPS-LFIMG,
        ZVRKME_DEL   LIKE LIPS-VRKME,
        WADAT_IST    LIKE LIKP-WADAT_IST,
        FKART        LIKE VBRK-FKART,
        VBELN_INV    LIKE VBRK-VBELN,
        POSNR_INV    LIKE VBRP-POSNR,
        FAREG        LIKE VBRP-FAREG,            "billing rule
        FAREGT       LIKE DD07T-DDTEXT,      " billing rule text
        FKIMG        LIKE VBRP-FKIMG,
        VRKME_INV    LIKE VBRP-VRKME,
        KZWI3_INV    LIKE VBRP-KZWI3,
        WAERK_INV    LIKE VBRK-WAERK,
*>>>insert fields issue 4108 on 07/2/8 air22296
        KZWI3_INV_CC    LIKE VBRP-KZWI3,  "Inv value in comp.currency
*<<<air22296
        ERDAT_INV    LIKE VBRK-ERDAT,
        FKDAT        LIKE VBRK-FKDAT,
        ZQUANT_INV   LIKE VBRP-FKIMG,
        ZVRKME_INV   LIKE VBRP-VRKME,
        ZAMOUNT      LIKE VBRP-FKIMG,
        ZWAERK_INV   LIKE VBRK-WAERK,
        FPROZ        LIKE FPLT-FPROZ,
        ZFPLVAL      LIKE FPLT-FAKWR,
        FAKSP        LIKE FPLT-FAKSP,
        KWMENG_OH    LIKE VBAP-KWMENG,
        KZWI3_OH     LIKE VBAP-KZWI3,
        KZWI3_OH_CC  LIKE VBAP-KZWI3,
        KWERT_COS_OH LIKE KOMV-KWERT,
        ZPROFIT_OH   LIKE VBAP-KZWI3,
        ZPROFPC_OH(16) TYPE P DECIMALS 2,
        KWERT_COS_IN LIKE KOMV-KWERT,
        ZPROFIT_IN   LIKE VBAP-KZWI3,
        ZPROFPC_IN(16) TYPE P DECIMALS 2,
        ZUONR        LIKE BSEG-ZUONR,
        ABGRU        LIKE VBAP-ABGRU,
        SPNAME2      LIKE KNA1-NAME2,            " SOLD TO
        SPNAME3      LIKE ADRC-NAME3,                       "20080327
        SPNAME4      LIKE ADRC-NAME4,                       "20080327
* The following are for the end customer data requested in D405
        ECCUSTN      LIKE VBPA-KUNNR,
        ECPARTF      LIKE VBPA-PARVW,
        ECNAME1      LIKE ADRC-NAME1,      " end customer name
        ECNAME2      LIKE ADRC-NAME2,
        ECNAME3      LIKE ADRC-NAME3,    "20080327 end customer
        ECNAME4      LIKE ADRC-NAME4,    "20080327 end customer
        ECDISCT      LIKE KNVV-BZIRK,
        ECREGIO      LIKE ADRC-REGION,
        ECCITY       LIKE ADRC-CITY1,
        ECSREP       LIKE KNVP-PERNR,
        ECNAICS      LIKE KNA1-BRAN1,
        ECHLCUS      LIKE KNVH-HKUNNR,
        ECHLCUS_NAM1 LIKE ADRC-NAME1,
*        echlcus_nam3 LIKE adrc-name3,
*        echlcus_nam4 LIKE adrc-name4,
*        kzwi3_ord_cc LIKE vbap-kzwi3,
        ZPROFIT_CC   LIKE VBAP-KZWI3,
        WAERK_CC     LIKE VBAP-WAERK,
*** js-001 * begin ***
*        country      LIKE adrc-country,
        COUNTRY      LIKE CE41000-WW009,
*** js-001 * end ***
        BELNR        LIKE BKPF-BELNR,         " 20080624  CR####
*** js-001 * begin ***
        MSTAV        LIKE MARA-MSTAV,
        MMSTA        LIKE MARC-MMSTA,
        KZAUS        LIKE MARC-KZAUS,
        FKSAK        LIKE VBUK-FKSAK,
        GBSTK        LIKE VBUK-GBSTK,
        WBSTK        LIKE VBUK-WBSTK,
        LFSTA        LIKE VBUP-LFSTA,
        GBSTA        LIKE VBUP-GBSTA,
        ZTERM        LIKE VBRK-ZTERM,
        KTGRD        LIKE CE41000-KTGRD,
*** js-001 * end ***
*** js-002 * begin ***
        ZFREIGHT_HDR LIKE KOMV-KWERT,
        ZFR_HDR_CC   LIKE VBAK-WAERK,
        ZFREIGHT_ITM LIKE KOMV-KWERT,
        ZFR_ITM_CC   LIKE VBAP-WAERK,
*** js-002 * end ***
*** js-003 * begin ***
        BSARK        LIKE VBAK-BSARK,
        IHREZ        LIKE VBAK-IHREZ,
*** js-003 * end ***
*** lme001 * begin ***
        XBLNR        LIKE VBAK-XBLNR,
*** lme001 * end ***
*** lme002 * begin ***
        KURRF        LIKE VBRK-KURRF,
        KZWI3_INV_LOC LIKE VBRP-KZWI3,  "Inv value in local currency
*** lme002 * end ***
*** lme003 * begin ***
        KURSK        LIKE VBKD-KURSK,
        KZWI3_ORD_LOC LIKE VBAP-KZWI3,  "Ord NetValue in local currency
*** lme003 * end ***
      END OF IT_DATA.


*** js-002 * begin ***
DATA: IT_SALES_INV   TYPE TABLE OF YSE_SD_SALES_INV
                           WITH HEADER LINE,
      GV_SALES_INV   TYPE YSE_SD_SALES_INV.
*** js-002 * end ***


*** js-001 * begin ***
DATA: IT_SALES_OPEN   TYPE TABLE OF YSE_SD_SALES_OPN
                           WITH HEADER LINE,
      GV_SALES_OPEN   TYPE YSE_SD_SALES_OPN.


DATA: BEGIN OF IT_VBPA_CUST OCCURS 0,
        VBELN   LIKE VBPA-VBELN,
        POSNR   LIKE VBPA-POSNR,
        PARVW   LIKE VBPA-PARVW,
        KUNNR   LIKE VBPA-KUNNR,
        ADRNR   LIKE VBPA-ADRNR,
      END OF IT_VBPA_CUST.

DATA: BEGIN OF IT_END_CUST_DISTRICT OCCURS 0,
        ECCUSTN      LIKE KNVV-KUNNR,
        VKORG        LIKE KNVV-VKORG,
        VTWEG        LIKE KNVV-VTWEG,
        SPART        LIKE KNVV-SPART,
        ECDISCT      LIKE KNVV-BZIRK,
     END OF IT_END_CUST_DISTRICT.

DATA: BEGIN OF IT_END_CUST_REP OCCURS 0,
        ECCUSTN      LIKE KNVP-KUNNR,
        VKORG        LIKE KNVP-VKORG,
        VTWEG        LIKE KNVP-VTWEG,
        SPART        LIKE KNVP-SPART,
        ECSREP       LIKE KNVP-PERNR,
      END OF IT_END_CUST_REP.
*** js-001 * end ***

DATA : W_DECIMAL_PLACE LIKE TCURX-CURRDEC.     "20090402 Uzzawal

DATA: BEGIN OF IT_DTYPE OCCURS 0,
        AUART        LIKE YSE_SD_BILLRELEV-AUART,
        ZFKREL       LIKE YSE_SD_BILLRELEV-ZFKREL,
        DDTEXT       LIKE DD07T-DDTEXT.                     "js-001
DATA: END OF IT_DTYPE.

DATA: BEGIN OF IT_DDSHRETVAL OCCURS 0.
        INCLUDE STRUCTURE DDSHRETVAL.
DATA: END OF IT_DDSHRETVAL.

*--- Structures
DATA: BEGIN OF STR_DATA.
        INCLUDE STRUCTURE IT_DATA.
DATA: END OF STR_DATA.

DATA: BEGIN OF STR_DATA_TMP.
        INCLUDE STRUCTURE IT_DATA.
DATA: END OF STR_DATA_TMP.

DATA: BEGIN OF STR_STATUS.
        INCLUDE STRUCTURE TVBST.
DATA: END OF STR_STATUS.

DATA: BEGIN OF STR_ADDR_IN.
        INCLUDE STRUCTURE ADDR1_SEL.
DATA: END OF STR_ADDR_IN.

DATA: BEGIN OF STR_ADDR_OUT.
        INCLUDE STRUCTURE SADR.
DATA: END OF STR_ADDR_OUT.

DATA:
  BEGIN OF IT_TVKO OCCURS 0,
    VKORG    LIKE TVKO-VKORG,
    WAERS_CC LIKE T001-WAERS,
  END OF IT_TVKO.

*--- Variables
DATA: X_FKIMG      LIKE VBRP-FKIMG.
DATA: X_FOUND      TYPE C.
DATA: X_LFIMG      LIKE LIPS-LFIMG.
DATA: X_POSNV      LIKE VBFA-POSNV.
DATA: X_REPID      LIKE SY-REPID.
DATA: X_VBELV      LIKE VBFA-VBELV.
DATA: X_VBTYP      LIKE VBFA-VBTYP_V.
* LME insert
DATA: X_SHKZG      LIKE TVAP-SHKZG.
* LME insert
DATA: X_ASSO       TYPE XFELD.                              "js-004

DATA: X_PARVW_VE   LIKE VBPA-PARVW,
      X_PERNR_VE   LIKE PA0003-PERNR,
      X_ENAME_VE   LIKE PERNR_LIST_STRUCTURE-ENAME,
      X_PARVW_ZX   LIKE VBPA-PARVW,
      X_PERNR_ZX   LIKE PA0003-PERNR,
      X_ENAME_ZX   LIKE PERNR_LIST_STRUCTURE-ENAME,
      X_PARVW_ZY   LIKE VBPA-PARVW,
      X_PERNR_ZY   LIKE PA0003-PERNR,
      X_ENAME_ZY   LIKE PERNR_LIST_STRUCTURE-ENAME,
      XV_ADRC_ENDCUSTOMER TYPE ADRC.

*--- Constants
CONSTANTS: C_FAREG_4     LIKE VBRP-FAREG   VALUE '4'.
CONSTANTS: C_FAREG_5     LIKE VBRP-FAREG   VALUE '5'.
CONSTANTS: C_FKTYP_D     LIKE TVFK-FKTYP   VALUE 'D'.
CONSTANTS: C_FKTYP_P     LIKE TVFK-FKTYP   VALUE 'P'.
CONSTANTS: C_FLAG_ON     TYPE C            VALUE 'X'.
CONSTANTS: C_HITYP_A     LIKE KNVH-HITYP   VALUE 'A'.
CONSTANTS: C_KSCHL_ZPRO  LIKE KONV-KSCHL   VALUE 'ZPRO'.
CONSTANTS: C_KSCHL_ZPRS  LIKE KONV-KSCHL   VALUE 'ZPRS'.
CONSTANTS: C_KSCHL_ZD00  LIKE KONV-KSCHL   VALUE 'ZD00'.    "js-002
CONSTANTS: C_KSCHL_ZURS  LIKE KONV-KSCHL   VALUE 'ZURS'.    "lme001
CONSTANTS: C_PARVW_AG    LIKE VBPA-PARVW   VALUE 'AG'.
CONSTANTS: C_PARVW_RE    LIKE VBPA-PARVW   VALUE 'RE'.
CONSTANTS: C_PARVW_VE    LIKE VBPA-PARVW   VALUE 'VE'.
CONSTANTS: C_PARVW_WE    LIKE VBPA-PARVW   VALUE 'WE'.
CONSTANTS: C_PARVW_ZE    LIKE VBPA-PARVW   VALUE 'ZE'.      "js-001
CONSTANTS: C_PARVW_ZX    LIKE VBPA-PARVW   VALUE 'ZX'.
CONSTANTS: C_PARVW_ZY    LIKE VBPA-PARVW   VALUE 'ZY'.
CONSTANTS: C_POSNR_INIT  LIKE VBAP-POSNR   VALUE '000000'.
CONSTANTS: C_STATUS_DEL  TYPE C            VALUE 'D'.
CONSTANTS: C_STATUS_INV1 TYPE C            VALUE '1'.
CONSTANTS: C_STATUS_INV2 TYPE C            VALUE '2'.
CONSTANTS: C_STATUS_ORD  TYPE C            VALUE 'O'.
CONSTANTS: C_VBTYP_C     LIKE VBAK-VBTYP   VALUE 'C'. "Order
CONSTANTS: C_VBTYP_H     LIKE VBAK-VBTYP   VALUE 'H'. "Returns
CONSTANTS: C_VBTYP_J     LIKE VBAK-VBTYP   VALUE 'J'. "Delivery
CONSTANTS: C_VBTYP_K     LIKE VBAK-VBTYP   VALUE 'K'. "Credit memo req
CONSTANTS: C_VBTYP_L     LIKE VBAK-VBTYP   VALUE 'L'. "Debit memo req
CONSTANTS: C_VBTYP_M     LIKE VBAK-VBTYP   VALUE 'M'. "Invoice
CONSTANTS: C_VBTYP_N     LIKE VBAK-VBTYP   VALUE 'N'. "Inv cancel
CONSTANTS: C_VBTYP_S     LIKE VBAK-VBTYP   VALUE 'S'. "Cancel
CONSTANTS: C_VBTYP_O     LIKE VBAK-VBTYP   VALUE 'O'. "Credit memo
CONSTANTS: C_VBTYP_P     LIKE VBAK-VBTYP   VALUE 'P'. "Debit Memo
CONSTANTS: C_VBTYP_T     LIKE VBAK-VBTYP   VALUE 'T'. "Return del 4 ord
CONSTANTS: C_VBTYP_V     LIKE VBAK-VBTYP   VALUE 'V'. "Purchase order
CONSTANTS: C_WBSTK_C     LIKE VBUK-WBSTK   VALUE 'C'.
CONSTANTS: C_ZFKREL_A    TYPE C            VALUE 'A'.
CONSTANTS: C_ZFKREL_C    TYPE C            VALUE 'C'.

*--- Ranges
RANGES: R_AUART    FOR VBAK-AUART           OCCURS 0.
*anges: r_date1    for sy-datum             occurs 0.
*anges: r_date2    for sy-datum             occurs 0.
RANGES: R_DTYPE1   FOR YSE_SR_DOCTYPE-AUART OCCURS 0.
RANGES: R_DTYPE2   FOR YSE_SR_DOCTYPE-AUART OCCURS 0.
RANGES: R_FAREG    FOR VBRP-FAREG           OCCURS 0.
RANGES: R_PARVW    FOR VBPA-PARVW           OCCURS 0.

*--------------------------------------------------------------------*
* Data declarations concerning ALV-output                            *
*--------------------------------------------------------------------*
*--- Type pools
TYPE-POOLS SLIS.
*--- Type pools for application server transfer
TYPE-POOLS TRUXS.
DATA : GT_CSV TYPE TRUXS_T_TEXT_DATA,
       GW_CSV LIKE LINE OF GT_CSV.
*--- end of application service transfer data.

*--- Internal tables
DATA: IT_FIELDCAT       TYPE SLIS_T_FIELDCAT_ALV.
DATA: IT_SORT           TYPE SLIS_T_SORTINFO_ALV.
DATA: LT_FIELDCAT       TYPE SLIS_T_FIELDCAT_ALV.

*--- Structures
DATA: STR_SORT          TYPE SLIS_SORTINFO_ALV.
DATA: VARIANT           LIKE DISVARIANT.
DATA: GS_SD_ALV_VARIANT LIKE DISVARIANT.
DATA: G_VARIANT         LIKE DISVARIANT.
DATA: GX_VARIANT        LIKE DISVARIANT.
DATA: GS_LAYOUT         TYPE SLIS_LAYOUT_ALV.
DATA: LS_FIELDCAT       TYPE SLIS_FIELDCAT_ALV.
DATA: G_VARIANT_FLAG    TYPE C.

*--- Variables
DATA: H_EXIT            TYPE C.

* ---- Field structure data
DATA: XT_DD03L         LIKE DD03L OCCURS 0 WITH HEADER LINE,
* begin of change lme004
*      xt_dd04t         LIKE dd04t OCCURS 0 WITH HEADER LINE,
      XT_DD04T TYPE SORTED TABLE OF DD04T
        WITH NON-UNIQUE KEY ROLLNAME
        WITH HEADER LINE,
* end of change lme004
      XT_DD03T         LIKE DD03T OCCURS 0 WITH HEADER LINE.

*--- Variables with default value
DATA: G_USER_COMMAND    TYPE SLIS_FORMNAME  VALUE 'USER_COMMAND'.
DATA: G_VARIANT_SAVE    TYPE C              VALUE 'U'.

*--- Constants
CONSTANTS: C_VALUE(10)  TYPE C              VALUE 'Values'.

*--- File to store Data on Application Server
DATA: LOGSYS TYPE SYSID,
      FILE_NAME TYPE RLGRAP-FILENAME,
      E_MESSAGE(100)  TYPE C.

DATA: V_DAT LIKE SY-DATUM,
      V_TIM LIKE SY-UZEIT,
      USER_NAME LIKE SY-UNAME.

FIELD-SYMBOLS: <X_DATA>     LIKE LINE OF IT_DATA,
               <SALES_OPEN> LIKE LINE OF IT_SALES_OPEN,     "js-001
               <SALES_INV>  LIKE LINE OF IT_SALES_INV.      "js-002

*--- end of declerations

*-------------------------------------------------------------------*
* Selection screen                                                  *
*-------------------------------------------------------------------*

**********************************************************************
*** If selection screen changes, please check if you heave to modify *
*** the select in Form SELECT_OPEN_ORDERS_TABLE (js-001)             *
*** and the select in Form SELECT_INV_ORDERS_TABLE (js-002)          *
**********************************************************************
*** js-001 * begin ***
SELECTION-SCREEN BEGIN OF BLOCK B02 WITH FRAME.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) TEXT-S03.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: RB_SEL1 RADIOBUTTON GROUP SEL DEFAULT 'X'.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS: S_ERDAT3 FOR VBAP-ERDAT.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) TEXT-S06.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: RB_SEL2 RADIOBUTTON GROUP SEL.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) TEXT-S04.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: RB_SEL3 RADIOBUTTON GROUP SEL.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS: S_ERDAT2 FOR VBRK-ERDAT.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) TEXT-S05.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: CB_SEL AS CHECKBOX.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK B02.
*** js-001 * end ***

SELECTION-SCREEN BEGIN OF BLOCK B01 WITH FRAME.
SELECT-OPTIONS:
  S_ERDAT1 FOR VBAK-ERDAT,                                  " CR0128
*  s_erdat3 FOR vbap-erdat,  "OBLIGATORY,        "js-001
  S_VBELN  FOR VBAK-VBELN,
  S_POSNR  FOR VBAP-POSNR,
  S_AUART  FOR VBAK-AUART,
  S_VBTYP  FOR VBAK-VBTYP,
*** js-003 * begin ***
  S_BSARK  FOR VBAK-BSARK,
  S_IHREZ  FOR VBAK-IHREZ,
*** js-003 * end ***
*** lme001 * begin ***
  S_XBLNR  FOR VBAK-XBLNR,
*** lme001 * end ***
  S_ERNAM  FOR VBAK-ERNAM,
  S_VDATU  FOR VBAK-VDATU,
  S_EDATU  FOR VBEP-EDATU,
  S_EBELN  FOR EKKO-EBELN,
* PARAMETERS:
*   p_vkorg  LIKE vbak-vkorg OBLIGATORY MEMORY ID vko,
*   p_vtweg  LIKE vbak-vtweg OBLIGATORY MEMORY ID vtw,
*   p_sparth LIKE vbak-spart OBLIGATORY MEMORY ID spa.
* SELECT-OPTIONS:
  S_VKORG  FOR VBAK-VKORG MEMORY ID VKO NO INTERVALS
                          OBLIGATORY,                       "js-004
  S_VTWEG  FOR VBAK-VTWEG MEMORY ID VTW NO INTERVALS
                          OBLIGATORY,                       "js-004
  S_SPARTH FOR VBAK-SPART MEMORY ID SPA NO INTERVALS
                          OBLIGATORY,                       "js-004
  S_SPARTD FOR VBAP-SPART,
  S_BZIRK  FOR VBKD-BZIRK,
  S_ZFKREL FOR YSE_SD_BILLRELEV-ZFKREL,
  S_VKBUR  FOR VBAK-VKBUR,
  S_VKGRP  FOR VBAK-VKGRP,
  S_PRCTR  FOR CE41000_ACCT-PRCTR,
  S_WW002  FOR CE41000_ACCT-WW002,
  S_WW006  FOR CE41000_ACCT-WW006,
  S_WW007  FOR CE41000_ACCT-WW007,
  S_GBSTK  FOR VBUK-GBSTK,
  S_WERKS  FOR VBAP-WERKS,
  S_MATNR  FOR VBAP-MATNR,
  S_ABGRU  FOR VBAP-ABGRU,
  S_KUNAG  FOR VBAK-KUNNR,
  S_KUNWE  FOR LIKP-KUNNR,
  S_KUNRE  FOR VBPA-KUNNR,
  S_HKUNNR FOR KNVH-HKUNNR,
  S_PERNR  FOR PA0003-PERNR MATCHCODE OBJECT PREM,
  S_BRAN1  FOR KNA1-BRAN1,
  S_PSTYV  FOR VBAP-PSTYV,
  S_MTPOS  FOR MVKE-MTPOS,
  S_FAKSK  FOR VBAK-FAKSK,
  S_LIFSK  FOR VBAK-LIFSK,
  S_FKART  FOR VBRK-FKART,
*  s_erdat2 FOR vbrk-erdat,                      "js-001
  S_FKDAT  FOR VBRK-FKDAT,
  S_ZUONR  FOR BSEG-ZUONR,
  S_CMGST  FOR VBUK-CMGST,          " credit status
  S_FAKSP  FOR FPLT-FAKSP,          " Billing block
*** js-001 * begin ***
  S_MSTAV  FOR MARA-MSTAV,
  S_MMSTA  FOR MARC-MMSTA,
  S_KZAUS  FOR MARC-KZAUS.
*** js-001 * end ***
PARAMETERS:
  P_DAT_CC LIKE SY-DATUM DEFAULT SY-DATUM,
  P_KURST  LIKE TCURV-KURST DEFAULT 'EURX'.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) TEXT-S12 FOR FIELD CB_EDP .
PARAMETER P_NO_DP TYPE C AS CHECKBOX .
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) TEXT-S08 FOR FIELD CB_EDP.
PARAMETER CB_EDP TYPE C AS CHECKBOX.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) TEXT-S10 FOR FIELD CB_SPPRD. "Supp Dup
PARAMETER CB_SPPRD TYPE C AS CHECKBOX.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK B01.

*** js-001 * begin ***
*SELECTION-SCREEN BEGIN OF BLOCK b02 WITH FRAME.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (30) text-s03.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: rb_sel1 RADIOBUTTON GROUP sel DEFAULT 'X'.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (32) text-s06.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: rb_sel2 RADIOBUTTON GROUP sel.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (30) text-s04.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: rb_sel3 RADIOBUTTON GROUP sel.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN SKIP.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (30) text-s05.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: cb_sel AS CHECKBOX.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN END OF BLOCK b02.
*** js-001 * end ***

SELECTION-SCREEN BEGIN OF BLOCK B03 WITH FRAME.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (25) TEXT-S07.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: P_VAR   LIKE DISVARIANT-VARIANT.
SELECTION-SCREEN COMMENT 52(20) TEXT-S09 FOR FIELD CB_LC.
PARAMETER CB_LC TYPE C AS CHECKBOX.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK B03.

SELECTION-SCREEN BEGIN OF BLOCK B04 WITH FRAME.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) TEXT-010 FOR FIELD R1.
PARAMETERS: R1 RADIOBUTTON GROUP RAD1 DEFAULT 'X'.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) TEXT-011 FOR FIELD R2.
PARAMETERS: R2 RADIOBUTTON GROUP RAD1.
SELECTION-SCREEN END OF LINE.
*** js-001 * begin ***
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) TEXT-015 FOR FIELD R3.
PARAMETERS: R3 RADIOBUTTON GROUP RAD1.
SELECTION-SCREEN END OF LINE.
*** js-001 * end ***
*** js-002 * begin ***
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) TEXT-016 FOR FIELD R4.
PARAMETERS: R4 RADIOBUTTON GROUP RAD1.
SELECTION-SCREEN END OF LINE.
*** js-002 * end ***
SELECTION-SCREEN END OF BLOCK B04.


*********************************************************************
* Initialization of the selection screen                            *
*********************************************************************
INITIALIZATION.

  USER_NAME = SY-UNAME.

  PERFORM RESTRICT_SO.

  PERFORM SELECT_DOCTYPES_TO_DISPLAY.                       "js-001


*********************************************************************
* Process selection screen                                          *
*********************************************************************
AT SELECTION-SCREEN ON VALUE-REQUEST FOR S_AUART-LOW.
  PERFORM DOCTYPES_TO_DISPLAY CHANGING S_AUART-LOW.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR S_AUART-HIGH.
  PERFORM DOCTYPES_TO_DISPLAY CHANGING S_AUART-HIGH.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_VAR.
  PERFORM VARIANT_INPUTHELP USING P_VAR.

AT SELECTION-SCREEN OUTPUT.
  PERFORM VARIANT_INIT.
*  if p_var is initial and g_variant_flag is initial.
*    perform get_default_variant using p_var.
*    g_variant_flag = 'X'.
*  endif.

AT SELECTION-SCREEN.
  PERFORM CHECK_AUTHORIZATION.
  PERFORM EXISTENCE_VARIANT USING P_VAR.
  PERFORM CHECK_VALUES_ON_SELECTIONS.


*********************************************************************
* START MAIN PROGRAM                                                *
*********************************************************************
START-OF-SELECTION.

  IF R1 EQ 'X'.
    PERFORM INITIALIZE_DATA.
    IF RB_SEL1 = 'X'.                                       "js-001
*     "Sales orders entered"
      PERFORM SELECT_DATA.
      PERFORM PROCESS_DATA.
      PERFORM GET_END_CUSTOMER_DATA.    " this wasn't here
    ENDIF.                                                  "js-001
*** js-001 * begin ***
    IF RB_SEL2 = 'X'.
*     For "Sales orders not invoiced"
*     the table YSE_SD_SALES_OPN is used (for performance)
      PERFORM SELECT_OPEN_ORDERS_TABLE.
    ENDIF.
*** js-001 * end ***
*** js-002 * begin ***
    IF RB_SEL3 = 'X'.
**     For "Sales orders invoiced"
**     the table YSE_SD_SALES_INV is used (for BO reporting)
*      PERFORM select_inv_orders_table.
      PERFORM SELECT_DATA.
      PERFORM PROCESS_DATA.
      PERFORM GET_END_CUSTOMER_DATA.
    ENDIF.
*** js-002 * end ***
    PERFORM DISPLAY_DATA.

  ELSEIF R2 EQ 'X' AND SY-BATCH NE 'X'.
*   kicks off background processing
    PERFORM START_BACKGROUND_PROCESSING.

  ELSEIF R2 EQ 'X' AND SY-BATCH EQ 'X'.
*   background processing is running and we execute.
*   calls misc functions
    PERFORM INITIALIZE_DATA.
    IF RB_SEL1 = 'X'.                                       "js-001
*     "Sales orders entered"
      PERFORM SELECT_DATA.
      PERFORM PROCESS_DATA.
      PERFORM GET_END_CUSTOMER_DATA.
    ENDIF.                                                  "js-001
*** js-001 * begin ***
    IF RB_SEL2 = 'X'.
*     For "Sales orders not invoiced"
*     the table YSE_SD_SALES_OPN is used (for performance)
      PERFORM SELECT_OPEN_ORDERS_TABLE.
    ENDIF.
*** js-001 * end ***
*** js-002 * begin ***
    IF RB_SEL3 = 'X'.
***     For "Sales orders invoiced"
***     the table YSE_SD_SALES_INV is used (for performance)
***     --> Table is used for BO reporting !
**      PERFORM select_inv_orders_table.
      PERFORM SELECT_DATA.
      PERFORM PROCESS_DATA.
      PERFORM GET_END_CUSTOMER_DATA.
    ENDIF.
*** js-002 * end ***
*   PERFORM WRITE_TO_APP_SERVER.
    PERFORM SEND2SPOOL.

*** js-001 * begin ***
  ELSEIF R3 EQ 'X' AND SY-BATCH EQ 'X'.
*   Open orders: background processing
*   (Upload table YSE_SD_SALES_OPN for performance)
    PERFORM INITIALIZE_DATA.
    PERFORM SELECT_DATA.
    PERFORM PROCESS_DATA.
    PERFORM GET_END_CUSTOMER_DATA.
    PERFORM BUILD_TABLE_OPEN_ORDERS.
*** js-001 * end ***

*** js-002 * begin ***
  ELSEIF R4 EQ 'X' AND SY-BATCH EQ 'X'.
*   Invoiced orders: background processing
*   (Upload table YSE_SD_SALES_INV for BO reporting)
    PERFORM INITIALIZE_DATA.
    PERFORM SELECT_DATA.
    PERFORM PROCESS_DATA.
    PERFORM GET_END_CUSTOMER_DATA.
    PERFORM BUILD_TABLE_INV_ORDERS.
*** js-002 * end ***

  ENDIF.


*********************************************************************
* SUBROUTINES                                                       *
*********************************************************************

*&------------------------------------------------------------------*
*&      Form  GET_END_CUSTOMER_DATA
*&------------------------------------------------------------------*
FORM GET_END_CUSTOMER_DATA.

  DATA: BEGIN OF LT_END_CUST_ADDR OCCURS 0,
          ADDRNUMBER   LIKE ADRC-ADDRNUMBER,
          ECNAME1      LIKE ADRC-NAME1,
          ECNAME2      LIKE ADRC-NAME2,
          ECNAME3      LIKE ADRC-NAME2,
          ECNAME4      LIKE ADRC-NAME2,
          ECREGIO      LIKE ADRC-REGION,
          ECCITY       LIKE ADRC-CITY1,
          SORT1        LIKE ADRC-SORT1,    " CR0128 20080530
      END OF LT_END_CUST_ADDR.

  DATA: BEGIN OF LT_END_CUST_DISTRICT OCCURS 0,
          ECCUSTN      LIKE KNVV-KUNNR,
          ECDISCT      LIKE KNVV-BZIRK,
       END OF LT_END_CUST_DISTRICT.

  DATA: BEGIN OF LT_END_CUST_REP OCCURS 0,
          ECCUSTN      LIKE KNVP-KUNNR,
          ECSREP        LIKE KNVP-PERNR,
        END OF LT_END_CUST_REP.

  DATA: BEGIN OF LT_END_CUST_NAICS OCCURS 0,
          ECCUSTN      LIKE KNA1-KUNNR,
          ECNAICS      LIKE KNA1-BRAN1,
        END OF LT_END_CUST_NAICS.

  DATA: BEGIN OF LT_END_CUST_HLCUS OCCURS 0,
          ECCUSTN      LIKE KNVH-KUNNR,
          ECHLCUS      LIKE KNVH-HKUNNR,
          ECHLCUS_ADR  LIKE KNA1-ADRNR,
          NAME1      LIKE ADRC-NAME1,
          NAME2      LIKE ADRC-NAME2,
          NAME3      LIKE ADRC-NAME3,
          NAME4      LIKE ADRC-NAME4,
        END OF LT_END_CUST_HLCUS.

  DATA: BEGIN OF LT_VBPA_CUST OCCURS 0,
          VBELN LIKE VBPA-VBELN,
          POSNR LIKE VBPA-POSNR,
          ADRNR LIKE VBPA-ADRNR,
          KUNNR LIKE VBPA-KUNNR,
          PARVW LIKE VBPA-PARVW,
        END OF LT_VBPA_CUST.


* read end customer partner function (when ZE) into internal table

* the following selects relevant information into the table IT_VBPA5
* where certain conditions are met
  IF NOT IT_VBAP[] IS INITIAL.
*    SELECT * FROM vbpa INTO TABLE it_vbpa5 FOR ALL ENTRIES IN it_vbap
*                           WHERE vbeln = it_vbap-vbeln
*                           AND ( posnr = it_vbap-posnr OR posnr = '')
*                           AND parvw EQ 'ZE'.
    SELECT VBELN POSNR ADRNR KUNNR PARVW FROM VBPA
                INTO TABLE LT_VBPA_CUST
                FOR ALL ENTRIES IN IT_VBAP
                     WHERE VBELN = IT_VBAP-VBELN
                     AND ( POSNR = IT_VBAP-POSNR OR POSNR = '')
                     AND PARVW EQ 'ZE'.

  ENDIF.
* we have declared a temorary internal table to improve performance
*  REFRESH it_vbpa5_temp.
*  it_vbpa5_temp[] = it_vbpa5[].
*  SORT it_vbpa5_temp BY adrnr.
*  DELETE ADJACENT DUPLICATES FROM it_vbpa5_temp COMPARING adrnr.

  SORT LT_VBPA_CUST BY ADRNR.

* a check is made to sure that the internal tables is not empty
*  IF NOT  it_vbpa5_temp[] IS INITIAL.
  IF NOT  LT_VBPA_CUST[] IS INITIAL.
* the following select populates the lt_end_cust_addr table.
* for all entries has been used to improve performance
    IF R3 = ' '  AND                                        "js-001
       R4 = ' '.                                            "js-002
      SELECT ADDRNUMBER NAME1 NAME2 NAME3 NAME4 REGION CITY1
                             SORT1       " CR0128  20080530
                            FROM ADRC
                            INTO TABLE LT_END_CUST_ADDR
                            FOR ALL ENTRIES IN LT_VBPA_CUST
                            WHERE ADDRNUMBER = LT_VBPA_CUST-ADRNR.
    ENDIF.                                                  "js-001
* refresh and refil the temporary internal table
*    REFRESH it_vbpa5_temp.
*    it_vbpa5_temp[] = it_vbpa5[].
* we sort the table to improve performance
    SORT LT_VBPA_CUST BY KUNNR.
* we delete any duplicates from the table
* FOR ALL ENTRIES will do this!
*    DELETE ADJACENT DUPLICATES FROM it_vbpa5_temp COMPARING kunnr.
    IF NOT  LT_VBPA_CUST[] IS INITIAL.
* we populate the lt_end_cust_district tables based on several
* conditions this table is to retrieve the end customer district
* as it is in a different table
      IF R3 = ' '  AND                                      "js-001
         R4 = ' '.                                          "js-002
        SELECT KUNNR BZIRK FROM KNVV INTO TABLE LT_END_CUST_DISTRICT
                              FOR ALL ENTRIES IN LT_VBPA_CUST
                              WHERE KUNNR = LT_VBPA_CUST-KUNNR
                              AND VKORG = IT_VBAK-VKORG
                              AND VTWEG = IT_VBAK-VTWEG
                              AND SPART = IT_VBAK-SPART.
      ENDIF.                                                "js-001
* this is to select the end customer representative
      IF R3 = ' '  AND                                      "js-001
         R4 = ' '.                                          "js-002
        SELECT KUNNR PERNR FROM KNVP INTO TABLE LT_END_CUST_REP
                              FOR ALL ENTRIES IN LT_VBPA_CUST
                              WHERE KUNNR = LT_VBPA_CUST-KUNNR
                              AND VKORG = IT_VBAK-VKORG
                              AND VTWEG = IT_VBAK-VTWEG
                              AND SPART = IT_VBAK-SPART
                              AND PERNR NE '00000000'.
      ENDIF.                                                "js-001
* this is to select the end customer NAICS code
      SELECT KUNNR BRAN1 FROM KNA1 INTO TABLE LT_END_CUST_NAICS
                            FOR ALL ENTRIES IN LT_VBPA_CUST
                            WHERE KUNNR = LT_VBPA_CUST-KUNNR.
* this is to select the high level customer number
      SELECT KNVH~KUNNR KNVH~HKUNNR
             KNA1~ADRNR ADRC~NAME1 ADRC~NAME2 ADRC~NAME3 ADRC~NAME4
                      FROM KNVH
                      JOIN KNA1 ON KNA1~KUNNR = KNVH~HKUNNR
                      LEFT JOIN ADRC ON ADRC~ADDRNUMBER = KNA1~ADRNR
                      INTO TABLE LT_END_CUST_HLCUS
                            FOR ALL ENTRIES IN LT_VBPA_CUST
                            WHERE KNVH~KUNNR = LT_VBPA_CUST-KUNNR.

* add new fields to the final table using a binary search
* and using keys to match them and then modify the relevant
* fields to the main internal table.
      DATA: LV_INDEX TYPE SY-TABIX.

      SORT LT_VBPA_CUST BY VBELN POSNR.
      SORT LT_END_CUST_ADDR  BY ADDRNUMBER ASCENDING.
      SORT LT_END_CUST_DISTRICT BY ECCUSTN ASCENDING.
      SORT LT_END_CUST_REP  BY ECCUSTN ASCENDING.
      SORT LT_END_CUST_NAICS  BY ECCUSTN ASCENDING.
      SORT LT_END_CUST_HLCUS  BY ECCUSTN ASCENDING.

*** js-001 * begin ***
      IF R3 = 'X'.
*       Open orders
        LOOP AT IT_SALES_OPEN ASSIGNING <SALES_OPEN>.

          CLEAR: LT_VBPA_CUST, LT_END_CUST_ADDR,
                LT_END_CUST_DISTRICT, LT_END_CUST_REP,
                LT_END_CUST_NAICS, LT_END_CUST_HLCUS.

          LV_INDEX = SY-TABIX.
          READ TABLE LT_VBPA_CUST
               WITH KEY VBELN = <SALES_OPEN>-VBELN_ORD
                        POSNR = <SALES_OPEN>-POSNR_ORD
               BINARY SEARCH.
          <SALES_OPEN>-ECCUSTN = LT_VBPA_CUST-KUNNR.
          <SALES_OPEN>-ECPARTF = LT_VBPA_CUST-PARVW.

          IF <SALES_OPEN>-ECCUSTN = ''.
            READ TABLE LT_VBPA_CUST
                 WITH KEY VBELN = <SALES_OPEN>-VBELN_ORD
                 BINARY SEARCH.
            <SALES_OPEN>-ECCUSTN = LT_VBPA_CUST-KUNNR.
            <SALES_OPEN>-ECPARTF = LT_VBPA_CUST-PARVW.
          ENDIF.

          READ TABLE LT_END_CUST_NAICS
               WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
               BINARY SEARCH.
          <SALES_OPEN>-ECNAICS = LT_END_CUST_NAICS-ECNAICS.

          READ TABLE LT_END_CUST_HLCUS
               WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
               BINARY SEARCH.
          <SALES_OPEN>-ECHLCUS = LT_END_CUST_HLCUS-ECHLCUS.

        ENDLOOP.
      ELSE.
*** js-001 * end ***
*** js-002 * begin ***
        IF R4 = 'X'.
*       Invoiced orders
          LOOP AT IT_SALES_INV ASSIGNING <SALES_INV>.

            CLEAR: LT_VBPA_CUST, LT_END_CUST_ADDR,
                  LT_END_CUST_DISTRICT, LT_END_CUST_REP,
                  LT_END_CUST_NAICS, LT_END_CUST_HLCUS.

            LV_INDEX = SY-TABIX.
            READ TABLE LT_VBPA_CUST
                 WITH KEY VBELN = <SALES_INV>-VBELN_ORD
                          POSNR = <SALES_INV>-POSNR_ORD
                 BINARY SEARCH.
            <SALES_INV>-ECCUSTN = LT_VBPA_CUST-KUNNR.
            <SALES_INV>-ECPARTF = LT_VBPA_CUST-PARVW.

            IF <SALES_INV>-ECCUSTN = ''.
              READ TABLE LT_VBPA_CUST
                   WITH KEY VBELN = <SALES_INV>-VBELN_ORD
                   BINARY SEARCH.
              <SALES_INV>-ECCUSTN = LT_VBPA_CUST-KUNNR.
              <SALES_INV>-ECPARTF = LT_VBPA_CUST-PARVW.
            ENDIF.

            READ TABLE LT_END_CUST_NAICS
                 WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
                 BINARY SEARCH.
            <SALES_INV>-ECNAICS = LT_END_CUST_NAICS-ECNAICS.

            READ TABLE LT_END_CUST_HLCUS
                 WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
                 BINARY SEARCH.
            <SALES_INV>-ECHLCUS = LT_END_CUST_HLCUS-ECHLCUS.

          ENDLOOP.
        ELSE.
*** js-002 * end ***
          LOOP AT IT_DATA ASSIGNING <X_DATA>.

            CLEAR: LT_VBPA_CUST, LT_END_CUST_ADDR,
                  LT_END_CUST_DISTRICT, LT_END_CUST_REP,
                  LT_END_CUST_NAICS, LT_END_CUST_HLCUS.

            LV_INDEX = SY-TABIX.
            READ TABLE LT_VBPA_CUST
                WITH KEY VBELN = <X_DATA>-VBELN_ORD
                         POSNR = <X_DATA>-POSNR_ORD
                BINARY SEARCH.
            <X_DATA>-ECCUSTN = LT_VBPA_CUST-KUNNR.
            <X_DATA>-ECPARTF = LT_VBPA_CUST-PARVW.

            IF <X_DATA>-ECCUSTN = ''.
              READ TABLE LT_VBPA_CUST
              WITH KEY VBELN = <X_DATA>-VBELN_ORD
*                          "POSNR = <x_data>-POSNR_ord
              BINARY SEARCH.
              <X_DATA>-ECCUSTN = LT_VBPA_CUST-KUNNR.
              <X_DATA>-ECPARTF = LT_VBPA_CUST-PARVW.
            ENDIF.

            READ TABLE LT_END_CUST_ADDR
                    WITH KEY ADDRNUMBER = LT_VBPA_CUST-ADRNR
                    BINARY SEARCH.
            <X_DATA>-ECNAME1 = LT_END_CUST_ADDR-ECNAME1.
            <X_DATA>-ECNAME2 = LT_END_CUST_ADDR-ECNAME2.
            <X_DATA>-ECNAME3 = LT_END_CUST_ADDR-ECNAME3.
            <X_DATA>-ECNAME4 = LT_END_CUST_ADDR-ECNAME4.
            <X_DATA>-ECCITY  = LT_END_CUST_ADDR-ECCITY.
            <X_DATA>-ECREGIO = LT_END_CUST_ADDR-ECREGIO.
            <X_DATA>-SORT1   = LT_END_CUST_ADDR-SORT1.

            READ TABLE LT_END_CUST_DISTRICT
                  WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
                  BINARY SEARCH.
            <X_DATA>-ECDISCT = LT_END_CUST_DISTRICT-ECDISCT.
            "LIKE KNVV-BZIRK,

            READ TABLE LT_END_CUST_REP
                    WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
                    BINARY SEARCH.
            <X_DATA>-ECSREP =  LT_END_CUST_REP-ECSREP.

            READ TABLE LT_END_CUST_NAICS
                    WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
                    BINARY SEARCH.
            <X_DATA>-ECNAICS = LT_END_CUST_NAICS-ECNAICS.

            READ TABLE LT_END_CUST_HLCUS
                    WITH KEY ECCUSTN = LT_VBPA_CUST-KUNNR
                    BINARY SEARCH.
            <X_DATA>-ECHLCUS = LT_END_CUST_HLCUS-ECHLCUS.

            <X_DATA>-ECHLCUS_NAM1 = LT_END_CUST_HLCUS-NAME1.
*    <x_data>-echlcus_NAM3 = lt_end_cust_hlcus-name2.
*    <x_data>-echlcus_NAM4 = lt_end_cust_hlcus-name4.

          ENDLOOP.
        ENDIF.                                              "js-001
      ENDIF.                                                "js-002
    ENDIF.
  ENDIF.

ENDFORM.                    "GET_END_CUSTOMER_DATA

*********************************************************************
* SUBROUTINES  LEVEL 01                                             *
*********************************************************************

*&------------------------------------------------------------------*
*&      Form  START_BACKGROUND_PROCESSING
*&------------------------------------------------------------------*
FORM START_BACKGROUND_PROCESSING.

* this function is to schedule batch processing. this is needed as the
* report has become very complex and processing will now happen in
* the background
  CALL FUNCTION 'BP_JOBVARIANT_SCHEDULE'
    EXPORTING
      TITLE_NAME = 'End Customer Report'(001)
      JOB_NAME   = 'customer_report'(002)
      PROG_NAME  = 'YSE_SD_SALES'.

ENDFORM.                    "START_BACKGROUND_PROCESSING

*&------------------------------------------------------------------*
*&      Form  GET_FIELDNAME
*&------------------------------------------------------------------*
FORM GET_FIELDNAME USING P_ROLL LIKE DD03L-ROLLNAME
                         P_FIELD LIKE DD03L-FIELDNAME
                   CHANGING P_TEXT.

  READ TABLE XT_DD04T WITH KEY ROLLNAME = P_ROLL
                      BINARY SEARCH.
  IF SY-SUBRC = 0.
    P_TEXT = XT_DD04T-REPTEXT.
  ELSE.
* field description defined in table definition
    READ TABLE XT_DD03T WITH KEY FIELDNAME = P_FIELD.
    IF SY-SUBRC = 0.
      P_TEXT = XT_DD03T-DDTEXT.
    ENDIF.
  ENDIF.

ENDFORM.                    "get_fieldname

*&------------------------------------------------------------------*
*&      Form  SEND2SPOOL
*&------------------------------------------------------------------*
FORM SEND2SPOOL .

  DATA: FNAM             LIKE RLGRAP-FILENAME,
        IT_OUTXLS(4096)  TYPE C OCCURS 0,
        LV_FIELDNAME(20) TYPE C,
        WA_OUTXLS(4096)  TYPE C.

  CONSTANTS:
    C_TAB TYPE C VALUE CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.


* Build filename
  V_DAT = SY-DATUM.
  V_TIM = SY-UZEIT.
  CONCATENATE '/var/load/' SY-SYSID '/UK/original/YSE_SALES_'
              USER_NAME '_' V_DAT '_' V_TIM '.TXT'
         INTO FNAM.

* Make the output table ; delimited
  CALL FUNCTION 'SAP_CONVERT_TO_CSV_FORMAT'
    TABLES
      I_TAB_SAP_DATA       = IT_DATA
    CHANGING
      I_TAB_CONVERTED_DATA = IT_OUTXLS
    EXCEPTIONS
      CONVERSION_FAILED    = 1
      OTHERS               = 2.
  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

* Open file
  OPEN DATASET FNAM FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF SY-SUBRC <> 0.
    WRITE 'Error opening file. Action aborted.'.
    EXIT.
  ENDIF.

* Write header line
  CLEAR WA_OUTXLS.
  SORT XT_DD03L BY POSITION.
  LOOP AT XT_DD03L.
    PERFORM GET_FIELDNAME USING XT_DD03L-ROLLNAME
                                XT_DD03L-FIELDNAME
                         CHANGING LV_FIELDNAME.

*   field description in data element
    IF WA_OUTXLS IS INITIAL.
      WA_OUTXLS = LV_FIELDNAME.
    ELSE.
      CONCATENATE WA_OUTXLS C_TAB LV_FIELDNAME INTO WA_OUTXLS.
    ENDIF.
  ENDLOOP.
  TRANSFER WA_OUTXLS TO FNAM.

* Process lines
  LOOP AT IT_OUTXLS INTO WA_OUTXLS.
    REPLACE ALL OCCURRENCES OF ';' IN WA_OUTXLS WITH C_TAB.
    TRANSFER WA_OUTXLS TO FNAM.
  ENDLOOP.

* Close file
  CLOSE DATASET FNAM.

  WRITE: 'Report output written to file: ', FNAM.

ENDFORM.                    " SEND2SPOOL

*&------------------------------------------------------------------*
*&      Form  WRITE_TO_APP_SERVER
*&------------------------------------------------------------------*
FORM WRITE_TO_APP_SERVER.

  DATA: DESCR_REF TYPE REF TO CL_ABAP_STRUCTDESCR.

  FIELD-SYMBOLS: <COMP_WA> TYPE ABAP_COMPDESCR.


* this form writes the contents of the internal table to a CSV file.
* in this case the seperator is not a comma but a |
* the user then retrieves the file using a program and can import this
* into excel.
  V_DAT = SY-DATUM.
  V_TIM = SY-UZEIT.

*this function actually converts the data into a file
  CALL FUNCTION 'SAP_CONVERT_TO_TEX_FORMAT'
    EXPORTING
      I_FIELD_SEPERATOR    = '|'
    TABLES
      I_TAB_SAP_DATA       = IT_DATA "the internal table that u want
    CHANGING
      I_TAB_CONVERTED_DATA = GT_CSV
    EXCEPTIONS
      CONVERSION_FAILED    = 1      "convert to csv format
      OTHERS               = 2.
  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO WITH
    SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

** as we do not have the fields, we need to append them to line 1 of
** the text file
* CONCATENATE: 'VKORG' 'VTWEG' 'SPART' 'SPARTD' 'VKBUR' 'VKBUR_TXT'
* 'VKGRP' 'VKGRP_TXT' 'PRCTR' 'WW002' 'WW006' 'WW007' 'BSTKD' 'BZIRK'
* 'VDATU' 'EDATU' 'EBELN' 'ERDAT_ORD' 'ERNAM' 'AUART' 'BNDDT' 'WERKS'
* 'MATNR' 'MAKTX' 'PSTYV' 'MTPOS' 'KUNAG' 'NAME1_AG' 'REGION_AG'
* 'CITY1_AG' 'POST_CODE1_AG' 'KUNWE' 'NAME1_WE' 'REGION_WE' 'CITY1_WE'
* 'POST_CODE1_WE' 'KUNRE' 'NAME1_RE' 'HKUNNR' 'NAME1_HL' 'BRAN1'
* 'LFSTA' 'FKSAK' 'GBSTK' 'GBSTA' 'FAKSK' 'LIFSK'
* 'VBELN_ORD' 'POSNR_ORD' 'PARVW_VE' 'PERNR_VE' 'ENAME_VE' 'PARVW_ZX'
* 'PERNR_ZX' 'ENAME_ZX' 'PARVW_ZY' 'PERNR_ZY' 'ENAME_ZY' 'KWERT_ZPRO'
* 'WAERK_ZPRO' 'KZWI3_ORD' 'WAERK_ORD'
* 'KZWI3_CC_ORD'
*
* 'ZUNITPR' 'ZUNITPRCURR' 'ZUNITPR_CC'
* 'KWERT_ZPRS' 'WAERK_ZPRS' 'ZPROFIT' 'ZPROFCURR' 'ZPROFPERC'
* 'KWMENG' 'VRKME_ORD' 'LIFNR' 'NAME1_VEND' 'VBELN_DEL'
* 'POSNR_DEL' 'WBSTK' 'LFIMG' 'VRKME_DEL' 'ZQUANT_DEL' 'ZVRKME_DEL'
* 'WADAT_IST' 'FKART' 'VBELN_INV' 'POSNR_INV' 'FKIMG' 'VRKME_INV'
* 'KZWI3_INV' 'WAERK_INV' 'KZWI3_INV_CC' 'ERDAT_INV'
* 'FKDAT'
* 'ZQUANT_INV' 'ZVRKME_INV' 'ZAMOUNT' 'ZWAERK_INV' 'FPROZ' 'ZFPLVAL'
* 'KWMENG_OH'
* 'KZWI3_OH' 'KZWI3_OH_CC'
* 'KWERT_COS_OH' 'ZPROFIT_OH' 'ZPROFPC_OH' 'KWERT_COS_IN' 'ZPROFIT_IN'
* 'ZPROFPC_IN' 'ZUONR' 'ABGRU' 'SPNAME2' 'SHNAME2' 'BPNAME2'
* 'ECCUSTN' 'ECPARTF' 'ECNAME1' 'ECNAME2' 'ECDISCT' 'ECREGIO' 'ECCITY'
* 'ECSREP' 'ECNAICS' 'ECHLCUS'
* INTO gw_csv SEPARATED BY '|'.

* we have the fields
  CLEAR GW_CSV.
  DESCR_REF ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_NAME( 'IT_DATA' ).
  LOOP AT DESCR_REF->COMPONENTS ASSIGNING <COMP_WA>.
    CONCATENATE GW_CSV <COMP_WA>-NAME '|' INTO GW_CSV.
  ENDLOOP.

  INSERT GW_CSV INTO GT_CSV INDEX 1.
* here we set the filename and add in the username, date and time.
  CONCATENATE '/var/load/' SY-SYSID '/END_CUST'
              '_' USER_NAME '_' V_DAT '_' V_TIM '.txt'
         INTO FILE_NAME.
* we are preparing to write to file
  CONDENSE FILE_NAME.
  DELETE DATASET FILE_NAME.
  OPEN DATASET FILE_NAME FOR OUTPUT IN TEXT MODE
  ENCODING NON-UNICODE IGNORING CONVERSION ERRORS MESSAGE E_MESSAGE.

  IF SY-SUBRC NE 0.
    MESSAGE E_MESSAGE TYPE 'E'.
    EXIT.
  ELSE.
* we are actually writing to the file. the contents
* of the internal tab are placed in the file
    LOOP AT GT_CSV INTO GW_CSV.
      TRANSFER GW_CSV TO FILE_NAME.
    ENDLOOP.
* we close the file
    CLOSE DATASET FILE_NAME.
* if there are any errors........
    IF SY-SUBRC NE 0.
      MESSAGE  'Error closing the File'(003) TYPE 'E'.
      EXIT.
    ELSEIF SY-SUBRC IS INITIAL.
      CONCATENATE 'File Saved as:'(004) FILE_NAME INTO FILE_NAME
      SEPARATED BY SPACE.
      MESSAGE  FILE_NAME TYPE 'I'.
    ENDIF.
  ENDIF.

ENDFORM.                    "WRITE_TO_APP_SERVER

*&---------------------------------------------------------------------*
*&      Form  SELECT_DOCTYPES_TO_DISPLAY         "js-001
*&---------------------------------------------------------------------*
*       Select relevant document types to display
*----------------------------------------------------------------------*
FORM SELECT_DOCTYPES_TO_DISPLAY .

  DATA: LV_DD07 TYPE XTYP_DD07.


* Select descriptions
  CLEAR: XT_DD07.
  REFRESH: XT_DD07.
  SELECT DD07L~DOMNAME DD07T~DDLANGUAGE DD07L~DOMVALUE_L
         DD07L~DOMVALUE_H DD07T~DDTEXT
        INTO TABLE XT_DD07
        FROM DD07L
        JOIN DD07T ON DD07T~DOMNAME = DD07L~DOMNAME
                  AND DD07T~AS4LOCAL = DD07L~AS4LOCAL
                  AND DD07T~VALPOS = DD07L~VALPOS
                  AND DD07T~DDLANGUAGE = 'E'
        WHERE DD07L~DOMNAME = 'ZFKREL'
          AND DD07L~AS4LOCAL = 'A'.

* Select relevant document types to display
  CLEAR: IT_DTYPE.
  REFRESH: IT_DTYPE.
  SELECT * FROM YSE_SD_BILLRELEV
           INTO CORRESPONDING FIELDS OF TABLE IT_DTYPE.
* Add descriptions
  LOOP AT IT_DTYPE.
    READ TABLE XT_DD07 INTO LV_DD07
        WITH KEY DOMNAME    = 'ZFKREL'
                 DDLANGUAGE = 'E'
                 DOMVALUE_L = IT_DTYPE-ZFKREL.
    IF SY-SUBRC = 0.
      IT_DTYPE-DDTEXT = LV_DD07-DDTEXT.
      MODIFY IT_DTYPE.
    ENDIF.
  ENDLOOP.

  CLEAR: XT_DD07.
  REFRESH: XT_DD07.

ENDFORM.                    " SELECT_DOCTYPES_TO_DISPLAY

*------------------------------------------------------------------*
*   Form  DOCTYPES_TO_DISPLAY                                      *
*------------------------------------------------------------------*
FORM DOCTYPES_TO_DISPLAY CHANGING DOCTYPE.

*** js-001 * begin ***
** Select relevant document types to display
*  CLEAR: it_dtype.
*  REFRESH: it_dtype.
*  SELECT * FROM yse_sd_billrelev
*           INTO CORRESPONDING FIELDS OF TABLE it_dtype.
*** js-001 * end ***

* Call list with selected plants
  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      VALUE_ORG       = 'S'
      RETFIELD        = 'AUART'
      WINDOW_TITLE    = 'Document types'
    TABLES
      VALUE_TAB       = IT_DTYPE
      RETURN_TAB      = IT_DDSHRETVAL
    EXCEPTIONS
      PARAMETER_ERROR = 1
      NO_VALUES_FOUND = 2
      OTHERS          = 3.
  IF SY-SUBRC EQ 0.
    READ TABLE IT_DDSHRETVAL INDEX 1.
    DOCTYPE = IT_DDSHRETVAL-FIELDVAL.
  ENDIF.

ENDFORM.                    " DOCTYPES_TO_DISPLAY

*------------------------------------------------------------------*
*   Form  VARIANT_INPUTHELP                                        *
*------------------------------------------------------------------*
*   F4 - help for variants                                         *
*------------------------------------------------------------------*
FORM VARIANT_INPUTHELP USING VAR.

  CLEAR H_EXIT.
  CLEAR GX_VARIANT.

  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      IS_VARIANT    = G_VARIANT
      I_SAVE        = G_VARIANT_SAVE
    IMPORTING
      E_EXIT        = H_EXIT
      ES_VARIANT    = GX_VARIANT
    EXCEPTIONS
      NOT_FOUND     = 1
      PROGRAM_ERROR = 2
      OTHERS        = 3.

  IF SY-SUBRC IS INITIAL AND H_EXIT IS INITIAL.
    G_VARIANT-VARIANT = GX_VARIANT-VARIANT.
    VAR               = GX_VARIANT-VARIANT.
  ENDIF.

ENDFORM.                    " VARIANT_INPUTHELP

*--------------------------------------------------------------------*
*   Form  VARIANT_INIT                                               *
*--------------------------------------------------------------------*
*   Initialize variant                                               *
*--------------------------------------------------------------------*
FORM VARIANT_INIT.

  CLEAR G_VARIANT.

  X_REPID = SY-REPID.
  G_VARIANT-REPORT = X_REPID.

ENDFORM.                    " VARIANT_INIT

*--------------------------------------------------------------------*
*   Form  EXISTENCE_VARIANT                                          *
*--------------------------------------------------------------------*
*   Does the variant exist ?                                         *
*--------------------------------------------------------------------*
FORM EXISTENCE_VARIANT USING VAR LIKE G_VARIANT-VARIANT.

  IF NOT VAR IS INITIAL.
    G_VARIANT-VARIANT = VAR.
    CALL FUNCTION 'REUSE_ALV_VARIANT_EXISTENCE'
      EXPORTING
        I_SAVE     = G_VARIANT_SAVE
      CHANGING
        CS_VARIANT = G_VARIANT.
  ELSE.
    PERFORM VARIANT_INIT.
  ENDIF.

ENDFORM.                    " EXISTENCE_VARIANT

*-------------------------------------------------------------------*
*   Form  GET_DEFAULT_VARIANT                                       *
*-------------------------------------------------------------------*
*   If there is an existing default variant - get it                *
*-------------------------------------------------------------------*
FORM GET_DEFAULT_VARIANT USING VAR.

  GX_VARIANT = G_VARIANT.

  CALL FUNCTION 'REUSE_ALV_VARIANT_DEFAULT_GET'
    EXPORTING
      I_SAVE     = G_VARIANT_SAVE
    CHANGING
      CS_VARIANT = GX_VARIANT
    EXCEPTIONS
      NOT_FOUND  = 2.

  IF SY-SUBRC IS INITIAL.
    VAR = GX_VARIANT-VARIANT.
  ENDIF.

ENDFORM.                    " GET_DEFAULT_VARIANT

*--------------------------------------------------------------------*
*   Form  CHECK_VALUES_ON_SELECTIONS                                 *
*--------------------------------------------------------------------*
FORM CHECK_VALUES_ON_SELECTIONS.

*LME
  DATA: LV_ERDAT LIKE VBAP-ERDAT.


*** js-001 * begin ***
  IF R3 IS INITIAL  AND
     R4 IS INITIAL.                                         "js-002
    IF NOT RB_SEL3 IS INITIAL.
      IF NOT S_ERDAT2 IS INITIAL.
        LV_ERDAT = S_ERDAT2-HIGH - S_ERDAT2-LOW.
* MJ change
*    if lv_erdat > 30.
        IF LV_ERDAT > 92.
* MJ change
          MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E98.
        ENDIF.
      ELSE.
        MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E97.
      ENDIF.
    ELSE.
      IF NOT RB_SEL1 IS INITIAL.
*** js-001 * end ***
        IF NOT S_ERDAT3 IS INITIAL.
          LV_ERDAT = S_ERDAT3-HIGH - S_ERDAT3-LOW.
* MJ change
*    if lv_erdat > 30.
          IF LV_ERDAT > 92.
* MJ change
            MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E99.
          ENDIF.
*LME
*** js-001 * begin ***
        ELSE.
          MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E96.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

* Obligatory fields
  IF R3 IS INITIAL  AND
     R4 IS INITIAL.                                         "js-002
*   Sales Organization
    IF S_VKORG[] IS INITIAL.
      MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E94.
    ENDIF.
*   Distribution Channel
    IF S_VTWEG[] IS INITIAL.
      MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E93.
    ENDIF.
*   Division (header level)
    IF S_SPARTH[] IS INITIAL.
      MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E92.
    ENDIF.
  ENDIF.
*** js-001 * end ***

  IF NOT RB_SEL2 IS INITIAL.
    IF NOT S_FKART[] IS INITIAL.
      MESSAGE E025(YSE_SALES_LOG) WITH TEXT-E03 TEXT-E01.
    ENDIF.
    IF NOT S_ERDAT2[] IS INITIAL.
      MESSAGE E025(YSE_SALES_LOG) WITH TEXT-E04 TEXT-E01.
    ENDIF.
    IF NOT S_FKDAT[] IS INITIAL.
      MESSAGE E025(YSE_SALES_LOG) WITH TEXT-E05 TEXT-E01.
    ENDIF.
  ELSEIF NOT RB_SEL3 IS INITIAL.
    IF NOT S_FKART[] IS INITIAL.
      LOOP AT S_FKART WHERE LOW IS INITIAL AND HIGH IS INITIAL.
        MESSAGE E026(YSE_SALES_LOG) WITH TEXT-E03 TEXT-E02.
      ENDLOOP.
    ENDIF.
    IF NOT S_ERDAT2[] IS INITIAL.
      LOOP AT S_ERDAT2 WHERE LOW IS INITIAL AND HIGH IS INITIAL.
        MESSAGE E026(YSE_SALES_LOG) WITH TEXT-E04 TEXT-E02.
      ENDLOOP.
    ENDIF.
    IF NOT S_FKDAT[] IS INITIAL.
      LOOP AT S_FKDAT WHERE LOW IS INITIAL AND HIGH IS INITIAL.
        MESSAGE E026(YSE_SALES_LOG) WITH TEXT-E05 TEXT-E02.
      ENDLOOP.
    ENDIF.
  ENDIF.

*** js-001 * begin ***
  IF R3 = 'X' AND RB_SEL2 IS INITIAL.
    MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E95.
  ENDIF.
*** js-001 * end ***

*** js-002 * begin ***
  IF R4 = 'X' AND RB_SEL3 IS INITIAL.
    MESSAGE E000(YSE_SALES_LOG) WITH TEXT-E91.
  ENDIF.
*** js-002 * end ***

ENDFORM.                    " CHECK_VALUES_ON_SELECTIONS

*--------------------------------------------------------------------*
*   Form  INITIALIZE_DATA                                            *
*--------------------------------------------------------------------*
FORM INITIALIZE_DATA.

* Clear of internal tables also necessary at routine 'reset_data'
  CLEAR: IT_VBAK, IT_VBAP, IT_VBEP.
  CLEAR: IT_LIKP, IT_LIPS, IT_VBRK, IT_VBRP.
  CLEAR: IT_LIKP2, IT_LIPS2, IT_VBRK2, IT_VBRP2.
  CLEAR: IT_VBPA1, IT_VBPA4.
  CLEAR: IT_VBFA1, IT_VBFA2, IT_VBFA3.
  CLEAR: XV_KNA1_AG, XV_KNA1_WE, XV_KNA1_RE, IT_KNA1_HL.
  CLEAR: IT_LFA1, XV_ADRC, IT_KNVH.
  CLEAR: IT_VBUK1, IT_VBUK2, IT_VBUP, IT_TVGRT, IT_TVKBT, IT_TVFK.
  CLEAR: IT_ACCT, IT_CE41000, IT_MAKT, IT_MVKE, IT_EKKO.
  CLEAR: IT_BILLRELEV, XT_KONV, IT_VBKD, IT_DATA.
*** js-001 * begin ***
  CLEAR: IT_EKPO, IT_MARA, IT_MARC.
*** js-001 * end ***
  REFRESH: IT_VBAK, IT_VBAP, IT_VBEP.
  REFRESH: IT_LIKP, IT_LIPS, IT_VBRK, IT_VBRP.
  REFRESH: IT_LIKP2, IT_LIPS2, IT_VBRK2, IT_VBRP2.
  REFRESH: IT_VBPA1, XT_VBPA3, IT_VBPA4.
  REFRESH: IT_VBFA1, IT_VBFA2, IT_VBFA3.
  REFRESH: XT_KNA1.
  REFRESH: IT_LFA1, XT_ADRC, IT_KNVH.
  REFRESH: IT_VBUK1, IT_VBUK2, IT_VBUP, IT_TVGRT, IT_TVKBT, IT_TVFK.
  REFRESH: IT_ACCT, IT_CE41000, IT_MAKT, IT_MVKE, IT_EKKO.
  REFRESH: IT_BILLRELEV, XT_KONV, IT_VBKD, IT_DATA.
*** js-001 * begin ***
  REFRESH: IT_EKPO, IT_MARA, IT_MARC.
*** js-001 * end ***

  CLEAR: R_AUART.
  REFRESH: R_AUART.
  R_AUART-SIGN   = 'I'.
  R_AUART-OPTION = 'EQ'.
  SELECT * FROM YSE_SD_BILLRELEV WHERE ZFKREL IN S_ZFKREL.
    R_AUART-LOW = YSE_SD_BILLRELEV-AUART.
    APPEND R_AUART.
  ENDSELECT.

  CLEAR: R_PARVW.
  REFRESH: R_PARVW.
  R_PARVW-SIGN   = 'I'.
  R_PARVW-OPTION = 'EQ'.
  R_PARVW-LOW    = C_PARVW_VE.  APPEND R_PARVW.
  R_PARVW-LOW    = C_PARVW_ZX.  APPEND R_PARVW.
  R_PARVW-LOW    = C_PARVW_ZY.  APPEND R_PARVW.

  CLEAR: R_FAREG.
  REFRESH: R_FAREG.
  R_FAREG-SIGN   = 'I'.
  R_FAREG-OPTION = 'EQ'.
  R_FAREG-LOW    = C_FAREG_4.  APPEND R_FAREG.
  R_FAREG-LOW    = C_FAREG_5.  APPEND R_FAREG.

* Get structure descriptions
* Get fields of structure 'YSE_SD_SALES_OU1'
  SELECT * FROM DD03L
           INTO TABLE XT_DD03L
           WHERE TABNAME = 'YSE_SD_SALES_OU1'.

* Get the descriptions of the fields in the structure
  SELECT * FROM DD04T
           INTO TABLE XT_DD04T
           FOR ALL ENTRIES IN XT_DD03L
           WHERE ROLLNAME EQ XT_DD03L-ROLLNAME
             AND DDLANGUAGE EQ 'EN'.
* begin of delete lme004
*  SORT xt_dd04t BY rollname.
* end of delete lme004

* Get description defined for table:
* Get fields of structure 'YSE_SD_SALES_OU1'
  SELECT * FROM DD03T
           INTO TABLE XT_DD03T
           WHERE TABNAME = 'YSE_SD_SALES_OU1'.

*** js-001 * begin ***
* Background processing: select all not-invoiced sales orders
  IF R3 = 'X'.
    CLEAR CB_SEL.
  ENDIF.
*** js-001 * end ***

*** js-002 * begin ***
* Background processing: select all invoiced sales orders
  IF R4 = 'X'.
    CLEAR CB_SEL.
  ENDIF.
*** js-002 * end ***

*** js-004 * begin ***
* ASSO ?  --> Take delivered orders (not invoiced)
  CLEAR X_ASSO.
  IF NOT R4 IS INITIAL.
    LOOP AT S_AUART WHERE LOW = 'ZO03'.
    ENDLOOP.
    IF SY-SUBRC = 0.
      X_ASSO = 'X'.
    ENDIF.
  ENDIF.
*** js-004 * end ***

ENDFORM.                    " INITIALIZE_DATA

*-------------------------------------------------------------------*
*   Form  SELECT_DATA                                               *
*-------------------------------------------------------------------*
FORM SELECT_DATA.

  DATA: LT_ADRNR TYPE TABLE OF XTYP_ADRNR,
        LT_KDGRP TYPE TABLE OF XTYP_KDGRP,
        LV_ADRNR TYPE XTYP_ADRNR,
        LV_KDGRP TYPE XTYP_KDGRP,
        LV_TABIX LIKE SY-TABIX,
        LV_ADDRNUMBER LIKE ADRC-ADDRNUMBER,
        LT_KUNNR TYPE TABLE OF XTYP_KUNNR,
        LV_VBPA LIKE LINE OF XT_VBPA3,
        LV_KUNNR TYPE XTYP_ADRNR.

  FIELD-SYMBOLS: <L_VBAP> TYPE VBAP.


* Get currency of company code related to provided sales org
  SELECT VKORG T001~WAERS
         INTO TABLE IT_TVKO
         FROM TVKO
         JOIN T001 ON TVKO~BUKRS EQ T001~BUKRS
         WHERE VKORG IN S_VKORG.
  SORT IT_TVKO BY VKORG.

*** js-005 * begin ***
  SELECT * INTO TABLE IT_TVFK
         FROM TVFK.

  SELECT PSTYV SHKZG INTO TABLE IT_TVAP
         FROM TVAP.
*** js-005 * end ***

*** js-001 * begin ***
  IF NOT RB_SEL3 IS INITIAL  AND
     X_ASSO IS INITIAL.                                     "js-004
    SELECT VBELN BUKRS FKART WAERK FKDAT ERDAT VBTYP FKTYP
*** lme001 * begin ***
           KURRF
*** lme002 * end ***
            FROM VBRK INTO TABLE IT_VBRK
            WHERE ERDAT IN S_ERDAT2
              AND VKORG IN S_VKORG
              AND VTWEG IN S_VTWEG                          "js-004
              AND SPART IN S_SPARTH                         "js-004
              AND FKART IN S_FKART
              AND FKDAT IN S_FKDAT.
* begin of delete lme004
*    SORT it_vbrk BY vbeln.
* end of delete lme004
    DELETE ADJACENT DUPLICATES FROM IT_VBRK.

    IF NOT IT_VBRK[] IS INITIAL.
*     Read billing related orders into IT_VBFA2
      SELECT * FROM VBFA INTO TABLE IT_VBFA2
               FOR ALL ENTRIES IN IT_VBRK
               WHERE ( VBELN   EQ IT_VBRK-VBELN )
                 AND ( VBTYP_N EQ C_VBTYP_M       " M - invoice
                    OR VBTYP_N EQ C_VBTYP_N       " N - Invoice canc.
                    OR VBTYP_N EQ C_VBTYP_S       " S - Canc.
                    OR VBTYP_N EQ C_VBTYP_O       " O - Credit memo
                    OR VBTYP_N EQ C_VBTYP_P )     " P - Debit Memo
*** lme001 * begin ***
                 AND RFMNG > 0
*** lme001 * end ***
                 AND STUFE EQ SPACE.

      IF NOT IT_VBFA2[] IS INITIAL.
*        SORT it_vbfa2 BY vbelv.                            "js-005
        IT_VBFA1[] = IT_VBFA2[].
*       Read deliveries and return deliveries into IT_VBFA2
        SELECT * FROM VBFA APPENDING TABLE IT_VBFA2
                 FOR ALL ENTRIES IN IT_VBFA1
                 WHERE VBELN   EQ IT_VBFA1-VBELV
                   AND (   VBTYP_N EQ C_VBTYP_J   " J- delivery
                        OR VBTYP_N EQ C_VBTYP_T ) " T - return of del
*** lme001 * begin ***
                   AND RFMNG > 0
*** lme001 * end ***
                   AND STUFE EQ SPACE.

*        SORT it_vbfa2 BY vbelv.                            "js-005
        SELECT * FROM VBAP INTO TABLE IT_VBAP
                 FOR ALL ENTRIES IN IT_VBFA2
                 WHERE VBELN EQ IT_VBFA2-VBELV
                   AND VBELN IN S_VBELN
                   AND POSNR IN S_POSNR
                   AND ERDAT IN S_ERDAT3
                   AND MATNR IN S_MATNR
                   AND PSTYV IN S_PSTYV
                   AND SPART IN S_SPARTD
                   AND WERKS IN S_WERKS
                   AND ABGRU IN S_ABGRU.
      ENDIF.
      REFRESH: IT_VBFA1, IT_VBFA2.
    ENDIF.
  ELSE.
*** js-001 * end ***
*   SELECT vbap moved UP!
*   We shall start with selection based on date FIRST
*            - the mandatory field

*        Begin of Insert Mod-0027 RSN.
*    SELECT * FROM vbap AS i
**            JOIN mara ON vbap~matnr = mara~matnr
**** js-004 * begin ***
**             INTO TABLE it_vbap
*             INNER JOIN vbak AS h
*                   ON i~vbeln = h~vbeln

    SELECT * FROM VBAK AS H
*            JOIN mara ON vbap~matnr = mara~matnr
*** js-004 * begin ***
*             INTO TABLE it_vbap
             INNER JOIN VBAP AS I
                   ON I~VBELN = H~VBELN
*        End of Insert Mod-0027 RSN.
             INTO CORRESPONDING FIELDS OF TABLE IT_VBAP
*** js-004 * end ***
             WHERE I~ERDAT IN S_ERDAT3
               AND I~VBELN IN S_VBELN                       " air23037
               AND I~POSNR IN S_POSNR
               AND I~MATNR IN S_MATNR
               AND I~PSTYV IN S_PSTYV
               AND I~SPART IN S_SPARTD
               AND I~WERKS IN S_WERKS
               AND I~ABGRU IN S_ABGRU
*** js-004 * begin ***
               AND H~VKORG IN S_VKORG
               AND H~VTWEG IN S_VTWEG
               AND H~SPART IN S_SPARTH.
*** js-004 * end ***
  ENDIF.                                                    "js-001

  IF NOT IT_VBAP[] IS INITIAL.
*    SORT it_vbap BY vbeln.                                 "js-005
    SELECT * FROM VBAK INTO TABLE IT_VBAK
             FOR ALL ENTRIES IN IT_VBAP                     " air23037
             WHERE VBELN EQ IT_VBAP-VBELN                   " air23037
*               and erdat in r_date1
               AND ERDAT IN S_ERDAT1                        " CR0128
               AND ERNAM IN S_ERNAM
               AND VBTYP IN S_VBTYP
               AND AUART IN S_AUART
               AND AUART IN R_AUART
               AND LIFSK IN S_LIFSK
               AND FAKSK IN S_FAKSK
               AND VKORG IN S_VKORG
               AND VTWEG IN S_VTWEG
               AND SPART IN S_SPARTH
*               AND vkorg = p_vkorg
*               AND vtweg = p_vtweg
*               AND spart = p_sparth
               AND VKGRP IN S_VKGRP
               AND VKBUR IN S_VKBUR
*** js-003 * begin ***
               AND BSARK IN S_BSARK
               AND IHREZ IN S_IHREZ
*** js-003 * end ***
*** lme001 * begin ***
               AND XBLNR IN S_XBLNR
*** lme001 * end ***
               AND VDATU IN S_VDATU
               AND KUNNR IN S_KUNAG.

*   Delete unnecessary lines from it_vbap
    LOOP AT IT_VBAP ASSIGNING <L_VBAP>.
      LV_TABIX = SY-TABIX.
      READ TABLE IT_VBAK WITH KEY VBELN = <L_VBAP>-VBELN.
      IF SY-SUBRC <> 0.
        DELETE IT_VBAP INDEX LV_TABIX.
      ENDIF.
    ENDLOOP.

    SORT IT_VBAK BY VBELN.
    CHECK NOT IT_VBAK[] IS INITIAL.

    SELECT * FROM YSE_SD_BILLRELEV INTO TABLE IT_BILLRELEV
             FOR ALL ENTRIES IN IT_VBAK
             WHERE AUART  EQ IT_VBAK-AUART
               AND ZFKREL IN S_ZFKREL.

    SELECT VBELN GBSTK FKSAK CMGST FROM VBUK INTO TABLE IT_VBUK1
           FOR ALL ENTRIES IN IT_VBAK
           WHERE VBELN EQ IT_VBAK-VBELN
             AND GBSTK IN S_GBSTK
             AND CMGST IN S_CMGST.                          "4244
    .
    SORT IT_VBUK1 BY VBELN.

    SELECT DD07L~DOMNAME DD07T~DDLANGUAGE DD07L~DOMVALUE_L  " 4244
           DD07L~DOMVALUE_H DD07T~DDTEXT
           INTO TABLE XT_DD07
           FROM DD07L
           JOIN DD07T ON DD07T~DOMNAME = DD07L~DOMNAME
                     AND DD07T~AS4LOCAL = DD07L~AS4LOCAL
                     AND DD07T~VALPOS = DD07L~VALPOS
                     AND DD07T~DDLANGUAGE = 'E'
*           FOR ALL ENTRIES IN it_vbuk1
           WHERE DD07L~DOMNAME = 'CMGST' OR DD07L~DOMNAME = 'FAREG'
             AND DD07L~AS4LOCAL = 'A'.
*             AND dd07l~DOMVALUE_L  = it_vbuk1-cmgst.

*    SELECT * FROM tvkbt INTO TABLE it_tvkbt                "js-005
    SELECT * FROM TVKBT INTO TABLE IT_TVKBTI                "js-005
             FOR ALL ENTRIES IN IT_VBAK
             WHERE SPRAS EQ SY-LANGU
               AND VKBUR EQ IT_VBAK-VKBUR.
* begin of delete lme004
*    SORT it_tvkbt BY vkbur spras.
* end of delete lme004
*** js-005 * begin ***
*    DELETE ADJACENT DUPLICATES FROM it_tvkbt.
    SORT IT_TVKBTI BY SPRAS VKBUR.
    DELETE ADJACENT DUPLICATES FROM IT_TVKBTI
           COMPARING SPRAS VKBUR.
    IT_TVKBT[] = IT_TVKBTI[].
*** js-005 * begin ***

*    SELECT * FROM tvgrt INTO TABLE it_tvgrt                "js-005
    SELECT * FROM TVGRT INTO TABLE IT_TVGRTI                "js-005
             FOR ALL ENTRIES IN IT_VBAK
             WHERE SPRAS EQ SY-LANGU
               AND VKGRP EQ IT_VBAK-VKGRP.
* begin of delete lme004
*    SORT it_tvgrt BY vkgrp spras.
* end of delete lme004
*** js-005 * begin ***
*    DELETE ADJACENT DUPLICATES FROM it_tvgrt.
    SORT IT_TVGRTI BY SPRAS VKGRP.
    DELETE ADJACENT DUPLICATES FROM IT_TVGRTI
           COMPARING SPRAS VKGRP.
    IT_TVGRT[] = IT_TVGRTI[].
*** js-005 * end ***

*    SELECT * FROM vbkd INTO TABLE it_vbkd                  "js-005
    SELECT * FROM VBKD INTO TABLE IT_VBKDI                  "js-005
             FOR ALL ENTRIES IN IT_VBAK
             WHERE VBELN EQ IT_VBAK-VBELN
               AND BZIRK IN S_BZIRK.
*** js-005 * begin ***
    SORT IT_VBKDI BY VBELN POSNR.
    DELETE ADJACENT DUPLICATES FROM IT_VBKDI
           COMPARING VBELN POSNR.
    IT_VBKD[] = IT_VBKDI[].
*** js-005 * end ***

*   We shall start with selection based on date FIRST
*                 - that's the mandatory field
*    SELECT * FROM vbap INTO TABLE it_vbap
*                       FOR ALL ENTRIES IN it_vbak
*                       WHERE vbeln EQ it_vbak-vbeln
*                         AND posnr IN s_posnr
*                         AND matnr IN s_matnr
*                         AND pstyv IN s_pstyv
*                         AND spart IN s_spartd
*                         AND werks IN s_werks
*                         AND abgru IN s_abgru
*                         AND ERDAT IN S_ERDAT3.

    IF NOT IT_VBAP[] IS INITIAL.

*      SELECT * FROM vbup INTO TABLE it_vbup                "js-005
      SELECT * FROM VBUP INTO TABLE IT_VBUPI                "js-005
               FOR ALL ENTRIES IN IT_VBAP
               WHERE VBELN EQ IT_VBAP-VBELN
                 AND POSNR EQ IT_VBAP-POSNR.
*** js-005 * begin ***
      SORT IT_VBUPI BY VBELN POSNR.
      DELETE ADJACENT DUPLICATES FROM IT_VBUPI
             COMPARING VBELN POSNR.
      IT_VBUP[] = IT_VBUPI[].
*** js-005 * end ***

*>>>>> BEGIN OF INSERT EXTUVE 20090805
*      SELECT * FROM makt INTO TABLE it_makt
*                         FOR ALL ENTRIES IN it_vbap
*                         WHERE matnr EQ it_vbap-matnr
*                           AND spras EQ sy-langu.
      CHECK NOT IT_VBAP[] IS INITIAL.                       " MOD-019
      SELECT MATNR ARKTX FROM VBAP
                            INTO CORRESPONDING FIELDS OF TABLE IT_MAKT
                            FOR ALL ENTRIES IN IT_VBAP
                            WHERE VBELN = IT_VBAP-VBELN
                              AND POSNR = IT_VBAP-POSNR.
*>>>>> END OF INSERT EXTUVE 20090805
      SORT IT_MAKT BY MATNR ARKTX.
      DELETE ADJACENT DUPLICATES FROM IT_MAKT.

*      SELECT * FROM mvke INTO TABLE it_mvke                "js-005
      SELECT * FROM MVKE INTO TABLE IT_MVKEI                "js-005
               FOR ALL ENTRIES IN IT_VBAP
               WHERE MATNR EQ IT_VBAP-MATNR
                 AND VKORG IN S_VKORG
                 AND VTWEG IN S_VTWEG
*                 AND vkorg = p_vkorg
*                 AND vtweg = p_vtweg
                 AND MTPOS IN S_MTPOS.

*** js-001 * begin ***
* begin of delete lme004
*      SORT it_mvke BY matnr vkorg vtweg.
* end of delete lme004
*** js-005 * begin ***
*      DELETE ADJACENT DUPLICATES FROM it_mvke.
      SORT IT_MVKEI BY MATNR VKORG VTWEG.
      DELETE ADJACENT DUPLICATES FROM IT_MVKEI
             COMPARING MATNR VKORG VTWEG.
      IT_MVKE[] = IT_MVKEI[].
*** js-005 * end ***

      SELECT MATNR MSTAV FROM MARA INTO TABLE IT_MARA
                         FOR ALL ENTRIES IN IT_MVKE
                         WHERE MATNR EQ IT_MVKE-MATNR
                           AND MSTAV IN S_MSTAV.
      SORT IT_MARA BY MATNR.
      DELETE ADJACENT DUPLICATES FROM IT_MARA.

      SELECT MATNR WERKS MMSTA KZAUS
             FROM MARC INTO TABLE IT_MARC
             FOR ALL ENTRIES IN IT_MARA
             WHERE MATNR EQ IT_MARA-MATNR
               AND WERKS IN S_WERKS
               AND MMSTA IN S_MMSTA
               AND KZAUS IN S_KZAUS.
      SORT IT_MARC BY MATNR WERKS.
      DELETE ADJACENT DUPLICATES FROM IT_MARC.
*** js-001 * end ***

      SELECT AKTBO PAOBJNR PASUBNR CE4KEY
             FROM CE41000_ACCT
             INTO TABLE IT_ACCT
             FOR ALL ENTRIES IN IT_VBAP
             WHERE AKTBO   EQ 'X'
               AND PAOBJNR EQ IT_VBAP-PAOBJNR.
      IF NOT IT_ACCT[] IS INITIAL.
        SORT IT_ACCT BY PAOBJNR.
        DELETE ADJACENT DUPLICATES FROM IT_ACCT.

        SELECT AKTBO PAOBJNR PASUBNR PRCTR WW002 WW006 WW007
               WW009 KTGRD
               FROM CE41000
               INTO TABLE IT_CE41000
               FOR ALL ENTRIES IN IT_ACCT
               WHERE AKTBO EQ 'X'
                 AND PAOBJNR EQ IT_ACCT-CE4KEY
                 AND PRCTR   IN S_PRCTR
                 AND WW002   IN S_WW002
                 AND WW006   IN S_WW006
                 AND WW007   IN S_WW007.
        DELETE ADJACENT DUPLICATES FROM IT_CE41000.
      ENDIF.
    ENDIF.

*    SELECT * FROM konv INTO TABLE xt_konv                  "js-005
    SELECT * FROM KONV INTO TABLE XT_KONVI                  "js-005
             FOR ALL ENTRIES IN IT_VBAK
             WHERE KNUMV EQ IT_VBAK-KNUMV
               AND (   KSCHL EQ C_KSCHL_ZPRO
                    OR KSCHL EQ C_KSCHL_ZPRS
*** lme001 * begin ***
                    OR KSCHL EQ C_KSCHL_ZURS
*** lme001 * end ***
                    OR KSCHL EQ C_KSCHL_ZD00 ).             "js-002
*** js-005 * begin ***
    SORT XT_KONVI BY KNUMV KPOSN KSCHL.
    DELETE ADJACENT DUPLICATES FROM XT_KONVI
           COMPARING KNUMV KPOSN KSCHL.
    XT_KONV[] = XT_KONVI[].
*** js-005 * end ***

    SELECT DISTINCT VBPA~VBELN VBPA~POSNR VBPA~PARVW VBPA~KUNNR
                    VBPA~ADRNR
           KNVV~KDGRP
           FROM VBPA
           LEFT JOIN KNVV ON KNVV~KUNNR = VBPA~KUNNR
                        AND KNVV~VKORG = IT_VBAK-VKORG
                        AND KNVV~VTWEG = IT_VBAK-VTWEG
                        AND KNVV~SPART = IT_VBAK-SPART
           INTO TABLE IT_VBPA1
           FOR ALL ENTRIES IN IT_VBAK
           WHERE VBELN EQ IT_VBAK-VBELN
                         AND PARVW EQ C_PARVW_AG.  " Soldto
*    DELETE ADJACENT DUPLICATES FROM it_vbpa1.

    IF NOT IT_VBPA1[] IS INITIAL.
      LOOP AT IT_VBPA1.
        LV_KUNNR = IT_VBPA1-KUNNR.  APPEND LV_KUNNR TO LT_KUNNR.
        LV_ADRNR = IT_VBPA1-ADRNR.  APPEND LV_ADRNR TO LT_ADRNR.
        LV_KDGRP = IT_VBPA1-KDGRP.  APPEND LV_KDGRP TO LT_KDGRP.
      ENDLOOP.

      SORT LT_KDGRP.
      IF NOT LT_KDGRP[] IS INITIAL.
        SELECT KDGRP SPRAS KTEXT FROM T151T
            INTO TABLE XT_KDGRP
            FOR ALL ENTRIES IN LT_KDGRP
            WHERE ( SPRAS = 'E'      AND KDGRP = LT_KDGRP-KDGRP )
               OR ( SPRAS = SY-LANGU AND KDGRP = LT_KDGRP-KDGRP ).
      ENDIF.
    ENDIF.

    SELECT DISTINCT VBPA~VBELN VBPA~POSNR VBPA~PARVW VBPA~KUNNR
                    VBPA~ADRNR
           FROM VBPA
           INTO TABLE XT_VBPA2
           FOR ALL ENTRIES IN IT_VBAK
           WHERE VBELN EQ IT_VBAK-VBELN
             AND PARVW EQ C_PARVW_WE
             AND VBPA~KUNNR IN S_KUNWE.

    IF NOT XT_VBPA2[] IS INITIAL.
*      SORT it_vbpa2.        " BY vbeln posnr parvw.
*      DELETE ADJACENT DUPLICATES FROM it_vbpa2.
      LOOP AT XT_VBPA2 INTO LV_VBPA.
        LV_KUNNR = LV_VBPA-KUNNR.    APPEND LV_KUNNR TO LT_KUNNR.
        LV_ADRNR = LV_VBPA-ADRNR.    APPEND LV_ADRNR TO LT_ADRNR.
      ENDLOOP.
    ENDIF.

    SELECT DISTINCT VBELN POSNR PARVW KUNNR ADRNR
           FROM VBPA INTO TABLE XT_VBPA3
           FOR ALL ENTRIES IN IT_VBAK
           WHERE VBELN EQ IT_VBAK-VBELN
             AND PARVW EQ C_PARVW_RE
             AND KUNNR IN S_KUNRE.

    IF NOT XT_VBPA3[] IS INITIAL.
*      SORT xt_vbpa3 BY vbeln posnr parvw.
*      DELETE ADJACENT DUPLICATES FROM xt_vbpa3.
*>>>AIR22296 13/2/8: we need the info from document, not from master
*   data
      LOOP AT XT_VBPA3 INTO LV_VBPA.
        LV_KUNNR = LV_VBPA-KUNNR.    APPEND LV_KUNNR TO LT_KUNNR.
        LV_ADRNR = LV_VBPA-ADRNR.    APPEND LV_ADRNR TO LT_ADRNR.
      ENDLOOP.
*<<<AIR22296
    ENDIF.

    SELECT * FROM VBPA INTO TABLE IT_VBPA4
             FOR ALL ENTRIES IN IT_VBAK
             WHERE VBELN EQ IT_VBAK-VBELN
               AND PARVW IN R_PARVW.
*               and pernr in s_pernr.
    DELETE ADJACENT DUPLICATES FROM IT_VBPA4.

*    SELECT * FROM knvh INTO TABLE it_knvh                  "js-005
    SELECT * FROM KNVH INTO TABLE IT_KNVHI                  "js-005
             FOR ALL ENTRIES IN IT_VBAK
             WHERE HITYP  EQ C_HITYP_A
               AND KUNNR  EQ IT_VBAK-KUNNR
               AND VKORG  EQ IT_VBAK-VKORG
               AND VTWEG  EQ IT_VBAK-VTWEG
               AND SPART  EQ IT_VBAK-SPART
               AND DATAB  LE IT_VBAK-ERDAT
               AND DATBI  GE IT_VBAK-ERDAT
               AND HKUNNR IN S_HKUNNR.

* begin of delete lme004
*    SORT it_knvh BY hityp kunnr vkorg vtweg spart.
* end of delete lme004
*** js-005 * begin ***
*    DELETE ADJACENT DUPLICATES FROM it_knvh.
    SORT IT_KNVHI BY HITYP KUNNR VKORG VTWEG SPART.
    DELETE ADJACENT DUPLICATES FROM IT_KNVHI
           COMPARING HITYP KUNNR VKORG VTWEG SPART.
    IT_KNVH[] = IT_KNVHI[].

    IF NOT IT_KNVH[] IS INITIAL.
      SELECT KUNNR ADRNR BRAN1 NAME1 FROM KNA1
*             INTO TABLE it_kna1_hl                         "js-005
             INTO TABLE IT_KNA1_HLI                         "js-005
             FOR ALL ENTRIES IN IT_KNVH
             WHERE KUNNR EQ IT_KNVH-HKUNNR.
      IF SY-SUBRC = 0.
* begin of delete lme004
*        SORT it_kna1_hl BY kunnr.
* end of delete lme004
*** js-005 * begin ***
*        DELETE ADJACENT DUPLICATES FROM it_kna1_hl.
        SORT IT_KNA1_HLI BY KUNNR.
        DELETE ADJACENT DUPLICATES FROM IT_KNA1_HLI
               COMPARING KUNNR.
        IT_KNA1_HL[] = IT_KNA1_HLI[].
*** js-005 * end ***
*       get address data for High Level Customer
        LOOP AT IT_KNA1_HL.
          LV_ADRNR = IT_KNA1_HL-ADRNR.  APPEND LV_ADRNR TO LT_ADRNR.
        ENDLOOP.
      ENDIF.
    ENDIF.

    SELECT * FROM VBEP INTO TABLE IT_VBEP
             FOR ALL ENTRIES IN IT_VBAK
             WHERE VBELN EQ IT_VBAK-VBELN
               AND EDATU IN S_EDATU.

* begin gru001
    SELECT * FROM VBEP INTO TABLE IT_VBEPR
             FOR ALL ENTRIES IN IT_VBAK
             WHERE VBELN EQ IT_VBAK-VBELN
               AND EDATU IN S_VDATU
               AND ETENR = '0001'.
* end gru001

*   Read deliveries and return deliveries into IT_VBFA1
    SELECT * FROM VBFA INTO TABLE IT_VBFA1
             FOR ALL ENTRIES IN IT_VBAK
             WHERE VBELV   EQ IT_VBAK-VBELN
               AND (    VBTYP_N EQ C_VBTYP_J   " J - delivery
                     OR VBTYP_N EQ C_VBTYP_T ) " T - return of del
               AND VBTYP_V EQ IT_VBAK-VBTYP
*** lme001 * begin ***
               AND RFMNG > 0
*** lme001 * end ***
               AND STUFE EQ SPACE.

    IF NOT IT_VBFA1[] IS INITIAL.

*      SELECT * FROM likp INTO TABLE it_likp                "js-005
      SELECT * FROM LIKP INTO TABLE IT_LIKPI                "js-005
                         FOR ALL ENTRIES IN IT_VBFA1
                         WHERE VBELN EQ IT_VBFA1-VBELN.
* begin of delete lme004
*      SORT it_likp BY vbeln.
* end of delete lme004
*** js-005 * begin ***
*      DELETE ADJACENT DUPLICATES FROM it_likp.
      SORT IT_LIKPI BY VBELN.
      DELETE ADJACENT DUPLICATES FROM IT_LIKPI
             COMPARING VBELN.
      IT_LIKP[] = IT_LIKPI[].
*** js-005 * end ***
      IT_LIKP2[] = IT_LIKP[].

      IF NOT IT_LIKP[] IS INITIAL.

*        SELECT * FROM vbuk INTO TABLE it_vbuk2             "js-005
        SELECT * FROM VBUK INTO TABLE IT_VBUK2I             "js-005
                           FOR ALL ENTRIES IN IT_LIKP
                           WHERE VBELN EQ IT_LIKP-VBELN
                               AND CMGST IN S_CMGST.        "4244
*** js-005 * begin ***
        SORT IT_VBUK2I BY VBELN.
        DELETE ADJACENT DUPLICATES FROM IT_VBUK2I
               COMPARING VBELN.
        IT_VBUK2[] = IT_VBUK2I[].
*** js-005 * end ***

        SELECT * FROM LIPS INTO TABLE IT_LIPS
                           FOR ALL ENTRIES IN IT_LIKP
                           WHERE VBELN EQ IT_LIKP-VBELN.
        IT_LIPS2[] = IT_LIPS[].

*       Read delivery based billing docs into IT_VBFA2
        SELECT * FROM VBFA INTO TABLE IT_VBFA2
                 FOR ALL ENTRIES IN IT_LIKP
                 WHERE ( VBELV   EQ IT_LIKP-VBELN )
                   AND ( VBTYP_N EQ C_VBTYP_M      " M - invoice
                      OR VBTYP_N EQ C_VBTYP_N      " N - Invoice canc.
*** js-006 * begin ***
                      OR VBTYP_N EQ C_VBTYP_P      " P - Debit Memo
                      OR VBTYP_N EQ C_VBTYP_S      " S - Canc.
*** js-006 * end ***
                      OR VBTYP_N EQ C_VBTYP_O )    " O - Credit memo
                   AND ( VBTYP_V EQ IT_LIKP-VBTYP )
*** lme001 * begin ***
                   AND RFMNG > 0
*** lme001 * end ***
                   AND STUFE EQ SPACE.

      ENDIF.

    ENDIF.

*   Read order related billing docs into IT_VBFA2
    SELECT * FROM VBFA APPENDING TABLE IT_VBFA2
             FOR ALL ENTRIES IN IT_VBAK
             WHERE ( VBELV   EQ IT_VBAK-VBELN )
               AND ( VBTYP_N EQ C_VBTYP_M      " M - invoice
                  OR VBTYP_N EQ C_VBTYP_N      " N - Invoice canc.
* LME insert
                  OR VBTYP_N EQ C_VBTYP_S      " S - Canc.
* LME insert
                  OR VBTYP_N EQ C_VBTYP_O      " O - Credit memo
                  OR VBTYP_N EQ C_VBTYP_P )    " P - Debit Memo
* MJ deletion
*               AND ( vbtyp_v EQ it_vbak-vbtyp )
* MJ deletion
*** lme001 * begin ***
               AND RFMNG > 0
*** lme001 * end ***
               AND STUFE EQ SPACE.

    IF NOT IT_VBFA2[] IS INITIAL.

*     Get billing plan details
      SELECT FPLNR FPLTR FPROZ FAKWR FAKSP FROM FPLT INTO TABLE IT_FPLT
             FOR ALL ENTRIES IN IT_VBFA2
             WHERE FPLNR EQ IT_VBFA2-FPLNR
               AND FPLTR EQ IT_VBFA2-FPLTR
               AND FAKSP IN S_FAKSP.

      SELECT VBELN BUKRS FKART WAERK FKDAT ERDAT VBTYP FKTYP
*** lme001 * begin ***
             KURRF
*** lme002 * end ***
             FROM VBRK INTO TABLE IT_VBRK
             FOR ALL ENTRIES IN IT_VBFA2
             WHERE VBELN EQ IT_VBFA2-VBELN
               AND FKART IN S_FKART
               AND FKDAT IN S_FKDAT
*               and erdat in r_date2.
               AND ERDAT IN S_ERDAT2.
* begin of delete lme004
*      SORT it_vbrk BY vbeln.
* end of delete lme004
      DELETE ADJACENT DUPLICATES FROM IT_VBRK.

      IF NOT IT_VBRK[] IS INITIAL.

*** js-005 * begin ***
*        SELECT * FROM tvfk INTO TABLE it_tvfk
*                 FOR ALL ENTRIES IN it_vbrk
*                 WHERE fkart EQ it_vbrk-fkart.
*        DELETE ADJACENT DUPLICATES FROM it_tvfk.
*** js-005 * end ***

*       Depending on checkbox, restrict billing items at FAREG
        IF NOT CB_EDP IS INITIAL.
          SELECT VBELN POSNR NETWR VRKME KZWI3 FAREG FKIMG FPLNR
                 AUBEL AUPOS
* LME insert
                 PSTYV
* LME insert
                 FROM VBRP INTO TABLE IT_VBRP
                 FOR ALL ENTRIES IN IT_VBRK
                 WHERE VBELN EQ IT_VBRK-VBELN
                   AND FAREG NE '4'
                   AND FAREG NE '5'.
        ELSE.
          SELECT VBELN POSNR NETWR VRKME KZWI3 FAREG FKIMG FPLNR
                 AUBEL AUPOS
* LME insert
                 PSTYV
* LME insert
                 FROM VBRP INTO TABLE IT_VBRP
                 FOR ALL ENTRIES IN IT_VBRK
                 WHERE VBELN EQ IT_VBRK-VBELN.  " TVO

* issue 4244, Spec 3.1.3  - zero downpayment lines.
          IF P_NO_DP = 'X'.
            LOOP AT IT_VBRP WHERE FAREG = '4' OR FAREG = '5'.
              IT_VBRP-NETWR = 0.
              IT_VBRP-KZWI3 = 0.    " KZWI3_INV - InvNetValue
              IT_VBRP-FKIMG = 0.
              MODIFY IT_VBRP.
            ENDLOOP.
          ENDIF.
        ENDIF.
      ENDIF.

*** js-005 * begin ***
*      SORT it_vbrp BY vbeln posnr.
      DELETE ADJACENT DUPLICATES FROM IT_VBRP COMPARING VBELN POSNR.
*** js-005 * begin ***

      SELECT VBELN BUKRS FKART WAERK FKDAT ERDAT VBTYP FKTYP
             FROM VBRK INTO TABLE IT_VBRK2
             FOR ALL ENTRIES IN IT_VBFA2
             WHERE VBELN EQ IT_VBFA2-VBELN.
* begin of delete lme004
*      SORT it_vbrk2 BY vbeln.
* end of delete lme004
      DELETE ADJACENT DUPLICATES FROM IT_VBRK2.

      IF NOT IT_VBRK2[] IS INITIAL.
        SELECT VBELN POSNR NETWR VRKME KZWI3 FAREG FKIMG FPLNR
               AUBEL AUPOS
* LME insert
               PSTYV
* LME insert
               FROM VBRP INTO TABLE IT_VBRP2
               FOR ALL ENTRIES IN IT_VBRK2
               WHERE VBELN EQ IT_VBRK2-VBELN.
* issue 4244, Spec 3.1.3  - zero downpayment lines.
        IF P_NO_DP = 'X'.
          LOOP AT IT_VBRP2 WHERE FAREG = '4' OR FAREG = '5'.
            IT_VBRP2-NETWR = 0.
            IT_VBRP2-KZWI3 = 0.    " KZWI3_INV - InvNetValue
            IT_VBRP2-FKIMG = 0.
            MODIFY IT_VBRP2.
          ENDLOOP.
        ENDIF.
      ENDIF.

    ENDIF.

*   Read purchase orders into IT_VBFA3
*    SELECT * FROM vbfa INTO TABLE it_vbfa3                 "js-005
    SELECT * FROM VBFA INTO TABLE IT_VBFA3I                 "js-005
             FOR ALL ENTRIES IN IT_VBAK
             WHERE VBELV   EQ IT_VBAK-VBELN
               AND VBTYP_N EQ C_VBTYP_V       " V - Purchase Order
               AND VBTYP_V EQ IT_VBAK-VBTYP
               AND RFMNG > 0            " Issue: 4727
               AND STUFE EQ SPACE.
*** js-005 * begin ***
    SORT IT_VBFA3I BY VBELV POSNV VBTYP_N VBTYP_V.
    DELETE ADJACENT DUPLICATES FROM IT_VBFA3I
           COMPARING VBELV POSNV VBTYP_N VBTYP_V.
    IT_VBFA3[] = IT_VBFA3I[].
*** js-005 * end ***

    IF NOT IT_VBFA3[] IS INITIAL.

*      SELECT * FROM ekko INTO TABLE it_ekko                "js-005
      SELECT * FROM EKKO INTO TABLE IT_EKKOI                "js-005
               FOR ALL ENTRIES IN IT_VBFA3
               WHERE EBELN EQ IT_VBFA3-VBELN
                 AND EBELN IN S_EBELN.
*** js-005 * begin ***
      SORT IT_EKKOI BY EBELN.
      DELETE ADJACENT DUPLICATES FROM IT_EKKOI
             COMPARING EBELN.
      IT_EKKO[] = IT_EKKOI[].
*** js-005 * end ***

      IF NOT IT_EKKO[] IS INITIAL.

*        SELECT * FROM lfa1 INTO TABLE it_lfa1              "js-005
        SELECT * FROM LFA1 INTO TABLE IT_LFA1I              "js-005
                 FOR ALL ENTRIES IN IT_EKKO
                WHERE LIFNR EQ IT_EKKO-LIFNR.
*** js-005 * begin ***
*        DELETE ADJACENT DUPLICATES FROM it_lfa1 COMPARING lifnr.
        SORT IT_LFA1I BY LIFNR.
        DELETE ADJACENT DUPLICATES FROM IT_LFA1I
               COMPARING LIFNR.
        IT_LFA1[] = IT_LFA1I[].
*** js-005 * end ***

*** js-001 * begin ***
        SELECT EBELN EBELP FROM EKPO INTO TABLE IT_EKPO
               FOR ALL ENTRIES IN IT_EKKO
               WHERE EBELN EQ IT_EKKO-EBELN.
*** js-001 * end ***
      ENDIF.

    ENDIF.

  ENDIF.

  SORT LT_ADRNR.
  DELETE ADJACENT DUPLICATES FROM LT_ADRNR.

  IF NOT LT_ADRNR[] IS INITIAL.
*    SELECT * FROM adrc INTO TABLE xt_adrc                  "js-005
    SELECT * FROM ADRC INTO TABLE XT_ADRCI                  "js-005
             FOR ALL ENTRIES IN LT_ADRNR
             WHERE ADDRNUMBER EQ LT_ADRNR-ADRNR
               AND DATE_FROM  LE SY-DATUM.
*   keep only the latest
*    SORT xt_adrc BY addrnumber date_from DESCENDING.       "js-005
    SORT XT_ADRCI BY ADDRNUMBER DATE_FROM DESCENDING.       "js-005
    CLEAR XV_ADRC_ENDCUSTOMER.
*** js-005 * begin ***
*    LOOP AT xt_adrc INTO xv_adrc_endcustomer.
*      lv_tabix = sy-tabix.
*      IF lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*        DELETE xt_adrc INDEX lv_tabix.
*      ENDIF.
*      lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*    ENDLOOP.
    DELETE ADJACENT DUPLICATES FROM XT_ADRCI
           COMPARING ADDRNUMBER.
    XT_ADRC[] = XT_ADRCI[].
*** js-005 * end ***
  ENDIF.

  SORT LT_KUNNR.
  DELETE ADJACENT DUPLICATES FROM LT_KUNNR.
  IF NOT LT_KUNNR[] IS INITIAL.
    SELECT KUNNR ADRNR BRAN1 NAME1 FROM KNA1 INTO TABLE XT_KNA1
           FOR ALL ENTRIES IN LT_KUNNR
           WHERE KUNNR EQ LT_KUNNR-KUNNR.
  ENDIF.

ENDFORM.                    " SELECT_DATA

*--------------------------------------------------------------------*
*   Form  PROCESS_DATA                                               *
*--------------------------------------------------------------------*
FORM PROCESS_DATA.

  DATA: LV_VBELN_ORD LIKE IT_DATA-VBELN_ORD,
        LV_POSNR_ORD LIKE IT_DATA-POSNR_ORD,
        LV_EBELP     LIKE IT_DATA-EBELP,                    "js-001
        LV_VBPA2 LIKE LINE OF XT_VBPA2,
        LV_VBPA3 LIKE LINE OF XT_VBPA3.

  FIELD-SYMBOLS: <L_DATA> LIKE LINE OF IT_DATA.


* do sorts                                    "20080327
  SORT IT_VBUK1 BY VBELN.
* begin of delete lme004
*  SORT it_vbuk2 BY vbeln.
*  SORT xt_konv BY knumv kposn kschl.
* end of delete lme004
*  SORT it_vbep BY vbeln posnr etenr.  " for loop!          "js-005
*** begin gru001
*  SORT it_vbepr BY vbeln posnr.  " for loop!               "js-005
*** end gru001

* begin of delete lme004
*  SORT it_vbup BY vbeln posnr.
*  SORT it_vbkd BY vbeln posnr.
*  SORT it_mvke BY matnr vkorg vtweg.
* end of delete lme004
  SORT IT_CE41000 BY PAOBJNR.
  SORT IT_VBPA1 BY VBELN POSNR PARVW.

*** js-001 * begin ***
* begin of change lme004
*  SORT: it_ekko BY ebeln,
*        it_lfa1 BY lifnr,
  SORT:
* end of change lme004
        IT_EKPO,
        IT_MARA,
        IT_MARC.
*** js-001 * end ***

  CLEAR STR_DATA.
  LOOP AT IT_VBAK.
    CLEAR: IT_TVKBT, IT_TVGRT, IT_KNVH, IT_KNA1_HL.
    CLEAR XV_ADRC_ENDCUSTOMER.                              "js-002

    READ TABLE IT_BILLRELEV WITH KEY AUART = IT_VBAK-AUART.
    IF SY-SUBRC NE 0.
      CONTINUE.
    ENDIF.

    READ TABLE IT_VBUK1 WITH KEY VBELN = IT_VBAK-VBELN
                          BINARY SEARCH.

    IF ( SY-SUBRC NE 0 ) OR
       ( SY-SUBRC EQ 0 AND NOT IT_VBUK1-GBSTK IN S_GBSTK ).
      CLEAR IT_VBUK1.
      CONTINUE.
    ENDIF.

    READ TABLE IT_TVKBT
*               WITH KEY vkbur = it_vbak-vkbur              "js-005
               WITH TABLE KEY SPRAS = SY-LANGU              "js-005
                              VKBUR = IT_VBAK-VKBUR.        "js-005
*               BINARY SEARCH.                              "js-005

    READ TABLE IT_TVGRT
*               WITH KEY vkgrp = it_vbak-vkgrp              "js-005
               WITH TABLE KEY SPRAS = SY-LANGU              "js-005
                              VKGRP = IT_VBAK-VKGRP.        "js-005
*               BINARY SEARCH.                              "js-005

    CLEAR IT_KNA1_HL.
    READ TABLE IT_KNVH
*               WITH KEY hityp = c_hityp_a                  "js-005
               WITH TABLE KEY HITYP = C_HITYP_A             "js-005
                              KUNNR = IT_VBAK-KUNNR
                              VKORG = IT_VBAK-VKORG
                              VTWEG = IT_VBAK-VTWEG
                              SPART = IT_VBAK-SPART.
*              BINARY SEARCH.                               "js-005

    IF SY-SUBRC NE 0.
      CLEAR: IT_KNVH.
      CLEAR: IT_KNA1_HL.
      CLEAR XV_ADRC_ENDCUSTOMER.                            "js-002
    ENDIF.
    IF IT_KNVH-HKUNNR IN S_HKUNNR.
      READ TABLE IT_KNA1_HL
                 WITH TABLE KEY KUNNR = IT_KNVH-HKUNNR.     "js-005
*                 WITH KEY kunnr = it_knvh-hkunnr           "js-005
*                 BINARY SEARCH.                            "js-005
      IF SY-SUBRC = 0.
*       get adrc for kna1
        READ TABLE XT_ADRC INTO XV_ADRC_ENDCUSTOMER
*              WITH KEY addrnumber = it_kna1_hl-adrnr       "js-005
              WITH TABLE KEY ADDRNUMBER = IT_KNA1_HL-ADRNR. "js-005
*              BINARY SEARCH.                               "js-005
*** js-002 * begin ***
        IF SY-SUBRC NE 0.
          CLEAR XV_ADRC_ENDCUSTOMER.
        ENDIF.
*** js-002 * end ***
      ENDIF.
    ELSE.
      CONTINUE.
    ENDIF.

*   Loop through positions
    LOOP AT IT_VBAP WHERE VBELN EQ IT_VBAK-VBELN.
      CLEAR IT_VBUP.

*      READ TABLE it_mvke WITH KEY matnr = it_vbap-matnr    "js-005
      READ TABLE IT_MVKE
                 WITH TABLE KEY MATNR = IT_VBAP-MATNR       "js-005
                                VKORG = IT_VBAK-VKORG
                                VTWEG = IT_VBAK-VTWEG.
*                          BINARY SEARCH.                   "js-005

      IF SY-SUBRC NE 0.
        CONTINUE.
      ENDIF.

*** js-001 * begin ***
      READ TABLE IT_MARA WITH KEY MATNR = IT_VBAP-MATNR
                         BINARY SEARCH.
      IF SY-SUBRC NE 0.
        CONTINUE.
      ENDIF.
      READ TABLE IT_MARC WITH KEY MATNR = IT_VBAP-MATNR
                                  WERKS = IT_VBAP-WERKS
                         BINARY SEARCH.
      IF SY-SUBRC NE 0.
        CONTINUE.
      ENDIF.
*** js-001 * end ***

      READ TABLE IT_VBKD
*                 WITH KEY vbeln = it_vbap-vbeln            "js-005
                 WITH TABLE KEY VBELN = IT_VBAP-VBELN       "js-005
                                POSNR = IT_VBAP-POSNR.
*                 BINARY SEARCH.                            "js-005

      IF SY-SUBRC NE 0.
        READ TABLE IT_VBKD
*                   WITH KEY vbeln = it_vbap-vbeln          "js-005
                   WITH TABLE KEY VBELN = IT_VBAP-VBELN     "js-005
                                  POSNR = C_POSNR_INIT.
*                           BINARY SEARCH.                  "js-005
        IF SY-SUBRC NE 0.
          CLEAR IT_VBKD.
          CONTINUE.
        ENDIF.
      ENDIF.

      LOOP AT IT_VBEP WHERE VBELN     EQ IT_VBAP-VBELN
                        AND POSNR     EQ IT_VBAP-POSNR
                        AND NOT BMENG IS INITIAL.
        EXIT.                                               "js-001
      ENDLOOP.

      IF SY-SUBRC NE 0.
        CLEAR IT_VBEP.
        IF NOT S_EDATU IS INITIAL.
          CONTINUE.
        ENDIF.
      ENDIF.
*** begin gru001
      LOOP AT IT_VBEPR WHERE VBELN     EQ IT_VBAP-VBELN
                         AND POSNR     EQ IT_VBAP-POSNR.
        EXIT.
      ENDLOOP.

      IF SY-SUBRC NE 0.
        CLEAR IT_VBEPR.
        IF NOT S_VDATU IS INITIAL.
          CONTINUE.
        ENDIF.
      ENDIF.
*** end gru001

      READ TABLE IT_VBUP
*                 WITH KEY vbeln = it_vbap-vbeln            "jus-005
                 WITH TABLE KEY VBELN = IT_VBAP-VBELN       "jus-005
                                POSNR = IT_VBAP-POSNR.
*                 BINARY SEARCH.                            "jus-005

      READ TABLE IT_MAKT INTO WA_MAKT WITH KEY MATNR = IT_VBAP-MATNR
                                                  BINARY SEARCH.
      IF SY-SUBRC NE 0.
        CLEAR IT_MAKT.
      ENDIF.

      READ TABLE IT_ACCT WITH KEY PAOBJNR = IT_VBAP-PAOBJNR
                          BINARY SEARCH.
      IF SY-SUBRC NE 0.
        CLEAR IT_ACCT.
        CLEAR IT_CE41000.                                   "jus-001
*      CONTINUE.    " Quotations don't have profitability segments,
*                     so don't make a problem of it. Also for other
*                     documents, don't consider this a reason not to
*                     show the item
      ELSE.
        READ TABLE IT_CE41000
                   WITH KEY PAOBJNR = IT_ACCT-CE4KEY
                   BINARY SEARCH.
        IF SY-SUBRC NE 0.
          CLEAR IT_CE41000.                                 "jus-001
          CONTINUE.
        ENDIF.
      ENDIF.

      READ TABLE XT_KONV INTO XV_KONV1
*                 WITH KEY knumv = it_vbak-knumv            "jus-005
                 WITH TABLE KEY KNUMV = IT_VBAK-KNUMV       "jus-005
                                KPOSN = IT_VBAP-POSNR
                                KSCHL = C_KSCHL_ZPRO.
*                 BINARY SEARCH .                           "jus-005
      IF SY-SUBRC NE 0.
        CLEAR XV_KONV1.
      ENDIF.

      READ TABLE XT_KONV INTO XV_KONV2
*                 WITH KEY knumv = it_vbak-knumv            "jus-005
                 WITH TABLE KEY KNUMV = IT_VBAK-KNUMV       "jus-005
                                KPOSN = IT_VBAP-POSNR
                                KSCHL = C_KSCHL_ZPRS.
*                 BINARY SEARCH .                           "jus-005
      IF SY-SUBRC NE 0.
        CLEAR XV_KONV2.
*** lme001 * begin ***
        READ TABLE XT_KONV INTO XV_KONV2
*                   WITH KEY knumv = it_vbak-knumv          "jus-005
                   WITH TABLE KEY KNUMV = IT_VBAK-KNUMV     "jus-005
                                  KPOSN = IT_VBAP-POSNR
                                  KSCHL = C_KSCHL_ZURS.
*                   BINARY SEARCH .                         "jus-005
        IF SY-SUBRC NE 0.
          CLEAR XV_KONV2.
        ENDIF.
*** lme001 * end ***
      ENDIF.

*** js-002 * begin ***
*     Freight charge
      READ TABLE XT_KONV INTO XV_KONVF
*                 WITH KEY knumv = it_vbak-knumv            "jus-005
                 WITH TABLE KEY KNUMV = IT_VBAK-KNUMV       "jus-005
                                   KPOSN = IT_VBAP-POSNR
                                   KSCHL = C_KSCHL_ZD00.
*                 BINARY SEARCH .                           "jus-005
      IF SY-SUBRC NE 0.
        CLEAR XV_KONVF.
      ENDIF.
*** js-002 * end ***

      READ TABLE IT_VBPA1 WITH KEY VBELN = IT_VBAP-VBELN
                                   POSNR = C_POSNR_INIT
                                   PARVW = C_PARVW_AG
                           BINARY SEARCH.
      IF SY-SUBRC NE 0.
        CLEAR: IT_VBPA1.
        CLEAR: XV_KNA1_AG.
        CONTINUE.
      ELSE.
        READ TABLE XT_KNA1 INTO XV_KNA1_AG
                            WITH KEY KUNNR = IT_VBPA1-KUNNR.
        IF SY-SUBRC NE 0.
          CLEAR XV_KNA1_AG.
          CONTINUE.
        ELSEIF NOT XV_KNA1_AG-BRAN1 IN S_BRAN1.
          CLEAR XV_KNA1_AG.
          CONTINUE.
        ENDIF.
      ENDIF.

      READ TABLE XT_VBPA2 INTO LV_VBPA2
                          WITH KEY VBELN = IT_VBAP-VBELN
                                   POSNR = IT_VBAP-POSNR
                                   PARVW = C_PARVW_WE
                              .
      IF SY-SUBRC NE 0.
        READ TABLE XT_VBPA2 INTO LV_VBPA2
                            WITH KEY VBELN = IT_VBAP-VBELN
                                     POSNR = C_POSNR_INIT
                                     PARVW = C_PARVW_WE.
        IF SY-SUBRC NE 0.
          CLEAR: LV_VBPA2.
          CONTINUE.
        ENDIF.
      ENDIF.
      READ TABLE XT_KNA1 INTO XV_KNA1_WE
                         WITH KEY KUNNR = LV_VBPA2-KUNNR.
      IF SY-SUBRC NE 0.
        CLEAR: XV_KNA1_WE.
        CLEAR: XV_ADRC.
      ELSE.
        READ TABLE XT_ADRC INTO XV_ADRC
*             WITH KEY addrnumber = xv_kna1_we-adrnr        "js-005
             WITH KEY ADDRNUMBER = XV_KNA1_WE-ADRNR.        "js-005
*             BINARY SEARCH.                                "js-005
        IF SY-SUBRC NE 0.
          CLEAR: XV_ADRC.
        ENDIF.
      ENDIF.

      READ TABLE XT_VBPA3 INTO LV_VBPA3
                          WITH KEY VBELN = IT_VBAP-VBELN
                                   POSNR = IT_VBAP-POSNR
                                   PARVW = C_PARVW_RE
                                   .
      IF SY-SUBRC NE 0.
        READ TABLE XT_VBPA3 INTO LV_VBPA3
                  WITH KEY VBELN = IT_VBAP-VBELN
                           POSNR = C_POSNR_INIT
                           PARVW = C_PARVW_RE
                                     .
        IF SY-SUBRC NE 0.
          CLEAR: LV_VBPA3 .
          CONTINUE.
        ENDIF.
      ENDIF.
      READ TABLE XT_KNA1 INTO XV_KNA1_RE
                  WITH KEY KUNNR = LV_VBPA3-KUNNR.
      IF SY-SUBRC NE 0.
        CLEAR: XV_KNA1_RE.
      ENDIF.

      PERFORM GET_SALESREP USING C_PARVW_VE
                           CHANGING X_PARVW_VE
                                    X_PERNR_VE
                                    X_ENAME_VE.
      PERFORM GET_SALESREP USING C_PARVW_ZX
                           CHANGING X_PARVW_ZX
                                    X_PERNR_ZX
                                    X_ENAME_ZX.
      PERFORM GET_SALESREP USING C_PARVW_ZY
                           CHANGING X_PARVW_ZY
                                    X_PERNR_ZY
                                    X_ENAME_ZY.
      IF NOT X_PERNR_VE IN S_PERNR AND
         NOT X_PERNR_ZX IN S_PERNR AND
         NOT X_PERNR_ZY IN S_PERNR.
        CONTINUE.
      ENDIF.

      READ TABLE IT_VBFA3
*                 WITH KEY vbelv   = it_vbak-vbeln          "js-005
                 WITH TABLE KEY VBELV   = IT_VBAK-VBELN     "js-005
                                POSNV   = IT_VBAP-POSNR
                                VBTYP_N = C_VBTYP_V
                                VBTYP_V = IT_VBAK-VBTYP.
      IF SY-SUBRC NE 0.
        CLEAR IT_VBFA3.
        CLEAR IT_EKKO.
        CLEAR IT_LFA1.
        CLEAR IT_EKPO.                                      "js-001
        IF NOT S_EBELN[]      IS INITIAL  AND
           NOT IT_VBFA3-VBELN IN S_EBELN.
          CONTINUE.
        ENDIF.
      ELSE.
*** js-005 * begin ***
*        READ TABLE it_ekko WITH KEY ebeln = it_vbfa3-vbeln
*                           BINARY SEARCH.
        READ TABLE IT_EKKO WITH TABLE KEY EBELN = IT_VBFA3-VBELN.
*** js-005 * end ***
        IF SY-SUBRC EQ 0.
*** js-005 * begin ***
*          READ TABLE it_lfa1 WITH KEY lifnr = it_ekko-lifnr
*                             BINARY SEARCH.
          READ TABLE IT_LFA1 WITH TABLE KEY LIFNR = IT_EKKO-LIFNR.
*** js-005 * end ***
          IF SY-SUBRC NE 0.
            CLEAR IT_LFA1.
          ENDIF.
*** js-001 * begin ***
          LV_EBELP = IT_VBFA3-POSNN.
          READ TABLE IT_EKPO WITH KEY EBELN = IT_VBFA3-VBELN
                                      EBELP = LV_EBELP
                             BINARY SEARCH.
          IF SY-SUBRC NE 0.
            CLEAR IT_EKPO.
          ENDIF.
*** js-001 * end ***
        ELSE.
          CLEAR IT_EKKO.
          CLEAR IT_LFA1.
          CLEAR IT_EKPO.                                    "js-001
          CONTINUE.
        ENDIF.
      ENDIF.

      LOOP AT IT_VBFA1 WHERE VBELV   EQ IT_VBAP-VBELN
                         AND POSNV   EQ IT_VBAP-POSNR
                         AND (    VBTYP_N EQ C_VBTYP_J
                               OR VBTYP_N EQ C_VBTYP_T )
                         AND VBTYP_V EQ IT_VBAK-VBTYP.

        READ TABLE IT_LIKP
*                   WITH KEY vbeln = it_vbfa1-vbeln         "js-005
                   WITH TABLE KEY VBELN = IT_VBFA1-VBELN.   "js-005
*                   BINARY SEARCH.                          "js-005
        IF SY-SUBRC NE 0.
          CLEAR IT_LIKP.
        ENDIF.

        READ TABLE IT_VBUK2
*             WITH KEY vbeln = it_likp-vbeln                "js-005
             WITH TABLE KEY VBELN = IT_LIKP-VBELN.          "js-005
*             BINARY SEARCH.                                "js-005
        IF SY-SUBRC NE 0.
          CLEAR IT_VBUK2.
        ENDIF.
*        IF NOT CB_SEL IS INITIAL.
*          CHECK IT_VBUK2-WBSTK EQ C_WBSTK_C.
*        ENDIF.

        LOOP AT IT_LIPS WHERE VBELN EQ IT_LIKP-VBELN
                          AND POSNR EQ IT_VBFA1-POSNN.

*         Invoices can be delivery-related or order-related
          IF IT_BILLRELEV-ZFKREL EQ C_ZFKREL_C.
            X_VBELV = IT_LIPS-VBELN.
            X_POSNV = IT_LIPS-POSNR.
            X_VBTYP = IT_LIKP-VBTYP.
          ELSEIF IT_BILLRELEV-ZFKREL EQ C_ZFKREL_A.
            X_VBELV = IT_VBAP-VBELN.
            X_POSNV = IT_VBAP-POSNR.
            X_VBTYP = IT_VBAK-VBTYP.
          ELSE.
            X_VBELV = IT_VBAP-VBELN.
            X_POSNV = IT_VBAP-POSNR.
            X_VBTYP = IT_VBAK-VBTYP.
          ENDIF.

          CLEAR IT_VBFA2.
          LOOP AT IT_VBFA2 WHERE ( VBELV   EQ X_VBELV )
                             AND ( POSNV   EQ X_POSNV )
                             AND ( VBTYP_N EQ C_VBTYP_M
                                OR VBTYP_N EQ C_VBTYP_N
*** js-006 * begin ***
                                OR VBTYP_N EQ C_VBTYP_P
                                OR VBTYP_N EQ C_VBTYP_S
*** js-006 * end ***
                                OR VBTYP_N EQ C_VBTYP_O )
                             AND ( VBTYP_V EQ X_VBTYP ).

            IF NOT RB_SEL2 IS INITIAL.
              CONTINUE.
            ENDIF.

            READ TABLE IT_VBRK WITH KEY VBELN = IT_VBFA2-VBELN
                               BINARY SEARCH.
            IF SY-SUBRC NE 0.
              CLEAR IT_VBRK.
              CONTINUE.
            ENDIF.

            LOOP AT IT_VBRP WHERE VBELN EQ IT_VBRK-VBELN
                              AND POSNR EQ IT_VBFA2-POSNN.

              PERFORM GET_ORDERSTATUS_DATA.
              PERFORM GET_ORDER_DATA.
              PERFORM GET_ORDER_BUSINESS_DATA.
              PERFORM GET_MATERIAL_DATA.
              PERFORM GET_ATLASCOPCO_DATA.
              PERFORM GET_CONDITIONS_DATA.
              PERFORM GET_SOLDTO_DATA.
              PERFORM GET_SHIPTO_DATA USING LV_VBPA2.
              PERFORM GET_BILLTO_DATA USING LV_VBPA3.
              PERFORM GET_HLEVEL_CUST_DATA.
              PERFORM GET_PURCHASE_DATA.
              PERFORM GET_DELIVERYSTATUS_DATA.
              PERFORM GET_DELIVERY_DATA.
              PERFORM GET_INVOICE_DATA.
*             Get golden tax reference
              PERFORM GET_GTS_INVOICE.
              PERFORM GET_SALES_REP_DATA.
              PERFORM GET_BILLING_PLAN_DATA .
              PERFORM CALCULATE_DATA USING C_STATUS_INV1.
              PERFORM SAVE_ALL_DATA.
              PERFORM RESET_DATA.
            ENDLOOP.

          ENDLOOP.

          IF SY-SUBRC    NE 0       AND
             ( NOT RB_SEL1 IS INITIAL OR
               NOT RB_SEL2 IS INITIAL ).
            PERFORM GET_ORDERSTATUS_DATA.
            PERFORM GET_ORDER_DATA.
            PERFORM GET_ORDER_BUSINESS_DATA.
            PERFORM GET_MATERIAL_DATA.
            PERFORM GET_ATLASCOPCO_DATA.
            PERFORM GET_CONDITIONS_DATA.
            PERFORM GET_SOLDTO_DATA.
            PERFORM GET_SHIPTO_DATA USING LV_VBPA2.
            PERFORM GET_BILLTO_DATA USING LV_VBPA3.
            PERFORM GET_HLEVEL_CUST_DATA.
            PERFORM GET_PURCHASE_DATA.
            PERFORM GET_DELIVERYSTATUS_DATA.
            PERFORM GET_DELIVERY_DATA.
            PERFORM GET_SALES_REP_DATA.
            PERFORM GET_BILLING_PLAN_DATA .
            PERFORM CALCULATE_DATA USING C_STATUS_DEL.
            PERFORM SAVE_ALL_DATA.
            PERFORM RESET_DATA.
          ENDIF.
        ENDLOOP.

      ENDLOOP.

*** js-004 * begin ***
*     Process invoiced ASSO
      IF SY-SUBRC = 0            AND
         NOT X_ASSO IS INITIAL   AND
         NOT R4 IS INITIAL.
        PERFORM GET_ORDERSTATUS_DATA.
        PERFORM GET_ORDER_DATA.
        PERFORM GET_ORDER_BUSINESS_DATA.
        PERFORM GET_MATERIAL_DATA.
        PERFORM GET_ATLASCOPCO_DATA.
        PERFORM GET_CONDITIONS_DATA.
        PERFORM GET_SOLDTO_DATA.
        PERFORM GET_SHIPTO_DATA USING LV_VBPA2.
        PERFORM GET_BILLTO_DATA USING LV_VBPA3.
        PERFORM GET_HLEVEL_CUST_DATA.
        PERFORM GET_PURCHASE_DATA.
        PERFORM GET_DELIVERYSTATUS_DATA.
        PERFORM GET_DELIVERY_DATA.
        PERFORM GET_SALES_REP_DATA.
        PERFORM GET_BILLING_PLAN_DATA .
        PERFORM CALCULATE_DATA USING C_STATUS_DEL.
        PERFORM SAVE_ALL_DATA.
        PERFORM RESET_DATA.
      ENDIF.
*** js-004 * end ***

      IF SY-SUBRC NE 0.
        IF ( NOT RB_SEL1 IS INITIAL AND CB_SEL IS INITIAL ) OR
           ( NOT RB_SEL2 IS INITIAL AND CB_SEL IS INITIAL ) OR
           ( NOT RB_SEL3 IS INITIAL ).
          IF IT_BILLRELEV-ZFKREL EQ C_ZFKREL_C.
* At this point, there are no deliveries and the document is
* delivery-related, so no invoices will be found. The orders are
* not invoiced and all relevant data must be displayed !
            IF RB_SEL3 IS INITIAL.
              PERFORM GET_ORDERSTATUS_DATA.
              PERFORM GET_ORDER_DATA.
              PERFORM GET_ORDER_BUSINESS_DATA.
              PERFORM GET_MATERIAL_DATA.
              PERFORM GET_ATLASCOPCO_DATA.
              PERFORM GET_CONDITIONS_DATA.
              PERFORM GET_SOLDTO_DATA.
              PERFORM GET_SHIPTO_DATA USING LV_VBPA2.
              PERFORM GET_BILLTO_DATA USING LV_VBPA3.
              PERFORM GET_HLEVEL_CUST_DATA.
              PERFORM GET_PURCHASE_DATA.
              PERFORM GET_SALES_REP_DATA.
              PERFORM CALCULATE_DATA USING C_STATUS_ORD.
              PERFORM SAVE_ALL_DATA.
              PERFORM RESET_DATA.
            ENDIF.
          ELSE.
* Order-related invoices can be found anyway, because deliveries are
* not necessary at this point.
            CLEAR IT_VBFA2.
            LOOP AT IT_VBFA2 WHERE ( VBELV   EQ IT_VBAP-VBELN )
                               AND ( POSNV   EQ IT_VBAP-POSNR )
                               AND ( VBTYP_N EQ C_VBTYP_M
                                  OR VBTYP_N EQ C_VBTYP_N
* LME insert
                                  OR VBTYP_N EQ C_VBTYP_S
* LME insert
                                  OR VBTYP_N EQ C_VBTYP_O
                                  OR VBTYP_N EQ C_VBTYP_P ).
* MJ deletion
*                               AND ( vbtyp_v EQ it_vbak-vbtyp ).
* MJ deletion
              IF NOT RB_SEL2 IS INITIAL.
                CONTINUE.
              ENDIF.

              READ TABLE IT_VBRK WITH KEY VBELN = IT_VBFA2-VBELN
                                 BINARY SEARCH.
              IF SY-SUBRC NE 0.
                CLEAR IT_VBRK.
                CONTINUE.
              ENDIF.
              LOOP AT IT_VBRP WHERE VBELN EQ IT_VBRK-VBELN
                                AND POSNR EQ IT_VBFA2-POSNN.

                PERFORM GET_ORDERSTATUS_DATA.
                PERFORM GET_ORDER_DATA.
                PERFORM GET_ORDER_BUSINESS_DATA.
                PERFORM GET_MATERIAL_DATA.
                PERFORM GET_ATLASCOPCO_DATA.
                PERFORM GET_CONDITIONS_DATA.
                PERFORM GET_SOLDTO_DATA.
                PERFORM GET_SHIPTO_DATA USING LV_VBPA2.
                PERFORM GET_BILLTO_DATA USING LV_VBPA3.
                PERFORM GET_HLEVEL_CUST_DATA.
                PERFORM GET_PURCHASE_DATA.
                PERFORM GET_INVOICE_DATA.
                PERFORM GET_GTS_INVOICE.
                PERFORM GET_SALES_REP_DATA.
                PERFORM GET_BILLING_PLAN_DATA.
                PERFORM CALCULATE_DATA USING C_STATUS_INV2.
                PERFORM SAVE_ALL_DATA.
                PERFORM RESET_DATA.
              ENDLOOP.

            ENDLOOP.

            IF SY-SUBRC   NE 0       AND
               RB_SEL3    IS INITIAL.
* Orders are not invoices and relevant data must be displayed anyway
              PERFORM GET_ORDERSTATUS_DATA.
              PERFORM GET_ORDER_DATA.
              PERFORM GET_ORDER_BUSINESS_DATA.
              PERFORM GET_MATERIAL_DATA.
              PERFORM GET_ATLASCOPCO_DATA.
              PERFORM GET_CONDITIONS_DATA.
              PERFORM GET_SOLDTO_DATA.
              PERFORM GET_SHIPTO_DATA USING LV_VBPA2.
              PERFORM GET_BILLTO_DATA USING LV_VBPA3.
              PERFORM GET_HLEVEL_CUST_DATA.
              PERFORM GET_PURCHASE_DATA.
              PERFORM GET_SALES_REP_DATA.
              PERFORM CALCULATE_DATA USING C_STATUS_ORD.
              PERFORM SAVE_ALL_DATA.
              PERFORM RESET_DATA.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.

* Start change TVO for 3368: order without items should not be shown
** It seems that orders without items are possible. To be sure that
** we are dealing with such orders, all selections concerning items
** must be initial
*    IF SY-SUBRC   NE 0       AND
*       RB_SEL3    IS INITIAL AND
*       S_POSNR[]  IS INITIAL AND
*       S_PRCTR[]  IS INITIAL AND
*       S_WW002[]  IS INITIAL AND
*       S_WW006[]  IS INITIAL AND
*       S_WW007[]  IS INITIAL AND
*       S_WERKS[]  IS INITIAL AND
*       S_MATNR[]  IS INITIAL AND
**      s_kunwe[]  is initial and
*       S_PERNR[]  IS INITIAL AND
*       S_BRAN1[]  IS INITIAL AND
*       S_PSTYV[]  IS INITIAL AND
*       S_MTPOS[]  IS INITIAL.
*
** Some data must be selected without item and therefore selections
** must be done again on header level at this point
*      READ TABLE IT_VBKD WITH KEY VBELN = IT_VBAK-VBELN
*                                  POSNR = C_POSNR_INIT.
*      IF SY-SUBRC NE 0.
*        CLEAR IT_VBKD.
*        CONTINUE.
*      ENDIF.
*
*      READ TABLE IT_VBPA1 WITH KEY VBELN = IT_VBAK-VBELN
*                                   POSNR = C_POSNR_INIT
*                                   PARVW = C_PARVW_AG.
*      IF SY-SUBRC NE 0.
*        CLEAR: IT_VBPA1.
*        CLEAR: IT_KNA1_AG.
*      ELSE.
*        READ TABLE IT_KNA1_AG WITH KEY KUNNR = IT_VBPA1-KUNNR.
*        IF SY-SUBRC NE 0.
*          CLEAR: IT_KNA1_AG.
*          CONTINUE.
*        ENDIF.
*      ENDIF.
*
*      READ TABLE IT_VBPA2 WITH KEY VBELN = IT_VBAK-VBELN
*                                   POSNR = C_POSNR_INIT
*                                   PARVW = C_PARVW_WE.
*      IF SY-SUBRC NE 0.
*        CLEAR: IT_VBPA2.
*        CLEAR: IT_KNA1_WE.
*        CLEAR: IT_ADRC.
*        CONTINUE.
*      ELSE.
*        READ TABLE IT_KNA1_WE WITH KEY KUNNR = IT_VBPA2-KUNNR.
*        IF SY-SUBRC NE 0.
*          CLEAR: IT_KNA1_WE.
*          CLEAR: IT_ADRC.
*        ELSE.
*          READ TABLE IT_ADRC WITH KEY ADDRNUMBER = IT_KNA1_WE-ADRNR.
*          IF SY-SUBRC NE 0.
*            CLEAR IT_ADRC.
*          ENDIF.
*        ENDIF.
*      ENDIF.
*
*      READ TABLE IT_VBPA3 WITH KEY VBELN = IT_VBAK-VBELN
*                                   POSNR = C_POSNR_INIT
*                                   PARVW = C_PARVW_RE.
*      IF SY-SUBRC NE 0.
*        CLEAR: IT_VBPA3.
*        CLEAR: IT_KNA1_RE.
*        CONTINUE.
*      ELSE.
*        READ TABLE IT_KNA1_RE WITH KEY KUNNR = IT_VBPA3-KUNNR.
*        IF SY-SUBRC NE 0.
*          CLEAR: IT_KNA1_RE.
*        ENDIF.
*      ENDIF.
*
*      PERFORM GET_ORDERSTATUS_DATA.
*      PERFORM GET_ORDER_DATA.
*      PERFORM GET_ORDER_BUSINESS_DATA.
*      PERFORM GET_SOLDTO_DATA.
*      PERFORM GET_SHIPTO_DATA.
*      PERFORM GET_BILLTO_DATA.
*      PERFORM GET_HLEVEL_CUST_DATA.
*      PERFORM SAVE_ALL_DATA.
*      PERFORM RESET_DATA.
*    ENDIF.
*   End change TVO for 3368

  ENDLOOP.

*** js-001 * begin ***
* Eliminate lines which don't fit the GTS invoice ref criterium
  DELETE IT_DATA WHERE ZUONR NOT IN S_ZUONR.
*** js-001 * end ***

* If suppress duplicate order lines is checked
  IF CB_SPPRD NE SPACE
     AND R3 = ' '                                           "js-001
     AND R4 = ' '.                                          "js-002

*   Sort table and start looping
    SORT IT_DATA BY VBELN_ORD POSNR_ORD.
    LOOP AT IT_DATA.
*     If new line is covering the same order item
      IF    IT_DATA-VBELN_ORD EQ LV_VBELN_ORD AND
            IT_DATA-POSNR_ORD EQ LV_POSNR_ORD.
*       Clear the order quantity and order value
        CLEAR:
          IT_DATA-KZWI3_ORD,
          IT_DATA-KWMENG,
          IT_DATA-KWERT_ZPRS,
          IT_DATA-ZPROFIT,
          IT_DATA-ZPROFPERC.
      ELSE.
        LV_VBELN_ORD = IT_DATA-VBELN_ORD.
        LV_POSNR_ORD = IT_DATA-POSNR_ORD.
      ENDIF.
*     Calculate order on hand (order quant - invoice quant)
      IT_DATA-KWMENG_OH = IT_DATA-KWMENG    - IT_DATA-FKIMG.
      IT_DATA-KZWI3_OH  = IT_DATA-KZWI3_ORD - IT_DATA-KZWI3_INV.
*     Calculate OH cost, profit, profit perc.
      IF NOT IT_DATA-KWMENG IS INITIAL.
        IT_DATA-KWERT_COS_OH = IT_DATA-KWERT_ZPRS * IT_DATA-KWMENG_OH /
                                IT_DATA-KWMENG.
        IT_DATA-ZPROFIT_OH   = IT_DATA-ZPROFIT *   IT_DATA-KWMENG_OH /
                                IT_DATA-KWMENG.
      ELSE.
        IT_DATA-KWERT_COS_OH = 0.
        IT_DATA-ZPROFIT_OH   = 0.
      ENDIF.
      IF NOT IT_DATA-KZWI3_OH IS INITIAL.
        IT_DATA-ZPROFPC_OH  = IT_DATA-ZPROFIT_OH * 100 /
                               IT_DATA-KZWI3_OH.

      ELSE.
        IT_DATA-ZPROFPC_OH  = 0.
      ENDIF.
      MODIFY IT_DATA.
    ENDLOOP.

  ENDIF.

* Eliminate lines which don't fit the GTS invoice ref criterium
*** js-001 * begin ***
*  LOOP AT it_data WHERE zuonr NOT IN s_zuonr.
*    DELETE it_data.
*  ENDLOOP.
*** js-001 * end ***

* DO after processing
*** js-001 * begin ***
  IF R3 = 'X'.
*   Open orders
    LOOP AT IT_SALES_OPEN ASSIGNING <SALES_OPEN>.
*     Profit
      PERFORM CONVERT_CURRENCY
              USING    <SALES_OPEN>-WAERK_ORD
                       <SALES_OPEN>-WAERK_CC
                       <SALES_OPEN>-ZPROFIT
              CHANGING <SALES_OPEN>-ZPROFIT_CC.
*     Invoice
      PERFORM CONVERT_CURRENCY
              USING    <SALES_OPEN>-WAERK_INV
                       <SALES_OPEN>-WAERK_CC
                       <SALES_OPEN>-KZWI3_INV
              CHANGING <SALES_OPEN>-KZWI3_INV_CC.

*     ORDER ITEM NET VALUE in CC
      PERFORM CONVERT_CURRENCY
              USING    <SALES_OPEN>-WAERK_ORD
                       <SALES_OPEN>-WAERK_CC
                       <SALES_OPEN>-KZWI3_ORD
              CHANGING <SALES_OPEN>-KZWI3_ORD_CC.
*** lme003 * begin ***
      <SALES_OPEN>-KZWI3_ORD_LOC =
            <SALES_OPEN>-KZWI3_ORD * <SALES_OPEN>-KURSK.
*** lme003 * end ***
*     Unit price
      PERFORM CONVERT_CURRENCY
              USING    <SALES_OPEN>-ZUNITPRCURR
                       <SALES_OPEN>-WAERK_CC
                       <SALES_OPEN>-ZUNITPR
              CHANGING <SALES_OPEN>-ZUNITPR_CC.
*     ORDER ON HAND VALUE
      PERFORM CONVERT_CURRENCY
              USING    <SALES_OPEN>-WAERK_ORD
                       <SALES_OPEN>-WAERK_CC
                       <SALES_OPEN>-KZWI3_OH
              CHANGING <SALES_OPEN>-KZWI3_OH_CC.
    ENDLOOP.
  ELSE.
*** js-001 * end ***
*** js-002 * begin ***
    IF R4 = 'X'.
*   Invoiced orders
      LOOP AT IT_SALES_INV ASSIGNING <SALES_INV>.
*       Profit
        PERFORM CONVERT_CURRENCY
                USING    <SALES_INV>-WAERK_ORD
                         <SALES_INV>-WAERK_CC
                         <SALES_INV>-ZPROFIT
                CHANGING <SALES_INV>-ZPROFIT_CC.
*       Invoice
        PERFORM CONVERT_CURRENCY
                USING    <SALES_INV>-WAERK_INV
                         <SALES_INV>-WAERK_CC
                         <SALES_INV>-KZWI3_INV
                CHANGING <SALES_INV>-KZWI3_INV_CC.

*       ORDER ITEM NET VALUE in CC
        PERFORM CONVERT_CURRENCY
                USING    <SALES_INV>-WAERK_ORD
                         <SALES_INV>-WAERK_CC
                         <SALES_INV>-KZWI3_ORD
                CHANGING <SALES_INV>-KZWI3_ORD_CC.
*** lme003 * begin ***
        <SALES_INV>-KZWI3_ORD_LOC =
              <SALES_INV>-KZWI3_ORD * <SALES_INV>-KURSK.
*** lme003 * end ***
*       Unit price
        PERFORM CONVERT_CURRENCY
                USING    <SALES_INV>-ZUNITPRCURR
                         <SALES_INV>-WAERK_CC
                         <SALES_INV>-ZUNITPR
                CHANGING <SALES_INV>-ZUNITPR_CC.
*       ORDER ON HAND VALUE
        PERFORM CONVERT_CURRENCY
                USING    <SALES_INV>-WAERK_ORD
                         <SALES_INV>-WAERK_CC
                         <SALES_INV>-KZWI3_OH
                CHANGING <SALES_INV>-KZWI3_OH_CC.
      ENDLOOP.
    ELSE.
*** js-002 * end ***
      LOOP AT IT_DATA ASSIGNING <L_DATA>.
*       Profit
        PERFORM CONVERT_CURRENCY
                USING    <L_DATA>-WAERK_ORD
                         <L_DATA>-WAERK_CC
                         <L_DATA>-ZPROFIT
                CHANGING <L_DATA>-ZPROFIT_CC.
*       Invoice
        PERFORM CONVERT_CURRENCY
                USING    <L_DATA>-WAERK_INV
                         <L_DATA>-WAERK_CC
                         <L_DATA>-KZWI3_INV
                CHANGING <L_DATA>-KZWI3_INV_CC.
*** lme002 * begin ***
        <L_DATA>-KZWI3_INV_LOC = <L_DATA>-KZWI3_INV * <L_DATA>-KURRF.
*** lme002 * end ***
*       ORDER ITEM NET VALUE in CC
        PERFORM CONVERT_CURRENCY
                USING    <L_DATA>-WAERK_ORD
                         <L_DATA>-WAERK_CC
                         <L_DATA>-KZWI3_ORD
                CHANGING <L_DATA>-KZWI3_ORD_CC.
*** lme003 * begin ***
        <L_DATA>-KZWI3_ORD_LOC =
              <L_DATA>-KZWI3_ORD * <L_DATA>-KURSK.
*** lme003 * end ***
*       Unit price
        PERFORM CONVERT_CURRENCY
                USING    <L_DATA>-ZUNITPRCURR
                         <L_DATA>-WAERK_CC
                         <L_DATA>-ZUNITPR
                CHANGING <L_DATA>-ZUNITPR_CC.
*       ORDER ON HAND VALUE
        PERFORM CONVERT_CURRENCY
                USING    <L_DATA>-WAERK_ORD
                         <L_DATA>-WAERK_CC
                         <L_DATA>-KZWI3_OH
                CHANGING <L_DATA>-KZWI3_OH_CC.
      ENDLOOP.
    ENDIF.                                                  "js-001
  ENDIF.                                                    "js-002

ENDFORM.                    " PROCESS_DATA

*--------------------------------------------------------------------*
*   Form  CONVERT_CURRENCY                                           *
*--------------------------------------------------------------------*
FORM CONVERT_CURRENCY USING PI_CURR_FROM
                              PI_CURR_TO
                              PI_AMMOUNT
                        CHANGING PE_AMMOUNT.

  IF PI_CURR_FROM = PI_CURR_TO
        OR PI_AMMOUNT = 0
        OR PI_AMMOUNT IS INITIAL.
    PE_AMMOUNT = PI_AMMOUNT.
  ELSE.
    CALL FUNCTION 'CONVERT_TO_LOCAL_CURRENCY'
      EXPORTING
        DATE             = P_DAT_CC
        FOREIGN_AMOUNT   = PI_AMMOUNT
        FOREIGN_CURRENCY = PI_CURR_FROM
        LOCAL_CURRENCY   = PI_CURR_TO
        TYPE_OF_RATE     = P_KURST
      IMPORTING
        LOCAL_AMOUNT     = PE_AMMOUNT.

*      CALL FUNCTION 'READ_EXCHANGE_RATE'
*        EXPORTING
*          date             = p_dat_cc
*          foreign_currency = str_data-waerk_ord
*          local_currency   = str_data-waerk_cc
*          type_of_rate     = p_kurst
*        IMPORTING
*          exchange_rate    = lv_ukurs
*        EXCEPTIONS
*          no_rate_found    = 1
*          no_factors_found = 2
*          no_spread_found  = 3
*          derived_2_times  = 4
*          overflow         = 5
*          zero_rate        = 6
*          OTHERS           = 7.
*      IF sy-subrc = 0.
*        str_data-kzwi3_ord_cc = str_data-kzwi3_ord * lv_ukurs.

  ENDIF.

ENDFORM.                    "convert_currency

*--------------------------------------------------------------------*
*   Form  DISPLAY_DATA                                               *
*--------------------------------------------------------------------*
FORM DISPLAY_DATA.

  PERFORM FILL_FIELD_CATALOG.
  PERFORM PREPARE_SORT.
  PERFORM CHANGE_CATALOG.
  PERFORM ALV_OUTPUT.

ENDFORM.                    " DISPLAY_DATA

**********************************************************************
* SUBROUTINES  LEVEL 02                                              *
**********************************************************************

*--------------------------------------------------------------------*
*   Form  GET_SALESREP                                               *
*--------------------------------------------------------------------*
FORM GET_SALESREP USING PARTNERFUNCTION
                  CHANGING PFUNCTION PNUMBER PNAME.

  CLEAR: PFUNCTION.
  CLEAR: PNUMBER.
  CLEAR: PNAME.

  CLEAR: IT_VBPA4.
  " hashed table!
  READ TABLE IT_VBPA4 WITH KEY VBELN = IT_VBAP-VBELN
                               POSNR = IT_VBAP-POSNR
                               PARVW = PARTNERFUNCTION.
  IF SY-SUBRC NE 0.
    " hashed table!
    READ TABLE IT_VBPA4 WITH KEY VBELN = IT_VBAP-VBELN
                                 POSNR = C_POSNR_INIT
                                 PARVW = PARTNERFUNCTION.
    IF SY-SUBRC NE 0.
      CLEAR IT_VBPA4.
    ENDIF.
  ENDIF.
  PFUNCTION = PARTNERFUNCTION.
  PNUMBER   = IT_VBPA4-PERNR.

* Begin of change gru001

*  CALL FUNCTION 'CATS_GET_EMPLOYEE_NAME'
*    EXPORTING
*      pernr           = pnumber
**     date            = sy-datum
*    IMPORTING
*      name            = pname
*    EXCEPTIONS
*      pernr_not_found = 1
*      OTHERS          = 2.
*  IF sy-subrc <> 0.
*    CLEAR pname.
*  ENDIF.

  SELECT SINGLE ENAME INTO PNAME FROM PA0001
         WHERE PERNR = PNUMBER
         AND ENDDA = '99991231'.

  IF SY-SUBRC <> 0.
    CLEAR PNAME.
  ENDIF.


* End of change gru001

ENDFORM.                    " GET_SALESREP

*--------------------------------------------------------------------*
*   Form  GET_ORDER_DATA                                             *
*--------------------------------------------------------------------*
FORM GET_ORDER_DATA.

  DATA LV_DD07 TYPE XTYP_DD07.


  STR_DATA-VKORG       = IT_VBAK-VKORG.
  STR_DATA-VTWEG       = IT_VBAK-VTWEG.
  STR_DATA-SPART       = IT_VBAK-SPART.
  STR_DATA-VKBUR       = IT_VBAK-VKBUR.
  STR_DATA-VKBUR_TXT   = IT_TVKBT-BEZEI.
  STR_DATA-VKGRP       = IT_VBAK-VKGRP.
  STR_DATA-VKGRP_TXT   = IT_TVGRT-BEZEI.
*** change gru001
*  str_data-vdatu       = it_vbak-vdatu.
  STR_DATA-VDATU       = IT_VBEPR-EDATU.
*** end gru001
  STR_DATA-EDATU       = IT_VBEP-EDATU.
  STR_DATA-ERDAT_ORD   = IT_VBAK-ERDAT.
  STR_DATA-ERNAM       = IT_VBAK-ERNAM.
  STR_DATA-AUART       = IT_VBAK-AUART.
  STR_DATA-BNDDT       = IT_VBAK-BNDDT.
  STR_DATA-ERDAT       = IT_VBAP-ERDAT.
  STR_DATA-WERKS       = IT_VBAP-WERKS.
  STR_DATA-MATNR       = IT_VBAP-MATNR.
  STR_DATA-MATKL       = IT_VBAP-MATKL.                     "20080414
  STR_DATA-PSTYV       = IT_VBAP-PSTYV.
  STR_DATA-ABGRU       = IT_VBAP-ABGRU.
  STR_DATA-FAKSK       = IT_VBAK-FAKSK.
  STR_DATA-LIFSK       = IT_VBAK-LIFSK.
  STR_DATA-VBELN_ORD   = IT_VBAK-VBELN.
  STR_DATA-POSNR_ORD   = IT_VBAP-POSNR.
  STR_DATA-SPARTD      = IT_VBAP-SPART.
*  str_data-kzwi3_ord   = it_vbap-kzwi3.              "20090402 Uzzawal
  STR_DATA-WAERK_ORD   = IT_VBAP-WAERK.
  STR_DATA-ZUNITPRCURR = IT_VBAP-WAERK.
  STR_DATA-CMGST = IT_VBUK1-CMGST.                  " credit check.

* Begin of Change EXTUVE   2009/04/02
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      CURRENCY       = STR_DATA-WAERK_ORD
    IMPORTING
      DECIMAL_PLACES = W_DECIMAL_PLACE.

  CASE W_DECIMAL_PLACE.
    WHEN 2.
      STR_DATA-KZWI3_ORD   = IT_VBAP-KZWI3.
    WHEN 0.
      STR_DATA-KZWI3_ORD   = IT_VBAP-KZWI3 * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE     2009/04/02


  READ TABLE XT_DD07 INTO LV_DD07
        WITH KEY DOMNAME    = 'CMGST'
                 DDLANGUAGE = 'E'
                 DOMVALUE_L = IT_VBUK1-CMGST.
  IF SY-SUBRC = 0.
    STR_DATA-CMGSTT = LV_DD07-DDTEXT.                  " credit check.
  ENDIF.

* Modification part 1 for issue 1952 point 8
  IF IT_VBAK-VBTYP = C_VBTYP_K OR IT_VBAK-VBTYP = C_VBTYP_L.
    STR_DATA-KWMENG      = IT_VBAP-ZMENG.
  ELSE.
    STR_DATA-KWMENG      = IT_VBAP-KWMENG.
  ENDIF.
* End Mod part 1 for issue 1952 point 8
  STR_DATA-VRKME_ORD   = IT_VBAP-VRKME.

*** js-003 * begin ***
  STR_DATA-BSARK       = IT_VBAK-BSARK.
  STR_DATA-IHREZ       = IT_VBAK-IHREZ.
*** js-003 * end ***
*** lme001 * begin ***
  STR_DATA-XBLNR       = IT_VBAK-XBLNR.
*** lme001 * end ***

ENDFORM.                    " GET_ORDER_DATA

*--------------------------------------------------------------------*
*   Form  GET_ORDERSTATUS_DATA                                       *
*--------------------------------------------------------------------*
FORM GET_ORDERSTATUS_DATA.

* Get status text of LFSTA
  STR_DATA-LFSTA = IT_VBUP-LFSTA.                           "js-001
  PERFORM GET_STATUS USING 'VBUP' 'LFSTA' IT_VBUP-LFSTA
                     CHANGING STR_DATA-LFSTA_TXT.

* Get status text of FKSAK
  STR_DATA-FKSAK = IT_VBUK1-FKSAK.                          "js-001
  PERFORM GET_STATUS USING 'VBUK' 'FKSAK' IT_VBUK1-FKSAK
                     CHANGING STR_DATA-FKSAK_TXT.

* Get status text of GBSTK
  STR_DATA-GBSTK = IT_VBUK1-GBSTK.                          "js-001
  PERFORM GET_STATUS USING 'VBUK' 'GBSTK' IT_VBUK1-GBSTK
                     CHANGING STR_DATA-GBSTK_TXT.

* Get status text of GBSTA
  STR_DATA-GBSTA = IT_VBUP-GBSTA.                           "js-001
  PERFORM GET_STATUS USING 'VBUP' 'GBSTA' IT_VBUP-GBSTA
                     CHANGING STR_DATA-GBSTA_TXT.

ENDFORM.                    " GET_ORDERSTATUS_DATA

*--------------------------------------------------------------------*
*   Form  GET_ORDER_BUSINESS_DATA                                    *
*--------------------------------------------------------------------*
FORM GET_ORDER_BUSINESS_DATA.

  STR_DATA-BSTKD = IT_VBKD-BSTKD.  " TVO insert
  STR_DATA-BZIRK = IT_VBKD-BZIRK.
  STR_DATA-ZTERM = IT_VBKD-ZTERM.                           "jus-001
  STR_DATA-KURSK = IT_VBKD-KURSK.                           "lme003

ENDFORM.                    "get_order_business_data

*--------------------------------------------------------------------*
*   Form  GET_MATERIAL_DATA                                          *
*--------------------------------------------------------------------*
FORM GET_MATERIAL_DATA.

*  str_data-maktx = it_makt-maktx.  "extuve
*   Material description
  READ TABLE IT_MAKT WITH KEY MATNR = STR_DATA-MATNR.
  IF SY-SUBRC = 0.
    STR_DATA-MAKTX = IT_MAKT-ARKTX.
  ENDIF.
  STR_DATA-MTPOS = IT_MVKE-MTPOS.
*** js-001 * begin ***
  STR_DATA-MSTAV = IT_MARA-MSTAV.
  STR_DATA-MMSTA = IT_MARC-MMSTA.
  STR_DATA-KZAUS = IT_MARC-KZAUS.
*** js-001 * end ***

ENDFORM.                    " GET_MATERIAL_DATA

*--------------------------------------------------------------------*
*   Form  GET_ATLASCOPCO_DATA                                        *
*--------------------------------------------------------------------*
FORM GET_ATLASCOPCO_DATA.

* str_data-prctr = it_acct-prctr.
  STR_DATA-PRCTR = IT_CE41000-PRCTR.
* str_data-ww002 = it_acct-ww002.
  STR_DATA-WW002 = IT_CE41000-WW002.
* str_data-ww006 = it_acct-ww006.
  STR_DATA-WW006 = IT_CE41000-WW006.
* str_data-ww007 = it_acct-ww007.
  STR_DATA-WW007 = IT_CE41000-WW007.
*** js-001 * begin ***
  STR_DATA-COUNTRY = IT_CE41000-WW009.
  STR_DATA-KTGRD   = IT_CE41000-KTGRD.
*** js-001 * end ***

ENDFORM.                    " GET_ATLASCOPCO_DATA

*--------------------------------------------------------------------*
*   Form  GET_CONDITIONS_DATA                                        *
*--------------------------------------------------------------------*
FORM GET_CONDITIONS_DATA.

*  str_data-kwert_zpro = xv_konv1-kwert.
  STR_DATA-WAERK_ZPRO = IT_VBAP-WAERK.
*  str_data-kwert_zprs = xv_konv2-kwert.
  STR_DATA-WAERK_ZPRS = IT_VBAP-WAERK.
* Begin of Change EXTUVE   2010/04/20
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      CURRENCY       = STR_DATA-WAERK_ZPRO
    IMPORTING
      DECIMAL_PLACES = W_DECIMAL_PLACE.

  CASE W_DECIMAL_PLACE.
    WHEN 2.
      STR_DATA-KWERT_ZPRO = XV_KONV1-KWERT.
    WHEN 0.
      STR_DATA-KWERT_ZPRO = XV_KONV1-KWERT * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE  2010/04/20
* Begin of Change EXTUVE   2010/04/20
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      CURRENCY       = STR_DATA-WAERK_ZPRS
    IMPORTING
      DECIMAL_PLACES = W_DECIMAL_PLACE.

  CASE W_DECIMAL_PLACE.
    WHEN 2.
      STR_DATA-KWERT_ZPRS  = XV_KONV2-KWERT.
    WHEN 0.
      STR_DATA-KWERT_ZPRS  = XV_KONV2-KWERT * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE  2010/04/20

*** js-002 * begin ***
  STR_DATA-ZFREIGHT_HDR = XV_KONVF-KBETR.
  STR_DATA-ZFR_HDR_CC   = IT_VBAK-WAERK.
  STR_DATA-ZFREIGHT_ITM = XV_KONVF-KWERT.
  STR_DATA-ZFR_ITM_CC   = IT_VBAP-WAERK.
*** js-002 * end ***

ENDFORM.                    " GET_CONDITIONS_DATA

*--------------------------------------------------------------------*
*   Form  GET_SOLDTO_DATA                                            *
*--------------------------------------------------------------------*
FORM GET_SOLDTO_DATA.

  DATA: LV_ADRC TYPE ADRC,
        LV_KDGRP TYPE XTYP_KDGRP.


  STR_DATA-KUNAG    = IT_VBPA1-KUNNR.
  STR_DATA-KDGRP_AG = IT_VBPA1-KDGRP.

* get customer group
  IF NOT STR_DATA-KUNAG IS INITIAL.
    READ TABLE XT_KDGRP INTO LV_KDGRP
            WITH KEY KDGRP = IT_VBPA1-KDGRP
                     SPRAS = SY-LANGU.
    IF SY-SUBRC <> 0 AND SY-LANGU <> 'E'.
      READ TABLE XT_KDGRP INTO LV_KDGRP
              WITH KEY KDGRP = IT_VBPA1-KDGRP
                       SPRAS = 'E'.
    ENDIF.
    STR_DATA-KDGRPT_AG    = LV_KDGRP-KTEXT.
  ENDIF.

*  str_data-name1_ag = it_kna1_ag-name1. "in comment air22296 13/3
  STR_DATA-BRAN1    = XV_KNA1_AG-BRAN1.
*DIPS NAIK
*  str_data-spname2  = it_kna1_ag-name2."in comment air22296 13/3
*END OF DIPS NAIK

  IF NOT IT_VBPA1-ADRNR IS INITIAL.
    IF XV_ADRC-ADDRNUMBER NE IT_VBPA1-ADRNR.
      READ TABLE XT_ADRC INTO LV_ADRC
*           WITH KEY addrnumber = it_vbpa1-adrnr            "js-005
           WITH TABLE KEY ADDRNUMBER = IT_VBPA1-ADRNR.      "js-005
*           BINARY SEARCH.                                  "js-005
    ELSE.
      LV_ADRC = XV_ADRC.
    ENDIF.

    IF LV_ADRC-ADDRNUMBER EQ IT_VBPA1-ADRNR.
*      CONCATENATE it_adrc-street
*                  it_adrc-house_num1
*                  it_adrc-post_code1
*                  it_adrc-city1
*                  INTO str_data-addr_ag SEPARATED BY space.
      STR_DATA-NAME1_AG = LV_ADRC-NAME1.        "air22296 13/3
      STR_DATA-SPNAME2  = LV_ADRC-NAME2.        "air22296 13/3
      STR_DATA-SPNAME3  = LV_ADRC-NAME3.                    "20880327
      STR_DATA-SPNAME4  = LV_ADRC-NAME4.                    "20880327

      STR_DATA-REGION_AG = LV_ADRC-REGION.
      STR_DATA-CITY1_AG  = LV_ADRC-CITY1.
      STR_DATA-POST_CODE1_AG = LV_ADRC-POST_CODE1.
    ENDIF.
  ENDIF.

ENDFORM.                    " GET_SOLDTO_DATA

*-------------------------------------------------------------------*
*   Form  GET_SHIPTO_DATA                                           *
*-------------------------------------------------------------------*
FORM GET_SHIPTO_DATA USING P_VBPA LIKE LINE OF XT_VBPA2.

  DATA: LV_ADRC TYPE ADRC,
        LV_KNA1 TYPE XTYP_KNA1.


* GET NAICS code for shipment
  IF NOT P_VBPA-KUNNR IS INITIAL.
    STR_DATA-KUNWE    = P_VBPA-KUNNR.
    READ TABLE XT_KNA1 INTO LV_KNA1
          WITH KEY KUNNR = STR_DATA-KUNWE.
    IF SY-SUBRC = 0.
      STR_DATA-SH_NAICS = LV_KNA1-BRAN1.
    ENDIF.
  ENDIF.

*  str_data-name1_we = it_kna1_we-name1. "comment air22296
*DIPS NAIK
*  str_data-shname2  = it_kna1_we-name2. "comment air22296
*END OF DIPS NAIK

  IF NOT P_VBPA-ADRNR IS INITIAL.
    IF XV_ADRC-ADDRNUMBER NE P_VBPA-ADRNR.
      READ TABLE XT_ADRC INTO LV_ADRC
*           WITH KEY addrnumber = p_vbpa-adrnr              "js-005
           WITH TABLE KEY ADDRNUMBER = P_VBPA-ADRNR.        "js-005
*           BINARY SEARCH.                                  "js-005
    ELSE.
      LV_ADRC = XV_ADRC.
    ENDIF.

    IF LV_ADRC-ADDRNUMBER EQ P_VBPA-ADRNR.
*      CONCATENATE it_adrc-street
*                  it_adrc-house_num1
*                  it_adrc-post_code1
*                  it_adrc-city1
*                  INTO str_data-addr_we SEPARATED BY space.
      STR_DATA-NAME1_WE = LV_ADRC-NAME1. "air22296 13/3
      STR_DATA-SHNAME2 = LV_ADRC-NAME2. "air22296 13/3
      STR_DATA-SHNAME3 = LV_ADRC-NAME3.                     "20080327
      STR_DATA-SHNAME4 = LV_ADRC-NAME4.                     "20080327
      STR_DATA-STREET  = LV_ADRC-STREET.      "MOD-001
      STR_DATA-REGION_WE = LV_ADRC-REGION.
      STR_DATA-CITY1_WE  = LV_ADRC-CITY1.
      STR_DATA-POST_CODE1_WE = LV_ADRC-POST_CODE1.
      IF STR_DATA-COUNTRY IS INITIAL.                       "js-001
        STR_DATA-COUNTRY   = LV_ADRC-COUNTRY.
      ENDIF.                                                "js-001
    ENDIF.

  ENDIF.

ENDFORM.                    " GET_SHIPTO_DATA

*--------------------------------------------------------------------*
*   Form  GET_BILLTO_DATA                                            *
*--------------------------------------------------------------------*
FORM GET_BILLTO_DATA USING P_VBPA3 LIKE LINE OF XT_VBPA3.

  STR_DATA-KUNRE    = P_VBPA3-KUNNR.
*  str_data-name1_re = it_kna1_re-name1. "comment air22296
*DIPS NAIK
*  str_data-bpname2  = it_kna1_re-name2."comment air22296
*DIPS NAIK
  IF NOT P_VBPA3-ADRNR IS INITIAL.
    IF XV_ADRC-ADDRNUMBER NE P_VBPA3-ADRNR.
      READ TABLE XT_ADRC INTO XV_ADRC
*           WITH KEY addrnumber = p_vbpa3-adrnr             "js-005
           WITH TABLE KEY ADDRNUMBER = P_VBPA3-ADRNR.       "js-005
*           BINARY SEARCH.                                  "js-005
      IF SY-SUBRC NE 0.
        CLEAR XV_ADRC.
      ENDIF.
    ENDIF.
    STR_DATA-NAME1_RE = XV_ADRC-NAME1.         "air22296 13/3
    STR_DATA-BPNAME2  = XV_ADRC-NAME2.         "air22296 13/3
    STR_DATA-BPNAME3  = XV_ADRC-NAME3.                      "20080327
    STR_DATA-BPNAME4  = XV_ADRC-NAME4.                      "20080327
  ENDIF.

ENDFORM.                    " GET_BILLTO_DATA

*--------------------------------------------------------------------*
*   Form  GET_HLEVEL_CUST_DATA                                       *
*--------------------------------------------------------------------*
FORM GET_HLEVEL_CUST_DATA.

  STR_DATA-HKUNNR   = IT_KNVH-HKUNNR.
  STR_DATA-NAME1_HL = IT_KNA1_HL-NAME1.
  STR_DATA-NAME3_HL = XV_ADRC_ENDCUSTOMER-NAME3.            "20080327
  STR_DATA-NAME4_HL = XV_ADRC_ENDCUSTOMER-NAME4.            "20080327

ENDFORM.                    " GET_HLEVEL_CUST_DATA

*--------------------------------------------------------------------*
*   Form  GET_PURCHASE_DATA                                          *
*--------------------------------------------------------------------*
FORM GET_PURCHASE_DATA.

  STR_DATA-EBELN      = IT_EKKO-EBELN.
  STR_DATA-EBELP      = IT_EKPO-EBELP.                      "js-001
  STR_DATA-LIFNR      = IT_EKKO-LIFNR.
  STR_DATA-NAME1_VEND = IT_LFA1-NAME1.

ENDFORM.                    " GET_PURCHASE_DATA

*--------------------------------------------------------------------*
*   Form  GET_DELIVERY_DATA                                          *
*--------------------------------------------------------------------*
FORM GET_DELIVERY_DATA.

  STR_DATA-VBELN_DEL  = IT_LIKP-VBELN.
  STR_DATA-POSNR_DEL  = IT_LIPS-POSNR.
  IF     IT_VBAK-VBTYP EQ C_VBTYP_K
      OR IT_VBAK-VBTYP EQ C_VBTYP_L.
    STR_DATA-LFIMG      = 0.
  ELSE.
    STR_DATA-LFIMG      = IT_LIPS-LFIMG.
  ENDIF.
  STR_DATA-VRKME_DEL  = IT_LIPS-VRKME.
  STR_DATA-ZVRKME_DEL = IT_LIPS-VRKME.
  STR_DATA-WADAT_IST  = IT_LIKP-WADAT_IST.

ENDFORM.                    " GET_DELIVERY_DATA

*--------------------------------------------------------------------*
*   Form  GET_DELIVERYSTATUS_DATA                                    *
*--------------------------------------------------------------------*
FORM GET_DELIVERYSTATUS_DATA.

* Get status text of WBSTK
  STR_DATA-WBSTK = IT_VBUK2-WBSTK.                          "js-001
  PERFORM GET_STATUS USING 'VBUK' 'WBSTK' IT_VBUK2-WBSTK
                     CHANGING STR_DATA-WBSTK_TXT.

ENDFORM.                    " GET_DELIVERYSTATUS_DATA

*--------------------------------------------------------------------*
*   Form  GET_INVOICE_DATA                                           *
*--------------------------------------------------------------------*
FORM GET_INVOICE_DATA.

  DATA: LV_DD07 LIKE LINE OF XT_DD07.


  STR_DATA-FKART      = IT_VBRK-FKART.
  STR_DATA-VBELN_INV  = IT_VBRK-VBELN.
  STR_DATA-POSNR_INV  = IT_VBRP-POSNR.
  IF     IT_VBAK-VBTYP EQ C_VBTYP_K
      OR IT_VBAK-VBTYP EQ C_VBTYP_L.
    STR_DATA-FKIMG      = 0.
  ELSE.
    STR_DATA-FKIMG      = IT_VBRP-FKIMG.
  ENDIF.
  STR_DATA-VRKME_INV  = IT_VBRP-VRKME.
*  str_data-kzwi3_inv  = it_vbrp-kzwi3.  " EXTUVE 2009/11/05
  STR_DATA-WAERK_INV  = IT_VBRK-WAERK.
  STR_DATA-FKDAT      = IT_VBRK-FKDAT.
  STR_DATA-ERDAT_INV  = IT_VBRK-ERDAT.
  STR_DATA-ZVRKME_INV = IT_VBRP-VRKME.
  STR_DATA-ZWAERK_INV = IT_VBRK-WAERK.
  STR_DATA-FAREG      = IT_VBRP-FAREG.

* Begin of Change EXTUVE   2009/11/05
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      CURRENCY       = STR_DATA-WAERK_INV
    IMPORTING
      DECIMAL_PLACES = W_DECIMAL_PLACE.

  CASE W_DECIMAL_PLACE.
    WHEN 2.
      STR_DATA-KZWI3_INV   = IT_VBRP-KZWI3.
    WHEN 0.
      STR_DATA-KZWI3_INV   = IT_VBRP-KZWI3 * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE     2009/11/05

  READ TABLE XT_DD07 INTO LV_DD07
        WITH KEY DOMNAME    = 'FAREG'
                 DDLANGUAGE = 'E'
                 DOMVALUE_L = STR_DATA-FAREG.
  IF SY-SUBRC = 0.
    STR_DATA-FAREGT = LV_DD07-DDTEXT.                  " credit check.
  ENDIF.

*** lme002 * begin ***
  STR_DATA-KURRF = IT_VBRK-KURRF.
*** lme002 * end ***

ENDFORM.                    " GET_INVOICE_DATA

*--------------------------------------------------------------------*
*   Form  GET_SALES_REP_DATA                                         *
*--------------------------------------------------------------------*
FORM GET_SALES_REP_DATA.

  STR_DATA-PARVW_VE = X_PARVW_VE.
  STR_DATA-PERNR_VE = X_PERNR_VE.
  STR_DATA-ENAME_VE = X_ENAME_VE.
  STR_DATA-PARVW_ZX = X_PARVW_ZX.
  STR_DATA-PERNR_ZX = X_PERNR_ZX.
  STR_DATA-ENAME_ZX = X_ENAME_ZX.
  STR_DATA-PARVW_ZY = X_PARVW_ZY.
  STR_DATA-PERNR_ZY = X_PERNR_ZY.
  STR_DATA-ENAME_ZY = X_ENAME_ZY.

ENDFORM.                    " GET_SALES_REP_DATA

*--------------------------------------------------------------------*
*   Form  CALCULATE_DATA                                             *
*--------------------------------------------------------------------*
FORM CALCULATE_DATA USING STATUS.

  DATA: BEGIN OF LT_FPLA OCCURS 0,
          FPLNR LIKE FPLT-FPLNR,
*          FPLTR LIKE FPLT-FPLTR,
        END OF LT_FPLA.

  DATA: LV_UKURS LIKE TCURR-UKURS.


* Calculate unit price: net val / quant
  IF NOT STR_DATA-KWMENG IS INITIAL.
    STR_DATA-ZUNITPR = STR_DATA-KZWI3_ORD / STR_DATA-KWMENG.
  ELSE.
    STR_DATA-ZUNITPR = 0.
  ENDIF.
* Calculate profit
  STR_DATA-ZPROFIT   = STR_DATA-KZWI3_ORD - STR_DATA-KWERT_ZPRS.
  STR_DATA-ZPROFCURR = STR_DATA-WAERK_ORD.
* Calculate profic percentage
  IF NOT STR_DATA-KZWI3_ORD IS INITIAL.
    STR_DATA-ZPROFPERC = STR_DATA-ZPROFIT / STR_DATA-KZWI3_ORD * 100.
  ELSE.
    CLEAR STR_DATA-ZPROFPERC.
  ENDIF.

* Calculate open delivery quantity
* if sales order doc category is L or K, don't show quantity
  IF IT_VBAK-VBTYP EQ C_VBTYP_K OR IT_VBAK-VBTYP EQ C_VBTYP_L.
    STR_DATA-ZVRKME_DEL = 0.
  ELSE.
    IF STATUS EQ C_STATUS_DEL OR STATUS EQ C_STATUS_INV1.
      CLEAR: X_LFIMG.
      LOOP AT IT_LIPS2 WHERE VGBEL EQ STR_DATA-VBELN_ORD
                         AND VGPOS EQ STR_DATA-POSNR_ORD.
        X_LFIMG = X_LFIMG + IT_LIPS2-LFIMG.
      ENDLOOP.
      STR_DATA-ZQUANT_DEL = STR_DATA-KWMENG - X_LFIMG.
    ELSE.
      IF IT_VBAK-VBTYP NE C_VBTYP_K AND IT_VBAK-VBTYP NE C_VBTYP_L.
        STR_DATA-ZQUANT_DEL = STR_DATA-KWMENG.
      ENDIF.
    ENDIF.
    IF NOT STR_DATA-ZQUANT_DEL IS INITIAL AND
       STR_DATA-ZVRKME_DEL     IS INITIAL.
      STR_DATA-ZVRKME_DEL = STR_DATA-VRKME_ORD.
    ENDIF.
  ENDIF.

* Calculate open invoice quantity
* if sales order doc category is L or K, don't show quantity
  IF IT_VBAK-VBTYP EQ C_VBTYP_K OR IT_VBAK-VBTYP EQ C_VBTYP_L.
    STR_DATA-ZVRKME_DEL = 0.
  ELSE.
    IF STATUS EQ C_STATUS_INV1 OR STATUS EQ C_STATUS_INV2.
*     Clear the total invoiced quantity
      CLEAR: X_FKIMG.
*     Clear the list of processed billing plan numbers
      CLEAR: LT_FPLA[], LT_FPLA.
*     Loop over linked billing documents which are not ... ?
      LOOP AT IT_VBRP2 WHERE AUBEL EQ STR_DATA-VBELN_ORD
                         AND AUPOS EQ STR_DATA-POSNR_ORD
                         AND NOT FAREG IN R_FAREG.
*       Find billing document header's "billing category" (TVFK-FKTYP)
        IF IT_VBRK2-VBELN NE IT_VBRP2-VBELN.
          READ TABLE IT_VBRK2 WITH KEY VBELN = IT_VBRP2-VBELN
                              BINARY SEARCH.
          IF SY-SUBRC NE 0.
            CLEAR IT_VBRK2.
          ENDIF.
        ENDIF.
        READ TABLE IT_TVFK WITH KEY FKART = IT_VBRK2-FKART.
        IF SY-SUBRC NE 0.
          CLEAR IT_TVFK.
        ENDIF.
*       If billing category not P ~ downpayment request
        IF IT_TVFK-FKTYP NE C_FKTYP_P.
*         Check if billing item's quantity is already counted as result
*         of other billing item coming from the same billing plannumber
          READ TABLE LT_FPLA WITH KEY FPLNR = IT_VBRP2-FPLNR.
          IF SY-SUBRC EQ 0.
            CONTINUE.
          ELSE.
            LT_FPLA-FPLNR = IT_VBRP2-FPLNR.
            APPEND LT_FPLA.
          ENDIF.
*         Take opposite of quantity in case of ...
*         inv cancell. or cr memo
          IF (    IT_VBRK2-VBTYP EQ C_VBTYP_N
               OR IT_VBRK2-VBTYP EQ C_VBTYP_O )
              AND IT_VBAK-VBTYP NE C_VBTYP_K   "not cr/db memo req
              AND IT_VBAK-VBTYP NE C_VBTYP_L
              AND IT_VBAK-VBTYP NE C_VBTYP_H.  "and not returns
            IT_VBRP2-FKIMG = IT_VBRP2-FKIMG * -1.
          ENDIF.
*         Add billing quantity to total billed quantity
          X_FKIMG = X_FKIMG + IT_VBRP2-FKIMG.
        ENDIF.
      ENDLOOP.
*     Open invoice quantity is order quantity - billed quantity
      STR_DATA-ZQUANT_INV = STR_DATA-KWMENG - X_FKIMG.
    ELSE.
      STR_DATA-ZQUANT_INV = STR_DATA-KWMENG.
    ENDIF.
  ENDIF.

* Fill invoice quantity unit if initial
  IF NOT STR_DATA-ZQUANT_INV IS INITIAL AND
     STR_DATA-ZVRKME_INV     IS INITIAL.
    STR_DATA-ZVRKME_INV = STR_DATA-VRKME_ORD.
  ENDIF.

* Calculate open invoice amount
  CATCH SYSTEM-EXCEPTIONS ARITHMETIC_ERRORS = 5.
    STR_DATA-ZAMOUNT = STR_DATA-ZQUANT_INV * STR_DATA-KZWI3_ORD.
  ENDCATCH.
  IF SY-SUBRC EQ 5.
    STR_DATA-ZAMOUNT = 0.
  ENDIF.
* Fill open inv amnt curr if initial
  IF NOT STR_DATA-ZAMOUNT IS INITIAL AND
     STR_DATA-ZWAERK_INV IS INITIAL.
    STR_DATA-ZWAERK_INV = STR_DATA-WAERK_ORD.
  ENDIF.

* Calculate profit / cost for inv
  IF NOT STR_DATA-KWMENG IS INITIAL.
    STR_DATA-KWERT_COS_IN = STR_DATA-KWERT_ZPRS * STR_DATA-FKIMG
                       / STR_DATA-KWMENG .
    STR_DATA-ZPROFIT_IN   = STR_DATA-ZPROFIT * STR_DATA-FKIMG /
                            STR_DATA-KWMENG.
  ELSE.
    STR_DATA-KWERT_COS_IN = 0.
    STR_DATA-ZPROFIT_IN   = 0.
  ENDIF.
  IF NOT STR_DATA-KZWI3_INV IS INITIAL.
    STR_DATA-ZPROFPC_IN  = STR_DATA-ZPROFIT_IN * 100 /
                           STR_DATA-KZWI3_INV.
  ELSE.
    STR_DATA-ZPROFPC_IN  = 0.
  ENDIF.

* Change the sign to show on screen
  IF IT_VBAK-VBTYP EQ C_VBTYP_H OR IT_VBAK-VBTYP EQ C_VBTYP_K.
    STR_DATA-KZWI3_ORD  = STR_DATA-KZWI3_ORD  * -1.
    STR_DATA-KWMENG     = STR_DATA-KWMENG     * -1.
    STR_DATA-ZPROFIT    = STR_DATA-ZPROFIT    * -1.
    STR_DATA-ZPROFPERC  = STR_DATA-ZPROFPERC  * -1.
    STR_DATA-KWERT_ZPRS = STR_DATA-KWERT_ZPRS * -1.
    IF STR_DATA-KWERT_COS_IN GT 0.
      STR_DATA-KWERT_COS_IN =  STR_DATA-KWERT_COS_IN  * -1.
    ENDIF.
  ENDIF.
  IF IT_LIKP-VBTYP EQ C_VBTYP_T.
    STR_DATA-LFIMG      = STR_DATA-LFIMG      * -1.
  ENDIF.
  IF IT_VBRK-VBTYP EQ C_VBTYP_N OR IT_VBRK-VBTYP EQ C_VBTYP_O.
    STR_DATA-FKIMG      = STR_DATA-FKIMG      * -1.
    STR_DATA-KZWI3_INV  = STR_DATA-KZWI3_INV  * -1.
    IF STR_DATA-KWERT_COS_IN GT 0.
      STR_DATA-KWERT_COS_IN =  STR_DATA-KWERT_COS_IN  * -1.
    ENDIF.
  ENDIF.

  IF IT_VBRK-FKTYP EQ C_FKTYP_D AND IT_VBRP-FAREG EQ C_FAREG_4.
    STR_DATA-FKIMG      = STR_DATA-FKIMG      * -1.
    STR_DATA-KZWI3_INV  = STR_DATA-KZWI3_INV  * -1.
  ENDIF.

* LME insert
*** js-005 * begin ***
*  SELECT SINGLE shkzg INTO x_shkzg
*    FROM tvap WHERE pstyv = it_vbap-pstyv.
  CLEAR IT_TVAP.
  READ TABLE IT_TVAP WITH KEY PSTYV = IT_VBAP-PSTYV.
  X_SHKZG = IT_TVAP-SHKZG.
*** js-005 * end ***
  IF IT_VBAK-AUART = 'ZRK' AND X_SHKZG = ' '.
    STR_DATA-KWMENG     = STR_DATA-KWMENG     * -1.
  ENDIF.

*** js-005 * begin ***
*  SELECT SINGLE shkzg INTO x_shkzg
*    FROM tvap WHERE pstyv = it_vbrp-pstyv.
  CLEAR IT_TVAP.
  READ TABLE IT_TVAP WITH KEY PSTYV = IT_VBRP-PSTYV.
  X_SHKZG = IT_TVAP-SHKZG.
*** js-005 * end ***
  IF IT_VBRK-FKART = 'ZG2' AND X_SHKZG = ' '.
    STR_DATA-FKIMG      = STR_DATA-FKIMG      * -1.
  ENDIF.
* LME insert

* MJ insert correction of sign of profit percentage
  IF ( STR_DATA-ZPROFIT > 0 AND STR_DATA-ZPROFPERC < 0 ) OR
    ( STR_DATA-ZPROFIT < 0 AND STR_DATA-ZPROFPERC > 0 ).
    STR_DATA-ZPROFPERC = STR_DATA-ZPROFPERC * -1.
  ENDIF.
* MJ insert

* Calculate to Company Currency
  READ TABLE IT_TVKO WITH KEY STR_DATA-VKORG BINARY SEARCH.
  IF SY-SUBRC EQ 0.
    STR_DATA-WAERK_CC = IT_TVKO-WAERS_CC.

*    PERFORM CONVERT_CURRENCY
*                USING
*                   str_data-waerk_ord  " PI_CURR_FROM =
*                   str_data-waerk_cc  " PI_CURR_TO =
*                   str_data-kzwi3_ord " PI_AMMOUNT =
*                CHANGING
*                   str_data-kzwi3_ord_cc.   " PE_AMMOUNT =  .
*
*    PERFORM CONVERT_CURRENCY
*                USING
*                   str_data-waerk_ord    " PI_CURR_FROM =
*                   str_data-waerk_cc     " PI_CURR_TO =
*                   str_data-zprofit      " PI_AMMOUNT =
*                CHANGING
*                   str_data-zprofit_cc.   " PE_AMMOUNT = .
*
**>>>air22296 insert 7/2
*    PERFORM CONVERT_CURRENCY
*                USING
*                   str_data-waerk_inv    " PI_CURR_FROM =
*                   str_data-waerk_cc     " PI_CURR_TO =
*                   str_data-kzwi3_inv      " PI_AMMOUNT =
*                CHANGING
*                   str_data-kzwi3_inv_cc.   " PE_AMMOUNT = .
**<<<air22296.
  ENDIF.

ENDFORM.                    " CALCULATE_DATA

*------------------------------------------------------------------*
*   Form  SAVE_ALL_DATA                                            *
*------------------------------------------------------------------*
FORM SAVE_ALL_DATA.

** js-001 * begin ***
  IF R3 = 'X'.
*   Open orders
*** js-004 * begin ***
*   ASSO
    IF STR_DATA-AUART = 'ZO03'.
      CHECK STR_DATA-LFSTA NE 'C'.
    ENDIF.
*** js-004 * end ***
    MOVE-CORRESPONDING STR_DATA TO IT_SALES_OPEN.
    APPEND IT_SALES_OPEN.
  ELSE.
** js-001 * end ***
** js-002 * begin ***
    IF R4 = 'X'.
*     Invoiced orders
*** js-004 * begin ***
*     ASSO
      IF STR_DATA-AUART = 'ZO03'.
        CHECK STR_DATA-LFSTA = 'C'.
      ENDIF.
*** js-004 * end ***
      MOVE-CORRESPONDING STR_DATA TO IT_SALES_INV.
      APPEND IT_SALES_INV.
    ELSE.
** js-002 * end ***
      MOVE STR_DATA TO IT_DATA.
      APPEND IT_DATA.
    ENDIF.                                                  "js-001
  ENDIF.                                                    "js-002

ENDFORM.                    " SAVE_ALL_DATA

*------------------------------------------------------------------*
*   Form  RESET_DATA                                               *
*------------------------------------------------------------------*
FORM RESET_DATA.

  CLEAR: STR_DATA.
*** js-001 * begin ***
  IF R3 = 'X'.
*   Open orders
    CLEAR: IT_SALES_OPEN.
  ELSE.
*** js-001 * end ***
*** js-002 * begin ***
    IF R4 = 'X'.
*     Invoiced orders
      CLEAR: IT_SALES_INV.
    ELSE.
*** js-002 * end ***
      CLEAR: IT_DATA.
    ENDIF.                                                  "js-001
  ENDIF.                                                    "js-002

ENDFORM.                    " RESET_DATA

*-------------------------------------------------------------------*
*       Form  FILL_FIELD_CATALOG                                    *
*-------------------------------------------------------------------*
FORM FILL_FIELD_CATALOG.

* Find used dictionary structure in INITIALIZATION!
* YSE_SD_SALES_OU1

  X_REPID = SY-REPID.
  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
       EXPORTING
            I_PROGRAM_NAME         = X_REPID
            I_INTERNAL_TABNAME     = 'IT_DATA'
*           i_structure_name       =
*           i_client_never_display = 'X'
            I_INCLNAME             = X_REPID
*           i_bypassing_buffer     =
*           i_buffer_active        =
       CHANGING
            CT_FIELDCAT            = IT_FIELDCAT
       EXCEPTIONS
            INCONSISTENT_INTERFACE = 1
            PROGRAM_ERROR          = 2
            OTHERS                 = 3.
  IF SY-SUBRC <> 0.
*   message id sy-msgid type sy-msgty number sy-msgno
*           with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " FILL_FIELD_CATALOG

*-------------------------------------------------------------------*
*       Form  PREPARE_SORT                                          *
*-------------------------------------------------------------------*
FORM PREPARE_SORT.

  CLEAR STR_SORT.
* str_sort-spos      = '1'.
* str_sort-fieldname = 'PRCTR'.
* str_sort-up        = 'X'.
* append str_sort to it_sort.

ENDFORM.                    " PREPARE_SORT

*-------------------------------------------------------------------*
*       Form  CHANGE_CATALOG                                        *
*-------------------------------------------------------------------*
FORM CHANGE_CATALOG.

  DATA: LV_STR TYPE STRING.


  CLEAR: LS_FIELDCAT.
  CLEAR: LT_FIELDCAT.
  REFRESH: LT_FIELDCAT.

  SORT XT_DD03L BY FIELDNAME.
  LOOP AT IT_FIELDCAT INTO LS_FIELDCAT.

    READ TABLE XT_DD03L WITH KEY FIELDNAME = LS_FIELDCAT-FIELDNAME
                        BINARY SEARCH.
*    IF xt_dd03l-rollname IS INITIAL.
    PERFORM GET_FIELDNAME USING XT_DD03L-ROLLNAME
                                XT_DD03L-FIELDNAME
                         CHANGING LV_STR.
    PERFORM CHANGE_FIELDCATALOGUE USING LV_STR.
    MODIFY IT_FIELDCAT FROM LS_FIELDCAT.
*    ENDIF.

*    CASE ls_fieldcat-fieldname.
*      WHEN 'ERDAT'.
*        PERFORM change_fieldcatalogue USING TEXT-G17.
*      WHEN 'VKBUR_TXT'.
*        PERFORM change_fieldcatalogue USING text-F05.
*      WHEN 'VKGRP_TXT'.
*        PERFORM change_fieldcatalogue USING text-f07.
*        ls_fieldcat-col_pos = 07.
*      WHEN 'EDATU'.
*        PERFORM change_fieldcatalogue USING text-f14.
*        ls_fieldcat-col_pos = 14.
*      WHEN 'ERDAT_ORD'.
*        PERFORM change_fieldcatalogue USING text-f16.
*        ls_fieldcat-col_pos = 16.
*      WHEN 'NAME1_AG'.
*        PERFORM change_fieldcatalogue USING text-f26.
*        ls_fieldcat-col_pos = 26.
*      WHEN 'ADDR_AG'.
*        PERFORM change_fieldcatalogue USING text-f88.
*        ls_fieldcat-col_pos = 27.
*      WHEN 'NAME1_WE'.
*        PERFORM change_fieldcatalogue USING text-f28.
*        ls_fieldcat-col_pos = 28.
*      WHEN 'ADDR_WE'.
*        PERFORM change_fieldcatalogue USING text-f29.
*        ls_fieldcat-col_pos = 29.
*      WHEN 'KUNRE'.
*        PERFORM change_fieldcatalogue USING text-f30.
*        ls_fieldcat-col_pos = 30.
*      WHEN 'NAME1_RE'.
*        PERFORM change_fieldcatalogue USING text-f31.
*        ls_fieldcat-col_pos = 31.
*      WHEN 'HKUNNR'.
*        PERFORM change_fieldcatalogue USING text-f32.
*        ls_fieldcat-col_pos = 32.
*      WHEN 'NAME1_HL'.
*        concatenate text-f33 ' 1.' INTO lv_str.
*        PERFORM change_fieldcatalogue USING lv_str.
*        ls_fieldcat-col_pos = 33.
*      WHEN 'NAME3_HL'.
*        concatenate text-f33 ' 3.' INTO lv_str.
*        PERFORM change_fieldcatalogue USING lv_str.
*        ls_fieldcat-col_pos = 34.
*      WHEN 'NAME4_HL'.
*        concatenate text-f33 ' 4.' INTO lv_str.
*        PERFORM change_fieldcatalogue USING lv_str.
*        ls_fieldcat-col_pos = 35.
*      WHEN 'BRAN1'.
*        PERFORM change_fieldcatalogue USING text-f34.
*        ls_fieldcat-col_pos = 37.
*      WHEN 'LFSTA_TXT'.
*        PERFORM change_fieldcatalogue USING text-f35.
*        ls_fieldcat-col_pos = 38.
*      WHEN 'FKSAK_TXT'.
*        PERFORM change_fieldcatalogue USING text-f36.
*        ls_fieldcat-col_pos = 39.
*      WHEN 'GBSTK_TXT'.
*        PERFORM change_fieldcatalogue USING text-f37.
*        ls_fieldcat-col_pos = 40.
*      WHEN 'GBSTA_TXT'.
*        PERFORM change_fieldcatalogue USING text-f38.
*        ls_fieldcat-col_pos = 41.
*      WHEN 'VBELN_ORD'.
*        ls_fieldcat-col_pos = 44.
*        ls_fieldcat-hotspot = c_flag_on.
*      WHEN 'ENAME_VE'.
*        PERFORM change_fieldcatalogue USING text-f45.
*        ls_fieldcat-col_pos = 45.
*      WHEN 'ENAME_ZX'.
*        PERFORM change_fieldcatalogue USING text-f48.
*        ls_fieldcat-col_pos = 48.
*      WHEN 'ENAME_ZY'.
*        PERFORM change_fieldcatalogue USING text-f51.
*        ls_fieldcat-col_pos = 51.
*      WHEN 'KWERT_ZPRO'.
*        PERFORM change_fieldcatalogue USING text-f52.
*        ls_fieldcat-col_pos = 52.
*      WHEN 'WAERK_ZPRO'.
*        PERFORM change_fieldcatalogue USING text-f53.
*        ls_fieldcat-col_pos = 53.
*      WHEN 'KZWI3_ORD'.
*        PERFORM change_fieldcatalogue USING text-f54.
*        ls_fieldcat-col_pos = 54.
*      WHEN 'KZWI3_CC_ORD'.
*        PERFORM change_fieldcatalogue
*            USING text-f75.
*        ls_fieldcat-col_pos = 60.
*      WHEN 'ZUNITPR'.
*        PERFORM change_fieldcatalogue USING text-f56.
*        ls_fieldcat-col_pos = 61.
*      WHEN 'ZUNITPR_CC'.
*        PERFORM change_fieldcatalogue
*            USING text-f76.
*        ls_fieldcat-col_pos = 62.
*      WHEN 'ZUNITPRCURR'.
*        PERFORM change_fieldcatalogue USING text-f57.
*        ls_fieldcat-col_pos = 63.
*      WHEN 'KWERT_ZPRS'.
*        PERFORM change_fieldcatalogue USING text-f58.
*        ls_fieldcat-col_pos = 64.
*      WHEN 'WAERK_ZPRS'.
*        PERFORM change_fieldcatalogue USING text-f59.
*        ls_fieldcat-col_pos = 65.
*      WHEN 'ZPROFIT'.
*        PERFORM change_fieldcatalogue USING text-f60.
*        ls_fieldcat-col_pos = 70.
*      WHEN 'ZPROFCURR'.
*        PERFORM change_fieldcatalogue USING text-f61.
*        ls_fieldcat-col_pos = 71.
*      WHEN 'ZPROFPERC'.
*        PERFORM change_fieldcatalogue USING text-f62.
*        ls_fieldcat-col_pos = 72.
*      WHEN 'NAME1_VEND'.
*        PERFORM change_fieldcatalogue USING text-f66.
*        ls_fieldcat-col_pos = 76.
*      WHEN 'VBELN_DEL'.
*        ls_fieldcat-col_pos = 77.
*        ls_fieldcat-hotspot = c_flag_on.
*      WHEN 'WBSTK_TXT'.
*        PERFORM change_fieldcatalogue USING text-f69.
*        ls_fieldcat-col_pos = 79.
*      WHEN 'ZQUANT_DEL'.
*        PERFORM change_fieldcatalogue USING text-f72.
*        ls_fieldcat-col_pos = 82.
*      WHEN 'ZWAERK_DEL'.
*        PERFORM change_fieldcatalogue USING text-f73.
*        ls_fieldcat-col_pos = 83.
*      WHEN 'VBELN_INV'.
*        ls_fieldcat-col_pos = 86.
*        ls_fieldcat-hotspot = c_flag_on.
*      WHEN 'KZWI3_INV'.
*        PERFORM change_fieldcatalogue USING text-f80.
*        ls_fieldcat-col_pos = 90.
**>>>insert air22296 on 7/2/8 issue 4108
*      WHEN 'KZWI3_INV_CC'.
*        PERFORM change_fieldcatalogue USING text-f81.
*        ls_fieldcat-col_pos = 91.
**>>> end insert
*      WHEN 'ERDAT_INV'.
*        PERFORM change_fieldcatalogue USING text-f82.
*        ls_fieldcat-col_pos = 92.
*      WHEN 'ZQUANT_INV'.
*        PERFORM change_fieldcatalogue USING text-f84.
*        ls_fieldcat-col_pos = 94.
*      WHEN 'ZVRKME_INV'.
*        PERFORM change_fieldcatalogue USING text-f85.
*        ls_fieldcat-col_pos = 95.
*      WHEN 'ZAMOUNT'.
*        PERFORM change_fieldcatalogue USING text-f86.
*        ls_fieldcat-col_pos = 96.
*      WHEN 'ZWAERK_INV'.
*        PERFORM change_fieldcatalogue USING text-f87.
*        ls_fieldcat-col_pos = 97.
*      WHEN 'SPARTD'.
*        PERFORM change_fieldcatalogue USING text-f89.
*      WHEN 'REGION_WE'.
*        PERFORM change_fieldcatalogue USING text-f90.
*        ls_fieldcat-col_pos = 150.
*      WHEN 'CITY1_WE'.
*        PERFORM change_fieldcatalogue USING text-f91.
*        ls_fieldcat-col_pos = 151.
*      WHEN 'POST_CODE1_WE'.
*        PERFORM change_fieldcatalogue USING text-f92.
*        ls_fieldcat-col_pos = 152.
*      WHEN 'REGION_AG'.
*        PERFORM change_fieldcatalogue USING text-f93.
*        ls_fieldcat-col_pos = 153.
*      WHEN 'CITY1_AG'.
*        PERFORM change_fieldcatalogue USING text-f94.
*        ls_fieldcat-col_pos = 154.
*      WHEN 'POST_CODE1_AG'.
*        PERFORM change_fieldcatalogue USING text-f95.
*        ls_fieldcat-col_pos = 155.
*      WHEN 'ZFPLVAL'.
*        PERFORM change_fieldcatalogue USING text-f96.
*        ls_fieldcat-col_pos = 155.
*      WHEN 'FPROZ'.
*        PERFORM change_fieldcatalogue USING text-f97.
*        ls_fieldcat-col_pos = 155.
*      WHEN 'SPNAME2'.
*        PERFORM change_fieldcatalogue USING text-g11.
*        ls_fieldcat-col_pos = 157.
*      WHEN 'SPNAME3'.
*        PERFORM change_fieldcatalogue USING text-g19.
*        ls_fieldcat-col_pos = 158.
*      WHEN 'SPNAME4'.
*        PERFORM change_fieldcatalogue USING text-g20.
*        ls_fieldcat-col_pos = 159.
*      WHEN 'SHNAME2'.
*        PERFORM change_fieldcatalogue USING text-g12.
*        ls_fieldcat-col_pos = 160.
*      WHEN 'SHNAME3'.
*        PERFORM change_fieldcatalogue USING text-g21.
*        ls_fieldcat-col_pos = 161.
*      WHEN 'SHNAME4'.
*        PERFORM change_fieldcatalogue USING text-g22.
*        ls_fieldcat-col_pos = 162.
*      WHEN 'BPNAME2'.
*        PERFORM change_fieldcatalogue USING text-g13.
*        ls_fieldcat-col_pos = 165.
*      WHEN 'BPNAME3'.
*        PERFORM change_fieldcatalogue USING text-g23.
*        ls_fieldcat-col_pos = 166.
*      WHEN 'BPNAME4'.
*        PERFORM change_fieldcatalogue USING text-g24.
*        ls_fieldcat-col_pos = 167.
*      WHEN 'POSNR_ORD'.
*        PERFORM change_fieldcatalogue USING text-f98.
*      WHEN 'POSNR_DEL'.
*        PERFORM change_fieldcatalogue USING text-f99.
*      WHEN 'POSNR_INV'.
*        PERFORM change_fieldcatalogue USING text-g01.
*      WHEN 'KWMENG_OH'.
*        PERFORM change_fieldcatalogue USING text-g02.
*      WHEN 'KZWI3_OH'.
*        PERFORM change_fieldcatalogue USING text-g03.
*      WHEN 'KZWI3_OH_CC'.
*        PERFORM change_fieldcatalogue USING text-g18.
*      WHEN 'KWERT_COS_OH'.
*        PERFORM change_fieldcatalogue USING text-g04.
*      WHEN 'ZPROFIT_OH'.
*        PERFORM change_fieldcatalogue USING text-g05.
*      WHEN 'ZPROFPC_OH'.
*        PERFORM change_fieldcatalogue USING text-g06.
*      WHEN 'KWERT_COS_IN'.
*        PERFORM change_fieldcatalogue USING text-g07.
*      WHEN 'ZPROFIT_IN'.
*        PERFORM change_fieldcatalogue USING text-g08.
*      WHEN 'ZPROFPC_IN'.
*        PERFORM change_fieldcatalogue USING text-g09.
*      WHEN 'ZUONR'.
*        PERFORM change_fieldcatalogue USING text-g10.
*      WHEN 'KZWI3_ORD_CC'.
*        PERFORM change_fieldcatalogue USING text-g14.
*      WHEN 'ZPROFIT_CC'.
*        PERFORM change_fieldcatalogue USING text-g15.
*      WHEN 'WAERK_CC'.
*        PERFORM change_fieldcatalogue USING text-g16.
*      WHEN 'VKORG'.
*      WHEN 'VTWEG'.
*      WHEN 'SPART'.
*      WHEN 'VKBUR'.
*      WHEN 'VKGRP'.
*      WHEN 'PRCTR'.
*      WHEN 'WW002'.
*      WHEN 'WW006'.
*      WHEN 'WW007'.
*      WHEN 'BSTKD'.
*      WHEN 'BZIRK'.
*      WHEN 'VDATU'.
*      WHEN 'EBELN'.
*      WHEN 'ERNAM'.
*      WHEN 'AUART'.
*      WHEN 'BNDDT'.
*      WHEN 'WERKS'.
*      WHEN 'MATNR'.
*      WHEN 'MAKTX'.
*      WHEN 'PSTYV'.
*      WHEN 'MTPOS'.
*      WHEN 'KUNAG'.
*      WHEN 'KUNWE'.
*      WHEN 'FAKSK'.
*      WHEN 'LIFSK'.
*      WHEN 'PARVW_VE'.
*      WHEN 'PERNR_VE'.
*      WHEN 'PARVW_ZX'.
*      WHEN 'ECNAME1'.
*        PERFORM change_fieldcatalogue USING text-g25.
*      WHEN 'ECNAME2'.
*        PERFORM change_fieldcatalogue USING text-g26.
*      WHEN 'ECNAME3'.
*        PERFORM change_fieldcatalogue USING text-g27.
*      WHEN 'ECNAME4'.
*        PERFORM change_fieldcatalogue USING text-g28.
**      WHEN OTHERS.
**        MESSAGE I000(yse_sales_log)
**            WITH 'BAD FIELDNAME ' ls_fieldcat-fieldname.
**
*    ENDCASE.
*    MODIFY it_fieldcat FROM ls_fieldcat.
  ENDLOOP.

  GS_LAYOUT-COLWIDTH_OPTIMIZE   = 'X'.
  GS_LAYOUT-CONFIRMATION_PROMPT = 'X'.
*  gs_layout-key_hotspot         = 'X'.
  GS_LAYOUT-DETAIL_TITLEBAR     = 'SALES REPORTING'.
*  GS_LAYOUT-COLTAB_FIELDNAME    = 'CELL'.

ENDFORM.                    " CHANGE_CATALOG

*--------------------------------------------------------------------*
*       Form  ALV_OUTPUT                                             *
*--------------------------------------------------------------------*
FORM ALV_OUTPUT.

*  variant-report    = 'YSE_SD_SALES'.
*  variant-variant   = variant.
  GS_SD_ALV_VARIANT = G_VARIANT.

  IF NOT CB_LC IS INITIAL.
    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
      EXPORTING
        I_CALLBACK_PROGRAM      = 'YSE_SD_SALES'
        I_CALLBACK_USER_COMMAND = G_USER_COMMAND
        I_CALLBACK_TOP_OF_PAGE  = 'ALV_TOP'
        I_GRID_TITLE            = 'Sales reporting'
        IS_LAYOUT               = GS_LAYOUT
        IT_FIELDCAT             = IT_FIELDCAT
        IT_SORT                 = IT_SORT
        I_DEFAULT               = 'X'
        I_SAVE                  = 'A'
        IS_VARIANT              = GS_SD_ALV_VARIANT
        I_SCREEN_START_COLUMN   = 0
        I_SCREEN_START_LINE     = 0
        I_SCREEN_END_COLUMN     = 0
        I_SCREEN_END_LINE       = 0
      TABLES
        T_OUTTAB                = IT_DATA
      EXCEPTIONS
        PROGRAM_ERROR           = 1
        OTHERS                  = 2.
    IF SY-SUBRC NE 0.
*      message id sy-msgid type sy-msgty number sy-msgno
*              with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ELSE.
    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
      EXPORTING
        I_CALLBACK_PROGRAM      = 'YSE_SD_SALES'
        I_CALLBACK_USER_COMMAND = G_USER_COMMAND
        I_GRID_TITLE            = 'Sales reporting'
        IS_LAYOUT               = GS_LAYOUT
        IT_FIELDCAT             = IT_FIELDCAT
        IT_SORT                 = IT_SORT
        I_DEFAULT               = 'X'
        I_SAVE                  = 'A'
        IS_VARIANT              = GS_SD_ALV_VARIANT
        I_SCREEN_START_COLUMN   = 0
        I_SCREEN_START_LINE     = 0
        I_SCREEN_END_COLUMN     = 0
        I_SCREEN_END_LINE       = 0
      TABLES
        T_OUTTAB                = IT_DATA
      EXCEPTIONS
        PROGRAM_ERROR           = 1
        OTHERS                  = 2.
    IF SY-SUBRC NE 0.
*      message id sy-msgid type sy-msgty number sy-msgno
*              with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ENDIF.

ENDFORM.                    " ALV_OUTPUT

**********************************************************************
* SUBROUTINES  LEVEL 03                                              *
**********************************************************************

*--------------------------------------------------------------------*
*   Form  GET_STATUS                                                 *
*--------------------------------------------------------------------*
FORM GET_STATUS USING TABLE FIELD STATUS
                CHANGING TEXT.

  CLEAR: STR_STATUS,
         TEXT.

  STR_STATUS-SPRAS = SY-LANGU.
  STR_STATUS-TBNAM = TABLE.
  STR_STATUS-FDNAM = FIELD.
  STR_STATUS-STATU = STATUS.

  CALL FUNCTION 'RV_DOCUMENT_STATUS_TEXTS'
    EXPORTING
      TVBST_WA      = STR_STATUS
    IMPORTING
*     returncode    =
      TEXT          = TEXT.

ENDFORM.                    " GET_STATUS

*-------------------------------------------------------------------*
*   Form  CHANGE_FIELDCATALOGUE                                     *
*-------------------------------------------------------------------*
FORM CHANGE_FIELDCATALOGUE USING TITLE.

  LS_FIELDCAT-SELTEXT_S    = TITLE.
  LS_FIELDCAT-SELTEXT_M    = TITLE.
  LS_FIELDCAT-SELTEXT_L    = TITLE.
  LS_FIELDCAT-REPTEXT_DDIC = TITLE.

ENDFORM.                    " CHANGE_FIELDCATALOGUE

*------------------------------------------------------------------*
*   Form  USER_COMMAND                                             *
*------------------------------------------------------------------*
*   --> R_UCOMM                                                    *
*   --> RS_SELFIELD                                                *
*------------------------------------------------------------------*
FORM USER_COMMAND USING UCOMM    LIKE SY-UCOMM
                        SELFIELD TYPE SLIS_SELFIELD.

* Check function code & selection field
* (show corresponding document)
  CASE UCOMM.
    WHEN '&IC1'.
      CASE SELFIELD-FIELDNAME.
        WHEN 'VBELN_ORD'.
          SET PARAMETER ID 'AUN' FIELD SELFIELD-VALUE.
          CALL TRANSACTION 'VA03' AND SKIP FIRST SCREEN.
        WHEN 'VBELN_DEL'.
          SET PARAMETER ID 'VL' FIELD SELFIELD-VALUE.
          CALL TRANSACTION 'VL03N' AND SKIP FIRST SCREEN.
        WHEN 'VBELN_INV'.
          SET PARAMETER ID 'VF' FIELD SELFIELD-VALUE.
          CALL TRANSACTION 'VF03' AND SKIP FIRST SCREEN.
      ENDCASE.
  ENDCASE.

ENDFORM.                    " USER_COMMAND

*&------------------------------------------------------------------*
*&      Form  Check_Authorization
*&------------------------------------------------------------------*
FORM CHECK_AUTHORIZATION .

  LOOP AT S_VKORG.
    LOOP AT S_VTWEG.
      LOOP AT S_SPARTH.
        AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
                        ID     'VKORG' FIELD S_VKORG-LOW
                        ID     'VTWEG' FIELD S_VTWEG-LOW
                        ID     'SPART' FIELD S_SPARTH-LOW
                        ID     'ACTVT' DUMMY.

        IF SY-SUBRC = 4.
*         No authorisation to display data from Sales Organisation
          MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '005'
                                   WITH S_VKORG-LOW S_VTWEG-LOW
                                   S_SPARTH-LOW.
        ELSEIF SY-SUBRC <> 0.
*         Error checking authorization.
          MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
        ENDIF.

      ENDLOOP.
    ENDLOOP.
  ENDLOOP.

ENDFORM.                    " Check_Authorization

*&-------------------------------------------------------------------*
*&      Form  RESTRICT_SO
*&-------------------------------------------------------------------*
FORM RESTRICT_SO .

* Include type pool SSCR (selection screen restriction)
  TYPE-POOLS: SSCR.

  DATA: LS_RESTRICT TYPE SSCR_RESTRICT,
*                      " to define the select options' restrictions
        LS_OPTLIST  TYPE SSCR_OPT_LIST," to define type of restrictions
        LS_ASS      TYPE SSCR_ASS.     " to assign select option(s) to

* Local constants
  CONSTANTS: LC_OBJK1 TYPE STRING VALUE 'OBJK1'.


* Restrict Select options
  LS_OPTLIST-NAME = LC_OBJK1.
  LS_OPTLIST-OPTIONS-EQ = 'X'.
  APPEND LS_OPTLIST TO LS_RESTRICT-OPT_LIST_TAB.

  LS_ASS-OP_MAIN = LC_OBJK1.
  LS_ASS-KIND = 'S'.
  LS_ASS-NAME = 'S_VKORG'.
  LS_ASS-SG_MAIN = 'I'.
  LS_ASS-SG_ADDY = SPACE.
  APPEND LS_ASS TO LS_RESTRICT-ASS_TAB.
  LS_ASS-NAME = 'S_VTWEG'.
  APPEND LS_ASS TO LS_RESTRICT-ASS_TAB.
  LS_ASS-NAME = 'S_SPARTH'.
  APPEND LS_ASS TO LS_RESTRICT-ASS_TAB.

  CALL FUNCTION 'SELECT_OPTIONS_RESTRICT'
    EXPORTING
*      PROGRAM                      =
      RESTRICTION                  = LS_RESTRICT
*      DB                           = ' '
    EXCEPTIONS
      TOO_LATE                     = 1
      REPEATED                     = 2
      SELOPT_WITHOUT_OPTIONS       = 3
      SELOPT_WITHOUT_SIGNS         = 4
      INVALID_SIGN                 = 5
      EMPTY_OPTION_LIST            = 6
      INVALID_KIND                 = 7
      REPEATED_KIND_A              = 8
      OTHERS                       = 9.

  IF SY-SUBRC <> 0.
  ENDIF.

ENDFORM.                    " RESTRICT_SO

*&-------------------------------------------------------------------*
*&      Form  ALV_TOP
*&-------------------------------------------------------------------*
FORM ALV_TOP.

* ALV header declarations
  DATA: T_HEADER      TYPE SLIS_T_LISTHEADER,
        WA_HEADER     TYPE SLIS_LISTHEADER,
*       T_LINE        LIKE WA_HEADER-INFO,
        LD_LINES      TYPE I,
        LD_LINESC(10) TYPE C.


* Nr of records
  DESCRIBE TABLE IT_DATA LINES LD_LINES.
  LD_LINESC = LD_LINES.

  WA_HEADER-TYP  = 'S'.
  WA_HEADER-KEY  = 'Nr of lines:'(101).
  WA_HEADER-INFO = LD_LINESC.
  APPEND WA_HEADER TO T_HEADER.
  CLEAR: WA_HEADER. ", T_LINE.

  CALL FUNCTION 'REUSE_ALV_COMMENTARY_WRITE'
    EXPORTING
      IT_LIST_COMMENTARY = T_HEADER
      I_LOGO             = 'GANESH_LOGO'.

ENDFORM.                    "ALV_TOP

*&-------------------------------------------------------------------*
*&      Form  get_billing_plan_data
*&-------------------------------------------------------------------*
FORM GET_BILLING_PLAN_DATA .

  IF     NOT IT_VBFA2-FPLNR IS INITIAL
     AND NOT IT_VBFA2-FPLTR IS INITIAL.

    IF    IT_VBFA2-FPLNR NE IT_FPLT-FPLNR
       OR IT_VBFA2-FPLTR NE IT_FPLT-FPLTR.
      READ TABLE IT_FPLT WITH KEY FPLNR = IT_VBFA2-FPLNR
                                  FPLTR = IT_VBFA2-FPLTR.
    ELSE.
      SY-SUBRC = 0.
    ENDIF.
    IF SY-SUBRC EQ 0.
      STR_DATA-FPROZ   = IT_FPLT-FPROZ.
      STR_DATA-ZFPLVAL = IT_FPLT-FAKWR.
      STR_DATA-FAKSP = IT_FPLT-FAKSP.
      IF STR_DATA-FPROZ IS INITIAL.
        IF NOT STR_DATA-KZWI3_ORD IS INITIAL.
          STR_DATA-FPROZ = STR_DATA-ZFPLVAL /
                           STR_DATA-KZWI3_ORD * 100.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " get_billing_plan_data

*&-------------------------------------------------------------------*
*&      Form  get_GTS_invoice
*&-------------------------------------------------------------------*
FORM GET_GTS_INVOICE.

  DATA: LV_ZUONR(10) TYPE C.


  IF NOT STR_DATA-VBELN_INV IS INITIAL AND
    NOT STR_DATA-FKDAT IS INITIAL.
    CLEAR BKPF.

*   No join possible for BSEG (pooled tables, bla bla...)
    SELECT SINGLE * FROM BKPF INTO BKPF
           WHERE AWKEY EQ STR_DATA-VBELN_INV
             AND BUKRS EQ IT_VBRK-BUKRS
             AND GJAHR EQ STR_DATA-FKDAT(4).
    IF SY-SUBRC EQ 0.
      STR_DATA-BELNR = BKPF-BELNR.             "20080624 CR####
      SELECT SINGLE ZUONR FROM BSEG INTO STR_DATA-ZUONR
             WHERE BELNR EQ BKPF-BELNR
               AND BUKRS EQ BKPF-BUKRS
               AND GJAHR EQ BKPF-GJAHR
               AND KOART EQ 'D'.
*      IF SY-SUBRC EQ 0.
*        SHIFT STR_DATA-ZUONR LEFT DELETING LEADING ''.
*        WRITE STR_DATA-ZUONR TO LV_ZUONR.
*        CLEAR STR_DATA-ZUONR.
*        SHIFT LV_ZUONR RIGHT DELETING TRAILING ''.
*        OVERLAY LV_ZUONR WITH '0000000000'.
*        MOVE LV_ZUONR TO STR_DATA-ZUONR.
*      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " get_GTS_invoice

*&---------------------------------------------------------------------*
*&      Form  BUILD_TABLE_OPEN_ORDERS            "js-001
*&---------------------------------------------------------------------*
*       Build table with open orders for performance
*----------------------------------------------------------------------*
FORM BUILD_TABLE_OPEN_ORDERS .

  DATA: LV_COUNT(5)    TYPE N.


* Build table
  SORT IT_SALES_OPEN BY VBELN_ORD POSNR_ORD VBELN_DEL POSNR_DEL.

  LOOP AT IT_SALES_OPEN INTO GV_SALES_OPEN.
    MODIFY YSE_SD_SALES_OPN FROM GV_SALES_OPEN.

    LV_COUNT = LV_COUNT + 1.
    IF LV_COUNT > 99.
      COMMIT WORK.
      CLEAR LV_COUNT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " BUILD_TABLE_OPEN_ORDERS

*&---------------------------------------------------------------------*
*&      Form  SELECT_OPEN_ORDERS_TABLE           "js-001
*&---------------------------------------------------------------------*
*       Select open orders from table (for performance)
*----------------------------------------------------------------------*
FORM SELECT_OPEN_ORDERS_TABLE .

  REFRESH IT_DATA.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE IT_DATA
           FROM YSE_SD_SALES_OPN
           WHERE VBELN_ORD IN S_VBELN
             AND POSNR_ORD IN S_POSNR
             AND VKORG     IN S_VKORG
             AND VTWEG     IN S_VTWEG
             AND SPART     IN S_SPARTH
             AND SPARTD    IN S_SPARTD
             AND VKBUR     IN S_VKBUR
             AND VKGRP     IN S_VKGRP
             AND PRCTR     IN S_PRCTR
             AND WW002     IN S_WW002
             AND WW006     IN S_WW006
             AND WW007     IN S_WW007
             AND CMGST     IN S_CMGST
             AND BZIRK     IN S_BZIRK
             AND VDATU     IN S_VDATU
             AND EDATU     IN S_EDATU
             AND EBELN     IN S_EBELN
             AND ERDAT_ORD IN S_ERDAT1
             AND ERNAM     IN S_ERNAM
             AND AUART     IN S_AUART
             AND WERKS     IN S_WERKS
             AND MATNR     IN S_MATNR
             AND PSTYV     IN S_PSTYV
             AND MTPOS     IN S_MTPOS
             AND KUNAG     IN S_KUNAG
             AND KUNWE     IN S_KUNWE
             AND KUNRE     IN S_KUNRE
             AND HKUNNR    IN S_HKUNNR
             AND BRAN1     IN S_BRAN1
             AND FAKSK     IN S_FAKSK
             AND LIFSK     IN S_LIFSK
             AND ERDAT     IN S_ERDAT3
             AND PERNR_VE  IN S_PERNR
             AND PERNR_ZX  IN S_PERNR
             AND PERNR_ZY  IN S_PERNR
             AND FKART     IN S_FKART
             AND ERDAT_INV IN S_ERDAT2
             AND FKDAT     IN S_FKDAT
             AND FAKSP     IN S_FAKSP
             AND ZUONR     IN S_ZUONR
             AND ABGRU     IN S_ABGRU
             AND MSTAV     IN S_MSTAV
             AND MMSTA     IN S_MMSTA
             AND KZAUS     IN S_KZAUS.

  SORT IT_DATA BY VBELN_ORD POSNR_ORD
                  VBELN_DEL POSNR_DEL.

* Only sales orders delivered ?
  IF NOT CB_SEL IS INITIAL.
    DELETE IT_DATA WHERE VBELN_DEL IS INITIAL.
  ENDIF.

* Fill fields (descriptions, names, ...)
  IF NOT IT_DATA[] IS INITIAL.
    PERFORM FILL_FIELDS.
  ENDIF.

*** js-003 * begin ***
* Selection on PO type / Reference (NOT in table yet)
* PO type
  IF NOT S_BSARK[] IS INITIAL.
    DELETE IT_DATA
           WHERE BSARK NOT IN S_BSARK.
  ENDIF.
* Reference
  IF NOT S_IHREZ[] IS INITIAL.
    DELETE IT_DATA
           WHERE IHREZ NOT IN S_IHREZ.
  ENDIF.
*** js-003 * end ***

*** lme001 * begin ***
* Selection on CTP quotation number(NOT in table yet)
  IF NOT S_XBLNR[] IS INITIAL.
    DELETE IT_DATA
           WHERE XBLNR NOT IN S_XBLNR.
  ENDIF.
*** lme001 * end ***

ENDFORM.                    " SELECT_OPEN_ORDERS_TABLE

*&---------------------------------------------------------------------*
*&      Form  FILL_FIELDS                        "js-001
*&---------------------------------------------------------------------*
*       Fill fields (descriptions, names, ...)
*----------------------------------------------------------------------*
FORM FILL_FIELDS .

* Get additional data
  PERFORM GET_ADDITIONAL_DATA.

* Fill data
  LOOP AT IT_DATA.

*   Sales office
    READ TABLE IT_TVKBT
*               WITH KEY vkbur = it_data-vkbur              "js-005
               WITH TABLE KEY SPRAS = SY-LANGU              "js-005
                              VKBUR = IT_DATA-VKBUR.        "js-005
*               BINARY SEARCH.                              "js-005
    IF SY-SUBRC = 0.
      IT_DATA-VKBUR_TXT   = IT_TVKBT-BEZEI.
    ENDIF.
*   Sales group
    READ TABLE IT_TVGRT
*               WITH KEY vkgrp = it_data-vkgrp              "js-005
               WITH TABLE KEY SPRAS = SY-LANGU              "js-005
                              VKGRP = IT_DATA-VKGRP.        "js-005
*               BINARY SEARCH.                              "js-005
    IT_DATA-VKGRP_TXT   = IT_TVGRT-BEZEI.
*   Credit check
    READ TABLE XT_DD07
         WITH KEY DOMNAME    = 'CMGST'
                  DDLANGUAGE = 'E'
                  DOMVALUE_L = IT_DATA-CMGST
       BINARY SEARCH.
    IF SY-SUBRC = 0.
      IT_DATA-CMGSTT = XT_DD07-DDTEXT.
    ENDIF.
*   Rule in billing plan
    READ TABLE XT_DD07
          WITH KEY DOMNAME    = 'FAREG'
                   DDLANGUAGE = 'E'
                   DOMVALUE_L = IT_DATA-FAREG
          BINARY SEARCH.
    IF SY-SUBRC = 0.
      IT_DATA-FAREGT = XT_DD07-DDTEXT.
    ENDIF.
*   Material description
    READ TABLE IT_MAKT WITH KEY MATNR = IT_DATA-MATNR.
    IF SY-SUBRC = 0.
      IT_DATA-MAKTX = IT_MAKT-ARKTX.
    ENDIF.
*   Status text of LFSTA (Delivery status)
    PERFORM GET_STATUS USING 'VBUP' 'LFSTA' IT_DATA-LFSTA
                       CHANGING IT_DATA-LFSTA_TXT.

*   Status text of FKSAK (Billing status)
    PERFORM GET_STATUS USING 'VBUK' 'FKSAK' IT_DATA-FKSAK
                       CHANGING IT_DATA-FKSAK_TXT.

*   Status text of GBSTK (Overall processing status - document)
    PERFORM GET_STATUS USING 'VBUK' 'GBSTK' IT_DATA-GBSTK
                       CHANGING IT_DATA-GBSTK_TXT.

*   Status text of GBSTA (Overall processing status - item)
    PERFORM GET_STATUS USING 'VBUP' 'GBSTA' IT_DATA-GBSTA
                       CHANGING IT_DATA-GBSTA_TXT.

*   Status text of WBSTK (Total goods movement status)
    PERFORM GET_STATUS USING 'VBUK' 'WBSTK' IT_DATA-WBSTK
                       CHANGING IT_DATA-WBSTK_TXT.
*   Customer group
    CLEAR: IT_KDGRP,
           XT_KDGRP.
    IF NOT IT_DATA-KUNAG IS INITIAL.
      READ TABLE IT_KDGRP WITH KEY KUNNR = IT_DATA-KUNAG
                          BINARY SEARCH.
      IT_DATA-KDGRP_AG = IT_KDGRP-KDGRP.
      READ TABLE XT_KDGRP
           WITH KEY KDGRP = IT_DATA-KDGRP_AG
                    SPRAS = SY-LANGU.
      IF SY-SUBRC <> 0 AND SY-LANGU <> 'E'.
        READ TABLE XT_KDGRP
             WITH KEY KDGRP = IT_DATA-KDGRP_AG
                      SPRAS = 'E'.
      ENDIF.
      IF SY-SUBRC = 0.
        IT_DATA-KDGRPT_AG    = XT_KDGRP-KTEXT.
      ENDIF.
    ENDIF.
*   Sold-to
    PERFORM GET_CUSTOMER USING IT_DATA-KUNAG 'AG'.
    IT_DATA-NAME1_AG = XT_ADRC-NAME1.
    IT_DATA-SPNAME2  = XT_ADRC-NAME2.
    IT_DATA-SPNAME3  = XT_ADRC-NAME3.
    IT_DATA-SPNAME4  = XT_ADRC-NAME4.
    IT_DATA-REGION_AG = XT_ADRC-REGION.
    IT_DATA-CITY1_AG  = XT_ADRC-CITY1.
    IT_DATA-POST_CODE1_AG = XT_ADRC-POST_CODE1.
*   Ship-to
    PERFORM GET_CUSTOMER USING IT_DATA-KUNWE 'WE'.
    IT_DATA-NAME1_WE = XT_ADRC-NAME1.
    IT_DATA-SHNAME2 = XT_ADRC-NAME2.
    IT_DATA-SHNAME3 = XT_ADRC-NAME3.
    IT_DATA-SHNAME4 = XT_ADRC-NAME4.
    IT_DATA-STREET  = XT_ADRC-STREET.  "MOD-001
    IT_DATA-REGION_WE = XT_ADRC-REGION.
    IT_DATA-CITY1_WE  = XT_ADRC-CITY1.
    IT_DATA-POST_CODE1_WE = XT_ADRC-POST_CODE1.
*    it_data-country   = xt_adrc-country.
*   Bill-to
    PERFORM GET_CUSTOMER USING IT_DATA-KUNRE 'RE'.
    IT_DATA-NAME1_RE = XT_ADRC-NAME1.
    IT_DATA-BPNAME2  = XT_ADRC-NAME2.
    IT_DATA-BPNAME3  = XT_ADRC-NAME3.
    IT_DATA-BPNAME4  = XT_ADRC-NAME4.
*   HLEVEL customer
    IF NOT IT_DATA-HKUNNR IS INITIAL.
      PERFORM GET_CUSTOMER USING IT_DATA-HKUNNR '  '.
      IT_DATA-NAME1_HL = IT_ADR-NAME1.
      IT_DATA-NAME3_HL = XT_ADRC-NAME3.
      IT_DATA-NAME4_HL = XT_ADRC-NAME4.
    ENDIF.
*   End customer
    IF NOT IT_DATA-ECCUSTN IS INITIAL.
      PERFORM GET_CUSTOMER USING IT_DATA-ECCUSTN 'ZE'.
      IT_DATA-ECNAME1 = XT_ADRC-NAME1.
      IT_DATA-ECNAME2 = XT_ADRC-NAME2.
      IT_DATA-ECNAME3 = XT_ADRC-NAME3.
      IT_DATA-ECNAME4 = XT_ADRC-NAME4.
      IT_DATA-ECCITY  = XT_ADRC-CITY1.
      IT_DATA-ECREGIO = XT_ADRC-REGION.
      IT_DATA-SORT1   = XT_ADRC-SORT1.
*     Additional EC data
      CLEAR: IT_VBPA_CUST,
             IT_END_CUST_DISTRICT,
             IT_END_CUST_REP.
      READ TABLE IT_VBPA_CUST
           WITH KEY VBELN = IT_DATA-VBELN_ORD
                    POSNR = IT_DATA-POSNR_ORD
           BINARY SEARCH.
      IF SY-SUBRC NE 0.
        READ TABLE IT_VBPA_CUST
             WITH KEY VBELN = IT_DATA-VBELN_ORD
             BINARY SEARCH.
      ENDIF.
*     End customer district
      READ TABLE IT_END_CUST_DISTRICT
           WITH KEY ECCUSTN = IT_VBPA_CUST-KUNNR
                    VKORG   = IT_DATA-VKORG
                    VTWEG   = IT_DATA-VTWEG
                    SPART   = IT_DATA-SPART
           BINARY SEARCH.
      IT_DATA-ECDISCT = IT_END_CUST_DISTRICT-ECDISCT.
*     End customer representative
      READ TABLE IT_END_CUST_REP
           WITH KEY ECCUSTN = IT_VBPA_CUST-KUNNR
                    VKORG   = IT_DATA-VKORG
                    VTWEG   = IT_DATA-VTWEG
                    SPART   = IT_DATA-SPART
           BINARY SEARCH.
      IT_DATA-ECSREP =  IT_END_CUST_REP-ECSREP.
    ENDIF.
    IF NOT IT_DATA-ECHLCUS IS INITIAL.
      PERFORM GET_CUSTOMER USING IT_DATA-ECHLCUS '  '.
      IT_DATA-ECHLCUS_NAM1 = XT_ADRC-NAME1.
    ENDIF.
*   Vendor
    CLEAR: IT_LFA1.
    IF NOT IT_DATA-LIFNR IS INITIAL.
*** js-005 * begin ***
*      READ TABLE it_lfa1 WITH KEY lifnr = it_data-lifnr
*                         BINARY SEARCH.
      READ TABLE IT_LFA1 WITH TABLE KEY LIFNR = IT_DATA-LIFNR.
*** js-005 * end ***
      IF SY-SUBRC = 0.
        IT_DATA-NAME1_VEND = IT_LFA1-NAME1.
      ENDIF.
    ENDIF.
*   Sales rep. (names)
    IF NOT IT_DATA-PERNR_VE IS INITIAL.
      PERFORM GET_SALES_REP_NAME USING IT_DATA-PERNR_VE
                                 CHANGING IT_DATA-ENAME_VE.
    ENDIF.
    IF NOT IT_DATA-PERNR_ZX IS INITIAL.
      PERFORM GET_SALES_REP_NAME USING IT_DATA-PERNR_ZX
                                 CHANGING IT_DATA-ENAME_ZX.
    ENDIF.
    IF NOT IT_DATA-PERNR_ZY IS INITIAL.
      PERFORM GET_SALES_REP_NAME USING IT_DATA-PERNR_ZY
                                 CHANGING IT_DATA-ENAME_ZY.
    ENDIF.

*** js-003 * begin ***
*   PO type / Reference
    READ TABLE IT_VBAK_ACC WITH KEY VBELN = IT_DATA-VBELN_ORD
                           BINARY SEARCH.
    IF SY-SUBRC = 0.
      IT_DATA-BSARK = IT_VBAK_ACC-BSARK.
      IT_DATA-IHREZ = IT_VBAK_ACC-IHREZ.
*** lme001 * begin ***
      IT_DATA-XBLNR = IT_VBAK_ACC-XBLNR.
*** lme001 * end ***
    ENDIF.
*** js-003 * end ***

    MODIFY IT_DATA.

  ENDLOOP.

ENDFORM.                    " FILL_FIELDS

*&---------------------------------------------------------------------*
*&      Form  GET_ADDITIONAL_DATA                "js-001
*&---------------------------------------------------------------------*
*       Get additional data
*----------------------------------------------------------------------*
FORM GET_ADDITIONAL_DATA .

  DATA: LV_TABIX       LIKE SY-TABIX,
        LV_ADDRNUMBER  LIKE ADRC-ADDRNUMBER.

  DATA: LT_PA0001   TYPE TABLE OF XTYP_PA0001.              "js-005


* Sales office
*  SELECT * FROM tvkbt INTO TABLE it_tvkbt                  "js-005
  SELECT * FROM TVKBT INTO TABLE IT_TVKBTI                  "js-005
           FOR ALL ENTRIES IN IT_DATA
           WHERE SPRAS EQ SY-LANGU
             AND VKBUR EQ IT_DATA-VKBUR.
* begin of delete lme004
*  SORT it_tvkbt BY vkbur spras.
* end of delete lme004
*** js-005 * begin ***
*  DELETE ADJACENT DUPLICATES FROM it_tvkbt.
  SORT IT_TVKBTI BY SPRAS VKBUR.
  DELETE ADJACENT DUPLICATES FROM IT_TVKBTI
         COMPARING SPRAS VKBUR.
  IT_TVKBT[] = IT_TVKBTI[].
*** js-005 * begin ***

* Sales group
*  SELECT * FROM tvgrt INTO TABLE it_tvgrt                  "js-005
  SELECT * FROM TVGRT INTO TABLE IT_TVGRTI                  "js-005
           FOR ALL ENTRIES IN IT_DATA
           WHERE SPRAS EQ SY-LANGU
             AND VKGRP EQ IT_DATA-VKGRP.
* begin of delete lme004
*  SORT it_tvgrt BY vkgrp spras.
* end of delete lme004
*** js-005 * begin ***
*  DELETE ADJACENT DUPLICATES FROM it_tvgrt.
  SORT IT_TVGRTI BY SPRAS VKGRP.
  DELETE ADJACENT DUPLICATES FROM IT_TVGRTI
         COMPARING SPRAS VKGRP.
  IT_TVGRT[] = IT_TVGRTI[].
*** js-005 * end ***

* Status
  SELECT DD07L~DOMNAME DD07T~DDLANGUAGE DD07L~DOMVALUE_L
         DD07L~DOMVALUE_H DD07T~DDTEXT
         INTO TABLE XT_DD07
         FROM DD07L
         JOIN DD07T ON DD07T~DOMNAME = DD07L~DOMNAME
                   AND DD07T~AS4LOCAL = DD07L~AS4LOCAL
                   AND DD07T~VALPOS = DD07L~VALPOS
                   AND DD07T~DDLANGUAGE = 'E'
         WHERE DD07L~DOMNAME = 'CMGST' OR DD07L~DOMNAME = 'FAREG'
           AND DD07L~AS4LOCAL = 'A'.
  SORT XT_DD07.

** Material description
*  SELECT * FROM makt INTO TABLE it_makt
*           FOR ALL ENTRIES IN it_data
*           WHERE matnr EQ it_data-matnr
*             AND spras EQ sy-langu.
*  SORT it_makt BY matnr spras.
*  DELETE ADJACENT DUPLICATES FROM it_makt.

* Customer group
  SELECT KUNNR KDGRP INTO TABLE IT_KDGRP
         FROM KNVV
         FOR ALL ENTRIES IN IT_DATA
         WHERE KUNNR = IT_DATA-KUNAG
           AND VKORG = IT_DATA-VKORG
           AND VTWEG = IT_DATA-VTWEG
           AND SPART = IT_DATA-SPART.
  SORT IT_KDGRP.
  DELETE ADJACENT DUPLICATES FROM IT_KDGRP.
  SELECT KDGRP SPRAS KTEXT FROM T151T
         INTO TABLE XT_KDGRP
         FOR ALL ENTRIES IN IT_KDGRP
         WHERE KDGRP = IT_KDGRP-KDGRP
           AND (   SPRAS = 'E'
                OR SPRAS = SY-LANGU ).
  SORT XT_KDGRP.
  DELETE ADJACENT DUPLICATES FROM XT_KDGRP.

* Customer data
  REFRESH XT_ADRC.
  SELECT KUNNR ADRNR NAME1 FROM KNA1
         INTO TABLE IT_ADR
         FOR ALL ENTRIES IN IT_DATA
         WHERE KUNNR = IT_DATA-HKUNNR
            OR KUNNR = IT_DATA-ECHLCUS.
  SORT IT_ADR.
  DELETE ADJACENT DUPLICATES FROM IT_ADR.
  IF NOT IT_ADR[] IS INITIAL.
*    SELECT * FROM adrc INTO TABLE xt_adrc                  "js-005
    SELECT * FROM ADRC INTO TABLE XT_ADRCI                  "js-005
             FOR ALL ENTRIES IN IT_ADR
             WHERE ADDRNUMBER EQ IT_ADR-ADRNR
               AND DATE_FROM  LE SY-DATUM.
  ENDIF.
* Customer data via order (partners)
  CLEAR: R_PARVW.
  REFRESH: R_PARVW.
  R_PARVW-SIGN   = 'I'.
  R_PARVW-OPTION = 'EQ'.
  R_PARVW-LOW    = C_PARVW_AG.  APPEND R_PARVW.
  R_PARVW-LOW    = C_PARVW_RE.  APPEND R_PARVW.
  R_PARVW-LOW    = C_PARVW_WE.  APPEND R_PARVW.
  R_PARVW-LOW    = C_PARVW_ZE.  APPEND R_PARVW.
  SELECT DISTINCT VBPA~VBELN VBPA~POSNR VBPA~PARVW VBPA~KUNNR
                  VBPA~ADRNR
         FROM VBPA
         INTO TABLE XT_VBPA2
         FOR ALL ENTRIES IN IT_DATA
         WHERE VBELN EQ IT_DATA-VBELN_ORD
           AND PARVW IN R_PARVW.
*  SELECT * FROM adrc APPENDING TABLE xt_adrc               "js-005
  SELECT * FROM ADRC APPENDING TABLE XT_ADRCI               "js-005
           FOR ALL ENTRIES IN XT_VBPA2
           WHERE ADDRNUMBER EQ XT_VBPA2-ADRNR
             AND DATE_FROM  LE SY-DATUM.
* Keep only the latest
*  SORT xt_adrc BY addrnumber date_from DESCENDING.         "js-005
  SORT XT_ADRCI BY ADDRNUMBER DATE_FROM DESCENDING.         "js-005
  CLEAR XV_ADRC_ENDCUSTOMER.
*** js-005 * end ***
*  LOOP AT xt_adrc INTO xv_adrc_endcustomer.
*    lv_tabix = sy-tabix.
*    IF lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*      DELETE xt_adrc INDEX lv_tabix.
*    ENDIF.
*    lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*  ENDLOOP.
  DELETE ADJACENT DUPLICATES FROM XT_ADRCI
         COMPARING ADDRNUMBER.
  XT_ADRC[] = XT_ADRCI[].
*** js-005 * end ***

* Customer end data
  REFRESH: IT_VBPA_CUST,
           IT_END_CUST_DISTRICT,
           IT_END_CUST_REP.
  IT_VBPA_CUST[] = XT_VBPA2[].
  DELETE IT_VBPA_CUST[] WHERE PARVW NE 'ZE'.
  SORT IT_VBPA_CUST.
  IF NOT  IT_VBPA_CUST[] IS INITIAL.
*   End customer district
    SELECT KUNNR VKORG VTWEG SPART BZIRK FROM KNVV
           INTO TABLE IT_END_CUST_DISTRICT
           FOR ALL ENTRIES IN IT_VBPA_CUST
           WHERE KUNNR = IT_VBPA_CUST-KUNNR.
    SORT IT_END_CUST_DISTRICT.
*   End customer representative
    SELECT KUNNR VKORG VTWEG SPART PERNR FROM KNVP
           INTO TABLE IT_END_CUST_REP
           FOR ALL ENTRIES IN IT_VBPA_CUST
           WHERE KUNNR = IT_VBPA_CUST-KUNNR
             AND PERNR NE '00000000'.
    SORT IT_END_CUST_REP.
  ENDIF.

* Vendor data
*  SELECT * FROM lfa1 INTO TABLE it_lfa1                    "js-005
  SELECT * FROM LFA1 INTO TABLE IT_LFA1I                    "js-005
           FOR ALL ENTRIES IN IT_DATA
           WHERE LIFNR EQ IT_DATA-LIFNR.
* begin of delete lme004
*  SORT it_lfa1 BY lifnr.
* end of delete lme004
*** js-005 * begin ***
*  DELETE ADJACENT DUPLICATES FROM it_lfa1 COMPARING lifnr.
  SORT IT_LFA1I BY LIFNR.
  DELETE ADJACENT DUPLICATES FROM IT_LFA1I
         COMPARING LIFNR.
  IT_LFA1[] = IT_LFA1I[].
*** js-005 * end ***

*** js-003 * begin ***
* PO type / Reference
*** lme001 * begin ***
* CTP quotation number
* SELECT vbeln bsark ihrez FROM vbak
  SELECT VBELN BSARK IHREZ XBLNR FROM VBAK
*** lme001 * end ***
         INTO TABLE IT_VBAK_ACC
         FOR ALL ENTRIES IN IT_DATA
         WHERE VBELN = IT_DATA-VBELN_ORD.
  SORT IT_VBAK_ACC BY VBELN.
  DELETE ADJACENT DUPLICATES FROM IT_VBAK_ACC COMPARING VBELN.
*** js-003 * end ***

*** js-005 * begin ***
* Get sales rep. names
  SELECT PERNR ENAME INTO TABLE LT_PA0001
         FROM PA0001
         FOR ALL ENTRIES IN IT_DATA
         WHERE PERNR = IT_DATA-PERNR_VE
           AND ENDDA = '99991231'.
  SELECT PERNR ENAME APPENDING TABLE LT_PA0001
         FROM PA0001
         FOR ALL ENTRIES IN IT_DATA
         WHERE PERNR = IT_DATA-PERNR_ZX
           AND ENDDA = '99991231'.
  SELECT PERNR ENAME APPENDING TABLE LT_PA0001
         FROM PA0001
         FOR ALL ENTRIES IN IT_DATA
         WHERE PERNR = IT_DATA-PERNR_ZY
           AND ENDDA = '99991231'.

  SORT LT_PA0001.
  DELETE ADJACENT DUPLICATES FROM LT_PA0001
                             COMPARING PERNR.
  IT_PA0001[] = LT_PA0001[].
*** js-005 * end ***

ENDFORM.                    " GET_ADDITIONAL_DATA

*&---------------------------------------------------------------------*
*&      Form  GET_CUSTOMER                       "js-001
*&---------------------------------------------------------------------*
*       Get customer data
*----------------------------------------------------------------------*
*      -->P_KUNNR : customernumber
*      -->P_PARVW : partnerfunction
*----------------------------------------------------------------------*
FORM GET_CUSTOMER  USING    P_KUNNR  TYPE KUNNR
                            P_PARVW  TYPE PARVW.

  DATA: LV_VBPA2  LIKE LINE OF XT_VBPA2,
        LV_ADRNR  TYPE ADRNR.


  CLEAR: IT_ADR,
         XT_ADRC.

  IF P_PARVW IS INITIAL.
*   Customer data
    READ TABLE IT_ADR WITH KEY KUNNR = P_KUNNR
                      BINARY SEARCH.
    IF SY-SUBRC = 0.
      LV_ADRNR = IT_ADR-ADRNR.
    ENDIF.
  ELSE.
*   Customer data via order (partners)
    READ TABLE XT_VBPA2 INTO LV_VBPA2
                        WITH KEY VBELN = IT_DATA-VBELN_ORD
                                 POSNR = IT_DATA-POSNR_ORD
                                 PARVW = P_PARVW
                                 KUNNR = P_KUNNR.
    IF SY-SUBRC NE 0.
      READ TABLE XT_VBPA2 INTO LV_VBPA2
                          WITH KEY VBELN = IT_DATA-VBELN_ORD
                                   POSNR = C_POSNR_INIT
                                   PARVW = P_PARVW
                                   KUNNR = P_KUNNR.
    ENDIF.
    IF SY-SUBRC = 0.
      LV_ADRNR = LV_VBPA2-ADRNR.
    ENDIF.
  ENDIF.

* Address data
  IF NOT LV_ADRNR IS INITIAL.
    READ TABLE XT_ADRC
*         WITH KEY addrnumber = lv_adrnr                    "js-005
         WITH TABLE KEY ADDRNUMBER = LV_ADRNR.              "js-005
*         BINARY SEARCH.                                    "js-005
  ENDIF.

ENDFORM.                    " GET_CUSTOMER

*&---------------------------------------------------------------------*
*&      Form  GET_SALES_REP_NAME                 "js-001
*&---------------------------------------------------------------------*
*       Get sales rep. (name)
*----------------------------------------------------------------------*
*      -->P_PERNR : sales rep. number
*      <--P_ENAME : name
*----------------------------------------------------------------------*
FORM GET_SALES_REP_NAME  USING    P_PERNR
                         CHANGING P_ENAME.

* Begin of change gru001
*
*  CALL FUNCTION 'CATS_GET_EMPLOYEE_NAME'
*    EXPORTING
*      pernr           = p_pernr
**     date            = sy-datum
*    IMPORTING
*      name            = p_ename
*    EXCEPTIONS
*      pernr_not_found = 1
*      OTHERS          = 2.
*
*  IF sy-subrc <> 0.
*    CLEAR p_ename.
*  ENDIF.

*** js-005 * begin ***
*  SELECT SINGLE ename INTO p_ename FROM pa0001
*    WHERE pernr = p_pernr
*      AND endda = '99991231'.
*  IF sy-subrc <> 0.
*    CLEAR p_ename.
*  ENDIF.

  CLEAR IT_PA0001.
  READ TABLE IT_PA0001 WITH KEY PERNR = P_PERNR.
  P_ENAME = IT_PA0001-ENAME.
*** js-005 * end ***

* End of change gru001

ENDFORM.                    " GET_SALES_REP_NAME

*&---------------------------------------------------------------------*
*&      Form  BUILD_TABLE_INV_ORDERS             "js-002
*&---------------------------------------------------------------------*
*       Build table with invoiced orders for BO reporting
*----------------------------------------------------------------------*
FORM BUILD_TABLE_INV_ORDERS .

  DATA: LV_COUNT(5)    TYPE N.


* Build table
  SORT IT_SALES_INV BY VBELN_ORD POSNR_ORD
                       VBELN_DEL POSNR_DEL
                       VBELN_INV POSNR_INV.

  LOOP AT IT_SALES_INV INTO GV_SALES_INV.
    MODIFY YSE_SD_SALES_INV FROM GV_SALES_INV.

    LV_COUNT = LV_COUNT + 1.
    IF LV_COUNT > 99.
      COMMIT WORK.
      CLEAR LV_COUNT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " BUILD_TABLE_INV_ORDERS

*&---------------------------------------------------------------------*
*&      Form  SELECT_INV_ORDERS_TABLE            "js-002
*&---------------------------------------------------------------------*
*       Select invoiced orders from table (for performance)
*       --> Table is used for BO reporting !
*----------------------------------------------------------------------*
FORM SELECT_INV_ORDERS_TABLE .

  REFRESH IT_DATA.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE IT_DATA
           FROM YSE_SD_SALES_INV
           WHERE VBELN_ORD IN S_VBELN
             AND POSNR_ORD IN S_POSNR
             AND VKORG     IN S_VKORG
             AND VTWEG     IN S_VTWEG
             AND SPART     IN S_SPARTH
             AND SPARTD    IN S_SPARTD
             AND VKBUR     IN S_VKBUR
             AND VKGRP     IN S_VKGRP
             AND PRCTR     IN S_PRCTR
             AND WW002     IN S_WW002
             AND WW006     IN S_WW006
             AND WW007     IN S_WW007
             AND CMGST     IN S_CMGST
             AND BZIRK     IN S_BZIRK
             AND VDATU     IN S_VDATU
             AND EDATU     IN S_EDATU
             AND EBELN     IN S_EBELN
             AND ERDAT_ORD IN S_ERDAT1
             AND ERNAM     IN S_ERNAM
             AND AUART     IN S_AUART
             AND WERKS     IN S_WERKS
             AND MATNR     IN S_MATNR
             AND PSTYV     IN S_PSTYV
             AND MTPOS     IN S_MTPOS
             AND KUNAG     IN S_KUNAG
             AND KUNWE     IN S_KUNWE
             AND KUNRE     IN S_KUNRE
             AND HKUNNR    IN S_HKUNNR
             AND BRAN1     IN S_BRAN1
             AND FAKSK     IN S_FAKSK
             AND LIFSK     IN S_LIFSK
             AND ERDAT     IN S_ERDAT3
             AND PERNR_VE  IN S_PERNR
             AND PERNR_ZX  IN S_PERNR
             AND PERNR_ZY  IN S_PERNR
             AND FKART     IN S_FKART
             AND ERDAT_INV IN S_ERDAT2
             AND FKDAT     IN S_FKDAT
             AND FAKSP     IN S_FAKSP
             AND ZUONR     IN S_ZUONR
             AND ABGRU     IN S_ABGRU
             AND MSTAV     IN S_MSTAV
             AND MMSTA     IN S_MMSTA
             AND KZAUS     IN S_KZAUS.

  SORT IT_DATA BY VBELN_ORD POSNR_ORD
                  VBELN_DEL POSNR_DEL
                  VBELN_INV POSNR_INV.

* Only sales orders delivered ?
  IF NOT CB_SEL IS INITIAL.
    DELETE IT_DATA WHERE VBELN_DEL IS INITIAL.
  ENDIF.

* Fill fields (descriptions, names, ...)
  IF NOT IT_DATA[] IS INITIAL.
    PERFORM FILL_FIELDS.
  ENDIF.

ENDFORM.                    " SELECT_INV_ORDERS_TABLE

*Text symbol text
*001:End Customer Report
*002:customer_report
*003:Error closing the File
*004:File Saved as:
*010:Standard Report
*011:Background Processing for End Customer Details
*012:Please enter custom Filename or leave blank for default
*015:Background Processing : create table with open orders (for performance)
*016:Background Processing : create table with invoiced orders (for BO reporting)
*101:Nr of lines:
*E01:Sales orders not invoiced
*E02:Sales orders invoiced
*E03:Billing type
*E04:Creation date invoice
*E05:Billing date
*E91:Please select sales order invoiced (for table creation)
*E92:Please enter Division (header level)
*E93:Please enter Distribution Channel
*E94:Please enter Sales Organization
*E95:Please select sales order not invoiced (for table creation)
*E96:Please enter a selection for Creation date SO line
*E97:Please enter a selection for Creation date invoice
*E98:Period Creation date invoice can not be > 3 months
*E99:Period Creation date SO line can not be > 3 months
*F05:Sales office description
*F07:Sales group description
*F14:SO: Conf.del.date
*F16:SO: creation date
*F26:Sold-To name
*F28:Ship-To name
*F29:Ship-To address
*F30:Bill-To party
*F31:Bill-To name
*F32:Higher level cust
*F33:Higher level cust. name
*F34:NAICS/SIC Code
*F35:SO: Delivery status
*F36:SO: Ord.rel.billing status
*F37:SO: Overall status (header)
*F38:SO: Overall status (item)
*F39:Sales order
*F45:Sales employee VE
*F48:Sales employee ZX
*F51:Sales employee ZY
*F52:Material list price
*F53:Mat.pr.curr.
*F54:Ord. item net value
*F56:Ord. item unit price
*F57:Unit pr. curr.
*F58:Order Cost
*F59:Cost curr.
*F60:Order Profit Value
*F61:Profit curr.
*F62:Order Profit %
*F66:Vendor name
*F69:Del. goods mov. status
*F72:Open del.qty
*F73:Open del.qty unit
*F74:Invoice
*F75:Ord. net value in CC
*F76:Ord. unit pr. CC
*F80:Inv.item net value
*F81:Invoice value in CC Currency
*F82:Inv.creation date
*F83:CC Currency
*F84:Open inv.qty
*F85:Quantity unit
*F86:Open inv. amount
*F87:Amount unit
*F88:Sold-To address
*F89:Dv (Item)
*F90:Ship-To region
*F91:Ship-To city
*F92:Ship-To ZIP code
*F93:Sold-To region
*F94:Sold-To city
*F95:Sold-To ZIP code
*F96:Billing plan line value
*F97:Billing plan line %
*F98:Order item
*F99:Deliv. item
*G01:Inv. item
*G02:Order on hand
*G03:Order on hand value
*G04:OH Cost
*G05:OH Profit Value
*G06:OH Profit %
*G07:Inv Cost
*G08:Inv Profit Value
*G09:Inv Profit %
*G10:GTS invoice
*G11:Sold-to Name 2
*G12:Ship-to Name 2
*G13:Bill-to Name 2
*G14:Ord. item net value CC
*G15:Order Profit Value CC
*G16:Comp.Curr.
*G17:SOLineCreaDate
*G18:Order On Hand Value CC
*G19:Sold-to Name 3
*G20:Sold-to Name 4
*G21:Ship-to Name 3
*G22:Ship-to Name 4
*G23:Bill-to Name 3
*G24:Bill-to Name 4
*G25:End cust. name 1
*G26:End cust. name 2
*G27:End cust. name 3
*G28:End cust. name 4
*S03:Select sales orders entered
*S04:Select sales orders invoiced
*S05:Only sales orders delivered
*S06:Select sales orders not invoiced
*S07:Variant to use ALV-output
*S08:Excl. DP lines of final invoice
*S09:Show linecount
*S10:Suppress Duplicated Order Lines
*S11:Check to view End Customer Information (Background Processing)

*S12:Clear DP invoice values
*Selection text
*CB_EDP:
*CB_LC:
*CB_SEL:
*CB_SPPRD:
*P_DAT_CC:        Date for curr. exchange
*P_KURST:D       .
*P_NO_DP:        Clear DP invoice values
*P_VAR:
*R1:
*R2:
*R3:
*R4:
*RB_SEL1:
*RB_SEL2:
*RB_SEL3:
*S_ABGRU:D       .
*S_AUART:        Sales order type
*S_BRAN1:        NAICS+
*S_BSARK:D       .
*S_BZIRK:D       .
*S_CMGST:        Overall Credit status of order
*S_EBELN:D       .
*S_EDATU:        Confirmed delivery date
*S_EDATUR:        Request delivery date
*S_ERDAT1:        Order Creation Date
*S_ERDAT2:        Creation date invoice
*S_ERDAT3:        Creation date SO line
*S_ERNAM:D       .
*S_FAKSK:D       .
*S_FAKSP:        Billing Block on Billing Plan
*S_FKART:D       .
*S_FKDAT:D       .
*S_GBSTK:        Overall status (header)
*S_HKUNNR:D       .
*S_IHREZ:D       .
*S_KUNAG:D       .
*S_KUNRE:        Bill-to party
*S_KUNWE:        Ship-to Party
*S_KZAUS:D       .
*S_LIFSK:D       .
*S_MATNR:D       .
*S_MMSTA:D       .
*S_MSTAV:D       .
*S_MTPOS:D       .
*S_PERNR:        Sales representative
*S_POSNR:D       .
*S_PRCTR:D       .
*S_PSTYV:D       .
*S_SPARTD:        Division (item-level)
*S_SPARTH:        Division (header-level)
*S_VBELN:D       .
*S_VBTYP:        Sales document type
*S_VDATU:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
*S_VKORG:        Sales organization
*S_VTWEG:        Distribution Channel
*S_WERKS:D       .
*S_WW002:D       .
*S_WW006:D       .
*S_WW007:D       .
*S_XBLNR:        CTP quotation number
*S_ZFKREL:D       .
*S_ZUONR:        GTS Invoice reference
