*-----------------------------------------------------------------------*
*                                                                       *
*  RFITEMAR      Line ITEMs Accounts Receivable                         *
*                     ----  -        -                                  *
*                                                                       *
*                This report selects data to be displayed by ALV        *
*-----------------------------------------------------------------------*
*-----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                    *
*-----------------------------------------------------------------------*
* MOD. NO.|  DATE    |  NAME      |CORRECTION NUMBER | CHANGE REFERENCE#*
*-----------------------------------------------------------------------*
* MOD-002 |2009.06.19| Uzzawal    | CD1K948835       |   CR0852         *
*-----------------------------------------------------------------------*
* MOD-003 |2009.06.23| Uzzawal    | CD1K948874       |   CR0514         *
*-----------------------------------------------------------------------*
* MOD-004 |2009.08.19| Uzzawal    | CD1K949809       |   CR0852         *
*-----------------------------------------------------------------------*
* MOD-005 |2010.06.01| Uzzawal    | CD1K957069       |   CR1458         *
*-----------------------------------------------------------------------*
* MOD-006 |2010.09.14| Uzzawal    | CD1K959211       |   CR1432         *
*-----------------------------------------------------------------------*
* MOD-007 |2010.12.21| Madhu      | CD1K962025       |   CR1432         *
*-----------------------------------------------------------------------*
* MOD-008 |2013.11.11| Praveen    | CD1K978311       |   CR3051         *
*-----------------------------------------------------------------------*
* MOD-009 |2015.07.01| Vishnupriya| CD1K986099       |   CR3601         *
* Add a ztable to pick the posting keys instead of the current hard     *
*                                               coded posting keys.     *
*-----------------------------------------------------------------------*

REPORT yse_rfitemar MESSAGE-ID msitem NO STANDARD PAGE HEADING.
* hallo
*... general data definitions:
INCLUDE yse_rfitem_def.
*include rfitem_def.
*... icons and symbols:
INCLUDE <list>.
*Begin of insertion by Mod-009
TYPES: BEGIN OF ty_bschl,
 	     bschl TYPE bschl,
       END OF ty_bschl.
*End of insertion by Mod-009
TABLES: kna1, knb1, bsid, bsik, admi_files,
        knkk.                              " MOD-003
TABLES: lfa1.
TABLES: t001.
TABLES: t005.
DATA: it_h_t001      TYPE tpit_t_vt001 WITH HEADER LINE,
      it_h_kna1      TYPE tpit_t_vkna1 WITH HEADER LINE,
      it_h_knb1      TYPE tpit_t_vknb1 WITH HEADER LINE.

* Begin of insertion by Mod-009
DATA: it_bschl TYPE STANDARD TABLE OF ty_bschl,
      wa_bschl TYPE ty_bschl.

DATA: BEGIN OF wa_so_bschl,
      sign    TYPE c LENGTH 1,
      option  TYPE c LENGTH 2,
      low     LIKE bseg-bschl,
      high    LIKE bseg-bschl,
  END OF wa_so_bschl.

DATA: so_bschl LIKE TABLE OF wa_so_bschl.

* End of insertion by Mod-009

*... selection screen layout:

* button worklists on/off:
SELECTION-SCREEN FUNCTION KEY 1.
* selections for processing of worklists:
SELECTION-SCREEN BEGIN OF BLOCK customer WITH FRAME TITLE text-w02.
PARAMETERS: pa_wlkun LIKE rf42b-idntd MODIF ID wkl.
SELECT-OPTIONS: so_wlkun FOR knb1-kunnr MODIF ID wkl NO DATABASE
SELECTION.
SELECTION-SCREEN END OF BLOCK customer.
SELECTION-SCREEN BEGIN OF BLOCK company WITH FRAME TITLE text-w03.
PARAMETERS: pa_wlbuk LIKE rf42b-idntb MODIF ID wkl.
SELECT-OPTIONS: so_wlbuk FOR knb1-bukrs MODIF ID wkl NO DATABASE
SELECTION.
SELECTION-SCREEN END OF BLOCK company.

* outer frame for item selection:
SELECTION-SCREEN BEGIN OF BLOCK items WITH FRAME TITLE text-007.
* inner frame 1:
SELECTION-SCREEN BEGIN OF BLOCK status WITH FRAME TITLE text-002.
*   open items:
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS x_opsel LIKE itemset-xopsel RADIOBUTTON GROUP rad1.
SELECTION-SCREEN COMMENT 3(20) text-003 FOR FIELD x_opsel.
SELECTION-SCREEN END OF LINE.
PARAMETERS pa_stida LIKE rfpdo-allgstid DEFAULT sy-datlo.
SELECTION-SCREEN SKIP.
*   cleared items:
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS x_clsel LIKE itemset-xclsel RADIOBUTTON GROUP rad1.
SELECTION-SCREEN COMMENT 3(25) text-004 FOR FIELD x_clsel.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS so_augdt FOR bsid-augdt NO DATABASE SELECTION.
PARAMETERS pa_stid2 LIKE rfpdo-allgstid.
SELECTION-SCREEN SKIP.
*   all items:
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS x_aisel LIKE itemset-xaisel RADIOBUTTON GROUP rad1.
SELECTION-SCREEN COMMENT 3(20) text-005 FOR FIELD x_aisel.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS so_budat FOR bsid-budat NO DATABASE SELECTION.
SELECTION-SCREEN END OF BLOCK status.
* inner frame 2:
SELECTION-SCREEN BEGIN OF BLOCK type WITH FRAME TITLE text-006.
PARAMETERS: x_norm LIKE itemset-xnorm AS CHECKBOX DEFAULT 'X',
            x_shbv LIKE itemset-xshbv AS CHECKBOX,
            x_merk LIKE itemset-xmerk AS CHECKBOX,
            x_park LIKE itemset-xpark AS CHECKBOX,
            x_apar LIKE itemset-xarit AS CHECKBOX.
SELECTION-SCREEN END OF BLOCK type.
* end of inner frames.
* net due date selection:
SELECT-OPTIONS so_faedt FOR it_pos-faedt NO DATABASE SELECTION
                                         MODIF ID due.
SELECTION-SCREEN END OF BLOCK items.
* end of outer frame.
* list layout frame:
SELECTION-SCREEN BEGIN OF BLOCK list WITH FRAME TITLE text-001.
PARAMETERS: pa_vari TYPE slis_vari,
            pa_nmax LIKE itemset-nmax.
SELECTION-SCREEN END OF BLOCK list.
*... end of selection screen layout.

*... dark parameters:
* branch: read items posted on central office?
*   Values: (Y)es, (N)o, ( ) prompt user, (C) selection cancelled
PARAMETERS: pa_cent TYPE c NO-DISPLAY.
* combined fiscal year/posting period
DATA: ld_yrper LIKE rwcoom-fiscper.
SELECT-OPTIONS: so_yrper FOR ld_yrper NO-DISPLAY.
* internet transaction mode?
PARAMETERS: pa_inet TYPE c NO-DISPLAY.
* grid control display?
*   Values: (Y)es, (N)o, ( ) get parameter
PARAMETERS: pa_grid TYPE c NO-DISPLAY.
*>>>>>>>>>> Begin of EXTUVE  MOD-002
DATA : BEGIN OF it_faglflexa OCCURS 0,
       ryear LIKE faglflexa-ryear,
       docnr LIKE faglflexa-docnr,
       rldnr LIKE faglflexa-rldnr,
       rbukrs LIKE faglflexa-rbukrs,
       hsl    LIKE faglflexa-hsl,
       wsl    LIKE faglflexa-wsl,
       segment LIKE faglflexa-segment,
       buzei LIKE faglflexa-buzei,
       bschl  LIKE faglflexa-bschl,
       END OF it_faglflexa.
DATA : wa_faglflexa LIKE it_faglflexa.
DATA : wa_pos2 LIKE it_pos.
*>>>>>>>>>> end of EXTUVE  MOD-002

*>>>>>>>>>> Begin of EXTUVE  MOD-003
DATA : BEGIN OF it_knkk OCCURS 0,
       kunnr LIKE knkk-kunnr,
       kkber LIKE knkk-kkber,
       klimk LIKE knkk-klimk,
       END OF it_knkk.
DATA : wa_knkk LIKE it_knkk.
*>>>>>>>>>> end of EXTUVE  MOD-003
*... include internal select-options for derived item fields:
INCLUDE yse_rfitem_sel.
*include rfitem_sel.

INITIALIZATION.
  g_repid = sy-repid.
  dd_noaut = 'X'.
  dd_nooap = 'X'.
* expiring currencies:
  PERFORM init_expcur.
* deactivate user commands:
  PERFORM change_status.
* get due date selection PID value:
  PERFORM dd_get_flag.
* initialize worklist button:
  PERFORM wl_flag_and_button.
* get T021S and make field administration tables:
  PERFORM init_admin_tables.
* make field catalog, exclude all unnecessary fields:
  PERFORM make_fieldcatalog.
* prepare KKBER currency lookup table:
  PERFORM init_kkcurr_table.
* get parameters:
  PERFORM get_general_param.
* set account and company code:
  PERFORM set_acct_and_ccode.
* set fields for transfer prices
  PERFORM insert_tp_fields.

AT SELECTION-SCREEN OUTPUT.
* check for "suppress dialog":
  gd_dynp_fun = 7.
  gd_dynp_val = 1.
  PERFORM dynp_get_status USING    gd_dynp_fun
                          CHANGING gd_dynp_val.
  LOOP AT SCREEN.
    PERFORM wl_modify_screen.
    PERFORM dd_modify_screen.
    MODIFY SCREEN.
  ENDLOOP.


AT SELECTION-SCREEN ON BLOCK customer.
  IF NOT gd_wl_on IS INITIAL.        " worklists on >
    IF gd_dynp_val EQ 0.             " rebuild dd_bukrs and dd_kunnr >
*       customer:
      REFRESH dd_kunnr.
      IF NOT pa_wlkun IS INITIAL.    " customer worklist given >
        PERFORM resolve_worklist TABLES gt_cosel
                                 USING  pa_wlkun
                                        'KUNNR'.
*           worklist overrides vendor select-option:
        REFRESH so_wlkun.
        CLEAR so_wlkun.
        LOOP AT gt_cosel.
          MOVE-CORRESPONDING gt_cosel TO dd_kunnr.
          APPEND dd_kunnr.
        ENDLOOP.
      ELSE.
        APPEND LINES OF so_wlkun TO dd_kunnr.
      ENDIF.                         " customer worklist given <
    ENDIF.                           " rebuild dd_bukrs and dd_kunnr <
  ENDIF.                             " worklists on <


AT SELECTION-SCREEN ON BLOCK company.
  IF NOT gd_wl_on IS INITIAL.        " worklists on >
    IF gd_dynp_val EQ 0.             " rebuild dd_bukrs and dd_kunnr >
*       company codes:
      REFRESH dd_bukrs.
      IF NOT pa_wlbuk IS INITIAL.    " ccode worklist given >
        PERFORM resolve_worklist TABLES gt_cosel
                                 USING  pa_wlbuk
                                        'BUKRS'.
*           worklist overrides company code select-option:
        REFRESH so_wlbuk.
        CLEAR so_wlbuk.
        LOOP AT gt_cosel.
          MOVE-CORRESPONDING gt_cosel TO dd_bukrs.
          APPEND dd_bukrs.
        ENDLOOP.
      ELSE.
        APPEND LINES OF so_wlbuk TO dd_bukrs.
      ENDIF.                         " ccode worklist given <
    ENDIF.                           " rebuild dd_bukrs and dd_kunnr <
  ENDIF.                             " worklists on <


AT SELECTION-SCREEN.

  CASE sy-ucomm.

*...switch worklist on or off:
    WHEN 'FC01'.
      PERFORM worklist_on_off.
      PERFORM set_acct_and_ccode.

*...process worklists and check selections:
    WHEN 'ONLI' OR 'PRIN' OR 'INIT' OR space.
      CALL FUNCTION 'BUKRS_AUTHORITY_CHECK'
        EXPORTING
          xdatabase = 'D'
        TABLES
          xbukreis  = dd_bukrs.
      CALL FUNCTION 'BUKRS_AUTHORITY_CHECK'
        EXPORTING
          xdatabase = 'B'
        TABLES
          xbukreis  = dd_bukrs.

*    check input:
      PERFORM sel_account_check.
*     check date (tpc)
      PERFORM check_date TABLES dd_bukrs
                         USING  dd_tpc.

  ENDCASE.

AT SELECTION-SCREEN ON BLOCK type.
* check item type only when action = execute:
  IF sy-ucomm = 'ONLI'.
    PERFORM sel_type_check.
  ENDIF.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR pa_vari.
  PERFORM alv_variant_f4 CHANGING pa_vari.

*** start of selection
START-OF-SELECTION.
***

  CLEAR: x_stop.
* set parameters:
  PERFORM set_parameters.
* map selections to LDB logic:
  PERFORM map_sel_to_ldb.

* determine company codes which use transfer prices
  SELECT * FROM t001a INTO TABLE it_tp_auth WHERE bukrs IN dd_bukrs.
  LOOP AT it_tp_auth.
    IF it_tp_auth-curtp+1(1) = '1' OR it_tp_auth-curtp+1(1) = '2'
      OR it_tp_auth-curtp2+1(1) = '1' OR it_tp_auth-curtp2+1(1) = '2'.
    ELSE.
      DELETE it_tp_auth.
    ENDIF.
  ENDLOOP.
* check tp authority and set 'tech'-attribute if authority is missing
  PERFORM make_fieldcatalog2.

GET kna1.
* general account master data:
  PERFORM kna1_info_fill.
  PERFORM t005_info_fill USING 'D'.

GET knb1.
* company master data and currencies:
  PERFORM t001_info_fill.
* company account master data:
  PERFORM knb1_info_fill.

GET knb1 LATE.
* vendor items requested?
  IF NOT x_apar IS INITIAL AND NOT kna1-lifnr IS INITIAL.
    PERFORM read_vendor_items.
  ENDIF.

GET bsid.
* importing BKPF and BSEG data from archive
  PERFORM import_arch_from_memory.
* line items, basic fields:
  ld_yrper(4) = bsid-gjahr.
  ld_yrper+5  = bsid-monat.
  CHECK ld_yrper IN so_yrper.
  PERFORM pos_table_fill  CHANGING  x_stop.

END-OF-SELECTION.
* any branch accounts? prompt user if necessary:
  PERFORM knb1_check_branch.
* save all selection criteria for refresh:
  PERFORM save_all_selections.
* Selection cancelled if choosen at the branch/head popup.
  IF pa_cent = 'C'.
    MESSAGE s050.
    EXIT.
  ENDIF.
* determine list display mode:
  PERFORM display_grid_or_classic.
* read items posted on central office:
  PERFORM read_central_items.
* set variant:
  gs_variant-report   = g_repid.
  gs_variant-username = sy-uname.
  gs_variant-variant  = pa_vari.
* read special fields if necessary:
  PERFORM special_fields_init USING gs_variant.
* number of selected items:
  IF x_stop = 'X'.
    MESSAGE i023 WITH pa_nmax.
  ELSE.
    DESCRIBE TABLE it_pos LINES n_lines.
    IF n_lines > 0.
      MESSAGE s024 WITH n_lines.
    ELSEIF pa_inet IS INITIAL AND gd_dynp_val IS INITIAL.
      MESSAGE s033.
      EXIT.
    ELSE.
      MESSAGE i033.
      LEAVE PROGRAM.
    ENDIF.
  ENDIF.
* export general data used in header info:
  PERFORM export_filitexts_data.

* authority display or change
  PERFORM authority_tcode USING 'FB02' subrc.
  IF subrc EQ 0.
    x_change = 'X'.
  ELSE.
    x_change = space.
  ENDIF.

  gt_pos_inv[] = it_pos[].
  gt_pos_no_inv[] = it_pos[].
  gt_pos_dwn_py[] = it_pos[].

  PERFORM yse_additional_data.


* leave to ALV:
  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
    EXPORTING
      text = text-009.
  gs_variant-report = c_repid_ar.
  gs_variant-username = sy-uname.
* Begin of insertion by Mod-009.
  SELECT bschl FROM yse_fi_fbl5n_slr
               INTO TABLE it_bschl.
  LOOP AT it_bschl INTO wa_bschl.
    wa_so_bschl-sign    = 'I'.
    wa_so_bschl-option  = 'EQ'.
    wa_so_bschl-low     = wa_bschl-bschl.
    APPEND wa_so_bschl TO so_bschl.
    CLEAR: wa_so_bschl, wa_bschl.
  ENDLOOP.
*End of insertion by Mod-009.
*>>>>>>>>>>> Begin of Insert EXTUVE MOD-002
  CHECK NOT it_pos[] IS INITIAL.
  SELECT ryear docnr rldnr rbukrs  hsl wsl segment buzei bschl
          INTO TABLE it_faglflexa
          FROM faglflexa
          FOR ALL ENTRIES IN it_pos
          WHERE ryear = it_pos-gjahr
          AND docnr = it_pos-belnr
          AND rldnr = '0L'
          AND rbukrs = it_pos-bukrs
          AND ( bschl IN so_bschl
          OR  bschl = ' ' ).   "+MOD-009
*Begin of deletion by MOD-009.
*                     AND ( bschl = '01'
*                      OR bschl = '04'        "MOD-004
*                      OR bschl = ' '                        "CR1458
*                      OR bschl = '14'                       "CR1458
*                      OR bschl = '17'        "MOD-006
*                      OR bschl = '09'        "MOD-006
*                      OR bschl = '15'        "MOD-006
*                      OR bschl = '11'        "MOD-006
*                      OR bschl = '19'        "MOD-006
*                      OR bschl = '06'        "MOD-006
*                      OR bschl = '07' ) .    "MOD-006
*End of deletion by MOD-009.

  IF sy-subrc = 0.
    SORT it_faglflexa BY ryear docnr segment.
  ENDIF.

*>>>>>>>>>>> Begin of Insert EXTUVE MOD-003 ( CR0514 )
  CHECK NOT it_pos[] IS INITIAL.
  SELECT kunnr kkber klimk FROM knkk
                INTO TABLE it_knkk
                FOR ALL ENTRIES IN it_pos
                 WHERE kunnr = it_pos-konto
                   AND kkber = it_pos-bukrs.
  IF sy-subrc = 0.
    SORT it_knkk BY kunnr kkber.
  ENDIF.
*>>>>>>>>>>> End of Insert EXTUVE MOD-003

*
  DATA : wa_pos1 LIKE it_pos.
  LOOP AT it_faglflexa INTO wa_faglflexa.
    CLEAR wa_pos1.
    READ TABLE it_pos INTO wa_pos1 WITH KEY bukrs = wa_faglflexa-rbukrs
                                              gjahr = wa_faglflexa-ryear
                                              belnr = wa_faglflexa-docnr
                                              buzei = wa_faglflexa-buzei.
    IF sy-subrc = 0.
      IF wa_pos1-dmshb = wa_faglflexa-hsl.
        CLEAR wa_knkk.
        READ TABLE it_knkk INTO wa_knkk WITH KEY kunnr = wa_pos1-konto
                                                 kkber = wa_pos1-bukrs.
        wa_pos1-segment = wa_faglflexa-segment.
        wa_pos1-klimk   = wa_knkk-klimk.      " MOD-003
        APPEND wa_pos1 TO it_pos .
        CLEAR wa_pos1.
      ELSE.
        AT END OF segment.
          READ TABLE it_knkk INTO wa_knkk WITH KEY kunnr = wa_pos1-konto
                                                   kkber = wa_pos1-bukrs.
          wa_pos1-segment = wa_faglflexa-segment.
          wa_pos1-dmshb   = wa_faglflexa-hsl.
          wa_pos1-wrshb   = wa_faglflexa-wsl.
          wa_pos1-bwwrt   = wa_faglflexa-hsl.
          wa_pos1-skfbt   = wa_faglflexa-hsl.
          wa_pos1-klimk   = wa_knkk-klimk.        " MOD-003
          APPEND wa_pos1 TO it_pos .
          CLEAR wa_pos1.
        ENDAT.
      ENDIF.
    ENDIF.
  ENDLOOP.

  DELETE it_pos WHERE segment = space.
*>>>>>>>>>>> End of Insert EXTUVE MOD-002
*>>>>>>>>>>> Begin of Insert EXTPBD MOD-008 ( CR3051 )
* Get sold to party details and append it to the final internal table
  PERFORM get_sp_details.
*>>>>>>>>>>> End of Insert EXTPBD MOD-008
  CALL FUNCTION 'YSE_FI_ITEMS_DISPLAY'
    EXPORTING
      caller_repid  = c_repid_ar
      acctype       = c_koart_ar
      x_change      = x_change
      i_u_save      = gd_alvsave
      is_u_variant  = gs_variant
      it_u_fieldcat = gt_fieldcat[]
      it_kontab     = it_accts[]
      it_slbtab     = it_comps[]
      it_t001       = it_h_t001[]
      it_kna1       = it_h_kna1[]
      it_knb1       = it_h_knb1[]
      x_grid        = x_grid
      x_inet        = pa_inet
    TABLES
      it_items      = it_pos.

*----------------------------------------------------------------------*
*  FORM SEL_ACCOUNT_CHECK
*----------------------------------------------------------------------*
FORM sel_account_check.

  DATA: ld_lines LIKE sy-index,
        ld_single_account TYPE c,
        ld_single_bukrs   TYPE c.

  READ TABLE dd_kunnr INDEX 1.
  IF sy-subrc NE 0.
    READ TABLE dd_bukrs INDEX 1.
    IF sy-subrc NE 0.
      MESSAGE w019.
    ENDIF.
  ENDIF.
  READ TABLE dd_kunnr INDEX 1.
  IF sy-subrc EQ 0.
    LOOP AT dd_kunnr TRANSPORTING NO FIELDS
                     WHERE option NE 'EQ' OR
                           sign   NE 'I'.
      EXIT.
    ENDLOOP.
    subrc = sy-subrc.                  "Arbeitsvorrat: subrc ne 0
  ELSE.
    subrc = 0.
  ENDIF.
  IF subrc EQ 0.
    SELECT SINGLE kunnr FROM knb1 INTO knb1-kunnr
           WHERE kunnr IN dd_kunnr
             AND bukrs IN dd_bukrs.
  ELSE.
    SELECT kunnr FROM knb1 INTO knb1-kunnr
           UP TO 1 ROWS
           FOR ALL ENTRIES IN dd_kunnr
           WHERE kunnr EQ dd_kunnr-low
             AND bukrs IN dd_bukrs.
    ENDSELECT.
  ENDIF.
  IF sy-subrc NE 0.
    MESSAGE e030(msitem).
  ENDIF.
  CLEAR knb1.

*...write dd_kunnr und dd_bukrs into memory
*...(important later for Dispute-Management).

  EXPORT dd_kunnr TO MEMORY ID 'FILITEXTS_KUNNR'.
  EXPORT dd_bukrs TO MEMORY ID 'FILITEXTS_BUKRS'.

*...find out, if single accounts and company codes have been selected..*
*...(important for header display).....................................*

  CLEAR ld_single_account.
  DESCRIBE TABLE dd_kunnr LINES ld_lines.
  IF ld_lines EQ 1.
    READ TABLE dd_kunnr INDEX 1.
    IF ( dd_kunnr-sign EQ 'I' AND dd_kunnr-option EQ 'EQ' ) OR
       ( dd_kunnr-sign EQ 'I' AND dd_kunnr-option EQ 'BT' AND
         dd_kunnr-low  EQ dd_kunnr-high ).
      ld_single_account = 'X'.
    ENDIF.
  ENDIF.
  CLEAR ld_single_bukrs.
  DESCRIBE TABLE dd_bukrs LINES ld_lines.
  IF ld_lines EQ 1.
    READ TABLE dd_bukrs INDEX 1.
    IF ( dd_bukrs-sign EQ 'I' AND dd_bukrs-option EQ 'EQ' ) OR
       ( dd_bukrs-sign EQ 'I' AND dd_bukrs-option EQ 'BT' AND
         dd_bukrs-low  EQ dd_bukrs-high ).
      ld_single_bukrs = 'X'.
    ENDIF.
  ENDIF.
  EXPORT ld_single_bukrs ld_single_account TO MEMORY ID
                                      'FILITEXTS_SINGLE'.

ENDFORM.                    "sel_account_check

*----------------------------------------------------------------------*
*  FORM SEL_TYPE_CHECK
*----------------------------------------------------------------------*
FORM sel_type_check.
  IF x_norm IS INITIAL AND x_shbv IS INITIAL AND x_merk IS INITIAL
     AND x_park IS INITIAL AND x_apar IS INITIAL.
    MESSAGE e020.
  ENDIF.
ENDFORM.                    "sel_type_check

*----------------------------------------------------------------------*
*      Form  POS_TABLE_FILL
*----------------------------------------------------------------------*
FORM pos_table_fill  CHANGING  p_stop.
  DATA: text_index TYPE i,
        okay       TYPE c VALUE space.

  CLEAR wa_pos.
  MOVE-CORRESPONDING bsid  TO wa_pos.
*... check item against selection flags:
  PERFORM check_item_ok  USING x_norm
                               x_shbv
                               x_merk
                               x_park
                               wa_pos
                         CHANGING okay.
  CHECK okay = 'X'.
*
  wa_pos-koart = c_koart_ar.
  wa_pos-konto = bsid-kunnr.
  wa_pos-dmshb = bsid-dmbtr.
  wa_pos-wrshb = bsid-wrbtr.
  wa_bsegp-bdiff = bsid-bdiff.
  wa_bsegp-bdif2 = bsid-bdif2.
  wa_bsegp-bdif3 = bsid-bdif3.
* derive nontrivial item fields:
  CALL FUNCTION 'ITEM_DERIVE_FIELDS'
       EXPORTING
            s_t001    = it_h_t001
            s_bsegp   = wa_bsegp
            key_date  = p_keydate
*           XOPVW     = 'X'
            i_kalsm     = t005-kalsm
       CHANGING
            s_item    = wa_pos
       EXCEPTIONS
            bad_input = 1
            OTHERS    = 2
            .
  IF sy-subrc NE 0.
    MESSAGE a022.
  ENDIF.
* check and modify text field in internet case:
  IF NOT pa_inet IS INITIAL.
    IF wa_pos-sgtxt(1) NE '*'.
*     take posting key text:
      CLEAR wa_pos-sgtxt.
      SELECT SINGLE ltext FROM tbslt INTO wa_pos-sgtxt
                    WHERE spras = sy-langu
                    AND   bschl = wa_pos-bschl
                    AND   umskz = wa_pos-umskz.
    ELSE.
*     take line item text:
      SHIFT wa_pos-sgtxt.
    ENDIF.
  ENDIF.
* fill currency fields:
  PERFORM item_currency_fields.
* check dark select-options and add item to table:
  PERFORM item_check_append.
* check max number:
  DESCRIBE TABLE it_pos LINES n_lines.
  IF pa_nmax > 0 AND n_lines GE pa_nmax.
    p_stop = 'X'.
    STOP.
  ENDIF.
ENDFORM.                    "pos_table_fill

*----------------------------------------------------------------------*
*      Form  POS_TABLE_FILL_VENDOR
*----------------------------------------------------------------------*
FORM pos_table_fill_vendor  CHANGING  p_stop.
  DATA: text_index TYPE i,
        okay       TYPE c VALUE space.

  CLEAR wa_pos.
  MOVE-CORRESPONDING bsik  TO wa_pos.
*... check item against selection flags:
  PERFORM check_item_ok  USING x_norm
                               x_shbv
                               x_merk
                               x_park
                               wa_pos
                         CHANGING okay.
  CHECK okay = 'X'.
*
  wa_pos-koart = 'K'.
  wa_pos-konto = kna1-lifnr.
  wa_pos-dmshb = bsik-dmbtr.
  wa_pos-wrshb = bsik-wrbtr.
  wa_bsegp-bdiff = bsik-bdiff.
  wa_bsegp-bdif2 = bsik-bdif2.
  wa_bsegp-bdif3 = bsik-bdif3.
* derive nontrivial item fields:
  CALL FUNCTION 'ITEM_DERIVE_FIELDS'
       EXPORTING
            s_t001    = it_h_t001
            s_bsegp   = wa_bsegp
            key_date  = p_keydate
*           XOPVW     = 'X'
            i_kalsm     = t005-kalsm
       CHANGING
            s_item    = wa_pos
       EXCEPTIONS
            bad_input = 1
            OTHERS    = 2
            .
  IF sy-subrc NE 0.
    MESSAGE a022.
  ENDIF.
* check and modify text field in internet case:
  IF NOT pa_inet IS INITIAL.
    IF wa_pos-sgtxt(1) NE '*'.
      CLEAR wa_pos-sgtxt.
    ELSE.
      SHIFT wa_pos-sgtxt.
    ENDIF.
  ENDIF.
* fill currency fields:
  PERFORM item_currency_fields.
* check dark select-options and add item to table:
  PERFORM item_check_append.
* check max number:
  DESCRIBE TABLE it_pos LINES n_lines.
  IF pa_nmax > 0 AND n_lines GE pa_nmax.
    p_stop = 'X'.
    STOP.
  ENDIF.
ENDFORM.                               " POS_TABLE_FILL_VENDOR

*&---------------------------------------------------------------------*
*&      Form  KNA1_INFO_FILL
*&---------------------------------------------------------------------*
FORM kna1_info_fill.
  CLEAR it_h_kna1.
  MOVE-CORRESPONDING kna1 TO it_h_kna1.
  INSERT table it_h_kna1.
ENDFORM.                    "kna1_info_fill

*&---------------------------------------------------------------------*
*&      Form  KNB1_INFO_FILL
*&---------------------------------------------------------------------*
FORM knb1_info_fill.
  CLEAR it_h_knb1.
  MOVE-CORRESPONDING knb1 TO it_h_knb1.
  INSERT table it_h_knb1.
* table of accounts:
  PERFORM fill_acct_table  USING  c_koart_ar
                                  knb1-kunnr
                                  knb1-bukrs
                                  kna1-lifnr
                                  kna1-name1
                                  space.
ENDFORM.                    "knb1_info_fill

*&---------------------------------------------------------------------*
*&      Form  KNB1_CHECK_BRANCH
*&---------------------------------------------------------------------*
FORM knb1_check_branch.
  DATA: ls_selection    LIKE addr1_sel,
        ls_branch_addr  LIKE addr1_val,
        ls_central_addr LIKE addr1_val,
        ls_kna1         LIKE kna1,
        lb_okay         TYPE c.
  DATA: ld_mandt LIKE knb1-mandt.
  DATA: ld_bukrs LIKE knb1-bukrs.
  DATA: ld_knrze LIKE knb1-knrze.
  DATA: ld_text(2) TYPE c.

  LOOP AT it_h_knb1 WHERE NOT knrze IS INITIAL.
    IF pa_cent NE 'N'.
      ld_mandt = it_h_knb1-mandt.
      ld_bukrs = it_h_knb1-bukrs.
      ld_knrze = it_h_knb1-knrze.
      READ TABLE it_h_knb1 WITH KEY mandt = ld_mandt
                                    kunnr = ld_knrze
                                    bukrs = ld_bukrs
           BINARY SEARCH
           TRANSPORTING NO FIELDS.
      IF sy-subrc = 0.
        CONTINUE.
      ELSE.
        CLEAR it_central.
        IF pa_cent IS INITIAL.
*         check permanent user setting:
          GET PARAMETER ID 'FIT_BRANCH' FIELD ld_text.
          IF ld_text+1(1) = 'X'.
*           'never again' case:
            lb_okay = ld_text(1).
          ELSE.
*           get central address record for branch account:
            READ TABLE it_h_kna1 WITH KEY mandt = it_h_knb1-mandt
                                          kunnr = it_h_knb1-kunnr
                                          BINARY SEARCH.
            IF sy-subrc = 0.
              ls_selection-addrnumber = it_h_kna1-adrnr.
              CALL FUNCTION 'ADDR_GET'
                EXPORTING
                  address_selection = ls_selection
                IMPORTING
                  address_value     = ls_branch_addr
                EXCEPTIONS
                  parameter_error   = 1
                  OTHERS            = 2.
            ENDIF.
*           get central address record for central account:
            SELECT SINGLE name1 adrnr FROM kna1
                                INTO CORRESPONDING FIELDS OF ls_kna1
                                WHERE kunnr = it_h_knb1-knrze.

            IF sy-subrc = 0.
              ls_selection-addrnumber = ls_kna1-adrnr.
              CALL FUNCTION 'ADDR_GET'
                EXPORTING
                  address_selection = ls_selection
                IMPORTING
                  address_value     = ls_central_addr
                EXCEPTIONS
                  parameter_error   = 1
                  OTHERS            = 2.
            ENDIF.
*           show popup:
            CALL FUNCTION 'FI_ITEMS_BRANCH_CENTRAL'
              EXPORTING
                id_branch_acct   = it_h_knb1-kunnr
                id_branch_name1  = ls_branch_addr-name1
                id_central_acct  = it_h_knb1-knrze
                id_central_name1 = ls_central_addr-name1
                id_bukrs         = it_h_knb1-bukrs
              IMPORTING
                eb_central_items = lb_okay.

          ENDIF.
        ENDIF.
* return to selection screen, if selection is cancelled in Branch/Head
* Popup:
        IF lb_okay = 'C'.
          pa_cent = 'C'.
          CLEAR it_central.
          REFRESH it_central.
          EXIT.
        ENDIF.
* add account to memory, and fill central account, if required:
        IF pa_cent = 'Y' OR lb_okay = 'X'.
          it_central-central = it_h_knb1-knrze.
        ENDIF.
        it_central-branch  = it_h_knb1-kunnr.
        it_central-bukrs   = it_h_knb1-bukrs.
        APPEND it_central.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "knb1_check_branch

*&---------------------------------------------------------------------*
*&      Form  T001_INFO_FILL
*&---------------------------------------------------------------------*
FORM t001_info_fill.

  READ TABLE it_h_t001 WITH KEY mandt = sy-mandt
                                bukrs = knb1-bukrs
                       BINARY SEARCH.
  IF sy-subrc NE 0.
    CLEAR: it_h_t001.
    SELECT SINGLE * FROM t001 INTO it_h_t001
        WHERE bukrs = knb1-bukrs.
    INSERT table it_h_t001.

*    table of companies:
    PERFORM fill_comp_table  USING  knb1-bukrs
                              it_h_t001-waers
                              it_h_t001-kkber.
  ENDIF.

  IF wa_x001-bukrs NE knb1-bukrs.
    CLEAR: wa_x001.
    CALL FUNCTION 'FI_CURRENCY_INFORMATION'
      EXPORTING
        i_bukrs                = knb1-bukrs
      IMPORTING
        e_x001                 = wa_x001
      EXCEPTIONS
        currency_2_not_defined = 1
        currency_3_not_defined = 2
        OTHERS                 = 3.
    IF sy-subrc = 0.
* ?
    ENDIF.
  ENDIF.

ENDFORM.                    "t001_info_fill

*&---------------------------------------------------------------------*
*&      Form  MAP_SEL_TO_LDB
*&---------------------------------------------------------------------*
FORM map_sel_to_ldb.

  DATA: ld_stida LIKE sy-datum.

  CLEAR:   dd_augdt, dd_budat, dd_opopt, dd_apopt, dd_stida .
  REFRESH: dd_augdt, dd_budat.

* Determine whether parked (xstav) and/or normal items
* (xstan) must be selected by the log. database
  IF x_park = 'X'.
    b0sg-xstav = 'X'.
  ELSE.
    CLEAR b0sg-xstav.
  ENDIF.
  IF ( x_norm = 'X' OR x_shbv = 'X' OR x_merk = 'X' ).
    b0sg-xstan = 'X'.
  ELSE.
    CLEAR b0sg-xstan.
  ENDIF.

* Determine relevant keydates for the selection by the log. database
* (dd_stida)
  GET PARAMETER ID 'FI_STIDA' FIELD ld_stida.
  IF NOT ld_stida IS INITIAL AND sy-subrc EQ 0.
    pa_stida = ld_stida.
    SET PARAMETER ID 'FI_STIDA' FIELD '00000000'.
  ENDIF.
  CASE 'X'.
    WHEN x_opsel.
      IF pa_stida IS INITIAL.
        p_keydate         = '99991231'.
        dd_stida          = '99991231'.
        b0sg-xnopl        = 'X'.
      ELSE.
        p_keydate         = pa_stida.
        dd_stida          = pa_stida.
      ENDIF.
      dd_opopt          = 'X'.
    WHEN x_clsel.
      IF pa_stid2 IS INITIAL.
        p_keydate       = '99991231'.
        dd_stida        = '00010101'.
        dd_apopt        = 'X'.                              "992643
      ELSE.
        p_keydate       = pa_stid2.
        dd_stida        = pa_stid2.
*        dd_budat-sign   = 'I'.                                "992643
*        dd_budat-option = 'LE'.                               "992643
*        dd_budat-low    = pa_stid2.                           "992643
*        append dd_budat.                                      "992643
      ENDIF.
      dd_augdt[]        = so_augdt[].
    WHEN x_aisel.
      p_keydate         = '99991231'.
      dd_stida          = '99991231'.
      dd_budat[]        = so_budat[].
      dd_opopt          = 'X'.
      dd_apopt          = 'X'.
  ENDCASE.
  pa_stida_default = dd_stida.

* For reading from archives:
* number of archived items as i-message:
  dd_iarch = 'X'.
  dd_memor = 'X'.

ENDFORM.                    "map_sel_to_ldb

*&---------------------------------------------------------------------*
*&      Form  SET_PARAMETERS
*&---------------------------------------------------------------------*
FORM set_parameters.
* set general parameters:
  PERFORM set_general_param.
* set acc.type specific parameters:
  CLEAR: dd_kunnr, dd_bukrs.
  CLEAR: so_wlkun, so_wlbuk.
  IF gd_wl_on IS INITIAL.
    READ TABLE dd_kunnr INDEX 1.
    IF sy-subrc = 0 AND dd_kunnr-sign = 'I' AND dd_kunnr-option = 'EQ'
        AND NOT dd_kunnr-low IS INITIAL.
      SET PARAMETER ID 'KUN' FIELD dd_kunnr-low.
    ENDIF.
    READ TABLE dd_bukrs INDEX 1.
    IF sy-subrc = 0 AND dd_bukrs-sign = 'I' AND dd_bukrs-option = 'EQ'
        AND NOT dd_bukrs-low IS INITIAL.
      SET PARAMETER ID 'BUK' FIELD dd_bukrs-low.
    ENDIF.
    SET PARAMETER ID 'AVD' FIELD space.
    SET PARAMETER ID 'AVB' FIELD space.
  ELSE.
*   worklists switched on:
    SET PARAMETER ID 'AVD' FIELD pa_wlkun.
    SET PARAMETER ID 'AVB' FIELD pa_wlbuk.
    READ TABLE so_wlkun INDEX 1.
    IF sy-subrc = 0 AND so_wlkun-sign = 'I' AND so_wlkun-option = 'EQ'
        AND NOT so_wlkun-low IS INITIAL.
      SET PARAMETER ID 'KUN' FIELD so_wlkun-low.
    ENDIF.
    READ TABLE so_wlbuk INDEX 1.
    IF sy-subrc = 0 AND so_wlbuk-sign = 'I' AND so_wlbuk-option = 'EQ'
        AND NOT so_wlbuk-low IS INITIAL.
      SET PARAMETER ID 'BUK' FIELD so_wlbuk-low.
    ENDIF.
  ENDIF.

* Set parameters for reading from archiv
  gd_usear = dd_usear.
  gd_usedb = dd_usedb.
  gd_memor = 'X'.

ENDFORM.                    "set_parameters

*&---------------------------------------------------------------------*
*&      Form  READ_VENDOR_ITEMS
*&---------------------------------------------------------------------*
FORM read_vendor_items.
* prepare selection screen table:
  PERFORM kdf_selscreen.
  IF sy-subrc <> 0 .
    sy-subrc = 0.
    EXIT.
  ENDIF.
* prepare dynamic selections:
  PERFORM kdf_dynamics.
* prepare callbacks for ldb_process:
  PERFORM fill_kdf_callback.
* export b0sg flags for ldb
  EXPORT b0sg TO MEMORY ID 'KDF_B0SG'.
* read ldb KDF:
  CALL FUNCTION 'LDB_PROCESS'
    EXPORTING
      ldbname                     = 'KDF'
      expressions                 = it_dyn_texpr[]
    TABLES
      callback                    = it_callback
      selections                  = it_selscreen
    EXCEPTIONS
      ldb_selections_error        = 1
      ldb_selections_not_accepted = 2
      free_selections_error       = 3
      callback_no_event           = 4
      callback_no_program         = 5
      callback_no_cbform          = 6
      OTHERS                      = 7.
  IF sy-subrc NE 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ELSE.
    PERFORM import_arch_from_memory.
  ENDIF.
ENDFORM.                               " READ_VENDOR_ITEMS

*&---------------------------------------------------------------------*
*&      Form  READ_CENTRAL_ITEMS
*&---------------------------------------------------------------------*
FORM read_central_items.
* loop over all identified central office accts:
  LOOP AT it_central WHERE NOT central IS INITIAL.
*   prepare selection screen table:
    PERFORM ddf_selscreen.
*   prepare dynamic selections:
    PERFORM ddf_dynamics.
*   prepare callbacks for ldb_process:
    PERFORM fill_ddf_callback.
*   export b0sg flags for ldb
    EXPORT b0sg TO MEMORY ID 'DDF_B0SG'.
*   read ldb DDF:
    CALL FUNCTION 'LDB_PROCESS'
      EXPORTING
        ldbname                     = 'DDF'
        expressions                 = it_dyn_texpr[]
      TABLES
        callback                    = it_callback
        selections                  = it_selscreen
      EXCEPTIONS
        ldb_not_reentrant           = 1
        ldb_incorrect               = 2
        ldb_already_running         = 3
        ldb_error                   = 4
        ldb_selections_error        = 5
        ldb_selections_not_accepted = 6
        free_selections_error       = 10
        callback_no_event           = 11
        callback_node_duplicate     = 12
        callback_no_program         = 13
        callback_no_cbform          = 14
        OTHERS                      = 17.
    IF sy-subrc = 0 .
      PERFORM import_arch_from_memory.
    ENDIF.
  ENDLOOP.
ENDFORM.                               " READ_CENTRAL_ITEMS

*&---------------------------------------------------------------------*
*&      Form  KDF_SELSCREEN
*&---------------------------------------------------------------------*
FORM kdf_selscreen.

  TYPES:   BEGIN OF acccoco,
             lifnr LIKE kna1-lifnr,
             bukrs LIKE knb1-bukrs,
           END OF acccoco.
  DATA:    ld_selections_old TYPE acccoco.
  STATICS: st_selections_old TYPE SORTED TABLE OF acccoco
           WITH UNIQUE KEY lifnr bukrs.

  ld_selections_old-lifnr = kna1-lifnr.
  ld_selections_old-bukrs = knb1-bukrs.
  INSERT ld_selections_old INTO TABLE st_selections_old.
  IF sy-subrc <> 0.
    EXIT.
  ELSE.
    REFRESH: it_selscreen.
* fill selections: first single values & parameters
    it_selscreen-selname = 'KD_LIFNR'.
    it_selscreen-kind    = 'S'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = kna1-lifnr.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_BUKRS'.
    it_selscreen-kind    = 'S'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = knb1-bukrs.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_OPOPT'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_opopt.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_APOPT'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_apopt.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_STIDA'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_stida.
    APPEND it_selscreen.
* now select option tables:
    LOOP AT dd_augdt.
      CLEAR it_selscreen.
      it_selscreen-selname = 'KD_AUGDT'.
      it_selscreen-kind    = 'S'.
      MOVE-CORRESPONDING dd_augdt TO it_selscreen.
      APPEND it_selscreen.
    ENDLOOP.
    LOOP AT dd_budat.
      CLEAR it_selscreen.
      it_selscreen-selname = 'KD_BUDAT'.
      it_selscreen-kind    = 'S'.
      MOVE-CORRESPONDING dd_budat TO it_selscreen.
      APPEND it_selscreen.
    ENDLOOP.
    IF sy-subrc <> 0.
      sy-subrc = 0.
    ENDIF.

* Parameters and Select Options for Archives
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_USEDB'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_usedb.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_USEAR'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_usear.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_USEAS'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_useas.
    APPEND it_selscreen.
    IF NOT dd_files[] IS INITIAL.
      LOOP AT dd_files.
        CLEAR it_selscreen.
        it_selscreen-selname = 'KD_FILES'.
        it_selscreen-kind    = 'S'.
        MOVE-CORRESPONDING dd_files TO it_selscreen.
        APPEND it_selscreen.
      ENDLOOP.
    ENDIF.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_MEMOR'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_memor.
    APPEND it_selscreen.
    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_IARCH'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_iarch.
    APPEND it_selscreen.

    CLEAR it_selscreen.
    it_selscreen-selname = 'KD_NOOAP'.
    it_selscreen-kind    = 'P'.
    it_selscreen-sign    = 'I'.
    it_selscreen-option  = 'EQ'.
    it_selscreen-low     = dd_nooap.
    APPEND it_selscreen.

  ENDIF.

ENDFORM.                               " KDF_SELSCREEN

*&---------------------------------------------------------------------*
*&      Form  DDF_SELSCREEN
*&---------------------------------------------------------------------*
FORM ddf_selscreen.

  REFRESH: it_selscreen.
* fill selections: first single values & parameters
  it_selscreen-selname = 'DD_KUNNR'.
  it_selscreen-kind    = 'S'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = it_central-central.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_BUKRS'.
  it_selscreen-kind    = 'S'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = it_central-bukrs.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_OPOPT'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_opopt.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_APOPT'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_apopt.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_STIDA'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_stida.
  APPEND it_selscreen.
* now select option tables:
  LOOP AT dd_augdt.
    CLEAR it_selscreen.
    it_selscreen-selname = 'DD_AUGDT'.
    it_selscreen-kind    = 'S'.
    MOVE-CORRESPONDING dd_augdt TO it_selscreen.
    APPEND it_selscreen.
  ENDLOOP.
  LOOP AT dd_budat.
    CLEAR it_selscreen.
    it_selscreen-selname = 'DD_BUDAT'.
    it_selscreen-kind    = 'S'.
    MOVE-CORRESPONDING dd_budat TO it_selscreen.
    APPEND it_selscreen.
  ENDLOOP.

* Parameters and Select Options for Archives
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_USEDB'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_usedb.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_USEAR'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_usear.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_USEAS'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_useas.
  APPEND it_selscreen.
  IF NOT dd_files[] IS INITIAL.
    LOOP AT dd_files.
      CLEAR it_selscreen.
      it_selscreen-selname = 'DD_FILES'.
      it_selscreen-kind    = 'S'.
      MOVE-CORRESPONDING dd_files TO it_selscreen.
      APPEND it_selscreen.
    ENDLOOP.
  ENDIF.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_MEMOR'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_memor.
  APPEND it_selscreen.
  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_MEMOR'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_memor.
  APPEND it_selscreen.

  CLEAR it_selscreen.
  it_selscreen-selname = 'DD_NOOAP'.
  it_selscreen-kind    = 'P'.
  it_selscreen-sign    = 'I'.
  it_selscreen-option  = 'EQ'.
  it_selscreen-low     = dd_nooap.
  APPEND it_selscreen.


ENDFORM.                               " DDF_SELSCREEN

*&---------------------------------------------------------------------*
*&      Form  KDF_DYNAMICS
*&---------------------------------------------------------------------*
FORM kdf_dynamics.
  DATA: rt_dyn_trange  TYPE rsds_trange.

  REFRESH: it_dyn_texpr.
* get report dynamic selections:
  CALL FUNCTION 'RS_REFRESH_FROM_DYNAMICAL_SEL'
    EXPORTING
      curr_report        = g_repid
      mode_write_or_move = 'M'
    IMPORTING
      p_trange           = rt_dyn_trange
    EXCEPTIONS
      not_found          = 1
      wrong_type         = 2
      OTHERS             = 3.
  IF sy-subrc NE 0.
    EXIT.
  ENDIF.
  DELETE rt_dyn_trange WHERE tablename NE 'BSID'.
  CALL FUNCTION 'FREE_SELECTIONS_RANGE_2_EX'
    EXPORTING
      field_ranges = rt_dyn_trange
    IMPORTING
      expressions  = it_dyn_texpr[].
* replace tablenames: customer -> vendor
  LOOP AT it_dyn_texpr.
    CASE it_dyn_texpr-tablename.
      WHEN 'KNA1'.
        it_dyn_texpr-tablename = 'LFA1'.
      WHEN 'KNB1'.
        it_dyn_texpr-tablename = 'LFB1'.
      WHEN 'BSID'.
        it_dyn_texpr-tablename = 'BSIK'.
      WHEN OTHERS.
        DELETE it_dyn_texpr.
        CONTINUE.
    ENDCASE.
    MODIFY it_dyn_texpr.
  ENDLOOP.

* create dummy if it_dyn_texpr is empty, due to technical reasons
* in LDB runtime environment (refresh DYN_SEL)
  READ TABLE it_dyn_texpr INDEX 1.
  IF sy-subrc NE 0.
    APPEND INITIAL LINE TO it_dyn_texpr.
  ENDIF.

ENDFORM.                               " KDF_DYNAMICS

*&---------------------------------------------------------------------*
*&      Form  DDF_DYNAMICS
*&---------------------------------------------------------------------*
FORM ddf_dynamics.
  DATA: rt_dyn_trange  TYPE rsds_trange,
        ls_expr        LIKE rsdsexpr.

  REFRESH: it_dyn_texpr,
           it_dyn_texpr-expr_tab.
* get report dynamic selections:
  CALL FUNCTION 'RS_REFRESH_FROM_DYNAMICAL_SEL'
    EXPORTING
      curr_report        = g_repid
      mode_write_or_move = 'M'
    IMPORTING
      p_trange           = rt_dyn_trange
    EXCEPTIONS
      not_found          = 1
      wrong_type         = 2
      OTHERS             = 3.
  IF sy-subrc > 1.
    EXIT.
  ENDIF.
  DELETE rt_dyn_trange WHERE tablename NE 'BSID'.
  CALL FUNCTION 'FREE_SELECTIONS_RANGE_2_EX'
    EXPORTING
      field_ranges = rt_dyn_trange
    IMPORTING
      expressions  = it_dyn_texpr[].
* add selection: items belonging to branch
  it_dyn_texpr-tablename = 'BSID'.
  ls_expr-fieldname = 'FILKD'.
  ls_expr-option    = 'EQ'.
  ls_expr-low       = it_central-branch.
  APPEND ls_expr TO it_dyn_texpr-expr_tab.
  APPEND it_dyn_texpr.

ENDFORM.                               " DDF_DYNAMICS

*&---------------------------------------------------------------------*
*&      Form  FILL_KDF_CALLBACK
*&---------------------------------------------------------------------*
FORM fill_kdf_callback.
  REFRESH: it_callback.

  it_callback-ldbnode = 'LFA1'.
  it_callback-get     = 'X'.
  it_callback-cb_prog = c_repid_ar.
  it_callback-cb_form = 'CB_KDF_GET_LFA1'.
  APPEND it_callback.

  it_callback-ldbnode = 'BSIK'.
  it_callback-get     = 'X'.
  it_callback-cb_prog = c_repid_ar.
  it_callback-cb_form = 'CB_KDF_GET_BSIK'.
  APPEND it_callback.
ENDFORM.                               " FILL_KDF_CALLBACK

*&---------------------------------------------------------------------*
*&      Form  FILL_DDF_CALLBACK
*&---------------------------------------------------------------------*
FORM fill_ddf_callback.
  REFRESH: it_callback.
  it_callback-ldbnode = 'KNA1'.
  it_callback-get     = 'X'.
  it_callback-cb_prog = c_repid_ar.
  it_callback-cb_form = 'CB_DDF_GET_KNA1'.
  APPEND it_callback.

  it_callback-ldbnode = 'BSID'.
  it_callback-get     = 'X'.
  it_callback-cb_prog = c_repid_ar.
  it_callback-cb_form = 'CB_DDF_GET_BSID'.
  APPEND it_callback.
ENDFORM.                               " FILL_DDF_CALLBACK

*&---------------------------------------------------------------------*
*&      Form  CB_KDF_GET_BSIK
*&---------------------------------------------------------------------*
FORM cb_kdf_get_bsik  USING  name     LIKE ldbn-ldbnode
                             ls_bsik  LIKE bsik
                             mode     TYPE c
                             selected TYPE c.
  bsik = ls_bsik.
  PERFORM pos_table_fill_vendor  CHANGING  x_stop.
ENDFORM.                               " CB_KDF_GET_BSIK

*&---------------------------------------------------------------------*
*&      Form  CB_DDF_GET_BSID
*&---------------------------------------------------------------------*
FORM cb_ddf_get_bsid  USING  name     LIKE ldbn-ldbnode
                             ls_bsid  LIKE bsid
                             mode     TYPE c
                             selected TYPE c.
  bsid = ls_bsid.

* HWAER would be filled incorrect in the case the IT_H_T001
* stands on the wrong entry
  IF bsid-bukrs <> it_h_t001-bukrs.
    READ TABLE it_h_t001 WITH KEY bukrs = bsid-bukrs.
  ENDIF.

* attention: change account number!!
  bsid-kunnr = bsid-filkd.
  PERFORM pos_table_fill  CHANGING  x_stop.
ENDFORM.                               " CB_DDF_GET_BSID

*&---------------------------------------------------------------------*
*&      Form  SET_ACCT_AND_CCODE
*&---------------------------------------------------------------------*
FORM set_acct_and_ccode.

  REFRESH: dd_kunnr, dd_bukrs, so_wlkun, so_wlbuk.
  CLEAR:   dd_kunnr, dd_bukrs, so_wlkun, so_wlbuk,
           pa_wlkun, pa_wlbuk.

  IF gd_wl_on IS INITIAL.
    GET PARAMETER ID 'KUN' FIELD dd_kunnr-low.
    IF sy-subrc = 0 AND NOT dd_kunnr-low IS INITIAL.
      dd_kunnr-sign   = 'I'.
      dd_kunnr-option = 'EQ'.
      APPEND dd_kunnr.
    ENDIF.
    GET PARAMETER ID 'BUK' FIELD dd_bukrs-low.
    IF sy-subrc = 0 AND NOT dd_bukrs-low IS INITIAL.
      dd_bukrs-sign   = 'I'.
      dd_bukrs-option = 'EQ'.
      APPEND dd_bukrs.
    ENDIF.
  ELSE.
*   worklists switched on:
    GET PARAMETER ID 'AVD' FIELD pa_wlkun.
    GET PARAMETER ID 'AVB' FIELD pa_wlbuk.
    IF pa_wlkun IS INITIAL.
      GET PARAMETER ID 'KUN' FIELD so_wlkun-low.
      IF sy-subrc = 0 AND NOT so_wlkun-low IS INITIAL.
        so_wlkun-sign   = 'I'.
        so_wlkun-option = 'EQ'.
        APPEND so_wlkun.
      ENDIF.
    ENDIF.
    IF pa_wlbuk IS INITIAL.
      GET PARAMETER ID 'BUK' FIELD so_wlbuk-low.
      IF sy-subrc = 0 AND NOT so_wlbuk-low IS INITIAL.
        so_wlbuk-sign   = 'I'.
        so_wlbuk-option = 'EQ'.
        APPEND so_wlbuk.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                               " SET_ACCT_AND_CCODE

*---------------------------------------------------------------------*
*       FORM CB_DDF_GET_LFA1                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  NAME                                                          *
*  -->  LS_LFA1                                                       *
*  -->  MODE                                                          *
*  -->  SELECTED                                                      *
*---------------------------------------------------------------------*
FORM cb_kdf_get_lfa1  USING  name     LIKE ldbn-ldbnode
                             ls_lfa1  LIKE lfa1
                             mode     TYPE c
                             selected TYPE c.

  DATA: ld_koart TYPE koart.

  lfa1 = ls_lfa1.
  ld_koart = 'K'.
  PERFORM t005_info_fill USING ld_koart.

ENDFORM.                    "CB_KDF_GET_LFA1

*---------------------------------------------------------------------*
*       FORM CB_DDF_GET_KNA1                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  NAME                                                          *
*  -->  LS_KNA1                                                       *
*  -->  MODE                                                          *
*  -->  SELECTED                                                      *
*---------------------------------------------------------------------*
FORM cb_ddf_get_kna1  USING  name     LIKE ldbn-ldbnode
                             ls_kna1  LIKE kna1
                             mode     TYPE c
                             selected TYPE c.

  DATA: ld_koart TYPE koart.

  kna1 = ls_kna1.
  ld_koart = 'D'.
  PERFORM t005_info_fill USING ld_koart.

ENDFORM.                    "CB_DDF_GET_KNA1

*&---------------------------------------------------------------------*
*&      Form  t005_info_fill
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM t005_info_fill USING ld_koart TYPE koart.

  IF ld_koart = 'D'.
    IF NOT kna1-land1 IS INITIAL.
      SELECT SINGLE * FROM t005 WHERE land1 = kna1-land1.
    ENDIF.
  ELSEIF ld_koart = 'K' .
    IF NOT lfa1-land1 IS INITIAL.
      SELECT SINGLE * FROM t005 WHERE land1 = lfa1-land1.
    ENDIF.
  ENDIF.

ENDFORM.                               " t005_info_fill

*&---------------------------------------------------------------------*
*&     Include RFITEM_INC
*&---------------------------------------------------------------------*
INCLUDE yse_rfitem_inc.
*include rfitem_inc.
*
*&---------------------------------------------------------------------*
*&      Form  GET_SP_DETAILS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_sp_details .
************************************************************************
*                     Types Declaration                                *
************************************************************************
  TYPES:BEGIN OF ty_bseg,
        bukrs TYPE bseg-bukrs,"Company Code
        belnr TYPE bseg-belnr,"Document Number
        gjahr TYPE bseg-gjahr,"Fiscal Year
        buzei TYPE bseg-buzei,"item
        vbeln TYPE bseg-vbeln,"Billing Document
        END OF ty_bseg.
  TYPES:BEGIN OF ty_vbpa,
        vbeln TYPE vbpa-vbeln,"Billing Document
        kunnr TYPE vbpa-kunnr,"Customer Number
        END OF ty_vbpa.
  TYPES:BEGIN OF ty_kna1,
        kunnr TYPE kna1-kunnr,"Customer Number
        name1 TYPE kna1-name1,"Customer Name
        END OF ty_kna1.
************************************************************************
*                 Internal table  Declaration                          *
************************************************************************
  DATA:lt_bseg TYPE STANDARD TABLE OF ty_bseg,"Internal table for BSEG data
       lt_vbpa TYPE STANDARD TABLE OF ty_vbpa,"Internal table for VBPA data
       lt_kna1 TYPE STANDARD TABLE OF ty_kna1."Internal table for KNA1 data
************************************************************************
*                 Field Symbols Declaraton                             *
************************************************************************
  FIELD-SYMBOLS:<ls_bseg> TYPE ty_bseg,"Local workarea for BSEG data
                <ls_vbpa> TYPE ty_vbpa,"Local Workarea for VBPA data
                <ls_kna1> TYPE ty_kna1,"Local workarea for KNA1 data
                <ls_pos>  TYPE yse_rfposxext."Final internal table
************************************************************************
*                 Constants Declaration                                *
************************************************************************
  CONSTANTS:c_sp TYPE parvw VALUE 'AG'."Sold-to-Party

*Get billing document
  IF NOT it_pos[] IS INITIAL.
    SELECT bukrs  "Company code
           belnr  "Document number
           gjahr  "Fiscal Year
           buzei  "item
           vbeln  "Billing document
           FROM bseg
           INTO TABLE lt_bseg
           FOR ALL ENTRIES IN it_pos
           WHERE bukrs EQ it_pos-bukrs
             AND belnr EQ it_pos-belnr
             AND gjahr EQ it_pos-gjahr
             AND buzei EQ it_pos-buzei.
  ENDIF.
*Get coustmer number(Sold-to-party)
  IF NOT lt_bseg[] IS INITIAL.
    SELECT vbeln  "Billing document
           kunnr  "Customer number
           FROM vbpa
           INTO TABLE lt_vbpa
           FOR ALL ENTRIES IN lt_bseg
           WHERE vbeln EQ lt_bseg-vbeln
             AND parvw EQ c_sp.
  ENDIF.
*Get customer details(Sold to party name)
  IF NOT lt_vbpa[] IS INITIAL.
    SELECT kunnr  "customer number
           name1  "customer name
           FROM kna1
           INTO TABLE lt_kna1
           FOR ALL ENTRIES IN lt_vbpa
           WHERE kunnr EQ lt_vbpa-kunnr.
  ENDIF.
*Sort the internal tables
  SORT lt_bseg BY bukrs belnr gjahr.
  SORT lt_vbpa BY vbeln kunnr.
  SORT lt_kna1 BY kunnr name1.
*Assign sold to party details to final internal table
  LOOP AT it_pos ASSIGNING <ls_pos>.
    UNASSIGN:<ls_bseg>.
    READ TABLE lt_bseg ASSIGNING <ls_bseg> WITH KEY bukrs = <ls_pos>-bukrs
                                                    belnr = <ls_pos>-belnr
                                                    gjahr = <ls_pos>-gjahr
                                                    buzei = <ls_pos>-buzei.
    IF sy-subrc EQ 0.
      UNASSIGN:<ls_vbpa>.
      READ TABLE lt_vbpa ASSIGNING <ls_vbpa> WITH KEY vbeln = <ls_bseg>-vbeln.
      IF sy-subrc EQ 0.
        UNASSIGN:<ls_kna1>.
        READ TABLE lt_kna1 ASSIGNING <ls_kna1> WITH KEY kunnr = <ls_vbpa>-kunnr.
        IF sy-subrc EQ 0.
          MOVE:<ls_kna1>-kunnr TO <ls_pos>-kunnr,
               <ls_kna1>-name1 TO <ls_pos>-sold_to_party.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.
  FREE:lt_bseg[],lt_vbpa[],lt_kna1[].
  UNASSIGN:<ls_bseg>,<ls_vbpa>,<ls_kna1>,<ls_pos>.
ENDFORM.                    " GET_SP_DETAILS

*Text symbol text
*001:List Output
*002:Status
*003:Open items
*004:Cleared items
*005:All items
*006:Type
*007:Line item selection
*008:Items. Selection continuing.....
*009:List being generated
*W01:Activate worklist
*W02:Customer
*W03:Company code

*W04:Deactivate worklist
*Selection text
*PA_NMAX:        Maximum number of items
*PA_STID2:        Open at key date
*PA_STIDA:        Open at key date
*PA_VARI:        Layout
*PA_WLBUK:        Company code worklist
*PA_WLKUN:        Customer worklist
*SO_AUGDT:        Clearing date
*SO_BUDAT:        Posting date
*SO_FAEDT:D       Net due date
*SO_WLBUK:        Or values
*SO_WLKUN:        Or values
*X_AISEL:        All items
*X_APAR:        Vendor items
*X_CLSEL:        Cleared items
*X_MERK:        Noted items
*X_NORM:        Normal items
*X_OPSEL:        Open items
*X_PARK:        Parked items
*X_SHBV:        Special G/L transactions
