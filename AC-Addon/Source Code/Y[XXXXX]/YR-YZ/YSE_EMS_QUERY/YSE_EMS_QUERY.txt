************************************************************************
* Program ID           : YAM_GTS_DOWNLOAD                              *
* Program Title        : A GTS report to store and query billing/VAT   *
*                        invoice/EMS information                       *
* Author               : Peter                                         *
* Date                 : 20/06/2011                                    *
* Change Request Number:CD1K965541                                     *
* Description          : A new report is required to store and query   *
*                        billing/VAT invoice/EMS information as below  *
*======================================================================*
* Copied From          : (Cloned Program)                              *
* Title                : (Program Title)                               *
* Other Related obj    : (Object names)                                *
*======================================================================*
* Change History Log                                                   *
*----------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number  | Change Reference *
*----------------------------------------------------------------------*
* MOD-001 |dd/mm/yyyy| xxxxxxxxxxxxxx | XXXXxxxxxx        |   XXXXxxxxxx      *
*                                                                      *
* Description:                                                         *
*----------------------------------------------------------------------*
* MOD-002 |dd/mm/yyyy| xxxxxxxxxxxxxx | XXXXxxxxxx                     *
*                                                                      *
* Description:                                                         *
************************************************************************

REPORT  YSE_EMS_EDIT
              NO STANDARD PAGE HEADING
              LINE-SIZE  132
              LINE-COUNT 65(2)
              MESSAGE-ID YSE_GTS.

*&---------------------------------------------------------------------*
*& Table DECLARATION
*&---------------------------------------------------------------------*
TABLES:
  YSE_GTS003,                                 "EMS
  BKPF,                                       "
  VBRK,
  VBAK.                                       "Sales Document: Header Data
*&---------------------------------------------------------------------*
*& Public clare
*&---------------------------------------------------------------------*
DATA: V_EMS TYPE CHAR20.
TYPE-POOLS: SLIS.
*&---------------------------------------------------------------------*
*& SCREEN
*&---------------------------------------------------------------------*
* Company code
PARAMETERS:P_BUKRS      TYPE T001-BUKRS OBLIGATORY.
* Year
SELECT-OPTIONS:S_GJAHR  FOR BKPF-GJAHR  NO-EXTENSION NO INTERVALS. "OBLIGATORY.
* VAT NO
SELECT-OPTIONS:S_VATNO  FOR YSE_GTS003-VATNO.
* Accounting number
SELECT-OPTIONS:S_BELNR  FOR BKPF-BELNR.
* Billing Number
SELECT-OPTIONS:S_RVBELN FOR VBAK-VBELN.
** Billing Date
*SELECT-OPTIONS:S_FKDAT  FOR VBRK-FKDAT.
* VAT invoice Date
SELECT-OPTIONS:S_FKDAT  FOR BKPF-AEDAT.
* SO Number
SELECT-OPTIONS:S_VBELN  FOR VBAK-VBELN.

* Sales Organization
SELECT-OPTIONS:S_VKORG  FOR VBAK-VKORG NO-EXTENSION NO INTERVALS.
* Distribution Channel
SELECT-OPTIONS:S_VTWEG  FOR VBAK-VTWEG NO-EXTENSION NO INTERVALS.
* Division
SELECT-OPTIONS:S_SPART  FOR VBAK-SPART NO-EXTENSION NO INTERVALS.
* Sold-to party
* customer
SELECT-OPTIONS:S_KUNNR  FOR VBAK-KUNNR.
* EMS number
SELECT-OPTIONS:S_EMS    FOR V_EMS.

*&---------------------------------------------------------------------*
*& CONSTANT DECLARATION
*&---------------------------------------------------------------------*
CONSTANTS:
  C_COMMAND     TYPE SLIS_FORMNAME
                  VALUE 'USER_COMMAND',       "'USER_COMMAND'
  C_PF_STATUS   TYPE SLIS_FORMNAME
                  VALUE 'ALV_SET_STATUS',     "ALV_SET_STATUS
  C_E           TYPE C VALUE 'E',             "E
  C_S           TYPE C VALUE 'S',             "S
  C_FLAG        TYPE C VALUE 'X'.
*&---------------------------------------------------------------------*
*& TYPE DECLARATION
*&---------------------------------------------------------------------*
TYPES: BEGIN OF TY_BKPF,
         BUKRS  TYPE BKPF-BUKRS,
         BELNR  TYPE BKPF-BELNR,
         GJAHR  TYPE BKPF-GJAHR,
         AEDAT  TYPE BKPF-AEDAT,
         AWKEY  TYPE VBRK-BELNR,
       END OF TY_BKPF.
TYPES: BEGIN OF TY_BILL,
         VBELN TYPE VBFA-VBELN,
         AWKEY TYPE BKPF-AWKEY,
       END OF TY_BILL.
TYPES: BEGIN OF TY_VBAK,
         VBELN   TYPE VBAK-VBELN,             "SO Number
         AUART   TYPE VBAK-AUART,             "SO Type
         VKORG   TYPE VBAK-VKORG,             "Sales Organization
         VTWEG   TYPE VBAK-VTWEG,             "Distribution Channel
         SPART   TYPE VBAK-SPART,             "Division
         VKBUR   TYPE VBAK-VKBUR,             "Sales office
         ERDAT   TYPE VBAK-ERDAT,             "SO creation Date
         ERNAM   TYPE VBAK-ERNAM,             "Created by
       END OF TY_VBAK.
TYPES: BEGIN OF TY_BSEG,
         BUKRS TYPE BSEG-BUKRS,
         BELNR TYPE BSEG-BELNR,
         GJAHR TYPE BSEG-GJAHR,
         ZUONR TYPE BSEG-ZUONR,
         KUNNR TYPE BSEG-KUNNR,
         LINFV TYPE BSEG-LINFV,
       END OF TY_BSEG.
TYPES: BEGIN OF TY_KUNNR,
         KUNNR TYPE KNA1-KUNNR,               "CUSTOMER
         ADRNR TYPE KNA1-ADRNR,               "ADDRESS NO
	  NAME1 TYPE ADRC-NAME1,               "CUSTOMER NAME
       END OF TY_KUNNR.
TYPES: BEGIN OF TY_ADDR,
         ADDRNUMBER TYPE ADRC-ADDRNUMBER,     "Bill-to party number
         NAME1      TYPE ADRC-NAME1,          "Name1
       END OF TY_ADDR.
TYPES: BEGIN OF TY_AUBEL,
         VBELN TYPE VBRP-VBELN,
         AUBEL TYPE VBRP-AUBEL,
       END OF TY_AUBEL.
TYPES: BEGIN OF TY_SKFBP,
         VBELN TYPE VBRP-VBELN,
         POSNR TYPE VBRP-POSNR,
         NETWR TYPE VBRP-NETWR,
         MWSBP TYPE VBRP-MWSBP,
       END OF TY_SKFBP.
TYPES: BEGIN OF TY_VBELN,
         VBELN TYPE VBRP-VBELN,
       END OF TY_VBELN.
TYPES: BEGIN OF TY_OUT,
         VATNO     TYPE YSE_GTS003-VATNO,       "VAT Invoice NO
         VATDATE   TYPE YSE_GTS003-VATDATE,   	"VAT invoice Date
         VATYPE    TYPE YSE_GTS003-VATYPE,    	"VAT TYPE
         VBELN     TYPE YSE_GTS003-VBELN,     	"Billing Document
         GJAHR     TYPE YSE_GTS003-GJAHR,     	"Fiscal Year
         BUKRS     TYPE YSE_GTS003-BUKRS,     	"Company Code
         NAME      TYPE YSE_GTS003-NAME,      	"Customer description
         AMOUT     TYPE YSE_GTS003-AMOUT,     	"Invoice amount (w tax)
         SONO      TYPE YSE_GTS003-SONO,      	"Sales Document
         ERNAM     TYPE YSE_GTS003-ERNAM,     	"SO create by
         REMARK    TYPE YSE_GTS003-REMARK,    	"Remark
         EXPDATE   TYPE YSE_GTS003-EXPDATE,   	"Express send date
         EXPNO     TYPE YSE_GTS003-EXPNO,     	"Express number
         VATRECDATE TYPE YSE_GTS003-VATRECDATE,"VAT Received date
         VATSNDATE TYPE YSE_GTS003-VATSNDATE, 	"Express sent date
         EXPNO1    TYPE YSE_GTS003-EXPNO1,    	"Express number
         EXPTYP    TYPE YSE_GTS003-EXPTYP,	"Express type(1.EMS 2.SALE 3.OTHERS)
       END OF TY_OUT.
*&---------------------------------------------------------------------*
*& INTERNAL TABLE DECLARATION
*&---------------------------------------------------------------------*
DATA:
  I_SKFBP    TYPE STANDARD TABLE OF TY_SKFBP,
  I_BSEG     TYPE STANDARD TABLE OF TY_BSEG,
  I_FCAT     TYPE SLIS_T_FIELDCAT_ALV,
  I_BILL     TYPE STANDARD TABLE OF TY_BILL,
  I_ADDR     TYPE STANDARD TABLE OF TY_ADDR,
  I_VBAK     TYPE STANDARD TABLE OF TY_VBAK,
  I_AUBEL    TYPE STANDARD TABLE OF TY_AUBEL,
  I_KUNNR    TYPE STANDARD TABLE OF TY_KUNNR,
  I_ADDON_OUT TYPE STANDARD TABLE OF YSE_GTS003,
  I_OUT      TYPE STANDARD TABLE OF YSE_GTS003,
  I_BKPF     TYPE STANDARD TABLE OF TY_BKPF.
*&---------------------------------------------------------------------*
*& VARIANT DECLARATION
*&---------------------------------------------------------------------*
DATA:
*Global Variant
  FLG_STOP   TYPE C,
*Transfer record
  REC_BKPF     TYPE  TY_BKPF,
  REC_AUBEL    TYPE  TY_AUBEL,
  REC_BILL     TYPE  TY_BILL,
  REC_VBAK     TYPE  TY_VBAK,
  REC_KUNNR    TYPE  TY_KUNNR,
  REC_ADDR     TYPE  TY_ADDR,
  REC_SKFBP    TYPE  TY_SKFBP,
  REC_OUT      TYPE  YSE_GTS003,
  REC_ADDON_OUT TYPE  YSE_GTS003,
  REC_BSEG     TYPE  TY_BSEG.
*----------------------------------------------------------------------*
*       AT SELECTION-SCREEN                                            *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
* Company code Check
  PERFORM CHECK_BUKRS     USING P_BUKRS.
* Authority check
  PERFORM AUTHORITY_CHECK.
*&---------------------------------------------------------------------*
*&      START-OF-SELECTION
*&---------------------------------------------------------------------*
START-OF-SELECTION.

*  DELETE FROM YSE_GTS003.
*  COMMIT WORK.
*>>20110811
* IF S_BELNR IS NOT INITIAL   "Accounting number
*   OR S_RVBELN IS NOT INITIAL "Billing Number
*   OR S_FKDAT IS NOT INITIAL."Billing Date
*<<20110811
* fetch billing from so
*    PERFORM GET_BILL.
*    IF S_VATNO IS INITIAL.
**     fetch data from gts003
*      PERFORM GET_GTS003.
**    fetch object data from bkpf
*      PERFORM GET_BKPF.
**    fetch object data from bseg
*      PERFORM GET_BSEG.
*    ELSEIF S_VATNO IS NOT INITIAL.
**     VAT invoice Date
*      IF S_FKDAT IS INITIAL.
***       fetch data from gts003
**        PERFORM GET_GTS003.
***      fetch object data from bseg
**        PERFORM GET_BSEG2.
***      fetch object data from bkpf
**        PERFORM GET_BKPF2.
**       fetch data from gts003
*        PERFORM GET_GTS003.
**      fetch object data from bseg
*        PERFORM GET_BSEG1.
**      fetch object data from bkpf
*        PERFORM GET_BKPF1.
*      ELSE.
**       fetch data from gts003
*        PERFORM GET_GTS003.
**      fetch object data from bkpf
*        PERFORM GET_BKPF.
**      fetch object data from bseg
*        PERFORM GET_BSEG.
*      ENDIF.
*    ENDIF.
*
*>>20110811
* ELSE.
**   fetch data from gts003
*    PERFORM GET_GTS003.
**  fetch object data from bseg
*    PERFORM GET_BSEG1.
**  fetch object data from bkpf
*    PERFORM GET_BKPF1.
* ENDIF.
*<<20110811
*edit data
*  PERFORM EDIT_DATA.
**Combination two table
*  PERFORM COMB_DATA.
*get data
  PERFORM GET_DATA.
* ALV display
  PERFORM ALV_SHOW.

*----------------------------------------------------------------------*
* Form CHECK_BUKRS                                                     *
*----------------------------------------------------------------------*
* This form is to  check company code                                  *
*----------------------------------------------------------------------*
* Parameters / Tables:                                                 *
* -->  I_BUKRS   company code                                          *
*----------------------------------------------------------------------*
FORM CHECK_BUKRS USING  I_BUKRS.

  DATA: WL_BUKRS TYPE T001-BUKRS.
  SELECT SINGLE BUKRS
           INTO WL_BUKRS
           FROM T001
          WHERE BUKRS = I_BUKRS.
  IF SY-SUBRC <> 0.
*Company code doesn't exsit
    MESSAGE S001 WITH P_BUKRS.
    SET CURSOR FIELD 'P_BUKRS'.
  ENDIF.

ENDFORM.                    " CHECK_BUKRS
*----------------------------------------------------------------------*
* Form AUTHORITY_CHECK                                                 *
*----------------------------------------------------------------------*
* This form is to check user authority                                *
*----------------------------------------------------------------------*
FORM AUTHORITY_CHECK.

  AUTHORITY-CHECK OBJECT 'YAM_BB_VKO'
           ID 'VKORG' FIELD S_VKORG-LOW
*           ID 'VTWEG' FIELD S_VTWEG
*           ID 'SPART' FIELD S_SPART
           ID 'ACTVT' FIELD '16'.

  IF SY-SUBRC <> 0.
* No authorization
    MESSAGE E005 WITH S_VKORG-LOW.
  ENDIF.

ENDFORM.                    " AUTHORITY_CHECK
*&---------------------------------------------------------------------*
*& Form  GET_BKPF
*&---------------------------------------------------------------------*
*  This form  is to fetch object data from bkpf
*----------------------------------------------------------------------*
FORM GET_BKPF .

  SELECT BUKRS
         BELNR
         GJAHR
         AEDAT
         AWKEY
    INTO TABLE I_BKPF
    FROM BKPF
     FOR ALL ENTRIES IN I_BILL
   WHERE BUKRS = P_BUKRS
     AND BELNR IN S_BELNR
*     AND BUDAT IN S_FKDAT
     AND AEDAT IN S_FKDAT "change date
     AND BLART = 'RV'
     AND AWTYP = 'VBRK'
*     AND BELNR = I_BSEG-BELNR
     AND AWKEY IN S_RVBELN
     AND AWKEY = I_BILL-AWKEY
     AND AEDAT <> '00000000'
     AND GJAHR IN S_GJAHR.
  IF SY-SUBRC <> 0.
    FLG_STOP = C_FLAG.
* No Data
    MESSAGE S000 WITH TEXT-S01.
  ENDIF.

ENDFORM.                    " GET_BKPF
*&---------------------------------------------------------------------*
*& Form  GET_BSEG
*&---------------------------------------------------------------------*
*  This form is to fetch data from bseg
*----------------------------------------------------------------------*
FORM GET_BSEG .

  IF I_BKPF IS NOT INITIAL.

    SELECT BUKRS
         BELNR
         GJAHR
         ZUONR
         KUNNR
         LINFV
    INTO TABLE I_BSEG
    FROM BSEG
         FOR ALL ENTRIES IN I_BKPF
   WHERE ZUONR IN S_VATNO                     "VAT Invoice NO:
     AND BUKRS = P_BUKRS
     AND GJAHR IN S_GJAHR
     AND BUZEI = '001'
     AND BELNR = I_BKPF-BELNR
*     AND BELNR IN S_BELNR
     AND KUNNR IN S_KUNNR.
    IF SY-SUBRC <> 0.
      FLG_STOP = C_FLAG.
*   No Data
      MESSAGE S000 WITH TEXT-S01.
    ENDIF.
  ENDIF.

ENDFORM.                    " GET_BSEG
*&---------------------------------------------------------------------*
*& Form  EDIT_DATA
*&---------------------------------------------------------------------*
*  This form is to edit data
*----------------------------------------------------------------------*
FORM EDIT_DATA .

DATA:LI_VBELN   TYPE RANGE OF VBRP-VBELN,
     LREC_VBELN LIKE LINE  OF LI_VBELN,
     LI_VBAK    TYPE STANDARD TABLE OF TY_VBAK,
     LREC_VBAK  TYPE TY_VBAK,
     LI_SKFBP   TYPE STANDARD TABLE OF TY_SKFBP,
     LREC_SKFBP TYPE  TY_SKFBP.
  IF I_BSEG IS NOT INITIAL.
    SELECT KUNNR
           ADRNR
      INTO TABLE I_KUNNR
      FROM KNA1
           FOR ALL ENTRIES IN I_BSEG
     WHERE KUNNR = I_BSEG-KUNNR.
  ENDIF.
  IF I_KUNNR IS NOT INITIAL.
    SELECT ADDRNUMBER
           NAME1                              "Name1
      INTO TABLE I_ADDR
      FROM ADRC
           FOR ALL ENTRIES IN I_KUNNR
     WHERE ADDRNUMBER = I_KUNNR-ADRNR       "Bill-to party number
       AND NATION = 'C'.
  ENDIF.

  LOOP AT I_KUNNR INTO REC_KUNNR.
    READ TABLE I_ADDR INTO REC_ADDR
           WITH KEY ADDRNUMBER = REC_KUNNR-ADRNR.
    IF SY-SUBRC = 0.
      REC_KUNNR-NAME1 = REC_ADDR-NAME1.
      MODIFY I_KUNNR FROM REC_KUNNR TRANSPORTING NAME1.
    ENDIF.
  ENDLOOP.
*Billing no.
*  LOOP AT I_BKPF INTO REC_BKPF.
*    LREC_VBELN-SIGN   = 'I'.
*    LREC_VBELN-OPTION = 'EQ'.
*    LREC_VBELN-LOW    = REC_BKPF-XBLNR+0(10).
*    COLLECT LREC_VBELN INTO LI_VBELN.
*  ENDLOOP.
*Invoice sum amount (w tax)
  IF I_BKPF IS NOT INITIAL.
    SELECT VBELN
           POSNR
           NETWR
           MWSBP
      INTO TABLE I_SKFBP
      FROM VBRP
           FOR ALL ENTRIES IN I_BKPF
*     WHERE VBELN IN LI_VBELN.           "billing  no.
      WHERE VBELN = I_BKPF-AWKEY.
*  Sales Document
    SELECT VBELN
           AUBEL                              "SO
      INTO TABLE I_AUBEL
      FROM VBRP
           FOR ALL ENTRIES IN I_BKPF
*     WHERE VBELN IN LI_VBELN.                   "billing no
      WHERE VBELN = I_BKPF-AWKEY.
  ENDIF.

  LOOP AT I_SKFBP INTO REC_SKFBP.
    CLEAR REC_SKFBP-POSNR.
    COLLECT REC_SKFBP INTO LI_SKFBP.
  ENDLOOP.
  FREE I_SKFBP.
  IF I_AUBEL IS NOT INITIAL.
    SELECT VBELN                              "SO Number
           AUART                              "SO Type
           VKORG                              "Sales Organization
           VTWEG                              "Distribution Channel
           SPART                              "Division
           VKBUR                              "Sales office
           ERDAT                              "SO creation Date
           ERNAM                              "Created by
      INTO TABLE LI_VBAK
      FROM VBAK
           FOR ALL ENTRIES IN I_AUBEL
     WHERE VBELN = I_AUBEL-AUBEL             "SO Document
       AND VKORG IN S_VKORG
       AND VTWEG IN S_VTWEG
       AND SPART IN S_SPART.
  ENDIF.

  LOOP AT I_BKPF INTO REC_BKPF.
    CLEAR REC_VBAK.
    CLEAR REC_OUT.
    READ TABLE I_BSEG INTO REC_BSEG
                 WITH KEY BUKRS = REC_BKPF-BUKRS
                          GJAHR = REC_BKPF-GJAHR
                          BELNR = REC_BKPF-BELNR.

    IF SY-SUBRC = 0.
*VAT Invoice NO
      REC_OUT-VATNO     = REC_BSEG-ZUONR.
*VAT invoice Date,
      REC_OUT-VATDATE = REC_BKPF-AEDAT.
      IF REC_OUT-VATDATE IS INITIAL.
        CLEAR REC_OUT-VATNO.
      ENDIF.
*Billing Document
      REC_OUT-VBELN  = REC_BKPF-AWKEY.
*  Customer NO
      REC_OUT-KUNNR = REC_BSEG-KUNNR.
    ENDIF.
*FI document
    REC_OUT-BELNR = REC_BKPF-BELNR.
*VAT TYPE
    REC_OUT-VATYPE = TEXT-V01.               "ÆÕÆ±
*Fiscal Year
    REC_OUT-GJAHR = REC_BKPF-GJAHR.
*Company Code
    REC_OUT-BUKRS = REC_BKPF-BUKRS.

*Customer description
    READ TABLE I_KUNNR  INTO REC_KUNNR
                WITH KEY KUNNR = REC_BSEG-KUNNR.
    IF SY-SUBRC = 0.
      REC_OUT-NAME = REC_KUNNR-NAME1.
    ENDIF.
*Invoice amount (w tax)
*    SELECT SUM( SKFBP )
*      INTO REC_OUT-AMOUT
*      FROM VBRP
*     WHERE VBELN = REC_BKPF-XBLNR.           "billing  no.

    READ TABLE LI_SKFBP INTO LREC_SKFBP
           WITH KEY VBELN = REC_BKPF-AWKEY.
    IF SY-SUBRC = 0.
      REC_OUT-AMOUT = LREC_SKFBP-NETWR
                    + LREC_SKFBP-MWSBP.
    ENDIF.
*Sales Document
*    SELECT AUBEL                              "SO
*      INTO REC_VBAK-VBELN
*           UP TO 1 ROWS
*      FROM VBRP
*     WHERE VBELN = REC_BKPF-XBLNR.            "billing no.
*    ENDSELECT.
    READ TABLE I_AUBEL INTO REC_AUBEL
           WITH KEY VBELN = REC_BKPF-AWKEY.   "billing no.
    IF SY-SUBRC = 0.
      REC_VBAK-VBELN = REC_AUBEL-AUBEL.
    ENDIF.
*    SELECT SINGLE VBELN                       "SO Number
*           AUART                              "SO Type
*           VKORG                              "Sales Organization
*           VTWEG                              "Distribution Channel
*           SPART                              "Division
*           VKBUR                              "Sales office
*           ERDAT                              "SO creation Date
*           ERNAM                              "Created by
*      INTO REC_VBAK
*      FROM VBAK
*     WHERE VBELN = REC_VBAK-VBELN             "SO Document
*       AND VKORG IN S_VKORG
*       AND VTWEG IN S_VTWEG
*       AND SPART IN S_SPART.
    READ TABLE LI_VBAK INTO LREC_VBAK
           WITH KEY VBELN = REC_VBAK-VBELN.
    IF SY-SUBRC = 0.
      REC_OUT-SONO = LREC_VBAK-VBELN.
*  SO create by
      REC_OUT-ERNAM = LREC_VBAK-ERNAM.
*  Remark
      REC_OUT-REMARK = ''.
*  Express send date
      REC_OUT-EXPDATE = ''.
*  Express number
      REC_OUT-EXPNO = ''.
*  VAT Received date
      REC_OUT-VATRECDATE = ''.
*  Express sent date
      REC_OUT-VATSNDATE = ''.
*  Express number
      REC_OUT-EXPNO1 =  ''.

    ENDIF.
*Express type(1.EMS 2.SALE 3.OTHERS)
    REC_OUT-EXPTYP =  ''.
    CLEAR REC_OUT-BOX.
    APPEND REC_OUT TO I_OUT.
  ENDLOOP.

ENDFORM.                    " EDIT_DATA
*&---------------------------------------------------------------------*
*& Form  ALV_SHOW
*&---------------------------------------------------------------------*
*  This form is to display ALV
*----------------------------------------------------------------------*
FORM ALV_SHOW .

* specify ALV fields
  PERFORM SET_FIELDCAT.
* output ALV
  PERFORM ALV_OUTPUT.

ENDFORM.                    " ALV_SHOW

*&---------------------------------------------------------------------*
*& Form  SET_FIELDCAT
*&---------------------------------------------------------------------*
*  This form is to specify ALV fields
*----------------------------------------------------------------------*
FORM SET_FIELDCAT .

  DATA:
    L_FCAT  TYPE SLIS_FIELDCAT_ALV.

  REFRESH I_FCAT.

*  CLEAR L_FCAT.
*  L_FCAT-CHECKBOX  = C_FLAG.
*  L_FCAT-FIX_COLUMN = C_FLAG.
*  L_FCAT-FIELDNAME = 'BOX'.                   "BOX
*  L_FCAT-SELTEXT_L = TEXT-H00.                "Select
*  L_FCAT-HOTSPOT   = C_FLAG.
*  APPEND L_FCAT TO I_FCAT.
*
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'VATNO'.
*  L_FCAT-SELTEXT_L = TEXT-H01.                "VAT Invoice NO
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'VATDATE'.
*  L_FCAT-SELTEXT_L = TEXT-H02.                "VAT invoice Date
*  APPEND L_FCAT TO I_FCAT.
*
**  CLEAR L_FCAT.
**  L_FCAT-EDIT      = C_FLAG.                  "X
**  L_FCAT-FIELDNAME = 'VATYPE'.
**  L_FCAT-SELTEXT_L = TEXT-H03.                "VAT TYPE
**  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'VBELN'.
*  L_FCAT-SELTEXT_L = TEXT-H04.                "SAP INVOICE
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'GJAHR'.
*  L_FCAT-SELTEXT_L = TEXT-H05.                "Fiscal Year
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'BUKRS'.
*  L_FCAT-SELTEXT_L = TEXT-H06.                "Company Code
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'BELNR'.
*  L_FCAT-SELTEXT_L = TEXT-H19.                "Accounting Document
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'KUNNR'.
*  L_FCAT-SELTEXT_L = TEXT-H18.                "Customer code
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'NAME'.
*  L_FCAT-SELTEXT_L = TEXT-H07.                "customer name
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'AMOUT'.
*  L_FCAT-SELTEXT_L = TEXT-H08.                "Invoice amount (w tax)
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'SONO'.
*  L_FCAT-SELTEXT_L = TEXT-H09.                "So number
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-FIELDNAME = 'ERNAM'.
*  L_FCAT-SELTEXT_L = TEXT-H10.                "SO create by
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-FIELDNAME = 'REMARK'.
*  L_FCAT-SELTEXT_L = TEXT-H11.                "Remark
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-REF_FIELDNAME = 'BUDAT'.
*  L_FCAT-REF_TABNAME = 'BKPF'.
*  L_FCAT-FIELDNAME = 'EXPDATE'.
*  L_FCAT-outputlen = '20'.
*  L_FCAT-SELTEXT_S = TEXT-H12.                "Express send date
*  L_FCAT-SELTEXT_M = TEXT-H12.                "Express send date
*  L_FCAT-SELTEXT_L = TEXT-H12.                "Express send date
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-FIELDNAME = 'EXPNO'.
*  L_FCAT-SELTEXT_L = TEXT-H13.                "Express number
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-outputlen = '100'.
*  L_FCAT-SELTEXT_S = TEXT-H14.                "VAT Received date
*  L_FCAT-SELTEXT_M = TEXT-H14.                "VAT Received date
*  L_FCAT-SELTEXT_L = TEXT-H14.                "VAT Received date
*  L_FCAT-REF_FIELDNAME = 'BUDAT'.
*  L_FCAT-REF_TABNAME = 'BKPF'.
*  L_FCAT-FIELDNAME = 'VATRECDATE'.
*
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-REF_FIELDNAME = 'BUDAT'.
*  L_FCAT-REF_TABNAME = 'BKPF'.
*  L_FCAT-FIELDNAME = 'VATSNDATE'.
*  L_FCAT-outputlen = '50'.
*  L_FCAT-SELTEXT_L = TEXT-H15.                "Express sent date(to customer)
*  L_FCAT-SELTEXT_S = TEXT-H15.                "Express sent date(to customer)
*  L_FCAT-SELTEXT_M = TEXT-H15.                "Express sent date(to customer)
*  L_FCAT-SELTEXT_L = TEXT-H15.                "Express sent date(to customer)
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-FIELDNAME = 'EXPNO1'.
*  L_FCAT-SELTEXT_L = TEXT-H16.                "Express number
*  APPEND L_FCAT TO I_FCAT.
*
*  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
*  L_FCAT-FIELDNAME = 'EXPTYP'.
**  L_FCAT-REF_FIELDNAME = 'EXPTYP'.
*  L_FCAT-SELTEXT_L = TEXT-H17.                "Express type(1.EMS 2.SALE 3.OTHERS)
*  APPEND L_FCAT TO I_FCAT.


*  CLEAR L_FCAT.
*  L_FCAT-CHECKBOX  = C_FLAG.
*  L_FCAT-FIX_COLUMN = C_FLAG.
*  L_FCAT-FIELDNAME = 'BOX'.                   "BOX
*  L_FCAT-SELTEXT_L = TEXT-H00.                "Select
*  L_FCAT-HOTSPOT   = C_FLAG.
*  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'BUKRS'.
  L_FCAT-SELTEXT_L = TEXT-H06.                "Company Code
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'VATNO'.
  L_FCAT-SELTEXT_L = TEXT-H01.                "VAT Invoice NO
  APPEND L_FCAT TO I_FCAT.


  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'VATDATE'.
  L_FCAT-SELTEXT_L = TEXT-H02.                "VAT invoice Date
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'BELNR'.
  L_FCAT-SELTEXT_L = TEXT-H19.                "Accounting Document
  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'GJAHR'.
  L_FCAT-SELTEXT_L = TEXT-H05.                "Fiscal Year
  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'NAME'.
  L_FCAT-SELTEXT_L = TEXT-H07.                "customer name
  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'KUNNR'.
  L_FCAT-SELTEXT_L = TEXT-H18.                "Customer code
  APPEND L_FCAT TO I_FCAT.


  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'SONO'.
  L_FCAT-SELTEXT_L = TEXT-H09.                "So number
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'AMOUT'.
  L_FCAT-SELTEXT_L = TEXT-H08.                "Invoice amount (w tax)
  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'ERNAM'.
  L_FCAT-SELTEXT_L = TEXT-H10.                "SO create by
  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-FIELDNAME = 'REMARK'.
  L_FCAT-SELTEXT_L = TEXT-H11.                "Remark
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-REF_FIELDNAME = 'BUDAT'.
  L_FCAT-REF_TABNAME = 'BKPF'.
  L_FCAT-FIELDNAME = 'EXPDATE'.
  L_FCAT-outputlen = '20'.
  L_FCAT-SELTEXT_S = TEXT-H12.                "Express send date
  L_FCAT-SELTEXT_M = TEXT-H12.                "Express send date
  L_FCAT-SELTEXT_L = TEXT-H12.                "Express send date
  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-FIELDNAME = 'EXPNO'.
  L_FCAT-outputlen = '15'.
  L_FCAT-SELTEXT_L = TEXT-H13.                "Express number
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-outputlen = '100'.
  L_FCAT-SELTEXT_S = TEXT-H14.                "VAT Received date
  L_FCAT-SELTEXT_M = TEXT-H14.                "VAT Received date
  L_FCAT-SELTEXT_L = TEXT-H14.                "VAT Received date
  L_FCAT-REF_FIELDNAME = 'BUDAT'.
  L_FCAT-REF_TABNAME = 'BKPF'.
  L_FCAT-FIELDNAME = 'VATRECDATE'.

  APPEND L_FCAT TO I_FCAT.

  CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-REF_FIELDNAME = 'BUDAT'.
  L_FCAT-REF_TABNAME = 'BKPF'.
  L_FCAT-FIELDNAME = 'VATSNDATE'.
  L_FCAT-outputlen = '50'.
  L_FCAT-SELTEXT_L = TEXT-H15.                "Express sent date(to customer)
  L_FCAT-SELTEXT_S = TEXT-H15.                "Express sent date(to customer)
  L_FCAT-SELTEXT_M = TEXT-H15.                "Express sent date(to customer)
  L_FCAT-SELTEXT_L = TEXT-H15.                "Express sent date(to customer)
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-FIELDNAME = 'EXPNO1'.
  L_FCAT-outputlen = '15'.
  L_FCAT-SELTEXT_L = TEXT-H16.                "Express number
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
*  L_FCAT-EDIT      = C_FLAG.                  "X
  L_FCAT-FIELDNAME = 'EXPTYP'.
*  L_FCAT-REF_FIELDNAME = 'EXPTYP'.
  L_FCAT-SELTEXT_L = TEXT-H17.                "Express type(1.EMS 2.SALE 3.OTHERS)
  APPEND L_FCAT TO I_FCAT.

    CLEAR L_FCAT.
  L_FCAT-FIELDNAME = 'VBELN'.
  L_FCAT-SELTEXT_L = TEXT-H04.                "SAP INVOICE
  APPEND L_FCAT TO I_FCAT.

ENDFORM.                    " SET_FIELDCAT
*&---------------------------------------------------------------------*
*& Form  ALV_OUTPUT
*&---------------------------------------------------------------------*
*  This form is to output ALV
*----------------------------------------------------------------------*
FORM   ALV_OUTPUT .

  DATA: L_REPID     LIKE SYST-REPID,          "Temp ABAP program
        L_LAYOUT    TYPE SLIS_LAYOUT_ALV.
  DATA: LREC_EVENTS TYPE SLIS_ALV_EVENT,
        LI_EVENTS   LIKE TABLE OF LREC_EVENTS.


  LREC_EVENTS-NAME = SLIS_EV_DATA_CHANGED.
  LREC_EVENTS-FORM = 'DATA_CHANGE'.
  APPEND LREC_EVENTS TO LI_EVENTS.

  L_REPID  = SY-REPID.                        "ABAP program

  L_LAYOUT-COLWIDTH_OPTIMIZE = C_FLAG.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      I_CALLBACK_PROGRAM       = L_REPID      "Temp ABAP program
      I_CALLBACK_USER_COMMAND  = C_COMMAND
      IT_EVENTS                = LI_EVENTS
      I_CALLBACK_PF_STATUS_SET = C_PF_STATUS
      IT_FIELDCAT              = I_FCAT       "Fieldcat
      IS_LAYOUT                = L_LAYOUT
    TABLES
      T_OUTTAB                 = I_OUT.

ENDFORM.                    " ALV_OUTPUT
*&---------------------------------------------------------------------*
*& Form  DATA_CHANGE
*&---------------------------------------------------------------------*
*  This form is to fetch the changed field in alv
*----------------------------------------------------------------------*
*  -->RR_DATA_CHANGED TYPE REF TO CL_ALV_CHANGED_DATA_PROTOCOL
*----------------------------------------------------------------------*
FORM DATA_CHANGE USING RR_DATA_CHANGED TYPE REF TO
                         CL_ALV_CHANGED_DATA_PROTOCOL.

  DATA: L_MOD_CELLS TYPE LVC_S_MODI.

  LOOP AT RR_DATA_CHANGED->MT_GOOD_CELLS INTO L_MOD_CELLS.
    CASE L_MOD_CELLS-FIELDNAME.

       WHEN 'BOX'.

*          READ TABLE I_OUT INTO REC_OUT INDEX L_MOD_CELLS-ROW_ID.
          REC_OUT-BOX = 'X'.
           MODIFY I_OUT FROM REC_OUT  INDEX L_MOD_CELLS-ROW_ID.
**Unit
*      WHEN C_UNIT.
*        IF L_MOD_CELLS-VALUE <> SPACE.
*          CLEAR:REC_DATA.
*          READ TABLE I_DATA INTO REC_DATA INDEX L_MOD_CELLS-ROW_ID.
*          REC_DATA-UNIT = L_MOD_CELLS-VALUE.
*          MODIFY I_DATA FROM REC_DATA
*                   TRANSPORTING UNIT
*                   WHERE VBELN = REC_DATA-VBELN.
*        ENDIF.
**Material Desciption
*      WHEN C_ARKTX.
*        IF L_MOD_CELLS-VALUE <> SPACE.
*          CLEAR:REC_DATA.
*          READ TABLE I_DATA INTO REC_DATA INDEX L_MOD_CELLS-ROW_ID.
*          REC_DATA-ARKTX = L_MOD_CELLS-VALUE.
*          MODIFY I_DATA FROM REC_DATA
*                   TRANSPORTING ARKTX
*                   WHERE VBELN = REC_DATA-VBELN.
*        ENDIF.
**Tax Amount
*      WHEN C_MWSBP.
*        IF L_MOD_CELLS-VALUE <> SPACE.
*          CLEAR:REC_DATA.
*          READ TABLE I_DATA INTO REC_DATA INDEX L_MOD_CELLS-ROW_ID.
*          REC_DATA-MWSBP = L_MOD_CELLS-VALUE.
*          MODIFY I_DATA FROM REC_DATA
*                   TRANSPORTING MWSBP
*                   WHERE VBELN = REC_DATA-VBELN.
*        ENDIF.
    ENDCASE.
  ENDLOOP.

ENDFORM.                    "DATA_CHANGE
*&---------------------------------------------------------------------*
*& Form  ALV_SET_STATUS
*&---------------------------------------------------------------------*
*  This form is to SET PF-STATUS
*----------------------------------------------------------------------*
*  --->I_EXTAB TOOLBAR
*----------------------------------------------------------------------*
FORM ALV_SET_STATUS USING I_EXTAB TYPE SLIS_T_EXTAB.

  SET PF-STATUS '9000'.

ENDFORM.                    " ALV_SET_STATUS
*&---------------------------------------------------------------------*
*& Form  USER_COMMAND
*&---------------------------------------------------------------------*
*  This form is to request alv command
*----------------------------------------------------------------------*
*  -->I_R_UCOMM  COMMAND CODE
*  -->I_RS_SELFIELD FIELDCAT
*----------------------------------------------------------------------*
FORM USER_COMMAND USING I_UCOMM LIKE SY-UCOMM
                        I_SELFIELD TYPE SLIS_SELFIELD.


  DATA:
    L_STBL     TYPE LVC_S_STBL,
    L_GRID1    TYPE REF TO CL_GUI_ALV_GRID.
  CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR'
    IMPORTING
      E_GRID = L_GRID1.

  CASE I_UCOMM.
*SELECT
    WHEN '&IC1'.
      IF I_SELFIELD-FIELDNAME = 'BOX'.
        CLEAR:REC_OUT.
        READ TABLE I_OUT INTO REC_OUT INDEX I_SELFIELD-TABINDEX.
        IF REC_OUT-BOX = C_FLAG.
          REC_OUT-BOX = SPACE.
        ELSE.
          REC_OUT-BOX = C_FLAG.
        ENDIF.
        MODIFY I_OUT FROM REC_OUT INDEX I_SELFIELD-TABINDEX
                 TRANSPORTING BOX.
      ENDIF.
*SAVE
    WHEN '&DATA_SAVE'.
*update db
      PERFORM UPDATE_DB.
    WHEN '&BEXP'.
       LOOP AT I_OUT INTO REC_OUT
                 WHERE BOX = 'X'.
         REC_OUT-EXPTYP = 'EXPRESS'.
         MODIFY I_OUT FROM REC_OUT TRANSPORTING EXPTYP.
       ENDLOOP.
    WHEN '&BEMS'.
       LOOP AT I_OUT INTO REC_OUT
                 WHERE BOX = 'X'.
         REC_OUT-EXPTYP = 'EMS'.
         MODIFY I_OUT FROM REC_OUT TRANSPORTING EXPTYP.
       ENDLOOP.
    WHEN '&BSALES'.
       LOOP AT I_OUT INTO REC_OUT
                 WHERE BOX = 'X'.
         REC_OUT-EXPTYP = 'SALES'.
         MODIFY I_OUT FROM REC_OUT TRANSPORTING EXPTYP.
       ENDLOOP.
    WHEN '&BOTHER'.
       LOOP AT I_OUT INTO REC_OUT
                WHERE BOX = 'X'.
         REC_OUT-EXPTYP = 'OTHER'.
         MODIFY I_OUT FROM REC_OUT TRANSPORTING EXPTYP.
       ENDLOOP.
*SELECT ALL
    WHEN '&BALL'.
      CLEAR: REC_OUT.
      REC_OUT-BOX = C_FLAG.
      MODIFY I_OUT FROM REC_OUT TRANSPORTING BOX
               WHERE BOX IS INITIAL.
*CANCEL ALL
    WHEN '&BSAL'.
      CLEAR: REC_OUT.
      REC_OUT-BOX = SPACE.
      MODIFY I_OUT FROM REC_OUT TRANSPORTING BOX
               WHERE BOX IS NOT INITIAL.
  ENDCASE.
  L_STBL-ROW = C_FLAG.
  L_STBL-COL = C_FLAG.
  CALL METHOD L_GRID1->REFRESH_TABLE_DISPLAY
    EXPORTING
      IS_STABLE = L_STBL.

ENDFORM.                    "USER_COMMAND
*&---------------------------------------------------------------------*
*&  Form  UPDATE_DB
*&---------------------------------------------------------------------*
*   This form is to update db
*----------------------------------------------------------------------*
FORM UPDATE_DB .

*Lock table
  DO 10 TIMES.
    CALL FUNCTION 'ENQUEUE_EYSE_GTS003'
      EXPORTING
        MODE_YSE_GTS003      = C_E
      EXCEPTIONS
        FOREIGN_LOCK         = 1
        SYSTEM_FAILURE       = 2
        OTHERS               = 3
                .
    IF SY-SUBRC <> 0.
      WAIT UP TO 1 SECONDS.
    ENDIF.
  ENDDO.
*LOCK failed
  IF SY-SUBRC <> 0.
    FLG_STOP = C_FLAG.
    MESSAGE ID SY-MSGID TYPE C_S NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.
  CHECK FLG_STOP IS INITIAL.
  MODIFY YSE_GTS003 FROM TABLE I_OUT.
  IF SY-SUBRC = 0.
    COMMIT WORK.
  ELSE.
    ROLLBACK WORK.
  ENDIF.
*unlock table
  CALL FUNCTION 'DEQUEUE_EYSE_GTS001'
    EXPORTING
      MODE_YSE_GTS001      = C_E.

ENDFORM.                    " UPDATE_DB
*&---------------------------------------------------------------------*
*& Form  GET_GTS003
*&---------------------------------------------------------------------*
*  fetch data from gts003
*----------------------------------------------------------------------*
FORM GET_GTS003 .

  SELECT *
    INTO TABLE I_ADDON_OUT
    FROM YSE_GTS003
   WHERE VATNO IN S_VATNO
     AND VBELN IN S_RVBELN
     AND SONO  IN S_VBELN
     AND BELNR IN S_BELNR
     AND GJAHR IN S_GJAHR
     AND BUKRS =  P_BUKRS
     AND VKORG IN S_VKORG
     AND VTWEG IN S_VTWEG
     AND SPART IN S_SPART
     AND KUNNR IN S_KUNNR
     AND EXPNO1 IN S_EMS.

ENDFORM.                    " GET_GTS003
*&---------------------------------------------------------------------*
*& Form  COMB_DATA
*&---------------------------------------------------------------------*
*  combination two table
*----------------------------------------------------------------------*
FORM COMB_DATA .

  DATA:L_VATNO TYPE YSE_GTS003-VATNO,
         LI_GTS001   TYPE STANDARD TABLE OF YSE_GTS001,
       LREC_GTS001 TYPE YSE_GTS001.
*>>20110811
   DELETE I_OUT WHERE VATNO IS INITIAL.
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE LI_GTS001
      FROM YSE_GTS001
     WHERE BUKRS = P_BUKRS                      "Company code
       AND VBELN  IN S_RVBELN                   "Billing no.
       AND GJAHR IN S_GJAHR                     "Year
       AND ZVATVOICE IN S_VATNO                 "VAT NO.
       AND KUNNR  IN S_KUNNR                    "Sold-to party
*       AND FKDAT  IN S_FKDAT                    "Billing Date
       AND ZREDATE IN S_FKDAT "change date
       AND AUBEL  IN S_VBELN.                   "SO DOCUMENT
*<<20110811

  LOOP AT I_OUT INTO REC_OUT.
*>>20110811
*CHECK IF VAT NO. EXSIT IN GTS001
    READ TABLE LI_GTS001 INTO LREC_GTS001
                 WITH KEY ZVATVOICE = REC_OUT-VATNO.
    IF SY-SUBRC <> 0.
      FLG_STOP = C_FLAG.
      DELETE I_OUT.
    ENDIF.
    CHECK FLG_STOP IS INITIAL.
*<<20110811
    READ TABLE I_ADDON_OUT INTO REC_ADDON_OUT
                 WITH KEY BELNR = REC_OUT-BELNR
                          GJAHR = REC_OUT-GJAHR.
    IF SY-SUBRC = 0.
      L_VATNO = REC_OUT-VATNO.
      REC_OUT = REC_ADDON_OUT.
      REC_OUT-VATNO = L_VATNO.
      CLEAR REC_OUT-BOX.
      MODIFY I_OUT FROM REC_OUT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " COMB_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_BSEG1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_BSEG1 .

  DATA:LI_GTS001    TYPE STANDARD TABLE OF YSE_GTS001,
       LRLEC_GTS001 TYPE YSE_GTS001,
       LI_GTS004    TYPE STANDARD TABLE OF YSE_GTS004,
       LRLEC_GTS004 TYPE YSE_GTS004.
*get accounting no.
    SELECT VATREF
      INTO CORRESPONDING FIELDS OF TABLE LI_GTS001
      FROM YSE_GTS001
     WHERE BUKRS = P_BUKRS                      "Company code
       AND VBELN  IN S_RVBELN                   "Billing no.
       AND GJAHR IN S_GJAHR                     "Year
       AND ZVATVOICE IN S_VATNO                 "VAT NO.
       AND KUNNR  IN S_KUNNR                    "Sold-to party
*2011-08-24
       AND VKORG IN S_VKORG
       AND VTWEG IN S_VTWEG
       AND SPART IN S_SPART
*2011-08-24
*       AND FKDAT  IN S_FKDAT                    "Billing Date
       AND ZREDATE IN S_FKDAT "change date
       AND AUBEL  IN S_VBELN.                   "SO DOCUMENT
   IF LI_GTS001 IS NOT INITIAL.
     SELECT BELNR
      INTO CORRESPONDING FIELDS OF TABLE LI_GTS004
      FROM YSE_GTS004
      FOR ALL ENTRIES IN LI_GTS001
     WHERE VATREF = LI_GTS001-VATREF.
   ENDIF.
   IF LI_GTS004 IS NOT INITIAL.
      SELECT BUKRS
           BELNR
           GJAHR
           ZUONR
           KUNNR
           LINFV
      INTO TABLE I_BSEG
      FROM BSEG
           FOR ALL ENTRIES IN LI_GTS004
     WHERE ZUONR IN S_VATNO                     "VAT Invoice NO:
       AND BUKRS = P_BUKRS
       AND GJAHR IN S_GJAHR
       AND BUZEI = '001'
       AND BELNR = LI_GTS004-BELNR
*       AND BELNR IN S_BELNR
       AND KUNNR IN S_KUNNR.
   ENDIF.
   IF I_BSEG IS INITIAL.
     FLG_STOP = C_FLAG.
*   No Data
     MESSAGE S000 WITH TEXT-S01.
   ENDIF.

ENDFORM.                    " GET_BSEG1
*&---------------------------------------------------------------------*
*&      Form  GET_BKPF1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_BKPF1 .

 IF I_BSEG IS NOT INITIAL.
   SELECT BUKRS
           BELNR
           GJAHR
           AEDAT
           AWKEY
      INTO TABLE I_BKPF
      FROM BKPF
           FOR ALL ENTRIES IN I_BSEG
     WHERE BUKRS = P_BUKRS
       AND BELNR IN S_BELNR
*       AND BUDAT IN S_FKDAT
       AND AEDAT IN S_FKDAT "change date
       AND BLART = 'RV'
       AND AWTYP = 'VBRK'
       AND BELNR = I_BSEG-BELNR
       AND AWKEY IN S_RVBELN
       AND AEDAT <> '00000000'
       AND GJAHR IN S_GJAHR.
    IF SY-SUBRC <> 0.
      FLG_STOP = C_FLAG.
*   No Data
      MESSAGE S000 WITH TEXT-S01.
    ENDIF.
 ENDIF.

ENDFORM.                    " GET_BKPF1
*&---------------------------------------------------------------------*
*&      Form  GET_BSEG2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_BSEG2 .

*  IF I_BKPF IS NOT INITIAL.

    SELECT BUKRS
         BELNR
         GJAHR
         ZUONR
         KUNNR
         LINFV
    INTO TABLE I_BSEG
    FROM BSEG
*         FOR ALL ENTRIES IN I_BKPF
   WHERE ZUONR IN S_VATNO                     "VAT Invoice NO:
     AND BUKRS = P_BUKRS
     AND GJAHR IN S_GJAHR
     AND BUZEI = '001'
*     AND BELNR = I_BKPF-BELNR
     AND BELNR IN S_BELNR
     AND KUNNR IN S_KUNNR.
    IF SY-SUBRC <> 0.
      FLG_STOP = C_FLAG.
*   No Data
      MESSAGE S000 WITH TEXT-S01.
    ENDIF.
*  ENDIF.

ENDFORM.                    " GET_BSEG2
*&---------------------------------------------------------------------*
*&      Form  GET_BKPF2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_BKPF2 .

  SELECT BUKRS
         BELNR
         GJAHR
         AEDAT
         AWKEY
    INTO TABLE I_BKPF
    FROM BKPF
         FOR ALL ENTRIES IN I_BSEG
   WHERE BUKRS = P_BUKRS
     AND BELNR IN S_BELNR
*     AND BUDAT IN S_FKDAT
     AND AEDAT IN S_FKDAT "change date
     AND BLART = 'RV'
     AND AWTYP = 'VBRK'
     AND BELNR = I_BSEG-BELNR
     AND AWKEY IN S_RVBELN
     AND AEDAT <> '00000000'
     AND GJAHR IN S_GJAHR.
  IF SY-SUBRC <> 0.
    FLG_STOP = C_FLAG.
* No Data
    MESSAGE S000 WITH TEXT-S01.
  ENDIF.

ENDFORM.                    " GET_BKPF2
*&---------------------------------------------------------------------*
*&      Form  GET_BILL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_BILL .

  IF S_VBELN IS NOT INITIAL.
    SELECT VBELN
      INTO TABLE I_BILL
      FROM VBFA
     WHERE VBELV IN S_VBELN
       AND ( VBTYP_N = 'M'
            OR  VBTYP_N = 'N' ).
  ENDIF.

  LOOP AT I_BILL INTO REC_BILL.
    REC_BILL-AWKEY = REC_BILL-VBELN.
    MODIFY I_BILL FROM REC_BILL
             TRANSPORTING AWKEY.
  ENDLOOP.

ENDFORM.                    " GET_BILL
*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
form GET_DATA .

 DATA: T_GTS001 TYPE STANDARD TABLE OF YSE_GTS001,
       REC_GTS001 TYPE YSE_GTS001.


  SELECT *
    INTO TABLE I_ADDON_OUT
    FROM YSE_GTS003
   WHERE VATNO IN S_VATNO "VAT NO
     AND VATDATE IN S_FKDAT "VAT invoice Date
     AND SONO  IN S_VBELN "SO Number
     AND VBELN IN S_RVBELN"Billing Number
     AND BELNR IN S_BELNR "Accounting number
     AND GJAHR IN S_GJAHR "Year
     AND BUKRS =  P_BUKRS "Company code
     AND VKORG IN S_VKORG "Sales Organization
     AND VTWEG IN S_VTWEG "Distribution Channel
     AND SPART IN S_SPART "Division
     AND KUNNR IN S_KUNNR "customer
     AND EXPNO1 IN S_EMS. "EMS number

 SELECT *
   INTO TABLE T_GTS001
   FROM YSE_GTS001
   WHERE ZVATVOICE IN S_VATNO "VAT NO
     AND ZREDATE   IN S_FKDAT "VAT invoice Date
     AND AUBEL     IN S_VBELN "SO Number
     AND VBELN IN S_RVBELN"Billing Number
     AND ZSTAUS = '3'
*     AND XBLNR IN S_BELNR "Accounting number
     AND GJAHR IN S_GJAHR "Year
     AND BUKRS =  P_BUKRS "Company code
     AND VKORG IN S_VKORG "Sales Organization
     AND VTWEG IN S_VTWEG "Distribution Channel
     AND SPART IN S_SPART "Division
     AND KUNNR IN S_KUNNR."customer

  DELETE ADJACENT DUPLICATES FROM T_GTS001
           COMPARING VBELN                    "Billing Document
                     ZVATVOICE.               "VAT VOICE
  DATA:L_TAX         TYPE MWSBP.
  LOOP AT T_GTS001 INTO REC_GTS001.
    CLEAR REC_OUT.
    CLEAR L_TAX.
    REC_OUT-VATNO   = REC_GTS001-ZVATVOICE."VAT Invoice NO
    REC_OUT-VATDATE = REC_GTS001-ZREDATE."VAT invoice Date
    REC_OUT-VATYPE = REC_GTS001-ZVATYP."VAT TYPE

    REC_OUT-VBELN = REC_GTS001-VBELN."Billing Document
*REC_OUT-BELNR = REC_GTS001-."accounting document
    SELECT SINGLE BELNR
      INTO REC_OUT-BELNR
      FROM YSE_GTS004
     WHERE BUKRS = REC_GTS001-BUKRS
       AND BELNR IN S_BELNR
       AND GJAHR = REC_GTS001-GJAHR
       AND VBELN = REC_GTS001-VBELN.
    CHECK REC_OUT-BELNR IS NOT INITIAL.

    REC_OUT-GJAHR = REC_GTS001-GJAHR."Fiscal Year
    REC_OUT-BUKRS = REC_GTS001-BUKRS."Company Code
*XBLNR                           Reference
    REC_OUT-VKORG = REC_GTS001-VKORG."Sales Organization
    REC_OUT-VTWEG = REC_GTS001-VTWEG."Distribution Channel
    REC_OUT-SPART = REC_GTS001-SPART."Division
    REC_OUT-KUNNR = REC_GTS001-KUNNR."Customer
    REC_OUT-NAME  = REC_GTS001-NAME."Customer description
*    REC_OUT-AMOUT = REC_GTS001-AMOUT."Invoice amount (w tax)
      SELECT SUM( NETWR )
        INTO REC_OUT-AMOUT
        FROM VBRP
       WHERE VBELN = REC_GTS001-VBELN.

      SELECT SUM( MWSBP )
        INTO L_TAX
        FROM VBRP
       WHERE VBELN = REC_GTS001-VBELN.
    REC_OUT-AMOUT = REC_OUT-AMOUT + L_TAX.
    REC_OUT-SONO  = REC_GTS001-AUBEL."Sales Document
    SELECT SINGLE ERNAM
      INTO REC_OUT-ERNAM
      FROM VBAK
     WHERE VBELN = REC_GTS001-AUBEL.  "SO Document
    APPEND REC_OUT TO I_OUT.
  ENDLOOP.

  LOOP AT I_OUT INTO REC_OUT.
    READ TABLE I_ADDON_OUT INTO REC_ADDON_OUT
           WITH KEY VATNO = REC_OUT-VATNO.
    IF SY-SUBRC = 0.
       REC_OUT = REC_ADDON_OUT.
      MODIFY I_OUT FROM REC_OUT.
    ENDIF.
  ENDLOOP.

endform.                    " GET_DATA

*Text symbol text£º
*H00:Select
*H01:VAT Invoice NO
*H02:VAT invoice Date
*H03:VAT TYPE
*H04:SAP Invoice
*H05:Fiscal Year
*H06:Company Code
*H07:Customer Name
*H08:Invoice amount (w tax)
*H09:So number
*H10:SO create by
*H11:Remark
*H12:Express send date
*H13:Express number
*H14:VAT Received date
*H15:Express sent date(to customer)
*H16:Express number1
*H17:Express type
*H18:Customer code
*H19:Accounting Document
*S01:No Data

*V01:ÔöÆ±
*Selection text£º
*P_BUKRS:        Company code
*S_BELNR:        Accounting number
*S_EMS:        EMS number
*S_FKDAT:        VAT invoice Date
*S_GJAHR:        Fiscal Year
*S_KUNNR:        Customer
*S_RVBELN:        Billing Number
*S_SPART:        Division
*S_VATNO:        VAT NO
*S_VBELN:        SO Number
*S_VKORG:        Sales Organization
*S_VTWEG:        Distribution Channel
