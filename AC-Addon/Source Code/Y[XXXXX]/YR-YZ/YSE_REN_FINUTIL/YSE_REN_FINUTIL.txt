***********************************************************************
* Program ID           : YSE_REN_FINUTIL                              *
* Program Title        : Financial utilization report                 *
* Author               : Erik Walravens                               *
* Date                 : 19.02.2007                                   *
* Development Number   : D027                                         *
* Change Request Number: CD1K910702                                   *
* Description          : Reports the rental revenue compared to the   *
*                        acquisition cost of the equipment.           *
***********************************************************************
* Notes:                                                              *
* - NAICS is not yet included in the selection options.               *
* - Financial inefficiency (D028) is also be included in this report. *
* - Company code needs not be displayed according to spec. This will  *
*   probably change. Therefore it's only commented out.               *
***********************************************************************
* MOD-001 |19/03/2007| Erik Walravens | CD1K912181        | 001       *
* Description: Optimization of main data selections.                  *
*---------------------------------------------------------------------*
* MOD-002 |27/03/2007| Erik Walravens | CD1K912525        | 002       *
* Description: Correct and optimize basic selections.                 *
*---------------------------------------------------------------------*
* MOD-003 |28/03/2007| Erik Walravens | CD1K913322        | 003       *
* Description: Modify calculations.                                   *
*---------------------------------------------------------------------*
* MOD-004 |29/03/2007| Erik Walravens | CD1K913358        | 004       *
* Description: Add 2 columns: Utilisation x Acquisition value.        *
*              Add average calculation on GAC, PGC, RPGC and Model.   *
*---------------------------------------------------------------------*
* MOD-005 |30/03/2007| Erik Walravens | CD1K913413        | 005       *
* Description: Correct formula Percentile Utilisation.                *
*              Add 2 columns: Inefficiency x Acquisition value.       *
*              Add average calculation on GAC, PGC, RPGC and Model.   *
*---------------------------------------------------------------------*
* MOD-006 |30/03/2007| Erik Walravens | CD1K913451        | 006       *
* Description: Correct Month to Date and Year to Date utilisation.    *
*---------------------------------------------------------------------*
* MOD-007 |30/03/2007| Erik Walravens | CD1K913467        | 007       *
* Description: Correct Material and model descriptions in output.     *
*---------------------------------------------------------------------*
* MOD-008 |01/04/2007| Erik Walravens | CD1K913497        | 008       *
* Description: Calculate Rolling Month Start date. (Not in use yet)   *
*              Fix overlapping Rental Contracts, Sevice Orders and    *
*              Transport Orders.                                      *
*              Include Asset Desactivation date into interval         *
*              calculation.                                           *
*---------------------------------------------------------------------*
* MOD-009 |02/04/2007| Erik Walravens | CD1K913508        | 009       *
* Description: Instore 1 Month Rolling.                               *
*              Fix data overflow error.                               *
*              Change reference periods for 1 Month Rolling, 12 Month *
*              Rolling, Month to Date and Year to Date.               *
*---------------------------------------------------------------------*
* MOD-010 |02/04/2007| Erik Walravens | CD1K913578        | 010       *
* Description: Correct Revenue PGC code.                              *
*              Merge Physical utilisation / Inefficiency report with  *
*              Financial utilisation / inefficiency.                  *
*              Cosmetic changes                                       *
*---------------------------------------------------------------------*
* MOD-011 |03/04/2007| Erik Walravens | CD1K913614        | 011       *
* Description: Include weekend regime calculation.                    *
*              Change document type for Service Order to ZAM1.        *
*---------------------------------------------------------------------*
* MOD-012 |03/04/2007| Erik Walravens | CD1K913643        | 012       *
* Description: Cosmetic changes                                       *
*              Correction period calculation.                         *
*---------------------------------------------------------------------*
* MOD-013 |03/04/2007| Erik Walravens | CD1K913647        | 013       *
* Description: Correction period calculation                          *
*              Include ZRIB as contract document type.                *
*---------------------------------------------------------------------*
* MOD-014 |04/04/2007| Erik Walravens | CD1K913652        | 014       *
* Description: Add MtD, YtD, 1 Month Rolling and 12 Month Rolling for *
*              Availibility calculation.                              *
*---------------------------------------------------------------------*
* MOD-015 |05/04/2007| Erik Walravens | CD1K913741        | 015       *
* Description: Correct negative availability error.                   *
*              Correct weekend-regime only for contracts.             *
*              Add 12 averages (MtD, YtD, 1m Rol 12m Rol - Utiliz.,   *
*              Ineff. and Avail.) weighted by Acquistion value.       *
*---------------------------------------------------------------------*
* MOD-016 |06/04/2007| Erik Walravens | CD1K913810        | 016       *
* Description: Clean-up                                               *
*              Remove 7/7 regime correction.                          *
*         |12/04/2007| Pieter Jespers |                   |           *
* Description: Authorisation check                                    *
***********************************************************************
* MOD-017 |13/02/2008| CVM            |                        | 017  *
* Description:  MAterial Description not filled up
* Remark in case ALV problem occurs it is better to create a struc.   *
* structure YSE_REN_FINUTIL is created in $TMP,   coding already      *
* only the fields of this structure needs to be fine tuned layout     *
***********************************************************************
* MOD-018 |12/02/2008| Peter Dudas    |  same as 17       | 018       *
* Description: Run report in background also            .             *
***********************************************************************
* MOD-019 |05/05/2009| M.Jacobs       |  CD1K947976       | NEWGL     *
*---------------------------------------------------------------------*
* MOD-020 |08/05/2009| Uzzawal V      |  CD1K948142       | 020       *
*          15/05/2009                    CD1K948297                   *
*          15/05/2009                    CD1K948301,CD1K948303        *
* Description: CR0227                                   .             *
*---------------------------------------------------------------------*


REPORT yse_ren_finutil MESSAGE-ID yse_rental.

***********************************************************************
* OBJECTS                                                             *
***********************************************************************
DATA:
  obj_container     TYPE REF TO cl_gui_docking_container,
  obj_alv           TYPE REF TO cl_gui_alv_grid.

***********************************************************************
* TABLES                                                              *
***********************************************************************
TABLES:
  mvke,
  mara,
  equi,
  iloa,
  yse_pgc_gac,
  t179,
  ce41000.        " EXTUVE 20090515

***********************************************************************
* INTERNAL TYPES                                                      *
***********************************************************************
TYPES:
  BEGIN OF str_equ_a,
    equnr       TYPE equi-equnr,   " Equipment number
  END OF str_equ_a,

  BEGIN OF str_equ_b,
    equnr TYPE equnr,
    matnr TYPE matnr,
    sernr TYPE gernr,
    iloan TYPE iloan,
    werk  TYPE eqbs-b_werk,
  END OF str_equ_b,

  BEGIN OF str_equ_c,
    iloan TYPE iloan,
    bukrs TYPE bukrs,
    vkorg TYPE vkorg,
    vtweg TYPE vtweg,
  END OF str_equ_c,

  BEGIN OF str_eq,
    bukrs        TYPE iloa-bukrs,  " Company code
    werk         TYPE eqbs-b_werk, " Stock plant
    matnr        TYPE equi-matnr,  " Material nr
    equnr        TYPE equi-equnr,  " Equipment nr
    sernr        TYPE equi-sernr,  " Serial nr
    pmatn        TYPE mvke-pmatn,  " Model
    prodh        TYPE mvke-prodh,  " Product hierarchy
  END OF str_eq,

  BEGIN OF str_mvke,
    matnr     TYPE mvke-matnr,
    pmatn     TYPE mvke-pmatn,
    prodh     TYPE mvke-prodh,
  END OF str_mvke,

  BEGIN OF str_sme,
        vbeln        TYPE yse_rent_sme-vbeln,    " Doc nr
        posnr        TYPE yse_rent_sme-posnr,    " Item nr
        zzequnr      TYPE yse_rent_sme-zzequnr,  " Equipment nr
        matnr        TYPE yse_rent_sme-matnr,    " Material nr
        zzsernr      TYPE yse_rent_sme-zzsernr,  " Serial nr
        angdt        TYPE yse_rent_sme-angdt,    " Start date
        bnddt        TYPE yse_rent_sme-bnddt,    " End date
        auart        TYPE yse_rent_sme-auart,    " Document type
  END OF str_sme,

  BEGIN OF str_vbap,
         vbeln        TYPE vbap-vbeln,
         posnr        TYPE vbap-posnr,
         werks        TYPE vbap-werks,
         zzsernr      TYPE vbap-zzsernr,
         prodh        TYPE vbap-prodh,
         paobjnr      TYPE vbap-paobjnr,
         vkaus        TYPE vbap-vkaus,
         netwr        TYPE vbap-netwr,
  END OF str_vbap,

  BEGIN OF str_result,
    werk         TYPE equi-werk,        " Plant
    gac          TYPE zgac,             " GAC
    pgc          TYPE zpgc,             " PGC
    rpgc         TYPE zgac,             " Revenue PGC
    model        TYPE makt-matnr,       " Model
    modesc       TYPE makt-maktx,       " Model description
    matnr        TYPE makt-matnr,       " Material number
    madesc       TYPE makt-maktx,       " Material description
    equnr        TYPE yse_rent_sme-zzequnr,  " Equipment nr
    sernr        TYPE yse_rent_sme-zzsernr,  " Serial nr
    zugdt        TYPE anla-zugdt,       " Investment date
    deakt        TYPE anla-deakt,       " Deactivation date
    period       TYPE int2,             " Nr of days in sel period
    absuse       TYPE int2,             " Abolute nr of days in use
    peruti       TYPE p DECIMALS 2,     " Fin util Over Time Period
    answl        TYPE anlc-answl,       " Investment cost
    answl_p      TYPE anlc-answl,       " Investment cost With Perind
    anuti        TYPE zrevu,            " Acq value x utilisation
    mtduti       TYPE p DECIMALS 2,     " Fin util Month to Date
    ytduti       TYPE p DECIMALS 2,     " Fin util Year to Date
    romuti       TYPE p DECIMALS 2,     " Fin util 1 Month Rolling
    romuti3      TYPE p DECIMALS 2,     " Fin util 3 Month Rolling
    romuti6      TYPE p DECIMALS 2,     " Fin util 6 Month Rolling
    roluti       TYPE p DECIMALS 2,     " Fin util 12 Months Rolling
    comuti       TYPE p DECIMALS 2,     " Fin util Month Comparison
    nonuse       TYPE int2,             " Days equipment is not in use
    ineffi       TYPE p DECIMALS 2,     " anlp-nafag, " Fin inefficiency
    inuti        TYPE zrevu,            " Acq value x inefficiency
    intrab       TYPE int2,             " Abs ineff. due to transport
    intrpr       TYPE p DECIMALS 2,     " Percentile ineff
    insrab       TYPE int2,             " Abs ineff due to serv orders
    insrpr       TYPE p DECIMALS 2,     " Perc. ineff
    mtdinf       TYPE p DECIMALS 2,     " Inefficiency Month to Date
    ytdinf       TYPE p DECIMALS 2,     " Inefficiency Year to Date
    rominf       TYPE p DECIMALS 2,     " Inefficiency 1 Month Rolling
    rominf3      TYPE p DECIMALS 2,     " Inefficiency 3 Month Rolling
    rominf6      TYPE p DECIMALS 2,     " Inefficiency 6 Month Rolling
    rolinf       TYPE p DECIMALS 2,     " Inefficiency 12 Months Rol
    inavab       TYPE int2,             " Absolute availibility
    inavpr       TYPE p DECIMALS 2,     " Percentile availibility
    mtdavl       TYPE p DECIMALS 2,     " Availibility Month to Date
    ytdavl       TYPE p DECIMALS 2,     " Availibility Year to Date
    romavl       TYPE p DECIMALS 2,     " Availibility 1 Month Rolling
    romavl3      TYPE p DECIMALS 2,     " Availibility 3 Month Rolling
    romavl6      TYPE p DECIMALS 2,     " Availibility 6 Month Rolling
    rolavl       TYPE p DECIMALS 2,     " Availibility 12 Months Rol
    linecolor(4) TYPE c,                " Line color
    WW006    TYPE CE41000-WW006,            " EXTUVE 20090515
    WW007    TYPE CE41000-WW007,            " EXTUVE 20090515

  END OF str_result,

  BEGIN OF str_makt,
        matnr        TYPE makt-matnr,       " Material number
        maktx        TYPE makt-maktx,       " Material description
  END OF str_makt,

  BEGIN OF str_acct,                        " Revenue PGC
    paobjnr  TYPE vbap-paobjnr,
    prodh    TYPE vbap-prodh,
    WW006    TYPE CE41000-WW006,            " EXTUVE 20090515
    WW007    TYPE CE41000-WW007,            " EXTUVE 20090515
  END OF str_acct,

  BEGIN OF str_invest,
        equnr     TYPE equz-equnr,          " Equipment number
        zugdt     TYPE anla-zugdt,          " Acquisition date
        deakt     TYPE anla-deakt,          " Deactivation date
        answl     TYPE anlc-answl,          " Acquisition value
        kansw     TYPE anlc-kansw,          " Acquisition kumulative value
  END OF str_invest.

***********************************************************************
* INTERNAL TABLES                                                     *
***********************************************************************
DATA:
  it_equ_a    TYPE TABLE OF str_equ_a,
  it_equ_b    TYPE TABLE OF str_equ_b   WITH HEADER LINE,
  it_equ_c    TYPE TABLE OF str_equ_c   WITH HEADER LINE,
  it_eq       TYPE TABLE OF str_eq      WITH HEADER LINE,
  it_mvke     TYPE TABLE OF str_mvke    WITH HEADER LINE,
  it_sme      TYPE TABLE OF str_sme     WITH HEADER LINE,
  it_sesme    TYPE TABLE OF str_sme     WITH HEADER LINE,
  it_vbap     TYPE TABLE OF str_vbap    WITH HEADER LINE,
  it_invest   TYPE TABLE OF str_invest  WITH HEADER LINE,
  it_result   TYPE TABLE OF str_result  WITH HEADER LINE,
*  it_result   TYPE TABLE OF yse_ren_finutil  WITH HEADER LINE,
  it_pgc      TYPE TABLE OF yse_pgc_gac WITH HEADER LINE,
  it_acct     TYPE TABLE OF str_acct    WITH HEADER LINE,
  it_makt     TYPE TABLE OF str_makt    WITH HEADER LINE,
  it_fieldcat TYPE lvc_t_fcat           WITH HEADER LINE,
  BEGIN OF it_matnr OCCURS 0,
     matnr    TYPE matnr,
  END OF it_matnr,

  BEGIN OF it_models OCCURS 0,
    matnr     TYPE matnr,
    model     TYPE matnr,
  END OF it_models,

  BEGIN OF it_matnr_eq OCCURS 0,
     matnr    TYPE matnr,
  END OF it_matnr_eq.

***********************************************************************
* CONSTANTS                                                           *
***********************************************************************
CONSTANTS:
  lc_true      TYPE char1        VALUE 'X',    " true
  lc_engl      TYPE tvagt-spras  VALUE 'E',    " english
  lc_rent      TYPE iloa-vtweg   VALUE '21',   " rental distr.
  lc_ctr1      TYPE vbak-auart   VALUE 'ZQP',  " rental contract
  lc_ctr2      TYPE vbak-auart   VALUE 'ZQP1', " rental contract
  lc_ctr3      TYPE vbak-auart   VALUE 'ZQP2', " rental contract
  lc_ctr4      TYPE vbak-auart   VALUE 'ZRIB', " Cross div contract
  lc_serv      TYPE vbak-auart   VALUE 'ZAM1', " service order
  lc_deli      TYPE vbak-auart   VALUE 'LR',   " inbound delivery
  lc_delo      TYPE vbak-auart   VALUE 'ZLF',  " outbound delivery
  lc_catx      TYPE equi-eqtyp   VALUE 'X',    " Financed by lease
  lc_caty      TYPE equi-eqtyp   VALUE 'Y',    " Not financed by lease
  gc_yellow(4) TYPE c            VALUE 'C300',
  gc_gray(4)   TYPE c            VALUE 'C200',
  gc_bluish(4) TYPE c            VALUE 'C400',
  gc_blue(4)   TYPE c            VALUE 'C100',
  gc_red(4)    TYPE c            VALUE 'C600',
  lc_use       TYPE c            VALUE 'A'.

***********************************************************************
* VARIABLES                                                           *
***********************************************************************
* ALV grid
DATA:
  lv_records   TYPE p,             " Record counter
  okcode       LIKE sy-ucomm,      " return param screen 100
  gs_layout    TYPE lvc_s_layo,    " ALV grid layout
  gs_variant   TYPE disvariant,    " ALV grid variant
  o_bukrs(4)   TYPE c,             " Output field Company Code
  o_werks(4)   TYPE c,             " Output field Plant
  o_vkorg(4)   TYPE c,             " Output field Sales Org.
  o_angdt(10)  TYPE c,             " Output field Start date
  o_bnddt(10)  TYPE c.             " Output field End date
* Process
DATA:
  lv_inloop    TYPE char1,         " Loop checker
  lv_lines     TYPE p,             " lines in an internal table
  lv_sesme_idx LIKE sy-tabix.      " table index it_sesme
* Calculations
DATA:
  lv_dtms      TYPE sy-datum,      " Month start date
  lv_dtys      TYPE sy-datum,      " Year start date
  lv_dtya      TYPE sy-datum,      " Year ago date
  lv_dtme      TYPE sy-datum,      " Month end date
  lv_dtma      TYPE sy-datum,      " Month ago date
  lv_dtma3     TYPE sy-datum,      " 3 Months ago date
  lv_dtma6     TYPE sy-datum,      " 6 Months ago date
  lv_dtym      TYPE sy-datum,      " Year and month ago date
  lv_permtd    TYPE int2,          " Period Month to Date
  lv_perytd    TYPE int2,          " Period Year to Date
  lv_peromr    TYPE int2,          " Period 1 month rolling
  lv_peromr3   TYPE int2,          " Period 3 month rolling
  lv_peromr6   TYPE int2,          " Period 6 month rolling
  lv_pertmr    TYPE int2,          " Period 12 month rolling
  lv_perymr    TYPE int2,          " Period 1 mth rol 1 yr ago
  lv_angdt     TYPE yse_rent_sme-angdt,    " Start date
  lv_bnddt     TYPE yse_rent_sme-bnddt,    " End date
  lv_period    TYPE int4,          " Day counter
  lv_mtduse    TYPE int2,          " Absolute usage MtD
  lv_mtdnon    TYPE int2,          " Absolute disuse MtD
  lv_mtdavl    TYPE int2,          " Absolute avail MtD
  lv_comuse    TYPE int2,          " Abs usage 1 month rol 1 yr ago
  lv_ytduse    TYPE int2,          " Absolute usage YtD
  lv_ytdnon    TYPE int2,          " Absolute disuse YtD
  lv_ytdavl    TYPE int2,          " Absolute avail YtD
  lv_romuse    TYPE int2,          " Absolute usage 1 month rol
  lv_romnon    TYPE int2,          " Absolute disuse 1 month rol
  lv_romavl    TYPE int2,          " Absolute avail 1 month rol
  lv_romuse3   TYPE int2,          " Absolute usage 3 month rol
  lv_romnon3   TYPE int2,          " Absolute disuse 3 month rol
  lv_romavl3   TYPE int2,          " Absolute avail 4 month rol
  lv_romuse6   TYPE int2,          " Absolute usage 6 month rol
  lv_romnon6   TYPE int2,          " Absolute disuse 6 month rol
  lv_romavl6   TYPE int2,          " Absolute avail 6 month rol
  lv_roluse    TYPE int2,          " Absolute usage 12 months rol
  lv_rolnon    TYPE int2,          " Absolute disuse 12 months rol
  lv_rolavl    TYPE int2,          " Absolute avail 12 months rol
  arg_angdt    LIKE sy-datum,
  arg_bnddt    LIKE sy-datum,
  wa_result    TYPE str_result,
  lv_tage      TYPE anz_tage.
*  wa_result    TYPE yse_ren_finutil.

***********************************************************************
* FIELD-SYMBOLS                                                       *
***********************************************************************
FIELD-SYMBOLS:
  <fs_invest> LIKE LINE OF it_invest.

***********************************************************************
* RANGES                                                              *
***********************************************************************
RANGES:
  r_auart FOR vbak-auart.         " AUART codes according to status

************************************************************************
* SELECTION SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-s01.
PARAMETERS:
  p_angdt     TYPE dats       OBLIGATORY,               " Date start period
  p_bnddt     TYPE dats       OBLIGATORY,               " Date end period
  p_bukrs     TYPE iloa-bukrs OBLIGATORY MEMORY ID buk. " Company Code
SELECT-OPTIONS:
  so_werk  FOR equi-werk   MEMORY ID wrk,      " stock plant
  so_vkorg FOR iloa-vkorg  MEMORY ID vko,      " sales org
  so_vtweg FOR iloa-vtweg DEFAULT lc_rent,
  so_pgc   FOR t179-prodh,                     " PGC
  so_gac   FOR yse_pgc_gac-gac,                " GAC
  so_rpgc   FOR ce41000-ww007,                 " PGC   " EXTUVE
  so_rgac   FOR ce41000-ww006,                 " GAC   " EXTUVE
  so_model FOR mvke-pmatn,                     " model
  so_matnr FOR mara-matnr  MEMORY ID mat,      " material nr
  so_equnr FOR equi-equnr  MEMORY ID eqn,      " equipment
  so_sernr FOR equi-sernr  MEMORY ID ser.      " serial nr
SELECTION-SCREEN END OF BLOCK b1.

************************************************************************
* AT SELECTION SCREEN                                                  *
************************************************************************
AT SELECTION-SCREEN.

* Check authorization
  PERFORM check_authorization.

* Check if dates are chronologic
  IF ( NOT p_angdt IS INITIAL AND NOT p_bnddt IS INITIAL ).
    IF p_angdt > p_bnddt.
      MESSAGE e033.
    ENDIF.
  ENDIF.

************************************************************************
* START OF SELECTION                                                   *
************************************************************************
START-OF-SELECTION.

* Pre-calculate dates
  PERFORM calc_dates.

* Load equipments
  PERFORM load_equipments.

* clean up equipment with deactivation date before start-date
  PERFORM delete_deactivated_equipments.

* load contract tables it_sme, it_vbak and it_vbap
  PERFORM load_sales_docs.

* Fill material and model description tables
  PERFORM load_descriptions.

* Add revenue PGC codes
  PERFORM load_rev_pgc_gac.
*>>>>>> Begin of Change EXTUVE 20090508
* Check if Revenue PGC/GAC codes are as selected
  LOOP AT it_eq.
  CLEAR IT_VBAP.
  READ TABLE it_vbap WITH KEY zzsernr = it_eq-sernr
                              WERKS   = IT_EQ-WERK. " EXTUVE 20090515
  CLEAR it_acct.
  READ TABLE it_acct WITH KEY paobjnr = it_vbap-paobjnr.
  IF NOT ( it_acct-ww007 IN so_rpgc ) OR
       NOT ( it_acct-ww006 IN so_rgac ).
      DELETE it_eq.
    ENDIF.    " check Revenue PGC GAC
  ENDLOOP.  " it_eq
*>>>>>> End of Change EXTUVE 20090508

* Initialize dates and supporting variables
  PERFORM loop_init.

* Scan through all unique equipments
  LOOP AT it_eq.

*   Copy data unrelated to sales documents
    PERFORM copy_static_data.

*   Prepare internal table with all Rental Documents for this single equipment
    PERFORM loop_init_sesme.

*   Loop through equipment's sales records
    LOOP AT it_sesme.
*     Set flag that loop was entered
      lv_inloop = lc_true.            " passed through the it_sesme loop
*     Keep track of current record in SESME being processed
      lv_sesme_idx = sy-tabix.
*     Add sales data for each equipment
      PERFORM calc_dyn_data.
    ENDLOOP.

*   If values have changed...
    IF lv_inloop = lc_true.
*     Calculate the derivates
      PERFORM calc_results.
    ENDIF.

*   Add record to result table
    APPEND it_result.
    CLEAR: lv_inloop, lv_period, it_result.

  ENDLOOP.  " it_eq - equipments loop

* Calculate cascading averages
  PERFORM calc_mean.

* Prepare header data
  PERFORM build_header.

* Display results
  IF sy-batch = 'X'.
    PERFORM build_alv.
  ELSE.
    CALL SCREEN 0100.
  ENDIF.
************************************************************************
* FORM: CALC_DATES                                                     *
************************************************************************
* Based on the start and end date entered in the selection parameters, *
* and the current date, this form pre-calculates all date variables    *
* ranges needed through-out the program.                               *
************************************************************************
FORM calc_dates.

* Calculate first of month
  lv_dtms = sy-datum.
  lv_dtms+6(2) = '01'.                " first of month
* Calculate first of year
  lv_dtys = sy-datum.
  lv_dtys+4(4) = '0101'.              " first of January
* Calculate one year ago
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum
      days      = 0
      months    = 0
      signum    = '-'
      years     = 1
    IMPORTING
      calc_date = lv_dtya.
  lv_dtya = lv_dtya + 1.
* Calculate end of this month
  lv_dtme = lv_dtms.                  " first of month
  lv_dtme+4(2) = lv_dtme+4(2) + 1.    " add 1 month
  IF lv_dtme+4(2) = '13'.             " if we went from december to month "13"
    lv_dtme+4(2) = '01'.              " Go to january
    lv_dtme(4) = lv_dtme(4) + 1.      "  .. of next year
  ENDIF.
  lv_dtme = lv_dtme - 1.              " substract 1 day
* Calculate one month ago
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum
      days      = 0
      months    = 1
      signum    = '-'
      years     = 0
    IMPORTING
      calc_date = lv_dtma.
  lv_dtma = lv_dtma + 1.
* Calculate 3 months ago
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum
      days      = 0
      months    = 3
      signum    = '-'
      years     = 0
    IMPORTING
      calc_date = lv_dtma3.
  lv_dtma3 = lv_dtma3 + 1.
* Calculate 6 months ago
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum
      days      = 0
      months    = 6
      signum    = '-'
      years     = 0
    IMPORTING
      calc_date = lv_dtma6.
  lv_dtma6 = lv_dtma6 + 1.
* Calculate one year and one month ago
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum
      days      = 0
      months    = 1
      signum    = '-'
      years     = 1
    IMPORTING
      calc_date = lv_dtym.
  lv_dtym = lv_dtym + 1.

  CALL FUNCTION 'YSE_REN_CALC_DAYS'
    EXPORTING
      i_fkdat               = p_bnddt
      i_nfdat               = p_angdt
*     I_FAKCA               =
      i_use                 = lc_use
   CHANGING
     e_anz_tage            =  lv_tage    .



ENDFORM.  " calc_dates


***********************************************************************
* FORM: LOAD_EQUIPMENTS                                               *
***********************************************************************
* Select all equipments based on selection parameters.                *
* Material, model, equipment and serial number in the selection       *
* fields should be entered exclusively. If more than one of these     *
* fields is entered, only the equipments are loaded that correspond   *
* to all the conditions. If some options are mutually exclusive, no   *
* equipment will be found. If nothing is entered, then all equipments *
* are loaded.                                                         *
***********************************************************************
FORM load_equipments.

* Local internal tables
  DATA: BEGIN OF lt_matnr OCCURS 0,
          matnr TYPE matnr,
        END OF lt_matnr.

* If models are entered, select all underlying materials and replace
* the entered material range.
  IF NOT so_model IS INITIAL.

*   Note: if materials in so_matnr should also be included, remove
*         next CLEAR/REFRESH and append materials from model instead.
    CLEAR so_matnr.
    REFRESH so_matnr.

*   Get all material numbers for selected models...
    SELECT matnr
        INTO TABLE lt_matnr
        FROM mvke
       WHERE pmatn IN so_model
         AND vkorg IN so_vkorg
         AND vtweg IN so_vtweg.

    SORT lt_matnr.
    DELETE ADJACENT DUPLICATES FROM lt_matnr.

    so_matnr-sign = 'I'.
    so_matnr-option = 'EQ'.
    so_matnr-high = space.

*   and add them to the list of selected materials.
    LOOP AT lt_matnr.
      so_matnr-low = lt_matnr-matnr.
      APPEND so_matnr.
    ENDLOOP.

    SORT so_matnr.
    DELETE ADJACENT DUPLICATES FROM so_matnr.
  ENDIF.    " so_model NOT INITIAL

* First: select equipments with rental equipment categories
  SELECT equnr
      INTO TABLE it_equ_a
      FROM equi
     WHERE equnr IN so_equnr  AND
         ( eqtyp EQ lc_catx   OR
           eqtyp EQ lc_caty )
     AND NOT EXISTS  ( SELECT * FROM jest
                       WHERE objnr EQ equi~objnr
                       AND  stat EQ 'I0076'
                       AND  inact EQ ' ' ) .

* Note: Performance improvement suggestion :
*    Test if so_moatnr not initial and delete entries from it_equ_a:
*        delete it_equ_a where matnr not in so_matnr.
*        same for so_sernr

* Second: obtain iloan code for selected equipments
  SELECT equi~equnr
         equi~matnr
         equi~sernr
         equz~iloan
         eqbs~b_werk AS werk
      FROM equi
      JOIN equz
        ON equi~equnr = equz~equnr
*      JOIN eqbs
     LEFT JOIN eqbs
        ON equi~equnr = eqbs~equnr
      INTO CORRESPONDING FIELDS OF TABLE it_equ_b
       FOR ALL ENTRIES IN it_equ_a
     WHERE equi~equnr  EQ it_equ_a-equnr
       AND equi~matnr  IN so_matnr
       AND equi~sernr  IN so_sernr
       AND equz~datbi  EQ '99991231'
       AND equi~matnr  IN so_matnr.

* sold and scrap items don't have a plant, in the history determine the plant
  PERFORM fill_missing_plant TABLES it_equ_b.


* Third: obtain Sales Org and Distribution Channel
  IF NOT ( it_equ_b[] IS INITIAL ).
    SELECT iloan
           bukrs
           vkorg
           vtweg
        INTO TABLE it_equ_c
        FROM iloa
         FOR ALL ENTRIES IN it_equ_b
       WHERE iloan = it_equ_b-iloan.
    SORT it_equ_c.
  ENDIF.

* Fourth: Load models and product hierarchies
  SELECT matnr pmatn prodh
      INTO TABLE it_mvke
      FROM mvke
       FOR ALL ENTRIES IN it_equ_b
     WHERE matnr EQ it_equ_b-matnr
       AND vkorg IN so_vkorg
       AND vtweg IN so_vtweg.

  SORT it_mvke.
  DELETE ADJACENT DUPLICATES FROM it_mvke.

  SORT it_equ_b BY iloan.

  LOOP AT it_equ_b.
*   If the plant is not part of the depots
    IF NOT ( it_equ_b-werk IN so_werk ).
      CONTINUE.
    ENDIF.
*   Check if the Company Code,  SalesOrg and Distr. Ch. are as selected
    READ TABLE it_equ_c WITH KEY iloan = it_equ_b-iloan BINARY SEARCH.
    IF sy-subrc EQ 0.
      IF it_equ_c-vkorg IN so_vkorg AND
         it_equ_c-vtweg IN so_vtweg AND
         it_equ_c-bukrs EQ p_bukrs.
*       Copy equipment nr, material nr and serial nr
        MOVE-CORRESPONDING it_equ_b TO it_eq.
*       Copy model and product hierarchy
        READ TABLE it_mvke WITH KEY matnr = it_equ_b-matnr.
        it_eq-pmatn = it_mvke-pmatn.
        it_eq-prodh = it_mvke-prodh.
*       Add record
        APPEND it_eq.
      ENDIF.    " Check VKORG VTWEG BUKRS
    ENDIF.    "  Check ILOA record exists
  ENDLOOP.  " it_equ_b

  SORT it_eq.
  DELETE ADJACENT DUPLICATES FROM it_eq.

* Build PGC/GAC conversion table
  PERFORM load_pgc_gac.

* Check if PGC/GAC codes are as selected
  LOOP AT it_eq.
    READ TABLE it_pgc WITH KEY pgc = it_eq-prodh.
    IF NOT ( it_pgc-pgc IN so_pgc ) OR
       NOT ( it_pgc-gac IN so_gac ).
      DELETE it_eq.
    ENDIF.    " check PGC GAC
  ENDLOOP.  " it_eq

* Count selected records
  DESCRIBE TABLE it_eq LINES lv_records.
  IF lv_records > 0.

*   Get all equipments' acquisition dates and values
    SELECT equz~equnr anla~zugdt anla~deakt anlc~answl anlc~kansw    "kansw inserted by Raskin Kevin issue 2615
        INTO TABLE it_invest
        FROM equz
        JOIN iloa
          ON equz~iloan EQ iloa~iloan
        JOIN anlc
          ON iloa~anlnr EQ anlc~anln1
        JOIN anla
          ON anlc~anln1 EQ anla~anln1
         AND anlc~bukrs EQ anla~bukrs
         FOR ALL entries IN it_eq
       WHERE equz~equnr EQ it_eq-equnr
         AND anlc~bukrs EQ p_bukrs
* begin of change MOD-018
*         AND anlc~afabe EQ '30'.
         and anlc~afabe eq '01'.
* end of change MOD-018
*        AND equz~equzn EQ '000'

*{Insert Raskin Kevin issue 2615:
*Make sure that cutover assets are also calculated correct
* CVM deactiveted Equipments, give ZERO Aqui Valu
    LOOP AT it_invest ASSIGNING <fs_invest>.
      IF <fs_invest>-answl LE 0.
        MOVE <fs_invest>-kansw TO <fs_invest>-answl.
      ELSE.
        ADD <fs_invest>-kansw TO <fs_invest>-answl.
      ENDIF.
    ENDLOOP.
*}End insert Raskin kevin

  ENDIF.    " it_eq not empty

ENDFORM.  " load_data


***********************************************************************
*  Form LOAD_SALES_DOCS                                               *
***********************************************************************
* Load all sales record in table YSE_RENT_SME based on check boxes    *
* and on selected equipments. Also load a seperate table for          *
* financial inefficiency calculation.                                 *
***********************************************************************
FORM load_sales_docs.

* Build option list based on selected statusses for financial util
  r_auart-sign = 'I'.
  r_auart-option = 'EQ'.
  r_auart-low = lc_ctr1.
  APPEND r_auart.
  r_auart-low = lc_ctr2.
  APPEND r_auart.
  r_auart-low = lc_ctr3.
  APPEND r_auart.
  r_auart-low = lc_ctr4.
  APPEND r_auart.
  r_auart-low = lc_deli.
  APPEND r_auart.
  r_auart-low = lc_delo.
  APPEND r_auart.
  r_auart-low = lc_serv.
  APPEND r_auart.

  SELECT      vbeln posnr zzequnr matnr
              zzsernr angdt bnddt auart
         FROM yse_rent_sme
         INTO TABLE it_sme
          FOR ALL ENTRIES IN it_eq
        WHERE zzequnr EQ it_eq-equnr
          AND auart IN r_auart.                         "#EC CI_NOFIRST

  DESCRIBE TABLE it_sme LINES lv_lines.
  IF lv_lines > 0.

*   Get contract item data
    SELECT vbeln posnr werks zzsernr
           prodh paobjnr vkaus netwr
        FROM vbap
        INTO TABLE it_vbap
         FOR ALL ENTRIES IN it_sme
       WHERE vbeln = it_sme-vbeln
         AND posnr = it_sme-posnr.

  ENDIF.    " records in it_sme

ENDFORM.  " load_sales_docs


***********************************************************************
*  Form LOAD_DESCRIPTIONS                                             *
***********************************************************************
* Load the descriptions for all materials used in the sales documents.*
***********************************************************************
* Note: May have to be enhanced to changed descriptions in item.      *
***********************************************************************
FORM load_descriptions.

  DESCRIBE TABLE it_sme LINES lv_lines.
  IF lv_lines > 0.

*   Create list of unique material numbers from it_sme
    LOOP AT it_sme.
      it_matnr-matnr = it_sme-matnr.
      APPEND it_matnr TO it_matnr.
    ENDLOOP.
    SORT it_matnr BY matnr.
    DELETE ADJACENT DUPLICATES FROM it_matnr.

    DESCRIBE TABLE it_matnr LINES lv_lines.
    IF lv_lines > 0.

*     Get material description for selected documents
      SELECT matnr maktx
          INTO TABLE it_makt
          FROM makt
           FOR ALL ENTRIES IN it_matnr
         WHERE matnr = it_matnr-matnr
           AND spras = lc_engl.
    ENDIF.  " records in it_matnr

*   Determine set of models
    SELECT matnr pmatn
        INTO TABLE it_models
        FROM mvke
        FOR ALL ENTRIES IN it_sme
       WHERE matnr = it_sme-matnr
         AND vkorg IN so_vkorg
         AND vtweg IN so_vtweg.

    SORT it_models.
    DELETE ADJACENT DUPLICATES FROM it_models.

*{   DELETE         CD2K940630                                        2
*\    DESCRIBE TABLE it_models LINES lv_lines.
*\    IF lv_lines > 0.
*\
*\*     Get material description for selected models
*\      SELECT matnr maktx
*\          APPENDING TABLE it_makt
*\          FROM makt
*\           FOR ALL ENTRIES IN it_models
*\         WHERE matnr = it_models-model
*\           AND spras = lc_engl.
*\    ENDIF.    " records in it_models
*}   DELETE
  ENDIF.    " records in it_sme


  DESCRIBE TABLE it_eq LINES lv_lines.
  IF lv_lines > 0 .
*   create list of unique material numbers from it_eq
    LOOP AT it_eq.
      it_matnr_eq-matnr = it_eq-matnr.
      APPEND it_matnr_eq TO it_matnr_eq.
    ENDLOOP.
    SORT it_matnr_eq BY matnr.
    DELETE ADJACENT DUPLICATES FROM it_matnr_eq.

    DESCRIBE TABLE it_matnr_eq LINES lv_lines.
    IF lv_lines > 0.

*     Get material description for selected documents
      SELECT matnr maktx
          APPENDING TABLE it_makt
          FROM makt
           FOR ALL ENTRIES IN it_matnr_eq
         WHERE matnr = it_matnr_eq-matnr
           AND spras = lc_engl.
*{   INSERT         CD2K940630                                        1
**   Determine set of models
      SELECT matnr pmatn
          APPENDING TABLE it_models
          FROM mvke
          FOR ALL ENTRIES IN it_matnr_eq
         WHERE matnr = it_matnr_eq-matnr
           AND vkorg IN so_vkorg
           AND vtweg IN so_vtweg.

      SORT it_models.
      DELETE ADJACENT DUPLICATES FROM it_models.


*}   INSERT
    ENDIF.  " records in it_matnr
  ENDIF.
*{   INSERT         CD2K940630                                        3
*
  DESCRIBE TABLE it_models LINES lv_lines.
  IF lv_lines > 0.

*     Get material description for selected models
    SELECT matnr maktx
        APPENDING TABLE it_makt
        FROM makt
         FOR ALL ENTRIES IN it_models
       WHERE matnr = it_models-model
         AND spras = lc_engl.


  ENDIF.
*}   INSERT
ENDFORM.  " load_descriptions


***********************************************************************
*  Form LOAD_PGC_GAC                                                  *
***********************************************************************
FORM load_pgc_gac.

  DESCRIBE TABLE it_eq LINES lv_lines.
  IF lv_lines > 0.

*   Fill table with PGC codes from it_eq
    SORT it_eq BY prodh.
    LOOP AT it_eq.
      IF it_eq-prodh <> it_pgc-pgc.
        it_pgc-pgc = it_eq-prodh.
        APPEND it_pgc.
      ENDIF.
    ENDLOOP.  " it_vbap

*   Get the corresponding GAC codes for the PGC codes
    CALL FUNCTION 'YSE_CONVERT_PGC_GAC'
      TABLES
        it_pgc_gac = it_pgc.
    SORT it_pgc BY pgc.
  ENDIF.    " records in it_eq

ENDFORM.    " load_pgc_gac


***********************************************************************
*  Form LOAD_REV_PGC_GAC                                              *
***********************************************************************
FORM load_rev_pgc_gac.

  IF NOT it_vbap[] IS INITIAL.
*   Get revenue PGC
    LOOP AT it_vbap.     " TVO: trying a select in a loop to solve timeout ...
      SELECT paobjnr prodh
                WW006 WW007                             " EXTUVE 2009 05 15
          FROM ce41000_acct                             "#EC CI_NOFIRST
          INTO it_acct
*           FOR ALL ENTRIES IN it_vbap
         WHERE AKTBO EQ 'X'
           AND paobjnr EQ it_vbap-paobjnr.
        APPEND it_acct.
      ENDSELECT.
    ENDLOOP.
    DELETE ADJACENT DUPLICATES FROM it_acct.

*   Fill table with PGC codes from VBAP
    SORT it_vbap BY prodh.
    LOOP AT it_vbap.
      IF it_vbap-prodh <> it_pgc-pgc.
        it_pgc-pgc = it_vbap-prodh.
        APPEND it_pgc.
      ENDIF.
    ENDLOOP.  " it_vbap

*   Complete table with PGC codes from CE41000_ACCT
    IF NOT it_acct[] IS INITIAL.
      SORT it_acct BY prodh.
      LOOP AT it_acct.
        CLEAR it_pgc.
        READ TABLE it_pgc WITH KEY pgc = it_acct-prodh.
        IF sy-subrc <> 0.
          it_pgc-pgc = it_acct-prodh.
          APPEND it_pgc.
        ENDIF.
      ENDLOOP.
    ENDIF.

*   Get the corresponding GAC codes for the PGC codes
    CALL FUNCTION 'YSE_CONVERT_PGC_GAC'
      TABLES
        it_pgc_gac = it_pgc.
    SORT it_pgc BY pgc.
  ENDIF.    " records in it_vbap
ENDFORM.    " load_pgc_gac


***********************************************************************
*  Form LOOP_INIT                                                     *
***********************************************************************
* Initializes dates and internal tables to allow period calculation   *
* in the subsequent loop through equipment table it_eq.               *
***********************************************************************
FORM loop_init.

* Sort equiments by unique equipment number
  SORT it_eq BY equnr.

* Sort sales docs by unique equipment number and by start date
  SORT it_sme BY zzequnr angdt.

* Initialization
  CLEAR it_result.
  CLEAR lv_inloop.

ENDFORM.    " loop_init

***********************************************************************
*  Form LOOP_INIT_SESME                                               *
***********************************************************************
* Prepare internal table with all Rental documents sorted by type.    *
* rental Contracts have priority over Service Orders.                 *
* Service Orders have priority over Deliveries.                       *
***********************************************************************
FORM loop_init_sesme.

  CLEAR it_sesme.
  CLEAR it_sesme[].

* First copy Rental Contracts
  LOOP AT it_sme
    WHERE zzequnr EQ it_eq-equnr AND
        ( auart EQ lc_ctr1 OR
          auart EQ lc_ctr2 OR
          auart EQ lc_ctr3 OR
          auart EQ lc_ctr4 ).
    IF it_sme-angdt > p_bnddt OR
       it_sme-bnddt < lv_dtym.         " p_angdt
*     Discard records that lie out of selected period
    ELSE.
      MOVE it_sme TO it_sesme.
      APPEND it_sesme.
    ENDIF.
  ENDLOOP.
* Next add Service Orders
  LOOP AT it_sme
    WHERE zzequnr EQ it_eq-equnr AND
          auart EQ lc_serv.
    IF it_sme-angdt > p_bnddt OR
       it_sme-bnddt < lv_dtym.
*     Discard records that lie out of selected period
    ELSE.
      MOVE it_sme TO it_sesme.
      APPEND it_sesme.
    ENDIF.
  ENDLOOP.
* And finally add deliveries
  LOOP AT it_sme
    WHERE zzequnr EQ it_eq-equnr AND
        ( auart EQ lc_deli OR
          auart EQ lc_delo ).
    IF it_sme-angdt > p_bnddt OR
       it_sme-bnddt < lv_dtym.
*     Discard records that lie out of selected period
    ELSE.
      MOVE it_sme TO it_sesme.
      APPEND it_sesme.
    ENDIF.
  ENDLOOP.

ENDFORM.    " loop_init_sesme

***********************************************************************
*  Form COPY_STATIC_DATA                                              *
***********************************************************************
* Copies all the fields that need no calculation other than the loop  *
* index in it_eq.                                                     *
***********************************************************************
FORM copy_static_data.

* Plant
  it_result-werk   = it_eq-werk.    " Plant
* Equipment number without leading zero's
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = it_eq-equnr
    IMPORTING
      output = it_result-equnr.
* Serial number
  it_result-sernr  = it_eq-sernr.    " Serial number
* Product hierarchy
  CLEAR it_pgc.
  READ TABLE it_pgc WITH KEY pgc = it_eq-prodh.
  it_result-gac   = it_pgc-gac.                " Machine GAC
  it_result-pgc   = it_pgc-pgc.                " Machine PGC
  CLEAR it_vbap.
  READ TABLE it_vbap WITH KEY zzsernr = it_eq-sernr
                              WERKS   = IT_EQ-WERK. " EXTUVE 20090515
  CLEAR it_acct.
  READ TABLE it_acct WITH KEY paobjnr = it_vbap-paobjnr.
  it_result-WW006   = it_acct-WW006.                " EXTUVE 20090515
  it_result-WW007   = it_acct-WW007.                " EXTUVE 20090515
  CLEAR it_pgc.
  READ TABLE it_pgc WITH KEY pgc = it_acct-prodh.
  it_result-rpgc  = it_pgc-pgc.                " Revenue PGC.

* Copy material and description
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = it_eq-matnr
    IMPORTING
      output = it_result-matnr.


  CLEAR it_makt.
  READ TABLE it_makt WITH KEY matnr = it_eq-matnr.
  IF sy-subrc EQ 0.
    it_result-madesc = it_makt-maktx.
  ENDIF.

* Copy model and description
*{   INSERT         CD2K940630                                        1
  CLEAR it_models.
*}   INSERT
  READ TABLE it_models WITH KEY matnr = it_eq-matnr.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = it_models-model  " matnr
    IMPORTING
      output = it_result-model.
  READ TABLE it_makt WITH KEY matnr = it_models-model.
*{   DELETE         CD2K940630                                        3
*\  it_result-modesc = it_makt-maktx.
*}   DELETE
*{   INSERT         CD2K940630                                        4
  IF sy-subrc EQ 0.
    it_result-modesc = it_makt-maktx.
  ENDIF.
*}   INSERT

* Get equipment's acquisition value and acquisition and desactivation dates
  READ TABLE it_invest WITH KEY equnr = it_eq-equnr.
  IF sy-subrc = 0.
    it_result-answl = it_invest-answl.
    it_result-zugdt = it_invest-zugdt.
    it_result-deakt = it_invest-deakt.
  ELSE.
    it_result-answl = 0.
    it_result-zugdt = '00000101'.
    it_result-deakt = '99991231'.
  ENDIF.

* Calculate number of days for each reference period, minding the equipment's acquisition
* Within selection dates
  PERFORM calc_acq_scrp_period
    USING
      p_angdt
      p_bnddt
    CHANGING
      it_result-period.
* Month to Date
  PERFORM calc_acq_scrp_period
    USING
      lv_dtms
      sy-datum
    CHANGING
      lv_permtd.
* Year to date
  PERFORM calc_acq_scrp_period
    USING
      lv_dtys
      sy-datum
    CHANGING
      lv_perytd.
* One month rolling
  PERFORM calc_acq_scrp_period
    USING
      lv_dtma
      sy-datum
    CHANGING
      lv_peromr.
* 3 month rolling
  PERFORM calc_acq_scrp_period
    USING
      lv_dtma3
      sy-datum
    CHANGING
      lv_peromr3.
* 6 month rolling
  PERFORM calc_acq_scrp_period
    USING
      lv_dtma6
      sy-datum
    CHANGING
      lv_peromr6.
* 12 months rolling
  PERFORM calc_acq_scrp_period
    USING
      lv_dtya
      sy-datum
    CHANGING
      lv_pertmr.
* 1 months rolling one year ago
  PERFORM calc_acq_scrp_period
    USING
      lv_dtym
      lv_dtya
    CHANGING
      lv_perymr.

* Acquisition Value take into Account Period.
  it_result-answl_p = it_result-answl * it_result-period
                     / lv_tage .

ENDFORM.    " copy_static_data

***********************************************************************
*  Form CALC_DYN_DATA                                                 *
***********************************************************************
* Calculates the periods when equipment is rented and adds to the     *
* total equipment's day usage and revenue. This form is called in the *
* sales record loop within the equipment loop.                        *
***********************************************************************
FORM calc_dyn_data.

* Period (from Selection parameters)
* ----------------------------------
  arg_angdt = p_angdt.
  arg_bnddt = p_bnddt.
  PERFORM calc_period.
* If sales order
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    it_result-absuse = it_result-absuse + lv_period.
  ENDIF.
* If Service Order
  IF it_sesme-auart = lc_serv.
    it_result-nonuse = it_result-nonuse + lv_period.
    it_result-insrab = it_result-insrab + lv_period.
  ENDIF.
* If Transport
  IF ( it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    it_result-nonuse = it_result-nonuse + lv_period.
    it_result-intrab = it_result-intrab + lv_period.
  ENDIF.

* Month to date
* -------------
  arg_angdt = lv_dtms.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_mtduse = lv_mtduse + lv_period.
  ENDIF.
* If Service or Transport
  IF ( it_sesme-auart = lc_serv OR
       it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    lv_mtdnon = lv_mtdnon + lv_period.
  ENDIF.

* Year to Date
* ------------
  arg_angdt = lv_dtys.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_ytduse = lv_ytduse + lv_period.
  ENDIF.
* If Service or Transport
  IF ( it_sesme-auart = lc_serv OR
       it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    lv_ytdnon = lv_ytdnon + lv_period.
  ENDIF.

* One Month Rolling
* -----------------
  arg_angdt = lv_dtma.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_romuse = lv_romuse + lv_period.
  ENDIF.
* If Service or Transport
  IF ( it_sesme-auart = lc_serv OR
       it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    lv_romnon = lv_romnon + lv_period.
  ENDIF.

* 3 Months Rolling
* -----------------
  arg_angdt = lv_dtma3.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_romuse3 = lv_romuse3 + lv_period.
  ENDIF.
* If Service or Transport
  IF ( it_sesme-auart = lc_serv OR
       it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    lv_romnon3 = lv_romnon3 + lv_period.
  ENDIF.

* 6 Months Rolling
* -----------------
  arg_angdt = lv_dtma6.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_romuse6 = lv_romuse6 + lv_period.
  ENDIF.
* If Service or Transport
  IF ( it_sesme-auart = lc_serv OR
       it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    lv_romnon6 = lv_romnon6 + lv_period.
  ENDIF.

* Twelve Months Rolling
* ---------------------
  arg_angdt = lv_dtya.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_roluse = lv_roluse + lv_period.
  ENDIF.    " Only contract documents
* If Service or Transport
  IF ( it_sesme-auart = lc_serv OR
       it_sesme-auart = lc_deli OR
       it_sesme-auart = lc_delo ).
    lv_rolnon = lv_rolnon + lv_period.
  ENDIF.

* One Month Rolling one year ago (Month Comparison)
* ------------------------------
  arg_angdt = lv_dtym.
  arg_bnddt = sy-datum.
  PERFORM calc_period.
* If Rental Contract
  IF ( it_sesme-auart = lc_ctr1 OR
       it_sesme-auart = lc_ctr2 OR
       it_sesme-auart = lc_ctr3 OR
       it_sesme-auart = lc_ctr4 ).
    lv_comuse = lv_comuse + lv_period.
  ENDIF.

ENDFORM.  " calc_dyn_data


***********************************************************************
*  Form CALC_PERIOD                                                   *
***********************************************************************
* Takes a start date and an end date as arguments and calculated the  *
* number of days in between as exit value.                            *
***********************************************************************
FORM calc_period.

* Get the latest start date (selection - contract start - investm date)
  IF it_sesme-angdt < arg_angdt.
    lv_angdt = arg_angdt.
  ELSE.
    lv_angdt = it_sesme-angdt.
  ENDIF.
  IF it_invest-zugdt > lv_angdt.      " recent investment date
    lv_angdt = it_invest-zugdt.
  ENDIF.

* Get the earliest end date (selection - contract start - deactiv date)
  IF it_sesme-bnddt > arg_bnddt.
    lv_bnddt = arg_bnddt.
  ELSE.
    lv_bnddt = it_sesme-bnddt.
  ENDIF.
  IF NOT it_invest-deakt IS INITIAL   " deactivation date
     AND it_invest-deakt < lv_bnddt.
    lv_bnddt = it_invest-deakt.
  ENDIF.

* Check if previous docs have overlapping interval
  LOOP AT it_sesme.
*   Only check previous records -> they have priority
    IF sy-tabix GE lv_sesme_idx.
      EXIT.
    ENDIF.
*   If start date lies within previous record's interval...
    IF lv_angdt GE it_sesme-angdt AND
       lv_angdt LE it_sesme-bnddt.
*     then start date starts after previous record's end date
      lv_angdt = it_sesme-bnddt + 1.
    ENDIF.
*   If end date lies within previous record's end date...
    IF lv_bnddt GE it_sesme-angdt AND
       lv_bnddt LE it_sesme-bnddt.
*     then end date must start before previous records start date.
*     If that would create an impossible interval, then it will
*     be discarded in period > 0 test.
      CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
        EXPORTING
          date      = it_sesme-angdt
          days      = 1
          months    = 0
          signum    = '-'
          years     = 0
        IMPORTING
          calc_date = lv_bnddt.
    ENDIF.
  ENDLOOP.

  IF lv_bnddt < lv_angdt.
    lv_period = 0.
  ELSE.
    lv_period = lv_bnddt - lv_angdt + 1.
  ENDIF.

ENDFORM.  " calc_period

***********************************************************************
*  Form CALC_ACQ_SCRP_PERIOD                                          *
*---------------------------------------------------------------------*
* Arguments:                                                          *
*   ARG_ANGDT  Start date                                             *
*   ARG_BNDDT  End date                                               *
* Return value:                                                       *
*   RET_PERIOD                                                        *
*---------------------------------------------------------------------*
* Calculates the period in days between a start and en end date and   *
* readjust this period to the acquistion date and the scrapping date. *
***********************************************************************
FORM calc_acq_scrp_period  USING    arg_angdt TYPE dats
                                    arg_bnddt TYPE dats
                           CHANGING ret_period LIKE it_result-period.

  DATA:
    loc_angdt TYPE dats,
    loc_bnddt TYPE dats.

* Calculate equipment's period
* Get the latest start date (selection or investment date)
  IF it_result-zugdt > arg_angdt.      " recent investment date
    loc_angdt = it_result-zugdt.
  ELSE.
    loc_angdt = arg_angdt.
  ENDIF.
* Get the earliest end date (selection or deactivation date)
  IF it_result-deakt < arg_bnddt AND NOT it_result-deakt IS INITIAL. " early deactivation date
    loc_bnddt = it_result-deakt.
  ELSE.
    loc_bnddt = arg_bnddt.
  ENDIF.

* Calculate number of days over the different reference periods
* Selection dates
  IF loc_bnddt < loc_angdt.
    ret_period = 0.
  ELSE.
    ret_period = loc_bnddt - loc_angdt + 1.
  ENDIF.

ENDFORM.  " calc_acq_scrp_period

***********************************************************************
*  Form CALC_RESULTS                                                  *
***********************************************************************
* Based on the data calculated in the it_sme loop, the final results  *
* calculated in this form and copied into table it_result for display.*
***********************************************************************
FORM calc_results.

* Absolute Availibility (in Yard)
  it_result-inavab = it_result-period - it_result-absuse -
                     it_result-intrab - it_result-insrab.

  IF it_result-period > 0.
*   Financial utilisation (%) over selected period
*   Note: Change of formula Financial Utilisation
    it_result-peruti = it_result-absuse / it_result-period * 100.
*   Total Physical inefficiency
    it_result-ineffi = it_result-nonuse / it_result-period * 100.
*   Physical inefficiency due to Service Orders
    it_result-insrpr = it_result-insrab * 100 / it_result-period.
*   Physical inefficiency due to Transport
    it_result-intrpr = it_result-intrab * 100 / it_result-period.
*   Physical inefficiency due to Availibilitry in Yard
    it_result-inavpr = it_result-inavab * 100 / it_result-period.
  ELSE.
    it_result-peruti = 0.
    it_result-ineffi = 0.
    it_result-insrpr = 0.
    it_result-intrpr = 0.
    it_result-inavpr = 0.
  ENDIF.

* Financial Utilization/Inefficiency/Availibility Month to Date
  IF lv_permtd > 0.
    it_result-mtduti = lv_mtduse / lv_permtd * 100.
    it_result-mtdinf = lv_mtdnon / lv_permtd * 100.
    lv_mtdavl = lv_permtd - lv_mtduse - lv_mtdnon.
    it_result-mtdavl = lv_mtdavl / lv_permtd * 100.
  ELSE.
    it_result-mtduti = 0.
    it_result-mtdinf = 0.
    it_result-mtdavl = 0.
  ENDIF.
* Financial Utilization/Inefficiency/Availibility Year to Date
  IF lv_perytd > 0.
    it_result-ytduti = lv_ytduse / lv_perytd * 100.
    it_result-ytdinf = lv_ytdnon / lv_perytd * 100.
    lv_ytdavl = lv_perytd - lv_ytduse - lv_ytdnon.
    it_result-ytdavl = lv_ytdavl / lv_perytd * 100.
  ELSE.
    it_result-ytduti = 0.
    it_result-ytdinf = 0.
    it_result-ytdavl = 0.
  ENDIF.
* Financial Utilization/Inefficiency/Availibiliy 1 Month Rolling
  IF lv_peromr > 0.
    it_result-romuti = lv_romuse / lv_peromr * 100.
    it_result-rominf = lv_romnon / lv_peromr * 100.
    lv_romavl = lv_peromr - lv_romuse - lv_romnon.
    it_result-romavl = lv_romavl / lv_peromr * 100.
  ELSE.
    it_result-romuti = 0.
    it_result-rominf = 0.
    it_result-romavl = 0.
  ENDIF.
* Financial Utilization/Inefficiency/Availibiliy 3 Month Rolling
  IF lv_peromr3 > 0.
    it_result-romuti3 = lv_romuse3 / lv_peromr3 * 100.
    it_result-rominf3 = lv_romnon3 / lv_peromr3 * 100.
    lv_romavl3 = lv_peromr3 - lv_romuse3 - lv_romnon3.
    it_result-romavl3 = lv_romavl3 / lv_peromr3 * 100.
  ELSE.
    it_result-romuti = 0.
    it_result-rominf = 0.
    it_result-romavl = 0.
  ENDIF.
* Financial Utilization/Inefficiency/Availibiliy 6 Month Rolling
  IF lv_peromr > 0.
    it_result-romuti6 = lv_romuse6 / lv_peromr6 * 100.
    it_result-rominf6 = lv_romnon6 / lv_peromr6 * 100.
    lv_romavl6 = lv_peromr6 - lv_romuse6 - lv_romnon6.
    it_result-romavl6 = lv_romavl6 / lv_peromr6 * 100.
  ELSE.
    it_result-romuti = 0.
    it_result-rominf = 0.
    it_result-romavl = 0.
  ENDIF.
* Financial Utilization/Inefficiency/Availibility 12 Months Rolling
  IF lv_pertmr > 0.
    it_result-roluti = lv_roluse / lv_pertmr * 100.
    it_result-rolinf = lv_rolnon / lv_pertmr * 100.
    lv_rolavl = lv_pertmr - lv_roluse - lv_rolnon.
    it_result-rolavl = lv_rolavl / lv_pertmr * 100.
  ELSE.
    it_result-roluti = 0.
    it_result-rolinf = 0.
    it_result-rolavl = 0.
  ENDIF.
* Financial Utilization Month comparison
  IF lv_comuse > 0.
    it_result-comuti = lv_romuse / lv_comuse * 100.
  ELSE.
    it_result-comuti = 0.        " to infinity and beyond!
  ENDIF.

* Acquisition Value take into Account Period.
  it_result-answl_p = it_result-answl * it_result-period
                     / lv_tage .



* Acquisition Value x Financial Utilisation
*  it_result-anuti =  it_result-answl * it_result-peruti / 100 .
  it_result-anuti =  it_result-answl_p * it_result-peruti / 100 .


* Acquisition Value x Financial Inefficiency
*  it_result-inuti =  it_result-answl * it_result-ineffi / 100 .
  it_result-inuti =  it_result-answl_p * it_result-ineffi / 100 .




* Clear intermediary variables
  CLEAR lv_mtduse.
  CLEAR lv_ytduse.
  CLEAR lv_romuse.
  CLEAR lv_roluse.

  CLEAR lv_permtd.
  CLEAR lv_mtduse.
  CLEAR lv_mtdnon.
  CLEAR lv_mtdavl.

  CLEAR lv_perytd.
  CLEAR lv_ytduse.
  CLEAR lv_ytdnon.
  CLEAR lv_ytdavl.

  CLEAR lv_peromr.
  CLEAR lv_romuse.
  CLEAR lv_romnon.
  CLEAR lv_romavl.

  CLEAR lv_peromr3.
  CLEAR lv_romuse3.
  CLEAR lv_romnon3.
  CLEAR lv_romavl3.

  CLEAR lv_peromr6.
  CLEAR lv_romuse6.
  CLEAR lv_romnon6.
  CLEAR lv_romavl6.

  CLEAR lv_pertmr.
  CLEAR lv_roluse.
  CLEAR lv_rolnon.
  CLEAR lv_rolavl.

ENDFORM.    " calc_results

***********************************************************************
** FORM  CALC_MEAN                                                    *
***********************************************************************
* Runs through the output table and calculates mean values on ROI     *
* field for aggregations on Machine GAC, Machine PGC, Revenue PGC and *
* model. This simulates and ALV grid layout with mean values, but the *
* averages need to be 'weighted' by the equipment's revenue.          *
***********************************************************************
FORM calc_mean.

  DATA:
    lv_mgac        TYPE yse_pgc_gac-gac,
    lv_mgac_answl  TYPE f,
    lv_mgac_answl_p  TYPE f,
    lv_mgac_anuti  TYPE f,
    lv_mgac_inuti  TYPE f,

    lv_mgac_mtdu   TYPE f,
    lv_mgac_ytdu   TYPE f,
    lv_mgac_rolu   TYPE f,
    lv_mgac_romu   TYPE f,
    lv_mgac_mtdi   TYPE f,
    lv_mgac_ytdi   TYPE f,
    lv_mgac_roli   TYPE f,
    lv_mgac_romi   TYPE f,
    lv_mgac_mtda   TYPE f,
    lv_mgac_ytda   TYPE f,
    lv_mgac_rola   TYPE f,
    lv_mgac_roma   TYPE f,

    lv_mpgc        TYPE yse_pgc_gac-pgc,
    lv_mpgc_answl  TYPE f,
    lv_mpgc_anuti  TYPE f,
    lv_mpgc_inuti  TYPE f,

    lv_mpgc_mtdu   TYPE f,
    lv_mpgc_ytdu   TYPE f,
    lv_mpgc_rolu   TYPE f,
    lv_mpgc_romu   TYPE f,
    lv_mpgc_mtdi   TYPE f,
    lv_mpgc_ytdi   TYPE f,
    lv_mpgc_roli   TYPE f,
    lv_mpgc_romi   TYPE f,
    lv_mpgc_mtda   TYPE f,
    lv_mpgc_ytda   TYPE f,
    lv_mpgc_rola   TYPE f,
    lv_mpgc_roma   TYPE f,

    lv_modl        TYPE matnr,
    lv_modl_answl  TYPE f,
    lv_modl_anuti  TYPE f,
    lv_modl_inuti  TYPE f,

    lv_modl_mtdu   TYPE f,
    lv_modl_ytdu   TYPE f,
    lv_modl_rolu   TYPE f,
    lv_modl_romu   TYPE f,
    lv_modl_mtda   TYPE f,
    lv_modl_ytda   TYPE f,
    lv_modl_rola   TYPE f,
    lv_modl_roma   TYPE f,
    lv_modl_mtdi   TYPE f,
    lv_modl_ytdi   TYPE f,
    lv_modl_roli   TYPE f,
    lv_modl_romi   TYPE f,

    lv_gtot_answl  TYPE f,
    lv_gtot_answl_p  TYPE f,
    lv_gtot_anuti  TYPE f,
    lv_gtot_inuti  TYPE f,

    lv_gtot_mtdu   TYPE f,
    lv_gtot_ytdu   TYPE f,
    lv_gtot_rolu   TYPE f,
    lv_gtot_romu   TYPE f,
    lv_gtot_mtdi   TYPE f,
    lv_gtot_ytdi   TYPE f,
    lv_gtot_roli   TYPE f,
    lv_gtot_romi   TYPE f,
    lv_gtot_mtda   TYPE f,
    lv_gtot_ytda   TYPE f,
    lv_gtot_rola   TYPE f,
    lv_gtot_roma   TYPE f,
    lv_modl_answl_p TYPE f,
    lv_mpgc_answl_p TYPE F .

* Sort the output table in order of averages
  SORT it_result BY gac pgc rpgc model.

* Read first record to initialize the averaging loop
  READ TABLE it_result INDEX 1.
  IF sy-subrc = 0.
    lv_mgac   = it_result-gac.
    lv_mpgc   = it_result-pgc.
*   lv_rpgc   = it_result-rpgc.
    lv_modl   = it_result-model.

*   Go through all output records to insert averages
    LOOP AT it_result.
*     Color standard record
      it_result-linecolor = gc_yellow.
*     Update actual normal record
      MODIFY it_result.

*     Average by Model
*     ----------------
*     While model stays the same, add entries
      IF ( it_result-model = lv_modl AND
*          it_result-rpgc  = lv_rpgc AND
           it_result-pgc   = lv_mpgc AND
           it_result-gac   = lv_mgac ).
*       Acquisition value
        lv_modl_answl = lv_modl_answl + it_result-answl.
*       Adjusted Acquisition value
        lv_modl_answl_p = lv_modl_answl_p + it_result-answl_p.
*       Absolute utilization (days)
        lv_modl_anuti = lv_modl_anuti + it_result-anuti.
*       Absolute inefficiency (days)
        lv_modl_inuti = lv_modl_inuti + it_result-inuti.
*       Month to Date utilization (percentile)
*        lv_modl_mtdu = lv_modl_mtdu + ( it_result-mtduti * it_result-answl ).
        lv_modl_mtdu = lv_modl_mtdu + ( it_result-mtduti * it_result-answl_p ).
*       Month to Date inefficiency (percentile)
*        lv_modl_mtdi = lv_modl_mtdi + ( it_result-mtdinf * it_result-answl ).
        lv_modl_mtdi = lv_modl_mtdi + ( it_result-mtdinf * it_result-answl_p ).
*       Month to Date availability (percentile)
*        lv_modl_mtda = lv_modl_mtda + ( it_result-mtdavl * it_result-answl ).
        lv_modl_mtda = lv_modl_mtda + ( it_result-mtdavl * it_result-answl_p ).
*       Year to Date utilization (percentile)
*        lv_modl_ytdu = lv_modl_ytdu + ( it_result-ytduti * it_result-answl ).
        lv_modl_ytdu = lv_modl_ytdu + ( it_result-ytduti * it_result-answl_p ).
*       Year to Date inefficiency (percentile)
*        lv_modl_ytdi = lv_modl_ytdi + ( it_result-ytdinf * it_result-answl ).
        lv_modl_ytdi = lv_modl_ytdi + ( it_result-ytdinf * it_result-answl_p ).

*       Year to Date availability (percentile)
*        lv_modl_ytda = lv_modl_ytda + ( it_result-ytdavl * it_result-answl ).
        lv_modl_ytda = lv_modl_ytda + ( it_result-ytdavl * it_result-answl_p ).
*       1 Month Rolling utilization (percentile)
*        lv_modl_romu = lv_modl_romu + ( it_result-romuti * it_result-answl ).
         lv_modl_romu = lv_modl_romu + ( it_result-romuti * it_result-answl_p ).
*       1 Month Rolling inefficiency (percentile)
*        lv_modl_romi = lv_modl_romi + ( it_result-rominf * it_result-answl ).
        lv_modl_romi = lv_modl_romi + ( it_result-rominf * it_result-answl_p ).
*       1 Month Rolling availability (percentile)
*        lv_modl_roma = lv_modl_roma + ( it_result-romavl * it_result-answl ).
        lv_modl_roma = lv_modl_roma + ( it_result-romavl * it_result-answl_p ).
*       12 Month Rolling utilization (percentile)
*        lv_modl_rolu = lv_modl_rolu + ( it_result-roluti * it_result-answl ).
        lv_modl_rolu = lv_modl_rolu + ( it_result-roluti * it_result-answl_p ).
*       12 Month Rolling inefficiency (percentile)
*        lv_modl_roli = lv_modl_roli + ( it_result-rolinf * it_result-answl ).
        lv_modl_roli = lv_modl_roli + ( it_result-rolinf * it_result-answl_p ).
*       12 Month Rolling availability (percentile)
*        lv_modl_rola = lv_modl_rola + ( it_result-rolavl * it_result-answl ).
        lv_modl_rola = lv_modl_rola + ( it_result-rolavl * it_result-answl_p ).
      ELSE.
*       Build mean value
        CLEAR wa_result.
*       Set line color
        wa_result-linecolor = gc_gray.
*       Copy summation title
        wa_result-model = lv_modl.
*       Copy sum of Acquistion values
        wa_result-answl = lv_modl_answl.
*       Copy sum of Adjusted Acquistion values
        wa_result-answl_p = lv_modl_answl_p.
*       Copy sum of absolute utilization
        wa_result-anuti = lv_modl_anuti.
*       Copy sum of absolute inefficiency
        wa_result-inuti = lv_modl_inuti.
        IF wa_result-answl <> 0.
*         Calculate weighted absolute utilization
*          wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
          wa_result-peruti = wa_result-anuti / wa_result-answl_p * 100.
*         Calculate weighted inefficiency Month to Date
*          wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
          wa_result-ineffi = wa_result-inuti / wa_result-answl_p * 100.
*         Calculate weighted month to date utilization
*          wa_result-mtduti = lv_modl_mtdu / wa_result-answl.
          wa_result-mtduti = lv_modl_mtdu / wa_result-answl_p.
*         Calculate weigthed month to date inefficiency
*          wa_result-mtdinf = lv_modl_mtdi / wa_result-answl.
          wa_result-mtdinf = lv_modl_mtdi / wa_result-answl_p.
*         Calculate weighted month to date availability
*          wa_result-mtdavl = lv_modl_mtda / wa_result-answl.
          wa_result-mtdavl = lv_modl_mtda / wa_result-answl_p.
*         Calculate weighted year to date utilization
*          wa_result-ytduti = lv_modl_ytdu / wa_result-answl.
          wa_result-ytduti = lv_modl_ytdu / wa_result-answl_p.
*         Calculate weighted year to date inefficiency
*          wa_result-ytdinf = lv_modl_ytdi / wa_result-answl.
          wa_result-ytdinf = lv_modl_ytdi / wa_result-answl_p.
*         Calculate weighted year to date availability
*          wa_result-ytdavl = lv_modl_ytda / wa_result-answl.
          wa_result-ytdavl = lv_modl_ytda / wa_result-answl_p.
*         Calculate weighted 1 month rolling utilization
*          wa_result-romuti = lv_modl_romu / wa_result-answl.
          wa_result-romuti = lv_modl_romu / wa_result-answl_p.
*         Calculate weighted 1 month rolling inefficiency
*          wa_result-rominf = lv_modl_romi / wa_result-answl.
          wa_result-rominf = lv_modl_romi / wa_result-answl_p.
*         Calculate weighted 1 month rolling availability
*          wa_result-romavl = lv_modl_roma / wa_result-answl.
          wa_result-romavl = lv_modl_roma / wa_result-answl_p.
*         Calculate weighted 12 months rolling utilization
*          wa_result-roluti = lv_modl_rolu / wa_result-answl.
          wa_result-roluti = lv_modl_rolu / wa_result-answl_p.
*         Calculate weighted 12 months rolling inefficiency
*          wa_result-rolinf = lv_modl_roli / wa_result-answl.
          wa_result-rolinf = lv_modl_roli / wa_result-answl_p.
*         Calculate weighted 12 months rolling availability
*          wa_result-rolavl = lv_modl_rola / wa_result-answl.
          wa_result-rolavl = lv_modl_rola / wa_result-answl_p.
        ELSE.
*         Clear output variables
          PERFORM clear_weighted_averages.
        ENDIF.

*       Insert new line
        INSERT wa_result INTO it_result.

*       Reset for new range of Model
        lv_modl = it_result-model.
        lv_modl_answl = it_result-answl.
        lv_modl_answl_p = it_result-answl_p.
        lv_modl_anuti = it_result-anuti.
        lv_modl_inuti = it_result-inuti.
*        lv_modl_mtdu = it_result-mtduti * it_result-answl.
*        lv_modl_mtdi = it_result-mtdinf * it_result-answl.
*        lv_modl_mtda = it_result-mtdavl * it_result-answl.
*        lv_modl_ytdu = it_result-ytduti * it_result-answl.
*        lv_modl_ytdi = it_result-ytdinf * it_result-answl.
*        lv_modl_ytda = it_result-ytdavl * it_result-answl.
*        lv_modl_romu = it_result-romuti * it_result-answl.
*        lv_modl_romi = it_result-rominf * it_result-answl.
*        lv_modl_roma = it_result-romavl * it_result-answl.
*        lv_modl_rolu = it_result-roluti * it_result-answl.
*        lv_modl_roli = it_result-rolinf * it_result-answl.
*        lv_modl_rola = it_result-rolavl * it_result-answl.

        lv_modl_mtdu = it_result-mtduti * it_result-answl_p.
        lv_modl_mtdi = it_result-mtdinf * it_result-answl_p.
        lv_modl_mtda = it_result-mtdavl * it_result-answl_p.
        lv_modl_ytdu = it_result-ytduti * it_result-answl_p.
        lv_modl_ytdi = it_result-ytdinf * it_result-answl_p.
        lv_modl_ytda = it_result-ytdavl * it_result-answl_p.
        lv_modl_romu = it_result-romuti * it_result-answl_p.
        lv_modl_romi = it_result-rominf * it_result-answl_p.
        lv_modl_roma = it_result-romavl * it_result-answl_p.
        lv_modl_rolu = it_result-roluti * it_result-answl_p.
        lv_modl_roli = it_result-rolinf * it_result-answl_p.
        lv_modl_rola = it_result-rolavl * it_result-answl_p.

      ENDIF.

**     Average by Revenue PGC
**     ----------------------
*      IF ( it_result-rpgc  = lv_rpgc AND
*           it_result-pgc   = lv_mpgc AND
*           it_result-gac   = lv_mgac ).
*        lv_rpgc_answl = lv_rpgc_answl + it_result-answl.
*        lv_rpgc_anuti = lv_rpgc_anuti + it_result-anuti.
*        lv_rpgc_inuti = lv_rpgc_inuti + it_result-inuti.
*lv_rpgc_mtdu = lv_rpgc_mtdu + ( it_result-mtduti * it_result-answl ).
*lv_rpgc_mtdi = lv_rpgc_mtdi + ( it_result-mtdinf * it_result-answl ).
*lv_rpgc_mtda = lv_rpgc_mtda + ( it_result-mtdavl * it_result-answl ).
*lv_rpgc_ytdu = lv_rpgc_ytdu + ( it_result-ytduti * it_result-answl ).
*lv_rpgc_ytdi = lv_rpgc_ytdi + ( it_result-ytdinf * it_result-answl ).
*lv_rpgc_ytda = lv_rpgc_ytda + ( it_result-ytdavl * it_result-answl ).
*lv_rpgc_romu = lv_rpgc_romu + ( it_result-romuti * it_result-answl ).
*lv_rpgc_romi = lv_rpgc_romi + ( it_result-rominf * it_result-answl ).
*lv_rpgc_roma = lv_rpgc_roma + ( it_result-romavl * it_result-answl ).
*lv_rpgc_rolu = lv_rpgc_rolu + ( it_result-roluti * it_result-answl ).
*lv_rpgc_roli = lv_rpgc_roli + ( it_result-rolinf * it_result-answl ).
*lv_rpgc_rola = lv_rpgc_rola + ( it_result-rolavl * it_result-answl ).
*      ELSE.
**       Build mean value
*        CLEAR wa_result.
*        wa_result-linecolor = gc_green.
*        wa_result-rpgc = lv_rpgc.
*        wa_result-answl = lv_rpgc_answl.
*        wa_result-anuti = lv_rpgc_anuti.
*        wa_result-inuti = lv_rpgc_inuti.
*        IF wa_result-answl <> 0.
*          wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
*          wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
*          wa_result-mtdu = lv_rpgc_mtdu / wa_result-answl.
*          wa_result-mtdi = lv_rpgc_mtdi / wa_result-answl.
*          wa_result-mtda = lv_rpgc_mtda / wa_result-answl.
*          wa_result-ytdu = lv_rpgc_ytdu / wa_result-answl.
*          wa_result-ytdi = lv_rpgc_ytdi / wa_result-answl.
*          wa_result-ytda = lv_rpgc_ytda / wa_result-answl.
*          wa_result-romu = lv_rpgc_romu / wa_result-answl.
*          wa_result-romi = lv_rpgc_romi / wa_result-answl.
*          wa_result-roma = lv_rpgc_roma / wa_result-answl.
*          wa_result-rolu = lv_rpgc_rolu / wa_result-answl.
*          wa_result-roli = lv_rpgc_roli / wa_result-answl.
*          wa_result-rola = lv_rpgc_rola / wa_result-answl.
*        ELSE.
*          PERFORM clear_weighted_averages.
*        ENDIF.
*
**       Insert new line
*        INSERT wa_result INTO it_result.
*
**       Reset for new range of PGC
*        lv_rpgc = it_result-rpgc.
*        lv_rpgc_answl = it_result-answl.
*        lv_rpgc_anuti = it_result-anuti.
*        lv_rpgc_inuti = it_result-inuti.
*        lv_rpgc_mtdu = it_result-mtduti * it_result-answl.
*        lv_rpgc_mtdi = it_result-mtdinf * it_result-answl.
*        lv_rpgc_mtda = it_result-mtdavl * it_result-answl.
*        lv_rpgc_ytdu = it_result-ytduti * it_result-answl.
*        lv_rpgc_ytdi = it_result-ytdinf * it_result-answl.
*        lv_rpgc_ytda = it_result-ytdavl * it_result-answl.
*        lv_rpgc_romu = it_result-romuti * it_result-answl.
*        lv_rpgc_romi = it_result-romavl * it_result-answl.
*        lv_rpgc_roma = it_result-romavl * it_result-answl.
*        lv_rpgc_rolu = it_result-roluti * it_result-answl.
*        lv_rpgc_roli = it_result-rolinf * it_result-answl.
*        lv_rpgc_rola = it_result-rolavl * it_result-answl.
*      ENDIF.

*     Average by Machine PGC
*     ----------------------
      IF ( it_result-pgc   = lv_mpgc AND
           it_result-gac   = lv_mgac ).
        lv_mpgc_answl = lv_mpgc_answl + it_result-answl.
        lv_mpgc_answl_p = lv_mpgc_answl_p + it_result-answl_p.
        lv_mpgc_anuti = lv_mpgc_anuti + it_result-anuti.
        lv_mpgc_inuti = lv_mpgc_inuti + it_result-inuti.
        lv_mpgc_mtdu = lv_mpgc_mtdu + ( it_result-mtduti *
        it_result-answl ).
        lv_mpgc_mtdi = lv_mpgc_mtdi + ( it_result-mtdinf *
        it_result-answl ).
        lv_mpgc_mtda = lv_mpgc_mtda + ( it_result-mtdavl *
        it_result-answl ).
        lv_mpgc_ytdu = lv_mpgc_ytdu + ( it_result-ytduti *
        it_result-answl ).
        lv_mpgc_ytdi = lv_mpgc_ytdi + ( it_result-ytdinf *
        it_result-answl ).
        lv_mpgc_ytda = lv_mpgc_ytda + ( it_result-ytdavl *
        it_result-answl ).
        lv_mpgc_romu = lv_mpgc_romu + ( it_result-romuti *
        it_result-answl ).
        lv_mpgc_romi = lv_mpgc_romi + ( it_result-rominf *
        it_result-answl ).
        lv_mpgc_roma = lv_mpgc_roma + ( it_result-romavl *
        it_result-answl ).
        lv_mpgc_rolu = lv_mpgc_rolu + ( it_result-roluti *
        it_result-answl ).
        lv_mpgc_roli = lv_mpgc_roli + ( it_result-rolinf *
        it_result-answl ).
        lv_mpgc_rola = lv_mpgc_rola + ( it_result-rolavl *
        it_result-answl ).
      ELSE.
*       Build mean value
        CLEAR wa_result.
        wa_result-linecolor = gc_bluish.
        wa_result-pgc = lv_mpgc.
        wa_result-answl = lv_mpgc_answl.
        wa_result-answl_p = lv_mpgc_answl_p.
        wa_result-anuti = lv_mpgc_anuti.
        wa_result-inuti = lv_mpgc_inuti.
        IF wa_result-answl <> 0.
          wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
          wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
          wa_result-mtduti = lv_mpgc_mtdu / wa_result-answl.
          wa_result-mtdinf = lv_mpgc_mtdi / wa_result-answl.
          wa_result-mtdavl = lv_mpgc_mtda / wa_result-answl.
          wa_result-ytduti = lv_mpgc_ytdu / wa_result-answl.
          wa_result-ytdinf = lv_mpgc_ytdi / wa_result-answl.
          wa_result-ytdavl = lv_mpgc_ytda / wa_result-answl.
          wa_result-romuti = lv_mpgc_romu / wa_result-answl.
          wa_result-rominf = lv_mpgc_romi / wa_result-answl.
          wa_result-romavl = lv_mpgc_roma / wa_result-answl.
          wa_result-roluti = lv_mpgc_rolu / wa_result-answl.
          wa_result-rolinf = lv_mpgc_roli / wa_result-answl.
          wa_result-rolavl = lv_mpgc_rola / wa_result-answl.
        ELSE.
          PERFORM clear_weighted_averages.
        ENDIF.

*       Insert new line
        INSERT wa_result INTO it_result.

*       Reset for new range of PGC
        lv_mpgc = it_result-pgc.
        lv_mpgc_answl = it_result-answl.
        lv_mpgc_answl_p = it_result-answl_p.
        lv_mpgc_anuti = it_result-anuti.
        lv_mpgc_inuti = it_result-inuti.
        lv_mpgc_mtdu = it_result-mtduti * it_result-answl.
        lv_mpgc_mtdi = it_result-mtdinf * it_result-answl.
        lv_mpgc_mtda = it_result-mtdavl * it_result-answl.
        lv_mpgc_ytdu = it_result-ytduti * it_result-answl.
        lv_mpgc_ytdi = it_result-ytdinf * it_result-answl.
        lv_mpgc_ytda = it_result-ytdavl * it_result-answl.
        lv_mpgc_romu = it_result-romuti * it_result-answl.
        lv_mpgc_romi = it_result-rominf * it_result-answl.
        lv_mpgc_roma = it_result-romavl * it_result-answl.
        lv_mpgc_rolu = it_result-roluti * it_result-answl.
        lv_mpgc_roli = it_result-rolinf * it_result-answl.
        lv_mpgc_rola = it_result-rolavl * it_result-answl.
      ENDIF.

*     Average by Machine GAC
*     ----------------------
      IF it_result-gac = lv_mgac.
        lv_mgac_answl = lv_mgac_answl + it_result-answl.
        lv_mgac_answl_p = lv_mgac_answl_p + it_result-answl_p.
        lv_mgac_anuti = lv_mgac_anuti + it_result-anuti.
        lv_mgac_inuti = lv_mgac_inuti + it_result-inuti.
        lv_mgac_mtdu = lv_mgac_mtdu + ( it_result-mtduti * it_result-answl ).
        lv_mgac_mtdi = lv_mgac_mtdi + ( it_result-mtdinf * it_result-answl ).
        lv_mgac_mtda = lv_mgac_mtda + ( it_result-mtdavl * it_result-answl ).
        lv_mgac_ytdu = lv_mgac_ytdu + ( it_result-ytduti * it_result-answl ).
        lv_mgac_ytdi = lv_mgac_ytdi + ( it_result-ytdinf * it_result-answl ).
        lv_mgac_ytda = lv_mgac_ytda + ( it_result-ytdavl * it_result-answl ).
        lv_mgac_romu = lv_mgac_romu + ( it_result-romuti * it_result-answl ).
        lv_mgac_romi = lv_mgac_romi + ( it_result-rominf * it_result-answl ).
        lv_mgac_roma = lv_mgac_roma + ( it_result-romavl * it_result-answl ).
        lv_mgac_rolu = lv_mgac_rolu + ( it_result-roluti * it_result-answl ).
        lv_mgac_roli = lv_mgac_roli + ( it_result-rolinf * it_result-answl ).
        lv_mgac_rola = lv_mgac_rola + ( it_result-rolavl * it_result-answl ).
      ELSE.
*       Build mean value
        CLEAR wa_result.
        wa_result-linecolor = gc_blue.
        wa_result-gac = lv_mgac.
        wa_result-answl = lv_mgac_answl.
        wa_result-answl_p = lv_mgac_answl_p.
        wa_result-anuti = lv_mgac_anuti.
        wa_result-inuti = lv_mgac_inuti.
        IF wa_result-answl <> 0.
          wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
          wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
          wa_result-mtduti = lv_mgac_mtdu / wa_result-answl.
          wa_result-mtdinf = lv_mgac_mtdi / wa_result-answl.
          wa_result-mtdavl = lv_mgac_mtda / wa_result-answl.
          wa_result-ytduti = lv_mgac_ytdu / wa_result-answl.
          wa_result-ytdinf = lv_mgac_ytdi / wa_result-answl.
          wa_result-ytdavl = lv_mgac_ytda / wa_result-answl.
          wa_result-romuti = lv_mgac_romu / wa_result-answl.
          wa_result-rominf = lv_mgac_romi / wa_result-answl.
          wa_result-romavl = lv_mgac_roma / wa_result-answl.
          wa_result-roluti = lv_mgac_rolu / wa_result-answl.
          wa_result-rolinf = lv_mgac_roli / wa_result-answl.
          wa_result-rolavl = lv_mgac_rola / wa_result-answl.
        ELSE.
          PERFORM clear_weighted_averages.
        ENDIF.

*       Insert new line
        INSERT wa_result INTO it_result.

*       Reset for new range of GAC
        lv_mgac = it_result-gac.
        lv_mgac_answl = it_result-answl.
        lv_mgac_answl_p = it_result-answl_p.
        lv_mgac_anuti = it_result-anuti.
        lv_mgac_inuti = it_result-inuti.
        lv_mgac_mtdu = it_result-mtduti * it_result-answl.
        lv_mgac_mtdi = it_result-mtdinf * it_result-answl.
        lv_mgac_mtda = it_result-mtdavl * it_result-answl.
        lv_mgac_ytdu = it_result-ytduti * it_result-answl.
        lv_mgac_ytdi = it_result-ytdinf * it_result-answl.
        lv_mgac_ytda = it_result-ytdavl * it_result-answl.
        lv_mgac_romu = it_result-romuti * it_result-answl.
        lv_mgac_romi = it_result-rominf * it_result-answl.
        lv_mgac_roma = it_result-romavl * it_result-answl.
        lv_mgac_rolu = it_result-roluti * it_result-answl.
        lv_mgac_roli = it_result-rolinf * it_result-answl.
        lv_mgac_rola = it_result-rolavl * it_result-answl.
      ENDIF.

*     Add for grand totals
      lv_gtot_answl = lv_gtot_answl + it_result-answl.
      lv_gtot_answl_p = lv_gtot_answl_p + it_result-answl_p.
      lv_gtot_anuti = lv_gtot_anuti + it_result-anuti.
      lv_gtot_inuti = lv_gtot_inuti + it_result-inuti.
      lv_gtot_mtdu = lv_gtot_mtdu + ( it_result-mtduti * it_result-answl ).
      lv_gtot_mtdi = lv_gtot_mtdi + ( it_result-mtdinf * it_result-answl ).
      lv_gtot_mtda = lv_gtot_mtda + ( it_result-mtdavl * it_result-answl ).
      lv_gtot_ytdu = lv_gtot_ytdu + ( it_result-ytduti * it_result-answl ).
      lv_gtot_ytdi = lv_gtot_ytdi + ( it_result-ytdinf * it_result-answl ).
      lv_gtot_ytda = lv_gtot_ytda + ( it_result-ytdavl * it_result-answl ).
      lv_gtot_romu = lv_gtot_romu + ( it_result-romuti * it_result-answl ).
      lv_gtot_romi = lv_gtot_romi + ( it_result-rominf * it_result-answl ).
      lv_gtot_roma = lv_gtot_roma + ( it_result-romavl * it_result-answl ).
      lv_gtot_rolu = lv_gtot_rolu + ( it_result-roluti * it_result-answl ).
      lv_gtot_roli = lv_gtot_roli + ( it_result-rolinf * it_result-answl ).
      lv_gtot_rola = lv_gtot_rola + ( it_result-rolavl * it_result-answl ).

    ENDLOOP.  " it_result

*   Closing averages
*   Average by Model
*   ----------------
    CLEAR wa_result.
    wa_result-linecolor = gc_gray.
    wa_result-model = lv_modl.
    wa_result-answl = lv_modl_answl.
    wa_result-answl_p = lv_modl_answl_p.
    wa_result-anuti = lv_modl_anuti.
    wa_result-inuti = lv_modl_inuti.
    IF wa_result-answl <> 0.
      wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
      wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
      wa_result-mtduti = lv_modl_mtdu / wa_result-answl.
      wa_result-mtdinf = lv_modl_mtdi / wa_result-answl.
      wa_result-mtdavl = lv_modl_mtda / wa_result-answl.
      wa_result-ytduti = lv_modl_ytdu / wa_result-answl.
      wa_result-ytdinf = lv_modl_ytdi / wa_result-answl.
      wa_result-ytdavl = lv_modl_ytda / wa_result-answl.
      wa_result-romuti = lv_modl_romu / wa_result-answl.
      wa_result-rominf = lv_modl_romi / wa_result-answl.
      wa_result-romavl = lv_modl_roma / wa_result-answl.
      wa_result-roluti = lv_modl_rolu / wa_result-answl.
      wa_result-rolinf = lv_modl_roli / wa_result-answl.
      wa_result-rolavl = lv_modl_rola / wa_result-answl.
    ELSE.
      PERFORM clear_weighted_averages.
    ENDIF.

*   Insert new line
    APPEND wa_result TO it_result.

**   Average by Revenue PGC
**   ----------------------
*    CLEAR wa_result.
*    wa_result-linecolor = gc_bluish.
*    wa_result-rpgc = lv_rpgc.
*    wa_result-answl = lv_rpgc_answl.
*    wa_result-anuti = lv_rpgc_anuti.
*    wa_result-inuti = lv_rpgc_inuti.
*    IF wa_result-answl <> 0.
*      wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
*      wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
*      wa_result-mtduti = lv_rpgc_mtdu / wa_result-answl.
*      wa_result-mtdinf = lv_rpgc_mtdi / wa_result-answl.
*      wa_result-mtdavl = lv_rpgc_mtda / wa_result-answl.
*      wa_result-ytduti = lv_rpgc_ytdu / wa_result-answl.
*      wa_result-ytdinf = lv_rpgc_ytdi / wa_result-answl.
*      wa_result-ytdavl = lv_rpgc_ytda / wa_result-answl.
*      wa_result-romuti = lv_rpgc_romu / wa_result-answl.
*      wa_result-rominf = lv_rpgc_romi / wa_result-answl.
*      wa_result-romavl = lv_rpgc_roma / wa_result-answl.
*      wa_result-roluti = lv_rpgc_rolu / wa_result-answl.
*      wa_result-rolinf = lv_rpgc_roli / wa_result-answl.
*      wa_result-rolavl = lv_rpgc_rola / wa_result-answl.
*    ELSE.
*      PERFORM clear_weighted_averages.
*    ENDIF.
*
**   Insert new line
*    APPEND wa_result TO it_result.

*   Average by Machine PGC
*   ----------------------
    CLEAR wa_result.
    wa_result-linecolor = gc_bluish.
    wa_result-pgc = lv_mpgc.
    wa_result-answl = lv_mpgc_answl.
    wa_result-answl_p = lv_mpgc_answl_p.
    wa_result-anuti = lv_mpgc_anuti.
    wa_result-inuti = lv_mpgc_inuti.
    IF wa_result-answl <> 0.
      wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
      wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
      wa_result-mtduti = lv_mpgc_mtdu / wa_result-answl.
      wa_result-mtdinf = lv_mpgc_mtdi / wa_result-answl.
      wa_result-mtdavl = lv_mpgc_mtda / wa_result-answl.
      wa_result-ytduti = lv_mpgc_ytdu / wa_result-answl.
      wa_result-ytdinf = lv_mpgc_ytdi / wa_result-answl.
      wa_result-ytdavl = lv_mpgc_ytda / wa_result-answl.
      wa_result-romuti = lv_mpgc_romu / wa_result-answl.
      wa_result-rominf = lv_mpgc_romi / wa_result-answl.
      wa_result-romavl = lv_mpgc_roma / wa_result-answl.
      wa_result-roluti = lv_mpgc_rolu / wa_result-answl.
      wa_result-rolinf = lv_mpgc_roli / wa_result-answl.
      wa_result-rolavl = lv_mpgc_rola / wa_result-answl.
    ELSE.
      PERFORM clear_weighted_averages.
    ENDIF.

*   Insert new line
    APPEND wa_result TO it_result.

*   Average by Machine GAC
*   ----------------------
    CLEAR wa_result.
    wa_result-linecolor = gc_blue.      " gc_green.
    wa_result-gac = lv_mgac.
    wa_result-answl = lv_mgac_answl.
    wa_result-answl_p = lv_mgac_answl_p.
    wa_result-anuti = lv_mgac_anuti.
    wa_result-inuti = lv_mgac_inuti.
    IF wa_result-answl <> 0.
      wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
      wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
      wa_result-mtduti = lv_mgac_mtdu / wa_result-answl.
      wa_result-mtdinf = lv_mgac_mtdi / wa_result-answl.
      wa_result-mtdavl = lv_mgac_mtda / wa_result-answl.
      wa_result-ytduti = lv_mgac_ytdu / wa_result-answl.
      wa_result-ytdinf = lv_mgac_ytdi / wa_result-answl.
      wa_result-ytdavl = lv_mgac_ytda / wa_result-answl.
      wa_result-romuti = lv_mgac_romu / wa_result-answl.
      wa_result-rominf = lv_mgac_romi / wa_result-answl.
      wa_result-romavl = lv_mgac_roma / wa_result-answl.
      wa_result-roluti = lv_mgac_rolu / wa_result-answl.
      wa_result-rolinf = lv_mgac_roli / wa_result-answl.
      wa_result-rolavl = lv_mgac_rola / wa_result-answl.
    ELSE.
      PERFORM clear_weighted_averages.
    ENDIF.

*   Insert new line
    APPEND wa_result TO it_result.

*   Grand Totals
*   ------------
    CLEAR wa_result.
    wa_result-linecolor = gc_red.
    wa_result-answl = lv_gtot_answl.
    wa_result-answl_p = lv_gtot_answl_p.
    wa_result-anuti = lv_gtot_anuti.
    wa_result-inuti = lv_gtot_inuti.
    IF wa_result-answl <> 0.
      wa_result-peruti = wa_result-anuti / wa_result-answl * 100.
      wa_result-ineffi = wa_result-inuti / wa_result-answl * 100.
      wa_result-mtduti = lv_gtot_mtdu / wa_result-answl.
      wa_result-mtdinf = lv_gtot_mtdi / wa_result-answl.
      wa_result-mtdavl = lv_gtot_mtda / wa_result-answl.
      wa_result-ytduti = lv_gtot_ytdu / wa_result-answl.
      wa_result-ytdinf = lv_gtot_ytdi / wa_result-answl.
      wa_result-ytdavl = lv_gtot_ytda / wa_result-answl.
      wa_result-romuti = lv_gtot_romu / wa_result-answl.
      wa_result-rominf = lv_gtot_romi / wa_result-answl.
      wa_result-romavl = lv_gtot_roma / wa_result-answl.
      wa_result-roluti = lv_gtot_rolu / wa_result-answl.
      wa_result-rolinf = lv_gtot_roli / wa_result-answl.
      wa_result-rolavl = lv_gtot_rola / wa_result-answl.
    ELSE.
      PERFORM clear_weighted_averages.
    ENDIF.

*   Insert new line
    APPEND wa_result TO it_result.

  ENDIF.    " data in it_result.
ENDFORM.  " calc_mean


***********************************************************************
** FORM  CLEAR_WEIGHTED AVERAGES                                      *
***********************************************************************
* Clears a destinct number of output fields. This form is called 9    *
* times.
***********************************************************************
FORM clear_weighted_averages.

  wa_result-peruti = 0.
  wa_result-ineffi = 0.
  wa_result-mtduti = 0.
  wa_result-mtdinf = 0.
  wa_result-mtdavl = 0.
  wa_result-ytduti = 0.
  wa_result-ytdinf = 0.
  wa_result-ytdavl = 0.
  wa_result-romuti = 0.
  wa_result-rominf = 0.
  wa_result-romavl = 0.
  wa_result-roluti = 0.
  wa_result-rolinf = 0.
  wa_result-rolavl = 0.

ENDFORM.  " clear_weighted_averages


***********************************************************************
** FORM  BUILD_HEADER                                                 *
***********************************************************************
* Prepares selection parameters to be displayed in header banner.     *
***********************************************************************
FORM build_header.

  o_bukrs = p_bukrs.
  o_werks = so_werk-low.
  o_vkorg = so_vkorg-low.
* Start date
  o_angdt(2)   = p_angdt+6(2).
  o_angdt+2    = '.'.
  o_angdt+3(2) = p_angdt+4(2).
  o_angdt+5    = '.'.
  o_angdt+6(4) = p_angdt(4).
* End date
  o_bnddt(2)   = p_bnddt+6(2).
  o_bnddt+2    = '.'.
  o_bnddt+3(2) = p_bnddt+4(2).
  o_bnddt+5    = '.'.
  o_bnddt+6(4) = p_bnddt(4).

ENDFORM.  " build_header


***********************************************************************
** Module STATUS_0100 OUTPUT                                          *
***********************************************************************
MODULE status_0100 OUTPUT.
  SET TITLEBAR 'TITLE100' .
  SET PF-STATUS 'STATUS100'.
ENDMODULE.                 " STATUS_0100  OUTPUT

***********************************************************************
** Module USER_COMMAND_0100 INPUT                                     *
***********************************************************************
MODULE user_command_0100 INPUT.
  CASE okcode.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
  ENDCASE.  " okcode
ENDMODULE.  " USER_COMMAND_0100 INPUT

***********************************************************************
** Module PREPARE_SCREEN OUTPUT                                       *
***********************************************************************
MODULE prepare_screen OUTPUT.

  IF obj_container IS INITIAL.
    PERFORM build_alv.
  ENDIF.    " obj_container INITIAL
ENDMODULE.                 " PREPARE_SCREEN  OUTPUT


***********************************************************************
* Form BUILD_ALV                                                      *
***********************************************************************
* No arguments                                                        *
***********************************************************************
* Builds the field catalog, sets display parameters and calls the     *
* method to display the results on screen.                            *
***********************************************************************
FORM build_alv.

  DATA:  lv_off TYPE int4.
* START MOVE here from MODULE 0100_prepare_screen OUTPUT. "MOD-004

  CALL METHOD cl_gui_alv_grid=>offline
    RECEIVING
      e_offline = lv_off.

  IF lv_off IS INITIAL.
    IF obj_container IS INITIAL .
*   Create the container
      CREATE OBJECT obj_container
        EXPORTING
            repid           =  sy-repid
            dynnr           =  sy-dynnr
            lifetime        =  cntl_lifetime_dynpro
*          ratio           =  90.
            extension       =  285
            side  = cl_gui_docking_container=>dock_at_bottom.
    ENDIF.
  ENDIF.

  IF obj_alv IS INITIAL.
*   Create the ALV control
    CREATE OBJECT obj_alv
      EXPORTING
        i_parent = obj_container.
  ENDIF.

  PERFORM build_field_catalog.

* Build layout, including default variant with subtotals
  gs_variant-report = sy-repid.
*  gs_layout-no_toolbar = lc_true.
  gs_layout-sel_mode   = 'B'.        " single row selectable
  gs_layout-cwidth_opt = lc_true.
  gs_layout-info_fname = 'LINECOLOR'.   " Color field name

  CALL METHOD obj_alv->set_table_for_first_display
    EXPORTING
      i_save          = 'A'
      is_variant      = gs_variant
      is_layout       = gs_layout
    CHANGING
      it_outtab       = it_result[]
      it_fieldcatalog = it_fieldcat[].

ENDFORM.                    "build_alv

***********************************************************************
* Form BUILD_FIELD_CATALOG                                            *
***********************************************************************
* Builds the field catalog for each field in it_result.               *
***********************************************************************
FORM build_field_catalog.

* if problem with ALV occurs
* best user this function
* but move structure with is create
* in package $TMP, also al the fields
* which are used in the structure
**  CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
**    EXPORTING
**      i_buffer_active  = ' '
**      i_structure_name = 'YSE_REN_FINUTIL'
**    CHANGING
**      ct_fieldcat      = it_fieldcat.




  CLEAR it_fieldcat.


* Field: Plant
  it_fieldcat-fieldname = 'WERK'.
  it_fieldcat-coltext = 'Plant'(001).
  it_fieldcat-tooltip = 'Issuing plant'(002).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: GAC
  it_fieldcat-fieldname = 'GAC'.
  it_fieldcat-coltext = 'GAC'(003).
  it_fieldcat-tooltip = 'GAC'(004).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: PGC
  it_fieldcat-fieldname = 'PGC'.
  it_fieldcat-coltext = 'PGC'(005).
  it_fieldcat-tooltip = 'PGC'(006).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

** Field: Revenue PGC
*  it_fieldcat-fieldname = 'RPGC'.
*  it_fieldcat-coltext = 'R.PGC'(009).
*  it_fieldcat-tooltip = 'Revenue PGC'(010).
*  it_fieldcat-fix_column = 'X'.
*  it_fieldcat-emphasize = 'X'.
*  APPEND it_fieldcat.

* Field: Model
  it_fieldcat-fieldname = 'MODEL'.
  it_fieldcat-coltext = 'Model'(011).
  it_fieldcat-tooltip = 'Model material number'(012).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Model description
  it_fieldcat-fieldname = 'MODESC'.
  it_fieldcat-coltext = 'Model desc'(013).
  it_fieldcat-tooltip = 'Model description'(014).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Material number
  it_fieldcat-fieldname = 'MATNR'.
  it_fieldcat-coltext = 'Material'(015).
  it_fieldcat-tooltip = 'Material number'(016).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Material description
  it_fieldcat-fieldname = 'MADESC'.
  it_fieldcat-coltext = 'Description'(017).
  it_fieldcat-tooltip = 'Description'(018).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Equipment number
  it_fieldcat-fieldname = 'EQUNR'.
  it_fieldcat-coltext = 'Equipment'(019).
  it_fieldcat-tooltip = 'Equipment number'(020).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Serial number
  it_fieldcat-fieldname = 'SERNR'.
  it_fieldcat-coltext = 'Serial nr'(021).
  it_fieldcat-tooltip = 'Serial number'(022).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Acquisition date
  it_fieldcat-fieldname = 'ZUGDT'.
  it_fieldcat-coltext = 'Acq. date'(023).
  it_fieldcat-tooltip = 'Acquisition date'(024).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Deactivation date
  it_fieldcat-fieldname = 'DEAKT'.
  it_fieldcat-coltext = 'Deact. date'(025).
  it_fieldcat-tooltip = 'Deactivation date'(026).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Period
  it_fieldcat-fieldname = 'PERIOD'.
  it_fieldcat-coltext = 'Period (days)'(027).
  it_fieldcat-tooltip = 'Period (days)'(028).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Absolute usage
  it_fieldcat-fieldname = 'ABSUSE'.
  it_fieldcat-coltext = 'Util (days)'(029).
  it_fieldcat-tooltip = 'Utilization (days)'(030).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation over period
  it_fieldcat-fieldname = 'PERUTI'.
  it_fieldcat-coltext = 'Utilization (%)'(031).
  it_fieldcat-tooltip = 'Utilization (percent)'(032).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Acquisition Value
  it_fieldcat-fieldname = 'ANSWL'.
  it_fieldcat-coltext = 'Acq Val'(033).
  it_fieldcat-tooltip = 'Acquisition Value'(034).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Acquisition Value with Period
  it_fieldcat-fieldname = 'ANSWL_P'.
  it_fieldcat-coltext = 'Adj Acq Val'(093).
  it_fieldcat-tooltip = 'Adjusted Acquisition Value'(094).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Acq val x Utilisation
  it_fieldcat-fieldname = 'ANUTI'.
  it_fieldcat-coltext = 'Adj Acq x Util'(035).
  it_fieldcat-tooltip = 'Adjusted Acquis value x Utilisation'(036).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: Month to Day
  it_fieldcat-fieldname = 'MTDUTI'.
  it_fieldcat-coltext = 'MtD Util(%)'(037).
  it_fieldcat-tooltip = 'Month to Day Utilization (percent)'(038).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: Year to Day
  it_fieldcat-fieldname = 'YTDUTI'.
  it_fieldcat-coltext = 'YtD Util(%)'(039).
  it_fieldcat-tooltip = 'Year to Day Utilization (percent)'(040).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: 1 month rolling
  it_fieldcat-fieldname = 'ROMUTI'.
  it_fieldcat-coltext = '1MR Util(%)'(041).
  it_fieldcat-tooltip = '1 Month Rolling Utilization (percent)'(042).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: 3 months rolling
  it_fieldcat-fieldname = 'ROMUTI3'.
  it_fieldcat-coltext = '3MR Util(%)'(081).
  it_fieldcat-tooltip = '3 Month Rolling Utilization (percent)'(082).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: 6 months rolling
  it_fieldcat-fieldname = 'ROMUTI6'.
  it_fieldcat-coltext = '6MR Util(%)'(083).
  it_fieldcat-tooltip = '6 Month Rolling Utilization (percent)'(084).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: 12 month rolling
  it_fieldcat-fieldname = 'ROLUTI'.
  it_fieldcat-coltext = '12MR Util(%)'(043).
  it_fieldcat-tooltip = '12 Month Rolling Utilization(percent)'(044).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial utilisation: Month Comparison
  it_fieldcat-fieldname = 'COMUTI'.
  it_fieldcat-coltext = 'MComp Util(%)'(071).
  it_fieldcat-tooltip = 'Month Comparison Utilization (percent)'(072).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Inoperation time
  it_fieldcat-fieldname = 'NONUSE'.
  it_fieldcat-coltext = 'Ineff(days)'(045).
  it_fieldcat-tooltip = 'Inefficiency (days)'(046).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Financial inefficiency
  it_fieldcat-fieldname = 'INEFFI'.
  it_fieldcat-coltext = 'Ineff(%)'(047).
  it_fieldcat-tooltip = 'Inefficiency (percent)'(048).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Acq val x Utilisation
  it_fieldcat-fieldname = 'INUTI'.
  it_fieldcat-coltext = 'Acq x Ineff'(049).
  it_fieldcat-tooltip = 'Acquisition value x Inefficiency'(050).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency due to Service Orders (absolute)
  it_fieldcat-fieldname = 'INSRAB'.
  it_fieldcat-coltext = 'Ser Ineff(days)'(051).
  it_fieldcat-tooltip = 'Inefficiency due to Service (days)'(052).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency due to Service Orders (percentile)
  it_fieldcat-fieldname = 'INSRPR'.
  it_fieldcat-coltext = 'Ser Ineff(%)'(053).
  it_fieldcat-tooltip = 'Inefficiency due to Service (percent)'(054).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency due to Transport (absolute)
  it_fieldcat-fieldname = 'INTRAB'.
  it_fieldcat-coltext = 'Tra Ineff(days)'(055).
  it_fieldcat-tooltip = 'Inefficiency due to Transport (days)'(056).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency due to Service Orders (percentile)
  it_fieldcat-fieldname = 'INTRPR'.
  it_fieldcat-coltext = 'Tra Ineff(%)'(057).
  it_fieldcat-tooltip = 'Inefficiency due to Transport (percent)'(058).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency: Month to Day
  it_fieldcat-fieldname = 'MTDINF'.
  it_fieldcat-coltext = 'MtD Ineff(%)'(063).
  it_fieldcat-tooltip = 'Month to Day Inefficiency (percent)'(064).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency: Year to Day
  it_fieldcat-fieldname = 'YTDINF'.
  it_fieldcat-coltext = 'YtD Ineff(%)'(065).
  it_fieldcat-tooltip = 'Year to Day Inefficiency (percent)'(066).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency: 1 month rolling
  it_fieldcat-fieldname = 'ROMINF'.
  it_fieldcat-coltext = '1MR Ineff(%)'(067).
  it_fieldcat-tooltip = '1 Month Rolling Inefficiency (percent)'(068).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency: 3 month rolling
  it_fieldcat-fieldname = 'ROMINF3'.
  it_fieldcat-coltext = '3MR Ineff(%)'(085).
  it_fieldcat-tooltip = '3 Month Rolling Inefficiency (percent)'(086).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency: 6 month rolling
  it_fieldcat-fieldname = 'ROMINF6'.
  it_fieldcat-coltext = '6MR Ineff(%)'(087).
  it_fieldcat-tooltip = '6 Month Rolling Inefficiency (percent)'(088).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency: 12 month rolling
  it_fieldcat-fieldname = 'ROLINF'.
  it_fieldcat-coltext = '12MR Ineff(%)'(069).
  it_fieldcat-tooltip = '12 Month Rolling Inefficiency (percent)'(070).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency due to availibility in Yard (absolute)
  it_fieldcat-fieldname = 'INAVAB'.
  it_fieldcat-coltext = 'Avail(days)'(059).
  it_fieldcat-tooltip = 'Availibility (days)'(060).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Physical Inefficiency due to Availibility in Yard (percent)
  it_fieldcat-fieldname = 'INAVPR'.
  it_fieldcat-coltext = 'Avail (%)'(061).
  it_fieldcat-tooltip = 'Availibility (percent)'(062).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Availibility: Month to Day
  it_fieldcat-fieldname = 'MTDAVL'.
  it_fieldcat-coltext = 'MtD Avail(%)'(073).
  it_fieldcat-tooltip = 'Month to Day Availibility (percent)'(074).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Availibility: Year to Day
  it_fieldcat-fieldname = 'YTDAVL'.
  it_fieldcat-coltext = 'YtD Avail(%)'(075).
  it_fieldcat-tooltip = 'Year to Day Availibility (percent)'(076).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Availibility: 1 month rolling
  it_fieldcat-fieldname = 'ROMAVL'.
  it_fieldcat-coltext = '1MR Avail(%)'(077).
  it_fieldcat-tooltip = '1 Month Rolling Availibility (percent)'(078).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Availibility: 3 month rolling
  it_fieldcat-fieldname = 'ROMAVL3'.
  it_fieldcat-coltext = '3MR Avail(%)'(089).
  it_fieldcat-tooltip = '3 Month Rolling Availibility (percent)'(090).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Availibility: 6 month rolling
  it_fieldcat-fieldname = 'ROMAVL6'.
  it_fieldcat-coltext = '6MR Avail(%)'(091).
  it_fieldcat-tooltip = '6 Month Rolling Availibility (percent)'(092).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Availibility: 12 month rolling
  it_fieldcat-fieldname = 'ROLAVL'.
  it_fieldcat-coltext = '12MR Avail(%)'(079).
  it_fieldcat-tooltip = '12 Month Rolling Availibility (percent)'(080).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Revenue GAC
  it_fieldcat-fieldname = 'WW006'.
  it_fieldcat-coltext = 'REVENUE GAC'(095).
  it_fieldcat-tooltip = 'REVENUE GAC'(096).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Field: Revenue PGC
  it_fieldcat-fieldname = 'WW007'.
  it_fieldcat-coltext = 'REVENUE PGC'(097).
  it_fieldcat-tooltip = 'REVENUE PGC'(098).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.


ENDFORM.    " build_field_catalog
*&---------------------------------------------------------------------*
*&      Form  Check_Authorization
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_authorization .

  DATA: t_t001w LIKE STANDARD TABLE OF t001w WITH HEADER LINE.

  SELECT *
  FROM t001w
  INTO TABLE t_t001w WHERE werks IN so_werk.


  LOOP AT t_t001w.

    AUTHORITY-CHECK OBJECT 'I_SWERK'
             ID 'TCD' DUMMY
             ID 'SWERK' FIELD t_t001w-werks.

    IF sy-subrc = 4.
*   No authorisation to display data from Sales Organisation p_vkorg
      MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '008' WITH t_t001w-werks.
      EXIT.
    ELSEIF sy-subrc <> 0.
*   Error checking authorization.
      MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " Check_Authorization
*&---------------------------------------------------------------------*
*&      Form  fill_missing_plant
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_IT_EQUI_TEMP  text
*----------------------------------------------------------------------*
FORM fill_missing_plant  TABLES   l_i_equi_tmp STRUCTURE it_equ_b.

  DATA:
       l_matnr  LIKE riserx1-matnr,
       l_sernr  LIKE riserx1-sernr,
       l_equi_nr LIKE riserx1-equnr.

  DATA: BEGIN OF da_sertab OCCURS 1.
          INCLUDE STRUCTURE riserx1.
  DATA: END OF da_sertab.

  DATA: BEGIN OF intobjk OCCURS 30.
          INCLUDE STRUCTURE objk.
  DATA: END  OF intobjk.
  DATA: BEGIN OF it_ser03 OCCURS 999.
          INCLUDE STRUCTURE ser03.
  DATA: END OF it_ser03.

  LOOP AT l_i_equi_tmp WHERE werk IS INITIAL.
    CALL FUNCTION 'SERIAL_NOT_UNIQUE'
      EXPORTING
        material  = l_i_equi_tmp-matnr
        serial    = l_i_equi_tmp-sernr
      IMPORTING
        serial    = l_sernr
        equipment = l_equi_nr
      EXCEPTIONS
        not_found = 01.

    CHECK sy-subrc = 0.
    CHECK NOT l_equi_nr IS INITIAL.

* Es werden alle Objektlisten zur Serialnummer selektiert.
    CLEAR intobjk[].
    SELECT *
    FROM objk
    INTO TABLE intobjk
    WHERE equnr = l_equi_nr
    AND taser EQ 'SER03'.
    IF sy-subrc EQ 0.
      SELECT *
      INTO TABLE it_ser03
      FROM ser03
      FOR ALL ENTRIES IN intobjk
      WHERE obknr = intobjk-obknr
      AND ( bwart EQ '601' OR bwart EQ '551' ).
      IF sy-subrc EQ 0.
        LOOP AT it_ser03.
          MOVE it_ser03-werk TO l_i_equi_tmp-werk.
          MODIFY l_i_equi_tmp.
          EXIT.
        ENDLOOP.
      ENDIF.
    ENDIF.

  ENDLOOP.



ENDFORM.                    " fill_missing_plant
*&---------------------------------------------------------------------*
*&      Form  delete_deactivated_equipments
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM delete_deactivated_equipments .

  LOOP AT it_eq.
*  read table it_invest
    READ TABLE it_invest WITH KEY equnr = it_eq-equnr.
    IF sy-subrc = 0.
      IF ( it_invest-deakt LT p_angdt AND NOT it_invest-deakt IS INITIAL )
           OR it_invest-zugdt GT p_bnddt  .
        DELETE it_eq.
      ENDIF.
    ENDIF.
  ENDLOOP.


ENDFORM.                    " delete_deactivated_equipments

*Text symbol text
*001:Plant
*002:Issuing plant
*003:GAC
*004:GAC
*005:PGC
*006:PGC
*011:Model
*012:Model material number
*013:Model desc
*014:Model description
*015:Material
*016:Material number
*017:Description
*018:Description
*019:Equipment
*020:Equipment number
*021:Serial nr
*022:Serial number
*023:Acq. date
*024:Acquisition date
*025:Deact. date
*026:Deactivation date
*027:Period (days)
*028:Period (days)
*029:Util (days)
*030:Utilization (days)
*031:Utilization (%)
*032:Utilization (percent)
*033:Acq Val
*034:Acquisition Value
*035:Adj Acq x Util
*036:Adjusted Acquis value x Utilisation
*037:MtD Util(%)
*038:Month to Day Utilization (percent)
*039:YtD Util(%)
*040:Year to Day Utilization (percent)
*041:1MR Util(%)
*042:1 Month Rolling Utilization (percent)
*043:12MR Util(%)
*044:12 Month Rolling Utilization(percent)
*045:Ineff(days)
*046:Inefficiency (days)
*047:Ineff(%)
*048:Inefficiency (percent)
*049:Acq x Ineff
*050:Acquisition value x Inefficiency
*051:Ser Ineff(days)
*052:Inefficiency due to Service (days)
*053:Ser Ineff(%)
*054:Inefficiency due to Service (percent)
*055:Tra Ineff(days)
*056:Inefficiency due to Transport (days)
*057:Tra Ineff(%)
*058:Inefficiency due to Transport (percent)
*059:Avail(days)
*060:Availibility (days)
*061:Avail (%)
*062:Availibility (percent)
*063:MtD Ineff(%)
*064:Month to Day Inefficiency (percent)
*065:YtD Ineff(%)
*066:Year to Day Inefficiency (percent)
*067:1MR Ineff(%)
*068:1 Month Rolling Inefficiency (percent)
*069:12MR Ineff(%)
*070:12 Month Rolling Inefficiency (percent)
*071:MComp Util(%)
*072:Month Comparison Utilization (percent)
*073:MtD Avail(%)
*074:Month to Day Availibility (percent)
*075:YtD Avail(%)
*076:Year to Day Availibility (percent)
*077:1MR Avail(%)
*078:1 Month Rolling Availibility (percent)
*079:12MR Avail(%)
*080:12 Month Rolling Availibility (percent)
*081:3MR Util(%)
*082:3 Month Rolling Utilization (percent)
*083:6MR Util(%)
*084:6 Month Rolling Utilization (percent)
*085:3MR Ineff(%)
*086:3 Month Rolling Inefficiency (percent)
*087:6MR Ineff(%)
*088:6 Month Rolling Inefficiency (percent)
*089:3MR Avail(%)
*090:3 Month Rolling Availibility (percent)
*091:6MR Avail(%)
*092:6 Month Rolling Availibility (percent)
*093:Adj Acq Val
*094:Adjusted Acquisition Value
*095:REVENUE GAC
*096:REVENUE GAC
*097:REVENUE PGC
*098:REVENUE PGC

*S01:Parameters
*Selection text
*P_ANGDT:        Start date
*P_BNDDT:        End date
*P_BUKRS:        Company code
*SO_EQUNR:        Equipment
*SO_GAC:        GAC
*SO_MATNR:        Material number
*SO_MODEL:        Model
*SO_PGC:        PGC
*SO_RGAC:        Revenue GAC
*SO_RPGC:        Revenue PGC
*SO_SERNR:        Serial number
*SO_VKORG:        Sales organisation
*SO_VTWEG:        Distribution channel
*SO_WERK:        Plant
