*&---------------------------------------------------------------------*
*& Report  YSE_UPLOAD_ASSET_UPD
*&
*&---------------------------------------------------------------------*
*&                                                                     *
*& Upload program to update Assets from text-file (Tab delimited)      *
*&                                                                     *
*&---------------------------------------------------------------------*
*  Author                : Jules Smets
*  Date                  : 13.10.2011
*  Change Request Number : CR2266
*  Transport request Nr. : CD1K968360
*----------------------------------------------------------------------*
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD.NR. | DATE       | NAME           | CORRECTION NR. | CHANGE REF. *
*----------------------------------------------------------------------*
* MOD-001 | 13.09.2012 | Raghav D.V.S   | CD1K973260     | CR2350      *
*         |Insert PERNR field from File | CD1K973272     |             *
*----------------------------------------------------------------------*

************************************************************************

REPORT  yse_upload_asset_upd  MESSAGE-ID yse_sales_log.

*******************
* Data definition *
*******************

TYPE-POOLS: abap.

TABLES : usr01, anla, csks, lfa1.

DATA: BEGIN OF gt_list OCCURS 0,
        anln1      TYPE anln1,
        anln2      TYPE anln2,
        txt50      TYPE txt50,
        result     TYPE text20,
      END OF gt_list.

DATA: BEGIN OF it_data  OCCURS 0,
        anln1        LIKE anla-anln1,
        anln2        LIKE anla-anln2,
        txt50        LIKE anla-txt50,
        txa50        LIKE anla-txa50,
        anlhtxt      LIKE anlh-anlhtxt,
        sernr        LIKE anla-sernr,
        invnr        LIKE anla-invnr,
        menge(18)    TYPE c,
        meins        LIKE anla-meins,
        aneqk        LIKE anla-aneqk,
        ivdat        LIKE anla-ivdat,
        invzu        LIKE anla-invzu,
        inken        LIKE anla-inken,
        aktiv        LIKE anla-aktiv,
        deakt        LIKE anla-deakt,
        gsber        LIKE anlz-gsber,
        kostl        LIKE anlz-kostl,
        adatu        LIKE anlz-adatu,
        werks        LIKE anlz-werks,
        stort        LIKE anlz-stort,
        raumn        LIKE anlz-raumn,
        ord41        LIKE anla-ord41,
        ord42        LIKE anla-ord42,
        ord43        LIKE anla-ord43,
        ord44        LIKE anla-ord44,
        gdlgrp       LIKE anla-gdlgrp,
        anlue        LIKE anla-anlue,
        lifnr        LIKE anla-lifnr,
        liefe        LIKE anla-liefe,
        herst        LIKE anla-herst,
        xafabch      LIKE anla-xafabch,
        vbund        LIKE anla-vbund,
        land1        LIKE anla-land1,
        typbz        LIKE anla-typbz,
        aibn1        LIKE anla-aibn1,
        aibn2        LIKE anla-aibn2,
        urjhr        LIKE anla-urjhr,
        urwrt(16)    TYPE c,
        antei(6)     TYPE c,
        vmgli        LIKE anla-vmgli,
        eigkz        LIKE anla-eigkz,
        grund        LIKE anla-grund,
        wrtma(16)    TYPE c,
        xvrmw        LIKE anla-xvrmw,
        leafi        LIKE anla-leafi,
        lvtnr        LIKE anla-lvtnr,
        lvdat        LIKE anla-lvdat,
        lkdat        LIKE anla-lkdat,
        leabg        LIKE anla-leabg,
        lejar        LIKE anla-lejar,
        leper        LIKE anla-leper,
        leart        LIKE anla-leart,
        lbasw(16)    TYPE c,
        lkauf(16)    TYPE c,
        letxt        LIKE anla-letxt,
        leanz        LIKE anla-leanz,
        lryth        LIKE anla-lryth,
        lvors        LIKE anla-lvors,
        legeb(16)    TYPE c,
        lzins(8)     TYPE c,
        ndjar1       LIKE anlb-ndjar,
        ndper1       LIKE anlb-ndper,
        afabg1       LIKE anlb-afabg,
        wbind1       LIKE anlb-wbind,
        ndjar2       LIKE anlb-ndjar,
        ndper2       LIKE anlb-ndper,
        afabg2       LIKE anlb-afabg,
        wbind2       LIKE anlb-wbind,
        ndjar3       LIKE anlb-ndjar,
        ndper3       LIKE anlb-ndper,
        afabg3       LIKE anlb-afabg,
        wbind3       LIKE anlb-wbind,
        gplab_a      LIKE anla-gplab,
        bstdt_a      LIKE anla-bstdt,
        kfzkz_a      LIKE anlz-kfzkz,
        caufn_a      LIKE anlz-caufn,
        msfak_a(4)   TYPE c,
        xstil_a      LIKE anlz-xstil,
        kostlv_a     LIKE anlz-kostlv,
        pernr        LIKE anlz-pernr,              " Mod-001
        iaufn_a      LIKE anlz-iaufn,
        fkber_a      LIKE anlz-fkber,
        izwek_a      LIKE anla-izwek,
        umwkz_a      LIKE anla-umwkz,
        ehwnr_a      LIKE anla-ehwnr,
        imkey_a      LIKE anlz-imkey,
        feins_a      LIKE anla-feins,
        vsart_a      LIKE anlv-vsart,
        vsind_a      LIKE anlv-vsind,
        vrsba_a      LIKE anlv-vrsba,
        vrsma_a      LIKE anlv-vrsma,
        vsman_a      LIKE anlv-vsman,
        vsges_a      LIKE anlv-vsges,
        vsstx_a      LIKE anlv-vsstx,
        vsztx_a      LIKE anlv-vsztx,
        xvrsid_a     LIKE anlv-xvrsid,
        vstar_a      LIKE anlv-vstar,
        vsbaj_a      LIKE anlv-vsbaj,
        eaufn_a      LIKE anla-eaufn,
        invsl_a      LIKE anlb-invsl,
        xanlgr_a     LIKE anla-xanlgr,
      END OF it_data.

TYPES: BEGIN OF ty_anlz,
         anln1       LIKE anlz-anln1,
         anln2       LIKE anlz-anln2,
         kostl       LIKE anlz-kostl,
       END OF ty_anlz.

DATA: it_anlz  TYPE HASHED TABLE OF ty_anlz
                    WITH UNIQUE KEY anln1 anln2
                    WITH HEADER LINE,
      it_kostl TYPE TABLE OF ty_anlz
                    WITH HEADER LINE.

DATA: BEGIN OF gt_messtab  OCCURS 0.
        INCLUDE STRUCTURE bdcmsgcoll.
DATA: END   OF gt_messtab.

DATA: struct_bdcdata  TYPE bdcdata.
DATA: i_bdcdata  TYPE STANDARD TABLE OF bdcdata.
*DATA: l_date TYPE d.

DATA: gv_txt50          TYPE txt50,
      gv_text           TYPE natxt,
      gv_mstring(100)   TYPE c,
      gv_mode(1)        TYPE c,
      gv_filename       TYPE string,
      gv_error          TYPE xfeld.

CONSTANTS: c_type_a        TYPE bapiret2-type   VALUE 'A',
           c_type_e        TYPE bapiret2-type   VALUE 'E',
           c_en            TYPE spras           VALUE 'E',
           c_99991231(8)   TYPE c               VALUE '99991231',
           c_1000(4)       TYPE c               VALUE '1000'.


********************
* Selection screen *
********************

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-009.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) text-018.
SELECTION-SCREEN POSITION 35.
PARAMETERS p_bukrs TYPE bukrs OBLIGATORY
                              MEMORY ID buk.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) text-001.
SELECTION-SCREEN POSITION 35.
PARAMETERS p_fname LIKE cffile-filename OBLIGATORY MEMORY ID gxd.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(30) text-016 MODIF ID sc1.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: p_comma  LIKE kcd_doku_struc-decimal_sep
            RADIOBUTTON GROUP dec  DEFAULT 'X' MODIF ID sc1.
SELECTION-SCREEN COMMENT 4(20) text-003 MODIF ID sc1.
PARAMETERS: p_point  LIKE kcd_doku_struc-decimal_sep
            RADIOBUTTON GROUP dec MODIF ID sc1.
SELECTION-SCREEN COMMENT 27(20) text-004 MODIF ID sc1.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(30) text-017 MODIF ID sc1.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: p_dmj  RADIOBUTTON GROUP dat DEFAULT 'X' MODIF ID sc1.
SELECTION-SCREEN COMMENT 4(20) text-005 MODIF ID sc1.
PARAMETERS: p_jmd  RADIOBUTTON GROUP dat MODIF ID sc1.
SELECTION-SCREEN COMMENT 27(20) text-006 MODIF ID sc1.
SELECTION-SCREEN END OF LINE.

PARAMETERS : p_view TYPE c AS CHECKBOX.

SELECTION-SCREEN END OF BLOCK b1.

*----------------------------------------------------------------------*
* On the selection screen                                              *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_fname.

  CALL FUNCTION 'WS_FILENAME_GET'
    EXPORTING
      def_filename     = p_fname
      def_path         = '\'
      mask             = ',*.*,*.csv;*.txt.'
      mode             = 'O'
      title            = text-024
    IMPORTING
      filename         = p_fname
    EXCEPTIONS
      inv_winsys       = 01
      no_batch         = 02
      selection_cancel = 03
      selection_error  = 04.

*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON p_bukrs.

  AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
           ID 'ACTVT' DUMMY
           ID 'BUKRS' FIELD p_bukrs.

  IF sy-subrc = 4.
*   No authorisation to display data
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '008' WITH p_bukrs.
    EXIT.
  ELSEIF sy-subrc <> 0.
*   Error checking authorization.
    MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
    EXIT.
  ENDIF.


*&---------------------------------------------------------------------*
*&  Main program                                                       *
*&---------------------------------------------------------------------*

START-OF-SELECTION.

* Read file
  PERFORM read_file.

* Check anything selected
  IF it_data[] IS INITIAL.
    MESSAGE ID 'YSE_GENERAL' TYPE 'S' NUMBER '000'
            WITH 'NO INPUT'(e01).
    EXIT.
  ENDIF.

* Convert data
  PERFORM convert_data.

* Get Cost centers (if required)
  PERFORM get_costcenter.

* Process data
  PERFORM process_data.


*----------------------------------------------------------------------*
*       FORMS
*----------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*&      Form  READ_FILE
*&---------------------------------------------------------------------*
*       Read input file (in internal table)
*----------------------------------------------------------------------*
FORM read_file.

  gv_filename = p_fname.

  CALL FUNCTION 'GUI_UPLOAD'
    EXPORTING
      filename                = gv_filename
      filetype                = 'ASC'
      has_field_separator     = 'X'
    TABLES
      data_tab                = it_data
    EXCEPTIONS
      file_open_error         = 1
      file_read_error         = 2
      no_batch                = 3
      gui_refuse_filetransfer = 4
      invalid_type            = 5
      no_authority            = 6
      unknown_error           = 7
      bad_data_format         = 8
      header_not_allowed      = 9
      separator_not_allowed   = 10
      header_too_long         = 11
      unknown_dp_error        = 12
      access_denied           = 13
      dp_out_of_memory        = 14
      disk_full               = 15
      dp_timeout              = 16
      OTHERS                  = 17.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* Delete lines without asset nrs
  DELETE it_data WHERE anln1 CO ' 0'.

ENDFORM.                    " READ_FILE

*&---------------------------------------------------------------------*
*&      Form  CONVERT_DATA
*&---------------------------------------------------------------------*
FORM convert_data .

* Convert asset number
  PERFORM convert_assetnr.

* Convert decimal point / comma (if required)
  SELECT SINGLE * FROM usr01
         WHERE bname = sy-uname.

  IF p_point = 'X' AND usr01-dcpfm <> 'X'.
    PERFORM convert_into_comma.
  ELSEIF p_comma = 'X' AND usr01-dcpfm = 'X'.
    PERFORM convert_into_point.
  ENDIF.

* Convert dates (if required)
  PERFORM convert_dates.

ENDFORM.                    " CONVERT_DATA

*&---------------------------------------------------------------------*
*&      Form  CONVERT_ASSETNR
*&---------------------------------------------------------------------*
FORM convert_assetnr .

  LOOP AT it_data.

*   Asset number
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = it_data-anln1
      IMPORTING
        output = it_data-anln1.

*   Subnumber
    IF it_data-anln2 = '    '.
      it_data-anln2 = '0000'.
    ENDIF.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = it_data-anln2
      IMPORTING
        output = it_data-anln2.

    MODIFY it_data.

  ENDLOOP.

ENDFORM.                    " CONVERT_ASSETNR

*&---------------------------------------------------------------------*
*&      Form  CONVERT_INTO_COMMA
*&---------------------------------------------------------------------*
FORM convert_into_comma.

  LOOP AT it_data.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-menge WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-menge WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-menge WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-urwrt WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-urwrt WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-urwrt WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-antei WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-antei WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-antei WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-wrtma WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-wrtma WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-wrtma WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-legeb WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-legeb WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-legeb WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-lbasw WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-lbasw WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-lbasw WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-lkauf WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-lkauf WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-lkauf WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-lzins WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-lzins WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-lzins WITH ','.

    REPLACE ALL OCCURRENCES OF '.' IN it_data-msfak_a WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-msfak_a WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-msfak_a WITH ','.

    MODIFY it_data INDEX sy-tabix.
  ENDLOOP.

ENDFORM.                    " CONVERT_INTO_COMMA

*&---------------------------------------------------------------------*
*&      FORM  CONVERT_INTO_POINT
*&---------------------------------------------------------------------*
FORM convert_into_point.

  LOOP AT it_data.
    REPLACE ALL OCCURRENCES OF ',' IN it_data-menge WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-menge WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-menge WITH '.'.

    REPLACE ALL OCCURRENCES OF ',' IN it_data-urwrt WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-urwrt WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-urwrt WITH '.'.

    REPLACE ALL OCCURRENCES OF ',' IN it_data-antei WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-antei WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-antei WITH '.'.

    REPLACE ALL OCCURRENCES OF ',' IN it_data-wrtma WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-wrtma WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-wrtma WITH '.'.


    REPLACE ALL OCCURRENCES OF ',' IN it_data-lbasw WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-lbasw WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-lbasw WITH '.'.


    REPLACE ALL OCCURRENCES OF ',' IN it_data-legeb WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-legeb WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-legeb WITH '.'.

    REPLACE ALL OCCURRENCES OF ',' IN it_data-lzins WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-lzins WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-lzins WITH '.'.

    REPLACE ALL OCCURRENCES OF ',' IN it_data-lkauf WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-lkauf WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-lkauf WITH '.'.


    REPLACE ALL OCCURRENCES OF ',' IN it_data-msfak_a WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN it_data-msfak_a WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN it_data-msfak_a WITH '.'.

    MODIFY it_data INDEX sy-tabix.
  ENDLOOP.

ENDFORM.                    " CONVERT_INTO_POINT

*&---------------------------------------------------------------------*
*&      Form  CONVERT_DATES
*&---------------------------------------------------------------------*
FORM convert_dates.

  DATA : lv_date(10) TYPE c.

  IF p_dmj = 'X'.
    LOOP AT it_data.

      lv_date = it_data-aktiv.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-aktiv.
      it_data-aktiv+0(4) = lv_date+4(4).
      it_data-aktiv+4(2) = lv_date+2(2).
      it_data-aktiv+6(2) = lv_date+0(2).

      lv_date = it_data-deakt.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-deakt.
      it_data-deakt+0(4) = lv_date+4(4).
      it_data-deakt+4(2) = lv_date+2(2).
      it_data-deakt+6(2) = lv_date+0(2).

      lv_date = it_data-adatu.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-adatu.
      it_data-adatu+0(4) = lv_date+4(4).
      it_data-adatu+4(2) = lv_date+2(2).
      it_data-adatu+6(2) = lv_date+0(2).

      lv_date = it_data-ivdat.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-ivdat.
      it_data-ivdat+0(4) = lv_date+4(4).
      it_data-ivdat+4(2) = lv_date+2(2).
      it_data-ivdat+6(2) = lv_date+0(2).

      lv_date = it_data-lvdat.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-lvdat.
      it_data-lvdat+0(4) = lv_date+4(4).
      it_data-lvdat+4(2) = lv_date+2(2).
      it_data-lvdat+6(2) = lv_date+0(2).

      lv_date = it_data-lkdat.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-lkdat.
      it_data-lkdat+0(4) = lv_date+4(4).
      it_data-lkdat+4(2) = lv_date+2(2).
      it_data-lkdat+6(2) = lv_date+0(2).

      lv_date = it_data-leabg.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-leabg.
      it_data-leabg+0(4) = lv_date+4(4).
      it_data-leabg+4(2) = lv_date+2(2).
      it_data-leabg+6(2) = lv_date+0(2).

      lv_date = it_data-gplab_a.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-gplab_a.
      it_data-gplab_a+0(4) = lv_date+4(4).
      it_data-gplab_a+4(2) = lv_date+2(2).
      it_data-gplab_a+6(2) = lv_date+0(2).

      lv_date = it_data-bstdt_a.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-bstdt_a.
      it_data-bstdt_a+0(4) = lv_date+4(4).
      it_data-bstdt_a+4(2) = lv_date+2(2).
      it_data-bstdt_a+6(2) = lv_date+0(2).

      lv_date = it_data-afabg1.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-afabg1.
      it_data-afabg1+0(4) = lv_date+4(4).
      it_data-afabg1+4(2) = lv_date+2(2).
      it_data-afabg1+6(2) = lv_date+0(2).

      lv_date = it_data-afabg2.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-afabg2.
      it_data-afabg2+0(4) = lv_date+4(4).
      it_data-afabg2+4(2) = lv_date+2(2).
      it_data-afabg2+6(2) = lv_date+0(2).

      lv_date = it_data-afabg3.
      REPLACE ALL OCCURRENCES OF '.' IN lv_date WITH ''.
      CLEAR it_data-afabg3.
      it_data-afabg3+0(4) = lv_date+4(4).
      it_data-afabg3+4(2) = lv_date+2(2).
      it_data-afabg3+6(2) = lv_date+0(2).

      MODIFY it_data TRANSPORTING aktiv
                                 deakt
                                 adatu
                                 ivdat
                                 lvdat
                                 lkdat
                                 leabg
                                 gplab_a
                                 bstdt_a
                                 afabg1
                                 afabg2
                                 afabg3.
    ENDLOOP.

  ELSE.
    LOOP AT it_data.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-aktiv WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-deakt WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-adatu WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-ivdat WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-lvdat WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-lkdat WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-leabg WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-gplab_a WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-bstdt_a WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-afabg1 WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-afabg2 WITH ''.
      REPLACE ALL OCCURRENCES OF '.' IN it_data-afabg3 WITH ''.
      MODIFY it_data TRANSPORTING aktiv
                                 deakt
                                 adatu
                                 ivdat
                                 lvdat
                                 lkdat
                                 leabg
                                 gplab_a
                                 bstdt_a
                                 afabg1
                                 afabg2
                                 afabg3.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " CONVERT_DATES

*&---------------------------------------------------------------------*
*&      Form  GET_COSTCENTER
*&---------------------------------------------------------------------*
FORM get_costcenter .

  LOOP AT it_data WHERE NOT kostl IS INITIAL.
    it_kostl-anln1 = it_data-anln1.
    it_kostl-anln2 = it_data-anln2.
    it_kostl-kostl = it_data-kostl.
    APPEND it_kostl.
  ENDLOOP.
  SORT it_kostl.
  DELETE ADJACENT DUPLICATES FROM it_kostl.

  CHECK NOT it_kostl[] IS INITIAL.

  SELECT anln1 anln2 kostl INTO TABLE it_anlz
         FROM anlz
         FOR ALL ENTRIES IN it_kostl
         WHERE bukrs = p_bukrs
           AND anln1 = it_kostl-anln1
           AND anln2 = it_kostl-anln2
           AND bdatu = c_99991231.

ENDFORM.                    " GET_COSTCENTER

*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
*       Process data
*----------------------------------------------------------------------*
FORM process_data .

  DATA: lv_datum1(10) TYPE c, lv_datum2(10) TYPE c,
        lv_datum3(10) TYPE c, lv_aktiv(10) TYPE c,
        lv_deakt(10) TYPE c,  lv_ivdat(10) TYPE c,
        lv_lkdat(10) TYPE c,  lv_lvdat(10) TYPE c,
        lv_leabg(10) TYPE c,  lv_gplab(10) TYPE c,
        lv_bstdt(10) TYPE c,  lv_adatu(10) TYPE c,
        lv_pernr(10) TYPE c.                               " Mod-001

* Process mode
  IF p_view = 'X'.
    gv_mode = 'A'.
  ELSE.
    gv_mode = 'N'.
  ENDIF.

  CLEAR:   gt_messtab[], i_bdcdata[].

  LOOP AT it_data.

*   Check record
    CLEAR gv_error.
    PERFORM check_record.
*   No error
    CHECK gv_error IS INITIAL.

*   Initial screen
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    'SAPLAIST'  '0100'  'X'  ''  ''
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'ANLA-ANLN1'  it_data-anln1
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'ANLA-ANLN2'  it_data-anln2
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'ANLA-BUKRS'  p_bukrs
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BDC_OKCODE'  '/00'
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

*   Next screen: Tab1
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    'SAPLAIST'  '1000'  'X'  ''  ''
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BDC_OKCODE'  '=TAB02'
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT it_data-txt50 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-TXT50'  it_data-txt50
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-txa50 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-TXA50'  it_data-txa50
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-anlhtxt IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLH-ANLHTXT'  it_data-anlhtxt
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-sernr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-SERNR'  it_data-sernr
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-invnr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-INVNR'  it_data-invnr
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-menge IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-MENGE'  it_data-menge
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-meins IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-MEINS'  it_data-meins
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-aneqk IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ANEQK'  it_data-aneqk
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-ivdat TO lv_ivdat.
    IF NOT it_data-ivdat IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-IVDAT'  lv_ivdat
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-invzu IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-INVZU'  it_data-invzu
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-inken IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-INKEN'  it_data-inken
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-aktiv TO lv_aktiv.
    IF NOT it_data-aktiv IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-AKTIV'  lv_aktiv
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-deakt TO lv_deakt.
    IF NOT it_data-deakt IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-DEAKT'  lv_deakt
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

*   Tab2
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BDC_OKCODE'  '=TAB03'
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT it_data-kostl IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLZ-KOSTL'  it_data-kostl
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.
**    begin of insert MOD-001
    WRITE it_data-pernr TO lv_pernr.
    IF NOT it_data-pernr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLZ-PERNR'  lv_pernr
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.
**    End of Insert Mod-002
    IF NOT it_data-gsber IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLZ-GSBER'  it_data-gsber
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-werks IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLZ-WERKS'  it_data-werks
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-stort IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLZ-STORT'  it_data-stort
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-raumn IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLZ-RAUMN'  it_data-raumn
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-kostl IS INITIAL.
      CLEAR it_anlz.
      READ TABLE it_anlz WITH TABLE KEY anln1 = it_data-anln1
                                        anln2 = it_data-anln2.
      IF it_data-kostl NE it_anlz-kostl.
*       Popup time interval
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLAIST'  '3020'  'X'  ''  ''
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
        IF it_data-adatu IS INITIAL.
*         Button 'Yes'
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=YES'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSE.
*         Button 'New time interval'
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=INEW'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
*         Enter date for new interval
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLAIST'  '3010'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
          WRITE it_data-adatu TO lv_adatu.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'ANLZ-ADATU'  lv_adatu
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
*         Select new interval
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLAIST'  '3000'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=SELZ'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'GD_MARK(01)'  'X'
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
*         Go to tab3
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLAIST'  '1000'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_OKCODE'  '=TAB03'
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
      ENDIF.
    ENDIF.

*   Tab3
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=TAB04'
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.


    IF NOT it_data-ord41 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ORD41'  it_data-ord41
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ord42 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ORD42'  it_data-ord42
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ord43 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ORD43'  it_data-ord43
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ord44 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ORD44'  it_data-ord44
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-gdlgrp IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-GDLGRP'  it_data-gdlgrp
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-anlue IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ANLUE'  it_data-anlue
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

*   Tab5
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
    USING    ''  ''  ''  'BDC_OKCODE'  '=TAB05'
    CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT it_data-lifnr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LIFNR'  it_data-lifnr
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-liefe IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LIEFE'  it_data-liefe
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-herst IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-HERST'  it_data-herst
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-xafabch IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-XAFABCH'  it_data-xafabch
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-vbund IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-VBUND'  it_data-vbund
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-typbz IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-TYPBZ'  it_data-typbz
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-aibn1 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-AIBN1'  it_data-aibn1
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-aibn2 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-AIBN2'  it_data-aibn2
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-urjhr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-URJHR'  it_data-urjhr
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-urwrt IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-URWRT'  it_data-urwrt
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-antei IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-ANTEI'  it_data-antei
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

*   Tab5
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
   USING    ''  ''  ''  'BDC_OKCODE'  '=TAB07'
   CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT it_data-vmgli IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-VMGLI'  it_data-vmgli
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-eigkz IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-EIGKZ'  it_data-eigkz
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-grund IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-GRUND'  it_data-grund
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-wrtma IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-WRTMA'  it_data-wrtma
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-xvrmw IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-XVRMW'  it_data-xvrmw
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

*   Tab7
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
   USING    ''  ''  ''  'BDC_OKCODE'  '=TAB08'
   CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT it_data-leafi IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEAFI'  it_data-leafi
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lvtnr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LVTNR'  it_data-lvtnr
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-lvdat TO lv_lvdat.
    IF NOT it_data-lvdat IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LVDAT'  lv_lvdat
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-lkdat TO lv_lkdat.
    IF NOT it_data-lkdat IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LKDAT'  lv_lkdat
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-leabg TO lv_leabg.
    IF NOT it_data-leabg IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEABG'  lv_leabg
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lejar IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEJAR'  it_data-lejar
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.


    IF NOT it_data-leper IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEPER'  it_data-leper
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-leart IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEART'  it_data-leart
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lbasw IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LBASW'  it_data-lbasw
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lkauf IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LKAUF'  it_data-lkauf
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-letxt IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LETXT'  it_data-letxt
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-leanz IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEANZ'  it_data-leanz
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lryth IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LRYTH'  it_data-lryth
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lvors IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LVORS'  it_data-lvors
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-legeb IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LEGEB'  it_data-legeb
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-lzins IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLA-LZINS'  it_data-lzins
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

*   Tab8
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
   USING    ''  ''  ''  'BDC_OKCODE'  '/00'
   CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT it_data-ndjar1 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-NDJAR(01)'  it_data-ndjar1
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ndjar2 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-NDJAR(02)'  it_data-ndjar2
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ndjar3 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-NDJAR(03)'  it_data-ndjar3
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ndper1 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-NDPER(01)'  it_data-ndper1
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ndper2 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-NDPER(02)'  it_data-ndper2
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-ndper3 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-NDPER(03)'  it_data-ndper3
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-afabg1 TO lv_datum1.
    IF NOT it_data-afabg1 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-AFABG(01)'  lv_datum1
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-afabg1 TO lv_datum2.
    IF NOT it_data-afabg2 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-AFABG(02)'  lv_datum2
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    WRITE it_data-afabg1 TO lv_datum3.
    IF NOT it_data-afabg3 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-AFABG(03)'  lv_datum3
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-wbind1 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-WBIND(01)'  it_data-wbind1
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-wbind2 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-WBIND(02)'  it_data-wbind2
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT it_data-wbind3 IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'ANLB-WBIND(03)'  it_data-wbind3
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
   USING    ''  ''  ''  'BDC_OKCODE'  '/00'
   CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

*   Save
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLAIST'  '1000'  'X'  ''  ''
           CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.


    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
   USING    ''  ''  ''  'BDC_OKCODE'  '=BUCH'
   CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT i_bdcdata[] IS INITIAL.

*     Perform Call Transaction to update the customer
      CALL TRANSACTION 'AS02' USING i_bdcdata
                              MODE gv_mode
                              UPDATE 'S'
                              MESSAGES INTO gt_messtab.

      IF sy-subrc NE 0 .
        LOOP AT gt_messtab.
          IF gt_messtab-msgtyp = c_type_a OR
             gt_messtab-msgtyp = c_type_e .
            SELECT SINGLE text INTO gv_text
                   FROM t100
                   WHERE sprsl = c_en
                     AND arbgb = gt_messtab-msgid
                     AND msgnr = gt_messtab-msgnr.
            IF sy-subrc = 0.
              gv_mstring = gv_text.
              IF gv_mstring CS '&1'.
                REPLACE '&1' WITH gt_messtab-msgv1 INTO gv_mstring.
                REPLACE '&2' WITH gt_messtab-msgv2 INTO gv_mstring.
                REPLACE '&3' WITH gt_messtab-msgv3 INTO gv_mstring.
                REPLACE '&4' WITH gt_messtab-msgv4 INTO gv_mstring.
              ELSE.
                REPLACE '&' WITH gt_messtab-msgv1 INTO gv_mstring.
                CONDENSE gv_mstring.
                REPLACE '&' WITH gt_messtab-msgv2 INTO gv_mstring.
                CONDENSE gv_mstring.
                REPLACE '&' WITH gt_messtab-msgv3 INTO gv_mstring.
                REPLACE '&' WITH gt_messtab-msgv4 INTO gv_mstring.
              ENDIF.
              CONDENSE gv_mstring.
              WRITE: / gv_mstring.
            ENDIF.
* Begin of Insert MOD-001
            gt_list-anln1  = it_data-anln1.
            gt_list-anln2  = it_data-anln2.
            gt_list-txt50  = gv_txt50.
            gt_list-result = 'NOT processed'.
            APPEND gt_list.
            CLEAR gt_list.
            EXIT.
          ELSE.
            IF NOT it_data-txt50 IS INITIAL.
              gv_txt50 = it_data-txt50.
            ENDIF.
            gt_list-anln1  = it_data-anln1.
            gt_list-anln2  = it_data-anln2.
            gt_list-txt50  = gv_txt50.
            gt_list-result = 'Processed'.
            APPEND gt_list.
            CLEAR gt_list.
          ENDIF .
* End of Insert MOD-001.
        ENDLOOP.
*Begin of COMMENTS MOD-001
*        gt_list-anln1  = it_data-anln1.
*        gt_list-anln2  = it_data-anln2.
*        gt_list-txt50  = gv_txt50.
*        gt_list-result = 'NOT processed'.
*        APPEND gt_list.
*        CLEAR gt_list.
*End of COMMENTS MOD-001
      ELSE.
        IF NOT it_data-txt50 IS INITIAL.
          gv_txt50 = it_data-txt50.
        ENDIF.
        gt_list-anln1  = it_data-anln1.
        gt_list-anln2  = it_data-anln2.
        gt_list-txt50  = gv_txt50.
        gt_list-result = 'Processed'.
        APPEND gt_list.
        CLEAR gt_list.

      ENDIF.
    ENDIF .

    CLEAR   i_bdcdata.
    REFRESH i_bdcdata.

  ENDLOOP.

  PERFORM print_results.

ENDFORM.                    " PROCESS_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_RECORD
*&---------------------------------------------------------------------*
*       Check input record
*----------------------------------------------------------------------*
FORM check_record.

  DATA: lv_lifnr     TYPE lifnr,
        lv_kostl     TYPE kostl.


  CLEAR gv_txt50.

* Check Asset
  SELECT SINGLE txt50 INTO gv_txt50
         FROM anla
         WHERE bukrs = p_bukrs
           AND anln1 = it_data-anln1
           AND anln2 = it_data-anln2.

  IF sy-subrc <> 0.
    gv_error = 'X'.
    WRITE: / text-033, it_data-anln1, it_data-anln2.
    RETURN.
  ENDIF.

* Check Vendor
  IF it_data-lifnr CN ' 0'.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = it_data-lifnr
      IMPORTING
        output = it_data-lifnr.

    SELECT SINGLE lifnr INTO lv_lifnr
           FROM lfa1
           WHERE lifnr = it_data-lifnr.

    IF sy-subrc <> 0.
      gv_error = 'X'.
      WRITE: / text-032, it_data-anln1, it_data-anln2, it_data-lifnr.
      RETURN.
    ENDIF.
  ENDIF.

* Check Costcenter
  IF it_data-kostl CN ' 0'.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = it_data-kostl
      IMPORTING
        output = it_data-kostl.

    SELECT SINGLE kostl INTO lv_kostl
           FROM csks
           WHERE kokrs =  c_1000
             AND kostl =  it_data-kostl
             AND datbi =  c_99991231
             AND bukrs =  p_bukrs
             AND kosar NE 'Z'.

    IF sy-subrc <> 0.
      gv_error = 'X'.
      WRITE: / text-022, it_data-anln1, it_data-anln2, it_data-kostl.
      RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "CHECK_RECORD

*&---------------------------------------------------------------------*
*&      Form  print_results
*&---------------------------------------------------------------------*
*       Print results
*----------------------------------------------------------------------*
FORM print_results.

  NEW-PAGE.

  IF NOT gt_list[] IS INITIAL.
    SORT gt_list.
    WRITE: / text-h01, p_bukrs, 70 sy-datum, ' ', sy-uzeit.
    ULINE.
    WRITE: /01 text-h02,
            15 text-h03,
            21 text-h04,
            72 text-h05.
    ULINE.

    LOOP AT gt_list.
      WRITE: /01 gt_list-anln1,
              15 gt_list-anln2,
              21 gt_list-txt50,
              72 gt_list-result.
    ENDLOOP.
  ENDIF.

ENDFORM.                    "form print-results

*Text symbol text
*001:Upload File
*002:Decimal notation
*003:1234567,89
*004:1234567.89
*005:ddmmjjjj
*006:jjjjmmdd
*009:Inputfile
*010:1 Record
*011:2 Records
*016:Decimal notation
*017:Date format
*018:Company Code
*022:CostCenter is not valid
*024:Select File
*032:Vendor Doesn't Exist
*033:Asset Doesn't Exist
*E03:No authorization for company :
*H01:Company:
*H02:Asset Number
*H03:Subn
*H04:Description

*H05:Result
*Selection text
*P_BUKRS:D       .
*P_COMMA:        1234567,89
*P_DMJ:        ddmmjjjj
*P_FNAME:        Inputfile
*P_JMD:        jjjjmmdd
*P_POINT:        1234567.89
*P_VIEW:        View screens (in foreground)
