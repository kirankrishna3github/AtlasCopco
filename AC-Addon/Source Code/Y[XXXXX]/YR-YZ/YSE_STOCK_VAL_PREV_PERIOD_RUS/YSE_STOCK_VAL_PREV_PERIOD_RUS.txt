*----------------------------------------------------------------------*
* PROGRAM ID           : YSE_STOCK_VAL_PREV_PERIOD                     *
* PROGRAM TITLE        : Stock valuation report for previous period    *
* AUTHOR               : Marc Jacobs                                   *
* DATE                 : 18/10/2007                                    *
* CHANGE REQUEST NUMBER: CD1K987553                                    *
* PROGRAM DESCRIPTION  : A report to calculate the stock valuation     *
*                        for previous period                           *
*                        Possibility to update workfile for downloads  *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 |03/04/2008|M.Jacobs  |CD2K940408| auth check on MBEW        *
*                                            extra parameter           *
* MOD-002 |28/04/2008|L.Mertens |CD2K941041| extend outputlist         *
* MOD-003 |07/05/2008|M.Jacobs  |CD1K940165| auth.check also in batch  *
* MOD-004 |22/07/2008|M.Jacobs  |CD1K942242| Optimisation              *
* MOD-005 |07/06/2010|Wouter D. |Issue 9802| Double stock overview due *
*         |                    to use of batches in Russia (MBEW-BWTAR *
* MOD-006 |23/11/2010|L.Mertens |CD1K961208| Add segment               *
* MOD-007 |23/07/2013|Anda Wu   |CD1K977041| Add 2 columns "Vendor"    *
*                                           and "Account group" (CN)   *
* MOD-008 |01/01/2015|Raghav D.V|CD1K984310| Add 2 columns " Storag    *
*                    |CR3274    |          |Loc"  and "Sloc quantity"  *
* MOD-009 |24/03/2015|PRAKASH.V |CD1K985921| Add 2 columns " Storag    *
*                    |CR3274    |          |Loc"  and "Sloc quantity"  *
*                  copied the YSE_STOCK_VAL_PREV_PERIOD into           *
*                  YSE_STOCK_VAL_PREV_PERIOD_RUS with CR3274 changes   *
* MOD-010 |13/06/2016|Dashmantha|CD1K989388| CR3748 Update whether the *
*                                             MATNR is obselete or not.*
* Addition of new columns Distribution Mode, Reordering Point,         *
*Date of last GR, qty of the last GR and sum of pieces sold            *
*----------------------------------------------------------------------*
REPORT yse_stock_val_prev_period NO STANDARD PAGE HEADING
                                           LINE-COUNT 65
* begin of change MOD-002
*                                          LINE-SIZE 120.
                                           LINE-SIZE 255.
* end of change MOD-002
TYPE-POOLS: slis.

TABLES: mbew,                         "material valuation
        mara,                         "material master
        ebew.                         "Sales Order Stock Valuation

* Begin of insertion by MOD-010
CONSTANTS : gc_mstav TYPE mstav VALUE 'Z5', " Cross-distribution-chain material status
            lv_601   TYPE bwart VALUE '601',
            lv_602   TYPE bwart VALUE '602'.

* Begin of insertion by MOD-010.

TYPES: BEGIN OF ty_mkpf,
       mblnr  TYPE mblnr, " Number of Material Document
       mjahr  TYPE mjahr, " Material Document Year
       bldat  TYPE bldat, " Document Date in Document
       budat  TYPE budat, " Posting Date in the Document
       END OF ty_mkpf.

TYPES: BEGIN OF ty_mseg,
       mblnr  TYPE mblnr,   " Number of Material Document
       mjahr  TYPE mjahr,   " Material Document Year
       bwart  TYPE bwart,   " Movement Type (Inventory Management)
       matnr  TYPE matnr,   " Material Number
       werks  TYPE werks_d, " Plant
       lgort  TYPE lgort_d, " Storage Location
       KUNNR  TYPE EKUNN,   " Account Number of Customer
       budat  TYPE budat,   " Date
       END OF ty_mseg.

TYPES: BEGIN OF ty_bwart,
       sign   TYPE sign,    " Debit/Credit Sign (+/-)
       option TYPE option,  " Option for ranges tables
       low    TYPE werks_d, " Plant
       high   TYPE werks_d, " Plant
       END OF ty_bwart.


TYPES: BEGIN OF ty_date,
         sign   TYPE sign,
         option TYPE option,
         low    TYPE datum,
         high   TYPE datum,
       END OF ty_date.


TYPES: BEGIN OF ty_mara,
       matnr TYPE matnr, " Material Number
       mstav TYPE mstav, " Cross-distribution-chain material status
       ersda TYPE ersda, " Created On
       END OF ty_mara.

TYPES: BEGIN OF ty_marc,
       matnr TYPE matnr,
       werks TYPE werks_d,
       dismm TYPE dismm,
       minbe TYPE minbe,
       prctr TYPE prctr,
       END OF ty_marc.
TYPES: BEGIN OF ty_mseg11,
      werks TYPE werks_d,
      lgort	TYPE lgort_d,
      matnr TYPE matnr,
      mblnr TYPE mblnr,
      mjahr TYPE mjahr,
      bwart TYPE bwart,
*      WERKS TYPE WERKS_D,
*      LGORT  TYPE LGORT_D,
      menge TYPE menge_d,
      budat_mkpf TYPE budat,
      END OF ty_mseg11.

TYPES: BEGIN OF ty_lips,
     VBELN  TYPE XBLNR, "VBELN_VL,
     POSNR  TYPE POSNR_VL,
     ERDAT  TYPE ERDAT,
     matnr  TYPE matnr,
     werks  TYPE werks_d,
     lgort  TYPE lgort_d,
     lfimg  TYPE lfimg,
     END OF ty_lips.

TYPES: BEGIN OF ty_lips11,
     matnr  TYPE matnr,
     werks  TYPE werks_d,
     lgort  TYPE lgort_d,
     lfimg  TYPE lfimg,
     END OF ty_lips11.

TYPES: BEGIN OF ty_mkpf11,
       mblnr TYPE mblnr,
       mjahr  TYPE mjahr,
       budat  TYPE budat,
       END OF ty_mkpf11.

TYPES: BEGIN OF ty_vbap,
       vbeln  TYPE vbeln_va,
       posnr  TYPE posnr_va,
       matnr  TYPE matnr,
       werks  TYPE werks_ext,
       lgort  TYPE lgort_d,
       erdat  TYPE erdat,
       END OF ty_vbap.
TYPES: BEGIN OF ty_vbfa,
       vbelv  TYPE vbeln_von,
       posnv TYPE	posnr_von,
       vbtyp_n  TYPE vbtyp_n,
       rfmng  TYPE rfmng,
       bwart  TYPE bwart,
       END OF ty_vbfa.
TYPES: BEGIN OF ty_rqty,
       matnr  TYPE matnr,
       werks  TYPE werks_ext,
       lgort  TYPE lgort_d,
       rfmng  TYPE rfmng,
       END OF ty_rqty.

TYPES: BEGIN OF TY_MSEG_Q,
       MBLNR      TYPE MBLNR,
       LINE_ID    TYPE MB_LINE_ID,
       BWART      TYPE BWART,
       MATNR      TYPE MATNR,
       WERKS      TYPE WERKS_D,
       LGORT      TYPE LGORT_D,
       SHKZG      TYPE SHKZG,
       MENGE      TYPE MENGE_D,
       XBLNR_MKPF TYPE XBLNR,
       END OF TY_MSEG_Q.

TYPES: BEGIN OF ty_plc,
       SEGMENT  TYPE FB_SEGMENT,
       plc      TYPE RKEG_WW002,
       END OF ty_plc.

TYPES : BEGIN OF ty_mvke,
        MATNR	TYPE MATNR,
        VKORG	TYPE VKORG,
        VTWEG	TYPE VTWEG,
        PRODH	TYPE PRODH_D,
        END OF ty_mvke.
TYPES: BEGIN OF ty_budat,
       bwart TYPE bwart,
       budat TYPE budat,
       lgort TYPE lgort_d, "nely added
       END OF ty_budat.
DATA : gt_marc    TYPE STANDARD TABLE OF ty_marc,
       gt_t438t   TYPE STANDARD TABLE OF t438t,
       gt_mseg11  TYPE STANDARD TABLE OF ty_mseg11,
       gt_mseg22  TYPE STANDARD TABLE OF ty_mseg11,
       gt_mkpf11  TYPE STANDARD TABLE OF ty_mkpf11,
       gt_lips    TYPE STANDARD TABLE OF ty_lips,
       gt_vbap    TYPE STANDARD TABLE OF ty_vbap,
       gt_vbfa    TYPE STANDARD TABLE OF ty_vbfa,
       gt_rqty    TYPE STANDARD TABLE OF ty_rqty,
       gt_mara    TYPE STANDARD TABLE OF ty_mara,
       gt_date    TYPE STANDARD TABLE OF ty_date,
       gt_lips11  TYPE STANDARD TABLE OF ty_lips11,
       gt_mseg_q  TYPE STANDARD TABLE OF ty_mseg_q,
       gt_mseg_r  TYPE STANDARD TABLE OF ty_mseg_q,
       gt_mseg    TYPE STANDARD TABLE OF ty_mseg,
       gt_mseg_1000 TYPE STANDARD TABLE OF ty_mseg,
       wa_mseg_1000 TYPE ty_mseg,
       gt_bwart   TYPE STANDARD TABLE OF ty_bwart,
       gt_mkpf    TYPE STANDARD TABLE OF ty_mkpf,
       gt_plc     TYPE STANDARD TABLE OF ty_plc,
       gt_yse_sales_lines TYPE STANDARD TABLE OF YSE_SALES_LINES,
       gt_mvke    TYPE STANDARD TABLE OF ty_mvke,
       gt_budat   TYPE STANDARD TABLE OF ty_budat,
       gt_budat1  TYPE STANDARD TABLE OF ty_budat,
       wa_budat   TYPE ty_budat,
       wa_mvke    TYPE ty_mvke,
       wa_yse_sales_lines TYPE YSE_SALES_LINES,
       gv_PRODH   TYPE PRODH_D,
       wa_plc     TYPE ty_plc,
       wa_mkpf    TYPE ty_mkpf,
       wa_mseg1   TYPE ty_mseg,
       wa_bwart   TYPE ty_bwart,
       wa_mseg_q  TYPE ty_mseg_q,
       wa_mseg_r  TYPE ty_mseg_q,
       wa_lips11  TYPE ty_lips11,
       wa_date    TYPE ty_date,
       wa_mara    TYPE ty_mara,
       wa_rqty    TYPE ty_rqty,
       wa_vbap    TYPE ty_vbap,
       wa_vbfa    TYPE ty_vbfa,
       wa_lips    TYPE ty_lips,
       wa_mkpf11  TYPE ty_mkpf11,
       wa_mseg11  TYPE ty_mseg11,
       wa_mseg_tmp TYPE ty_mseg11,
       wa_mseg22  TYPE ty_mseg11,
       wa_t438t   TYPE t438t,
       wa_marc    TYPE ty_marc.

DATA: lv_601_budat TYPE sy-datum,
      lv_261_budat TYPE sy-datum,
      lv_101_budat TYPE sy-datum,
      lv_budat     TYPE sy-datum.

CONSTANTS: gc_261   TYPE bwart VALUE '261', " Movement Type (Inventory Management)
           gc_262   TYPE bwart VALUE '262', " Movement Type (Inventory Management)
           gc_601   TYPE bwart VALUE '601', " Movement Type (Inventory Management)
           gc_602   TYPE bwart VALUE '602', " Movement Type (Inventory Management)
           gc_101   TYPE bwart VALUE '101', " Movement Type (Inventory Management)
           gc_999   TYPE bwart VALUE '999',
           gc_998   TYPE bwart VALUE '998',
           gc_701   TYPE bwart VALUE '701',
           gc_309   TYPE bwart VALUE '309',
           gc_241   TYPE bwart VALUE '241',
           gc_1000  TYPE lgort_d VALUE '1000',
           gc_i     TYPE c     VALUE 'I'.   " I of type Character
*           gc_mstav TYPE mstav VALUE 'Z5'. " Cross-distribution-chain material status

* End of insertion by MOD-010

* begin of insertion MOD-007
TYPES: BEGIN OF ty_eord,
        matnr  TYPE eord-matnr,       "Material Number
        werks  TYPE eord-werks,       "Plant
        lifnr  TYPE eord-lifnr,       "Vendor Account Number
        flifn  TYPE eord-flifn,       "Indicator: Fixed vendor
       END OF ty_eord,
       BEGIN OF ty_lfa1,
         lifnr TYPE lfa1-lifnr,       "Account Number of Vendor
         ktokk TYPE lfa1-ktokk,       "Vendor account group
       END OF ty_lfa1.
* end of insertion MOD-007
* Begin of Insertion MOD-008
TYPES: BEGIN OF ty_s032,
        ssour	  TYPE ssour,             " Statistic(s) origin
        vrsio   TYPE vrsio,             " Version number in the information structure
        werks	  TYPE werks_d,           " Plant
        lgort	  TYPE lgort_d,           " Storage Location
        matnr	  TYPE matnr,             " Material Number
        mbwbest	TYPE mbwbest,           " Quantity of valuated stock
       END OF ty_s032.
* End of Insertion MOD-008
DATA: BEGIN OF gt_mbew OCCURS 0.
        INCLUDE STRUCTURE mbew.
DATA :END OF gt_mbew.

DATA: BEGIN OF gt_mbewt OCCURS 0.
        INCLUDE STRUCTURE mbew.
DATA :END OF gt_mbewt.

DATA: BEGIN OF gt_ebew OCCURS 0.
        INCLUDE STRUCTURE ebew.
DATA :END OF gt_ebew.

DATA: BEGIN OF gt_ebewt OCCURS 0.
        INCLUDE STRUCTURE ebew.
DATA :END OF gt_ebewt.

DATA: BEGIN OF gt_out OCCURS 0,
        bwkey LIKE mbew-bwkey,
        matnr LIKE mbew-matnr,
        maktx LIKE makt-maktx,
*        segment TYPE yse_prctr_bl-segment,       "mod-006
        segment(32) TYPE c,       "mod-006
        zprctr LIKE marc-prctr,
        zgac(4) TYPE c,
        zpgc(4) TYPE c,
        lbkum LIKE mbew-lbkum,
        salk3 LIKE mbew-salk3,
        vmkum LIKE mbew-vmkum,
        vmsal LIKE mbew-vmsal,
        stprs LIKE mbew-stprs,
        bwprs LIKE mbew-bwprs,
        zkprs LIKE mbew-zkprs,
        abwkz LIKE mbew-abwkz,
        lfgja LIKE mbew-lfgja,
        lfmon LIKE mbew-lfmon,
        bklas LIKE mbew-bklas,
* begin of insertion MOD-007
        lifnr TYPE eord-lifnr,
        ktokk TYPE lfa1-ktokk,
* end of insertion MOD-007
* begin of insertion MOD-008
        lgort	  TYPE lgort_d,               " Storage Location
        mbwbest TYPE mbwbest,               " Quantity of valuated stock
* end of insertion MOD-008
        selected,
* Begin of insertion by MOD-010
        Obsolete    TYPE char3,
        DISMM	      TYPE DISMM,
        MINBE	      TYPE MINBE,
        BUDAT_MKPF  TYPE BUDAT,
        MENGE	      TYPE MENGE_D,
        lfimg       TYPE MENGE_D,
        RFMNG	      TYPE RFMNG,
        DIBEZ       TYPE DIBEZ,
        werks       TYPE WERKS_D,
        sold        TYPE MENGE_D,
        ersda       TYPE ersda,
        budat       TYPE sy-datum,
        plc         TYPE RKEG_WW002,
* End of insertion by MOD-010
      END OF gt_out.

DATA : wa_out LIKE gt_out.
DATA : wa_stock_report LIKE yse_stock_report.

DATA: g_mtart         LIKE mara-mtart,
      g_prdha         LIKE mara-prdha,
      g_maktx         LIKE makt-maktx,
* begin of insertion MOD-007
      g_flg_cn        TYPE char1,
* end of insertion MOD-007
      g_spras         LIKE makt-spras,
      g_prctr         LIKE marc-prctr,
      gt_fieldcat     TYPE slis_t_fieldcat_alv,
      g_events_tab    TYPE slis_t_event,
      g_form_user_command TYPE slis_formname VALUE 'USER_COMMAND_L',
      g_ic1           LIKE sy-ucomm VALUE '&IC1',
      g_repid         LIKE sy-repid,
      l_index         TYPE sy-tabix,
      g_vrsio         TYPE vrsio.                                             " +MOD-008

* begin of insertion MOD-004
FIELD-SYMBOLS: <mbew> TYPE ANY TABLE.
* end of insertion MOD-004

CONSTANTS: c_sc1(3)             VALUE 'SC1',
           c_s(1) TYPE c        VALUE 'S',
           c_x(1) TYPE c        VALUE 'X',
           c_spras(1) TYPE c    VALUE 'E',
* begin of insertion MOD-004
           c_mbew(35) TYPE c    VALUE '(SAPLMG27)IMBEWH[]'.
* end of insertion MOD-004
* begin of insertion MOD-003
CONSTANTS : c_tcode LIKE sy-tcode VALUE 'YSE_FI_REP_STOCKS_RU'.
* end of insertion MOD-003
* begin of insertion MOD-007
CONSTANTS:  c_cn01 TYPE werks VALUE 'CN01',
            c_cn41 TYPE werks VALUE 'CN41'.
* end of insertion MOD-007

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-b01.
SELECT-OPTIONS: s_bwkey FOR mbew-bwkey,
                s_matnr FOR mbew-matnr,
                s_bklas FOR mbew-bklas,
                s_mtart FOR mara-mtart OBLIGATORY DEFAULT 'ZMAT'.
SELECTION-SCREEN END   OF BLOCK b1.

SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-b02.
PARAMETERS: p_dtc AS CHECKBOX,
            p_dtconl AS CHECKBOX.
SELECT-OPTIONS: s_dtc FOR ebew-bwkey. "OBLIGATORY.
SELECTION-SCREEN END   OF BLOCK b2.

SELECTION-SCREEN BEGIN OF BLOCK b3 WITH FRAME TITLE text-b03.
PARAMETERS: p_updf AS CHECKBOX.
SELECTION-SCREEN END OF BLOCK b3.
SELECT-OPTIONS : s_vrsio FOR g_vrsio NO-DISPLAY.                                             " +MOD-008
*.................. Selection screen validations...................... *
* at selection screen on.

AT SELECTION-SCREEN ON BLOCK b2.
  IF p_dtc IS NOT INITIAL AND s_dtc IS INITIAL.
    MESSAGE e001(00) WITH text-e01.
  ENDIF.

  IF p_dtconl IS NOT INITIAL AND s_dtc IS INITIAL.
    MESSAGE e001(00) WITH text-e01.
  ENDIF.

  IF p_dtc IS NOT INITIAL AND p_dtconl IS NOT INITIAL.
    MESSAGE e001(00) WITH text-e02.
  ENDIF.

* begin of insertion MOD-003
  IF sy-batch IS INITIAL.
* end of insertion MOD-003
    LOOP AT s_bwkey.
      AUTHORITY-CHECK OBJECT 'I_SWERK'
                 ID 'TCD'   FIELD sy-tcode
                 ID 'SWERK' FIELD s_bwkey-low.
      IF sy-subrc NE 0.
        MESSAGE e001(00) WITH text-e04 s_bwkey-low.
      ELSEIF NOT s_bwkey-high IS INITIAL.
        AUTHORITY-CHECK OBJECT 'I_SWERK'
                 ID 'TCD'   FIELD sy-tcode
                 ID 'SWERK' FIELD s_bwkey-high.
        IF sy-subrc NE 0.
          MESSAGE e001(00) WITH text-e04 s_bwkey-high.
        ENDIF.
      ENDIF.
    ENDLOOP.

    LOOP AT s_dtc.
      AUTHORITY-CHECK OBJECT 'I_SWERK'
                   ID 'TCD'   FIELD sy-tcode
                   ID 'SWERK' FIELD s_dtc-low.
      IF sy-subrc NE 0.
        MESSAGE e001(00) WITH text-e04 s_dtc-low.
      ELSEIF NOT s_dtc-high IS INITIAL.
        AUTHORITY-CHECK OBJECT 'I_SWERK'
                 ID 'TCD'   FIELD sy-tcode
                 ID 'SWERK' FIELD s_dtc-high.
        IF sy-subrc NE 0.
          MESSAGE e001(00) WITH text-e04 s_dtc-high.
        ENDIF.
      ENDIF.
    ENDLOOP.
* begin of insertion MOD-003
  ELSE.
    LOOP AT s_bwkey.
      AUTHORITY-CHECK OBJECT 'I_SWERK'
                 ID 'TCD'   FIELD c_tcode
                 ID 'SWERK' FIELD s_bwkey-low.
      IF sy-subrc NE 0.
        MESSAGE e001(00) WITH text-e04 s_bwkey-low.
      ELSEIF NOT s_bwkey-high IS INITIAL.
        AUTHORITY-CHECK OBJECT 'I_SWERK'
                 ID 'TCD'   FIELD c_tcode
                 ID 'SWERK' FIELD s_bwkey-high.
        IF sy-subrc NE 0.
          MESSAGE e001(00) WITH text-e04 s_bwkey-high.
        ENDIF.
      ENDIF.
    ENDLOOP.

    LOOP AT s_dtc.
      AUTHORITY-CHECK OBJECT 'I_SWERK'
                   ID 'TCD'   FIELD c_tcode
                   ID 'SWERK' FIELD s_dtc-low.
      IF sy-subrc NE 0.
        MESSAGE e001(00) WITH text-e04 s_dtc-low.
      ELSEIF NOT s_dtc-high IS INITIAL.
        AUTHORITY-CHECK OBJECT 'I_SWERK'
                 ID 'TCD'   FIELD c_tcode
                 ID 'SWERK' FIELD s_dtc-high.
        IF sy-subrc NE 0.
          MESSAGE e001(00) WITH text-e04 s_dtc-high.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.
* end of insertion MOD-003
*-----------------------------------------------------------------------
START-OF-SELECTION.


* begin of change MOD-001
* PERFORM authority_begin(rsaqexce).
* PERFORM authority(rsaqexce) USING 'MBEW'.
* PERFORM authority_end(rsaqexce).
  PERFORM authority_begin(rsaqexce) USING 'CL_QUERY_TAB_ACCESS_AUTHORITY'.
  PERFORM authority(rsaqexce) USING 'MBEW'
                                       'CL_QUERY_TAB_ACCESS_AUTHORITY'.
  PERFORM authority_end(rsaqexce) USING 'CL_QUERY_TAB_ACCESS_AUTHORITY'.
* end of change MOD-001
* begin of insertion MOD-007
  PERFORM check_werks_cn.
* end of insertion MOD-007
  IF p_dtconl IS INITIAL.

* selection of normal sales stock

    SELECT * FROM mbew INTO TABLE gt_mbew
     WHERE bwkey IN s_bwkey
     AND   bklas IN s_bklas
     AND   matnr IN s_matnr
* begin of insertion MOD-005
     AND   bwtar EQ space.
* MBEW contains one line per batch and one 'total' line. Since currently
* only Russia uses batches, they are the first to stumble across the
* problem.  See example below.
* Material Valuation Area Valuation Type   Total Stock
*
* 409         PL09                               0,000    <- OK
* 409         PL10                               0,000    <- OK
* 409         RU01                              15,000    <- OK
* 409         RU01           0000000034          0,000
* 409         RU01           0000000042          1,000
* 409         RU01           0000000045          1,000
* 409         RU01           0000000049          1,000 etc ....
* end of insertion MOD-005

* sort table
    SORT gt_mbew BY matnr.

* select only the records with a correct material type
    LOOP AT gt_mbew.
      AT NEW matnr.
        CLEAR g_mtart.
        SELECT SINGLE mtart INTO g_mtart FROM mara
         WHERE matnr = gt_mbew-matnr.
      ENDAT.
      IF g_mtart NOT IN s_mtart.
        DELETE gt_mbew.
      ENDIF.
    ENDLOOP.

* call function mbew_extend record by record

    LOOP AT gt_mbew.
      REFRESH gt_mbewt.
      MOVE-CORRESPONDING gt_mbew TO gt_mbewt.
      APPEND gt_mbewt.
* begin of insertion MOD-004
      ASSIGN (c_mbew) TO <mbew>.
      IF <mbew> IS ASSIGNED.
        CLEAR <mbew>.
      ENDIF.
* end of insertion MOD-004
      CALL FUNCTION 'MBEW_EXTEND'
        EXPORTING
          xvper    = 'X'
        TABLES
          mbew_tab = gt_mbewt.
* update gt_mbew
      LOOP AT gt_mbewt.
        MOVE-CORRESPONDING gt_mbewt TO gt_mbew.
        MODIFY gt_mbew.
      ENDLOOP.
* delete entry in table gt_mbew when no values
      IF gt_mbew-vmkum IS INITIAL AND
         gt_mbew-vmsal IS INITIAL AND
         gt_mbew-lbkum IS INITIAL AND
         gt_mbew-salk3 IS INITIAL.
        DELETE gt_mbew.
      ENDIF.
    ENDLOOP.

  ENDIF.

* extra selection +DTC or DTC only

  IF p_dtc = 'X' OR p_dtconl = 'X'.

* selection of DTC stock
    SELECT * FROM ebew INTO TABLE gt_ebew
       WHERE bwkey IN s_dtc
       AND   matnr IN s_matnr.

* sort table
    SORT gt_ebew BY matnr.

* select only the records with a correct material type
    LOOP AT gt_ebew.
      AT NEW matnr.
        CLEAR g_mtart.
        SELECT SINGLE mtart INTO g_mtart FROM mara
         WHERE matnr = gt_ebew-matnr.
      ENDAT.
      IF g_mtart NOT IN s_mtart.
        DELETE gt_ebew.
      ENDIF.
    ENDLOOP.

* call function ebew_extend record by record

    LOOP AT gt_ebew.
      REFRESH gt_ebewt.
      MOVE-CORRESPONDING gt_ebew TO gt_ebewt.
      APPEND gt_ebewt.
      CALL FUNCTION 'EBEW_EXTEND'
        EXPORTING
          xvper    = 'X'
        TABLES
          ebew_tab = gt_ebewt.
* update gt_mbew
      LOOP AT gt_ebewt.
        MOVE-CORRESPONDING gt_ebewt TO gt_ebew.
        MODIFY gt_ebew.
      ENDLOOP.
* delete entry in table gt_ebew when no values
      IF gt_ebew-vmkum IS INITIAL AND
         gt_ebew-vmsal IS INITIAL AND
         gt_ebew-lbkum IS INITIAL AND
         gt_ebew-salk3 IS INITIAL.
        DELETE gt_ebew.
      ENDIF.
    ENDLOOP.
* flag p_dtc = on
  ENDIF.

* add table gt_mbew to table gt_out

  IF NOT gt_mbew[] IS INITIAL.

    LOOP AT gt_mbew.
      CLEAR gt_out.
      MOVE-CORRESPONDING gt_mbew TO gt_out.
* profit center
* Begin of deletion by MOD-010
      SELECT SINGLE prctr INTO gt_out-zprctr FROM marc
       WHERE matnr = gt_mbew-matnr
       AND   werks = gt_mbew-bwkey.
* End of deletion by MOD-010

* begin of insert MOD-006
* segment
      IF sy-subrc = 0.
        SELECT SINGLE segment INTO gt_out-segment
          FROM yse_prctr_bl WHERE prctr = gt_out-zprctr.
      ENDIF.
* end of insert MOD-006
* values current period
      gt_out-lbkum = gt_mbew-lbkum.
      gt_out-salk3 = gt_mbew-salk3.
* values previous period
      gt_out-vmkum = gt_mbew-vmkum.
      gt_out-vmsal = gt_mbew-vmsal.
* save in gt_out
      APPEND gt_out.
    ENDLOOP.
  ENDIF.

* add table gt_ebew to table gt_out

  IF NOT gt_ebew[] IS INITIAL.
    LOOP AT gt_ebew.
      READ TABLE gt_out WITH KEY bwkey = gt_ebew-bwkey
                                 matnr = gt_ebew-matnr.
      IF sy-subrc = 0.
        wa_out = gt_out.
* values current period
        wa_out-lbkum = wa_out-lbkum + gt_ebew-lbkum.
        wa_out-salk3 = wa_out-salk3 + gt_ebew-salk3.
* values previous period
        wa_out-vmkum = wa_out-vmkum + gt_ebew-vmkum.
        wa_out-vmsal = wa_out-vmsal + gt_ebew-vmsal.
        MODIFY gt_out FROM wa_out INDEX sy-tabix.
      ELSE.
        CLEAR gt_out.
        MOVE-CORRESPONDING gt_ebew TO gt_out.
* profit center
        SELECT SINGLE prctr INTO gt_out-zprctr FROM marc
         WHERE matnr = gt_ebew-matnr
         AND   werks = gt_ebew-bwkey.
* begin of insert MOD-006
* segment
        IF sy-subrc = 0.
          SELECT SINGLE segment INTO gt_out-segment
            FROM yse_prctr_bl WHERE prctr = gt_out-zprctr.
        ENDIF.
* end of insert MOD-006
* values current period
        gt_out-lbkum = gt_ebew-lbkum.
        gt_out-salk3 = gt_ebew-salk3.
* values previous period
        gt_out-vmkum = gt_ebew-vmkum.
        gt_out-vmsal = gt_ebew-vmsal.
* save in gt_out
        APPEND gt_out.
      ENDIF.
    ENDLOOP.
  ENDIF.

* following things only once for a new material number

  SORT gt_out BY matnr.

  IF NOT gt_out[] IS INITIAL.
* Begin of insertion by MOD-010
   SELECT SOUR1_FROM TARGET1 FROM K9RCD11000010
            INTO TABLE gt_plc
            FOR ALL ENTRIES IN gt_out
            WHERE SOUR1_FROM = gt_out-segment.
     SORT gt_plc by segment.

     SELECT * FROM YSE_SALES_LINES
              INTO TABLE gt_YSE_SALES_LINES
              FOR ALL ENTRIES IN gt_out
              WHERE werks = gt_out-bwkey.
       IF sy-subrc = 0.
         SORT gt_YSE_SALES_LINES BY werks.
*         SELECT MATNR
*                VKORG
*                VTWEG
*                PRODH FROM mvke
*                      INTO TABLE gt_mvke
*                      FOR ALL ENTRIES IN gt_YSE_SALES_LINES
*                      WHERE matnr = gt_YSE_SALES_LINES-matnr
*                      AND   vkorg = gt_YSE_SALES_LINES-vkorg
*                      AND   vtweg = gt_YSE_SALES_LINES-vtweg.
       ENDIF.

* End of insertion by MOD-010
    LOOP AT gt_out.
      AT NEW matnr.
* gac and pgc
        CLEAR g_prdha.
        SELECT SINGLE prdha INTO g_prdha FROM mara
         WHERE matnr = gt_out-matnr.
* material description
        CLEAR g_maktx.
        SELECT SINGLE maktx INTO g_maktx FROM makt
         WHERE matnr = gt_out-matnr AND spras = c_spras.
      ENDAT.
      gt_out-zgac = g_prdha(4).
      gt_out-zpgc = g_prdha+4(4).
      gt_out-maktx = g_maktx.
      READ TABLE gt_plc INTO wa_plc WITH KEY segment = gt_out-segment BINARY SEARCH.
      IF sy-subrc = 0.
        gt_out-plc = wa_plc-plc.
      ENDIF.
      READ TABLE gt_YSE_SALES_LINES INTO wa_YSE_SALES_LINES WITH KEY werks = gt_out-bwkey BINARY SEARCH.
      IF sy-subrc = 0.
        SELECT single PRODH INTO gv_PRODH
                            FROM mvke
                            WHERE matnr = gt_out-matnr
                            AND   vkorg = wa_YSE_SALES_LINES-vkorg
                            AND   vtweg = wa_YSE_SALES_LINES-vtweg.
        IF sy-subrc = 0.
*       Update Product hierarchy from Sales view2
            gt_out-zgac = gv_PRODH(4).
            gt_out-zpgc = gv_PRODH+4(4).
            CLEAR gv_PRODH.
        ENDIF.
      ENDIF.
      MODIFY gt_out.
    ENDLOOP.
  ENDIF.

* begin of insert MOD-007
  IF g_flg_cn IS NOT INITIAL.
    DATA: lt_out LIKE STANDARD TABLE OF gt_out,
          lt_eord TYPE STANDARD TABLE OF ty_eord,
          lt_lfa1 TYPE STANDARD TABLE OF ty_lfa1,
          ls_eord TYPE ty_eord,
          ls_lfa1 TYPE ty_lfa1.

    lt_out = gt_out[].
    SORT   lt_out BY matnr bwkey.
    DELETE ADJACENT DUPLICATES FROM lt_out COMPARING matnr bwkey.
    IF lt_out IS NOT INITIAL.
      SELECT  matnr                   "Material Number
              werks                   "Plant
              lifnr                   "Vendor Account Number
              flifn                   "Indicator: Fixed vendor
        FROM  eord
        INTO TABLE lt_eord
        FOR ALL ENTRIES IN lt_out
        WHERE matnr = lt_out-matnr
          AND werks = lt_out-bwkey
          AND flifn = 'X'.
      SELECT  matnr                   "Material Number
              werks                   "Plant
              lifnr                   "Vendor Account Number
              flifn                   "Indicator: Fixed vendor
        FROM  eord
        APPENDING TABLE lt_eord
        FOR ALL ENTRIES IN lt_out
        WHERE matnr = lt_out-matnr
          AND ( werks = c_cn01 OR werks = c_cn41 )
          AND flifn = 'X'.
      IF lt_eord IS NOT INITIAL.
        SELECT  lifnr                 "Account Number of Vendor
                ktokk                 "Vendor account group
          FROM lfa1
          INTO TABLE lt_lfa1
          FOR ALL ENTRIES IN lt_eord
          WHERE lifnr = lt_eord-lifnr.
      ENDIF.
      LOOP AT gt_out.
        CLEAR: ls_eord.
        READ TABLE lt_eord INTO ls_eord
          WITH KEY matnr = gt_out-matnr
                   werks = gt_out-bwkey.
        IF sy-subrc = 0.
          gt_out-lifnr = ls_eord-lifnr.
        ELSE.
          CLEAR: ls_eord.
          READ TABLE lt_eord INTO ls_eord
            WITH KEY matnr = gt_out-matnr
                     werks = c_cn01.
          IF sy-subrc = 0.
            gt_out-lifnr = ls_eord-lifnr.
          ELSE.
            CLEAR: ls_eord.
            READ TABLE lt_eord INTO ls_eord
              WITH KEY matnr = gt_out-matnr
                       werks = c_cn41.
            IF sy-subrc = 0.
              gt_out-lifnr = ls_eord-lifnr.
            ENDIF.
          ENDIF.
        ENDIF.
        CLEAR ls_lfa1.
        READ TABLE lt_lfa1 INTO ls_lfa1
          WITH KEY lifnr = ls_eord-lifnr.
        IF sy-subrc = 0.
          gt_out-ktokk = ls_lfa1-ktokk.
        ENDIF.
        MODIFY gt_out.
      ENDLOOP.
    ENDIF.
    REFRESH: lt_out.
  ENDIF.
* begin of insert MOD-007
* Begin of Insertion MOD-008
  DATA:     lt_s032   TYPE STANDARD TABLE OF ty_s032,
            ls_s032   TYPE ty_s032,
            lv_matnr  TYPE matnr.
  IF gt_out[] IS NOT INITIAL.
    SELECT
      ssour
      vrsio
      werks
      lgort
      matnr
      mbwbest
      FROM s032
      INTO TABLE lt_s032
      FOR ALL ENTRIES IN gt_out
      WHERE ssour = space
      AND vrsio IN s_vrsio
      AND werks = gt_out-bwkey
      AND lgort NE space
      AND matnr = gt_out-matnr.

    IF sy-subrc = 0.
      SORT lt_s032 BY werks matnr ASCENDING mbwbest DESCENDING.
      CLEAR: lv_matnr.
      DATA : lv_flg_vmkum,
             lv_prev_matnr TYPE matnr,
             lv_prev_bwkey TYPE werks_d,
             lv_tabix TYPE sy-tabix.
      SORT gt_out BY bwkey matnr.
      LOOP AT lt_s032 INTO ls_s032.
        CLEAR wa_out.
        lv_tabix =  sy-tabix .

        READ TABLE gt_out INTO wa_out WITH KEY bwkey = ls_s032-werks
                                               matnr = ls_s032-matnr
                                      BINARY SEARCH.
        IF sy-subrc = 0.
          wa_out-lgort    = ls_s032-lgort.
          wa_out-mbwbest  = ls_s032-mbwbest.
          wa_out-salk3    = ( wa_out-salk3 / wa_out-lbkum ) * ls_s032-mbwbest.
*** Begin of Insertion MOD-009  -Prakash -CR3274
*        wa_out-vmsal    = ( wa_out-vmsal / wa_out-vmkum ) * ls_s032-mbwbest. - MOD 009 prakash
          IF lv_tabix EQ 1.
            lv_prev_matnr = wa_out-matnr.
            lv_prev_bwkey = wa_out-bwkey.
          ELSEIF lv_prev_matnr = wa_out-matnr and lv_prev_bwkey = wa_out-bwkey.
            lv_flg_vmkum = 'X'.
          ELSEIF ( lv_prev_matnr ne wa_out-matnr ) or ( lv_prev_bwkey ne wa_out-bwkey ).
            lv_flg_vmkum = ' '.
            lv_prev_matnr = wa_out-matnr.
            lv_prev_bwkey = wa_out-bwkey.
          ENDIF.
          IF lv_flg_vmkum = 'X'.
            wa_out-vmkum = ' '.
            wa_out-vmsal = ' '.

          ENDIF.
***   End of Insertion MOD-009 -Prakash -CR3274
          APPEND wa_out TO lt_out.
        ENDIF.
      ENDLOOP.
      REFRESH gt_out.
      gt_out[] = lt_out[].
    ENDIF.
  ENDIF.
* End of Insertion MOD-008

* Begin of insrtion by MOD-010.
    IF NOT gt_out[] IS INITIAL.

* Collect all movement types into gt_bwart.
      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_261.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_601.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_101.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_999.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_998.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_701.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_309.
      APPEND wa_bwart TO gt_bwart.

      wa_bwart-sign    = gc_i.
      wa_bwart-option  = 'EQ'.
      wa_bwart-low     = gc_241.
      APPEND wa_bwart TO gt_bwart.

      SELECT mblnr           " Number of Material Document
             mjahr           " Material Document Year
             bwart           " Movement Type (Inventory Management)
             matnr           " Material Number
             werks           " Plant
             lgort           " Storage Location
             kunnr           " Account Number of Customer
              FROM mseg      " Document Segment: Material
                   INTO TABLE gt_mseg
                   FOR ALL ENTRIES IN gt_out
                   WHERE matnr =  gt_out-matnr
                   AND   werks = gt_out-bwkey
                   AND   lgort = gt_out-lgort
                   AND   bwart IN gt_bwart.

        LOOP AT gt_mseg INTO wa_mseg1.

          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
            EXPORTING
              input         = wa_mseg1-kunnr
           IMPORTING
             OUTPUT        = wa_mseg1-kunnr.

          IF wa_mseg1-kunnr+0(3) EQ '102'.
            DELETE gt_mseg INDEX sy-tabix.
          ENDIF.
        ENDLOOP.

      IF sy-subrc = 0.
        SELECT mblnr            " Number of Material Document
               mjahr            " Material Document Year
               bldat            " Document Date in Document
               budat  FROM mkpf " Header: Material Document
                      INTO TABLE gt_mkpf
                      FOR ALL ENTRIES IN gt_mseg
                      WHERE mblnr = gt_mseg-mblnr
                      AND   mjahr = gt_mseg-mjahr.

        SORT gt_mkpf BY mblnr mjahr.
*     SORT gt_mseg BY matnr ASCENDING mjahr DESCENDING.
        SORT gt_mseg BY mblnr DESCENDING.
      ENDIF. " IF sy-subrc = 0

* Fetch the material creation date Cross-distribution-chain material status from MARA
      SELECT matnr  " Material Number
             mstav  " Cross-distribution-chain material status
             ersda  " Created On
        FROM mara " General Material Data
                   INTO TABLE gt_mara
                   FOR ALL ENTRIES IN gt_out
                   WHERE matnr = gt_out-matnr.
      IF sy-subrc = 0.
        SORT gt_mara BY matnr.
      ENDIF. " IF sy-subrc = 0

* Get DISMM and MINBE fields from MARC
      SELECT matnr
             werks
             dismm
             minbe
             prctr FROM marc
                   INTO TABLE gt_marc
                   FOR ALL ENTRIES IN gt_out
                   WHERE matnr = gt_out-matnr
                   AND   werks = gt_out-bwkey.
      IF sy-subrc = 0.
        SORT gt_marc BY matnr werks ASCENDING.
        SELECT * FROM t438t
                 INTO TABLE gt_t438t
                 FOR ALL ENTRIES IN gt_marc
                 WHERE  spras = sy-langu
                 AND    dismm = gt_marc-dismm.
        SORT gt_t438t BY dismm ASCENDING.
      ENDIF.
* Get MSEG data for MATNR and WERKS for latest delivered date and quantity
      SELECT mblnr
             mjahr
             bwart
             matnr
             werks
             lgort
             menge
             budat_mkpf FROM mseg
                        INTO CORRESPONDING FIELDS OF TABLE gt_mseg11
                        FOR ALL ENTRIES IN gt_out
                         WHERE bwart = '101'
                         AND   matnr = gt_out-matnr
                         AND   werks = gt_out-bwkey
                         AND   lgort = gt_out-lgort.
      IF sy-subrc = 0.
*        SORT gt_mseg11 BY matnr mblnr DESCENDING.
*           SORT gt_mseg11 BY MATNR WERKS LGORT ASCENDING MBLNR DESCENDING.
           SORT gt_mseg11 BY MATNR WERKS LGORT ASCENDING budat_mkpf DESCENDING.
        LOOP AT gt_mseg11 INTO wa_mseg11.
          wa_mseg_tmp = wa_mseg11.
          AT NEW matnr.
            wa_mseg22 = wa_mseg_tmp.
            APPEND wa_mseg22 TO gt_mseg22.
            CLEAR wa_mseg_tmp.
          ENDAT.
        ENDLOOP.
      ENDIF.
      IF NOT gt_mseg22[] IS INITIAL.
        SELECT  mblnr
                mjahr
                budat FROM mkpf
                      INTO TABLE gt_mkpf11
                      FOR ALL ENTRIES IN gt_mseg22
                      WHERE mblnr = gt_mseg22-mblnr
                      AND   mjahr = gt_mseg22-mjahr.
          SORT gt_mkpf11 BY MBLNR MJAHR.
      ENDIF.
      DATA: gv_date1 TYPE sy-datum,
            gv_date2 TYPE sy-datum,
            gv_NUMC3 TYPE NUMC3 VALUE '12'.
*      gv_old_date1 = sy-datum - 365.

      CALL FUNCTION 'CCM_GO_BACK_MONTHS'
        EXPORTING
          currdate         = sy-datum
          backmonths       = gv_NUMC3
       IMPORTING
         NEWDATE          = gv_date1.
      gv_date2 = sy-datum.
* Dates calculation
      wa_date-sign    = 'I'.
      wa_date-option  =  'BT'.
      wa_date-low     =  gv_date1.
      wa_date-high    = gv_date2.
      APPEND wa_date TO gt_date.

        SELECT MBLNR
               LINE_ID
               BWART
               MATNR
               WERKS
               LGORT
               SHKZG
               MENGE
               XBLNR_MKPF FROM MSEG
                          INTO TABLE GT_MSEG_Q
                          FOR ALL ENTRIES IN gt_out
                          WHERE MATNR = gt_out-matnr
                          AND   WERKS = gt_out-bwkey
                          AND   lgort = gt_out-lgort
                          AND   BUDAT_MKPF IN gt_date
                          AND   ( BWART EQ gc_601 or bwart EQ gc_261 ).


            IF sy-subrc = 0.
               SORT gt_mseg_q by matnr werks lgort XBLNR_MKPF.

                LOOP AT gt_mseg_q INTO wa_mseg_q.
                  wa_lips11-matnr = wa_mseg_q-matnr.
                  wa_lips11-werks = wa_mseg_q-werks.
                  wa_lips11-lgort = wa_mseg_q-lgort.

                 IF wa_mseg_q-shkzg = 'H'.
                    wa_lips11-lfimg = wa_mseg_q-menge.
                  ELSE.
                    wa_lips11-lfimg = wa_mseg_q-menge * -1.
                  ENDIF.
                  COLLECT wa_lips11 INTO gt_lips11.
              CLEAR wa_lips11.
                 ENDLOOP.
            ENDIF.

        SELECT MBLNR
               LINE_ID
               BWART
               MATNR
               WERKS
               LGORT
               SHKZG
               MENGE
               XBLNR_MKPF FROM MSEG
                          INTO TABLE GT_MSEG_r
                          FOR ALL ENTRIES IN gt_out
                          WHERE MATNR = gt_out-matnr
                          AND   WERKS = gt_out-bwkey
                          AND   lgort = gt_out-lgort
                          AND   BUDAT_MKPF IN gt_date
                          AND   ( BWART EQ gc_602 or bwart EQ gc_262 ).


            IF sy-subrc = 0.
               SORT gt_mseg_r by matnr werks lgort XBLNR_MKPF.

                LOOP AT gt_mseg_r INTO wa_mseg_r.
                  wa_rqty-matnr = wa_mseg_r-matnr.
                  wa_rqty-werks = wa_mseg_r-werks.
                  wa_rqty-lgort = wa_mseg_r-lgort.

                 IF wa_mseg_q-shkzg = 'H'.
                    wa_rqty-rfmng = wa_mseg_r-menge.
                  ELSE.
                    wa_rqty-rfmng = wa_mseg_r-menge * -1.
                  ENDIF.
                  COLLECT wa_rqty INTO gt_rqty.
                  CLEAR wa_rqty.
                 ENDLOOP.
            ENDIF.

*************************************************************************
*            Update GT_MSEG with BUDAT from GT_MKPF based MBLNR
      LOOP AT gt_mseg INTO wa_mseg1.
        READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr BINARY SEARCH.
        IF sy-subrc = 0.
          wa_mseg1-budat = wa_mkpf-budat.
          MODIFY gt_mseg FROM wa_mseg1 TRANSPORTING budat.
        ENDIF.
      ENDLOOP.

      SORT gt_mseg BY MATNR werks lgort bwart budat DESCENDING.

*************************************************************************

      LOOP AT gt_out INTO wa_out.
        CLEAR: wa_out-lfmon, wa_out-lfgja.
        READ TABLE gt_mara INTO wa_mara
                           WITH KEY matnr = wa_out-matnr
                           BINARY SEARCH.
        IF sy-subrc = 0.
          wa_out-ersda = wa_mara-ersda.
          IF wa_mara-mstav EQ gc_mstav.
            wa_out-obsolete = 'Yes'.
          ELSE. " ELSE -> IF wa_mara-mstav EQ gc_mstav
            wa_out-obsolete = 'No'.
          ENDIF. " IF wa_mara-mstav EQ gc_mstav
        ENDIF. " IF sy-subrc = 0
* Determine last movement date.
**     Search whther 601 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_601
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_601_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_601.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
            APPEND wa_budat to gt_budat1.
          ENDIF. " IF sy-subrc = 0

        ENDIF. " IF sy-subrc = 0
**     Search whther 261 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_261
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_261_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_261.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
            APPEND wa_budat to gt_budat1.
          ENDIF. " IF sy-subrc = 0
        ENDIF. " IF sy-subrc = 0
**     Search whther 601 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_101
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_101_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_101.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
            APPEND wa_budat to gt_budat1.
          ENDIF. " IF sy-subrc = 0
        ENDIF. " IF sy-subrc = 0

**     Search whther 999 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_999
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_101_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_999.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
          ENDIF. " IF sy-subrc = 0
        ENDIF. " IF sy-subrc = 0

**     Search whther 998 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_998
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_101_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_998.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
          ENDIF. " IF sy-subrc = 0
        ENDIF. " IF sy-subrc = 0

**     Search whther 701 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_701
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_101_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_701.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
            APPEND wa_budat to gt_budat1.
          ENDIF. " IF sy-subrc = 0
        ENDIF. " IF sy-subrc = 0

**     Search whther 309 movement type exists for material.
        READ TABLE gt_mseg INTO wa_mseg1 WITH KEY bwart = gc_309
                                                  matnr = wa_out-matnr
                                                  werks = wa_out-bwkey
                                                  lgort = wa_out-lgort.
        IF sy-subrc = 0.
          READ TABLE gt_mkpf INTO wa_mkpf
                             WITH KEY mblnr = wa_mseg1-mblnr
                                      mjahr = wa_mseg1-mjahr.
          IF sy-subrc = 0.
*            lv_101_budat = wa_mkpf-budat.
            wa_budat-bwart = gc_309.
            wa_budat-budat = wa_mkpf-budat.
            wa_budat-lgort = wa_out-lgort.
            APPEND wa_budat to gt_budat.
            APPEND wa_budat to gt_budat1.
          ENDIF. " IF sy-subrc = 0
        ENDIF. " IF sy-subrc = 0

        SORT gt_budat   BY budat DESCENDING.
        SORT gt_budat1  BY budat DESCENDING.

* If storage location is 1000 then do a sbelow
*Date of last movement: to show the dates for the last movements 601, 261, 101, 999,
*                       998, 701, 309, 241 on 1000 location.
*Date of Last GR:should be the date of 101 movement  on the 1000 location, if there
*                is no such movement - to take the last 309, 701, 241 on 1000 location.

          IF wa_out-lgort = gc_1000.
            IF NOT gt_budat[] IS INITIAL.
              READ TABLE gt_budat INTO wa_budat WITH KEY lgort = gc_1000.
              IF sy-subrc = 0.
                wa_out-budat = wa_budat-budat.
              ENDIF.
              READ TABLE gt_budat INTO wa_budat WITH KEY bwart = gc_101
                                                         lgort = gc_1000.
              IF sy-subrc = 0.
                wa_out-budat_mkpf = wa_budat-budat.
              ELSE.
                DELETE gt_budat WHERE bwart = gc_601 OR
                                      bwart = gc_261 OR
                                      bwart = gc_999 OR
                                      bwart = gc_998.
                IF NOT gt_budat[] IS INITIAL.
                  SORT gt_budat BY budat DESCENDING.
                  READ TABLE gt_budat INTO wa_budat WITH KEY lgort = gc_1000.
                  IF sy-subrc = 0.
                    wa_out-budat_mkpf = wa_budat-budat.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.
          ELSE.
*           If storage location is other than 1000 then do a sbelow
* Collect all 1000 storage location recs
              REFRESH gt_mseg_1000.
              CLEAR gt_mseg_1000[].
              LOOP AT gt_mseg INTO wa_mseg1 WHERE ( bwart = gc_101 OR
                                                    bwart = gc_261 OR
                                                    bwart = gc_601 OR
                                                    bwart = gc_309 OR
                                                    bwart = gc_701 )
                                            AND matnr = wa_out-matnr
                                            AND werks = wa_out-bwkey
                                            AND lgort = gc_1000.
                APPEND wa_mseg1 TO gt_mseg_1000.
                CLEAR wa_mseg1.
              ENDLOOP.

            IF NOT gt_budat1[] IS INITIAL.
              READ TABLE gt_budat1 INTO wa_budat WITH KEY lgort = wa_out-lgort.
              IF sy-subrc = 0.
                wa_out-budat = wa_budat-budat.
              ENDIF.
            ELSE.
*           If no other movement types found, consider the movement type 101 with storage location 1000 combination.

*           If movement type 101 and storage location 1000 combination not found then consider the movement types
*           261, 601,309, 709 and 1000 storage locations latest movement

***              REFRESH gt_mseg_1000.
***              CLEAR gt_mseg_1000[].
***              LOOP AT gt_mseg INTO wa_mseg1 WHERE ( bwart = gc_101 OR
***                                                    bwart = gc_261 OR
***                                                    bwart = gc_601 OR
***                                                    bwart = gc_309 OR
***                                                    bwart = gc_701 )
***                                            AND matnr = wa_out-matnr
***                                            AND werks = wa_out-bwkey
***                                            AND lgort = gc_1000.
***                APPEND wa_mseg1 TO gt_mseg_1000.
***                CLEAR wa_mseg1.
***              ENDLOOP.

              IF gt_mseg_1000[] IS NOT INITIAL.
                SORT gt_mseg_1000 BY budat DESCENDING.
                READ TABLE gt_mseg_1000 INTO wa_mseg1 INDEX 1.

                READ TABLE gt_mkpf INTO wa_mkpf
                                   WITH KEY mblnr = wa_mseg1-mblnr
                                            mjahr = wa_mseg1-mjahr.
                IF sy-subrc = 0.
                  wa_out-budat = wa_mkpf-budat.
                ENDIF.
              ENDIF.
              endif. "added added
              READ TABLE gt_mseg INTO wa_mseg1
                                 WITH KEY bwart = gc_101
                                          matnr = wa_out-matnr
                                          werks = wa_out-bwkey
                                          lgort = wa_out-lgort.       "gc_1000.
              IF sy-subrc = 0.

                READ TABLE gt_mkpf INTO wa_mkpf
                                   WITH KEY mblnr = wa_mseg1-mblnr
                                            mjahr = wa_mseg1-mjahr.
                IF sy-subrc = 0.
                  wa_out-budat_mkpf = wa_mkpf-budat.
                ENDIF.
              ELSE.
                DELETE gt_mseg_1000 WHERE bwart = gc_261 OR
                                          bwart = gc_601.
                IF gt_mseg_1000[] IS NOT INITIAL.
                  SORT gt_mseg_1000 BY budat DESCENDING.
                  READ TABLE gt_mseg_1000 INTO wa_mseg1 INDEX 1.

                  READ TABLE gt_mkpf INTO wa_mkpf
                                     WITH KEY mblnr = wa_mseg1-mblnr
                                              mjahr = wa_mseg1-mjahr.
                  IF sy-subrc = 0.
                    wa_out-budat_mkpf = wa_mkpf-budat.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.
*          ENDIF.

        refresh:  gt_budat[],
                  gt_budat1[].
        CLEAR wa_budat.

* Assign Distribution Mode and Reordering Point
        READ TABLE gt_marc INTO wa_marc
                           WITH KEY matnr = wa_out-matnr
                                    werks = wa_out-bwkey
                           BINARY SEARCH.
        IF sy-subrc = 0.
          wa_out-minbe = wa_marc-minbe.
          wa_out-dismm = wa_marc-dismm.
          READ TABLE gt_t438t INTO wa_t438t
                              WITH KEY dismm = wa_marc-dismm
                              BINARY SEARCH.
          IF sy-subrc = 0.
             wa_out-dibez = wa_t438t-dibez.
          ENDIF.
        ENDIF.
* Assgin Date of last GR and qty of the last GR
        READ TABLE gt_mseg22 INTO wa_mseg22
                             WITH KEY matnr = wa_out-matnr
                                      werks = wa_out-bwkey
                                      lgort = wa_out-lgort.
        IF sy-subrc = 0.
          wa_out-menge = wa_mseg22-menge.
          READ TABLE gt_mkpf11 INTO wa_mkpf11
                             WITH KEY mblnr = wa_mseg22-mblnr
                                      mjahr = wa_mseg22-mjahr
                             BINARY SEARCH.
*          wa_out-budat_mkpf = wa_mkpf11-budat. "- EXTIBMDCA 27-03-2017
          ELSE.
* Consider the quantity of 1000 storage location if quantity not found for their own storage location.
            READ TABLE gt_mseg22 INTO wa_mseg22
                     WITH KEY matnr = wa_out-matnr
                              werks = wa_out-bwkey
                              lgort = gc_1000.  "wa_out-lgort.
              IF sy-subrc = 0.
                 wa_out-menge = wa_mseg22-menge.
                 READ TABLE gt_mkpf11 INTO wa_mkpf11
                             WITH KEY mblnr = wa_mseg22-mblnr
                                      mjahr = wa_mseg22-mjahr
                             BINARY SEARCH.
              ENDIF.
        ENDIF.
* Assgin the Delivery quantity from LIPS
        READ TABLE gt_lips11 INTO wa_lips11
                            WITH KEY matnr = wa_out-matnr
                                     werks = wa_out-bwkey
                                     lgort = wa_out-lgort
                            BINARY SEARCH.
        IF sy-subrc = 0.
          wa_out-lfimg = wa_lips11-lfimg.
        ELSE.
* Search and consider storage location 1000 quantity if not avaialble for respective storage location
* Begin of comment on 10/Jul-2017
*            READ TABLE gt_lips11 INTO wa_lips11
*                    WITH KEY matnr = wa_out-matnr
*                             werks = wa_out-bwkey
*                             lgort = gc_1000 "wa_out-lgort
*                    BINARY SEARCH.
*            IF sy-subrc = 0.
*              wa_out-lfimg = wa_lips11-lfimg.
*            ENDIF.
* End of comment on 10/Jul-2017
        ENDIF.
* Assign the Referenced quantity
        READ TABLE gt_rqty INTO wa_rqty
                           WITH KEY matnr = wa_out-matnr
                                    werks = wa_out-bwkey
                                    lgort = wa_out-lgort
                                    BINARY SEARCH.
        IF sy-subrc = 0.
          wa_out-rfmng = wa_rqty-rfmng.
        ELSE.
* Search and consider storage location 1000 quantity if not avaialble for respective storage location
* Begin of comment on 10/Jul-2017
*          READ TABLE gt_rqty INTO wa_rqty
*                   WITH KEY matnr = wa_out-matnr
*                            werks = wa_out-bwkey
*                            lgort = gc_1000    "wa_out-lgort
*                            BINARY SEARCH.
*          IF sy-subrc = 0.
*            wa_out-rfmng = wa_rqty-rfmng.
*          ENDIF.
* End of comment on 10/Jul-2017
        ENDIF.
* Calculate sum of pieces sold
        wa_out-sold = wa_out-lfimg - wa_out-rfmng.

        MODIFY gt_out FROM wa_out.
      ENDLOOP. " LOOP AT gt_out INTO wa_out

      DELETE gt_out WHERE SALK3 IS INITIAL AND
                          VMSAL IS  INITIAL.
* End of insertion by MOD-010
    ENDIF. " IF NOT gt_out[] IS INITIAL

* End of insertion by MOD-010.

*-----------------------------------------------------------------------
END-OF-SELECTION.

  IF gt_out[] IS INITIAL.
    SKIP 3.
    WRITE: /15 'No result in this selection'(015).
    STOP.
  ENDIF.

  SORT gt_out BY bwkey matnr.

* create ALV-GRID
  PERFORM build_field_catlog CHANGING gt_fieldcat.
  PERFORM fill_events_f14.
  PERFORM alv_display.
* update file YSE_STOCK_REPORT
  IF p_updf = 'X'.
    PERFORM update_file.
  ENDIF.

*-----------------------------------------------------------------------
TOP-OF-PAGE.

*&---------------------------------------------------------------------*
*&      Form  build_field_catlog
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FIELDCAT  text
*----------------------------------------------------------------------*
FORM build_field_catlog  CHANGING pt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA : ls_fcat TYPE slis_fieldcat_alv.
*---------------------Plant-----------------------*
  ls_fcat-fieldname = 'BWKEY'.
  ls_fcat-seltext_l = 'Plant'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------------Material--------------------*
  ls_fcat-fieldname = 'MATNR'.
  ls_fcat-rollname = 'MATNR'.
  ls_fcat-outputlen = '18'.
  ls_fcat-no_convext = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*------------------Material description-----------*
  ls_fcat-fieldname = 'MAKTX'.
  ls_fcat-seltext_l = 'Material description'.
* begin of change MOD-004
*  ls_fcat-outputlen = '35'.
  ls_fcat-outputlen = '40'.
* end of changde MOD-004
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* begin of insert MOD-006
*------------------Profit Center------------------*
  ls_fcat-fieldname = 'SEGMENT'.
  ls_fcat-seltext_l = 'Segment'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* end of insert MOD-006
*------------------Profit Center------------------*
  ls_fcat-fieldname = 'ZPRCTR'.
  ls_fcat-seltext_l = 'Prof. Cntr'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------GAC--------------------*
  ls_fcat-fieldname = 'ZGAC'.
  ls_fcat-seltext_l = 'GAC'.
  ls_fcat-outputlen = '4'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------PGC--------------------*
  ls_fcat-fieldname = 'ZPGC'.
  ls_fcat-seltext_l = 'PGC'.
  ls_fcat-outputlen = '4'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------total stock current period-------------*
* Begin of Insertion MOD-009 -prakash Cr3274
*  ls_fcat-fieldname = 'LBKUM'.
*  ls_fcat-seltext_l = 'Stock curr.period'.
*  ls_fcat-outputlen = '17'.
*  APPEND ls_fcat TO pt_fieldcat.
*  CLEAR ls_fcat.
*  End of Insertion MOD-009 prakash - CR3274CD1K985063
*---------------value stock current period-------------*
  ls_fcat-fieldname = 'SALK3'.
  ls_fcat-seltext_l = 'Value curr.period'.
  ls_fcat-outputlen = '17'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------total stock prev period-------------*
* Begin of deletion on 27-03-2017 by EXTIBMDCA
*  ls_fcat-fieldname = 'VMKUM'.
*  ls_fcat-seltext_l = 'SLoc Qty Prev.per'."'Stock prev.period'. - MOD 09 PRAKASH
*  ls_fcat-outputlen = '17'.
*  APPEND ls_fcat TO pt_fieldcat.
*  CLEAR ls_fcat.
* End of deletion on 27-03-2017 by EXTIBMDCA
*---------------value stock prev period-------------*
  ls_fcat-fieldname = 'VMSAL'.
  ls_fcat-seltext_l = 'Value prev.period'.
  ls_fcat-outputlen = '17'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------standard price-------------*
  ls_fcat-fieldname = 'STPRS'.
  ls_fcat-seltext_l = 'Standard Price'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------Tax price 1 -------------*
  ls_fcat-fieldname = 'BWPRS'.
  ls_fcat-seltext_l = 'Tax Price 1'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------Future Price -------------*
  ls_fcat-fieldname = 'ZKPRS'.
  ls_fcat-seltext_l = 'Future Price'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*---------------Devaluation indicator-------------*
  ls_fcat-fieldname = 'ABWKZ'.
  ls_fcat-seltext_l = 'Dev.Ind'.
  ls_fcat-outputlen = '07'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* Begin of Deletion by MOD-010
*--------------- year-------------*
*  ls_fcat-fieldname = 'LFGJA'.
*  ls_fcat-seltext_l = 'Last Yr.Mvt'.
*  ls_fcat-outputlen = '11'.
*  APPEND ls_fcat TO pt_fieldcat.
*  CLEAR ls_fcat.
*--------------- period------------*
*  ls_fcat-fieldname = 'LFMON'.
*  ls_fcat-seltext_l = 'Last Per.Mvt'.
*  ls_fcat-outputlen = '12'.
*  APPEND ls_fcat TO pt_fieldcat.
*  CLEAR ls_fcat.
* End of End of deletion by MOD-010

* Begin of insertion by MOD-010

  ls_fcat-fieldname = 'DISMM'.
  ls_fcat-seltext_l = 'Distribution Mode'.
  ls_fcat-outputlen = '17'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

 ls_fcat-fieldname = 'MINBE'.
 ls_fcat-seltext_l = 'Reorder Point'.
 ls_fcat-outputlen = '13'.
 APPEND ls_fcat TO pt_fieldcat.
 CLEAR ls_fcat.

 ls_fcat-fieldname = 'BUDAT_MKPF'.
 ls_fcat-seltext_l = 'Date of Last GR'.
 ls_fcat-outputlen = '10'.
 APPEND ls_fcat TO pt_fieldcat.
 CLEAR ls_fcat.

ls_fcat-fieldname = 'MENGE'.
ls_fcat-seltext_l = 'Qty of the last GR'.
ls_fcat-outputlen = '10'.
APPEND ls_fcat TO pt_fieldcat.
CLEAR ls_fcat.

ls_fcat-fieldname = 'SOLD'.
ls_fcat-seltext_l = 'Sum of pieces sold'.
ls_fcat-outputlen = '10'.
APPEND ls_fcat TO pt_fieldcat.
CLEAR ls_fcat.

ls_fcat-fieldname = 'ERSDA'.
ls_fcat-seltext_l = 'Created On'.
ls_fcat-outputlen = '10'.
APPEND ls_fcat TO pt_fieldcat.
CLEAR ls_fcat.
* End of insertion by MOD-010
*----------Valuation Class-----------*
  ls_fcat-fieldname = 'BKLAS'.
  ls_fcat-seltext_l = 'Val.Cl'.
  ls_fcat-outputlen = '06'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* begin of insertion MOD-007
  IF g_flg_cn IS NOT INITIAL.
*  ----------Vendor number  -----------*
    ls_fcat-fieldname = 'LIFNR'.
    ls_fcat-seltext_l = 'Vendor Number'.
    ls_fcat-outputlen = '10'.
    APPEND ls_fcat TO pt_fieldcat.
    CLEAR ls_fcat.
*  --Vendor account assignment group--*
    ls_fcat-fieldname = 'KTOKK'.
    ls_fcat-seltext_l = 'Vendor Account Group'.
    ls_fcat-outputlen = '4'.
    APPEND ls_fcat TO pt_fieldcat.
    CLEAR ls_fcat.
  ENDIF.
* end of insertion MOD-007
*  Begin of Insertion MOD-008..
*  ----------Storage Location  -----------*
  ls_fcat-fieldname = 'LGORT'.
  ls_fcat-seltext_l = 'Storage Location'.
  ls_fcat-outputlen = '4'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*  Begin of Insertion MOD-009 -prakash CR3274
*  --Storage Location Valuation qty--*
  ls_fcat-fieldname = 'MBWBEST'.
  ls_fcat-seltext_l =  'SLoc Qty Curr.per'.  "'SLoc Valuation Qty'.  - MOD09  PRAKASH
  ls_fcat-outputlen = '17'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*  End of Insertion MOD-009 -prakash CR3274

* Begin of insertion by MOD-010
  ls_fcat-fieldname = 'OBSOLETE'.
  ls_fcat-seltext_l =  'Obsolete?'(002).  "'SLoc Valuation Qty'.  - MOD09  PRAKASH
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-seltext_l =  'Date of last movement'(005).  "'SLoc Valuation Qty'.  - MOD09  PRAKASH
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

  ls_fcat-fieldname = 'PLC'.
  ls_fcat-seltext_l =  'PLC'.
  ls_fcat-outputlen = '03'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

* End of insertion by MOD-010
ENDFORM.                    " build_field_catlog

*&---------------------------------------------------------------------*
*&      Form  fill_events_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_events_f14 .

  DATA h_event       TYPE slis_alv_event.

  CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
    EXPORTING
      i_list_type = 0
    IMPORTING
      et_events   = g_events_tab.

*--- allocate form for user-command ---------------------------------*
  READ TABLE g_events_tab WITH KEY name = slis_ev_user_command
                        INTO h_event.
  IF sy-subrc = 0.
    MOVE g_form_user_command TO h_event-form.
    MODIFY g_events_tab FROM h_event INDEX sy-tabix.
  ENDIF.

ENDFORM.                    " fill_events_f14

*&--------------------------------------------------------------------*
*&      Form  user_command_l
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*---------------------------------------------------------------------*
FORM user_command_l USING p_ucomm LIKE sy-ucomm
                          p_selfield TYPE slis_selfield.

  p_selfield-refresh = c_s.
  PERFORM check_pf2_with_object_f16 USING p_ucomm.
  PERFORM set_p_selfield_general_f16 USING p_selfield.

  CASE p_ucomm.
    WHEN 'ISEL'.
      p_ucomm = 'DISP'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
  ENDCASE.

ENDFORM.                    "user_command_l

*&---------------------------------------------------------------------*
*&      Form  check_pf2_with_object_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*----------------------------------------------------------------------*
FORM check_pf2_with_object_f16  USING    p_ucomm.

  CHECK p_ucomm = g_ic1.
  p_ucomm = 'ISEL'.

ENDFORM.                    " check_pf2_with_object_f16

*&---------------------------------------------------------------------*
*&      Form  set_p_selfield_general_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
FORM set_p_selfield_general_f16  USING f_selfield TYPE slis_selfield.

  f_selfield-col_stable = c_x.
  f_selfield-row_stable = c_x.

ENDFORM.                    " set_p_selfield_general_f16

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*      -->P_ENDCASE  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_f16  USING p_ucomm LIKE sy-ucomm
                                p_selfield TYPE slis_selfield.

  PERFORM check_object_tab_marked_f14 USING p_ucomm p_selfield.

  LOOP AT gt_out WHERE selected = c_x .
    l_index = sy-tabix.
    PERFORM fcodes_with_mark_l USING p_ucomm p_selfield.
    gt_out-selected = ' '.
    MODIFY gt_out INDEX l_index.
  ENDLOOP.

  CLEAR p_ucomm.

ENDFORM.                    " fcodes_with_mark_f16

*&---------------------------------------------------------------------*
*&      Form  check_object_tab_marked_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
FORM check_object_tab_marked_f14  USING    p_ucomm LIKE sy-ucomm
                                        p_selfield TYPE slis_selfield.

  READ TABLE gt_out WITH KEY selected = c_x.

  IF NOT sy-subrc IS INITIAL.
    IF NOT p_selfield-tabindex IS INITIAL.
      READ TABLE gt_out  INDEX p_selfield-tabindex.
      gt_out-selected = c_x.
      MODIFY gt_out  INDEX p_selfield-tabindex.
    ENDIF.
  ELSE.
*--- Checkbox markiert -----------------------------------------------*
    p_selfield-sel_tab_field = 'G_MARK'.
  ENDIF.

ENDFORM.                    " check_object_tab_marked_f14

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_F_UCOMM  text
*      -->P_F_SELFIELD  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_l  USING   p_ucomm LIKE sy-ucomm
                              p_selfield TYPE slis_selfield.

  DATA: h_ucomm LIKE sy-ucomm.

  CASE p_ucomm.
*   Display material number
    WHEN 'DISP'.
      SET PARAMETER ID 'MAT' FIELD  gt_out-matnr.
      CALL TRANSACTION 'MM03' AND SKIP FIRST SCREEN.
  ENDCASE.

ENDFORM.                    " fcodes_with_mark_l

*&---------------------------------------------------------------------*
*&      Form  alv_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM alv_display .

  g_repid = sy-repid.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
     EXPORTING
       i_callback_program                =  g_repid
       i_save                            = 'A'
       it_events                         =  g_events_tab[]
*      I_GRID_TITLE                      =
*      I_GRID_SETTINGS                   =
*      is_layout                         =  g_layout
       it_fieldcat                       =  gt_fieldcat[]
     TABLES
        t_outtab                         =  gt_out.

ENDFORM.                    " alv_display
*&---------------------------------------------------------------------*
*&      Form  update_file
*&---------------------------------------------------------------------*
*       update file YSE_STOCK_REP
*----------------------------------------------------------------------*
FORM update_file .

* delete existing records for the selected valuation keys
  DELETE FROM yse_stock_report CLIENT SPECIFIED
      WHERE mandt EQ sy-mandt
        AND bwkey IN s_bwkey.
  COMMIT WORK AND WAIT.
* insert records
  IF NOT gt_out[] IS INITIAL.
    LOOP AT gt_out.
      wa_stock_report-mandt = sy-mandt.
      MOVE-CORRESPONDING gt_out TO wa_stock_report.
      INSERT yse_stock_report FROM wa_stock_report.
    ENDLOOP.
    COMMIT WORK AND WAIT.
    MESSAGE i001(00) WITH text-i01.

  ENDIF.


ENDFORM.                    "updat
* begin of insertion MOD-007
*&---------------------------------------------------------------------*
*&      Form  CHECK_WERKS_CN
*&---------------------------------------------------------------------*
*       Check if the plant belong to china(including HK)
*----------------------------------------------------------------------*
FORM check_werks_cn .
  DATA: lt_t001w TYPE STANDARD TABLE OF t001w,
        ls_t001w TYPE t001w.
  SELECT *
    FROM t001w
    INTO TABLE lt_t001w
    WHERE werks IN s_bwkey.
  LOOP AT lt_t001w INTO ls_t001w.
    IF    ls_t001w-werks(2) = 'CN'
      OR  ls_t001w-werks(2) = 'HK'.
      g_flg_cn = 'X'.
      EXIT.
    ENDIF.
  ENDLOOP.
ENDFORM.                    " CHECK_WERKS_CN

* end of insertion MOD-007
*Text symbol text
*001:created
*002:Obsolete?
*005:Date of last movement
*015:No result in this selection
*B01:Selection
*B02:DTC Stock
*B03:Update file
*E01:Fill in plants for DTC
*E02:Select only 1 option for DTC-stock
*E03:Fill in plants please
*E04:Not authorised for plant:

*I01:File YSE_STOCK_REPORT updated.
*Selection text
*P_DTC:        Include DTC-Stock
*P_DTCONL:        DTC-Stock only
*P_UPDF:        Update file YSE_STOCK_REPORT
*S_BKLAS:        Valuation Class
*S_BWKEY:        Plant
*S_DTC:        DTC Plants
*S_MATNR:        Material Number
*S_MTART:        Material Type
