*&---------------------------------------------------------------------*
*& Report  YSE_ACT_CONTRACT_ITEM_EXTR
*&
*&---------------------------------------------------------------------*
*&                                                                     *
*& ACT! : Contract Item Data extraction                                *
*&                                                                     *
*&---------------------------------------------------------------------*
*  Author                : Jules Smets
*  Date                  : 10.10.2012
*  Change Request Number :
*  Transport request Nr. : CD1K973505
*----------------------------------------------------------------------*
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NR.|   DATE     | NAME            | CORRECTION NR.| CHANGE REF. *
*----------------------------------------------------------------------*
* MOD-001 | 28.03.2017 |                 | CD1K991227   |              *
*----------------------------------------------------------------------*

************************************************************************

REPORT  yse_act_contract_item_extr.

TABLES: vbak,
        vbap,
        veda,
        vbup,
        vbkd,
        fpla,
        viser02.

* Types
TYPES: BEGIN OF ty_vbap,
         vbeln      TYPE vbeln_va,
         posnr      TYPE posnr_va,
         matnr      TYPE matnr,
         zmeng      TYPE dzmeng,
         zieme      TYPE dzieme,
         arktx      TYPE arktx,
         pstyv      TYPE pstyv,
         vkaus      TYPE abrvw,
         abgru      TYPE abgru,
         pmatn      TYPE pmatn,
         prodh      TYPE prodh_d,
         matkl      TYPE matkl,
         spart      TYPE spart,
         kondm      TYPE kondm,
         werks      TYPE werks_d,
         vstel      TYPE vstel,
         route      TYPE route,
         mfrgr      TYPE mfrgr,
         lprio      TYPE lprio,
         lgort      TYPE lgort_d,
         kztlf      TYPE kztlf,
         antlf      TYPE antlf,
         uebto      TYPE uebto,
         untto      TYPE untto,
         faksp      TYPE faksp_ap,
         taxm1      TYPE taxm1,
         prctr      TYPE prctr,
         abgrs      TYPE abgr_schl,
         kalsm_k    TYPE aufkalsm,
         posex      TYPE posex,
         kdmat      TYPE kdmat,
         zzbbs      TYPE zzbbs,
         zzbbt      TYPE zzbbt,
         zzipm      TYPE zzipm,
         zzipl      TYPE zzipl,
         zlsch_k    TYPE aufzschl,
         vkuegru    TYPE vkgru_veda,
         veindat    TYPE vedat_veda,
* Begin of insert MOD-001
         netwr      TYPE netwr_ap,
         wtgbtr     TYPE wtgxxx,
         objnr      TYPE objpo,
         waerk      TYPE waerk,
* End of insert MOD-001
      END OF ty_vbap.

TYPES: BEGIN OF ty_vbkd,
         vbeln      TYPE vbeln_va,
         posnr      TYPE posnr_va,
         delco      TYPE delco,
         prsdt      TYPE prsdt,
         kdgrp      TYPE kdgrp,
         pltyp      TYPE pltyp,
         konda      TYPE konda,
         bzirk      TYPE bzirk,
         faktf      TYPE faktf,
         ffprf      TYPE ad01profnr,
         abtnr      TYPE abtnr,
         traty      TYPE traty,
         trmtyp     TYPE trmtyp,
         empst      TYPE empst,
         vsart      TYPE vsarttr,
         sdabw      TYPE sdabw,
         inco1      TYPE inco1,
         inco2      TYPE inco2,
         zterm      TYPE dzterm,
         valdt      TYPE valdt,
         valtg      TYPE valtg,
         perfk      TYPE perfk,
         fbuda      TYPE fbuda,
         kurrf      TYPE kurrf,
         mschl      TYPE mschl,
         mansp      TYPE mansp,
         abssc      TYPE abssche_cm,
         lcnum      TYPE lcnum,
         akprz      TYPE akprz,
         bstkd      TYPE bstkd,
         bstdk      TYPE bstdk,
         bsark      TYPE bsark,
         ihrez      TYPE ihrez,
         bstkd_e    TYPE bstkd_e,
         bstdk_e    TYPE bstdk_e,
         bsark_e    TYPE bsark_e,
         posex_e    TYPE posex_e,
         ihrez_e    TYPE ihrez_e,
         fplnr      TYPE fplnr,
       END OF ty_vbkd.

TYPES: BEGIN OF ty_veda,
         vbeln      TYPE vbeln_va,
         vposn      TYPE posnr_va,
         vbegdat    TYPE vbdat_veda,
         venddat    TYPE vndat_veda,
         vlaufk     TYPE vlauk_veda,
         vlaufz     TYPE vlauf_veda,
         vinsdat    TYPE vidat_veda,
         vabndat    TYPE vadat_veda,
         vuntdat    TYPE vudat_veda,
         vdemdat    TYPE vddat_veda,
         vkuesch    TYPE vkues_veda,
         vkuegru    TYPE vkgru_veda,
         veindat    TYPE vedat_veda,
         vwundat    TYPE vwdat_veda,
         vbelkue    TYPE vbelk_veda,
         vkuepar    TYPE vkpar_veda,
         vbedkue    TYPE vbedk_veda,
      END OF ty_veda.

TYPES: BEGIN OF ty_vbpa,
         vbeln      TYPE vbeln_va,
         posnr      TYPE posnr_va,
         parvw      TYPE parvw,
         kunnr      TYPE kunnr,
         ablad      TYPE ablad,
      END OF ty_vbpa.

TYPES: BEGIN OF ty_fpla,
         fplnr      TYPE fplnr,
         perio      TYPE perio_fp,
         autte      TYPE autte,
         peraf      TYPE peraf_fp,
         bedat      TYPE bedat_fp,
         bedar      TYPE bedat_fpk,
         endat      TYPE endat_fp,
         endar      TYPE endat_fpk,
         lodat      TYPE tadat,
         tndat      TYPE tbdat,
      END OF ty_fpla.

TYPES: BEGIN OF ty_vbup,
         vbeln      TYPE vbeln_va,
         posnr      TYPE posnr_va,
         gbsta      TYPE gbsta,
         fksaa      TYPE fksaa,
      END OF ty_vbup.

TYPES: BEGIN OF ty_viser,
         vbeln      TYPE vbeln_va,
         posnr      TYPE posnr_va,
         obknr      TYPE objknr,
         obzae      TYPE objza,
         sernr      TYPE gernr,
         equnr      TYPE equnr,
         matnr_eq   TYPE matnr,
         bismt      TYPE bismt,
      END OF ty_viser.

* Begin of insert MOD-001
TYPES: BEGIN OF ty_coep,
         objnr     TYPE j_objnr,
         twaer     TYPE twaer,
         wtgbtr    TYPE wtgxxx,
         belnr     TYPE co_belnr,
         buzei     TYPE co_buzei,
       END OF ty_coep.

* Begin of insert MOd-001
TYPES: BEGIN OF ty_curr,
         kurst     TYPE kurst,
         fcurr     TYPE fcurr,
         tcurr     TYPE tcurr_curr,
         gdatu     TYPE gdatu_inv,
         ukurs     TYPE ukurs_curr,
       END OF ty_curr.
* End of insert MOD-001

DATA: gv_act_cost_so  TYPE wtgxxx,
      gv_act_cost_lc  TYPE wogxxx,
      gv_waers_cc     TYPE waers.

DATA: gv_gdatu        TYPE gdatu_inv.
* End of insert MOD-001
* Internal tables
DATA: gt_vbap  TYPE STANDARD TABLE OF ty_vbap
                    WITH HEADER LINE.

DATA: gt_vbkd TYPE  HASHED TABLE OF ty_vbkd
                    WITH UNIQUE KEY vbeln posnr
                    WITH HEADER LINE.

* Begin of insert MOD-001
DATA: gt_curr    TYPE HASHED TABLE OF ty_curr
                      WITH UNIQUE KEY kurst fcurr tcurr
                      WITH HEADER LINE,
      gt_curri   TYPE TABLE OF ty_curr
                      WITH HEADER LINE.

DATA: gv_kurst        TYPE kurst.
* End of insert MOD-001


DATA: gt_veda TYPE  HASHED TABLE OF ty_veda
                    WITH UNIQUE KEY vbeln vposn
                    WITH HEADER LINE,
      gt_vedai TYPE TABLE OF ty_veda
                    WITH HEADER LINE.

DATA: gt_vbpa TYPE  HASHED TABLE OF ty_vbpa
                    WITH UNIQUE KEY vbeln posnr parvw
                    WITH HEADER LINE.

DATA: gt_fpla TYPE  HASHED TABLE OF ty_fpla
                    WITH UNIQUE KEY fplnr
                    WITH HEADER LINE.

DATA: gt_vbup  TYPE HASHED TABLE OF ty_vbup
                    WITH UNIQUE KEY vbeln posnr
                    WITH HEADER LINE.

DATA: gt_viser TYPE HASHED TABLE OF ty_viser
                    WITH UNIQUE KEY vbeln posnr
                    WITH HEADER LINE,
      gt_viseri TYPE TABLE OF ty_viser
                     WITH HEADER LINE.

* Begin of insert MOD-001
DATA: gt_coep    TYPE SORTED TABLE OF ty_coep
                      WITH NON-UNIQUE KEY objnr
                      WITH HEADER LINE.
* End of insert MOD-001

DATA: BEGIN OF gt_out  OCCURS 0,
        vbeln       TYPE vbeln_va,
        tab01(1)    TYPE c,
        posnr       TYPE posnr_va,
        tab02(1)    TYPE c,
        matnr       TYPE matnr,
        tab03(1)    TYPE c,
        zmeng       TYPE char17,
        tab04(1)    TYPE c,
        zieme       TYPE dzieme,
        tab05(1)    TYPE c,
        arktx       TYPE arktx,
        tab06(1)    TYPE c,
        pstyv       TYPE pstyv,
        tab07(1)    TYPE c,
        delco       TYPE delco,
        tab08(1)    TYPE c,
        prsdt       TYPE prsdt,
        tab09(1)    TYPE c,
        vkaus       TYPE abrvw,
        tab10(1)    TYPE c,
        abgru       TYPE abgru,
        tab11(1)    TYPE c,
        pmatn       TYPE pmatn,
        tab12(1)    TYPE c,
        prodh       TYPE prodh_d,
        tab13(1)    TYPE c,
        matkl       TYPE matkl,
        tab14(1)    TYPE c,
        spart       TYPE spart,
        tab15(1)    TYPE c,
        kdgrp       TYPE kdgrp,
        tab16(1)    TYPE c,
        pltyp       TYPE pltyp,
        tab17(1)    TYPE c,
        kondm       TYPE kondm,
        tab18(1)    TYPE c,
        konda       TYPE konda,
        tab19(1)    TYPE c,
        bzirk       TYPE bzirk,
        tab20(1)    TYPE c,
        faktf       TYPE faktf,
        tab21(1)    TYPE c,
        ffprf       TYPE ad01profnr,
        tab22(1)    TYPE c,
        vbegdat     TYPE vbdat_veda,
        tab23(1)    TYPE c,
        venddat     TYPE vndat_veda,
        tab24(1)    TYPE c,
        vlaufk      TYPE vlauk_veda,
        tab25(1)    TYPE c,
        vlaufz      TYPE vlauf_veda,
        tab26(1)    TYPE c,
        vinsdat     TYPE vidat_veda,
        tab27(1)    TYPE c,
        vabndat     TYPE vadat_veda,
        tab28(1)    TYPE c,
        vuntdat     TYPE vudat_veda,
        tab29(1)    TYPE c,
        vdemdat     TYPE vddat_veda,
        tab30(1)    TYPE c,
        vkuesch     TYPE vkues_veda,
        tab31(1)    TYPE c,
        vkuegru     TYPE vkgru_veda,
        tab32(1)    TYPE c,
        veindat     TYPE vedat_veda,
        tab33(1)    TYPE c,
        vwundat     TYPE vwdat_veda,
        tab34(1)    TYPE c,
        vbelkue     TYPE vbelk_veda,
        tab35(1)    TYPE c,
        vkuepar     TYPE vkpar_veda,
        tab36(1)    TYPE c,
        vbedkue     TYPE vbedk_veda,
        tab37(1)    TYPE c,
        abtnr       TYPE abtnr,
        tab38(1)    TYPE c,
        werks       TYPE werks_d,
        tab39(1)    TYPE c,
        vstel       TYPE vstel,
        tab40(1)    TYPE c,
        route       TYPE route,
        tab41(1)    TYPE c,
        mfrgr       TYPE mfrgr,
        tab42(1)    TYPE c,
        traty       TYPE traty,
        tab43(1)    TYPE c,
        trmtyp      TYPE trmtyp,
        tab44(1)    TYPE c,
        empst       TYPE empst,
        tab45(1)    TYPE c,
        lprio       TYPE lprio,
        tab46(1)    TYPE c,
        lgort       TYPE lgort_d,
        tab47(1)    TYPE c,
        kztlf       TYPE kztlf,
        tab48(1)    TYPE c,
        antlf       TYPE char1,
        tab49(1)    TYPE c,
        vsart       TYPE vsarttr,
        tab50(1)    TYPE c,
        sdabw       TYPE sdabw,
        tab51(1)    TYPE c,
        uebto       TYPE char4,
        tab52(1)    TYPE c,
        untto       TYPE char4,
        tab53(1)    TYPE c,
        inco1       TYPE inco1,
        tab54(1)    TYPE c,
        inco2       TYPE inco2,
        tab55(1)    TYPE c,
        zterm       TYPE dzterm,
        tab56(1)    TYPE c,
        valdt       TYPE valdt,
        tab57(1)    TYPE c,
        valtg       TYPE valtg,
        tab58(1)    TYPE c,
        faksp       TYPE faksp,
        tab59(1)    TYPE c,
        perfk       TYPE perfk,
        tab60(1)    TYPE c,
        fbuda       TYPE fbuda,
        tab61(1)    TYPE c,
        taxm1       TYPE taxm1,
        tab62(1)    TYPE c,
        kurrf       TYPE char12,
        tab63(1)    TYPE c,
        mschl       TYPE mschl,
        tab64(1)    TYPE c,
        mansp       TYPE mansp,
        tab65(1)    TYPE c,
        abssc       TYPE abssche_cm,
        tab66(1)    TYPE c,
        lcnum       TYPE lcnum,
        tab67(1)    TYPE c,
        akprz       TYPE char6,
        tab68(1)    TYPE c,
        prctr       TYPE prctr,
        tab69(1)    TYPE c,
        abgrs       TYPE abgr_schl,
        tab70(1)    TYPE c,
        kalsm_k     TYPE aufkalsm,
        tab71(1)    TYPE c,
        zlsch_k     TYPE aufzschl,
        tab72(1)    TYPE c,
        bstkd       TYPE bstkd,
        tab73(1)    TYPE c,
        bstdk       TYPE bstdk,
        tab74(1)    TYPE c,
        bsark       TYPE bsark,
        tab75(1)    TYPE c,
        posex       TYPE posex,
        tab76(1)    TYPE c,
        ihrez       TYPE ihrez,
        tab77(1)    TYPE c,
        kdmat       TYPE kdmat,
        tab78(1)    TYPE c,
        bstkd_e     TYPE bstkd_e,
        tab79(1)    TYPE c,
        bstdk_e     TYPE bstdk_e,
        tab80(1)    TYPE c,
        bsark_e     TYPE bsark_e,
        tab81(1)    TYPE c,
        posex_e     TYPE posex_e,
        tab82(1)    TYPE c,
        ihrez_e     TYPE ihrez_e,
        tab83(1)    TYPE c,
        zzbbs       TYPE zzbbs,
        tab84(1)    TYPE c,
        zzbbt       TYPE char10,
        tab85(1)    TYPE c,
        zzipm       TYPE char6,
        tab86(1)    TYPE c,
        zzipl       TYPE char6,
        tab87(1)    TYPE c,
        sernr       TYPE gernr,
        tab88(1)    TYPE c,
        equnr       TYPE equnr,
        tab89(1)    TYPE c,
        matnr_eq    TYPE matnr,
        tab90(1)    TYPE c,
        ablad       TYPE ablad,
        tab91(1)    TYPE c,
        perio       TYPE perio_fp,
        tab92(1)    TYPE c,
        autte       TYPE autte,
        tab93(1)    TYPE c,
        peraf       TYPE peraf_fp,
        tab94(1)    TYPE c,
        bedat       TYPE bedat_fp,
        tab95(1)    TYPE c,
        bedar       TYPE bedat_fpk,
        tab96(1)    TYPE c,
        endat       TYPE endat_fp,
        tab97(1)    TYPE c,
        endar       TYPE endat_fpk,
        tab98(1)    TYPE c,
        lodat       TYPE tadat,
        tab99(1)    TYPE c,
        tndat       TYPE tbdat,
        tab100(1)   TYPE c,
        gbsta       TYPE gbsta,
        tab101(1)   TYPE c,
        fksaa       TYPE fksaa,
        tab102(1)   TYPE c,
        bismt       TYPE mara-bismt,
        tab103(1)   TYPE c,
* Begin of insert MOD-001
        netwr(21)   TYPE c,
        tab104(1)   TYPE c,
        wtgbtr(21)  TYPE c,
        tab105(1)   TYPE c,
* End of insert MOD-001
      END OF gt_out.

DATA: BEGIN OF gt_outh  OCCURS 0,
        vbeln       TYPE fieldname,
        tab01(1)    TYPE c,
        posnr       TYPE fieldname,
        tab02(1)    TYPE c,
        matnr       TYPE fieldname,
        tab03(1)    TYPE c,
        zmeng       TYPE fieldname,
        tab04(1)    TYPE c,
        zieme       TYPE fieldname,
        tab05(1)    TYPE c,
        arktx       TYPE fieldname,
        tab06(1)    TYPE c,
        pstyv       TYPE fieldname,
        tab07(1)    TYPE c,
        delco       TYPE fieldname,
        tab08(1)    TYPE c,
        prsdt       TYPE fieldname,
        tab09(1)    TYPE c,
        vkaus       TYPE fieldname,
        tab10(1)    TYPE c,
        abgru       TYPE fieldname,
        tab11(1)    TYPE c,
        pmatn       TYPE fieldname,
        tab12(1)    TYPE c,
        prodh       TYPE fieldname,
        tab13(1)    TYPE c,
        matkl       TYPE fieldname,
        tab14(1)    TYPE c,
        spart       TYPE fieldname,
        tab15(1)    TYPE c,
        kdgrp       TYPE fieldname,
        tab16(1)    TYPE c,
        pltyp       TYPE fieldname,
        tab17(1)    TYPE c,
        kondm       TYPE fieldname,
        tab18(1)    TYPE c,
        konda       TYPE fieldname,
        tab19(1)    TYPE c,
        bzirk       TYPE fieldname,
        tab20(1)    TYPE c,
        faktf       TYPE fieldname,
        tab21(1)    TYPE c,
        ffprf       TYPE fieldname,
        tab22(1)    TYPE c,
        vbegdat     TYPE fieldname,
        tab23(1)    TYPE c,
        venddat     TYPE fieldname,
        tab24(1)    TYPE c,
        vlaufk      TYPE fieldname,
        tab25(1)    TYPE c,
        vlaufz      TYPE fieldname,
        tab26(1)    TYPE c,
        vinsdat     TYPE fieldname,
        tab27(1)    TYPE c,
        vabndat     TYPE fieldname,
        tab28(1)    TYPE c,
        vuntdat     TYPE fieldname,
        tab29(1)    TYPE c,
        vdemdat     TYPE fieldname,
        tab30(1)    TYPE c,
        vkuesch     TYPE fieldname,
        tab31(1)    TYPE c,
        vkuegru     TYPE fieldname,
        tab32(1)    TYPE c,
        veindat     TYPE fieldname,
        tab33(1)    TYPE c,
        vwundat     TYPE fieldname,
        tab34(1)    TYPE c,
        vbelkue     TYPE fieldname,
        tab35(1)    TYPE c,
        vkuepar     TYPE fieldname,
        tab36(1)    TYPE c,
        vbedkue     TYPE fieldname,
        tab37(1)    TYPE c,
        abtnr       TYPE fieldname,
        tab38(1)    TYPE c,
        werks       TYPE fieldname,
        tab39(1)    TYPE c,
        vstel       TYPE fieldname,
        tab40(1)    TYPE c,
        route       TYPE fieldname,
        tab41(1)    TYPE c,
        mfrgr       TYPE fieldname,
        tab42(1)    TYPE c,
        traty       TYPE fieldname,
        tab43(1)    TYPE c,
        trmtyp      TYPE fieldname,
        tab44(1)    TYPE c,
        empst       TYPE fieldname,
        tab45(1)    TYPE c,
        lprio       TYPE fieldname,
        tab46(1)    TYPE c,
        lgort       TYPE fieldname,
        tab47(1)    TYPE c,
        kztlf       TYPE fieldname,
        tab48(1)    TYPE c,
        antlf       TYPE fieldname,
        tab49(1)    TYPE c,
        vsart       TYPE fieldname,
        tab50(1)    TYPE c,
        sdabw       TYPE fieldname,
        tab51(1)    TYPE c,
        uebto       TYPE fieldname,
        tab52(1)    TYPE c,
        untto       TYPE fieldname,
        tab53(1)    TYPE c,
        inco1       TYPE fieldname,
        tab54(1)    TYPE c,
        inco2       TYPE fieldname,
        tab55(1)    TYPE c,
        zterm       TYPE fieldname,
        tab56(1)    TYPE c,
        valdt       TYPE fieldname,
        tab57(1)    TYPE c,
        valtg       TYPE fieldname,
        tab58(1)    TYPE c,
        faksp       TYPE fieldname,
        tab59(1)    TYPE c,
        perfk       TYPE fieldname,
        tab60(1)    TYPE c,
        fbuda       TYPE fieldname,
        tab61(1)    TYPE c,
        taxm1       TYPE fieldname,
        tab62(1)    TYPE c,
        kurrf       TYPE fieldname,
        tab63(1)    TYPE c,
        mschl       TYPE fieldname,
        tab64(1)    TYPE c,
        mansp       TYPE fieldname,
        tab65(1)    TYPE c,
        abssc       TYPE fieldname,
        tab66(1)    TYPE c,
        lcnum       TYPE fieldname,
        tab67(1)    TYPE c,
        akprz       TYPE fieldname,
        tab68(1)    TYPE c,
        prctr       TYPE fieldname,
        tab69(1)    TYPE c,
        abgrs       TYPE fieldname,
        tab70(1)    TYPE c,
        kalsm_k     TYPE fieldname,
        tab71(1)    TYPE c,
        zlsch_k     TYPE fieldname,
        tab72(1)    TYPE c,
        bstkd       TYPE fieldname,
        tab73(1)    TYPE c,
        bstdk       TYPE fieldname,
        tab74(1)    TYPE c,
        bsark       TYPE fieldname,
        tab75(1)    TYPE c,
        posex       TYPE fieldname,
        tab76(1)    TYPE c,
        ihrez       TYPE fieldname,
        tab77(1)    TYPE c,
        kdmat       TYPE fieldname,
        tab78(1)    TYPE c,
        bstkd_e     TYPE fieldname,
        tab79(1)    TYPE c,
        bstdk_e     TYPE fieldname,
        tab80(1)    TYPE c,
        bsark_e     TYPE fieldname,
        tab81(1)    TYPE c,
        posex_e     TYPE fieldname,
        tab82(1)    TYPE c,
        ihrez_e     TYPE fieldname,
        tab83(1)    TYPE c,
        zzbbs       TYPE fieldname,
        tab84(1)    TYPE c,
        zzbbt       TYPE fieldname,
        tab85(1)    TYPE c,
        zzipm       TYPE fieldname,
        tab86(1)    TYPE c,
        zzipl       TYPE fieldname,
        tab87(1)    TYPE c,
        sernr       TYPE fieldname,
        tab88(1)    TYPE c,
        equnr       TYPE fieldname,
        tab89(1)    TYPE c,
        matnr_eq    TYPE fieldname,
        tab90(1)    TYPE c,
        ablad       TYPE fieldname,
        tab91(1)    TYPE c,
        perio       TYPE fieldname,
        tab92(1)    TYPE c,
        autte       TYPE fieldname,
        tab93(1)    TYPE c,
        peraf       TYPE fieldname,
        tab94(1)    TYPE c,
        bedat       TYPE fieldname,
        tab95(1)    TYPE c,
        bedar       TYPE fieldname,
        tab96(1)    TYPE c,
        endat       TYPE fieldname,
        tab97(1)    TYPE c,
        endar       TYPE fieldname,
        tab98(1)    TYPE c,
        lodat       TYPE fieldname,
        tab99(1)    TYPE c,
        tndat       TYPE fieldname,
        tab100(1)    TYPE c,
        gbsta       TYPE fieldname,
        tab101(1)   TYPE c,
        fksaa       TYPE fieldname,
        tab102(1)   TYPE c,
        bismt       TYPE fieldname,
        tab103(1)   TYPE c,
* Begin of insert MOD-001
        netwr       TYPE fieldname,
        tab104(1)   TYPE c,
        wtgbtr      TYPE fieldname,
        tab105(1)   TYPE c,
* End of insert MOD-001
      END OF gt_outh.

DATA: gv_directory(25) TYPE c VALUE '/var/load/xxx/UK/read/',
      gv_ofile         LIKE /sapdmc/lsoinp-filename,
      gv_logsys        LIKE tbdlst-logsys,
      gv_ersda(14)     TYPE c,                      "YYYYMMDDHHMMSS
      gv_error         TYPE xfeld.


DATA: gv_waers_int    TYPE waers.
*CONSTANTS: gc_stat_dl  TYPE j_status  VALUE 'I0076'.

SELECTION-SCREEN  BEGIN OF BLOCK input  WITH FRAME  TITLE text-s01.
*PARAMETERS: p_vkorg  LIKE vbak-vkorg  OBLIGATORY  MEMORY ID vko.
PARAMETERS:     p_bukrs  TYPE aufk-bukrs OBLIGATORY MEMORY ID buk,
                p_vkorg  LIKE vbak-vkorg MEMORY ID vko.
SELECTION-SCREEN SKIP.
SELECT-OPTIONS: s_vkbur  FOR vbak-vkbur,
                s_vkgrp  FOR vbak-vkgrp,
                s_vbdat  FOR veda-vbegdat,
                s_vndat  FOR veda-venddat,
                s_auart  FOR vbak-auart,
                s_vbeln  FOR vbak-vbeln,
                s_abgru  FOR vbap-abgru,
                s_gbsta  FOR vbup-gbsta,
                s_fksaa  FOR vbup-fksaa.
SELECTION-SCREEN SKIP.
PARAMETERS: p_canc_r   AS CHECKBOX,
            p_canc_d   AS CHECKBOX.
SELECTION-SCREEN  END OF BLOCK input.


************************************************************************
*       I N I T I A L I Z A T I O N    E V E N T                       *
************************************************************************
INITIALIZATION.

* Timestamp
  CONCATENATE sy-datum sy-uzeit INTO gv_ersda.

* Logical system
  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = gv_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.


************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.
  PERFORM initial.
* Select data
  PERFORM select_data.

* Check anything selected
  IF gt_vbap[] IS INITIAL.
    MESSAGE ID 'YSE_GENERAL' TYPE 'S' NUMBER '000'
            WITH 'No contracts selected'(e01).
    RETURN.
  ENDIF.

* Build output
  PERFORM build_output.

* Save output.
  PERFORM save_output.

  IF gv_error IS INITIAL.
    WRITE: /01 'Program ended succesfully'(i01).
  ENDIF.


************************************************************************
*       S U B R O U T I N E S                                          *
************************************************************************

*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
*       Select data
*----------------------------------------------------------------------*
FORM select_data .

  DATA: lv_where TYPE string.
  lv_where = 'tvko~bukrs EQ p_bukrs'.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_where 'AND h~vkorg = p_vkorg' INTO lv_where SEPARATED BY space.
  ENDIF.
  CONCATENATE lv_where 'AND h~vkbur IN s_vkbur'
                       'AND h~vkgrp IN s_vkgrp'
                       'AND c~vbegdat IN s_vbdat'
                       'AND c~venddat IN s_vndat'
                       'AND h~auart IN s_auart'
                       'AND h~vbeln IN s_vbeln'
                       'AND i~abgru IN s_abgru'
                       'AND s~gbsta IN s_gbsta'
                       'AND s~fksaa IN s_fksaa'
                       'AND h~vbtyp =  ''G'''
                       'AND c~vposn =  0'
    INTO lv_where SEPARATED BY space.

* Contract items
*  SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_vbap
*         FROM vbap AS i
*         INNER JOIN vbak AS h
*                    ON h~vbeln = i~vbeln
*         INNER JOIN veda AS c
*                    ON c~vbeln = i~vbeln
*         INNER JOIN vbup AS s
*                    ON s~vbeln = i~vbeln  AND
*                       s~posnr = i~posnr
*         WHERE h~vkorg   =  p_vkorg
*           AND h~vkbur   IN s_vkbur
*           AND h~vkgrp   IN s_vkgrp
*           AND c~vbegdat IN s_vbdat
*           AND c~venddat IN s_vndat
*           AND h~auart   IN s_auart
*           AND h~vbeln   IN s_vbeln
*           AND i~abgru   IN s_abgru
*           AND s~gbsta   IN s_gbsta
*           AND s~fksaa   IN s_fksaa
*           AND h~vbtyp   =  'G'
*           AND c~vposn   =  0.
  SELECT i~vbeln i~posnr i~matnr i~zmeng i~zieme i~arktx i~pstyv i~vkaus i~abgru i~pmatn i~prodh
         i~matkl i~spart i~kondm i~werks i~vstel i~route i~mfrgr i~lprio i~lgort i~kztlf i~antlf
         i~uebto i~untto i~faksp i~taxm1 i~prctr i~abgrs i~kalsm_k  i~posex i~kdmat
         i~zzbbs i~zzbbt i~zzipm c~vkuegru c~veindat i~netwr i~objnr i~waerk
     INTO CORRESPONDING FIELDS OF TABLE gt_vbap
         FROM vbap AS i
         INNER JOIN vbak AS h
                    ON h~vbeln = i~vbeln
         INNER JOIN veda AS c
                    ON c~vbeln = i~vbeln
         INNER JOIN vbup AS s
                    ON s~vbeln = i~vbeln  AND
                       s~posnr = i~posnr
         INNER JOIN tvko AS tvko
           ON tvko~vkorg EQ h~vkorg
         WHERE (lv_where).
  CHECK NOT gt_vbap[] IS INITIAL.

* Check cancellation
  IF NOT p_canc_r IS INITIAL.
    DELETE gt_vbap WHERE NOT vkuegru IS INITIAL.
  ENDIF.
  IF NOT p_canc_d IS INITIAL.
    DELETE gt_vbap WHERE NOT veindat IS INITIAL.
  ENDIF.

  SORT gt_vbap BY vbeln posnr.

* Business Data
  SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_vbkd
           FROM vbkd
           FOR ALL ENTRIES IN gt_vbap
           WHERE vbeln = gt_vbap-vbeln
             AND posnr = gt_vbap-posnr.

* Contract data
  SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_vedai
           FROM veda
           FOR ALL ENTRIES IN gt_vbap
           WHERE vbeln = gt_vbap-vbeln.
*             AND vposn = gt_vbap-posnr.
  SORT gt_vedai BY vbeln vposn.
  DELETE ADJACENT DUPLICATES FROM gt_vedai
                                  COMPARING vbeln vposn.
  gt_veda[] = gt_vedai[].
  FREE gt_vedai.

* Shipping point
  SELECT vbeln posnr parvw kunnr ablad
         INTO TABLE gt_vbpa
         FROM vbpa
         FOR ALL ENTRIES IN gt_vbap
         WHERE vbeln = gt_vbap-vbeln
           AND posnr = gt_vbap-posnr
           AND parvw = 'WE'.

* Billing plan
  SELECT fplnr perio autte peraf
         bedat bedar endat endar
         lodat tndat
         INTO TABLE gt_fpla
         FROM fpla
         FOR ALL ENTRIES IN gt_vbkd
         WHERE fplnr = gt_vbkd-fplnr.

* Status
  SELECT vbeln posnr gbsta fksaa
         INTO TABLE gt_vbup
         FROM vbup
         FOR ALL ENTRIES IN gt_vbap
         WHERE vbeln = gt_vbap-vbeln
           AND posnr = gt_vbap-posnr.

* Technical objects
  SELECT sdaufnr posnr obknr obzae sernr equnr matnr
         INTO TABLE gt_viseri
         FROM viser02
         FOR ALL ENTRIES IN gt_vbap
         WHERE sdaufnr = gt_vbap-vbeln
           AND posnr   = gt_vbap-posnr.
  SORT gt_viseri BY vbeln posnr obknr DESCENDING obzae DESCENDING.
  DELETE ADJACENT DUPLICATES FROM gt_viseri
                                  COMPARING vbeln posnr.
  gt_viser[] = gt_viseri[].
  FREE gt_viseri.


ENDFORM.                    " SELECT_DATA

*&---------------------------------------------------------------------*
*&      Form  BUILD_OUTPUT
*&---------------------------------------------------------------------*
*       Build table fot output file
*----------------------------------------------------------------------*
FORM build_output .

  LOOP AT gt_vbap.


* Begin of insert MOD-001
  CLEAR gt_COEP[].
  SELECT ci~objnr ci~twaer ci~wtgbtr ci~belnr ci~buzei
         INTO TABLE gt_coep
         FROM coep AS ci
         INNER JOIN cobk AS ch
                    ON ci~kokrs = ch~kokrs  AND
                       ci~belnr = ch~belnr
*         FOR ALL ENTRIES IN gt_vbap
         WHERE ci~objnr =  gt_vbap-objnr
           AND ci~wrttp =  '04'            "Actual costs
           AND ci~lednr =  '00'
           AND ci~versn =  '000'
           AND ci~beknz IN ('H', 'S')
           AND ci~beltp IN ('0', '1').
*           AND ch~budat LE p_kdate.

* End of insert MOD-001

  CLEAR gv_act_cost_so.
  LOOP AT gt_coep WHERE objnr = gt_vbap-objnr.
*   Get actual values
    IF gt_coep-twaer = gt_vbap-waerk.
*     Transaction Currency = SO Currency
      gv_act_cost_so = gv_act_cost_so + gt_coep-wtgbtr.
    ELSE.
*     Convert to SO Currency (via intermediate currency)
      CLEAR gv_act_cost_lc.
      PERFORM convert_amount_int USING gt_coep-wtgbtr
                                       gt_coep-twaer
                                       gv_act_cost_lc
                                       gt_vbap-waerk.
      gv_act_cost_so = gv_act_cost_so + gv_act_cost_lc.
    ENDIF.
  ENDLOOP.

    clear: gt_out.


    MOVE '|' TO: gt_out-tab01, gt_out-tab02, gt_out-tab03, gt_out-tab04,
                 gt_out-tab05, gt_out-tab06, gt_out-tab07, gt_out-tab08,
                 gt_out-tab09, gt_out-tab10, gt_out-tab11, gt_out-tab12,
                 gt_out-tab13, gt_out-tab14, gt_out-tab15, gt_out-tab16,
                 gt_out-tab17, gt_out-tab18, gt_out-tab19, gt_out-tab20,
                 gt_out-tab21, gt_out-tab22, gt_out-tab23, gt_out-tab24,
                 gt_out-tab25, gt_out-tab26, gt_out-tab27, gt_out-tab28,
                 gt_out-tab29, gt_out-tab30, gt_out-tab31, gt_out-tab32,
                 gt_out-tab33, gt_out-tab34, gt_out-tab35, gt_out-tab36,
                 gt_out-tab37, gt_out-tab38, gt_out-tab39, gt_out-tab40,
                 gt_out-tab41, gt_out-tab42, gt_out-tab43, gt_out-tab44,
                 gt_out-tab45, gt_out-tab46, gt_out-tab47, gt_out-tab48,
                 gt_out-tab49, gt_out-tab50, gt_out-tab51, gt_out-tab52,
                 gt_out-tab53, gt_out-tab54, gt_out-tab55, gt_out-tab56,
                 gt_out-tab57, gt_out-tab58, gt_out-tab59, gt_out-tab60,
                 gt_out-tab61, gt_out-tab62, gt_out-tab63, gt_out-tab64,
                 gt_out-tab65, gt_out-tab66, gt_out-tab67, gt_out-tab68,
                 gt_out-tab69, gt_out-tab70, gt_out-tab71, gt_out-tab72,
                 gt_out-tab73, gt_out-tab74, gt_out-tab75, gt_out-tab76,
                 gt_out-tab77, gt_out-tab78, gt_out-tab79, gt_out-tab80,
                 gt_out-tab81, gt_out-tab82, gt_out-tab83, gt_out-tab84,
                 gt_out-tab85, gt_out-tab86, gt_out-tab87, gt_out-tab88,
                 gt_out-tab89, gt_out-tab90, gt_out-tab91, gt_out-tab92,
                 gt_out-tab93, gt_out-tab94, gt_out-tab95, gt_out-tab96,
                 gt_out-tab97, gt_out-tab98, gt_out-tab99, gt_out-tab100,
                 gt_out-tab101, gt_out-tab102, gt_out-tab103,
* Begin of insert MOD-001
                 gt_out-tab104, gt_out-tab105.
* End of insert MOD-001                   .


    MOVE-CORRESPONDING gt_vbap TO gt_out.
*   Packed fields
    WRITE gt_vbap-zmeng TO gt_out-zmeng.
    WRITE gt_vbap-antlf TO gt_out-antlf.
    WRITE gt_vbap-uebto TO gt_out-uebto.
    WRITE gt_vbap-untto TO gt_out-untto.
    WRITE gt_vbap-zzbbt TO gt_out-zzbbt.
    WRITE gt_vbap-zzipm TO gt_out-zzipm.
    WRITE gt_vbap-zzipl TO gt_out-zzipl.

    MOVE gv_act_cost_so TO gt_out-wtgbtr.


*   Business Data
    CLEAR gt_vbkd.
    READ TABLE gt_vbkd WITH TABLE KEY vbeln = gt_vbap-vbeln
                                      posnr = gt_vbap-posnr.
    IF sy-subrc = 0.
      MOVE-CORRESPONDING gt_vbkd TO gt_out.
*     Packed fields
      WRITE gt_vbkd-akprz TO gt_out-akprz.
      WRITE gt_vbkd-kurrf TO gt_out-kurrf.
    ENDIF.

*   Contract data
    READ TABLE gt_veda WITH TABLE KEY vbeln = gt_vbap-vbeln
                                      vposn = gt_vbap-posnr.
    IF sy-subrc = 0.
      MOVE-CORRESPONDING gt_veda TO gt_out.
    ELSE.
      READ TABLE gt_veda WITH TABLE KEY vbeln = gt_vbap-vbeln
                                        vposn = 0.
      IF sy-subrc = 0.
        MOVE-CORRESPONDING gt_veda TO gt_out.
      ENDIF.
    ENDIF.

*   Shipping point
    READ TABLE gt_vbpa WITH TABLE KEY vbeln = gt_vbap-vbeln
                                      posnr = gt_vbap-posnr
                                      parvw = 'WE'.
    IF sy-subrc = 0.
      gt_out-ablad = gt_vbpa-ablad.
    ENDIF.

*   Billing plan
    READ TABLE gt_fpla WITH TABLE KEY fplnr = gt_vbkd-fplnr.
    IF sy-subrc = 0.
      MOVE-CORRESPONDING gt_fpla TO gt_out.
    ENDIF.

*   Status
    READ TABLE gt_vbup WITH TABLE KEY vbeln = gt_vbap-vbeln
                                      posnr = gt_vbap-posnr.
    IF sy-subrc = 0.
      MOVE-CORRESPONDING gt_vbup TO gt_out.
    ENDIF.

*   Technical objects
    READ TABLE gt_viser WITH TABLE KEY vbeln = gt_vbap-vbeln
                                       posnr = gt_vbap-posnr.
    IF sy-subrc = 0.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = gt_viser-matnr_eq
        IMPORTING
          output = gt_viser-matnr_eq.

      SELECT SINGLE bismt FROM mara INTO gt_viser-bismt
        where matnr = gt_viser-matnr_eq.
      MOVE-CORRESPONDING gt_viser TO gt_out.
    ENDIF.

    APPEND gt_out.

  ENDLOOP.

ENDFORM.                    " BUILD_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  SAVE_OUTPUT
*&---------------------------------------------------------------------*
*       Save output file
*----------------------------------------------------------------------*
FORM save_output .

* Open file
*  CONCATENATE 'CONTRACT_ITM_DATA' p_vkorg gv_ersda
  CONCATENATE 'CONTRACT_ITM_DATA' p_bukrs
             INTO gv_ofile SEPARATED BY '_'.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE gv_ofile p_vkorg
               INTO gv_ofile SEPARATED BY '_'.
  ENDIF.
  CONCATENATE gv_ofile gv_ersda
             INTO gv_ofile SEPARATED BY '_'.

  REPLACE 'xxx' IN gv_directory WITH gv_logsys(3).
  CONCATENATE gv_directory gv_ofile INTO gv_ofile.

  OPEN DATASET gv_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc <> 0.
    WRITE: / text-e02, gv_ofile.
    gv_error = 'X'.
    EXIT.
  ENDIF.

* Fill header
  PERFORM fill_header.
  LOOP AT gt_outh.
    TRANSFER gt_outh TO gv_ofile.
  ENDLOOP.

* Fill output
  LOOP AT gt_out.
    TRANSFER gt_out TO gv_ofile.
  ENDLOOP.

ENDFORM.                    " SAVE_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  FILL_HEADER
*&---------------------------------------------------------------------*
*       Fill header
*----------------------------------------------------------------------*
FORM fill_header .

  CLEAR: gt_outh.
  MOVE '|' TO: gt_outh-tab01, gt_outh-tab02, gt_outh-tab03, gt_outh-tab04,
               gt_outh-tab05, gt_outh-tab06, gt_outh-tab07, gt_outh-tab08,
               gt_outh-tab09, gt_outh-tab10, gt_outh-tab11, gt_outh-tab12,
               gt_outh-tab13, gt_outh-tab14, gt_outh-tab15, gt_outh-tab16,
               gt_outh-tab17, gt_outh-tab18, gt_outh-tab19, gt_outh-tab20,
               gt_outh-tab21, gt_outh-tab22, gt_outh-tab23, gt_outh-tab24,
               gt_outh-tab25, gt_outh-tab26, gt_outh-tab27, gt_outh-tab28,
               gt_outh-tab29, gt_outh-tab30, gt_outh-tab31, gt_outh-tab32,
               gt_outh-tab33, gt_outh-tab34, gt_outh-tab35, gt_outh-tab36,
               gt_outh-tab37, gt_outh-tab38, gt_outh-tab39, gt_outh-tab40,
               gt_outh-tab41, gt_outh-tab42, gt_outh-tab43, gt_outh-tab44,
               gt_outh-tab45, gt_outh-tab46, gt_outh-tab47, gt_outh-tab48,
               gt_outh-tab49, gt_outh-tab50, gt_outh-tab51, gt_outh-tab52,
               gt_outh-tab53, gt_outh-tab54, gt_outh-tab55, gt_outh-tab56,
               gt_outh-tab57, gt_outh-tab58, gt_outh-tab59, gt_outh-tab60,
               gt_outh-tab61, gt_outh-tab62, gt_outh-tab63, gt_outh-tab64,
               gt_outh-tab65, gt_outh-tab66, gt_outh-tab67, gt_outh-tab68,
               gt_outh-tab69, gt_outh-tab70, gt_outh-tab71, gt_outh-tab72,
               gt_outh-tab73, gt_outh-tab74, gt_outh-tab75, gt_outh-tab76,
               gt_outh-tab77, gt_outh-tab78, gt_outh-tab79, gt_outh-tab80,
               gt_outh-tab81, gt_outh-tab82, gt_outh-tab83, gt_outh-tab84,
               gt_outh-tab85, gt_outh-tab86, gt_outh-tab87, gt_outh-tab88,
               gt_outh-tab89, gt_outh-tab90, gt_outh-tab91, gt_outh-tab92,
               gt_outh-tab93, gt_outh-tab94, gt_outh-tab95, gt_outh-tab96,
               gt_outh-tab97, gt_outh-tab98, gt_outh-tab99, gt_outh-tab100,
               gt_outh-tab101, gt_outh-tab102, gt_outh-tab103,
* Begin of insert MOD-001
               gt_outh-tab104, gt_outh-tab105.
* End of insert MOD-001

  gt_outh-vbeln       = 'VBELN'.
  gt_outh-posnr       = 'POSNR'.
  gt_outh-matnr       = 'MATNR'.
  gt_outh-zmeng       = 'ZMENG'.
  gt_outh-zieme       = 'ZIEME'.
  gt_outh-arktx       = 'ARKTX'.
  gt_outh-pstyv       = 'PSTYV'.
  gt_outh-delco       = 'DELCO'.
  gt_outh-prsdt       = 'PRSDT'.
  gt_outh-vkaus       = 'VKAUS'.
  gt_outh-abgru       = 'ABGRU'.
  gt_outh-pmatn       = 'PMATN'.
  gt_outh-prodh       = 'PRODH'.
  gt_outh-matkl       = 'MATKL'.
  gt_outh-spart       = 'SPART'.
  gt_outh-kdgrp       = 'KDGRP'.
  gt_outh-pltyp       = 'PLTYP'.
  gt_outh-kondm       = 'KONDM'.
  gt_outh-konda       = 'KONDA'.
  gt_outh-bzirk       = 'BZIRK'.
  gt_outh-faktf       = 'FAKTF'.
  gt_outh-ffprf       = 'FFPRF'.
  gt_outh-vbegdat     = 'VBEGDAT'.
  gt_outh-venddat     = 'VENDDAT'.
  gt_outh-vlaufk      = 'VLAUFK'.
  gt_outh-vlaufz      = 'VLAUFZ'.
  gt_outh-vinsdat     = 'VINSDAT'.
  gt_outh-vabndat     = 'VABNDAT'.
  gt_outh-vuntdat     = 'VUNTDAT'.
  gt_outh-vdemdat     = 'VDEMDAT'.
  gt_outh-vkuesch     = 'VKUESCH'.
  gt_outh-vkuegru     = 'VKUEGRU'.
  gt_outh-veindat     = 'VEINDAT'.
  gt_outh-vwundat     = 'VWUNDAT'.
  gt_outh-vbelkue     = 'VBELKUE'.
  gt_outh-vkuepar     = 'VKUEPAR'.
  gt_outh-vbedkue     = 'VBEDKUE'.
  gt_outh-abtnr       = 'ABTNR'.
  gt_outh-werks       = 'WERKS'.
  gt_outh-vstel       = 'VSTEL'.
  gt_outh-route       = 'ROUTE'.
  gt_outh-mfrgr       = 'MFRGR'.
  gt_outh-traty       = 'TRATY'.
  gt_outh-trmtyp      = 'TRMTYP'.
  gt_outh-empst       = 'EMPST'.
  gt_outh-lprio       = 'LPRIO'.
  gt_outh-lgort       = 'LGORT'.
  gt_outh-kztlf       = 'KZTLF'.
  gt_outh-antlf       = 'ANTLF'.
  gt_outh-vsart       = 'VSART'.
  gt_outh-sdabw       = 'SDABW'.
  gt_outh-uebto       = 'UEBTO'.
  gt_outh-untto       = 'UNTTO'.
  gt_outh-inco1       = 'INCO1'.
  gt_outh-inco2       = 'INCO2'.
  gt_outh-zterm       = 'ZTERM'.
  gt_outh-valdt       = 'VALDT'.
  gt_outh-valtg       = 'VALTG'.
  gt_outh-faksp       = 'FAKSP'.
  gt_outh-perfk       = 'PERFK'.
  gt_outh-fbuda       = 'FBUDA'.
  gt_outh-taxm1       = 'TAXM1'.
  gt_outh-kurrf       = 'KURRF'.
  gt_outh-mschl       = 'MSCHL'.
  gt_outh-mansp       = 'MANSP'.
  gt_outh-abssc       = 'ABSSC'.
  gt_outh-lcnum       = 'LCNUM'.
  gt_outh-akprz       = 'AKPRZ'.
  gt_outh-prctr       = 'PRCTR'.
  gt_outh-abgrs       = 'ABGRS'.
  gt_outh-kalsm_k     = 'KALSM_K'.
  gt_outh-zlsch_k     = 'ZSCHL_K'.
  gt_outh-bstkd       = 'BSTKD'.
  gt_outh-bstdk       = 'BSTDK'.
  gt_outh-bsark       = 'BSARK'.
  gt_outh-posex       = 'POSEX'.
  gt_outh-ihrez       = 'IHREZ'.
  gt_outh-kdmat       = 'KDMAT'.
  gt_outh-bstkd_e     = 'BSTKD_E'.
  gt_outh-bstdk_e     = 'BSTDK_E'.
  gt_outh-bsark_e     = 'BSARK_E'.
  gt_outh-posex_e     = 'POSEX_E'.
  gt_outh-ihrez_e     = 'IHREZ_E'.
  gt_outh-zzbbs       = 'ZZBBS'.
  gt_outh-zzbbt       = 'ZZBBT'.
  gt_outh-zzipm       = 'ZZIPM'.
  gt_outh-zzipl       = 'ZZIPL'.
  gt_outh-sernr       = 'GERNR'.
  gt_outh-equnr       = 'EQUNR'.
  gt_outh-matnr_eq    = 'MATNR_EQ'.
  gt_outh-ablad       = 'ABLAD'.
  gt_outh-perio       = 'PERIO'.
  gt_outh-autte       = 'AUTTE'.
  gt_outh-peraf       = 'PERAF'.
  gt_outh-bedat       = 'BEDAT'.
  gt_outh-bedar       = 'BEDAR'.
  gt_outh-endat       = 'ENDAT'.
  gt_outh-endar       = 'ENDAR'.
  gt_outh-lodat       = 'LODAT'.
  gt_outh-tndat       = 'TNDAT'.
  gt_outh-gbsta       = 'GBSTA'.
  gt_outh-fksaa       = 'FKSAA'.
  gt_outh-bismt       = 'BISMT'.
* Begin of insert MOD-001
  gt_outh-netwr       = 'NETWR'.
  gt_outh-wtgbtr      = 'WTGBTR'.
* End of insert MOD-001
  APPEND gt_outh.

  gt_outh-vbeln       = 'Contract'.
  gt_outh-posnr       = 'Item'.
  gt_outh-matnr       = 'Material'.
  gt_outh-zmeng       = 'Target Qty'.
  gt_outh-zieme       = 'UoM'.
  gt_outh-arktx       = 'Item Text'.
  gt_outh-pstyv       = 'Item Cat.'.
  gt_outh-delco       = 'Del. Time'.
  gt_outh-prsdt       = 'Pricing Date'.
  gt_outh-vkaus       = 'Usage'.
  gt_outh-abgru       = 'Reject.'.
  gt_outh-pmatn       = 'Pric. Ref. Mat.'.
  gt_outh-prodh       = 'Prod Hier.'.
  gt_outh-matkl       = 'Mat. Gr.'.
  gt_outh-spart       = 'Div.'.
  gt_outh-kdgrp       = 'Cust. Gr.'.
  gt_outh-pltyp       = 'Pr. List'.
  gt_outh-kondm       = 'Mat. Pr. Gr.'.
  gt_outh-konda       = 'Price Gr.'.
  gt_outh-bzirk       = 'Sales Distr.'.
  gt_outh-faktf       = 'Bill. Form'.
  gt_outh-ffprf       = 'DIP Profile'.
  gt_outh-vbegdat     = 'Start Date'.
  gt_outh-venddat     = 'End Date'.
  gt_outh-vlaufk      = 'Val. Per. Cat.'.
  gt_outh-vlaufz      = 'Val. Per. Contr.'.
  gt_outh-vinsdat     = 'Install. Date'.
  gt_outh-vabndat     = 'Accept. Date'.
  gt_outh-vuntdat     = 'Contr. Signed'.
  gt_outh-vdemdat     = 'Dismantle Date'.
  gt_outh-vkuesch     = 'Cancell. Proc.'.
  gt_outh-vkuegru     = 'Reason'.
  gt_outh-veindat     = 'Receipt Canc.'.
  gt_outh-vwundat     = 'Req. Canc.'.
  gt_outh-vbelkue     = 'Cancell. Doc.'.
  gt_outh-vkuepar     = 'Canc. Party'.
  gt_outh-vbedkue     = 'Canc. Date'.
  gt_outh-abtnr       = 'Dep.'.
  gt_outh-werks       = 'Plant'.
  gt_outh-vstel       = 'Shipp. Point'.
  gt_outh-route       = 'Route'.
  gt_outh-mfrgr       = 'Mat. Freight Gr.'.
  gt_outh-traty       = 'Means Tr. Type'.
  gt_outh-trmtyp      = 'Means of Transp.'.
  gt_outh-empst       = 'Receiving Point'.
  gt_outh-lprio       = 'Del. Priority'.
  gt_outh-lgort       = 'Stor. Loc.'.
  gt_outh-kztlf       = 'Part. Del.'.
  gt_outh-antlf       = 'Max.P. D.'.
  gt_outh-vsart       = 'Shipp. Type'.
  gt_outh-sdabw       = 'Spec. Proc.'.
  gt_outh-uebto       = 'Over Tol.'.
  gt_outh-untto       = 'Under Tol.'.
  gt_outh-inco1       = 'Incoterms (1)'.
  gt_outh-inco2       = 'Incoterms (2)'.
  gt_outh-zterm       = 'Paym. Terms'.
  gt_outh-valdt       = 'Fixed Value'.
  gt_outh-valtg       = 'Add. Val. Days'.
  gt_outh-faksp       = 'Bill. Block'.
  gt_outh-perfk       = 'Inv. Dates'.
  gt_outh-fbuda       = 'Serv. Rend.'.
  gt_outh-taxm1       = 'Tax Tlass.'.
  gt_outh-kurrf       = 'Exch. Rate'.
  gt_outh-mschl       = 'Dunning Key'.
  gt_outh-mansp       = 'Dunn. Block'.
  gt_outh-abssc       = 'Paym. Guar. Pr.'.
  gt_outh-lcnum       = 'Financ. Doc.'.
  gt_outh-akprz       = 'Deprec.'.
  gt_outh-prctr       = 'Profit Ctr.'.
  gt_outh-abgrs       = 'RA Key'.
  gt_outh-kalsm_k     = 'Costing Sheet'.
  gt_outh-zlsch_k     = 'Overhead'.
  gt_outh-bstkd       = 'PO Number'.
  gt_outh-bstdk       = 'PO Date'.
  gt_outh-bsark       = 'PO Type'.
  gt_outh-posex       = 'PO Item'.
  gt_outh-ihrez       = 'Your Ref.'.
  gt_outh-kdmat       = 'Cust. Mat.'.
  gt_outh-bstkd_e     = 'Ship-to PO'.
  gt_outh-bstdk_e     = 'S-T PO Date'.
  gt_outh-bsark_e     = 'S-T PO Type'.
  gt_outh-posex_e     = 'S-T PO Item'.
  gt_outh-ihrez_e     = 'S-T PO Ref.'.
  gt_outh-zzbbs       = 'Back-bill.'.
  gt_outh-zzbbt       = 'B-b Treshold'.
  gt_outh-zzipm       = 'Index. Mat.'.
  gt_outh-zzipl       = 'Index. Lab.'.
  gt_outh-sernr       = 'Serial No.'.
  gt_outh-equnr       = 'Equipment'.
  gt_outh-matnr_eq    = 'Mat. (Equipm.)'.
  gt_outh-ablad       = 'Unload. Point'.
  gt_outh-perio       = 'Per. (BP)'.
  gt_outh-autte       = 'Adv. Bill.'.
  gt_outh-peraf       = 'Dev. Bill.'.
  gt_outh-bedat       = 'Start (BP)'.
  gt_outh-bedar       = 'Rule'.
  gt_outh-endat       = 'End (BP)'.
  gt_outh-endar       = 'Rule'.
  gt_outh-lodat       = 'Dates From'.
  gt_outh-tndat       = 'Dates To'.
  gt_outh-gbsta       = 'Proc. Stat.'.
  gt_outh-fksaa       = 'Bill. Stat.'.
  gt_outh-bismt       = 'Old Material Number'.
* Begin of insert MOD-001
  gt_outh-netwr       = 'Net Value'.
  gt_outh-wtgbtr      = 'Actual Cost'.
* End of insert MOD-001
  APPEND gt_outh.

ENDFORM.                    " FILL_HEADER

FORM convert_amount_int  USING    p_kwert_in
                                  p_waers_in
                                  p_kwert_out
                                  p_waers_res.

  DATA: lv_value_int   TYPE wtgxxx.

* Input Currency = Result currency -> NO conversion
  IF p_waers_in = p_waers_res.
    p_kwert_out = p_kwert_in.
    RETURN.
  ENDIF.

* Intermediate exchange rate
  IF p_waers_in = gv_waers_int.
    lv_value_int = p_kwert_in.
  ELSE.
    CLEAR gt_curr.
    READ TABLE gt_curr WITH TABLE KEY kurst = gv_kurst
                                      fcurr = p_waers_in
                                      tcurr = gv_waers_int.
    CHECK sy-subrc = 0.
*     Calculate ammount in intermediate currency
    IF gt_curr-ukurs = 0.
      gt_curr-ukurs = 1.
    ENDIF.
    lv_value_int = p_kwert_in * gt_curr-ukurs.
  ENDIF.

* Result exchange rate
  IF p_waers_res = gv_waers_int.
    p_kwert_out = lv_value_int.
  ELSE.
    CLEAR gt_curr.
    READ TABLE gt_curr WITH TABLE KEY kurst = gv_kurst
                                      fcurr = p_waers_res
                                      tcurr = gv_waers_int.
    CHECK sy-subrc = 0.
*     Calculate ammount in result currency
    IF gt_curr-ukurs = 0.
      gt_curr-ukurs = 1.
    ENDIF.
    p_kwert_out = lv_value_int / gt_curr-ukurs.
  ENDIF.

ENDFORM.

FORM initial.
* Company currency
  SELECT SINGLE waers INTO gv_waers_cc
         FROM t001
         WHERE bukrs = p_bukrs.
  IF sy-subrc NE 0.
  ENDIF.

* Invert key date
  CONVERT DATE sy-datum INTO INVERTED-DATE gv_gdatu.

* Exchange rate type
  CASE p_bukrs.
    WHEN 'MRUA'.
      gv_kurst = 'DRU'.
    WHEN 'POLA'.
      gv_kurst = 'D'.
    WHEN OTHERS.
      gv_kurst = 'EURX'.
  ENDCASE.

* Intermediate currency
  CASE p_bukrs.
    WHEN 'MRUA'.
      gv_waers_int = gv_waers_cc.
    WHEN 'POLA'.
      gv_waers_int = gv_waers_cc.
    WHEN OTHERS.
      gv_waers_int = 'EUR'.
  ENDCASE.


  SELECT kurst fcurr tcurr gdatu ukurs INTO TABLE gt_curri
         FROM tcurr
         WHERE kurst =  gv_kurst
           AND tcurr =  gv_waers_int
           AND gdatu GE gv_gdatu.
  SORT gt_curri BY kurst fcurr tcurr gdatu.
  DELETE ADJACENT DUPLICATES FROM gt_curri COMPARING kurst fcurr tcurr.
  gt_curr[] = gt_curri[].
  FREE gt_curri.

** Get last day of the month
*  CALL FUNCTION 'DATE_GET_MONTH_LASTDAY'
*    EXPORTING
*      i_date = p_kdate
*    IMPORTING
*      e_date = gv_end_month.
ENDFORM.

*Text symbol text£º
*E01:No contracts selected
*I01:Program ended succesfully

*S01:Selection
*Selection text£º
*P_BUKRS:D       .
*P_CANC_D:        Check cancellation receipt
*P_CANC_R:        Check cancellation reason
*P_VKORG:D       .
*S_ABGRU:D       .
*S_AUART:D       .
*S_FKSAA:D       .
*S_GBSTA:D       .
*S_VBDAT:D       .
*S_VBELN:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
*S_VNDAT:D       .
