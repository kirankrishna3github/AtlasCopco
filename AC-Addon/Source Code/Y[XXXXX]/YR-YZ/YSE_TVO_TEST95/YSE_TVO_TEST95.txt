************************************************************************
* Program ID           : YSE_REN_DEPREC_ALLOC                          *
* Program title        : REN: P/L per Rental Depot                     *
* Author               : Erik Walravens                                *
* Date                 : 30.01.2007                                    *
* Development Number   : D214-Rental                                   *
* Change Request Number: CD1K909906                                    *
* Description          : This report is a tool which allows to derive  *
*                        the percentile distributions of depreciation  *
*                        costs of rental equipment per rental depot.   *
************************************************************************
* Change History Log                                                   *
*----------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number | Change Ref *
*----------------------------------------------------------------------*
* MOD-001 |19/04/2007| Erik Walravens | CD1K912632        | 001        *
* Description: Fix COEP Revenue error.                                 *
*              Load depreciation values from table ANLP.               *
*----------------------------------------------------------------------*
* MOD-002 |20/04/2007| Erik Walravens | CD1K914115        | 002        *
* Description: Fix multiple ANLP records error.                        *
*----------------------------------------------------------------------*
* MOD-003 |24/04/2007| Erik Walravens | CD1K914220        | 003        *
* Description: Invert cost signs and enhance save functionality.       *
*----------------------------------------------------------------------*
* MOD-004 |31/05/2007| Erik Walravens | CD1K915724        | 004        *
* Description: Default contract end date in case of incomplete doc.    *
*----------------------------------------------------------------------*
* MOD-005 |04/06/2007| Erik Walravens | CD1K915857        | 005        *
* Description: Fix revenue per sales office distribution error.        *
*----------------------------------------------------------------------*
* MOD-006 |13/06/2007| Erik Walravens | CD1K916264        | 006        *
* Description: copy correct currency on every line.                    *
*----------------------------------------------------------------------*
* MOD-007 |02/07/2007| Erik Walravens | CD1K917256        | 007        *
* Description: Implement distribution between contracts and depots     *
*              on table YSE_LOC_EQUIP.                                 *
************************************************************************
REPORT  YSE_REN_DEPREC_ALLOC.

************************************************************************
* FIELD-SYMBOLS                                                        *
************************************************************************
FIELD-SYMBOLS: <FIELDCAT> TYPE LVC_S_FCAT.

************************************************************************
* OBJECTS                                                              *
************************************************************************
DATA : OBJ_CONTAINER     TYPE REF TO CL_GUI_CUSTOM_CONTAINER.
DATA : OBJ_ALV           TYPE REF TO CL_GUI_ALV_GRID.

************************************************************************
* TABLES                                                               *
************************************************************************
TABLES: LIKP, LIPS, VBUP, QMEL, EQUI, EQKT, EQUZ, ILOA, IMPTT,
        YSE_RENT_COPA, YSE_RENT_DEPOT.

************************************************************************
* TYPE-POOLS                                                           *
************************************************************************
TYPE-POOLS SLIS.

************************************************************************
* INTERNAL TYPES                                                       *
************************************************************************
TYPES:  BEGIN OF STR_EQ,
               EQUNR        TYPE EQUI-EQUNR,
        END OF STR_EQ.

TYPES:  BEGIN OF STR_CONT,
               ANGDT        TYPE DATS,                " Start date
               BNDDT        TYPE DATS,                " End date
               TPLNR        TYPE TPLNR,               " Functional location
               DELTA        TYPE P,                   " Delta
               PRCNT        TYPE P DECIMALS 5,        " Percentage
               VKORG        TYPE VKORG,               " Sales organisation
               VKBUR        TYPE VKBUR,               " Sales office
               FLAG         TYPE C,                   " source flag
        END OF STR_CONT.

TYPES:  BEGIN OF STR_YARD,
               ANGDT        TYPE DATS,                " Start date
               BNDDT        TYPE DATS,                " End date
               VKORG        TYPE ITOB-VKORG,          " Sales organisation
               VKBUR        TYPE ITOB-VKBUR,          " Sales office
        END OF STR_YARD.

TYPES:  BEGIN OF STR_COS4,                                  " CE41000
               EQUNR        TYPE EQUNR,
               VKBUR        TYPE VKBUR,        " new
               PAOBJNR      TYPE RKEOBJNR,
        END OF STR_COS4.

TYPES:  BEGIN OF STR_COS3,                                  " CE31000
               EQUNR        TYPE EQUNR,               " Equipment
               VKBUR        TYPE VKBUR,               " Sales office " new
               PAOBJNR      TYPE RKEOBJNR,            " Posting number
               VRGAR        TYPE RKE_VRGAR,           " Posting type
               REC_WAERS    TYPE RKE_REC_WAERS,       " Currency
               PERBL        TYPE JAHRPERBL,           " Year/Period
               VV100001     TYPE RKE2_VV100,          " Revenue
               VV200001     TYPE RKE2_VV200,          " Parts
               VV300001     TYPE RKE2_VV300,          " Labour
               VV400001     TYPE RKE2_VV400,          " Mileage
               VV500001     TYPE RKE2_VV500,          " Subcontracting
               VV600001     TYPE RKE2_VV600,          " Ad Hoc Expenses
               VV112001     TYPE RKE2_VV112,          " COGS-Contract provis
               VV130001     TYPE RKE2_VV130,          " Unadjusted COS
        END OF STR_COS3.

TYPES:  BEGIN OF STR_ILOA,                        " Asset number
               EQUNR        TYPE EQUNR,           " Equipment nr
               ANLNR        TYPE ANLN1,           " Asset nr
               ANLUN        TYPE ANLN2,           " Asset subnr
        END OF STR_ILOA.

TYPES:  BEGIN OF STR_ANLP,                        " Depreciations
               BUKRS        TYPE BUKRS,           " Company code
               GJAHR        TYPE GJAHR,           " Fiscal Year
               PERAF        TYPE PERAF,           " Depr calc period
               AFBNR        TYPE AFBNR,           " Seq nr
               ANLN1        TYPE ANLN1,           " Asset nr
               ANLN2        TYPE ANLN2,           " Asset subnr
               AFABER       TYPE AFABER,          " Area
               ZUJHR        TYPE DZUJHR,          " Asset acq. year
               ZUCOD        TYPE DZUCOD,          " sub-clas of ass acq
               NAFAZ        TYPE NAFAZ,           " Ord Posted Deprec.
               WAERS        TYPE WAERS,           " Currency
        END OF STR_ANLP.

TYPES:  BEGIN OF STR_LOC,
               EQUNR        TYPE EQUNR,           " Equipment
               DATUM        TYPE DATS,            " Date
               B_WERK       TYPE WERKS_D,         " Plant
               B_LAGER      TYPE LGORT_D,         " Storage location
               KUNNR        TYPE KUNNR,           " Customer nr
        END OF STR_LOC.

TYPES:  BEGIN OF STR_CON,
               VKORG        TYPE VKORG,           " Sales org
               VTWEG        TYPE VTWEG,           " Distr. chan.
               VKBUR        TYPE VKBUR,           " Sales office
               AUART        TYPE AUART,
               VBELN        TYPE VBELN,
               POSNR        TYPE POSNR,
               MATNR        TYPE MATNR,
               ZZEQUNR      TYPE EQUNR,
               ZZSERNR      TYPE GERNR,
               KUNNR        TYPE KUNNR,           " Sold-to party
               ANGDT        TYPE ANGDT,           " Start date
               BNDDT        TYPE BNDDT,           " End date
        END OF STR_CON.

TYPES:  BEGIN OF STR_DEPOTS,                      " Sales offices (depots)
               VKORG        TYPE VKORG,           " Sales organization
               VKBUR        TYPE VKBUR,           " Sales office
               WERKS        TYPE WERKS_EXT,       " Plant
               KOSTL        TYPE KOSTL,           " Cost center
               OBJNR        TYPE COEP-OBJNR,      " COEP id
        END OF STR_DEPOTS.

TYPES:  BEGIN OF STR_COEP,                            " COEP (Cost Centers)
               OBJNR        TYPE COEP-OBJNR,          " Cost object
               WOGBTR       TYPE COEP-WOGBTR,         " Cost value
               OWAER        TYPE COEP-OWAER,          " Currency
        END OF STR_COEP.


************************************************************************
* FIELD-SYMBOLS                                                        *
************************************************************************
FIELD-SYMBOLS:
  <FS_COS3> TYPE STR_COS3,
  <FS_COS4> TYPE STR_COS4.

************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:  IT_EQ       TYPE TABLE OF STR_EQ       WITH HEADER LINE,
       IT_LOC      TYPE TABLE OF STR_LOC      WITH HEADER LINE,
       IT_CON      TYPE TABLE OF STR_CON      WITH HEADER LINE,
       IT_CONT     TYPE TABLE OF STR_CONT     WITH HEADER LINE,
       IT_YARD     TYPE TABLE OF STR_YARD     WITH HEADER LINE,
       IT_FIELDCAT TYPE LVC_T_FCAT,            " ALV grid field catalog
       IT_COS4     TYPE TABLE OF STR_COS4     WITH HEADER LINE,
       IT_COS3     TYPE TABLE OF STR_COS3     WITH HEADER LINE,
       IT_ILOA     TYPE TABLE OF STR_ILOA     WITH HEADER LINE,
       IT_ANLP     TYPE TABLE OF STR_ANLP     WITH HEADER LINE,
       IT_DEPOTS   TYPE TABLE OF STR_DEPOTS   WITH HEADER LINE,
       IT_COEP     TYPE TABLE OF STR_COEP     WITH HEADER LINE,
       IT_SME      LIKE YSE_RENT_SME OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF IT_LINES OCCURS 0.
        INCLUDE STRUCTURE YSE_REN_ALV_COPA_ALLOC.
DATA:   B_WERK       TYPE WERKS_D,
        KUNNR        TYPE KUNNR,
      END OF IT_LINES.

DATA: WA_LINES     LIKE LINE OF IT_LINES.
DATA: R_VRGAR      TYPE RANGE OF RKE_VRGAR WITH HEADER LINE.
DATA: V_TOT_DAYS TYPE I.
************************************************************************
* GLOBAL CONSTANTS                                                     *
************************************************************************
CONSTANTS: GC_TRUE     TYPE CHAR1       VALUE 'X',    " true
           GC_ENGL     LIKE TVAGT-SPRAS VALUE 'E',    " english
           GC_EQTYPX   TYPE EQUI-EQTYP  VALUE 'X',    " rental equipment
           GC_EQTYPY   TYPE EQUI-EQTYP  VALUE 'Y',    " rental equipment
           GC_RENT     TYPE VTWEG       VALUE '21',   " rental distr. ch.
           GC_PALED    TYPE LEDBO       VALUE '02',   " Currency type
           GC_AFABER   TYPE AFABER      VALUE '30',   " Deprec. Area
           GC_RECENT   TYPE DATBI       VALUE '99991231',
           GC_CONT     TYPE C           VALUE 'C',    " from contract
           GC_KS(2)    TYPE C           VALUE 'KS'.   " COEP object start

************************************************************************
* VARIABLES                                                            *
************************************************************************
* ALV grid
DATA:  OKCODE          LIKE SY-UCOMM,       " return param screen 100
       O_BUKRS(4)      TYPE C,
       O_YEAR(4)       TYPE C,
       O_PERIOD(4)     TYPE C,
       GS_LAYOUT       TYPE LVC_S_LAYO.
* Process
DATA:  WA_DEPOT        TYPE YSE_RENT_DEPOT,
       IDX_LINES       LIKE SY-TABIX,       " index it_lines table
       LV_LINES        TYPE P,              " lines in an internal table
       GV_START        TYPE DATS,           " month's start
       GV_END          TYPE DATS,           " month's end
       GV_DAYS         TYPE P,              " days in current period
       GV_MAXEND       TYPE DATS,           " period's end
       GV_KOKRS        TYPE KOKRS,          " Controlling Area
       GV_EQUNR        TYPE EQUNR,          " temp equipment
       GV_B_WERK       TYPE WERKS_D,        " temp plant
       GV_KUNNR        TYPE KUNNR.          " temp partner
* Temp
DATA:  LV_SUM          TYPE F.              " temporarily used until contracts issue is solved

************************************************************************
* SELECTION SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-S01.
PARAMETERS:   P_BUKRS  TYPE BUKRS MEMORY ID BUK OBLIGATORY,
              P_FYEAR  LIKE YSE_RENT_COPA-FYEAR OBLIGATORY,
              P_FPERD  LIKE YSE_RENT_COPA-FPERD OBLIGATORY.
SELECT-OPTIONS: S_EQUNR FOR EQUI-EQUNR.
SELECTION-SCREEN END OF BLOCK B1.

************************************************************************
* INITIALIZATION                                                       *
************************************************************************
INITIALIZATION.
  P_FYEAR = SY-DATUM+0(4).
  P_FPERD = SY-DATUM+4(2).
  IF P_FPERD = '01'.
    P_FYEAR  = P_FYEAR - 1.
    P_FPERD  = '12'.
  ELSE.
    P_FPERD  = P_FPERD - 1.
  ENDIF.


************************************************************************
* START OF SELECTION                                                   *
************************************************************************
START-OF-SELECTION.

  PERFORM CALC_DATES.
  PERFORM PREPARE_DATA.

  LOOP AT IT_EQ.
*   Read where (VKBUR) the equipment has been at customers' sites
    PERFORM GET_CONTRACT_HISTORY.
**   Read where (VKBUR) the equipment has been at rental depot(s)
*    PERFORM get_yard_history.
*   Calculate derivates
    PERFORM CALC_DERIVATES.
  ENDLOOP.  " it_eq

  CALL SCREEN 100.

*************************************************************************
** Module STATUS_0100 OUTPUT                                            *
*************************************************************************
MODULE STATUS_0100 OUTPUT.
  SET TITLEBAR 'TITLE100'.
  SET PF-STATUS 'STATUS100'.
ENDMODULE.                 " STATUS_0100  OUTPUT

*************************************************************************
** Module USER_COMMAND_0100 INPUT                                       *
*************************************************************************
MODULE USER_COMMAND_0100 INPUT.
  CASE OKCODE.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
    WHEN 'SAVE'.
      PERFORM SAVE_DATA.
  ENDCASE.
ENDMODULE.                 " USER_COMMAND_0100 INPUT

*************************************************************************
** Module PREPARE_SCREEN OUTPUT                                         *
*************************************************************************
MODULE PREPARE_SCREEN OUTPUT.
  IF OBJ_CONTAINER IS INITIAL .
    CREATE OBJECT OBJ_CONTAINER
             EXPORTING CONTAINER_NAME = 'OVERVIEW' .

    CREATE OBJECT OBJ_ALV
              EXPORTING I_PARENT = OBJ_CONTAINER.

    PERFORM BUILD_ALV.
  ENDIF.
ENDMODULE.                 " PREPARE_SCREEN  OUTPUT


************************************************************************
* Form                 : PREPARE_DATA                                  *
************************************************************************
* Description          : Pre-loads equipments and COS data in internal *
*                        tables.                                       *
************************************************************************
FORM PREPARE_DATA.

  DATA: LV_PERBL    TYPE JAHRPERBL.   " Period

* Copy header data for output
  O_BUKRS = P_BUKRS.
  O_YEAR = P_FYEAR.
  O_PERIOD = P_FPERD.

* Select all rental equipment for the selected company code
* Note: this is a minimized ITOB join
* Note: To be optimized further - see example in Sources
  SELECT EQUI~EQUNR
      INTO CORRESPONDING FIELDS OF TABLE IT_EQ
      FROM EQUI
     INNER JOIN EQUZ
        ON EQUI~EQUNR EQ EQUZ~EQUNR
     INNER JOIN ILOA
        ON EQUZ~ILOAN EQ ILOA~ILOAN
     WHERE EQUZ~DATBI EQ '99991231' AND
           ILOA~BUKRS EQ P_BUKRS   AND
         ( EQUI~EQTYP EQ GC_EQTYPX OR
           EQUI~EQTYP EQ GC_EQTYPY ) AND
           EQUI~EQUNR IN S_EQUNR.

  SORT IT_EQ.
  DELETE ADJACENT DUPLICATES FROM IT_EQ.

* Retrieve all equipment's locations over selected period
  SELECT EQUNR DATUM B_WERK B_LAGER KUNNR
    FROM YSE_LOC_EQUIP
    INTO TABLE IT_LOC
    FOR ALL ENTRIES IN IT_EQ
    WHERE EQUNR EQ IT_EQ-EQUNR
    AND   DATUM GE GV_START
    AND   DATUM LE GV_END.

  IF NOT IT_EQ[] IS INITIAL.
*   Retrieve all contracts
    SELECT VKORG VTWEG VKBUR AUART
           VBELN POSNR MATNR
           ZZEQUNR ZZSERNR
           KUNNR ANGDT BNDDT
      INTO TABLE IT_CON
      FROM YSE_RENT_SME
      FOR ALL ENTRIES IN IT_LOC
      WHERE KUNNR EQ IT_LOC-KUNNR
      AND ( ANGDT EQ IT_LOC-DATUM
      OR    BNDDT EQ IT_LOC-DATUM ).

*   Get equipment key to access COS data
    SELECT EQUNR VKBUR PAOBJNR
        INTO TABLE IT_COS4              " CORRESPONDING FIELDS OF TABLE it_cos4
        FROM CE41000
         FOR ALL ENTRIES IN IT_EQ
       WHERE BUKRS = P_BUKRS
         AND VTWEG = GC_RENT
         AND EQUNR = IT_EQ-EQUNR.

    SORT IT_COS4 BY PAOBJNR.

*   Build VRGAR values range
    R_VRGAR-SIGN = 'I'.
    R_VRGAR-OPTION = 'EQ'.
    R_VRGAR-LOW = 'B'.
    APPEND R_VRGAR.
    R_VRGAR-LOW = 'C'.
    APPEND R_VRGAR.
    R_VRGAR-LOW = 'F'.
    APPEND R_VRGAR.
    R_VRGAR-LOW = '0'.
    APPEND R_VRGAR.
    R_VRGAR-LOW = '9'.
    APPEND R_VRGAR.

    LV_PERBL(4) = P_FYEAR.
    LV_PERBL+4(1) = '0'.
    LV_PERBL+5(2) = P_FPERD.

    IF NOT IT_COS4[] IS INITIAL.
*     Get equipment's COS data
      SELECT PAOBJNR  VRGAR    REC_WAERS PERBL
             VV100001 VV200001 VV300001 VV400001
             VV500001 VV600001 VV112001 VV130001
        INTO CORRESPONDING FIELDS OF TABLE IT_COS3
        FROM CE31000
         FOR ALL ENTRIES IN IT_COS4
       WHERE PAOBJNR  EQ IT_COS4-PAOBJNR
         AND PALEDGER EQ GC_PALED            " Rental equipment
         AND VRGAR    IN R_VRGAR             " Posting type
         AND PERBL    EQ LV_PERBL.           " Period

      SORT IT_COS4 BY PAOBJNR.
    ENDIF.

*   Add equipment number and sales office
    LOOP AT IT_COS3 ASSIGNING <FS_COS3>.
      READ TABLE IT_COS4
        WITH KEY PAOBJNR = <FS_COS3>-PAOBJNR
        BINARY SEARCH
        ASSIGNING <FS_COS4>.
      IF <FS_COS4> IS ASSIGNED.
        <FS_COS3>-EQUNR = <FS_COS4>-EQUNR.
        <FS_COS3>-VKBUR = <FS_COS4>-VKBUR.
      ENDIF.
    ENDLOOP.                                                " it_cos3

*   Get equipment's Depreciation data
    SELECT EQUZ~EQUNR ILOA~ANLNR ILOA~ANLUN
        INTO TABLE IT_ILOA
        FROM EQUZ
       INNER JOIN ILOA
          ON EQUZ~ILOAN EQ ILOA~ILOAN
         FOR ALL ENTRIES IN IT_EQ
        WHERE EQUZ~EQUNR EQ IT_EQ-EQUNR
          AND EQUZ~DATBI EQ GC_RECENT
          AND ILOA~ANLNR NE ' '.
*       WHERE equz~datbi EQ '99991231' AND
*             iloa~bukrs EQ p_bukrs   AND
*           ( equi~eqtyp EQ gc_eqtypx OR
*             equi~eqtyp EQ gc_eqtypy ).

    SORT IT_ILOA.
    DELETE ADJACENT DUPLICATES FROM IT_ILOA.

    SELECT ANLP~BUKRS ANLP~GJAHR ANLP~PERAF  ANLP~AFBNR
           ANLP~ANLN1 ANLP~ANLN2 ANLP~AFABER ANLP~ZUJHR
           ANLP~ZUCOD ANLP~NAFAZ T093B~WAERS
        INTO TABLE IT_ANLP
        FROM ANLP
        JOIN T093B
          ON ANLP~BUKRS  EQ T093B~BUKRS
         AND ANLP~AFABER EQ T093B~AFABE
         FOR ALL ENTRIES IN IT_ILOA
       WHERE ANLP~BUKRS  EQ P_BUKRS
         AND ANLP~GJAHR  EQ P_FYEAR
         AND ANLP~PERAF  EQ P_FPERD
         AND ANLP~ANLN1  EQ IT_ILOA-ANLNR
         AND ANLP~ANLN2  EQ IT_ILOA-ANLUN
         AND ANLP~AFABER EQ GC_AFABER.

  ENDIF.  " it_eq not initial

* Other costs: build cost center objnr
* Find depots for this company code
*    SELECT tvkbz~vkbur tvkbt~bezei
*        INTO TABLE it_depots
*        FROM tvkbz
*       INNER JOIN tvkbt
*          ON tvkbz~vkbur EQ tvkbt~vkbur
*       WHERE vkorg EQ p_vkorg
*         AND spras EQ gc_engl.
*    SORT it_depots.
*    DELETE ADJACENT DUPLICATES FROM it_depots.

* Get sales office per plant
* Get cost center postings per sales offices
* Get this data for current company code
  SELECT VKBUR VKORG WERKS KOSTL
      INTO CORRESPONDING FIELDS OF TABLE IT_DEPOTS
      FROM YSE_RENT_DEPOT
     WHERE BUKRS = P_BUKRS.

* Get controlling area
  SELECT SINGLE KOKRS
      INTO GV_KOKRS
      FROM TKA02
     WHERE BUKRS = P_BUKRS.

* Load postings per sales office cost center
  LOOP AT IT_DEPOTS WHERE NOT KOSTL IS INITIAL.
    IT_DEPOTS-OBJNR = GC_KS.
    IT_DEPOTS-OBJNR+2(4) = GV_KOKRS.
    IT_DEPOTS-OBJNR+6    = IT_DEPOTS-KOSTL.
    MODIFY IT_DEPOTS.
  ENDLOOP.

  SELECT OBJNR WOGBTR OWAER
      FROM COEP
      INTO CORRESPONDING FIELDS OF TABLE IT_COEP
       FOR ALL ENTRIES IN IT_DEPOTS
     WHERE KOKRS EQ GV_KOKRS
       AND OBJNR EQ IT_DEPOTS-OBJNR
       AND PERIO EQ P_FPERD                 " gv_perio
       AND GJAHR EQ P_FYEAR.

ENDFORM.    " prepare_data


************************************************************************
* Form                 : CALC_DATES                                    *
************************************************************************
* Description          : Pre-calculates all date derivates.            *
************************************************************************
FORM CALC_DATES.

* Rectify month if necessary
  IF P_FPERD < 10 AND
    P_FPERD(1) <> '0'.
    P_FPERD+1(1) = '0'.
    SHIFT P_FPERD CIRCULAR.
  ENDIF.

* Note: move to initialization with error and message
  IF P_FPERD > 12.
    P_FPERD = 12.
  ENDIF.

* Build start date
  CONCATENATE P_FYEAR
              P_FPERD
              '01'
         INTO GV_START.

* Count number of days in this month
  CALL FUNCTION 'HR_E_NUM_OF_DAYS_OF_MONTH'
    EXPORTING
      P_FECHA        = GV_START
    IMPORTING
      NUMBER_OF_DAYS = GV_DAYS.

* Build end date
  GV_END = GV_START + GV_DAYS - 1.

ENDFORM.    " calc_dates


************************************************************************
* Form                 : GET_CONTRACT_HISTORY                          *
************************************************************************
* Description          : Reads all contracts for this equipment and    *
*                        inserts the functional locations in it_lines. *
************************************************************************
FORM GET_CONTRACT_HISTORY.

  CLEAR IT_CONT.
  REFRESH IT_CONT.

* Get all contract items for this equipment within selected period
  SELECT *
      FROM YSE_RENT_SME                                 "#EC CI_NOFIRST
      INTO TABLE IT_SME
     WHERE ZZEQUNR EQ IT_EQ-EQUNR AND           " equipment
             AUART EQ 'ZQP'          AND        " rental contracts
         ( ( ANGDT GT GV_START       AND        " within selected period
             ANGDT LT GV_END       )  OR
           ( BNDDT GT GV_START       AND
             BNDDT LT GV_END       )  OR
           ( ANGDT LE GV_START       AND
             BNDDT GT GV_END       ) ).

* If found contract(s)
  IF SY-SUBRC = 0.
    LOOP AT IT_SME.
      CLEAR IT_CONT.                     " Clear contracts' table header line.
      IF IT_SME-ANGDT < GV_START.
        IT_CONT-ANGDT = GV_START.
      ELSE.
        IT_CONT-ANGDT = IT_SME-ANGDT.
      ENDIF.
      IF IT_SME-BNDDT > GV_END.
        IT_CONT-BNDDT = GV_END.
      ELSE.
        IT_CONT-BNDDT = IT_SME-BNDDT.
      ENDIF.
      IF IT_CONT-BNDDT IS INITIAL.
        IT_CONT-BNDDT = GV_END.
      ENDIF.
      IT_CONT-DELTA = IT_CONT-BNDDT - IT_CONT-ANGDT + 1.
      IT_CONT-PRCNT = IT_CONT-DELTA * 100 / GV_DAYS.
      IT_CONT-VKORG = IT_SME-VKORG.
      IT_CONT-VKBUR = IT_SME-VKBUR.
      IT_CONT-FLAG = GC_CONT.
      APPEND IT_CONT.
    ENDLOOP.  " it_sme
  ENDIF.    " found contracts

ENDFORM.  " get_contract_history


************************************************************************
* Form                 : GET_YARD_HISTORY                              *
************************************************************************
* Description          : Obtain historical overview of the plants      *
*                        where this equipment has been in the yard.    *
************************************************************************
*FORM get_yard_history.

** Local variables
*  DATA: lv_start         TYPE dats,               " start
*        lv_end           TYPE dats,               " end
*        lv_prev_vkbur    TYPE vkbur.              " previous tplnr
*
** Local constants
*  CONSTANTS: lc_intoyard TYPE ser03-bwart VALUE '932', " Movement type into depot
*             lc_outayard TYPE ser03-bwart VALUE '931'. " Movement type out of depot
** Local types
*  TYPES: BEGIN OF str_hist,
*           werk      TYPE ser03-werk,          " Plant = depot
*           datum     TYPE ser03-datum,         " Date
*           uzeit     TYPE ser03-uzeit,         " Time
*           bwart     TYPE mseg-bwart,          " Movement type
*         END OF str_hist.
*
** local internal tables
*  DATA: it_hist TYPE TABLE OF str_hist WITH HEADER LINE.
*
*
*  CLEAR it_hist.
*  REFRESH it_hist.
*
*  CLEAR it_yard.
*  REFRESH it_yard.
*
** Read all equipments' plant and date history
** Plant information = depot site
** Date is install date if movement type = 932.
*  SELECT * " werk datum uzeit bwart
*      INTO CORRESPONDING FIELDS OF TABLE it_hist
*      FROM objk
*     INNER JOIN ser03
*        ON     objk~obknr EQ ser03~obknr
*     INNER JOIN mseg
*        ON    ser03~mblnr EQ mseg~mblnr
*     WHERE     objk~equnr EQ it_eq-equnr
*       AND     objk~taser EQ 'SER03'.                  " to check
**       AND     mseg~parent_id EQ 0
**       AND     mseg~sobkz EQ space
**       AND     mseg~shkzg EQ 'S'.
*
*  SORT it_hist BY werk datum uzeit.
*  DELETE ADJACENT DUPLICATES FROM it_hist.
*
** Plants lead to sales office data through table YSE_RENT_DEPOT
*  LOOP AT it_hist.
*    READ TABLE it_depots WITH KEY werks = it_hist-werk.
*    it_hist-werk = it_depots-vkbur.       " hijack plant field for depot
*    MODIFY it_hist.
*  ENDLOOP.
*
** Note: Time is not checked in following loop, only dates. The
**       time code is only there to help sort the records.
**       0-days intervals will be deleted later on. -> to do
*
** Check if at least one installment record
*  DESCRIBE TABLE it_hist LINES lv_lines.
*  IF lv_lines > 0.
**   Run through all historical installments
*    LOOP AT it_hist
*      WHERE bwart EQ lc_intoyard
*         OR bwart EQ lc_outayard.
*
**     Record before start of selected period
*      IF it_hist-datum < gv_start.
**       If this is a start record
*        IF it_hist-bwart = lc_intoyard.
**         Store actual data for next entry
*          lv_start = gv_start.
*          lv_prev_vkbur = it_hist-werk.
*        ELSE.  " datum < gv_start / end record
**         Clear previous start, since equipment is no longer there
*          CLEAR lv_start.
*          CLEAR lv_prev_vkbur.
*        ENDIF.
*      ELSE.  " datum > gv_start
**       Record within selected period
*        IF it_hist-datum <= gv_end.
**         If this is a start record
*          IF it_hist-bwart = lc_intoyard.
**           Store actual data for next entry
*            lv_start = gv_start.
*            lv_prev_vkbur = it_hist-werk.
*          ELSE.   " lv_start > gv_start / lv_start < gv_end / end record
**           If this is not the first record, create an entry up to now
*            IF NOT lv_start IS INITIAL.
*              it_yard-angdt = lv_start.
*              it_yard-bnddt = it_hist-datum - 1.
**              it_yard-vkorg = yse_rent_depot-vkorg.
*              it_yard-vkbur = it_hist-werk.
*              APPEND it_yard.
*            ENDIF.
**           Clear previous start data
*            CLEAR lv_start.
*            CLEAR lv_prev_vkbur.
*          ENDIF.  " start or end record
**       Record after selected period
*        ELSE.
**         Note: Whether this is a start or an end record does not matter
**               since it will end the last important interval to us.
**               The loop has to be interupted.
*          EXIT.
*        ENDIF.    " gv_end < it_hist-datum > gv_end
*      ENDIF.    " gv_start < it_hist-datum > gv_start
*    ENDLOOP.  " it_hist
*
**   Tie up 'open' records
*    IF NOT lv_start IS INITIAL
*       AND lv_start <= gv_end.
**     Create one last record
*      it_yard-angdt = lv_start.
*      it_yard-bnddt = gv_end.
**      it_yard-vkorg = yse_rent_depot-vkorg.
*      it_yard-vkbur = lv_prev_vkbur.     " it_hist-werk.
*      APPEND it_yard.
*    ENDIF.    " tie up 'open' records.
*  ENDIF.    " lv_lines > 0
*
** Clean up contract records.
**  DELETE it_yard WHERE vkbur IS INITIAL.

*ENDFORM.  " get_yard_history


************************************************************************
* Form                 : CALC_DERIVATES                                *
************************************************************************
* Description          : Based on tables it_cont with contract data,   *
*                        and it_yard with yard data, the it_lines is   *
*                        extended with a line per equipment/depot      *
*                        combination with non-zero values.             *
************************************************************************
FORM CALC_DERIVATES.

  DATA:  LV_FIRST      TYPE C,
         LV_PREV_END   TYPE DATS,
         LV_FOUND      TYPE C,
         LV_INDEX      TYPE SY-TABIX,
         LV_DZTOT      TYPE P,
         LV_DATE       TYPE DATS.

**Initialize the main output table
*  REFRESH IT_LINES.

* Store end date of previous interval
  LV_PREV_END = GV_START - 1.
  CLEAR LV_DZTOT.

* Sort the contract list primary by depot
* and secondary by contract start date
  SORT IT_CONT BY VKBUR ANGDT.

* Process equipment's contract records
  LOOP AT IT_CONT.
    CLEAR IT_LINES.             " clear header line.
*   Search if a line for this equipment/depot combination exists
    READ TABLE IT_LINES WITH KEY EQUNR = IT_EQ-EQUNR VKBUR = IT_CONT-VKBUR.
    LV_INDEX = SY-TABIX.
    IF SY-SUBRC = 0.
*     Modify the existing record
      IT_LINES-DZCON = IT_LINES-DZCON + ( IT_CONT-BNDDT - IT_CONT-ANGDT + 1 ).
*     Add to total days for this equipment
      LV_DZTOT = LV_DZTOT + ( IT_CONT-BNDDT - IT_CONT-ANGDT + 1 ).
*AIR22188   10.07.2007
*      CLEAR IT_LINES-DZDEP.
*AIR22188   10.07.2007

      MODIFY IT_LINES INDEX LV_INDEX.
    ELSE.
*     Create a new equipment/depot record.
      IT_LINES-EQUNR = IT_EQ-EQUNR.
      IT_LINES-VKORG = IT_CONT-VKORG.
      IT_LINES-VKBUR = IT_CONT-VKBUR.
      IT_LINES-DZCON = IT_CONT-BNDDT - IT_CONT-ANGDT + 1.
*     Add to total days for this equipment
      LV_DZTOT = LV_DZTOT + ( IT_CONT-BNDDT - IT_CONT-ANGDT + 1 ).
*AIR22188   10.07.2007
*      CLEAR IT_LINES-DZDEP.
*AIR22188   10.07.2007
*
      APPEND IT_LINES.
    ENDIF.
    CLEAR IT_CONT.
  ENDLOOP.  " it_cont




*====================================
*Up to this point the contract have been added to IT_LINES
* Fill in gaps of the month with depot location
  LV_DATE = GV_START.
  WHILE LV_DATE <= GV_END.    " it_sme-angdt.
*   Check exiting contract intervals
*We must check for each day of the month if it is in a contract, if so
*then leave alone
    CLEAR IT_SME.
    LOOP AT IT_SME
           WHERE ANGDT <= LV_DATE AND
                 BNDDT >= LV_DATE.
    ENDLOOP.
    IF SY-SUBRC = 0.
*This day the equipment was still in a contract
*Advance the date until after the validity of the contract to save time
      LV_DATE = IT_SME-BNDDT + 1.
    ELSE.
*     Get the location of the equipment that day
      READ TABLE IT_LOC WITH KEY EQUNR = IT_EQ-EQUNR
                                 DATUM = LV_DATE.
*     Note: there should be one for each day but test anyway
      IF SY-SUBRC = 0.
*       Get corresponding sales org and office
        READ TABLE IT_DEPOTS WITH KEY WERKS = IT_LOC-B_WERK.
        IF SY-SUBRC = 0.
*         Check if an entry exists already
          READ TABLE IT_LINES WITH KEY EQUNR = IT_EQ-EQUNR
                                       VKORG = IT_DEPOTS-VKORG
                                       VKBUR = IT_DEPOTS-VKBUR.
*                                       DZCON = '  0'.

          IF SY-SUBRC = 0.
*           Inclease the depot with one day
            IT_LINES-DZDEP = IT_LINES-DZDEP + 1.
*AIR22188   10.07.2007
*            CLEAR IT_LINES-DZCON.
*AIR22188   10.07.2007
            MODIFY TABLE IT_LINES.
          ELSE.
*           Create a new entry
            IT_LINES-EQUNR = IT_EQ-EQUNR.
            IT_LINES-VKORG = IT_DEPOTS-VKORG.
            IT_LINES-VKBUR = IT_DEPOTS-VKBUR.
            IT_LINES-DZDEP = 1.
*AIR22188   10.07.2007
            CLEAR IT_LINES-DZCON.
*AIR22188   10.07.2007

            APPEND IT_LINES.
          ENDIF.
        ENDIF.  " it_depots
      ENDIF.
*     Go on with next day
      LV_DATE = LV_DATE + 1.
    ENDIF.     " contract interval exists or not
  ENDWHILE.  " lv_date

*--------------------------------
*Count the number of days found for this equipment and use this as a base to
*calculate the percentage on
*--------------------------------

  CLEAR V_TOT_DAYS.
  LOOP AT IT_LINES
       WHERE EQUNR EQ IT_EQ-EQUNR.
    V_TOT_DAYS = V_TOT_DAYS + ( IT_LINES-DZDEP + IT_LINES-DZCON ).
  ENDLOOP.
*--------------------------------
*Now we have the corect number of line in the table, time to calculate the % of each
*--------------------------------
data: v_peral(13) type c.
  IF NOT V_TOT_DAYS IS INITIAL.
    LOOP AT IT_LINES
             WHERE EQUNR EQ IT_EQ-EQUNR.
     IT_LINES-PERAL = ( IT_LINES-DZDEP + IT_LINES-DZCON ) / V_TOT_DAYS * 100.
*CALL FUNCTION 'HR_NZ_ROUNDING_DECIMALS'
*  EXPORTING
*    VALUE_IN                       = it_lines-peral
*   CONV_DEC                       = 2
* IMPORTING
*   VALUE_OUT                      = it_lines-peral
* EXCEPTIONS
*   NO_ROUNDING_REQUIRED           = 1
*   DECIMALS_GREATER_THAN_10       = 2
*   ROUNDING_ERROR                 = 3
*   OTHERS                         = 4
*          .
*IF SY-SUBRC <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*ENDIF.

*      clear v_peral.
*      write it_lines-peral to v_peral decimals 2.
*      move v_peral to it_lines-peral.
      modify it_lines.
    ENDLOOP.
  ENDIF.


*  LOOP AT it_yard.
*    CLEAR it_lines.
**   Search if a line for this equipment/depot combination exists
*    READ TABLE it_lines WITH KEY equnr = it_eq-equnr vkbur = it_yard-vkbur.
*    lv_index = sy-tabix.
*    IF sy-subrc = 0.
**     Modify the existing record
*      it_lines-dzdep = it_lines-dzdep + ( it_yard-bnddt - it_yard-angdt + 1 ).
**     Add to total days for this equipment
*      lv_dztot = lv_dztot + ( it_yard-bnddt - it_yard-angdt + 1 ).
*      MODIFY it_lines INDEX lv_index.
*    ELSE.
**     Create a new equipment/depot record.
*      it_lines-equnr = it_eq-equnr.
*      it_lines-vkorg = it_yard-vkorg.
*      it_lines-vkbur = it_yard-vkbur.
*      it_lines-dzdep = it_yard-bnddt - it_yard-angdt + 1.
**     Add to total days for this equipment
*      lv_dztot = lv_dztot + ( it_yard-bnddt - it_yard-angdt + 1 ).
*      APPEND it_lines.
*    ENDIF.
*  ENDLOOP.  " it_yard

* Calculate revenue and COS by allocation percentage
  LOOP AT IT_LINES
    WHERE EQUNR EQ IT_EQ-EQUNR.
*   Store table index for modifying record
    LV_INDEX = SY-TABIX.
    LOOP AT IT_COS4
      WHERE EQUNR EQ IT_LINES-EQUNR
      AND   VKBUR EQ IT_LINES-VKBUR.
      READ TABLE IT_COS3 WITH KEY PAOBJNR = IT_COS4-PAOBJNR.
      IF SY-SUBRC = 0.
        IT_LINES-VREVU = IT_LINES-VREVU + IT_COS3-VV100001.
*        it_lines-vdepr = it_lines-vdepr + it_cos3-vv130001.
        IT_LINES-VSERV = IT_LINES-VSERV   + IT_COS3-VV200001 + IT_COS3-VV300001
                       + IT_COS3-VV400001 + IT_COS3-VV500001 + IT_COS3-VV600001.
        IT_LINES-WAERS = IT_COS3-REC_WAERS.
      ENDIF.    " read it_cos3.
    ENDLOOP.                                                " it_cos4
*   Calculate equipment's depreciation cost
    READ TABLE IT_ILOA WITH KEY EQUNR = IT_EQ-EQUNR.
    IF SY-SUBRC = 0.
      LOOP AT IT_ANLP
        WHERE ANLN1 = IT_ILOA-ANLNR
          AND ANLN2 = IT_ILOA-ANLUN.
        IT_LINES-VDEPR = IT_LINES-VDEPR + IT_ANLP-NAFAZ.
        IT_LINES-WAERS = IT_ANLP-WAERS.
      ENDLOOP.    " it_anlp
    ENDIF.    " record found in it_iloa

*   Calculate percentile allocation based on # of days the equipment has been
*   somewhere and not relative to # of days in this month.
    IF NOT LV_DZTOT = 0.
*      IT_LINES-PERAL = ( IT_LINES-DZDEP + IT_LINES-DZCON ) / LV_DZTOT.  " / gv_days.
    ELSE.
*      IT_LINES-PERAL = 0.
    ENDIF.
    IT_LINES-ADEPR = IT_LINES-VDEPR * IT_LINES-PERAL.
*    IT_LINES-PERAL = IT_LINES-PERAL * 100.    " Percentile, for display reasons
*   Get equipment's other costs
    READ TABLE IT_DEPOTS WITH KEY VKBUR = IT_LINES-VKBUR.
    IF SY-SUBRC = 0.
      LOOP AT IT_COEP WHERE OBJNR EQ IT_DEPOTS-OBJNR.
        IT_LINES-VOTHR = IT_LINES-VOTHR + IT_COEP-WOGBTR.
      ENDLOOP.  " it_coep
      IF IT_LINES-WAERS IS INITIAL.
        IT_LINES-WAERS = IT_COEP-OWAER.
      ENDIF.
    ENDIF.
*   Invert costs
    IT_LINES-VDEPR = 0 - IT_LINES-VDEPR.
    IT_LINES-ADEPR = 0 - IT_LINES-ADEPR.
*   it_lines-vothr comes from COEP. Not sure if it needs to be inverted.
*   it_lines-vserv comes from CE31000 and is a positive writing.

*   Save changed record
    MODIFY IT_LINES INDEX LV_INDEX.
  ENDLOOP.  " it_lines
ENDFORM.    " calc_derivates



**************************************************************************
*** Form ALT_CALC                                                        *
**************************************************************************
*FORM alt_calc.
*
** Per equipment, order the plants together and the contracts together.
** Note: since B_WERK and KUNNR can be empty, the depot records will
**       be grouped before the contract records.
*  SORT it_loc BY equnr kunnr b_werk.
*
********************** start *****************************
** Each record in table YSE_LOC_EQUIP corresponds to one day's worth
** of equipment location, either in a contract or in a depot. This
** loop adds the days per equipment per location.
*
*  LOOP AT it_loc.
**   When no contract nor depot -> skip record.
*    IF it_loc-b_lager IS INITIAL AND
*       it_loc-kunnr IS INITIAL.
*      CONTINUE.
*    ENDIF.
**   When same date again, skip record
**   TODO
**   When equipment in contract
*    IF NOT it_loc-kunnr IS INITIAL.
**     Search corresponding contract (loop until first entry)
*      LOOP AT it_sme
*        WHERE kunnr EQ it_loc-kunnr
*        AND   angdt LE it_loc-datum
*        AND   bnddt GE it_loc-datum.
*        EXIT.
*      ENDLOOP.
*
**     If found...
*      IF sy-subrc = 0.
**       copy contract data
*        wa_lines-equnr = it_sme-zzequnr.
*        wa_lines-vkorg = it_sme-vkorg.
*        wa_lines-vkbur = it_sme-vkbur.
*        wa_lines-dzcon = 1.
*      ELSE.
**       else get the depot from the issuing plant
*        READ TABLE it_depots WITH KEY werks = it_loc-b_werk.
*        IF sy-subrc = 0.
*          wa_lines-equnr = it_loc-equnr.
*          wa_lines-vkorg = it_depots-vkorg.
*          wa_lines-vkbur = it_depots-vkbur.
*        ENDIF.
*      ENDIF.
*
**   When equipment in depot
*    ELSE.
**     Get the corresponding depot
*      READ TABLE it_depots WITH KEY werks = it_loc-b_werk.
*      IF sy-subrc <> 0.
*        wa_lines-equnr = it_sme-zzequnr.
*        wa_lines-vkorg = it_sme-vkorg.
*        wa_lines-vkbur = it_sme-vkbur.
*        wa_lines-dzdep = 1.
*      ELSE.
**     Unassigned depot?
*      ENDIF.
*    ENDIF.
*
**   Update output table
*    READ TABLE it_lines WITH KEY equnr = wa_lines-equnr
*                           vkorg = wa_lines-vkorg
*                           vkbur = wa_lines-vkbur.
**   If found...
*    IF sy-subrc = 0.
*      IF NOT wa_lines-dzdep IS INITIAL.
*        wa_lines-dzdep = it_lines-dzdep + 1.
*      ELSE.
*        wa_lines-dzcon = it_lines-dzcon + 1.
*      ENDIF.
**     update
*      MODIFY it_lines FROM wa_lines.
*    ELSE.
**     insert new entry.
*      INSERT wa_lines INTO it_lines.
*    ENDIF.
*  ENDLOOP.
*
********************* end ***************************

*  LOOP AT it_loc.
**   When no contract nor depot -> skip record.
*    IF it_loc-b_lager IS INITIAL AND
*       it_loc-kunnr IS INITIAL.
*      CONTINUE.
*    ENDIF.
**   When new equipment
*    IF it_loc-equnr <> gv_equnr.
*      CLEAR it_lines.
**     Create new equipment line.
*      it_lines-equnr = it_loc-equnr.
*      gv_equnr = it_loc-equnr.
**     For contract record
*      IF NOT it_loc-kunnr IS INITIAL.
**       Search for corresponding contract with same start date
*        READ TABLE it_sme WITH KEY kunnr = it_loc-kunnr
*                                   angdt = it_loc-datum.
*        IF sy-subrc <> 0.
**         or with same end date
*          READ TABLE it_sme WITH KEY kunnr = it_loc-kunnr
*                                     bnddt = it_loc-datum.
*          IF sy-subrc <> 0.
**           and else skip this record.
*            CONTINUE.
*          ENDIF.
*
*
***     For depot record
**      IF NOT it_loc-b_werk IS INITIAL.
**        it_lines-b_werk = it_loc-b_werk.
**        it_lines-dzdep = 1.
**      ELSE.
**        it_lines-kunnr = it_loc-kunnr.
**        it_lines-dzcon = 1.
**      ENDIF.
*      APPEND it_lines.
*    ELSE.
*      IF NOT it_loc-b_werk IS INITIAL.
**       When processing new depot
*        IF it_loc-b_werk <> gv_b_werk.
**         Create a new entry
*          it_lines-equnr = it_loc-equnr.
*          it_lines-b_werk = it_loc-b_werk.
*          gv_b_werk = it_loc-b_werk.
*          it_lines-dzdep = 1.
*          APPEND it_lines.
*        ELSE.
**         Increase days in this depot
*          it_lines-dzdep = it_lines-dzdep + 1.
*          MODIFY it_lines.
*        ENDIF.  " new b_werk
*      ELSE.
**       Fetch corresponding contract
*        READ TABLE it_sme WITH KEY kunnr = it_loc-kunnr
*                                   angdt <= it_loc-datum
*                                   bnddt >= it_loc-datum.
*        IF sy-subrc <> 0.
*          CONTINUE.
*        ENDIF.
**       When processing new contract
*        IF it_sme-vbeln <> gv_vbeln AND
*           it_sme-posnr <> gv_posnr AND
*           it_loc-kunnr <> gv_kunnr.
**         Search for existing line
*          READ TABLE it_lines WITH KEY vkorg = it_sme-vkorg
*                                       vkbur = it_sme-vkbur.
*          IF sy-subrc <> 0.
**           Create a new entry
*            it_lines-equnr = it_loc-equnr.
*            it_lines-kunnr = it_loc-kunnr.
*            gv_vbeln = it_sme-vbeln.
*            gv_posnr = it_sme-posnr.
*            gv_kunnr = it_loc-kunnr.
*            it_lines-dzcon = 1.
*            APPEND it_lines.
*          ELSE.
**           Increase days in the contract's line
*            it_lines-dzcon = it_lines-dzcon + 1.
*            MODIFY it_lines.
*          ENDIF.
*        ENDIF.    " new kunnr
*      ENDIF.    " b_werk or kunnr
*    ENDIF.    " new equnr
*  ENDLOOP.  " it_loc
*
*  LOOP AT it_lines.
*    IF NOT it_lines-b_werk IS INITIAL.
**     Fetch corresponding depot
*      READ it_depot WITH KEY werks = it_lines-b_werk.
*      IF sy-subrc = 0.
*        it_lines-vkorg = it_depot-vkorg.
*        it_lines-vkbur = it_depot-vkbur.
*      ENDIF.
*    ELSE.
**     Fetch corresponding contract
*      SELECT vkorg vkbur
*        INTO (it_lines-vkorg it_lines-vkbur)
*        FROM yse_rent_sme
*        WHERE equnr = it_lines-equnr
*        AND   erdat = it_lines-datum
*    ENDIF.
*
*  ENDLOOP.  " it_lines.
*ENDFORM.

*************************************************************************
** Form BUILD_ALV                                                       *
*************************************************************************
FORM BUILD_ALV.

  REFRESH: IT_FIELDCAT.

  CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
    EXPORTING
      I_BUFFER_ACTIVE  = ' '
      I_STRUCTURE_NAME = 'YSE_REN_ALV_COPA_ALLOC'  " 'YSE_REN_ALV_DEPREC_ALLOC'
    CHANGING
      CT_FIELDCAT      = IT_FIELDCAT.

  LOOP AT IT_FIELDCAT ASSIGNING <FIELDCAT>.
    CASE <FIELDCAT>-FIELDNAME.
      WHEN  'EQUNR'.
        <FIELDCAT>-COLTEXT   = 'Equipment'(001).
        <FIELDCAT>-TOOLTIP   = 'Equipment number'(002).
        <FIELDCAT>-OUTPUTLEN = 15.
      WHEN  'VKORG'.
        <FIELDCAT>-COLTEXT = 'Sales org.'(003).
        <FIELDCAT>-TOOLTIP = 'Sales organization'(004).
        <FIELDCAT>-OUTPUTLEN = 4.
      WHEN  'VKBUR'.
        <FIELDCAT>-COLTEXT = 'Sales off.'(005).
        <FIELDCAT>-TOOLTIP = 'Sales office'(006).
        <FIELDCAT>-OUTPUTLEN = 4.
      WHEN  'DZDEP'.
        <FIELDCAT>-COLTEXT = 'Depot'(007).
        <FIELDCAT>-TOOLTIP = 'Days in depot'(008).
        <FIELDCAT>-OUTPUTLEN = 6.
      WHEN  'DZCON'.
        <FIELDCAT>-COLTEXT = 'Contract'(009).
        <FIELDCAT>-TOOLTIP = 'Days in contract'(010).
        <FIELDCAT>-OUTPUTLEN = 6.
      WHEN  'PERAL'.
        <FIELDCAT>-COLTEXT = 'Perc. alloc'(011).
        <FIELDCAT>-TOOLTIP = 'Percentage allocation'(012).
        <FIELDCAT>-OUTPUTLEN = 8.
      WHEN  'VREVU'.
        <FIELDCAT>-COLTEXT = 'Base rev'(013).
        <FIELDCAT>-TOOLTIP = 'Revenue'(014).
        <FIELDCAT>-OUTPUTLEN = 9.
      WHEN  'VDEPR'.
        <FIELDCAT>-COLTEXT = 'Base deprec'(015).
        <FIELDCAT>-TOOLTIP = 'Base Depreciation Costs'(016).
        <FIELDCAT>-OUTPUTLEN = 9.
      WHEN  'VSERV'.
        <FIELDCAT>-COLTEXT = 'Base serv'(017).
        <FIELDCAT>-TOOLTIP = 'Service Costs'(018).
        <FIELDCAT>-OUTPUTLEN = 9.
      WHEN  'VOTHR'.
        <FIELDCAT>-COLTEXT = 'Other Costs'(019).
        <FIELDCAT>-TOOLTIP = 'Other Costs'(020).
        <FIELDCAT>-OUTPUTLEN = 9.
      WHEN  'ADEPR'.
        <FIELDCAT>-COLTEXT = 'Alloc Depr'(021).
        <FIELDCAT>-TOOLTIP = 'Allocated Depreciation Costs'(022).
        <FIELDCAT>-OUTPUTLEN = 9.
      WHEN  'WAERS'.
        <FIELDCAT>-COLTEXT = 'Curr'(023).
        <FIELDCAT>-TOOLTIP = 'Currency'(024).
        <FIELDCAT>-OUTPUTLEN = 4.
    ENDCASE.
  ENDLOOP.

*  GS_LAYOUT-NO_TOOLBAR = GC_TRUE.
  GS_LAYOUT-SEL_MODE   = 'B'.        " single row selectable
  CALL METHOD OBJ_ALV->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      I_STRUCTURE_NAME              = 'YSE_REN_ALV_COPA_ALLOC'
      IS_LAYOUT                     = GS_LAYOUT
    CHANGING
      IT_OUTTAB                     = IT_LINES[]
      IT_FIELDCATALOG               = IT_FIELDCAT
    EXCEPTIONS
      INVALID_PARAMETER_COMBINATION = 1
      PROGRAM_ERROR                 = 2
      TOO_MANY_LINES                = 3
      OTHERS                        = 4.

  IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*     WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.
ENDFORM.                    "build_alv


************************************************************************
* Form                 : PROCESS_EQUIPMENT                             *
************************************************************************
* Description          : Obtains a table with functional locations for *
*                        a given period of 1 month.                    *
*                        This location can either be at a rental site  *
*                        or at a customer's site.                      *
************************************************************************
FORM PROCESS_EQUIPMENT
         TABLES IT_RESULT  STRUCTURE IT_CONT
         USING A_EQUNR
               A_YEAR
               A_PERIOD.

  CONSTANTS: LC_CONT  TYPE C VALUE 'C'.

  DATA: IT_HIST LIKE EQUI_INSTALL_DATA OCCURS 0 WITH HEADER LINE,
        IT_SME  LIKE YSE_RENT_SME      OCCURS 0 WITH HEADER LINE.

  DATA: LV_START  TYPE DATS,     " month's start
        LV_END    TYPE DATS,     " month's end
        LV_DAYS   TYPE P,        " days in month
        LV_PREV   TYPE DATS,     " previously read date
        LV_TABIX  TYPE SY-TABIX. " table index it_result

* Note: date calculation should be optimized: brought outside form
* Rectify month if necessary
  IF A_PERIOD < 10 AND
     A_PERIOD(1) <> '0'.
    A_PERIOD+1(1) = '0'.
    SHIFT A_PERIOD CIRCULAR.
  ENDIF.

* Build start date
  CONCATENATE A_YEAR
              A_PERIOD
              '01'
         INTO LV_START.

* Count number of days in this month
  CALL FUNCTION 'HR_E_NUM_OF_DAYS_OF_MONTH'
    EXPORTING
      P_FECHA        = LV_START
    IMPORTING
      NUMBER_OF_DAYS = LV_DAYS.

* Make days a global variable
  GV_DAYS = LV_DAYS.

* Build end date
  LV_END = LV_START + LV_DAYS - 1.

* Get the equipment's functional locations
  CALL FUNCTION 'EQUIPMENT_GET_INSTALL_HISTORY'
    EXPORTING
      ID_EQUNR   = A_EQUNR
    TABLES
      ET_HISTORY = IT_HIST.
*   EXCEPTIONS
*     EQUI_NOT_FOUND       = 1
*     OTHERS               = 2

*  IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*  ENDIF.

  DELETE IT_HIST WHERE TPLNR = SPACE.
  SORT IT_HIST BY DATDN ASCENDING.

  LV_PREV = LV_START - 1.
* If no locations, make one empty record
  IF IT_HIST[] IS INITIAL.
    IT_RESULT-ANGDT = LV_START.
    IT_RESULT-BNDDT = LV_END.
    APPEND IT_RESULT.
  ELSE.
*   Run through locations and build overview for selected period.
*   This contains the periods the equipment was in depot.
    LOOP AT IT_HIST.
*     creation date before start period -> change first record
      IF IT_HIST-DATDN < LV_START.
        IT_RESULT-ANGDT = LV_START.
        IT_RESULT-TPLNR = IT_HIST-TPLNR.
      ENDIF.

*     Creation date within period
      IF IT_HIST-DATDN GE LV_START AND
        IT_HIST-DATDN GT LV_PREV  AND
        IT_HIST-DATDN LE LV_END.
        IF IT_RESULT-ANGDT IS INITIAL.
          IT_RESULT-ANGDT = LV_PREV + 1.
        ENDIF.
        IT_RESULT-BNDDT = IT_HIST-DATDN.
        IT_RESULT-TPLNR = IT_HIST-TPLNR.
        LV_PREV = IT_RESULT-BNDDT.
        APPEND IT_RESULT.
        CLEAR IT_RESULT.
      ENDIF.

*     Creation date after period
      IF IT_HIST-DATDN > LV_END.
        IF IT_RESULT-ANGDT IS INITIAL.
          IT_RESULT-ANGDT = LV_PREV + 1.
        ENDIF.
        IF IT_RESULT-BNDDT IS INITIAL.
          IT_RESULT-BNDDT = LV_END.
          APPEND IT_RESULT.
        ENDIF.
      ENDIF.
    ENDLOOP.

*   Tie up loose ends (close 'open' periods)
    IF NOT IT_RESULT-ANGDT IS INITIAL
       AND IT_RESULT-BNDDT IS INITIAL.
      IT_RESULT-BNDDT = LV_END.
      APPEND IT_RESULT.
    ELSEIF IT_HIST-DATDN < LV_END.
      IT_RESULT-ANGDT = LV_PREV + 1.
      IT_RESULT-BNDDT = LV_END.
      APPEND IT_RESULT.
    ENDIF.
  ENDIF.    " it_hist is initial

* Run through overview and add delta and sales data
  LOOP AT IT_RESULT.
    IF NOT IT_RESULT-FLAG = LC_CONT.
      LV_TABIX = SY-TABIX.
      IT_RESULT-DELTA = IT_RESULT-BNDDT - IT_RESULT-ANGDT + 1.
      IT_RESULT-PRCNT = IT_RESULT-DELTA * 100 / LV_DAYS.
      MODIFY IT_RESULT INDEX LV_TABIX.
*     If equipment is at rental company's yard
      SELECT SINGLE *
          INTO WA_DEPOT
          FROM YSE_RENT_DEPOT
         WHERE TPLNR = IT_RESULT-TPLNR.
      IF SY-SUBRC = 0.
        IT_RESULT-VKORG = WA_DEPOT-VKORG.
        IT_RESULT-VKBUR = WA_DEPOT-VKBUR.
        MODIFY IT_RESULT INDEX SY-TABIX.
      ELSE.
*       else if equipment is at a customer's site
        SELECT *
            FROM YSE_RENT_SME                           "#EC CI_NOFIRST
            INTO TABLE IT_SME
           WHERE ZZEQUNR EQ A_EQUNR           AND
                   AUART EQ 'ZQP'             AND
               ( ( ANGDT GT IT_RESULT-ANGDT   AND
                   ANGDT LT IT_RESULT-BNDDT )  OR
                 ( BNDDT GT IT_RESULT-ANGDT   AND
                   BNDDT LT IT_RESULT-BNDDT )  OR
                 ( ANGDT LE IT_RESULT-ANGDT   AND
                   BNDDT GT IT_RESULT-BNDDT ) ).
        IF SY-SUBRC = 0.
*          Get rid of the 'false' entry and create a new entry
*          per contract item found for this equipment
          DELETE IT_RESULT INDEX LV_TABIX.
          LOOP AT IT_SME.
            CLEAR IT_RESULT.
            IF IT_SME-ANGDT < LV_START.
              IT_RESULT-ANGDT = LV_START.
            ELSE.
              IT_RESULT-ANGDT = IT_SME-ANGDT.
            ENDIF.
            IF IT_SME-BNDDT > LV_END.
              IT_RESULT-BNDDT = LV_END.
            ELSE.
              IT_RESULT-BNDDT = IT_SME-BNDDT.
            ENDIF.
            IT_RESULT-DELTA = IT_RESULT-BNDDT - IT_RESULT-ANGDT + 1.
            IT_RESULT-PRCNT = IT_RESULT-DELTA * 100 / LV_DAYS.
            IT_RESULT-VKORG = IT_SME-VKORG.
            IT_RESULT-VKBUR = IT_SME-VKBUR.
            IT_RESULT-FLAG = LC_CONT.
            INSERT IT_RESULT INDEX LV_TABIX.
          ENDLOOP.  " it_sme
        ENDIF.    " found contracts
      ENDIF.    " found functional location in depot
    ENDIF.    " not customer
  ENDLOOP.  " it_result

  LV_PREV = LV_START - 1.
* Clean up overlapping records
  LOOP AT IT_RESULT.
    IF IT_RESULT-ANGDT LE LV_PREV.
      IF NOT IT_RESULT-FLAG = LC_CONT.
        IT_RESULT-ANGDT = LV_PREV + 1.
        IT_RESULT-DELTA = IT_RESULT-BNDDT - IT_RESULT-ANGDT + 1.
        IT_RESULT-PRCNT = IT_RESULT-DELTA * 100 / LV_DAYS.
      ELSE.
*       Re-read previous record
        LV_TABIX = SY-TABIX - 1.
        LV_PREV = IT_RESULT-ANGDT - 1.
        READ TABLE IT_RESULT INDEX LV_TABIX.
        IT_RESULT-BNDDT = LV_PREV.
        IT_RESULT-DELTA = IT_RESULT-BNDDT - IT_RESULT-ANGDT + 1.
        IT_RESULT-PRCNT = IT_RESULT-DELTA * 100 / LV_DAYS.
        MODIFY IT_RESULT INDEX LV_TABIX.
*       Re-read next record
        LV_TABIX = LV_TABIX + 1.
        READ TABLE IT_RESULT INDEX LV_TABIX.
      ENDIF.
    ENDIF.
    LV_PREV = IT_RESULT-BNDDT.
  ENDLOOP.   " clean up overlapping records
ENDFORM.  " process_equipment


************************************************************************
* Form                 : SAVE_DATA                                     *
************************************************************************
* Description          : Saves the distribution data to a table to be  *
*                        used in P/L per Depot report.                 *
************************************************************************
FORM SAVE_DATA.

  DATA   BEGIN OF WA_YSE_RENT_COPA.
          INCLUDE STRUCTURE YSE_RENT_COPA.
  DATA   END OF WA_YSE_RENT_COPA.

* Save every line that has at least one non-zero figure
  LOOP AT IT_LINES.
*   Search for existing record
    SELECT SINGLE *
        FROM YSE_RENT_COPA
       WHERE EQUNR EQ IT_LINES-EQUNR
         AND VKORG EQ IT_LINES-VKORG
         AND VKBUR EQ IT_LINES-VKBUR
         AND FYEAR EQ P_FYEAR
         AND FPERD EQ P_FPERD.

*   Overwrite data
    WA_YSE_RENT_COPA-EQUNR = IT_LINES-EQUNR.
    WA_YSE_RENT_COPA-BUKRS = P_BUKRS.
    WA_YSE_RENT_COPA-VKORG = IT_LINES-VKORG.
    WA_YSE_RENT_COPA-VKBUR = IT_LINES-VKBUR.
    WA_YSE_RENT_COPA-FYEAR = P_FYEAR.
    WA_YSE_RENT_COPA-FPERD = P_FPERD.
    WA_YSE_RENT_COPA-PERAL = IT_LINES-PERAL.
    WA_YSE_RENT_COPA-VREVU = IT_LINES-VREVU.
    WA_YSE_RENT_COPA-ADEPR = IT_LINES-ADEPR.
    WA_YSE_RENT_COPA-VSERV = IT_LINES-VSERV.
    WA_YSE_RENT_COPA-VOTHR = IT_LINES-VOTHR.
    WA_YSE_RENT_COPA-WAERS = IT_LINES-WAERS.

*   If exists
    IF SY-SUBRC = 0.
*     Overwrite
      MODIFY YSE_RENT_COPA FROM WA_YSE_RENT_COPA.
    ELSE.
*     Create new record
      INSERT YSE_RENT_COPA FROM WA_YSE_RENT_COPA.
    ENDIF.
  ENDLOOP.  " it_lines
ENDFORM.  " save_data

*Text symbol text

*S01:Selection
*Selection text
*P_BUKRS:        Company code
*P_FPERD:        Fiscal period
*P_FYEAR:        Fiscal year
*S_EQUNR:        Equipment
