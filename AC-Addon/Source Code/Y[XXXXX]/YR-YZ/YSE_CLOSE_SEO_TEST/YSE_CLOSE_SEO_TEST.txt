*----------------------------------------------------------------------*
* PROGRAM ID           : YSE_CLOSE_QUOT                                *
* PROGRAM TITLE        : Automatic closing of SEO                      *
*                        One Button                                    *
* AUTHOR               : Geert Rutten                                  *
* DATE                 : 21/05/2010                                    *
* DEVELOPMENT ID       : AIR21243                                      *
* CHANGE REQUEST NUMBER: CD1K956790                                    *
* PROGRAM DESCRIPTION  : Automatic closing of service orders           *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME            |CORRECTION NR| CHANGE REF#     *
*----------------------------------------------------------------------*
*MOD-001 |16/11/2010| Geert Rutten  | CD1K961024      | Additional     *
*                                                       Checks CR1670  *
*MOD-002 |24/05/2011| Geert Rutten  | CD1K965310      | Changes        *
*                                    for SEED + general ones CR1825    *
*MOD-003 |12/08/2011| Luc Mertens   | CD1K967201      | CR1825         *
*      - TECO should not be set when errors after previous actions     *
*MOD-004 |09/12/2011| Geert Rutten   | CD1K969205      |               *
*      - Exclude Mainworkcenters should be possible                    *
*MOD-005 |21/02/2012| Geert Rutten   | CD1K970474      |               *
*      - Handle FP Orders                                              *
*MOD-006 |04/05/2012| Geert Rutten   | CD1K971684      |               *
*      - Handle ZSM6 Orders                                              *
*----------------------------------------------------------------------*
REPORT yse_close_quot MESSAGE-ID yam_re  NO STANDARD PAGE HEADING
                                    LINE-SIZE 400.

TYPE-POOLS: slis.

TABLES: vbak, yse_close_act, yam_ctam_ccodes, aufk, yse_close_log, mseg, afru
* Begin of insert MOD-005
 ,afih.
* End of insert MOD-005
.

*-------------------------CONSTANTS-------------------------*
CONSTANTS : g_x VALUE 'X',
            g_s  VALUE 'S',
            c_color_green(4)    TYPE c VALUE 'C500', "Green intense/inverse off
            c_color_red(4)  TYPE c VALUE 'C600', "Lt blue intens/inverse off
            c_title(72) TYPE c VALUE 'Please give a reason to close quotation(s)',
            c_iw32          LIKE tstc-tcode   VALUE 'IW32',
            c_ko88          LIKE tstc-tcode   VALUE 'KO88',
            c_iw41          LIKE tstc-tcode   VALUE 'IW41',
* Begin of insert MOD-005
            c_vf01          LIKE tstc-tcode   VALUE 'VF01',
            c_manu(4)   TYPE c VALUE 'MANU',
* End of insert MOD-005
            c_i0046(5)       TYPE c VALUE 'I0046'.
CONSTANTS: seperator(1) TYPE c VALUE ',', " Delimeter or Seperator
           c_type_a         TYPE bapiret2-type     VALUE 'A',
           c_type_e         TYPE bapiret2-type     VALUE 'E',
           c_en             TYPE spras             VALUE 'E',
           period           TYPE tvarvc-low        VALUE 'SAP_SCMA_PERIOD',
           year             TYPE tvarvc-low        VALUE 'SAP_SCMA_FISC_YEAR'.
DATA:      gv_statprof     TYPE tj30t-stsma               " Stat. profile
                                 VALUE 'ZAM00001'.
*- VARIABLES----------------------------------------------------------


DATA : l_s_msg TYPE bal_s_msg,
       l_log_handle TYPE balloghndl,
       l_s_log      TYPE bal_s_log ,
       lt_logh      TYPE bal_t_logh,
       lv_mode(1)   TYPE c VALUE 'N',
       lv_vkorg     TYPE vkorg.

DATA: lv_text(200) TYPE c,
      g_text       LIKE t100-text,
      g_mstring(200)        TYPE c,
      lv_mstring(200)       TYPE c.

DATA: lv_delete TYPE c.

DATA: lv_matkl TYPE matkl.

DATA : i_bdcdata LIKE bdcdata OCCURS 0 WITH HEADER LINE,
       struct_bdcdata TYPE bdcdata.

DATA: gt_act TYPE TABLE OF yse_close_act WITH HEADER LINE.

* Begin of insert MOD-001
DATA : BEGIN OF i_aufm_check OCCURS 0,
       mblnr LIKE aufm-mblnr,
       mjahr LIKE aufm-mjahr,
       zeile LIKE aufm-zeile,
       aufnr LIKE aufm-aufnr,         " Service Order Number
       werks LIKE aufm-werks,         " Plant
*        lgort LIKE aufm-lgort,         " Storage Location
       matnr LIKE aufm-matnr,         " Material Number
       bwart LIKE aufm-bwart,         " Movement Type
       erfmg LIKE aufm-erfmg,         " Quantity
*        budat LIKE aufm-budat,         " posting date
    END OF i_aufm_check.

DATA : BEGIN OF i_afru_check OCCURS 0,
       rueck LIKE afru-rueck,
       rmzhl LIKE afru-rmzhl,
    END OF i_afru_check.

DATA: lv_lin_ch TYPE i.
* End of insert MOD-001
DATA: lv_index TYPE sy-tabix.
* Begin of insert MOD-005

DATA : es_equipment TYPE yscs_equipment.

DATA: BEGIN OF i_lines OCCURS 0.
        INCLUDE STRUCTURE tline.
DATA: END OF i_lines.

DATA: lv_ilart TYPE afih-ilart,
      lv_langu TYPE sy-langu,
      lv_lines TYPE i,
      lv_manu TYPE c,
      lv_stat(5) TYPE c.
DATA: lv_salord LIKE thead-tdname.
* End of insert MOD-005

TYPES :
    BEGIN OF gty_ch,
      ch(25) TYPE c,
    END OF gty_ch.


TYPES :
    BEGIN OF gty_vaplz,
      vaplz TYPE aufk-vaplz,
    END OF gty_vaplz.

DATA: gt_ch     TYPE TABLE OF gty_ch WITH HEADER LINE.
* Begin of insert MOD-005
DATA: gt_ch2     TYPE TABLE OF gty_ch WITH HEADER LINE.
* End of insert MOD-005

DATA : BEGIN OF i_messtab OCCURS 0.
        INCLUDE STRUCTURE bdcmsgcoll.
DATA : END OF i_messtab.

DATA: gt_fieldcat         TYPE slis_t_fieldcat_alv,
      g_events_tab        TYPE slis_t_event,
      h_event             TYPE slis_alv_event,
      g_form_user_command TYPE slis_formname VALUE 'USER_COMMAND_L',
      g_form_set_pf_stat  TYPE slis_formname VALUE 'SET_PF_STAT_L',
      g_layout            TYPE slis_layout_alv,
      gt_sort             TYPE slis_t_sortinfo_alv,
      g_repid             LIKE ceddb-program,
      gv_bukrs2           LIKE vbak-vkorg,
      ctamflag(1)         TYPE c,
      fields              LIKE sval OCCURS 0 WITH HEADER LINE,
      g_index LIKE sy-tabix,
      lv_answer,
      gv_index LIKE sy-tabix.

DATA: BEGIN OF gt_seo OCCURS 0,
        aufnr LIKE aufk-aufnr,
        objnr LIKE aufk-objnr,
        bemot LIKE aufk-bemot,
        auart LIKE aufk-auart,
        kdauf LIKE aufk-kdauf,
        kdpos LIKE aufk-kdpos,
        vkorg LIKE pmsdo-vkorg,
        bukrs LIKE aufk-bukrs,
        qmnum LIKE afih-qmnum,
* Begin of insert MOD-005
        kunum LIKE afih-kunum,
        kdgrp LIKE knvv-kdgrp,
        phas2 LIKE aufk-phas2,
        faktf LIKE pmsdo-faktf,
        netwr LIKE vbak-netwr,
* End of insert MOD-005
        scenar(255) TYPE c,
        checks TYPE c,
        actions TYPE c,
        ch(255) TYPE c,
        act(255) TYPE c,
        selected,
*        pm_selected TYPE pm_selected,
        flag,
        color(4) TYPE c,
* Begin of insert MOD-002
        vaplz  TYPE aufk-vaplz,
* End of insert Mod-002
* Begin of insert MOD-005
        ordpwlab TYPE c,
* End of insert MOD-005
      END OF gt_seo.

DATA: BEGIN OF h_status_tab OCCURS 30.
        INCLUDE STRUCTURE jstat.
DATA: END OF h_status_tab.

DATA: h_stat_flag,
      h_stat_flag2,
      h_stat_flag3,
      lv_objnr_ord LIKE aufk-objnr,
      lv_objnr_qmnum LIKE viqmel-objnr,
      lv_check TYPE c.

* Output list
DATA: BEGIN OF gt_outputlist OCCURS 0,
      qmnum LIKE vbak-qmnum,
      nstat(8) TYPE c,
      aufnr LIKE vbak-aufnr,
      ostat(8) TYPE c,
      vbeln LIKE vbak-vbeln,
      posnr LIKE vbap-posnr,
      matnr LIKE mara-matnr,
      maktx LIKE makt-maktx,
      abgru(20) TYPE c,
      col   TYPE c,
      END OF gt_outputlist.
DATA: lv_name2 TYPE name2,
      lv_sernr TYPE gernr,
      lv_eqktx TYPE ktx01,
      lv_bstkd TYPE bstkd.
DATA: gt_yse_close_log TYPE TABLE OF yse_close_log WITH HEADER LINE,
      it_vaplz         TYPE TABLE OF gty_vaplz WITH HEADER LINE,
* Begin of insert MOD-002
      lv_ok TYPE c.
* End of insert MOD-002

DATA: lv_per      TYPE tvarvc-low,
      lv_yr       TYPE tvarvc-low,
      lv_cnf_flag TYPE c,
* Begin of insert MOD-005
      lv_inv_flag TYPE c.

DATA:  lv_adrnr TYPE iloa-adrnr,
       lv_quot TYPE vbeln,
       lv_pwlabex TYPE c.

CONSTANTS: c_eqart(9) TYPE c VALUE 'EQUIPMENT',
          c_99991231  LIKE sy-datum     VALUE '99991231'.


* End of insert MOD-005

* Begin of insert MOD-002
DATA: lv_vaplz TYPE aufk-vaplz.



* End of insert MOD-002
*- SELECTION SCREEN---------------------------------------------------
SELECTION-SCREEN: BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
SELECT-OPTIONS: s_vkorg  FOR vbak-vkorg,
                s_bemot  FOR aufk-bemot,
                s_bemotc FOR aufk-bemot,
* Begin of insert MOD-005
                s_ilart  FOR afih-ilart,
* End of insert MOD-005
                s_auart  FOR aufk-auart,
                s_aufnr  FOR aufk-aufnr,
* Begin of change MOD-004
                s_vaplz  FOR aufk-vaplz NO INTERVALS.
* PARAMETERS:    p_vaplz  TYPE aufk-vaplz.
* End of change MOD-004
SELECTION-SCREEN: END OF BLOCK b1.

*
**.................. Selection screen validations...................... *
*AT SELECTION-SCREEN ON p_vkorg.
*
*  AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
*           ID 'VKORG' FIELD p_vkorg
*           ID 'VTWEG' FIELD p_vtweg
*           ID 'SPART' FIELD p_spart
*           ID 'ACTVT' FIELD '03'.
*  IF sy-subrc <> 0.
*    MESSAGE e001(00) WITH text-e01 p_vkorg.
*  ENDIF.

*-INITIALIZATION--------------------------------------------------------
INITIALIZATION.
  PERFORM log_create.


*-START OF SELECTION----------------------------------------------------
START-OF-SELECTION.





* first select orders

  SELECT a~aufnr a~bemot a~auart a~kdauf a~kdpos a~bukrs a~objnr b~vkorg
* Begin of insert MOD-002
    a~vaplz
* End of insert MOD-002
* Begin of insert MOD-005
    a~phas2
    b~faktf
* End of insert MOD-005
    INTO CORRESPONDING FIELDS OF TABLE gt_seo
    FROM aufk AS a
    INNER JOIN pmsdo AS b
      ON a~objnr = b~objnr
    WHERE
       a~bemot IN s_bemot AND
       a~auart IN s_auart AND
       a~aufnr IN s_aufnr AND
       b~vkorg IN s_vkorg AND
       a~phas3 <> 'X'.

  SELECT SINGLE low FROM tvarvc INTO lv_per
   WHERE name = period.
  SELECT SINGLE low FROM tvarvc INTO lv_yr
   WHERE name = year.
* Begin of insert MOD-001
* Check for each if order confirmations, goods movements do not have accounting indicator which is excluded on the selection screen
  LOOP AT gt_seo.

    CLEAR lv_delete.
* Begin of insert MOD-002
* CTAM or Seed
    SELECT SINGLE * FROM yam_ctam_ccodes
          WHERE bukrs = gt_seo-bukrs.
    IF NOT sy-subrc = 0.
      ctamflag = 'N'.
    ELSE.
      ctamflag = 'Y'.
    ENDIF.


* Begin of insert MOD-005
*    IF gt_seo-bemot = 'FP' OR ( gt_seo-bemot = '1E' AND gt_seo-faktf = '01' ).
* Check if Manual status is active.. if active skip order
    IF ctamflag = 'Y'.
      lv_stat = 'E0024'.
    ELSE.
      lv_stat = 'E0021'.
    ENDIF.

    REFRESH: h_status_tab.

    CALL FUNCTION 'STATUS_READ'
      EXPORTING
        objnr            = gt_seo-objnr
        only_active      = 'X'
      TABLES
        status           = h_status_tab
      EXCEPTIONS
        object_not_found = 01.

    CLEAR lv_manu.
    LOOP AT h_status_tab.
      IF h_status_tab-stat EQ lv_stat. "MANU
        lv_manu = 'X'.
        EXIT.
      ENDIF.
    ENDLOOP.

    IF lv_manu = 'X'.
      DELETE gt_seo.
      CONTINUE.
    ENDIF.
*    ENDIF.
* End of insert MOD-005

    CLEAR lv_ok.
* Begin of change MOD-004
*   IF p_vaplz IS NOT INITIAL.
    IF s_vaplz IS NOT INITIAL.
      LOOP AT s_vaplz.
*    IF p_vaplz IS NOT INITIAL.
* End of change MOD-004
        CLEAR lv_vaplz.
* Begin of change MOD-004
        CONCATENATE s_vaplz-low '%' INTO lv_vaplz.
* End of change MOD-004
        IF ctamflag = 'Y'.

* Begin of insert MOD-004
          IF s_vaplz-sign = 'I'.
* End of insert MOD-004

            SELECT arbpl FROM yam_wc_map_sloc INTO TABLE it_vaplz
              WHERE werks = gt_seo-vkorg AND
                    arbpl  LIKE lv_vaplz.
* Begin of insert MOD-004
          ELSE.
            SELECT arbpl FROM yam_wc_map_sloc INTO TABLE it_vaplz
              WHERE werks = gt_seo-vkorg AND
                    arbpl NOT LIKE lv_vaplz.
          ENDIF.
* End of insert MOD-004

        ELSE.
* Begin of insert MOD-004
          IF s_vaplz-sign = 'I'.
* End of insert MOD-004

            SELECT arbpl FROM crhd INTO TABLE it_vaplz
              WHERE arbpl LIKE lv_vaplz.
* Begin of insert MOD-004
          ELSE.
            SELECT arbpl FROM crhd INTO TABLE it_vaplz
              WHERE arbpl NOT LIKE lv_vaplz.
          ENDIF.
* End of insert MOD-004

        ENDIF.

        LOOP AT it_vaplz.

          IF gt_seo-vaplz = it_vaplz-vaplz.
            lv_ok = 'X'.
            EXIT.
          ENDIF.

        ENDLOOP.
        IF lv_ok <> 'X'.
          DELETE gt_seo.
* Begin of insert MOD-005
          lv_delete = 'X'.
* End of insert MOD-005
          EXIT.
        ENDIF.
* Begin of change MOD-004
*    ENDIF.
      ENDLOOP.
* End of change MOD-004
* Begin of insert MOD-005
      IF  lv_delete = 'X'.
        CONTINUE.
      ENDIF.
* Ebd of insert MOD-005

* Begin of insert MOD-004
    ENDIF.
* End of insert MOD-004

* End of insert MOD-002
* Check the goodsmovments
    CLEAR i_aufm_check[].
    SELECT  mblnr mjahr zeile aufnr werks matnr bwart erfmg
                        INTO TABLE i_aufm_check
                        FROM aufm
                        WHERE aufnr = gt_seo-aufnr.

    CLEAR lv_lin_ch.
    DESCRIBE TABLE i_aufm_check LINES lv_lin_ch.
    IF lv_lin_ch > 0.
      LOOP AT i_aufm_check.

        SELECT SINGLE * FROM mseg
          WHERE mblnr = i_aufm_check-mblnr AND
                mjahr = i_aufm_check-mjahr AND
                zeile = i_aufm_check-zeile AND
                bemot IN s_bemotc.
        IF sy-subrc <> 0.
          DELETE gt_seo.
* Begin of insert MOD-005
          lv_delete = 'X'.
* End of insert MOD-005
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.
* Begin of insert MOD-005
    IF  lv_delete = 'X'.
      CONTINUE.
    ENDIF.
* End of insert MOD-005
* Check the labour confirmations

    CLEAR i_afru_check[].
    SELECT  rueck rmzhl
          INTO TABLE i_afru_check
               FROM afru
               WHERE aufnr = gt_seo-aufnr.

    CLEAR lv_lin_ch.
    DESCRIBE TABLE i_afru_check LINES lv_lin_ch.
    IF lv_lin_ch > 0.
      LOOP AT i_afru_check.

        SELECT  SINGLE * FROM afru
        WHERE rueck = i_afru_check-rueck AND
              rmzhl = i_afru_check-rmzhl AND
              bemot IN s_bemotc.
        IF sy-subrc <> 0.
          DELETE gt_seo.
* Begin of insert MOD-005
          lv_delete = 'X'.
* End of insert MOD-005
          EXIT.
        ENDIF.

      ENDLOOP.
    ENDIF.
* Begin of insert MOD-005
    IF  lv_delete = 'X'.
      CONTINUE.
    ENDIF.



* Orders which are on TECO(and not FP) do not need to be handled anymore
    IF gt_seo-bemot <> 'FP' AND gt_seo-bemot <> '1E' AND gt_seo-phas2 = 'X'.
      DELETE gt_seo.
      CONTINUE.
    ENDIF.

    IF  gt_seo-bemot = '1E' AND gt_seo-faktf = '01'.
      SELECT SINGLE * FROM afih
        WHERE aufnr = gt_seo-aufnr AND
              ilart IN s_ilart.
      IF sy-subrc <> 0.
        DELETE gt_seo.
        CONTINUE.
      ENDIF.
    ENDIF.
* End of insert MOD-005
  ENDLOOP.
* End of insert MOD-001

  IF NOT gt_seo[] IS INITIAL.

    LOOP AT gt_seo.

* Begin of insert MOD-005
      CLEAR: gt_seo-kunum, gt_seo-kdgrp, gt_seo-qmnum.
* End of insert MOD-005

* Retrieve the notification number
      SELECT SINGLE
* Begin of insert MOD-005
        kunum
* End of insert MOD-005
        qmnum INTO
* Begin of insert MOD-005
        CORRESPONDING FIELDS OF gt_seo
* End of insert MOD-005
         FROM afih WHERE aufnr = gt_seo-aufnr.
      IF gt_seo-qmnum IS INITIAL.
        SELECT SINGLE qmnum INTO gt_seo-qmnum FROM vbak WHERE vbeln = gt_seo-kdauf.
      ENDIF.

      REFRESH: h_status_tab.

      CALL FUNCTION 'STATUS_READ'
        EXPORTING
          objnr            = gt_seo-objnr
          only_active      = 'X'
        TABLES
          status           = h_status_tab
        EXCEPTIONS
          object_not_found = 01.

*.... check status REL and CLSD
      CLEAR h_stat_flag.
      CLEAR h_stat_flag2.
      CLEAR h_stat_flag3.

      LOOP AT h_status_tab.
        IF h_status_tab-stat EQ 'I0002'. "Released
          h_stat_flag = 'X'.
          EXIT.
        ENDIF.
        IF h_status_tab-stat EQ 'I0045'. "Teco
          h_stat_flag3 = 'X'.
          EXIT.
        ENDIF.
* Double check (also done above)
        IF h_status_tab-stat EQ 'I0046'. "Closed
          h_stat_flag2 = 'X'.
          EXIT.
        ENDIF.

      ENDLOOP.

      IF h_stat_flag <> 'X' AND h_stat_flag3 <> 'X' .       "When not status REL and not TECO -> delete from internal table
        DELETE gt_seo.
        CONTINUE.
      ENDIF.
      IF h_stat_flag2 = 'X'.       "When status CLSD -> also delete from internal table
        DELETE gt_seo.
        CONTINUE.
      ENDIF.

      MODIFY gt_seo TRANSPORTING qmnum
* Begin of insert MOD-005
       kunum
       kdgrp.
* End of insert MOD-005
    ENDLOOP.


* Further delete out of table gt_SEO when no scenario is found in table YSE_CLOSE_SCEN
    PERFORM scenario.
* Some extra checks before we can do the actions described in table YSE_CLOSE_ACT
    PERFORM checks.
* Perform the action
    PERFORM action.

  ENDIF.



*&---------------------------------------------------------------------*
*&      Form  ACTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM action.
  DATA: lv_closed TYPE c,
        lv_teco TYPE c,
        lv_ok   TYPE c,        "+MOD-003
        gv_ind TYPE num_rec,
        gv_retcd LIKE sy-subrc,
        lv_bstkd TYPE bstkd. " MOD-005

  LOOP AT gt_seo.
    CLEAR gv_retcd.
    lv_closed = 'N'.
* Begin of insert MOD-005
    lv_inv_flag = ' '.
* End of insert MOD-005
    lv_cnf_flag = 'Y'.
    SELECT * FROM yse_close_act INTO TABLE gt_act
     WHERE scenario = gt_seo-scenar.

    READ TABLE gt_act INDEX 1.

    IF gt_act-set_userstatus <> ' '.
      PERFORM set_user_status IN PROGRAM yse_action_routines_test USING gt_seo-aufnr gt_act-set_userstatus.
    ENDIF.

* Begin of insert MOD-005
    IF gt_act-set_cnf = 'X'.
      PERFORM set_cnf IN PROGRAM yse_action_routines_test  USING gt_seo-aufnr gt_seo-vaplz gt_seo-bemot.
      WAIT UP TO 5 SECONDS.
    ENDIF.
* End of insert MOD-005

    IF gt_act-set_cnfparts = 'X' AND ctamflag = 'Y'.
      gv_ind = 0.
      PERFORM set_cnf_parts IN PROGRAM yse_action_routines_test TABLES i_bdcdata USING gt_seo-aufnr
* Begin of insert MOD-006
      gt_seo-bemot
      gt_seo-vkorg
* End of insert MOD-006
             CHANGING gv_ind lv_cnf_flag.
      IF gv_ind > 1.
        CALL TRANSACTION c_iw41 USING i_bdcdata MODE lv_mode
                   UPDATE 'S' MESSAGES INTO i_messtab.
      ENDIF.
    ENDIF.
    IF gt_act-set_settl = 'X'.
      PERFORM set_settl IN PROGRAM yse_action_routines_test TABLES i_bdcdata USING gt_seo-aufnr lv_per lv_yr.

      CALL TRANSACTION c_ko88 USING i_bdcdata MODE lv_mode
                 UPDATE 'S' MESSAGES INTO i_messtab.
    ENDIF.

* begin of insert MOD-003
    lv_ok = 'X'.
    LOOP AT i_messtab TRANSPORTING NO FIELDS WHERE msgtyp = 'E' OR msgtyp = 'A'.
      EXIT.
    ENDLOOP.
    IF sy-subrc = 0.  " Errors found
      CLEAR lv_ok.
    ELSE.
      LOOP AT i_messtab TRANSPORTING NO FIELDS WHERE msgtyp = 'W'
                                                 AND msgid  = 'RU'
                                                 AND msgnr  = '452'.
        EXIT.
      ENDLOOP.
      IF sy-subrc = 0.  " Warning RU 452 = Error in goods movements  !!!!
        CLEAR lv_ok.
      ENDIF.
    ENDIF.
    LOOP AT i_messtab.
      lv_index = sy-tabix.
      IF i_messtab-msgid = 'RU' AND i_messtab-msgnr = '451'.
        DELETE i_messtab INDEX lv_index.
      ENDIF.
    ENDLOOP.
* end of insert MOD-003

    CLEAR lv_inv_flag.
* begin of change MOD-003
*    IF gt_act-set_teco = 'X' AND lv_cnf_flag = 'Y'.
    IF gt_act-set_teco = 'X' AND lv_cnf_flag = 'Y' AND lv_ok = 'X'.
* end of change MOD-003
      CALL FUNCTION 'STATUS_CHECK'
      EXPORTING
*   BYPASS_BUFFER           = ' '
*   CLIENT                  = SY-MANDT
        objnr                   = gt_seo-objnr
        status                  = 'I0045'
     EXCEPTIONS
       object_not_found        = 1
       status_not_active       = 2
       OTHERS                  = 3
              .
      IF sy-subrc <> 0.

*****
* Begin of insert MOD-005
* Check PO number filled
        IF gt_seo-bemot = 'FP' OR ( gt_seo-bemot = '1E' AND gt_seo-faktf = '01' ).
          CLEAR lv_bstkd.
          IF ctamflag = 'Y'.
            SELECT SINGLE bstkd FROM pmsdo INTO lv_bstkd
              WHERE objnr = gt_seo-objnr.
          ELSE.
            SELECT SINGLE bstkd
              INTO lv_bstkd
              FROM vbkd WHERE vbeln = gt_seo-kdauf
                          AND posnr = '000000'.
          ENDIF.

          IF lv_bstkd IS INITIAL.

            lv_inv_flag = 'P'.

          ELSE.

* Check internal sales notes

            SELECT SINGLE equnr
               FROM afih INTO CORRESPONDING FIELDS OF es_equipment
              WHERE aufnr = gt_seo-aufnr.

            SELECT SINGLE matnr sernr erdat eqktx eqtyp ansdt inbdt gwldt
                          adrnr iloan tplnr
             FROM v_equi INTO CORRESPONDING FIELDS OF es_equipment
                     WHERE equnr = es_equipment-equnr
                       AND eqart = c_eqart
                       AND datbi EQ c_99991231.

            SELECT SINGLE adrnr FROM iflo INTO lv_adrnr
             WHERE tplnr = es_equipment-tplnr.

**  get language of functional location
            SELECT langu
                INTO lv_langu
                FROM adrc
                WHERE addrnumber = lv_adrnr.
            ENDSELECT.

            CLEAR lv_lines.
            CLEAR lv_quot.
            CLEAR i_lines[].
            CLEAR lv_salord.
            IF ctamflag = 'Y'.
              SELECT SINGLE vbeln FROM vbak INTO lv_quot
                WHERE aufnr = gt_seo-aufnr AND
                      vbtyp = 'B'.
              IF sy-subrc = 0.
                SELECT SINGLE vbeln FROM vbfa INTO lv_salord
                  WHERE vbelv = lv_quot AND
                        posnv = 0 AND
                        vbtyp_n = 'L'.
              ENDIF.
            ELSE.
              lv_salord = gt_seo-kdauf.
            ENDIF.

            CALL FUNCTION 'READ_TEXT'
              EXPORTING
                id                      = '0003'
                language                = lv_langu
                name                    = lv_salord
                object                  = 'VBBK'
              TABLES
                lines                   = i_lines
              EXCEPTIONS
                id                      = 1
                language                = 2
                name                    = 3
                not_found               = 4
                object                  = 5
                reference_check         = 6
                wrong_access_to_archive = 7
                OTHERS                  = 8.
            DESCRIBE TABLE i_lines LINES  lv_lines.
            IF lv_lines > 0.
              lv_inv_flag = 'I'.
            ENDIF.

          ENDIF.
        ENDIF.
*****

        IF lv_inv_flag IS INITIAL.
* End of insert MOD-005
          PERFORM set_teco IN PROGRAM yse_action_routines_test TABLES i_bdcdata USING gt_seo-aufnr gt_seo-qmnum gv_retcd.
* Begin of insert MOD-005
        ENDIF.
* End of insert MOD-005

      ENDIF.
    ENDIF.

* Check again if TECO is SET to update the TECO-FLG
    CALL FUNCTION 'STATUS_CHECK'
       EXPORTING
*   BYPASS_BUFFER           = ' '
*   CLIENT                  = SY-MANDT
         objnr                   = gt_seo-objnr
         status                  = 'I0045'
      EXCEPTIONS
        object_not_found        = 1
        status_not_active       = 2
        OTHERS                  = 3
               .
    IF sy-subrc <> 0.
      lv_teco = 'N'.
    ELSE.
      lv_teco = 'Y'.
    ENDIF.


* Begin of insert MOD-005
    IF gt_act-set_inv = 'X' AND lv_teco = 'Y' AND lv_inv_flag <> 'P' AND lv_inv_flag <> 'I'.
      CLEAR lv_adrnr.
      SELECT SINGLE adrnr FROM iflo INTO lv_adrnr
      WHERE tplnr = es_equipment-tplnr.
      CLEAR: lv_name2, lv_sernr, lv_eqktx.
*  SELECT SINGLE adrnr FROM iloa INTO lv_adrnr
*    WHERE tplnr = ms_equipment-tplnr AND iloan = ms_equipment-iloan.

**  get address of functional location
      SELECT SINGLE name2
          INTO lv_name2
          FROM adrc
          WHERE addrnumber = lv_adrnr.

      lv_sernr = es_equipment-sernr.
      lv_eqktx = es_equipment-eqktx.
      PERFORM set_invoice IN PROGRAM yse_action_routines_test USING gt_seo-aufnr gt_seo-kdauf ctamflag lv_langu gt_seo-vkorg
                                                               lv_sernr lv_name2 lv_bstkd lv_eqktx gv_retcd.
      IF gv_retcd = 5.
        lv_teco = 'N'.
      ENDIF.
    ENDIF.
* End of insert MOD-005

* Begin of delete MOD-005
*    IF gt_act-set_close = 'X'.
*
*
*      PERFORM set_close IN PROGRAM yse_action_routines TABLES i_bdcdata USING gt_seo-aufnr ctamflag.
*      CALL TRANSACTION c_iw32 USING i_bdcdata MODE lv_mode
*                UPDATE 'S' MESSAGES INTO i_messtab.
*      IF sy-subrc = 0.
*        lv_closed = 'Y'.
*        LOOP AT i_messtab.
*          IF i_messtab-msgtyp = 'A' OR i_messtab-msgtyp = 'E'.
*            lv_closed = 'N'.
*          ENDIF.
*        ENDLOOP.
*      ELSE.
*        lv_closed = 'N'.
*      ENDIF.
*
*    ENDIF.
* End of delete MOD-005


    IF gt_act-set_log = 'X'.
* Fill closed flag

*    CALL FUNCTION 'STATUS_CHECK'
*      EXPORTING
**   BYPASS_BUFFER           = ' '
**   CLIENT                  = SY-MANDT
*        objnr                   = gt_SEO-objnr
*        status                  = 'I0046'
*     EXCEPTIONS
*       object_not_found        = 1
*       status_not_active       = 2
*       OTHERS                  = 3
*              .
*    IF sy-subrc EQ 0.
*      lv_closed = 'Y'.
*    ELSE.
*      lv_closed = 'N'.
*    ENDIF.

      PERFORM add_msg_log2 USING lv_closed
                                 lv_teco
                                 gv_retcd
                                 lv_cnf_flag
                                 lv_inv_flag.
    ENDIF.


    IF gt_act-set_appl_log = 'X'.
      PERFORM create_log.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ACTION

*&---------------------------------------------------------------------*
*&      Form  SCENARIO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM scenario.


  DATA : lv_status(40) TYPE c,
         lv_stat(5) TYPE c,
         lv_vbeln TYPE vbeln,
         lv_contr_type TYPE auart,
         lv_lines TYPE i,
         lv_ch_lines TYPE i,
         teller TYPE i,
         line_s TYPE i.

  DATA: BEGIN OF gt_scen OCCURS 0,
        scen TYPE zscen,
        act(255) TYPE c,
        ch(255) TYPE c,
        status(40) TYPE c,
        prio   TYPE zprio,
* Begin of insert MOD-005
        ordpwlab TYPE c,
* End of insert MOD-005
        plab   TYPE c,
        END OF gt_scen.

  TYPES :
    BEGIN OF gty_status,
      status(5) TYPE c,
    END OF gty_status.

* Begin of insert MOD-005
  DATA: lt_message TYPE  bal_t_msg,
        lt_cost_details TYPE STANDARD TABLE OF bapi_alm_order_costs_detail_e,
        wa_cost_details TYPE bapi_alm_order_costs_detail_e,
        lv_lab_cost_act TYPE dkgrkosist,
        lv_lab_cost_plan TYPE dkgrkoplan,
        lv_pwith_lab     TYPE c,
        lv_ord_part_wlab TYPE c,
        lv_index TYPE sy-tabix,
        lv_apav TYPE c,
        lv_cnf TYPE c.
* End of insert MOD-005



  DATA :
    gs_status TYPE gty_status,
    gt_status TYPE TABLE OF gty_status WITH HEADER LINE.


* Begin of insert MOD-005
  DATA: i_resb TYPE TABLE OF resb WITH HEADER LINE.
* End of insert MOD-005

  LOOP AT gt_seo.


* Begin of insert MOD-002
* CTAM or Seed
    SELECT SINGLE * FROM yam_ctam_ccodes
          WHERE bukrs = gt_seo-bukrs.
    IF NOT sy-subrc = 0.
      ctamflag = 'N'.
    ELSE.
      ctamflag = 'Y'.
    ENDIF.
* End of insert MOD-002

*    IF gt_seo-aufnr = '004000005076'.
*      CLEAR lv_contr_type.
*    ENDIF.
* retrieve contract type

* Begin of insert MOD-002
    IF ctamflag = 'Y'.
* End of insert MOD-002
      CLEAR lv_contr_type.
      CLEAR lv_vbeln.
      IF NOT gt_seo-kdauf IS INITIAL.
*      select single vbelv from vbfa into lv_vbeln
*        where vbeln = gt_SEO-kdauf and
*              vbtyp_v = 'G'.
*
*      select single auart from vbak into lv_contr_type
*        where vbeln = lv_vbeln.

      SELECT SINGLE auart FROM vbak INTO lv_contr_type
      WHERE vbeln = gt_seo-kdauf.

      SELECT SINGLE matkl FROM vbap INTO lv_matkl
      WHERE vbeln = gt_seo-kdauf AND posnr = gt_seo-kdpos.

      ENDIF.
* Begin of insert MOD-002
    ELSE.
      CLEAR lv_contr_type.
      CLEAR: lv_vbeln.
      SELECT SINGLE vgbel FROM vbak INTO lv_vbeln
      WHERE vbeln = gt_seo-kdauf.

      SELECT SINGLE auart FROM vbak INTO lv_contr_type
      WHERE vbeln = lv_vbeln.

    ENDIF.
* End of insert MOD-002


* Retrieve the scenario, checks and status
* Begin of insert MOD-005
    IF  ( gt_seo-bemot = 'FP' OR ( gt_seo-bemot = '1E' AND gt_seo-faktf = '01' ) ) AND ctamflag <> 'Y'.

      CLEAR lv_ilart.

      SELECT SINGLE ilart FROM afih INTO lv_ilart
        WHERE aufnr = gt_seo-aufnr.

      CLEAR gt_scen[].
      SELECT  scenario action checks status prio ordpwlab FROM yse_close_scen INTO TABLE gt_scen
           WHERE vkorg = gt_seo-vkorg AND
                  auart = gt_seo-auart AND
                  ( contr_type = lv_contr_type OR contr_type = ' ' ) AND
                  bemot = gt_seo-bemot AND
                  ilart = lv_ilart.


    ELSE.
      IF lv_contr_type = 'ZSM7'.
      CLEAR gt_scen[].
      SELECT  scenario action checks status prio ordpwlab FROM yse_close_scen INTO TABLE gt_scen
           WHERE vkorg = gt_seo-vkorg AND
                  auart = gt_seo-auart AND
                  ( contr_type = lv_contr_type OR contr_type = ' ' ) AND
                  matkl = lv_matkl AND
                  bemot = gt_seo-bemot.
      ELSE.
* End of insert MOD-005
      CLEAR gt_scen[].
      SELECT  scenario action checks status prio ordpwlab FROM yse_close_scen INTO TABLE gt_scen
           WHERE vkorg = gt_seo-vkorg AND
                  auart = gt_seo-auart AND
                  ( contr_type = lv_contr_type OR contr_type = ' ' ) AND
                  bemot = gt_seo-bemot.
      ENDIF.
* Begin of insert MOD-005
    ENDIF.

* End of insert MOD-005

* Delete the scenario's out of the table which do not have the required statuses

    REFRESH: h_status_tab.

    CALL FUNCTION 'STATUS_READ'
      EXPORTING
        objnr            = gt_seo-objnr
        only_active      = 'X'
      TABLES
        status           = h_status_tab
      EXCEPTIONS
        object_not_found = 01.

    IF ctamflag = 'Y'.
      gv_statprof = 'ZAM00001'.
    ELSE.
      gv_statprof = 'ZAM00006'.
    ENDIF.

    LOOP AT gt_scen.


      SPLIT gt_scen-status AT seperator INTO TABLE gt_status.

      CLEAR lv_lines.
      DESCRIBE TABLE gt_status LINES lv_lines.
*.... Check the status (multiple entries possible in table YSE_CLOSE_SCEN-> gt_status)

      CLEAR teller.
      CLEAR lv_stat.
      LOOP AT gt_status.
        SELECT SINGLE estat FROM tj30t INTO lv_stat
          WHERE txt04 = gt_status-status
          AND stsma = gv_statprof
          AND spras = 'E'.
        IF sy-subrc = 0.
          LOOP AT h_status_tab.
            IF h_status_tab-stat EQ lv_stat.
              teller = teller + 1.
            ENDIF.
          ENDLOOP.
        ELSE.
          SELECT SINGLE istat FROM tj02t INTO lv_stat
            WHERE txt04 = gt_status-status
            AND spras = 'E'.
          IF sy-subrc = 0.
            LOOP AT h_status_tab.
              IF h_status_tab-stat EQ lv_stat.
                teller = teller + 1.
              ENDIF.
            ENDLOOP.
          ENDIF.
        ENDIF.

      ENDLOOP.

      IF teller <  lv_lines.
        DELETE gt_scen.
*      else.
*        gt_vbak_vbap-scenar = gt_scen-scen.
      ENDIF.
    ENDLOOP.   " endloop gt_scen

* Begin of insert MOD-005
* Check if its scenario 'order parts without labour'
    CLEAR lv_pwith_lab.
    CLEAR lv_ord_part_wlab.
    LOOP AT gt_scen.
      lv_index = sy-tabix.
      CLEAR lv_lines.

      IF gt_scen-ordpwlab = 'X'.
        lv_ord_part_wlab = 'X'.
      ENDIF.

      IF lv_ord_part_wlab = 'X'.
* Check if status APAV and not CNF
        CALL FUNCTION 'STATUS_READ'
          EXPORTING
            objnr            = gt_seo-objnr
            only_active      = 'X'
          TABLES
            status           = h_status_tab
          EXCEPTIONS
            object_not_found = 01.
        CLEAR: lv_apav, lv_cnf.
        LOOP AT h_status_tab.
          IF h_status_tab = 'E0010'.
            lv_apav = 'X'.
          ENDIF.
          IF h_status_tab = 'I0009'.
            lv_cnf = 'X'.
          ENDIF.
        ENDLOOP.
* Check if there are parts ordered
        IF lv_apav = 'X' AND lv_cnf <> 'X'.
          SELECT * FROM resb INTO CORRESPONDING FIELDS OF TABLE i_resb
            WHERE aufnr = gt_seo-aufnr.
          IF sy-subrc = 0.

*         Check deletion status of component
            LOOP AT i_resb.
              CALL FUNCTION 'STATUS_CHECK'
                EXPORTING
                  objnr             = i_resb-objnr
                  status            = 'I0013'
                EXCEPTIONS
                  object_not_found  = 1
                  status_not_active = 2
                  OTHERS            = 3.
              IF sy-subrc = 0.
                DELETE i_resb.
                CONTINUE.
              ENDIF.
            ENDLOOP.
            CLEAR lv_lines.
            DESCRIBE TABLE i_resb LINES lv_lines.
            IF lv_lines > 0.
* Check if planned and actual costs = 0

*
              CALL FUNCTION 'IBAPI_ALM_ORDERCOSTS_READ'
                EXPORTING
                  iv_orderid            = gt_seo-aufnr
               IMPORTING
*     ET_COSTS_SUM          =
                 et_costs_details       = lt_cost_details
                TABLES
                  et_messages           = lt_message.

              CLEAR: lv_lab_cost_act, lv_lab_cost_plan.
              LOOP AT lt_cost_details INTO wa_cost_details.
                CASE wa_cost_details-budget_type.
                  WHEN 'RKL'.
                    lv_lab_cost_act = lv_lab_cost_act + wa_cost_details-costs_act.
                    lv_lab_cost_plan = lv_lab_cost_plan + wa_cost_details-costs_plan.
                  WHEN 'KPPS'.
                    lv_lab_cost_act = lv_lab_cost_act + wa_cost_details-costs_act.
                    lv_lab_cost_plan = lv_lab_cost_plan + wa_cost_details-costs_plan.
                ENDCASE.
              ENDLOOP.
              IF lv_lab_cost_act <= 1 AND lv_lab_cost_plan <= 1.
                gt_scen-plab = 'Y'.
                lv_pwith_lab = 'X'.
                MODIFY gt_scen INDEX lv_index TRANSPORTING plab.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.
    IF lv_pwith_lab = 'X'. " A valid 'order with parts without labour' is encountered
      LOOP AT gt_scen.
        lv_index  = sy-tabix.
        IF gt_scen-plab <> 'Y'.
          DELETE gt_scen INDEX lv_index.
        ENDIF.
      ENDLOOP.
    ELSE.
      IF lv_ord_part_wlab = 'X'. " scenario 'order with parts without labour' exist but not valid for the order
        LOOP AT gt_scen.
          lv_index  = sy-tabix.
* Begin of insert MOD-006
          IF gt_seo-bemot = 'FF'.
            DELETE gt_scen INDEX lv_index. "for the first time fix we don't need to do anything if its not a parts without labour scenario
          ELSE.
* End of insert MOD-006
            IF gt_scen-ordpwlab = 'X'.
              DELETE gt_scen INDEX lv_index.
            ENDIF.
* Begin of insert MOD-006
          ENDIF.
* End of insert MOD-006
        ENDLOOP.
      ENDIF.
    ENDIF.

* End of insert MOD-005


* Check if 1 scenario is found.
* Otherwise delete the record out of gt_vbak_vbap.  This order we do not need to close.
    CLEAR line_s.
    DESCRIBE TABLE gt_scen LINES line_s.
    IF line_s = 0.
      DELETE gt_seo.
    ELSE.
      SORT gt_scen BY prio.
      READ TABLE gt_scen INDEX 1.

      gt_seo-scenar = gt_scen-scen.

* Checks need to be done?
      IF NOT gt_scen-ch IS INITIAL.
        gt_seo-ch = gt_scen-ch.
        gt_seo-checks = 'Y'.
      ELSE.
        gt_seo-checks = 'N'.
      ENDIF.
* Actions need to be done?
      IF NOT gt_scen-act IS INITIAL.
        gt_seo-act = gt_scen-act.
        gt_seo-actions = 'Y'.
      ELSE.
        gt_seo-actions = 'N'.
      ENDIF.
* Begin of insert MOD-005
      gt_seo-ordpwlab = gt_scen-ordpwlab.
* End of insert MOD-005

      MODIFY gt_seo TRANSPORTING checks actions act ch scenar ordpwlab.
    ENDIF.
  ENDLOOP. " gt_SEO
ENDFORM.                    "SCENARIO

*&---------------------------------------------------------------------*
*&      Form  checks
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM checks.
*.. Local variables
  DATA: lv_msg TYPE char120.

  DATA : lv_ch(255) TYPE c,
         lv_scenario TYPE zscen,
         lv_count_start TYPE i,
         lv_count_start2 TYPE i,
         lv_count_end TYPE i,
         lv_length TYPE i,
         lv_perc_f TYPE i,
         lv_perc_t TYPE i,
         lv_perc_f_c(3) TYPE c,
         lv_perc_t_c(3) TYPE c,
         lv_perc TYPE i,
         lv_percc(7) TYPE c,
         lv_count_start_perc TYPE i,
         lv_check1 TYPE i,
         lv_perc_c(3) TYPE c.

  DATA: check TYPE c.

* Begin insert MOD-001
  DATA: lv_gjahr TYPE gjahr,
        lv_perio2(2) TYPE n,
        lv_perio(2) TYPE n,
        lv_budat TYPE aufm-budat,
        lv_lfmon TYPE marv-lfmon.
* End insert MOD-001

  LOOP AT gt_seo.

* Begin of insert MOD-002
* CTAM or Seed
    SELECT SINGLE * FROM yam_ctam_ccodes
          WHERE bukrs = gt_seo-bukrs.
    IF NOT sy-subrc = 0.
      ctamflag = 'N'.
    ELSE.
      ctamflag = 'Y'.
    ENDIF.
* End of insert MOD-002

    CLEAR gt_yse_close_log.
    IF gt_seo-checks = 'Y'.

      CLEAR gt_ch[].
      SPLIT gt_seo-ch AT seperator INTO TABLE gt_ch.
* Do the necessary checks.
      LOOP AT gt_ch.
        CLEAR lv_perc.
        CLEAR lv_perc_f.
        CLEAR lv_perc_t.
        check = gt_seo-checks.
        CLEAR lv_check1.
        FIND ';' IN gt_ch-ch MATCH OFFSET lv_check1.
        IF lv_check1 = 0.
* Retrieve variables between () when there are in the checklist.
* Retrieve lv_perc for MAX cost difference VALUE
          CLEAR lv_count_start.
          CLEAR lv_count_end.
          CLEAR lv_length.
          CLEAR lv_count_start_perc.
          FIND '(' IN gt_ch-ch MATCH OFFSET lv_count_start.
          IF NOT lv_count_start IS INITIAL.
            FIND ')' IN gt_ch-ch MATCH OFFSET lv_count_end.
            IF NOT lv_count_end IS INITIAL.
              lv_length = lv_count_end - lv_count_start.
              lv_length = lv_length - 1.
              lv_count_start_perc = lv_count_start + 1.
              lv_perc = gt_ch-ch+lv_count_start_perc(lv_length).
              gt_ch-ch = gt_ch-ch(lv_count_start).
            ENDIF.
          ENDIF.

        ELSE.
* Retrieve lv_perc_f and lv_perc_t %
          CLEAR lv_count_start.
          CLEAR lv_count_end.
          CLEAR lv_length.
          CLEAR lv_count_start_perc.
          FIND '(' IN gt_ch-ch MATCH OFFSET lv_count_start.
          IF NOT lv_count_start IS INITIAL.
            FIND ';' IN gt_ch-ch MATCH OFFSET lv_count_end.
            IF NOT lv_count_end IS INITIAL.
              lv_length = lv_count_end - lv_count_start.
              lv_length = lv_length - 1.
              lv_count_start_perc = lv_count_start + 1.
              lv_perc_f = gt_ch-ch+lv_count_start_perc(lv_length).
            ENDIF.
          ENDIF.

          CLEAR lv_count_start2.
          CLEAR lv_count_end.
          CLEAR lv_length.
          CLEAR lv_count_start_perc.
          FIND ';' IN gt_ch-ch MATCH OFFSET lv_count_start2.
          IF NOT lv_count_start IS INITIAL.
            FIND ')' IN gt_ch-ch MATCH OFFSET lv_count_end.
            IF NOT lv_count_end IS INITIAL.
              lv_length = lv_count_end - lv_count_start2.
              lv_length = lv_length - 1.
              lv_count_start_perc = lv_count_start2 + 1.
              lv_perc_t = gt_ch-ch+lv_count_start_perc(lv_length).
              gt_ch-ch = gt_ch-ch(lv_count_start).
            ENDIF.
          ENDIF.

        ENDIF.

* Regenerate order costs
        SUBMIT ripmco00
            WITH saufnr = gt_seo-aufnr
            WITH p_test = ' '
            AND RETURN.


        CASE gt_ch-ch.
          WHEN 'CHECK1_COSTS'.
*            if check <> 'N'.
*              IF lv_perc <> 0.
            PERFORM check1_costs IN PROGRAM yse_check_routines
                                    USING gt_seo-aufnr
                                          lv_perc_f
                                          lv_perc_t
                                    CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text =  text-t01.
              lv_perc_f_c = lv_perc_f.
              lv_perc_t_c = lv_perc_t.
              CONCATENATE lv_perc_f_c '/' lv_perc_t_c INTO lv_percc.
              PERFORM conc_msg_log_par USING lv_text
                                         lv_percc.
              gt_yse_close_log-check1 = 'X'.
            ENDIF.
*              ENDIF.
*            endif.
          WHEN 'CHECK2_INTERN_COM'.
*            if check <> 'N'.
            PERFORM check2_intern_com IN PROGRAM yse_check_routines
                                      USING gt_seo-qmnum
                                      CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text = text-t02.
              PERFORM conc_msg_log USING lv_text.
              gt_yse_close_log-check2 = 'X'.
            ENDIF.
*           endif.
          WHEN 'CHECK3_ALL_PARTS_CONF'.
*           if check <> 'N'.
            PERFORM check3_all_parts_conf IN PROGRAM yse_check_routines
                                      USING gt_seo-aufnr
* Begin of insert MOD-002
                                            ctamflag
* End of insert MOD-002
                                      CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text =  text-t03.
              PERFORM conc_msg_log USING lv_text.
              gt_yse_close_log-check3 = 'X'.
            ENDIF.
*            endif.
          WHEN 'CHECK4_MAXCOSTS'.
            IF lv_perc <> 0.
              PERFORM check4_maxcosts IN PROGRAM yse_check_routines
                                      USING gt_seo-aufnr
                                            lv_perc
                                      CHANGING check.
              IF check = 'N'.
                CLEAR lv_text.
                lv_text =  text-t04.
                lv_percc = lv_perc.
                PERFORM conc_msg_log_par USING lv_text
                                           lv_percc.
                gt_yse_close_log-check4 = 'X'.
              ENDIF.
            ENDIF.
          WHEN 'CHECK5_NO_PART'.
            PERFORM check5_no_part IN PROGRAM yse_check_routines
                                       USING gt_seo-aufnr
                                       CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text =  text-t05.
              PERFORM conc_msg_log USING lv_text.
              gt_yse_close_log-check5 = 'X'.
            ENDIF.

* Begin of insert MOD-002
          WHEN 'CHECK6_PART_EXIST'.
            PERFORM check6_part_exist IN PROGRAM yse_check_routines
                                       USING gt_seo-aufnr
                                       CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text =  text-t07.
              PERFORM conc_msg_log USING lv_text.
              gt_yse_close_log-check6 = 'X'.

            ENDIF.

          WHEN 'CHECK7_SUBC'.
            PERFORM check7_subc IN PROGRAM yse_check_routines
                                       USING gt_seo-aufnr
                                       CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text =  text-t08.
              PERFORM conc_msg_log USING lv_text.
              gt_yse_close_log-check7 = 'X'.
            ENDIF.
* End of insert MOD-002
* Begin of insert MOD-005
          WHEN 'CHECK8_PROFIT'.
            PERFORM check8_profit IN PROGRAM yse_check_routines
                                       USING gt_seo-aufnr
                                             gt_seo-kdauf
                                             lv_perc
                                             ctamflag
                                       CHANGING check.
            IF check = 'N'.
              CLEAR lv_text.
              lv_text =  text-t09.
              lv_perc_c = lv_perc.
              CONCATENATE lv_text lv_perc_c INTO lv_text SEPARATED BY ' '.
              PERFORM conc_msg_log USING lv_text.
              gt_yse_close_log-check8 = 'X'.
            ENDIF.

          WHEN 'CHECK9_ACTCOST'.
            IF lv_perc <> 0.
              PERFORM check9_actcost IN PROGRAM yse_check_routines
                                      USING gt_seo-aufnr
                                            lv_perc
                                      CHANGING check.
              IF check = 'N'.
                CLEAR lv_text.
                lv_text =  text-t10.
                lv_percc = lv_perc.
                PERFORM conc_msg_log_par USING lv_text
                                           lv_percc.
                gt_yse_close_log-check9 = 'X'.
              ENDIF.
            ENDIF.
* End of insert MOD-005
        ENDCASE.

      ENDLOOP.
    ENDIF.
* Begin of insert MOD-001
* Always Check if period is open
    CLEAR: lv_budat,  lv_gjahr, lv_perio2, lv_perio, lv_lfmon.

    lv_budat = sy-datum.

*    CALL FUNCTION 'MR_PERIOD_DETERMINE'
*      EXPORTING
*        i_bukrs                = gt_seo-bukrs
*        i_budat                = lv_budat
*      IMPORTING
*        e_lfgja                = lv_gjahr
*        e_lfmon                = lv_perio2
*      EXCEPTIONS
*        invalid_posting_period = 01.
*    IF sy-subrc <> 0.
*      check = 'N'.
*      lv_text =  text-t06.
*      PERFORM conc_msg_log USING lv_text.
*    ELSE.

    SELECT SINGLE lfmon FROM marv INTO lv_lfmon
      WHERE bukrs = gt_seo-bukrs.


    lv_perio = lv_budat+4(2).
    IF lv_perio  <> lv_lfmon.
      check = 'N'.
      lv_text =  text-t06.
      PERFORM conc_msg_log USING lv_text.
    ENDIF.
*    ENDIF.
* End of insert MOD-001

    IF NOT gt_yse_close_log-checklist IS INITIAL.
      SELECT SINGLE * FROM yse_close_act
        WHERE scenario = gt_seo-scenar AND set_log = 'X'.
      IF sy-subrc = 0.
* Write to Log
        PERFORM add_msg_log.
      ENDIF.
      CLEAR gt_yse_close_log[].
      DELETE gt_seo.
      CONTINUE.
    ENDIF.



* Also additional actions necessary?

    IF gt_seo-actions = 'Y'.
      CLEAR gt_ch[].
      SPLIT gt_seo-act AT seperator INTO TABLE gt_ch.
* Do the necessary actions.
      LOOP AT gt_ch.
        check = gt_seo-actions.
*
        CASE gt_ch-ch.
          WHEN 'ACTION1_NOLA'.

            PERFORM action1_nola IN PROGRAM yse_action_routines_test
                                    USING gt_seo-aufnr
                                          CHANGING lv_msg.

*             if lv_msg is not initial.
*                select single * from yse_close_act
*                      where scenario = gt_seo-scenar and set_log = 'X'.
*                if sy-subrc = 0.
*                  PERFORM ADD_MSG_LOG.
*                endif.
*             endif.
        ENDCASE.

      ENDLOOP.

    ENDIF.

  ENDLOOP.

ENDFORM.                    "user_command_l



*&---------------------------------------------------------------------*
*&      Form  log_create
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM log_create.

* create an initial log file
  l_s_log-extnumber  = 'Application Log'.
  l_s_log-object = 'YSE_CLOS_QUOT'.
  l_s_log-aldate = sy-datlo.
  l_s_log-aluser = sy-uname.
  l_s_log-altime = sy-uzeit.

  CALL FUNCTION 'BAL_LOG_CREATE'
    EXPORTING
      i_s_log      = l_s_log
    IMPORTING
      e_log_handle = l_log_handle
    EXCEPTIONS
      OTHERS       = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
ENDFORM.                    "log_create

*&---------------------------------------------------------------------*
*&      Form  log_show
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM log_show .
  DATA:
    l_s_display_profile TYPE bal_s_prof.
  CLEAR  l_s_display_profile.

* get a prepared profile
  CALL FUNCTION 'BAL_DSP_PROFILE_POPUP_GET'
    IMPORTING
      e_s_display_profile = l_s_display_profile
    EXCEPTIONS
      OTHERS              = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* set report to allow saving of variants
  l_s_display_profile-disvariant-report = sy-repid.
  CALL FUNCTION 'BAL_DSP_LOG_DISPLAY'
    EXPORTING
      i_s_display_profile = l_s_display_profile
    EXCEPTIONS
      OTHERS              = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    "log_show

*&---------------------------------------------------------------------*
*&      Form  create_log
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM create_log .
* LOOP THE BDC MESSAGE TABLE
  LOOP AT i_messtab.
    l_s_msg-msgty = i_messtab-msgtyp.
    l_s_msg-msgid = i_messtab-msgid.
    l_s_msg-msgno = i_messtab-msgnr.
    l_s_msg-msgv1 = i_messtab-msgv1.
    l_s_msg-msgv2 = i_messtab-msgv2.
    l_s_msg-msgv3 = i_messtab-msgv3.
    l_s_msg-msgv4 = i_messtab-msgv4.
    CALL FUNCTION 'BAL_LOG_MSG_ADD'
      EXPORTING
        i_log_handle = l_log_handle
        i_s_msg      = l_s_msg
      EXCEPTIONS
        OTHERS       = 1.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

  ENDLOOP.
  REFRESH i_messtab.
  APPEND l_log_handle TO lt_logh.


ENDFORM.                    "create_log



* Message Log for Checks
FORM add_msg_log. "Add Messages when checks failed
  DATA: lv_timestamp(20) TYPE c.

  gt_yse_close_log-scenario = gt_seo-scenar.
  lv_timestamp = sy-uzeit.
  CONCATENATE gt_seo-aufnr lv_timestamp INTO gt_yse_close_log-seotim SEPARATED BY ' '.
  gt_yse_close_log-datum = sy-datum.
  gt_yse_close_log-vkorg = gt_seo-vkorg.
* Begin of insert MOD-005
  gt_yse_close_log-bemot = gt_seo-bemot.
* End of insert MOD-005
* Begin of insert MOD-006
  gt_yse_close_log-auart = gt_seo-auart.
* End of insert MOD-006
  gt_yse_close_log-aufnr  = gt_seo-aufnr.
  gt_yse_close_log-clsd_flg = 'N'.
  gt_yse_close_log-teco_flg = 'N'.
  gt_yse_close_log-errmess = ' '.
  APPEND gt_yse_close_log.
  INSERT yse_close_log FROM TABLE gt_yse_close_log.
  COMMIT WORK.

ENDFORM.                    "ADD_MSG_LOG

** Message log for additional actions
*FORM ADD_MSG_LOG1 USING lv_msg TYPE CHAR120. "Add Messages when checks failed
*DATA: lv_timestamp(20) type C.
*
*gt_YSE_CLOSE_LOG-SCENARIO = gt_SEO-scenar.
*lv_timestamp = sy-uzeit.
*concatenate gt_SEO-aufnr lv_timestamp into gt_YSE_CLOSE_LOG-SEOTIM separated by ' '.
*gt_YSE_CLOSE_LOG-DATUM = sy-datum.
*gt_YSE_CLOSE_LOG-VKORG = gt_SEO-vkorg.
*gt_YSE_CLOSE_LOG-AUFNR  = gt_SEO-aufnr.
*gt_YSE_CLOSE_LOG-CLSD_FLG = 'N'.
*gt_YSE_CLOSE_LOG-ERRMESS = lv_msg.
*APPEND gt_YSE_CLOSE_LOG.
*INSERT YSE_CLOSE_LOG FROM TABLE gt_YSE_CLOSE_LOG.
*COMMIT WORK.
*
*ENDFORM.

* Message log for Standard Action
FORM add_msg_log2 USING lv_closed TYPE c
                        lv_teco TYPE c
                        lv_retcd LIKE sy-subrc
                        lv_cnf_flag TYPE c
                        lv_inv_flag TYPE c.

  DATA: lv_timestamp(20) TYPE c,
        lv_ln TYPE i.


  CLEAR g_mstring.
  IF lv_retcd = 4.
    lv_closed = 'N'.
    g_mstring = 'TECO is NOT possible'.
  ENDIF.

  IF lv_retcd = 5.
    lv_closed = 'N'.
    g_mstring = 'Invoice is NOT possible'.
  ENDIF.


  IF lv_cnf_flag = 'E'.
    lv_closed = 'N'.
    g_mstring = 'TECO is NOT possible: confirmation error'.
  ENDIF.

* Begin of insert MOD-005


  IF lv_inv_flag = 'P'.
    lv_closed = 'N'.
    g_mstring = 'Teco & Invoice is NOT possible: Purchase Order Number not filled in'.
  ENDIF.


  IF lv_inv_flag = 'I'.
    lv_closed = 'N'.
    g_mstring = 'Teco & Invoice is NOT possible: There are internal sales notes'.
  ENDIF.

* End of insert MOD-005

  LOOP AT i_messtab.
    IF i_messtab-msgtyp = c_type_a OR i_messtab-msgtyp = c_type_e.
      lv_closed = 'N'.

      SELECT SINGLE text FROM t100 INTO g_text
                            WHERE sprsl = c_en
                              AND arbgb = i_messtab-msgid
                              AND msgnr = i_messtab-msgnr.
      IF sy-subrc = 0.
        lv_mstring = g_text.
        IF lv_mstring CS '&1'.
          REPLACE '&1' WITH i_messtab-msgv1 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&2' WITH i_messtab-msgv2 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&3' WITH i_messtab-msgv3 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&4' WITH i_messtab-msgv4 INTO lv_mstring.
          CONDENSE lv_mstring.
        ELSE.
          REPLACE '&' WITH i_messtab-msgv1 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&' WITH i_messtab-msgv2 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&' WITH i_messtab-msgv3 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&' WITH i_messtab-msgv4 INTO lv_mstring.
          CONDENSE lv_mstring.
        ENDIF.
      ENDIF.
      IF g_mstring IS INITIAL.
        g_mstring = lv_mstring.
      ELSE.
        CONCATENATE g_mstring lv_mstring INTO g_mstring SEPARATED BY ' / '.
      ENDIF.
      EXIT.
    ENDIF.
  ENDLOOP.

  IF g_mstring IS INITIAL AND lv_closed = 'N'.
    LOOP AT i_messtab.

      SELECT SINGLE text FROM t100 INTO g_text
                                   WHERE sprsl = c_en
                                     AND arbgb = i_messtab-msgid
                                     AND msgnr = i_messtab-msgnr
                                     AND ( arbgb <> 'KD' OR msgnr <> '213' )
                                     AND ( arbgb <> 'IW' OR msgnr <> '711' ).

      IF sy-subrc = 0.
        lv_mstring = g_text.
        IF lv_mstring CS '&1'.
          REPLACE '&1' WITH i_messtab-msgv1 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&2' WITH i_messtab-msgv2 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&3' WITH i_messtab-msgv3 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&4' WITH i_messtab-msgv4 INTO lv_mstring.
          CONDENSE lv_mstring.
        ELSE.
          REPLACE '&' WITH i_messtab-msgv1 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&' WITH i_messtab-msgv2 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&' WITH i_messtab-msgv3 INTO lv_mstring.
          CONDENSE lv_mstring.
          REPLACE '&' WITH i_messtab-msgv4 INTO lv_mstring.
          CONDENSE lv_mstring.
        ENDIF.

        IF g_mstring IS INITIAL.
          g_mstring = lv_mstring.
        ELSE.
          CONCATENATE g_mstring lv_mstring INTO g_mstring SEPARATED BY ' / '.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.

  CLEAR gt_yse_close_log[].
  CLEAR gt_yse_close_log.

  gt_yse_close_log-scenario = gt_seo-scenar.
  lv_timestamp = sy-uzeit.
  CONCATENATE gt_seo-aufnr lv_timestamp INTO gt_yse_close_log-seotim SEPARATED BY ' '.
  gt_yse_close_log-datum = sy-datum.
  gt_yse_close_log-vkorg = gt_seo-vkorg.
  gt_yse_close_log-aufnr  = gt_seo-aufnr.
* Begin of insert MOD-005
  gt_yse_close_log-bemot = gt_seo-bemot.
* End of insert MOD-005
* Begin of insert MOD-006
  gt_yse_close_log-auart = gt_seo-auart.
* End of insert MOD-006
  gt_yse_close_log-checklist = ' '.
  gt_yse_close_log-clsd_flg = lv_closed.
  gt_yse_close_log-teco_flg = lv_teco.
  gt_yse_close_log-errmess = g_mstring.

  APPEND gt_yse_close_log.
  INSERT yse_close_log FROM TABLE gt_yse_close_log.
  COMMIT WORK.

ENDFORM.                    "ADD_MSG_LOG2

*&---------------------------------------------------------------------*
*&      Form  CONC_MSG_LOG
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->LV_TEXT    text
*----------------------------------------------------------------------*
FORM conc_msg_log USING lv_text TYPE char200.

  IF gt_yse_close_log-checklist IS INITIAL.
    gt_yse_close_log-checklist = lv_text.
  ELSE.
    CONCATENATE gt_yse_close_log-checklist lv_text INTO gt_yse_close_log-checklist SEPARATED BY ' / '.
  ENDIF.

ENDFORM.                    "CONC_MSG_LOG

*&---------------------------------------------------------------------*
*&      Form  CONC_MSG_LOG_PAR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->LV_TEXT    text
*      -->LV_PERC    text
*----------------------------------------------------------------------*
FORM conc_msg_log_par USING lv_text TYPE char200
                               lv_perc TYPE char7.
  IF gt_yse_close_log-checklist IS INITIAL.
    CONCATENATE lv_text lv_perc INTO gt_yse_close_log-checklist.
  ELSE.
    CONCATENATE lv_text lv_perc INTO lv_text.
    CONCATENATE gt_yse_close_log-checklist lv_text INTO gt_yse_close_log-checklist SEPARATED BY ' / '.
  ENDIF.

ENDFORM.                    "CONC_MSG_LOG_PAR

*Text symbol text
*001:Order Selection
*002:Transactional Data
*E01:You have no authorisation for sales organisation :
*E03:No authorization for sales organisation: &1
*I01:No contracts selected !
*I10:Act_rev
*I11:Profit Center (Text)
*I12:Sales Org.(Text)
*I13:Region (Text)
*I14:Sales district(Text)
*I15:Sales office(Text)
*I16:Customer Industrial Code
*I17:Customer Ind.Code(Text)
*I18:Customer group(Text)
*I19:Customer Name
*I20:PLC(Text)
*I21:GAC(Text)
*I22:PGC(Text)
*I23:Plant(Text)
*I24:Equipment description
*I25:Contract
*I26:Contract item invoiced
*I27:Contract item invoice outstanding
*I28:Contract item value total
*I29:Product
*I30:Product description
*I31:Revenues Actual
*I32:Cash discount Actual
*I33:Net invoiced sales Actual
*I34:Unadjusted COS Actual
*I35:Parts Actual
*I36:Labour Actual
*I37:Mileage Actual
*I38:Ad Hoc Expenses Actual
*I39:Subcontracting Actual
*I40:COGS-Contract provis Actual
*I41:Fix price accruals Actual
*I42:Unadjusted COGS Actual
*I43:Unadjusted Gross Profit Actual
*I44:% UGP Actual
*I45:Tot.Revenues Planned
*I46:Tot.Costs Planned
*I47:Tot.Planned GP value
*I48:Tot.Planned GP value %
*I49:Total Acutal Costs
*I50:Balance Receivables not invoiced
*I51:Balance Accrued Revenue
*I55:Sales group(Text)
*T01:cost diff perc:
*T02:internal comments
*T03:missing part conf
*T04:cost diff val:
*T05:no parts
*T06:Period is closed
*T07:Part Exist
*T08:Order Contains Subcontracting
*T09:Profit <

*T10:Actual Cost is higher than limit:
*Selection text
*S_AUART:        Order Type
*S_AUFNR:        Service Order
*S_BEMOT:        Accounting Indicator
*S_BEMOTC:        Accounting Indicator Confirm.
*S_ILART:        Fixed Price Business Indicator
*S_VAPLZ:        Main Workcenter
*S_VKORG:        Sales Organisation
