*----------------------------------------------------------------------*
* PROGRAM ID           : YSE_P025_EQUIPMENT_COMPLETION                 *
* PROGRAM TITLE        : P025 : Equipment Completion                   *
* AUTHOR               : Marc Jacobs                                   *
* DATE                 : 01/02/2007                                    *
* DEVELOPMENT ID       : P025                                          *
*                                                                      *
* CHANGE REQUEST NUMBER:                                               *
*                                                                      *
************************************************************************
* Program Description:  For new equipments following is done :         *
*                       - customer warranty                            *
*                       - vendor warranty                              *
*                       - measuring points                             *
*                       - configurable material                        *
*                       - estimated running hours                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME         |CORRECTION Nr| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 | 18/09/07 |M.Jacobs      |CD1K920717   | ZAM_OILTYPE ipv    *
*         CH_TL_COMPRESSOR_OIL                                         *
* MOD-002 | 14/11/07 |M.Jacobs      |CD1K923395   | Cust. Warranty :   *
*         no dates when number of months = zero                        *
* MOD-003 | 22/09/08 |M.Jacobs      |CD1K943497   | variable mode      *
* MOD-004 | 04/02/09 |L.Mertens USG |CD1K946072   | CR0452             *
*         select equipments which are still on country funct.loc.level *
* MOD-005 | 05/05/09 |M.Jacobs      |CD1K948019   | NEWGL              *
* MOD-006 | 05/08/11 |L. Mertens    |CD1K967012   | Ticket 16712 New BA*
* MOD-007 | 03/10/11 |J. Smets      |CD1K967012   | CR2177             *
* MOD-008 | 13/12/11 |L.Mertens USG |CD1K969287   | CR2347             *
************************************************************************
REPORT  yse_p025_equipment_completion    NO STANDARD PAGE HEADING
                                         LINE-SIZE 165
                                         LINE-COUNT 80
                                         MESSAGE-ID yse_p025.

TABLES:yse_p025_parms.

************************************************************************
*                   C O N S T A N T S                                  *
************************************************************************
CONSTANTS :c_indicator(1)     TYPE c VALUE 'X' ,
           c_category(1)      TYPE c VALUE 'M' ,
           c_z(1)             TYPE c VALUE 'Z' ,
           c_zam_model(9)     TYPE c VALUE 'ZAM_MODEL' ,
           c_equipment(10)    TYPE c VALUE 'EQUIPMENT' ,
           c_1(1)             TYPE c VALUE '1',
           c_2(1)             TYPE c VALUE '2',
           pc_1(3)            TYPE c VALUE 'PC1',
           pc_2(3)            TYPE c VALUE 'PC2',
           pc_3(3)            TYPE c VALUE 'PC3',
           c_999(3)           TYPE c VALUE '999',
           c_equi_country(20) TYPE c VALUE 'CH_EQUIPMENT_COUNTRY' ,
           gc_z_vc_pgcoil     TYPE vtnam VALUE 'Z_VC_PGCOIL',
           gc_pgc(7)          TYPE c VALUE 'ZAM_PGC' ,
           gc_oiltype(11)     TYPE c VALUE 'ZAM_OILTYPE' ,
* begin of deletion MOD-001
*           gc_compr_oil(20)   TYPE c  VALUE 'CH_TL_COMPRESSOR_OIL',
* end of deletion MOD-001
           c_act_runhours(17) TYPE c  VALUE 'ZAM_RHRSTOTAL_ACT',
           c_est_runhours(13) TYPE c  VALUE 'ZAM_RHRSTOTAL',
           c_default          TYPE imrc_pyeac  VALUE '4000',
           c_mafid            TYPE ausp-mafid  VALUE 'O' ,
           c_klart            TYPE ausp-klart  VALUE '002',
           c_datbi            TYPE v_equi-datbi  VALUE '99991231' .

************************************************************************
*                   V A R I A B L E S                                  *
************************************************************************
DATA:  g_erdat         TYPE equi-erdat ,             " Order Number
       g_bukrs         TYPE iloa-bukrs,
       g_default(1)    TYPE c,                       " default values
       g_subrc         TYPE subrc,
       g_text(100)     TYPE c,
       g_runhours_exist,
       l_mpobj         TYPE imptt-mpobj ,
       g_point         LIKE imptt-point,
       g_valuefield    TYPE zvalue_field,
       g_old_procedure TYPE c,
       g_new_procedure TYPE c,
       g_chansdt(1)    TYPE c,
       g_prctr(1)      TYPE c,
       g_date          TYPE d ,                 " Date in User Format
       gv_atinn_country  TYPE atinn,
       gv_atinn_pgc      TYPE atinn,
       gv_atinn_oiltype  TYPE atinn,
       gv_valc           TYPE atwrt,
       g_equnr         TYPE equi-equnr .             " Equipment Number
* begin of insertion MOD-003
DATA : gv_mode(1)      TYPE c VALUE 'N'.
* end of insertion MOD-003
* begin of insertion MOD-005
DATA : gv_prctr        TYPE prctr.
* end of insertion MOD-005

DATA: gv_plc           TYPE yse_plc.                        "MOD-007

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************

** Equipment details
DATA : BEGIN OF i_equi OCCURS 0,
          equnr TYPE equi-equnr,         " Equipment Number
          erdat TYPE equi-erdat,         " Equipment Creation Date
          ansdt TYPE equi-ansdt,         " Equi acquisition date
          matnr TYPE equi-matnr,         " Material Number
          sernr TYPE equi-sernr,         " Serial Number
          objnr TYPE equi-objnr,         " Object Number
          eqart TYPE equi-eqart,         " Type technical object
          kmatn TYPE equi-kmatn,         " Configurable material
          datab TYPE v_equi-datab,       " Valid from date
          eqtyp TYPE equi-eqtyp,         " equipment category
          vtweg TYPE v_equi-vtweg,       " distribution channel
          bukrs TYPE iloa-bukrs,         " Company code
       END OF i_equi.

** Status table
DATA: BEGIN OF i_status OCCURS 0,
         equnr TYPE equi-equnr,         " Equipment Number
         matnr TYPE equi-matnr,         " Material Number
         sernr TYPE equi-sernr,         " Serial Number
         statusmsg(100) TYPE c,         " Status message
      END OF i_status.

DATA: BEGIN OF i_yse_prctr_deriv OCCURS 0.
        INCLUDE STRUCTURE yse_prctr_deriv.
DATA: END OF i_yse_prctr_deriv.

DATA: l_struct_bdcdata  TYPE bdcdata ,             "BDCDATA table
      l_i_bdcdata TYPE STANDARD TABLE OF bdcdata.  "Table for BDC data

DATA: gt_basic_data TYPE cuvtab      OCCURS 0  WITH HEADER LINE,
      gt_value_n    TYPE cuvtab_valn OCCURS 0  WITH HEADER LINE,
      gt_value_c    TYPE cuvtab_valc OCCURS 0  WITH HEADER LINE,
      gt_value_c2   TYPE cuvtab_valc OCCURS 0  WITH HEADER LINE.

************************************************************************
*       S E L E C T I O N   S C R E E N                                *
************************************************************************

SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.

SELECT-OPTIONS: s_bukrs FOR g_bukrs OBLIGATORY .     "Company
SELECT-OPTIONS: s_erdat FOR g_erdat .                "Posting Date
SELECT-OPTIONS: s_equnr FOR g_equnr .                "Equipment Number

PARAMETERS: p_wntycu AS CHECKBOX DEFAULT 'X',
            p_wntyve AS CHECKBOX DEFAULT 'X'.
PARAMETERS: p_meas   AS CHECKBOX DEFAULT 'X' .
PARAMETERS: p_kmatn  AS CHECKBOX DEFAULT 'X'.

SELECTION-SCREEN: END OF BLOCK b1.

************************************************************************
*    Selection Screen Validations                                      *
************************************************************************
AT SELECTION-SCREEN .

  IF p_wntycu IS INITIAL AND
     p_wntyve IS INITIAL AND
     p_meas   IS INITIAL AND
     p_kmatn  IS INITIAL.
    MESSAGE e001.
  ENDIF .

*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON s_equnr.

  IF NOT s_equnr[] IS INITIAL .
    SELECT equnr INTO g_equnr
           UP TO 1 ROWS
           FROM equi
           WHERE equnr IN s_equnr .
    ENDSELECT .
    IF sy-subrc NE 0.
      MESSAGE e000.
    ENDIF.
  ENDIF .

************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.

** Fetch Equipment Numbers based on the Selection Criteria
  PERFORM get_equipment_numbers .

** Preselect profitcenters
  SELECT * INTO TABLE i_yse_prctr_deriv
       FROM yse_prctr_deriv.
* delete duplicate records on vtweg pgc
  DELETE ADJACENT DUPLICATES FROM i_yse_prctr_deriv
*       COMPARING vtweg pgc.
       COMPARING pgc.
** Preselect variant table for oiltype
  PERFORM preselect_variant_table.

** Update Warranty & Measuring Point + configurable material
  PERFORM update_warranty_measpoint .

************************************************************************
*       E N D - O F - S E L E C T I O N    E V E N T                   *
************************************************************************
END-OF-SELECTION .

** Print a report stating the details updated for Warranty and Measuring
** Points

  IF NOT i_status[] IS INITIAL .
    WRITE:/ text-014 .
    WRITE: text-015 ,
    sy-datum , sy-uzeit .
    ULINE AT /1(165).
    WRITE:  /1  text-016 ,
             20 text-017 ,
             39 text-018 ,
             58 text-019 .
    ULINE AT /1(165).

    LOOP AT i_status .
      AT NEW equnr .
        SKIP 1 .
      ENDAT .

      WRITE: / i_status-equnr, i_status-matnr,
               i_status-sernr, i_status-statusmsg  .
    ENDLOOP .
  ENDIF .

************************************************************************
*       F O R M S                                                      *
************************************************************************

*&---------------------------------------------------------------------*
*&      Form  Get_Equipment_Numbers
*&---------------------------------------------------------------------*
*       Fetch the Equipment Number based on Selection Criteria
*----------------------------------------------------------------------*
FORM get_equipment_numbers .

* begin of delete MOD-004
* DATA: l_date TYPE sy-datum .
*
* l_date = sy-datum - 1 .
* end of delete MOD-004

* begin of insert MOD-004
  DATA: i_iflot TYPE STANDARD TABLE OF iflot WITH HEADER LINE.
* end of insert MOD-004

** IF selection screen date range and equipment no. range are not
** provided

  IF s_erdat[] IS INITIAL AND s_equnr[] IS INITIAL .

* begin of insert MOD-004
    SELECT * INTO TABLE i_iflot
           FROM iflot
           WHERE tplma = ' '.

    LOOP AT i_iflot.
      IF i_iflot-tplnr+2(1) NE ' '.
        DELETE i_iflot.
      ENDIF.
    ENDLOOP.

    IF i_iflot[] IS INITIAL.
*  Write Error message - No country funct.loc.levels available in table IFLOT
      WRITE: / text-044 .
      EXIT.
    ENDIF.
* end of insert MOD-004

    SELECT equnr erdat ansdt matnr sernr objnr
           eqart kmatn datab eqtyp vtweg bukrs
           INTO TABLE i_equi
           FROM v_equi
* begin of change MOD-004
*           WHERE erdat BETWEEN l_date AND sy-datum
           FOR ALL ENTRIES IN i_iflot
           WHERE tplnr = i_iflot-tplnr
* end of change MOD-004
             AND datbi = c_datbi
             AND bukrs IN s_bukrs.

    IF sy-subrc NE 0  .
*  Write Error message - No data available for the Selection Criteria
      WRITE: / text-002 .
    ELSE .
      DELETE ADJACENT DUPLICATES FROM i_equi COMPARING equnr .
    ENDIF .

  ELSE .

** IF selection screen date range or equipment no. range are
** provided in the selection screen
    SELECT equnr erdat ansdt matnr sernr objnr
           eqart kmatn datab eqtyp vtweg bukrs
           INTO TABLE i_equi
           FROM v_equi
           WHERE equnr IN s_equnr
             AND erdat IN s_erdat
             AND datbi =  c_datbi
             AND bukrs IN s_bukrs.
    IF sy-subrc NE 0  .
*  Write Error message - No data available for the Selection Criteria
      WRITE: / text-002 .
    ELSE .
      DELETE ADJACENT DUPLICATES FROM i_equi COMPARING equnr .
    ENDIF .
  ENDIF .

ENDFORM.                    " Get_Equipment_Numbers

*&---------------------------------------------------------------------*
*&      Form  Update_Warranty_MeasPoint
*&---------------------------------------------------------------------*
*       Update Warranty & Measurement Point Details
*----------------------------------------------------------------------*
FORM update_warranty_measpoint .

  DATA: l_objnr TYPE bgmkobj-j_objnr ,        " Object Number
        l_warranty_flag(1) TYPE c    ,        " Warranty Flag
        l_cust_warranty_flag(1) TYPE c,       " Customer warranty flag
        l_vend_warranty_flag(1) TYPE c,       " Vendor   warranty flag
        l_prdha TYPE prodh_d,                 " Product hierarchy
        l_zprodh3 TYPE zprodh3,         " AM: Product Hierarchy L3 - PGC
        l_zcolnr TYPE zcolnr,                 " AM: Column number
        lv_yba   TYPE yba,                    " Business area          +MOD-008
        l_mpexist(1) TYPE c,                  " Meas.point exist flag
        l_meas_flag(1) TYPE c        ,        " Measurement Flag
        l_cust_warr_end_date TYPE sy-datum ,  " Cust Warranty End date
        l_vend_warr_end_date TYPE sy-datum ,  " Vend Warranty End date
        l_date TYPE d ,                       " Date in User Format
        l_atbez TYPE cabnt-atbez   ,
        l_text(100) TYPE c         ,
        l_cus_warr_months TYPE int4,
        l_ven_warr_months TYPE int4,
        l_kmatn TYPE kmatn,
        l_langu TYPE langu.

  DATA: BEGIN OF l_i_yam_p025_mp_char OCCURS 0,
           zcolnr TYPE yam_p025_mp_char-zcolnr, " AM: Column number
           zvalue TYPE yam_p025_mp_char-zvalue, " Position
           atnam  TYPE yam_p025_mp_char-atnam,  " Characteristic Name
           indct  TYPE yam_p025_mp_char-indct,  " Indicator
           atbez  TYPE cabnt-atbez,             " Char. description
           atinn  TYPE ausp-atinn,              " Internal characterist.
        END OF l_i_yam_p025_mp_char.

** Loop through the internal table and update the required information
  LOOP AT i_equi .

* Clear Variables
    CLEAR: l_objnr,
           l_warranty_flag ,
           l_cust_warranty_flag,
           l_vend_warranty_flag,
           l_cust_warr_end_date,
           l_vend_warr_end_date,
           l_i_bdcdata.

** determine profit center and get the corresponding YSE_P025-record

    CLEAR: l_prdha,
           l_cus_warr_months,
           l_ven_warr_months,
           l_kmatn,
           l_langu,
           g_chansdt.

    SELECT SINGLE prdha INTO l_prdha
           FROM mara
           WHERE matnr = i_equi-matnr.
    IF sy-subrc IS INITIAL.
      CLEAR i_yse_prctr_deriv-prctr.
      READ TABLE i_yse_prctr_deriv WITH KEY
*                 vtweg = i_equi-vtweg
                 pgc   = l_prdha+4(4).
      IF sy-subrc EQ 0.
* begin of insertion MOD-005
        gv_prctr = i_yse_prctr_deriv-prctr.
        CALL FUNCTION 'YSE_CONVERT_PRCTR_BL'
          EXPORTING
            prctr_in    = gv_prctr
            bukrs       = i_equi-bukrs
          IMPORTING
            segment_out = gv_prctr.
* end of insertion MOD-005

*** MOD-007 * begin ***
*        SELECT SINGLE * FROM yse_p025_parms
*          WHERE bukrs EQ i_equi-bukrs AND plc =
** begin of change MOD-005
**           i_yse_prctr_deriv-prctr+6(2).
*          gv_prctr+6(2).
** end of change MOD-005
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = gv_prctr
          IMPORTING
            output = gv_plc.
        IF gv_plc CO '0123456789'.
          gv_plc+2(1) = ' '.
        ENDIF.
        SELECT SINGLE * FROM yse_p025_parms
               WHERE bukrs = i_equi-bukrs
                 AND plc   = gv_plc.
*** MOD-007 * end ***
        IF sy-subrc IS INITIAL.
          l_cus_warr_months = yse_p025_parms-cus_warr_months.
          l_ven_warr_months = yse_p025_parms-ven_warr_months.
          l_kmatn = yse_p025_parms-kmatn.
          l_langu = yse_p025_parms-langu.
        ELSE.
* no record found in YSE_P025_PARMS
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-037 .
        ENDIF.
      ELSE.
* no record in yse_prctr_deriv
        g_text = text-040.
        REPLACE '&1' IN g_text WITH i_equi-vtweg.
        REPLACE '&2' IN g_text WITH l_prdha+4(4).
        PERFORM status_message_update USING i_equi-equnr
                                            i_equi-matnr
                                            i_equi-sernr
                                            g_text.
      ENDIF.

* Validate if Warranty update checkbox is checked
      IF p_wntycu NE c_indicator AND
         p_wntyve NE c_indicator.
** Populate Status table with Warranty Information not populated - Sel.
**                            Screen Checkbox not checked
        PERFORM status_message_update USING i_equi-equnr
                                            i_equi-matnr
                                            i_equi-sernr
                                            text-006 .
        l_warranty_flag = c_indicator .
      ELSE .
* if acquistition date is not filled in , take valid-from-date
        IF i_equi-ansdt IS INITIAL.
          i_equi-ansdt = i_equi-datab.
          g_chansdt = 'Y'.
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-039 .
        ENDIF.
        IF NOT i_equi-ansdt IS INITIAL .

** Validate if customer warranty detail is already available or not
          IF p_wntycu EQ c_indicator.
            SELECT j_objnr INTO l_objnr
                   FROM bgmkobj
                   UP TO 1 ROWS
                   WHERE j_objnr EQ i_equi-objnr
                     AND gaart   EQ c_1
                     AND lvorm   NE c_indicator .
            ENDSELECT .

            IF sy-subrc EQ 0 .
** Populate Status table with cust. Warranty Details already available
              PERFORM status_message_update USING i_equi-equnr
                                                  i_equi-matnr
                                                  i_equi-sernr
                                                  text-003 .
              l_cust_warranty_flag = c_indicator .
            ELSE .
              CALL FUNCTION 'MONTH_PLUS_DETERMINE'
                EXPORTING
                  months  = l_cus_warr_months
                  olddate = i_equi-ansdt
                IMPORTING
                  newdate = l_cust_warr_end_date.
            ENDIF .
          ENDIF.

** Validate if vendor warranty detail is already available or not
          IF p_wntyve EQ c_indicator.
            SELECT j_objnr INTO l_objnr
                   FROM bgmkobj
                   UP TO 1 ROWS
                   WHERE j_objnr EQ i_equi-objnr
                     AND gaart   EQ c_2
                     AND lvorm   NE c_indicator .
            ENDSELECT .

            IF sy-subrc EQ 0 .
** Populate Status table with vendor Warranty Details already available
              PERFORM status_message_update USING i_equi-equnr
                                                  i_equi-matnr
                                                  i_equi-sernr
                                                  text-023 .
              l_vend_warranty_flag = c_indicator.
            ELSE .
              CALL FUNCTION 'MONTH_PLUS_DETERMINE'
                EXPORTING
                  months  = l_ven_warr_months
                  olddate = i_equi-ansdt
                IMPORTING
                  newdate = l_vend_warr_end_date.
            ENDIF .
          ENDIF.
        ELSE .

** Populate Status table with Equipment acquisition date not available
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-004 .
          l_warranty_flag = c_indicator .
        ENDIF .
      ENDIF.

    ENDIF .

********* Call Transaction IE02 ***********************

** Fill bdcdata structure
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMIEQ0'  '0100'  'X'  ''  ''
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'RM63E-EQUNR'
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '/00'
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'RM63E-EQUNR'  i_equi-equnr
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

** Screen 2
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMIEQ0'  '0101'  'X'  ''  ''
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_OKCODE'  '=T\05'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_CURSOR'  'ITOB-SHTXT'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

* fill acquisition date with valid from date.
* not for eqtyp = X or Y
    IF g_chansdt = 'Y' AND ( i_equi-eqtyp <> 'X'
     AND i_equi-eqtyp <> 'Y' ).

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_CURSOR'  'ITOB-ANSDT'
               CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      WRITE i_equi-ansdt TO g_date .
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'ITOB-ANSDT'  g_date
                     CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

    ENDIF.

** Screen 3
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMIEQ0'  '0101'  'X'  ''  ''
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_OKCODE'  '=MEPO'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_CURSOR'  'WCHECK_V_H-GAERB_I'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    IF l_warranty_flag NE c_indicator .

** Populate Warranty Details

      IF p_wntycu EQ c_indicator.

** customer warranty Only for equipments of category Z
        IF i_equi-eqtyp = c_z.
* begin of change MOD-002
* only change customer warranty when number of months <> 0
*         IF l_cust_warranty_flag NE c_indicator.
          IF l_cust_warranty_flag NE c_indicator AND
             l_cus_warr_months NE 0 .
* end of change MOD-002
** Customer Warranty Begin Date
            WRITE i_equi-ansdt TO l_date .
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'WCHECK_V_H-GWLDT_O'  l_date
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

** Customer Warranty End Date
            WRITE l_cust_warr_end_date TO l_date .
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING ''  ''  ''  'WCHECK_V_H-GWLEN_O'  l_date
                   CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

** Customer Warranty (Inherit/Warranty)
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'WCHECK_V_H-WAGET_O'  c_indicator
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

** Customer Warranty (Pass on Warranty)
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'WCHECK_V_H-GAERB_O'  c_indicator
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

** Populate Status table with Customer Warranty Details Populated
            PERFORM status_message_update USING i_equi-equnr
                                                i_equi-matnr
                                                i_equi-sernr
                                                text-025.
          ENDIF.
        ENDIF.
      ENDIF.

      IF p_wntyve EQ c_indicator.

        IF l_vend_warranty_flag NE c_indicator.

** Vendor Warranty Begin date
          WRITE i_equi-ansdt TO l_date .
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'WCHECK_V_H-GWLDT_I'  l_date
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

** Vendor Warranty End date
          WRITE l_vend_warr_end_date TO l_date .
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING ''  ''  ''  'WCHECK_V_H-GWLEN_I'  l_date
                 CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

** Vendor Warranty (Inherit/Warranty)
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'WCHECK_V_H-WAGET_I'   c_indicator
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

** Vendor Warranty (Pass on Warranty)
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'WCHECK_V_H-GAERB_I'   c_indicator
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

** Populate Status table with Vendor Warranty Details Populated
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-005 .
        ENDIF.
      ENDIF.
    ENDIF .

** Measuring Points
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIMR0'  '4110'  'X'  ''   ''
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'IMPT-INDCT(01)'
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '/00'
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

** Ignore if selection screen option for MEAS point not checked
    IF p_meas EQ c_indicator .

      REFRESH l_i_yam_p025_mp_char.
      CLEAR g_prctr.

* check if 1 measuring point is already created
      l_mpexist = 'N'.
      SELECT mpobj INTO l_mpobj
                   FROM imptt
                   UP TO 1 ROWS
                   WHERE mpobj EQ i_equi-objnr .
      ENDSELECT .
      IF sy-subrc EQ 0 .
        l_mpexist = 'Y'.
      ENDIF.

      IF l_prdha NE space.
        l_zprodh3 = l_prdha+4(4).
        g_default = 'N'.
        CLEAR l_zcolnr.
        SELECT SINGLE zcolnr INTO l_zcolnr
               FROM yam_p025_mp_pgc
               WHERE zprodh3 = l_zprodh3.
        IF sy-subrc NE 0 .
** Populate Status table with No Measuring Points available
** in custom table
          IF NOT i_equi-eqart = c_equipment.
            PERFORM status_message_update USING i_equi-equnr
                                                i_equi-matnr
                                                i_equi-sernr
                                                text-010 .
          ELSE.
** different measuring point for different profit center
*              l_zcolnr = c_999.
* begin of change mod-005
*            g_prctr = i_yse_prctr_deriv-prctr+6(1).
            g_prctr = gv_prctr+6(1).
* end of change MOD-005
* begin of insert MOD-008
            CLEAR lv_yba.
            SELECT SINGLE yba INTO lv_yba
              FROM yse_segm_ba WHERE segment = gv_prctr.

            CASE lv_yba.
              WHEN 'CT'.
                g_prctr = '1'.
              WHEN 'CR'.
                g_prctr = '1'.
              WHEN 'MR'.
                g_prctr = '2'.
              WHEN 'IT'.
                g_prctr = '3'.
            ENDCASE.
* end of insert MOD-008
            CASE g_prctr.
              WHEN '1'.
                l_zcolnr = pc_1.
              WHEN '2'.
                l_zcolnr = pc_2.
              WHEN '3'.
                l_zcolnr = pc_3.
* begin of insert MOD-006
              WHEN OTHERS.
                l_zcolnr = pc_1.
* end of insert MOD-006
            ENDCASE.
            g_default = 'Y'.
            SELECT zcolnr zvalue atnam indct
                   INTO TABLE l_i_yam_p025_mp_char
                   FROM yam_p025_mp_char
                   WHERE zcolnr = l_zcolnr.
          ENDIF.
        ELSE.
          SELECT zcolnr zvalue atnam indct
                 INTO TABLE l_i_yam_p025_mp_char
                 FROM yam_p025_mp_char
                 WHERE zcolnr = l_zcolnr.
          IF sy-subrc NE 0.
            IF NOT i_equi-eqart = c_equipment.
              PERFORM status_message_update USING i_equi-equnr
                                                  i_equi-matnr
                                                  i_equi-sernr
                                                  text-010 .
            ELSE.
** different measuring point for different profit center
*              l_zcolnr = c_999.
* begin of change MOD-005
*              g_prctr = i_yse_prctr_deriv-prctr+6(1).
              g_prctr = gv_prctr+6(1).
* end of change MOD-005
* begin of insert MOD-008
              CLEAR lv_yba.
              SELECT SINGLE yba INTO lv_yba
                FROM yse_segm_ba WHERE segment = gv_prctr.

              CASE lv_yba.
                WHEN 'CT'.
                  g_prctr = '1'.
                WHEN 'CR'.
                  g_prctr = '1'.
                WHEN 'MR'.
                  g_prctr = '2'.
                WHEN 'IT'.
                  g_prctr = '3'.
              ENDCASE.
* end of insert MOD-008
              CASE g_prctr.
                WHEN '1'.
                  l_zcolnr = pc_1.
                WHEN '2'.
                  l_zcolnr = pc_2.
                WHEN '3'.
                  l_zcolnr = pc_3.
* begin of insert MOD-006
                WHEN OTHERS.
                  l_zcolnr = pc_1.
* end of insert MOD-006
              ENDCASE.
              g_default = 'Y'.
              SELECT zcolnr zvalue atnam indct
                     INTO TABLE l_i_yam_p025_mp_char
                     FROM yam_p025_mp_char
                     WHERE zcolnr = l_zcolnr.
            ENDIF.
          ENDIF.
        ENDIF .
      ELSE .
        IF NOT i_equi-eqart = c_equipment.
* Populate Status table with Material or PGC not available
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-026.
        ELSE.
** different measuring point for different profit center
*          l_zcolnr = c_999.
* begin of change MOD-005
*          g_prctr = i_yse_prctr_deriv-prctr+6(1).
          g_prctr = gv_prctr+6(1).
* end of change MOD-005
* begin of insert MOD-008
          CLEAR lv_yba.
          SELECT SINGLE yba INTO lv_yba
            FROM yse_segm_ba WHERE segment = gv_prctr.

          CASE lv_yba.
            WHEN 'CT'.
              g_prctr = '1'.
            WHEN 'CR'.
              g_prctr = '1'.
            WHEN 'MR'.
              g_prctr = '2'.
            WHEN 'IT'.
              g_prctr = '3'.
          ENDCASE.
* end of insert MOD-008
          CASE g_prctr.
            WHEN '1'.
              l_zcolnr = pc_1.
            WHEN '2'.
              l_zcolnr = pc_2.
            WHEN '3'.
              l_zcolnr = pc_3.
* begin of insert MOD-006
            WHEN OTHERS.
              l_zcolnr = pc_1.
* end of insert MOD-006
          ENDCASE.
          g_default = 'Y'.
          SELECT zcolnr zvalue atnam indct
                 INTO TABLE l_i_yam_p025_mp_char
                 FROM yam_p025_mp_char
                 WHERE zcolnr = l_zcolnr.
        ENDIF.
      ENDIF .

*   Populate characteristic description
      CLEAR l_meas_flag .
      LOOP AT l_i_yam_p025_mp_char.
        CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
          EXPORTING
            input  = l_i_yam_p025_mp_char-atnam
          IMPORTING
            output = l_i_yam_p025_mp_char-atinn.

** check if MP already created - if not, create new MP
        SELECT mpobj INTO l_mpobj
               FROM imptt
               WHERE mpobj EQ i_equi-objnr
                 AND atinn EQ l_i_yam_p025_mp_char-atinn.
        ENDSELECT.
        IF sy-subrc IS INITIAL.
          DELETE l_i_yam_p025_mp_char.
          CONTINUE.
        ENDIF.

        SELECT atbez INTO l_i_yam_p025_mp_char-atbez
               FROM cabnt
               UP TO 1 ROWS
               WHERE atinn EQ l_i_yam_p025_mp_char-atinn
                 AND spras EQ l_langu
                 AND lkenz NE c_indicator .
        ENDSELECT .
        IF sy-subrc NE 0 .
          l_meas_flag = c_indicator .
** Populate Status table with Characteristic Name Invalid
          CLEAR l_text .
          CONCATENATE text-013 l_i_yam_p025_mp_char-atnam INTO l_text.
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              l_text .

        ELSE .
          MODIFY l_i_yam_p025_mp_char.
        ENDIF .
      ENDLOOP .
      g_runhours_exist = 'N'.

      IF NOT l_i_yam_p025_mp_char[] IS INITIAL AND
         l_meas_flag EQ space .
        LOOP AT l_i_yam_p025_mp_char .
          IF l_i_yam_p025_mp_char-atnam = c_act_runhours OR
             l_i_yam_p025_mp_char-atnam = c_est_runhours.
            g_runhours_exist = 'Y'.
          ENDIF.

          IF l_mpexist = 'N'.                   " none exist already
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING ''  ''  ''  'IMPT-PSORT(01)'
                      l_i_yam_p025_mp_char-zvalue
                  CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING ''  ''  ''  'IMPT-MPTYP(01)'  c_category
                  CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING ''  ''  ''  'IMPT-ATNAM(01)'
                       l_i_yam_p025_mp_char-atnam
                  CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING ''  ''  ''  'IMPT-PTTXT(01)'
                      l_i_yam_p025_mp_char-atbez
             CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            IF l_i_yam_p025_mp_char-indct EQ c_indicator .
              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING ''  ''  ''  'IMPT-INDCT(01)'  c_indicator
                    CHANGING l_struct_bdcdata.
              APPEND l_struct_bdcdata  TO l_i_bdcdata.
              CLEAR  l_struct_bdcdata.
            ENDIF .

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPLIMR0'  '4110'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IMPT-PSORT(01)'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_OKCODE'  '=ADDP'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            l_mpexist = 'Y'.
          ELSE .
** More than One Record **

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPLIMR0'  '4110'  'X'  ''   ''
                   CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IMPT-PSORT(01)'
                   CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'BDC_OKCODE'  '=ADDP'
                   CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPLIMR0'  '4110'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IMPT-INDCT(02)'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

**********2 entry *******
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING ''  ''  ''  'IMPT-PSORT(02)'
                       l_i_yam_p025_mp_char-zvalue
                  CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING ''  ''  ''  'IMPT-MPTYP(02)'  c_category
                  CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING ''  ''  ''  'IMPT-ATNAM(02)'
                       l_i_yam_p025_mp_char-atnam
                  CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING ''  ''  ''  'IMPT-PTTXT(02)'
                       l_i_yam_p025_mp_char-atbez
             CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            IF l_i_yam_p025_mp_char-indct EQ c_indicator .
              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING ''  ''  ''  'IMPT-INDCT(02)'  c_indicator
                    CHANGING l_struct_bdcdata.
              APPEND l_struct_bdcdata  TO l_i_bdcdata.
              CLEAR  l_struct_bdcdata.
            ENDIF .
          ENDIF .

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPLIMR0'  '4110'  'X'  ''   ''
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IMPT-PSORT(01)'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=ADDP'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

        ENDLOOP .

** Populate Status table with Measurement Points Populated
        IF g_default = 'Y'.
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-020.
        ELSE.
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-007 .
        ENDIF.
      ELSE.
** Populate Status table with MP already available or one of char. names
** is invalid, No MP details created
        PERFORM status_message_update USING i_equi-equnr
                                            i_equi-matnr
                                            i_equi-sernr
                                            text-027.
      ENDIF .
    ELSE .
** Populate Status table with Measurement Points not Populated
      PERFORM status_message_update USING i_equi-equnr
                                          i_equi-matnr
                                          i_equi-sernr
                                          text-008 .
    ENDIF .

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIMR0'  '4110'  'X'  ''   ''
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_OKCODE'  '/ERW'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'IMPT-PSORT(01)'
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

* Configuration data setup
**************************
    IF p_kmatn = c_indicator.

      IF i_equi-kmatn IS INITIAL.

        IF i_equi-eqart = c_equipment.
*             get internal numbers for the characteristics
          SELECT SINGLE atinn INTO gv_atinn_country
                 FROM cabn
                 WHERE atnam = c_equi_country.

          IF sy-subrc <> 0.
* Could not find char.CH_EQUIPMENT_COUNTRY - Config.data not populated
            PERFORM status_message_update USING i_equi-equnr
                                                i_equi-matnr
                                                i_equi-sernr
                                                text-041.
          ELSE.

            SELECT SINGLE atinn INTO gv_atinn_pgc
                FROM cabn
                WHERE atnam = gc_pgc.

            IF sy-subrc <> 0.
*                Could not find char.ZAM_PGC - Config.data not populated
              PERFORM status_message_update USING i_equi-equnr
                                                  i_equi-matnr
                                                  i_equi-sernr
                                                  text-042.
            ELSE.

              SELECT SINGLE atinn INTO gv_atinn_oiltype
                     FROM cabn
                     WHERE atnam = gc_oiltype.

              IF sy-subrc <> 0.
*            Could not find char.ZAM_OILTYPE - Config.data not populated
                PERFORM status_message_update USING i_equi-equnr
                                                    i_equi-matnr
                                                    i_equi-sernr
                                                    text-043.
              ELSE.
*                   determine value for char. 'ZAM_OILTYPE'
                CLEAR gv_valc.
                PERFORM determine_char_value USING    l_prdha
                                             CHANGING gv_valc.
              ENDIF.
            ENDIF.
          ENDIF.

          IF l_kmatn NE space.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPMIEQ0'  '0101'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'BDC_OKCODE'  '=AUSI'
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

* View selection
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPMIEQ0'  '1030'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'EQUI-S_KONFI'  c_indicator
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'BDC_OKCODE'  '/ERW'
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPMIEQ0'  '0101'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'BDC_OKCODE'  '=T\09'
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

* Configuration data
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPMIEQ0'  '0101'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'EQUI-KMATN'  l_kmatn
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'BDC_OKCODE'  '=COCH'
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

* Maintain characteristics
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    'SAPLCEI0'  '0109'  'X'  ''   ''
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RCTMS-MNAME(01)'  c_equi_country
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'RCTMS-MWERT(01)'  i_equi-bukrs
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.
* fill 2nd characteristic
            IF NOT gv_valc IS INITIAL.
* begin of deletion MOD-001
*              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'RCTMS-MNAME(02)'  gc_compr_oil
*                      CHANGING l_struct_bdcdata.
* end of deletion MOD-001
* begin of insertion MOD-001
              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'RCTMS-MNAME(02)'  gc_oiltype
                                   CHANGING l_struct_bdcdata.

* end of insertion MOD-001
              APPEND l_struct_bdcdata  TO l_i_bdcdata.
              CLEAR  l_struct_bdcdata.

              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING    ''  ''  ''  'RCTMS-MWERT(02)'  gv_valc
                      CHANGING l_struct_bdcdata.
              APPEND l_struct_bdcdata  TO l_i_bdcdata.
              CLEAR  l_struct_bdcdata.
            ENDIF.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING    ''  ''  ''  'BDC_OKCODE'  '=BACK'
                     CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

*           Configuration data populated
            PERFORM status_message_update USING i_equi-equnr
                                                i_equi-matnr
                                                i_equi-sernr
                                                text-030.
          ELSE.
*           no configurable material available in YSE_P025_PARMS
            PERFORM status_message_update USING i_equi-equnr
                                                i_equi-matnr
                                                i_equi-sernr
                                                text-038.
          ENDIF.
        ELSE.
*         PRODH not available - Configuration data not populated
          PERFORM status_message_update USING i_equi-equnr
                                              i_equi-matnr
                                              i_equi-sernr
                                              text-028.
        ENDIF.
      ELSE.
** Populate Status table with Configuration data already available
        PERFORM status_message_update USING i_equi-equnr
                                            i_equi-matnr
                                            i_equi-sernr
                                            text-032.
      ENDIF.
    ELSE .
** Populate Status table with Configuration data not Populated
      PERFORM status_message_update USING i_equi-equnr
                                          i_equi-matnr
                                          i_equi-sernr
                                          text-031 .
    ENDIF.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMIEQ0'  '0101'  'X'  ''   ''
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    IF NOT l_i_bdcdata[] IS INITIAL.
* Perform Call Transaction to update the customer
      CALL TRANSACTION 'IE02' USING l_i_bdcdata
* begin of change MOD-003
*      MODE 'N' UPDATE 'S' .
       MODE gv_mode UPDATE 'S' .
* end of change MOD-003
      IF sy-subrc NE 0 .
** Populate Status table with Call Transaction failed
        PERFORM status_message_update USING i_equi-equnr
                                            i_equi-matnr
                                            i_equi-sernr
                                            text-012 .
      ELSE.
        IF p_meas = c_indicator AND g_runhours_exist = 'Y'.

          REFRESH l_i_bdcdata.
          PERFORM prep_update_measpoint USING c_act_runhours.

          IF NOT l_i_bdcdata[] IS INITIAL.
            CALL TRANSACTION 'IK02' USING l_i_bdcdata
* begin of change MOD-003
*                  MODE 'N' UPDATE 'S' .
                  MODE gv_mode UPDATE 'S' .
* end of change MOD-003
            g_subrc = sy-subrc.

            REFRESH l_i_bdcdata.
            PERFORM prep_update_measpoint USING c_est_runhours.

            IF NOT l_i_bdcdata[] IS INITIAL.
              CALL TRANSACTION 'IK02' USING l_i_bdcdata
* begin of change MOD-003
*                     MODE 'N' UPDATE 'S' .
                     MODE gv_mode UPDATE 'S' .
* end of change MOD-003

              IF sy-subrc NE 0 OR g_subrc NE 0.
**              Populate Status table with Call Transaction failed
                PERFORM status_message_update USING i_equi-equnr
                                                    i_equi-matnr
                                                    i_equi-sernr
                                                    text-033 .
              ENDIF.

            ENDIF.

          ENDIF.

        ENDIF.

      ENDIF .
      REFRESH l_i_bdcdata.
    ENDIF.
  ENDLOOP .

ENDFORM.                    " Update_Warranty_MeasPoint

*&---------------------------------------------------------------------*
*&      Form  Status_message_update
*&---------------------------------------------------------------------*
*       Populate status message table
*----------------------------------------------------------------------*
*      -->P_I_EQUI_EQUNR  Equipment Number
*      -->P_I_EQUI_MATNR  Material Number
*      -->P_I_EQUI_SERNR  Serial Number
*      -->P_TEXT          Status Message Text
*----------------------------------------------------------------------*
FORM status_message_update  USING    p_i_equi_equnr TYPE any
                                     p_i_equi_matnr TYPE any
                                     p_i_equi_sernr TYPE any
                                     p_text   TYPE any .

  i_status-equnr = p_i_equi_equnr .
  i_status-matnr = p_i_equi_matnr .
  i_status-sernr = p_i_equi_sernr .
  i_status-statusmsg = p_text     .
  APPEND i_status .
  CLEAR  i_status .

ENDFORM.                    " Status_message_update

*&---------------------------------------------------------------------*
*&      Form  prep_update_measpoint
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_RUNHOURS  text
*----------------------------------------------------------------------*
FORM prep_update_measpoint  USING  p_runhours.

  DATA: g_atinn    TYPE atinn,
        g_est_flag.

  CLEAR g_est_flag.

* get internal number for the characteristic
  SELECT SINGLE atinn INTO g_atinn
         FROM cabn
         WHERE atnam = p_runhours.

  IF sy-subrc = 0.
    CONCATENATE 'IE' i_equi-equnr INTO l_mpobj.
    SELECT point INTO g_point
           FROM imptt
           WHERE atinn = g_atinn
             AND mpobj = l_mpobj.
    ENDSELECT.

    IF sy-subrc NE 0.
*     characteristic not available - 'Annual estimate' not populated
      g_text = text-035.
      REPLACE '&' IN g_text WITH p_runhours.
      PERFORM status_message_update USING i_equi-equnr
                                          i_equi-matnr
                                          i_equi-sernr
                                          g_text.
      g_est_flag = c_indicator.
    ELSE.
*     'Annual estimate' populated
      g_text = text-034.
      REPLACE '&' IN g_text WITH p_runhours.
      PERFORM status_message_update USING i_equi-equnr
                                          i_equi-matnr
                                          i_equi-sernr
                                          g_text.
    ENDIF.

  ELSE.
*   characteristic not available - 'Annual estimate' not populated
    g_text = text-035.
    REPLACE '&' IN g_text WITH p_runhours.
    PERFORM status_message_update USING i_equi-equnr
                                        i_equi-matnr
                                        i_equi-sernr
                                        g_text.
    g_est_flag = c_indicator.
  ENDIF.

  IF g_est_flag NE c_indicator.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIMR0'  '1110'  'X'  ''   ''
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'IMPT-POINT'  g_point
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_OKCODE'  '/00'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLIMR0'  '5110'  'X'  ''   ''
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'RIMR0-PYEAC'  c_default
            CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
             CHANGING l_struct_bdcdata.
    APPEND l_struct_bdcdata  TO l_i_bdcdata.
    CLEAR  l_struct_bdcdata.

  ENDIF.

ENDFORM.                    " prep_update_measpoint

*&---------------------------------------------------------------------*
*&      Form  preselect_variant_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM preselect_variant_table .

  CALL FUNCTION 'CUTX_INIT_STRUC_ENTRY_PLANNING'
    EXPORTING
      var_tab                = gc_z_vc_pgcoil
    TABLES
      et_basic_data          = gt_basic_data
*     ET_TABLE_TEXTS         =
*     ET_TABLE_FIELDS        =
*     ET_TABLE_INDICES       =
*     ET_TABLE_LINE          =
      et_table_value_n       = gt_value_n
      et_table_value_c       = gt_value_c
    EXCEPTIONS
      table_not_found        = 1
      OTHERS                 = 2.

ENDFORM.                    " preselect_variant_table

*&---------------------------------------------------------------------*
*&      Form  determine_char_value
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_L_PRDHA  text
*      -->P_GV_VALC  text
*----------------------------------------------------------------------*
FORM determine_char_value USING    p_l_prdha
                          CHANGING p_gv_valc.

  gt_value_c2[] = gt_value_c[].
  SORT gt_value_c2 BY mandt vtint slnid atinn.

  READ TABLE gt_basic_data WITH KEY mandt = sy-mandt
                                    vtnam = gc_z_vc_pgcoil.

  IF sy-subrc = 0.
*.. get oiltype
    LOOP AT gt_value_c WHERE mandt = sy-mandt
                         AND vtint = gt_basic_data-vtint
                         AND atinn = gv_atinn_pgc
                         AND valc  = p_l_prdha+4(4).

      READ TABLE gt_value_c2 WITH KEY mandt = sy-mandt
                                      vtint = gt_basic_data-vtint
                                      slnid = gt_value_c-slnid
                                      atinn = gv_atinn_country
                                      valc  = i_equi-bukrs
                           BINARY SEARCH.

      IF sy-subrc = 0.
        READ TABLE gt_value_c2 WITH KEY mandt = sy-mandt
                                        vtint = gt_basic_data-vtint
                                        slnid = gt_value_c2-slnid
                                        atinn = gv_atinn_oiltype
                              BINARY SEARCH.

        IF sy-subrc = 0.
          MOVE gt_value_c2-valc TO p_gv_valc.
          EXIT.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " determine_char_value

*Text symbol text
*001:Selection Screen Input
*002:No data available for the Selection Criteria
*003:Customer Warranty Details already available - Customer Warranty Info not populated
*004:Equipment acquisition date not available - Warranty Info not populated
*005:Vendor Warranty Information populated
*006:Warranty Information not populated - Sel. Screen Checkbox not checked
*007:Measurement Points populated
*008:Measuring Points not populated - Sel. Screen Checkbox not checked
*009:Measuring Points already available,  no Meas Point details to be created
*010:No Measuring Points available in the custom table
*011:Characteristic ZAM_MODEL or  characteristic value not available
*012:Call Transaction failed !!
*013:Characteristic Name is invalid, check Characteristic -
*014:Atlas Copco - Warranty/Meas.point/Configuration data
*015:creation for new equipments status report as on -
*016:Equipment Number
*017:Material Number
*018:Serial Number
*019:Status Message
*020:Measurement Points populated with default measuring points.
*023:Vendor Warranty Details already available - Vendor Warranty Info not populated
*025:Customer Warranty Information populated
*026:Material or PGC not available
*027:MP already available or one of char.names is invalid, no MP details created
*028:PRODH not available - Configuration data not populated
*029:No Profitcenter available - Configuration data not populated
*030:Configuration data populated
*031:Configuration data not populated - Sel. Screen Checkbox not checked
*032:Configuration data already available
*033:Call Transaction 'IK02' failed !!
*034:'Annual estimate' in & populated
*035:& not available - 'Annual estimate' not populated
*036:Invalid product hierarchy
*037:Record does not exist in YSE_P025_PARMS
*038:No configurable material available in YSE_P025_PARMS
*039:Acquisition date filled with valid from date
*040:No profit center for distribution channel &1 and pgc &2.
*041:No record found in table CABN for CH_EQUIPMENT_COUNTRY
*042:No record found in table CABN for ZAM_PGC
*043:No record found in table CABN for ZAM_OILTYPE

*044:No country funct.loc.levels available in table IFLOT
*Selection text
*P_KMATN:        Create Configuration tab
*P_MEAS:        Create  Measuring Points
*P_WNTYCU:        Create Customer Warranty info
*P_WNTYVE:        Create Vendor Warranty info
*S_BUKRS:        Company Code
*S_EQUNR:        Equipment Number
*S_ERDAT:        Equipment Creation Date
