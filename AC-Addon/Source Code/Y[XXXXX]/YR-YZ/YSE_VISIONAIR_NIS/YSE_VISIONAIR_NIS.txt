*----------------------------------------------------------------------
* PROGRAM ID           : YSE_ORDERS_INVOICED                           *
* PROGRAM TITLE        : VisionAir interface - NIS                     *
* AUTHOR               : Anda  Wu                                      *
* DATE                 : 28/9/2016                                     *
* DEVELOPMENT ID       : CR3987                                        *
* CHANGE REQUEST NUMBER: CD1K989781                                    *
* PROGRAM DESCRIPTION  : Copy from program    YSE_ORDERS_INVOICED      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME                |CORRECTION NR| CHANGE REF# *
*----------------------------------------------------------------------*
* MOD-XXX |DD/MM/YYYY|XXXXXXXXX            |CD1KXXXXXX   | NEWGL       *
*----------------------------------------------------------------------*
REPORT yse_orders_invoiced NO STANDARD PAGE HEADING
                                    LINE-SIZE 256.

TYPE-POOLS: slis.

TABLES: vbak,                          "Sales Document: Header Data
        vbap,
        vbkd,
        adrc,
        kna1,
        ce11000,
        rihea.

*- VARIABLES----------------------------------------------------------
DATA: BEGIN OF gt_vbap OCCURS 0,
        vbeln     LIKE vbak-vbeln,
        posnr     LIKE vbap-posnr,
        kunnr     LIKE vbak-kunnr,
        vkbur     LIKE vbak-vkbur,
        vkgrp     LIKE vbak-vkgrp,
        kdgrp     LIKE vbkd-kdgrp,
        matkl     LIKE vbap-matkl,
        objnr     LIKE vbap-objnr,
        vkorg     LIKE vbak-vkorg,
        bzirk     LIKE vbkd-bzirk,
        vtweg     LIKE vbak-vtweg,
        spart     LIKE vbak-spart,
        werks     LIKE vbap-werks,
        auart     LIKE vbak-auart,
        matnr     LIKE vbap-matnr,
        arktx     LIKE vbap-arktx,
        bran1     LIKE kna1-bran1,
        name1     LIKE kna1-name1,
        region    LIKE adrc-region,
        country   LIKE adrc-country,
        prsdt     LIKE vbkd-prsdt,
      END OF gt_vbap.

DATA: BEGIN OF gt_copa OCCURS 0,
        kaufn     TYPE kdauf,
        kdpos     TYPE kdpos,
        vrgar     TYPE rke_vrgar,
        budat     LIKE ce11000-budat,
*       fadat     like ce11000-fadat,
        vv110     TYPE rke2_vv110,
        vv120     TYPE rke2_vv120,
        kokrs     TYPE kokrs,
        prctr     TYPE prctr,
        equnr     TYPE equnr,
        ww003     TYPE rkeg_ww003,
        rec_waers TYPE rke_rec_waers,
        vv100     TYPE rke2_vv100,
        vv112     TYPE rke2_vv112,
*       vv113     type RKE2_VV113,
        vv114     TYPE rke2_vv114,
        vv130     TYPE rke2_vv130,
        vv140     TYPE rke2_vv140,
        vv150     TYPE rke2_vv150,
        vv200     TYPE rke2_vv200,
        vv300     TYPE rke2_vv300,
        vv400     TYPE rke2_vv400,
        vv500     TYPE rke2_vv500,
        vv600     TYPE rke2_vv600,
        ww002     TYPE rkeg_ww002,
        ww006     TYPE rkeg_ww006,
        ww007     TYPE rkeg_ww007,
        paobjnr   LIKE ce41000-paobjnr,
        pasubnr   LIKE ce41000-pasubnr,
* begin of insertion MOD-001
        bukrs     TYPE bukrs,
* end of insertion MOD-001
      END OF gt_copa.

DATA: BEGIN OF gt_final OCCURS 0,
        vbeln               LIKE vbak-vbeln,
        posnr               LIKE vbap-posnr,
        budat               LIKE ce11000-budat,
*       fadat               like ce11000-fadat,
        kunnr               LIKE vbak-kunnr,
        vkbur               LIKE vbak-vkbur,
        vkgrp               LIKE vbak-vkgrp,
        kdgrp               LIKE vbkd-kdgrp,
        matkl               LIKE vbap-matkl,
        objnr               LIKE vbap-objnr,
        vkorg               LIKE vbak-vkorg,
        bzirk               LIKE vbkd-bzirk,
        vtweg               LIKE vbak-vtweg,
        spart               LIKE vbak-spart,
        werks               LIKE vbap-werks,
        auart               LIKE vbak-auart,
        matnr               LIKE vbap-matnr,
        arktx               LIKE vbap-arktx,
        bran1               LIKE kna1-bran1,
        name1               LIKE kna1-name1,
        region              LIKE adrc-region,
        country             LIKE adrc-country,
        kaufn               TYPE kdauf,
        kdpos               TYPE kdpos,
        equnr               TYPE equnr,
        kokrs               TYPE kokrs,
        prctr               TYPE prctr,
        ww003               TYPE rkeg_ww003,
        rec_waers           TYPE waers,
        tot_vv100           TYPE rke2_vv100,
        tot_vv112           TYPE rke2_vv112,
        tot_vv110           TYPE rke2_vv110,
        tot_vv114           TYPE rke2_vv114,
        tot_vv130           TYPE rke2_vv130,
        tot_vv140           TYPE rke2_vv140,
        tot_vv150           TYPE rke2_vv150,
        tot_vv200           TYPE rke2_vv200,
        tot_vv300           TYPE rke2_vv300,
        tot_vv400           TYPE rke2_vv400,
        tot_vv500           TYPE rke2_vv500,
        tot_vv600           TYPE rke2_vv600,
        ww002               TYPE rkeg_ww002,
        ww006               TYPE rkeg_ww006,
        ww007               TYPE rkeg_ww007,
        net_inv_sls(15)     TYPE p DECIMALS 2,
        unadj_cogs(15)      TYPE p DECIMALS 2,
        unadj_gp(15)        TYPE p DECIMALS 2,
        %ugp(3)             TYPE p DECIMALS 2,
        sttxt               TYPE j_stext,
        prctr_text          TYPE ktext,
        vkorg_text          TYPE vtxtk,
        bzirk_text          TYPE bztxt,
        vkbur_text          TYPE bezei20,
        ww002_text          TYPE bezap,
        ww006_text          TYPE bezap,
        ww007_text          TYPE bezap,
        werks_text          TYPE name1,
        equnr_text          TYPE ktx01,
        region_text         TYPE bezei20,
        vkgrp_text          TYPE bezei20,
        kdgrp_text          TYPE vtxtk,
        bran1_text          TYPE vtext,
        prsdt               LIKE vbkd-prsdt,
        cont_type(32)       TYPE c,                         "CD1K968676
        unadj_cogs_seed(15) TYPE p DECIMALS 2,                  " Mod-004
        selected,
      END OF gt_final.

DATA: BEGIN OF gt_stai1 OCCURS 0,
        low(4) TYPE c,
      END OF gt_stai1.

DATA: BEGIN OF gt_stae1 OCCURS 0,
        low(4) TYPE c,
      END OF gt_stae1.

DATA: BEGIN OF h_status_tab OCCURS 20.
        INCLUDE STRUCTURE jstat.
DATA: END OF h_status_tab.

DATA: BEGIN OF h_status_text_tab OCCURS 20,
        txt04 LIKE tj02t-txt04.
DATA: END OF h_status_text_tab.
DATA: h_stat_flag.
DATA : gv_bukrs2 TYPE zvalue_field.

DATA: gv_adrnr             LIKE kna1-adrnr,
      gv_bukrs             TYPE bukrs,
      gv_waers             TYPE waers_cp,
      gv_land1             LIKE t001-land1,
      gv_ww002             LIKE ce11000-ww002,
      gv_repid             TYPE sy-repid,
      gv_index             TYPE sy-tabix,
      gv_ic1               LIKE sy-ucomm VALUE '&IC1',
      gt_fieldcat          TYPE slis_t_fieldcat_alv,
      gt_events_tab        TYPE slis_t_event,
      gv_newgl_active(1)   TYPE c,
      gv_form_user_command TYPE slis_formname VALUE 'USER_COMMAND_L'.

DATA: g_stai1_lines LIKE sy-tabix.
DATA: g_stae1_lines LIKE sy-tabix.

DATA : g_incl(1) TYPE c,
       g_excl(1) TYPE c.

*- Constants------------------------------------------------------------
CONSTANTS: gc_x(1)        TYPE c       VALUE 'X',
           c_c(1)         TYPE c       VALUE 'C',        "Sales Orders
           c_g(1)         TYPE c       VALUE 'G',        "Contracts
           c_l(1)         TYPE c       VALUE 'L',
           c_k(1)         TYPE c       VALUE 'K',
           c_h(1)         TYPE c       VALUE 'H',
           c_zo01         TYPE auart   VALUE 'ZO01',     "CC Service Sales
           c_zc01         TYPE auart   VALUE 'ZC01',     "Contract
           c_zor          TYPE auart   VALUE 'ZOR ',     "Standard order
           c_zor1         TYPE auart   VALUE 'ZOR1',
           c_zor2         TYPE auart   VALUE 'ZOR2',
           c_zor3         TYPE auart   VALUE 'ZOR3',
           c_z1cr         TYPE auart   VALUE 'Z1CR',
           c_z1dr         TYPE auart   VALUE 'Z1DR',
           c_zre1         TYPE auart   VALUE 'ZRE1',
           c_zkr          TYPE auart   VALUE 'ZKR',
           c_zrk          TYPE auart   VALUE 'ZRK',
           c_99999(3)     TYPE p DECIMALS 2 VALUE '999.99'.

*- SELECTION SCREEN---------------------------------------------------
SELECTION-SCREEN: BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
PARAMETERS:     p_vkorg  TYPE vbak-vkorg OBLIGATORY MEMORY ID vko.
SELECT-OPTIONS: s_vbeln  FOR  vbak-vbeln MATCHCODE OBJECT vmva,
                s_posnr  FOR  vbap-posnr,
                s_perio  FOR  ce11000-perio,
                s_budat  FOR  ce11000-budat,
                s_bzirk  FOR  vbkd-bzirk,
                s_vkbur  FOR  vbak-vkbur,
                s_vkgrp  FOR  vbak-vkgrp,
                s_kunnr  FOR  vbak-kunnr,
                s_region FOR  adrc-region,
                s_kdgrp  FOR  vbkd-kdgrp,
                s_bran1  FOR  kna1-bran1,
                s_prctr  FOR  ce11000-prctr,
                s_plc    FOR  ce11000-ww002 OBLIGATORY,
                s_gac    FOR  ce11000-ww006,
                s_pgc    FOR  ce11000-ww007,
                s_equnr  FOR  ce11000-equnr,
                s_matkl  FOR  vbap-matkl,
                s_matnr  FOR  vbap-matnr.
SELECT-OPTIONS:
  s_stai1 FOR rihea-i_estatin MATCHCODE OBJECT i_status NO INTERVALS,
  s_stae1 FOR rihea-i_estatex MATCHCODE OBJECT i_status NO INTERVALS.
PARAMETERS: p_server   TYPE char50
  DEFAULT '/var/load/xxx/UK/read/VISIONAIR_CTSCHINA/'.
SELECTION-SCREEN: END OF BLOCK b1.
AT SELECTION-SCREEN.
AT SELECTION-SCREEN OUTPUT.
*  Begin of CR3987
*  DATA: lv_yester  TYPE sy-datum,
*      lv_lastdy  TYPE sy-datum,
*      lv_frstday TYPE sy-datum.
*  IF s_budat[] IS INITIAL.
*
*    lv_yester = sy-datum - 1.
*    CALL FUNCTION 'LAST_DAY_OF_MONTHS'
*      EXPORTING
*        day_in            = lv_yester
*      IMPORTING
*        last_day_of_month = lv_lastdy
*      EXCEPTIONS
*        day_in_no_date    = 1
*        OTHERS            = 2.
*    IF sy-subrc <> 0.
*      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*    ENDIF.
*
*    lv_frstday = lv_lastdy.
*    lv_frstday+6(2) = '01'.
*    s_budat-sign = 'I'.
*    s_budat-option = 'BT'.
*    s_budat-low = lv_frstday.
*    s_budat-high = lv_lastdy.
*    APPEND s_budat.
*  ENDIF.
*  End of CR3987

*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_vkorg.

  AUTHORITY-CHECK OBJECT 'V_VBRK_VKO'
           ID 'VKORG' FIELD p_vkorg
           ID 'ACTVT' FIELD '03'.

  IF sy-subrc NE 0.
*.. No authorization for sales organisation: &1
    MESSAGE e001(00) WITH text-e03 p_vkorg.
  ENDIF.

* begin of insertion MOD-002
*...................Transaction counter...............................*
  CALL METHOD ycl_statistics=>record_transaction .
* end of insertion MOD-002
AT SELECTION-SCREEN ON s_perio.

  IF s_vbeln-low  IS INITIAL AND
     s_vbeln-high IS INITIAL.
    IF NOT s_perio-high IS INITIAL.
*.... Fill in only 1 period !
      MESSAGE e001(00) WITH text-e04.
    ENDIF.
  ENDIF.

*-INITIALIZATION--------------------------------------------------------
INITIALIZATION.
* to become SDI statusses at F4
  EXPORT p_obtyp = 'VBP' TO MEMORY ID 'PM_OBTYP'.



*-START OF SELECTION----------------------------------------------------
START-OF-SELECTION.
* Fill status tables
  REFRESH: gt_stai1,
           gt_stae1.

*  Begin of CR3987
  DATA: lv_yester  TYPE sy-datum,
      lv_lastdy  TYPE sy-datum,
      lv_frstday TYPE sy-datum.
*  refresh: s_budat.
  IF s_budat[] IS INITIAL.

    lv_yester = sy-datum - 1.
    CALL FUNCTION 'LAST_DAY_OF_MONTHS'
      EXPORTING
        day_in            = lv_yester
      IMPORTING
        last_day_of_month = lv_lastdy
      EXCEPTIONS
        day_in_no_date    = 1
        OTHERS            = 2.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

    lv_frstday = lv_lastdy.
    lv_frstday+6(2) = '01'.
    s_budat-sign = 'I'.
    s_budat-option = 'BT'.
    s_budat-low = lv_frstday.
    s_budat-high = lv_lastdy.
    APPEND s_budat.
  ENDIF.
*  End of CR3987

  LOOP AT s_stai1.
    CLEAR gt_stai1.
    MOVE s_stai1-low TO gt_stai1-low.
    APPEND gt_stai1.
  ENDLOOP.

  LOOP AT s_stae1.
    CLEAR gt_stae1.
    MOVE s_stae1-low TO gt_stae1-low.
    APPEND gt_stae1.
  ENDLOOP.

* Number of records in the status-tables
  DESCRIBE TABLE gt_stai1 LINES g_stai1_lines.
  DESCRIBE TABLE gt_stae1 LINES g_stae1_lines.

* Select order items
  SELECT a~vbeln a~kunnr a~vkgrp b~posnr
         a~auart a~vkorg a~vtweg a~spart a~vkbur
         b~matnr b~arktx b~werks b~objnr b~matkl
        INTO CORRESPONDING FIELDS OF TABLE gt_vbap
        FROM vbak AS a
        INNER JOIN vbap AS b
         ON a~vbeln EQ b~vbeln
*        inner join vbkd as c
*         on  a~vbeln eq c~vbeln
*         and b~posnr eq c~posnr
        WHERE a~vbeln IN s_vbeln
          AND b~posnr IN s_posnr
          AND a~vkorg EQ p_vkorg
          AND a~kunnr IN s_kunnr
          AND a~vbtyp IN (c_c, c_g, c_l, c_h, c_k)
*          and a~auart in (c_zo01, c_zc01, c_zor, c_zor1, c_zor2, c_zor3,
*                          c_z1cr, c_z1dr, c_zre1, c_zkr, c_zrk)
          AND a~vkgrp IN s_vkgrp
*          AND c~bzirk in s_bzirk
          AND a~vkbur IN s_vkbur
*          AND c~kdgrp in s_kdgrp
          AND b~matnr IN s_matnr
          AND b~matkl IN s_matkl.

  IF gt_vbap[] IS INITIAL.
    WRITE: / text-i01.              "No orders selected
    EXIT.
  ENDIF.

  LOOP AT gt_vbap.
* check on vbkd (first with item , if not found without item)
    SELECT SINGLE kdgrp bzirk prsdt
       INTO (gt_vbap-kdgrp, gt_vbap-bzirk, gt_vbap-prsdt)
       FROM vbkd
      WHERE vbeln = gt_vbap-vbeln
        AND posnr = gt_vbap-posnr.
    IF NOT sy-subrc = 0.
      SELECT SINGLE kdgrp bzirk prsdt
        INTO  (gt_vbap-kdgrp, gt_vbap-bzirk, gt_vbap-prsdt)
        FROM vbkd
       WHERE vbeln = gt_vbap-vbeln.
    ENDIF.
    IF NOT gt_vbap-bzirk IN s_bzirk.
      DELETE gt_vbap.
      CONTINUE.
    ENDIF.
    IF NOT gt_vbap-kdgrp IN s_kdgrp.
      DELETE gt_vbap.
      CONTINUE.
    ENDIF.

*.. check status inclusive / exlusive
    IF NOT ( g_stai1_lines IS INITIAL
        AND g_stae1_lines IS INITIAL ) .
      PERFORM check_statusses USING gt_vbap-objnr.
      IF NOT g_stai1_lines IS INITIAL AND g_incl = ' '.
        DELETE gt_vbap.
        CONTINUE.
      ELSEIF NOT g_stae1_lines IS INITIAL AND g_excl = 'X'.
        DELETE gt_vbap.
        CONTINUE.
      ENDIF.
    ENDIF.

*.. check region and customer industrial code
    SELECT SINGLE adrnr bran1 name1
       INTO (gv_adrnr, gt_vbap-bran1, gt_vbap-name1)
       FROM kna1 WHERE kunnr EQ gt_vbap-kunnr
                   AND bran1 IN s_bran1.

    IF sy-subrc = 0.
*      modify gt_vbap transporting bran1 name1.
    ELSE.
      DELETE gt_vbap.
      CONTINUE.
    ENDIF.

    SELECT SINGLE region country
       INTO (gt_vbap-region, gt_vbap-country)
       FROM adrc WHERE addrnumber EQ gv_adrnr
                   AND date_from  EQ '00010101'
                   AND region     IN s_region.

    IF sy-subrc = 0.
*      modify gt_vbap transporting region country.
    ELSE.
      DELETE gt_vbap.
      CONTINUE.
    ENDIF.

    MODIFY gt_vbap.

  ENDLOOP.

* Select CO-PA info
  SORT gt_vbap BY vbeln posnr.
  REFRESH: gt_copa.

  LOOP AT gt_vbap.
    SELECT kaufn kdpos vv100 vv112 vv113 vv114 vv130 vv120 vv110
           vv200 vv300 vv400 vv500 vv600 ww002 ww006 ww007 equnr
           kokrs prctr ww003 rec_waers vrgar budat
           paobjnr pasubnr vv140 vv150
* begin of insertion MOD-001
           bukrs
* end of insertion MOD-001
         FROM ce11000
         APPENDING CORRESPONDING FIELDS OF TABLE gt_copa
         WHERE paledger EQ '02'
           AND vrgar    IN ('C', 'B', 'F')
           AND perio    IN s_perio
           AND budat    IN s_budat                          "CR3987 ADD
           AND kaufn    EQ gt_vbap-vbeln
           AND kdpos    EQ gt_vbap-posnr
           AND equnr    IN s_equnr
           AND prctr    IN s_prctr
           AND ww002    IN s_plc
           AND ww006    IN s_gac
           AND ww007    IN s_pgc.
  ENDLOOP.

  IF NOT gt_copa[] IS INITIAL.
    LOOP AT gt_copa.
* begin of insertion MOD-001
      CALL FUNCTION 'YSE_CONVERT_PRCTR_BL'
        EXPORTING
          prctr_in    = gt_copa-prctr
          bukrs       = gt_copa-bukrs
        IMPORTING
          segment_out = gt_copa-prctr.
* end of insertion MOD-001
      SELECT SINGLE ww002 INTO gv_ww002
          FROM ce41000
          WHERE aktbo = gc_x
            AND paobjnr = gt_copa-paobjnr
            AND pasubnr = gt_copa-pasubnr.
      IF sy-subrc = 0.
        gt_copa-ww002 = gv_ww002.
        MODIFY gt_copa.
      ENDIF.
    ENDLOOP.
  ENDIF.

*-----------------------------------------------------------------------
END-OF-SELECTION.

* Cumulate detailrecords
  SORT gt_copa BY kaufn kdpos.
  REFRESH: gt_final.

  LOOP AT gt_copa.
    MOVE-CORRESPONDING gt_copa TO gt_final.

    READ TABLE gt_vbap WITH KEY vbeln = gt_copa-kaufn
                                posnr = gt_copa-kdpos
                 BINARY SEARCH.
    MOVE-CORRESPONDING gt_vbap TO gt_final.

    "CD1K968676 begin
    CLEAR gt_final-cont_type.
    CASE gt_vbap-matkl+4(2).
      WHEN 'TR'.
        gt_final-cont_type = '* Total_Responsibity'.
      WHEN 'PM'.
        gt_final-cont_type = '* Preventive_Maintenance'.
      WHEN 'IP'.
        gt_final-cont_type = '* Inspection'.
      WHEN 'CC'.
        gt_final-cont_type = '* Cover_Care'.
      WHEN 'PP'.
        gt_final-cont_type = '* Parts_Only'.
      WHEN 'XT'.
        gt_final-cont_type = '* AirExtend'.
      WHEN '044Z'.
        gt_final-cont_type = '** Other_Contract_Type'.
      WHEN OTHERS.
        gt_final-cont_type = ''.
    ENDCASE.
    "CD1K968676 end

    gt_final-tot_vv200 = gt_copa-vv200.
    gt_final-tot_vv300 = gt_copa-vv300.
    gt_final-tot_vv400 = gt_copa-vv400.
    gt_final-tot_vv500 = gt_copa-vv500.
    gt_final-tot_vv600 = gt_copa-vv600.
    gt_final-tot_vv100 = gt_copa-vv100.
    gt_final-tot_vv112 = gt_copa-vv112.
    gt_final-tot_vv110 = gt_copa-vv110.
    gt_final-tot_vv114 = gt_copa-vv114.
    gt_final-tot_vv130 = gt_copa-vv130.
    gt_final-tot_vv140 = gt_copa-vv140.
    gt_final-tot_vv150 = gt_copa-vv150.

    COLLECT gt_final.
    CLEAR gt_final.
  ENDLOOP.

* Calculate remaining fields and get missing info
  LOOP AT gt_final.
*.. Net invoiced sales
    gt_final-net_inv_sls = gt_final-tot_vv100 + gt_final-tot_vv110.

*.. Unadjusted COGS Actual
    gt_final-unadj_cogs = gt_final-tot_vv200 + gt_final-tot_vv300 +
           gt_final-tot_vv400 + gt_final-tot_vv500 + gt_final-tot_vv600 +
           gt_final-tot_vv112 + gt_final-tot_vv114 + gt_final-tot_vv130 +
           gt_final-tot_vv140 + gt_final-tot_vv150.

*BEGIN OF change MOD-004
    CLEAR gt_final-unadj_cogs_seed.
    gt_final-unadj_cogs_seed = gt_final-unadj_cogs - gt_final-tot_vv112.
*END OF change MOD-004

*.. Unadjusted Gross Profit Actual
    gt_final-unadj_gp = gt_final-net_inv_sls - gt_final-unadj_cogs.

*.. Unadjusted Gross Profit Actual
    CATCH SYSTEM-EXCEPTIONS arithmetic_errors = 1.
      IF NOT gt_final-net_inv_sls IS INITIAL.
        gt_final-%ugp = 100 * gt_final-unadj_gp / gt_final-net_inv_sls.
      ENDIF.
    ENDCATCH.
    IF sy-subrc = 1.
      gt_final-%ugp = c_99999.
    ENDIF.

*.. Get SDI status
    CALL FUNCTION 'STATUS_TEXT_EDIT'
      EXPORTING
        flg_user_stat    = 'X'
        objnr            = gt_final-objnr
        only_active      = 'X'
        spras            = sy-langu
      IMPORTING
        line             = gt_final-sttxt
      EXCEPTIONS
        object_not_found = 1
        OTHERS           = 2.

*.. Get descriptions
*.. Profit Center
    SELECT SINGLE ktext INTO gt_final-prctr_text
       FROM cepct WHERE spras = sy-langu
                    AND prctr = gt_final-prctr
                    AND datbi = '99991231'
                    AND kokrs = gt_final-kokrs.

*.. Sales organization
    SELECT SINGLE vtext INTO gt_final-vkorg_text
       FROM tvkot WHERE spras = sy-langu
                    AND vkorg = gt_final-vkorg.

*.. Sales district
    SELECT SINGLE bztxt INTO gt_final-bzirk_text
       FROM t171t WHERE spras = sy-langu
                    AND bzirk = gt_final-bzirk.

*.. Sales office
    SELECT SINGLE bezei INTO gt_final-vkbur_text
       FROM tvkbt WHERE spras = sy-langu
                    AND vkbur = gt_final-vkbur.

*.. PLC
    SELECT SINGLE bezek INTO gt_final-ww002_text
       FROM t25a1 WHERE spras = sy-langu
                    AND ww002 = gt_final-ww002.

*.. GAC
    SELECT SINGLE bezek INTO gt_final-ww006_text
       FROM t25a3 WHERE spras = sy-langu
                    AND ww006 = gt_final-ww006.

*.. PGC
    IF NOT gt_final-ww007 IS INITIAL.
      SELECT SINGLE bezek INTO gt_final-ww007_text
         FROM t25a4 WHERE spras = sy-langu
                      AND ww007 = gt_final-ww007.
    ENDIF.

*.. Plant
    SELECT SINGLE name1 INTO gt_final-werks_text
       FROM t001w WHERE werks = gt_final-werks.

*.. Equipment
    IF NOT gt_final-equnr IS INITIAL.
      SELECT SINGLE eqktx INTO gt_final-equnr_text
         FROM eqkt  WHERE equnr = gt_final-equnr
                      AND spras = sy-langu.
    ENDIF.

*.. Region
    IF NOT gt_final-region IS INITIAL.
      SELECT SINGLE bezei INTO gt_final-region_text
         FROM t005u WHERE spras = sy-langu
                      AND land1 = gt_final-country
                      AND bland = gt_final-region.
    ENDIF.

*.. Sales group
    SELECT SINGLE bezei INTO gt_final-vkgrp_text
       FROM tvgrt WHERE spras = sy-langu
                    AND vkgrp = gt_final-vkgrp.

*.. Customer group
    SELECT SINGLE ktext INTO gt_final-kdgrp_text
       FROM t151t WHERE spras = sy-langu
                    AND kdgrp = gt_final-kdgrp.

*.. Customer industrial code
    SELECT SINGLE vtext INTO gt_final-bran1_text
       FROM tbrct WHERE spras = sy-langu
                    AND braco = gt_final-bran1.

*.. Add new fields to internal table
    MODIFY gt_final TRANSPORTING net_inv_sls
                                 unadj_cogs
                                 unadj_gp
                                 %ugp
                                 sttxt
                                 prctr_text
                                 vkorg_text
                                 bzirk_text
                                 vkbur_text
                                 ww002_text
                                 ww006_text
                                 ww007_text
                                 werks_text
                                 equnr_text
                                 region_text
                                 vkgrp_text
                                 kdgrp_text
                                 bran1_text
                                 unadj_cogs_seed.       " MOD-004
  ENDLOOP.

* create ALV-GRID
  PERFORM build_field_catlog CHANGING gt_fieldcat.
  PERFORM fill_events_f14.
  PERFORM alv_display.


*- SUBROUTINES---------------------------------------------------------
*&---------------------------------------------------------------------*
*&      Form  build_field_catlog
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FIELDCAT  text
*----------------------------------------------------------------------*
FORM build_field_catlog  CHANGING pt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA : ls_fcat TYPE slis_fieldcat_alv.

*-----------------------Profit Center---------------------*
  ls_fcat-fieldname = 'PRCTR'.
*  ls_fcat-rollname = 'PRCTR'.
  ls_fcat-outputlen = '15'.
  SELECT SINGLE bukrs INTO gv_bukrs2 FROM tvko
    WHERE vkorg = p_vkorg.
  CALL FUNCTION 'YSE_CHECK_DEV_MATRIX'
    EXPORTING
      object      = 'YSE_NEWGL_ACTIVE'
      checkfield  = 'BUKRS'
      value_field = gv_bukrs2
      counter     = 1
    EXCEPTIONS
      active      = 1
      passive     = 2
      not_found   = 3
      OTHERS      = 4.
  IF sy-subrc = 1.
    gv_newgl_active = 'Y'.
  ELSE.
    gv_newgl_active = 'N'.
  ENDIF.
  IF gv_newgl_active = 'Y'.
    ls_fcat-seltext_l = 'Segment'(i50).
  ELSE.
    ls_fcat-seltext_l = 'Profit Center'(i49).
  ENDIF.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero    = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Profit Center text----------------*
  ls_fcat-fieldname = 'PRCTR_TEXT'.
  ls_fcat-outputlen = '15'.
  IF gv_newgl_active = 'Y'.
    ls_fcat-seltext_l = 'Segment (Text)'(i52).
  ELSE.
    ls_fcat-seltext_l = 'Profit Center (Text)'(i11).
  ENDIF.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales organization----------------*
  ls_fcat-fieldname = 'VKORG'.
  ls_fcat-rollname = 'VKORG'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales organization text-----------*
  ls_fcat-fieldname = 'VKORG_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales Org.(Text)'(i12).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Region----------------------------*
  ls_fcat-fieldname = 'REGION'.
  ls_fcat-rollname = 'REGIO'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Region Text----------------------*
  ls_fcat-fieldname = 'REGION_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Region (Text)'(i13).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales district--------------------*
  ls_fcat-fieldname = 'BZIRK'.
  ls_fcat-rollname = 'BZIRK'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales district text--------------*
  ls_fcat-fieldname = 'BZIRK_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales district(Text)'(i14).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales office----------------------*
  ls_fcat-fieldname = 'VKBUR'.
  ls_fcat-rollname = 'VKBUR'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales office text--------------*
  ls_fcat-fieldname = 'VKBUR_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales office(Text)'(i15).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales group---------------------*
  ls_fcat-fieldname = 'VKGRP'.
  ls_fcat-rollname = 'VKGRP'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales group text--------------*
  ls_fcat-fieldname = 'VKGRP_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales group(Text)'(i55).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Acc.indicator-------------------*
  ls_fcat-fieldname = 'WW003'.
  ls_fcat-rollname = 'RKEG_WW003'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Customer industrial code--------*
  ls_fcat-fieldname = 'BRAN1'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer Industrial Code'(i16).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Customer ind.code text------*
  ls_fcat-fieldname = 'BRAN1_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer Ind.Code(Text)'(i17).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Customer group------------------*
  ls_fcat-fieldname = 'KDGRP'.
  ls_fcat-rollname = 'KDGRP'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Customer group text-----------*
  ls_fcat-fieldname = 'KDGRP_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer group(Text)'(i18).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Customer------------------------*
  ls_fcat-fieldname = 'KUNNR'.
  ls_fcat-rollname = 'KUNNR'.
  ls_fcat-no_convext = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Customer name-----------------*
  ls_fcat-fieldname = 'NAME1'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer Name'(i19).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Distr.Channel--------------------*
  ls_fcat-fieldname = 'VTWEG'.
  ls_fcat-rollname = 'VTWEG'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Division-------------------------*
  ls_fcat-fieldname = 'SPART'.
  ls_fcat-rollname = 'SPART'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------PLC-------------------------------*
  ls_fcat-fieldname = 'WW002'.
  ls_fcat-rollname = 'RKEG_WW002'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------PLC text----------------------*
  ls_fcat-fieldname = 'WW002_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'PLC(Text)'(i20).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------GAC-------------------------------*
  ls_fcat-fieldname = 'WW006'.
  ls_fcat-rollname = 'RKEG_WW006'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------GAC text----------------------*
  ls_fcat-fieldname = 'WW006_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'GAC(Text)'(i21).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------PGC-------------------------------*
  ls_fcat-fieldname = 'WW007'.
  ls_fcat-rollname = 'RKEG_WW007'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------PGC text----------------------*
  ls_fcat-fieldname = 'WW007_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'PGC(Text)'(i22).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Material group--------------------*
  ls_fcat-fieldname = 'MATKL'.
  ls_fcat-rollname = 'MATKL'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Plant-----------------------------*
  ls_fcat-fieldname = 'WERKS'.
  ls_fcat-rollname = 'WERKS_D'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Plant text--------------------*
  ls_fcat-fieldname = 'WERKS_TEXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Plant(Text)'(i23).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Equipment-------------------------*
  ls_fcat-fieldname = 'EQUNR'.
  ls_fcat-rollname = 'EQUNR'.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Equipment description---------*
  ls_fcat-fieldname = 'EQUNR_TEXT'.
  ls_fcat-outputlen = '40'.
  ls_fcat-seltext_l = 'Equipment description'(i24).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales document--------------------*
  ls_fcat-fieldname = 'VBELN'.
  ls_fcat-rollname = 'VBELN_VA'.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero    = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales document type---------------*
  ls_fcat-fieldname = 'AUART'.
  ls_fcat-rollname = 'AUART'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales Document Item----------------*
  ls_fcat-fieldname = 'POSNR'.
  ls_fcat-rollname = 'POSNR_VA'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
**-----------------------Billing Date-----------------------*
*  ls_fcat-fieldname = 'FADAT'.
*  ls_fcat-rollname = 'FADAT'.
*  APPEND ls_fcat TO pt_fieldcat.
*  CLEAR ls_fcat.
*-----------------------Posting Date-----------------------*
  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-rollname = 'DAERF'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------SDI status-------------------------*
  ls_fcat-fieldname = 'STTXT'.
  ls_fcat-rollname = 'J_STEXT'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Product---------------------------*
  ls_fcat-fieldname = 'MATNR'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Product'(i29).
  ls_fcat-no_zero   = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Product description---------------*
  ls_fcat-fieldname = 'ARKTX'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Product description'(i30).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Revenues Actual---------------------*
  ls_fcat-fieldname = 'TOT_VV100'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Revenues Actual'(i31).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Discount ----------------------*
  ls_fcat-fieldname = 'TOT_VV110'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Discount'(i32).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Net invoiced sales Actual----------*
  ls_fcat-fieldname = 'NET_INV_SLS'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Net invoiced sales Actual'(i33).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Unadjusted COS Actual----------*
  ls_fcat-fieldname = 'TOT_VV130'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Unadjusted COS Actual'(i34).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Parts Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV200'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Parts Actual'(i35).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Labour Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV300'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Labour Actual'(i36).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Mileage Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV400'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Mileage Actual'(i37).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Ad Hoc Expenses Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV600'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Ad Hoc Expenses Actual'(i38).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Subcontracting Actual-------------------*
  ls_fcat-fieldname = 'TOT_VV500'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Subcontracting Actual'(i39).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------COGS-Contract provis Actual-------------*
  ls_fcat-fieldname = 'TOT_VV112'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'COGS-Contract provis Actual'(i40).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Fix price accruals Actual---------------*
  ls_fcat-fieldname = 'TOT_VV114'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Fix price accruals Actual'(i41).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Unadjusted COGS Actual------------------*
  ls_fcat-fieldname = 'UNADJ_COGS'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Unadjusted COGS Actual'(i42).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Unadjusted Gross Profit Actual----------*
  ls_fcat-fieldname = 'UNADJ_GP'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Unadjusted Gross Profit Actual'(i43).
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------% UGP Actual----------------------------*
  ls_fcat-fieldname = '%UGP'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = '% UGP Actual'(i44).
  ls_fcat-no_sum    = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Currency------------------------*
  ls_fcat-fieldname = 'REC_WAERS'.
  ls_fcat-rollname = 'WAERS'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

  "CD1K968676 begin
  ls_fcat-fieldname = 'CONT_TYPE'.
  ls_fcat-outputlen = '32'.
  ls_fcat-seltext_l = 'Contract Type'(i56).
  ls_fcat-no_sum    = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

  "CD1K968676 end

*  BEGIN OF CHANGE MOD-004
*-----------------------Unadjusted COGS Actual-SEED------------------*
  ls_fcat-fieldname = 'UNADJ_COGS_SEED'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Unadjusted COGS Actual-SEED'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*  END OF CHANGE MOD-004

ENDFORM.                    " build_field_catlog

*&---------------------------------------------------------------------*
*&      Form  fill_events_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_events_f14 .

  DATA lv_event       TYPE slis_alv_event.

  CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
    EXPORTING
      i_list_type = 0
    IMPORTING
      et_events   = gt_events_tab.

*--- allocate form for user-command ---------------------------------*
  READ TABLE gt_events_tab WITH KEY name = slis_ev_user_command
                        INTO lv_event.
  IF sy-subrc = 0.
    MOVE gv_form_user_command TO lv_event-form.
    MODIFY gt_events_tab FROM lv_event INDEX sy-tabix.
  ENDIF.

ENDFORM.                    " fill_events_f14

*&--------------------------------------------------------------------*
*&      Form  user_command_l
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*---------------------------------------------------------------------*
FORM user_command_l USING p_ucomm LIKE sy-ucomm
                          p_selfield TYPE slis_selfield.

  p_selfield-refresh = 'S'.
  PERFORM check_pf2_with_object_f16 USING p_ucomm.
  PERFORM set_p_selfield_general_f16 USING p_selfield.

  CASE p_ucomm.
    WHEN 'ISEL'.
      p_ucomm = 'DISP'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
  ENDCASE.

ENDFORM.                    "user_command_l

*&---------------------------------------------------------------------*
*&      Form  check_pf2_with_object_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*----------------------------------------------------------------------*
FORM check_pf2_with_object_f16  USING    p_ucomm.

  CHECK p_ucomm = gv_ic1.
  p_ucomm = 'ISEL'.

ENDFORM.                    " check_pf2_with_object_f16

*&---------------------------------------------------------------------*
*&      Form  set_p_selfield_general_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
FORM set_p_selfield_general_f16  USING f_selfield TYPE slis_selfield.

  f_selfield-col_stable = gc_x.
  f_selfield-row_stable = gc_x.

ENDFORM.                    " set_p_selfield_general_f16

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*      -->P_ENDCASE  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_f16  USING p_ucomm LIKE sy-ucomm
                                p_selfield TYPE slis_selfield.

  PERFORM check_object_tab_marked_f14 USING p_ucomm p_selfield.

  LOOP AT gt_final WHERE selected = gc_x .
    gv_index = sy-tabix.
    PERFORM fcodes_with_mark_l USING p_ucomm p_selfield.
    gt_final-selected = ' '.
    MODIFY gt_final INDEX gv_index.
  ENDLOOP.

  CLEAR p_ucomm.

ENDFORM.                    " fcodes_with_mark_f16

*&---------------------------------------------------------------------*
*&      Form  check_object_tab_marked_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
FORM check_object_tab_marked_f14  USING    p_ucomm LIKE sy-ucomm
                                        p_selfield TYPE slis_selfield.

  READ TABLE gt_final WITH KEY selected = gc_x.

  IF NOT sy-subrc IS INITIAL.
    IF NOT p_selfield-tabindex IS INITIAL.
      READ TABLE gt_final INDEX p_selfield-tabindex.
      gt_final-selected = gc_x.
      MODIFY gt_final INDEX p_selfield-tabindex.
    ENDIF.
  ELSE.
*--- Checkbox markiert -----------------------------------------------*
    p_selfield-sel_tab_field = 'G_MARK'.
  ENDIF.

ENDFORM.                    " check_object_tab_marked_f14

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_F_UCOMM  text
*      -->P_F_SELFIELD  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_l  USING   p_ucomm LIKE sy-ucomm
                              p_selfield TYPE slis_selfield.

  DATA: h_ucomm LIKE sy-ucomm.

  CASE p_ucomm.
*   Display Contract
    WHEN 'DISP'.
      SET PARAMETER ID 'KTN' FIELD gt_final-vbeln.
      CALL TRANSACTION 'VA43' AND SKIP FIRST SCREEN.
  ENDCASE.

ENDFORM.                    " fcodes_with_mark_l

*&---------------------------------------------------------------------*
*&      Form  alv_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_display .

  gv_repid = sy-repid.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
     EXPORTING
       i_callback_program                =  gv_repid
       i_save                            = 'A'
       it_events                         =  gt_events_tab[]
*      I_GRID_TITLE                      =
*      I_GRID_SETTINGS                   =
*      is_layout                         =  g_layout
       it_fieldcat                       =  gt_fieldcat[]
     TABLES
        t_outtab                         =  gt_final.


********BEGIN OF CR3987 INSERT*****************************
  DATA: lv_file     TYPE /sapdmc/ls_filename,
          ls_out_file TYPE yse_outfile_ke24,
          lv_filename TYPE char128,
          lv_directory(50) TYPE c,
          lv_line     TYPE string,
          lv_lines    TYPE char10,
          lv_logsys   TYPE tbdlst-logsys.

  DATA: lt_outfile_nis  TYPE STANDARD TABLE OF yse_outfile_nis,
        ls_outfile_nis  TYPE yse_outfile_nis,
        ls_final        LIKE LINE OF gt_final.

  IF sy-batch IS NOT INITIAL.
    LOOP AT gt_final INTO ls_final.
      ls_outfile_nis-vkbur        = ls_final-vkbur.
      ls_outfile_nis-vkgrp        = ls_final-vkgrp.
      ls_outfile_nis-bzirk        = ls_final-bzirk.
      ls_outfile_nis-vbeln        = ls_final-vbeln.
      ls_outfile_nis-posnr        = ls_final-posnr.
      ls_outfile_nis-matnr        = ls_final-matnr.
      ls_outfile_nis-ww006        = ls_final-ww006.
      ls_outfile_nis-kdgrp        = ls_final-kdgrp.
      ls_outfile_nis-kunnr        = ls_final-kunnr.
      ls_outfile_nis-name1        = ls_final-name1.
      ls_outfile_nis-auart        = ls_final-auart.
      ls_outfile_nis-net_inv_sls  = ls_final-net_inv_sls.
      ls_outfile_nis-rec_waers    = ls_final-rec_waers.
      ls_outfile_nis-budat        = ls_final-budat.
      ls_outfile_nis-ww003        = ls_final-ww003.
      ls_outfile_nis-vtweg        = ls_final-vtweg.
      ls_outfile_nis-tot_vv200    = ls_final-tot_vv200.
      ls_outfile_nis-tot_vv300    = ls_final-tot_vv300.
      ls_outfile_nis-tot_vv600    = ls_final-tot_vv600.
      ls_outfile_nis-tot_vv500    = ls_final-tot_vv500.
      ls_outfile_nis-tot_vv400    = ls_final-tot_vv400.
      ls_outfile_nis-tot_vv114    = ls_final-tot_vv114.
      ls_outfile_nis-unadj_cogs   = ls_final-unadj_cogs.
      ls_outfile_nis-vkorg        = ls_final-vkorg.
      ls_outfile_nis-bzirk_text   = ls_final-bzirk_text.
      APPEND ls_outfile_nis TO lt_outfile_nis.
    ENDLOOP.

    lv_directory = p_server.
    CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
      IMPORTING
        own_logical_system             = lv_logsys
      EXCEPTIONS
        own_logical_system_not_defined = 1
        OTHERS                         = 2.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
           WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
    REPLACE 'xxx' IN lv_directory WITH lv_logsys(3).
    CONCATENATE lv_directory 'NIS_' p_vkorg '.CSV' INTO  lv_file.
    OPEN DATASET lv_file FOR OUTPUT
      IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      MESSAGE s001(00) DISPLAY LIKE 'E'
      WITH 'Open dataset failed for :'(m03) lv_file.
      LEAVE LIST-PROCESSING.
    ENDIF.
    CLEAR: ls_outfile_nis.
    LOOP AT  lt_outfile_nis INTO ls_outfile_nis.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-tot_vv200.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-tot_vv300.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-tot_vv600.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-tot_vv500.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-tot_vv400.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-tot_vv114.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-unadj_cogs.
      CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
        CHANGING
          value = ls_outfile_nis-net_inv_sls.

      CONCATENATE   ls_outfile_nis-vkbur
                    ls_outfile_nis-vkgrp
*                    ls_outfile_nis-bzirk
                    ls_outfile_nis-bzirk_text
                    ls_outfile_nis-vbeln
                    ls_outfile_nis-posnr
                    ls_outfile_nis-matnr
                    ls_outfile_nis-ww006
                    ls_outfile_nis-kdgrp
                    ls_outfile_nis-kunnr
                    ls_outfile_nis-name1
                    ls_outfile_nis-auart
                    ls_outfile_nis-net_inv_sls
                    ls_outfile_nis-rec_waers
                    ls_outfile_nis-budat
                    ls_outfile_nis-ww003
                    ls_outfile_nis-vtweg
                    ls_outfile_nis-tot_vv200
                    ls_outfile_nis-tot_vv300
                    ls_outfile_nis-tot_vv600
                    ls_outfile_nis-tot_vv500
                    ls_outfile_nis-tot_vv400
                    ls_outfile_nis-tot_vv114
                    ls_outfile_nis-unadj_cogs
                    ls_outfile_nis-vkorg
*                    ls_outfile_nis-bzirk_text
            INTO   lv_line
            SEPARATED BY cl_abap_char_utilities=>horizontal_tab.
      TRANSFER lv_line TO lv_file.
    ENDLOOP.
    CLOSE DATASET lv_file.
    IF sy-subrc <> 0.
      MESSAGE e001(00) WITH 'Close dataset failed for :'(m05)  lv_file.
    ELSE.
      DESCRIBE TABLE lt_outfile_nis LINES lv_lines.
      MESSAGE i001(00)
        WITH 'Totatly '  lv_lines 'records are transferred!'.
    ENDIF.
  ENDIF.
********END   OF CR3987 INSERT*****************************


ENDFORM.                    " alv_display

*&---------------------------------------------------------------------*
*&      Form  check_statusses
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM check_statusses USING r_objnr.

  CLEAR: g_excl,
         g_incl.

  REFRESH: h_status_tab,
           h_status_text_tab.

* get active statusses
  CALL FUNCTION 'STATUS_READ'
    EXPORTING
      objnr       = r_objnr
      only_active = 'X'
    TABLES
      status      = h_status_tab
    EXCEPTIONS
      OTHERS      = 01.

  CHECK sy-subrc = 0.

* get status descriptions
  LOOP AT h_status_tab.
    CALL FUNCTION 'STATUS_NUMBER_CONVERSION'
      EXPORTING
        language      = sy-langu
        objnr         = r_objnr
        status_number = h_status_tab-stat
      IMPORTING
        txt04         = h_status_text_tab-txt04
      EXCEPTIONS
        OTHERS        = 01.
    IF sy-subrc = 0.
      APPEND h_status_text_tab.
    ENDIF.
  ENDLOOP.

* check status inclusive
  IF NOT g_stai1_lines IS INITIAL.
    LOOP AT h_status_text_tab.
      LOOP AT gt_stai1.
        IF gt_stai1-low = h_status_text_tab-txt04.
          g_incl = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF g_incl = 'X'.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDIF.

* check status exclusive
  IF NOT g_stae1_lines IS INITIAL.
    LOOP AT h_status_text_tab.
      LOOP AT gt_stae1.
        IF gt_stae1-low = h_status_text_tab-txt04.
          g_excl = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF g_excl = 'X'.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDFORM.                    "check_statusse

*Text symbol text£º
*001:Selection screen input
*E03:No authorization for sales organisation: &1
*E04:Fill in only 1 period !
*E05:Pls Fill in SalesOrder Creation or TECO Date
*I01:No contracts selected !
*I10:Act_rev
*I11:Profit Center (Text)
*I12:Sales Org.(Text)
*I13:Region (Text)
*I14:Sales district(Text)
*I15:Sales office(Text)
*I16:Customer Industrial Code
*I17:Customer Ind.Code(Text)
*I18:Customer group(Text)
*I19:Customer Name
*I20:PLC(Text)
*I21:GAC(Text)
*I22:PGC(Text)
*I23:Plant(Text)
*I24:Equipment description
*I25:Contract
*I26:Contract item invoiced
*I27:Contract item invoice outstanding
*I28:Contract item value total
*I29:Product
*I30:Product description
*I31:Revenues Actual
*I32:Discount
*I33:Net invoiced sales Actual
*I34:Unadjusted COS Actual
*I35:Parts Actual
*I36:Labour Actual
*I37:Mileage Actual
*I38:Ad Hoc Expenses Actual
*I39:Subcontracting Actual
*I40:COGS-Contract provis Actual
*I41:Fix price accruals Actual
*I42:Unadjusted COGS Actual
*I43:Unadjusted Gross Profit Actual
*I44:% UGP Actual
*I45:Tot.Revenues Planned
*I46:Tot.Costs Planned
*I47:Tot.Planned GP value
*I48:Tot.Planned GP value %
*I49:Profit Center
*I50:Segment
*I52:Segment (Text)
*I55:Sales group(Text)
*I56:Contract Type
*M03:Open dataset failed for :

*M05:Close dataset failed for :
*Selection text£º
*P_SERVER:        Path
*P_VKORG:D       .
*S_BRAN1:        Customer industrial code
*S_BUDAT:D       .
*S_BZIRK:D       .
*S_EQUNR:D       .
*S_GAC:D       .
*S_KDGRP:D       .
*S_KUNNR:        Customer
*S_MATKL:D       .
*S_MATNR:        Product
*S_PERIO:D       .
*S_PGC:D       .
*S_PLC:D       .
*S_POSNR:D       .
*S_PRCTR:D       .
*S_REGION:D       .
*S_STAE1:        SDI Status excluded
*S_STAI1:        SDI Status included
*S_VBELN:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
