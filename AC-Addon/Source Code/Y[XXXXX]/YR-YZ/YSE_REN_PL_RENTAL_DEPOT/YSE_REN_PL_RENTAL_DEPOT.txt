************************************************************************
* Program ID           : YSE_REN_PL_RENTAL_DEPOT                       *
* Program title        : REN: P/L per Rental Depot                     *
* Author               : Erik Walravens                                *
* Date                 : 30.01.2007                                    *
* Development Number   : D214-Rental                                   *
* Change Request Number: CD1K909906                                    *
* Description          : This report loads a pre-defined table with    *
*                        distributed costs per equipment. These are    *
*                        regrouped per selected depot for the selected *
*                        period.
************************************************************************
* Notes                                                                *
* * Extra texts in selection parameters. To be deleted.                *
* * First fiscal month is Januari. The program does not consider this  *
*   to change and does not check for offset for end period.            *
************************************************************************
* MOD-001 |14/03/2007| Erik Walravens | CD1K911602        | 001        *
* Description: Change header texts.                                    *
*              Fix YSE_RENT_COPA fields bug.                           *
*----------------------------------------------------------------------*
* MOD-002 |16/03/2007| Erik Walravens | CD1K912478        | 002        *
* Description: Fix Revenue, Service Cost and Other Cost totals error.  *
*----------------------------------------------------------------------*
* MOD-003 |16/03/2007| Erik Walravens | CD1K912513        | 003        *
* Description: Add absolute and percentile margins.                    *
*----------------------------------------------------------------------*
* MOD-004 |19/03/2007| Erik Walravens | CD1K912632        | 004        *
* Description: Include fiscal period defaults.                         *
*              Add transaction KE24 on double-click                    *
*              Fix other cost sum bug.                                 *
*----------------------------------------------------------------------*
* MOD-005 |12/04/2007| Pieter Jespers | CD1K913810        | 005        *
* Description: Authorisation check                                     *
* CD1K914102 - Note:                                                   *
*----------------------------------------------------------------------*
* MOD-006 |08/05/2007| Erik Walravens | CD1K914224        | 006        *
* Description: Add column unassigned costs.                            *
*              Add column horizontal totals.                           *
*              Add sum total Op. Gross Profit.                         *
*              Add sum percentile Op. Gross Profit.                    *
* Note: Authorization check is not up-to-date.                         *
************************************************************************
REPORT yse_ren_pl_rental_depot.

************************************************************************
* CLASSES                                                              *
************************************************************************
CLASS lcl_event_handler DEFINITION.
  PUBLIC SECTION.
    METHODS:
*   Double click control
    handle_double_click
          FOR EVENT double_click OF cl_gui_alv_grid
          IMPORTING e_row e_column.
ENDCLASS.                    "lcl_event_handler DEFINITION

*----------------------------------------------------------------------*
*       CLASS lcl_event_handler IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_handler IMPLEMENTATION.
* Handle double click
  METHOD handle_double_click.
    PERFORM handle_double_click USING e_row e_column.
  ENDMETHOD.                    "handle_double_click
ENDCLASS.                    "lcl_event_handler IMPLEMENTATION

*----------------------------------------------------------------------*
*       CLASS lcl_event_handler_0200 DEFINITION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_handler_0200 DEFINITION.
  PUBLIC SECTION.
    METHODS:
*   Double click control
    handle_double_click_0200
          FOR EVENT double_click OF cl_gui_alv_grid
          IMPORTING e_row e_column.
ENDCLASS.                    "lcl_event_handler DEFINITION

*----------------------------------------------------------------------*
*       CLASS lcl_event_handler_0200 IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_handler_0200 IMPLEMENTATION.
* Handle double click
  METHOD handle_double_click_0200.
    PERFORM handle_double_click_0200 USING e_row e_column.
  ENDMETHOD.                    "handle_double_click_0200
ENDCLASS.                    "lcl_event_handler IMPLEMENTATION


********************************************************************
* FIELD-SYMBOLS                                                    *
********************************************************************
FIELD-SYMBOLS: <it_result>  TYPE table,
               <wa_result>,
               <dyn_field>,
               <fieldcat>   TYPE lvc_s_fcat.

********************************************************************
* OBJECTS                                                          *
********************************************************************
DATA:  obj_container     TYPE REF TO cl_gui_docking_container,
       obj_cont_0200     TYPE REF TO cl_gui_docking_container,
       obj_alv           TYPE REF TO cl_gui_alv_grid,
       obj_alv_0200      TYPE REF TO cl_gui_alv_grid,
       obj_event_handler TYPE REF TO lcl_event_handler,
       obj_event_handler_0200 TYPE REF TO lcl_event_handler_0200.

************************************************************************
* TABLES                                                               *
************************************************************************
TABLES: itob, cosp, cofit.

************************************************************************
* TYPE-POOLS                                                           *
************************************************************************
TYPE-POOLS: slis, ftis.

************************************************************************
* INTERNAL TYPES                                                       *
************************************************************************
TYPES:  BEGIN OF str_depots,
               vkbur        TYPE tvbur-vkbur,  " Sales office (= depot)
               bezei        TYPE tvkbt-bezei,  " Sales office name
        END OF str_depots.

TYPES:  BEGIN OF str_copa,
               vkbur        TYPE itob-vkbur,   " Sales office (= depot)
               fperd        TYPE zfiscperiod,  " Fiscal month
               vrevu        TYPE zrevu,        " Revenue
               adepr        TYPE zdepr,
               " Allocated depreciation costs
               vserv        TYPE zserv,        " Allocated service costs
               vothr        TYPE zothr,        " Other costs
               waers        TYPE waers,        " Currency
        END OF str_copa.

TYPES:  BEGIN OF str_detail,
               equnr        TYPE equi-equnr,   " Sales office (= depot)
               vrevu        TYPE zrevu,        " Revenue
               adepr        TYPE zdepr,
               " Allocated depreciation costs
               vserv        TYPE zserv,        " Allocated service costs
               vothr        TYPE zothr,        " Other costs
               waers        TYPE waers,        " Currency
        END OF str_detail.

************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:
  it_depots   TYPE TABLE OF str_depots WITH HEADER LINE,  " Sales off.
  it_copa     TYPE TABLE OF str_copa   WITH HEADER LINE,  " COPA records
  it_detail   TYPE TABLE OF str_detail WITH HEADER LINE,  " Detail view
  it_bdcdata  TYPE TABLE OF bdcdata    WITH HEADER LINE,  " Screen par
  it_fieldcat TYPE lvc_t_fcat          WITH HEADER LINE.  " ALV grid

************************************************************************
* CONSTANTS                                                            *
************************************************************************
CONSTANTS:
  gc_true  TYPE char1       VALUE 'X',    " true
  gc_engl  LIKE tvagt-spras VALUE 'E'.    " english

************************************************************************
* VARIABLES                                                            *
************************************************************************
* ALV grid handling
DATA:
  okcode          LIKE sy-ucomm,       " return param screen 100
  gs_layout       TYPE lvc_s_layo ,
  g_behaviour_alv TYPE REF TO cl_dragdrop,
  ls_options      TYPE ctu_params,    " Call tranx options
  cellcolor       TYPE lvc_t_scol,
  o_bukrs(4)      TYPE c,              " Output field Company Code
  o_fyear(4)      TYPE c,              " Output fiscal year
  o_angdt(4)      TYPE c,              " Output fiscal period start
  o_bnddt(4)      TYPE c,              " Output fiscal period end
  o_period(4)     TYPE c,              " Output fiscal period
  o_vkbur(10)     TYPE c.              " Output Sales Office
* Dynamic table generation
DATA:
  dy_table        TYPE REF TO data,
  dy_line         TYPE REF TO data.
* Process
DATA:
  lv_date         TYPE sy-datum,
  lv_year(4)      TYPE c,
  lv_bukrs(4)     TYPE c,
  lv_vkorg(4)     TYPE c,
  lv_month        TYPE ftis_monat,
  gv_text(10)     TYPE c,             " temporary text variable
  gv_periods      TYPE p,             " # of periods in selection
  gv_columns      TYPE p.             " # columns in output table

************************************************************************
* SELECTION SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-s01.
PARAMETERS:
  p_bukrs  TYPE itob-bukrs OBLIGATORY,   " Company code
  p_vkorg  TYPE itob-vkorg OBLIGATORY,   " Sales organization
  p_vkbur  TYPE itob-vkbur,              " Sales Off (=depot)
  p_gjahr  TYPE cosp-gjahr OBLIGATORY,   " Fiscal year
  p_start  TYPE cofit-rpmax,             " Start period
  p_end    TYPE cofit-rpmax.             " End period
SELECTION-SCREEN END OF BLOCK b1.

************************************************************************
* INITIALIZATION                                                       *
************************************************************************
INITIALIZATION.

  PERFORM init_params.

************************************************************************
* AT SELECTION SCREEN                                                  *
************************************************************************
AT SELECTION-SCREEN.

  PERFORM check_authorization.

************************************************************************
* START OF SELECTION                                                   *
************************************************************************
START-OF-SELECTION.

  PERFORM calc_periods.
  PERFORM create_result_table.
  PERFORM fill_result_table.

  CALL SCREEN 100.


************************************************************************
* Module STATUS_0100 OUTPUT                                            *
************************************************************************
MODULE status_0100 OUTPUT.
  SET TITLEBAR '100' .
  SET PF-STATUS 'STATUS100'.
ENDMODULE.                 " STATUS_0100  OUTPUT


************************************************************************
* Module USER_COMMAND_0100 INPUT                                       *
************************************************************************
MODULE user_command_0100 INPUT.

  CASE okcode.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
  ENDCASE.
ENDMODULE.                 " USER_COMMAND_0100 INPUT

************************************************************************
* Module PREPARE_SCREEN OUTPUT                                         *
************************************************************************
MODULE prepare_screen OUTPUT.

  IF obj_container IS INITIAL.

*   Create the container
    CREATE OBJECT obj_container
      EXPORTING
        repid           =  sy-repid
        dynnr           =  sy-dynnr
        lifetime        =  cntl_lifetime_dynpro
        extension       =  280
        side  = cl_gui_docking_container=>dock_at_bottom.

*   Create the ALV control
    CREATE OBJECT obj_alv
      EXPORTING
        i_parent  =  obj_container.

    CREATE OBJECT obj_event_handler.

    PERFORM build_alv.

*   Enable line selection and double clicking
    SET HANDLER obj_event_handler->handle_double_click FOR obj_alv.
  ENDIF.    " obj_container IS INITIAL

* Prepare header data
  o_bukrs = p_bukrs.
  o_fyear = p_gjahr.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = p_start
    IMPORTING
      output = o_angdt.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = p_end
    IMPORTING
      output = o_bnddt.

ENDMODULE.                 " PREPARE_SCREEN  OUTPUT


************************************************************************
* Form BUILD_ALV                                                       *
************************************************************************
* No arguments                                                         *
************************************************************************
* Builds the field catalog, sets display parameters and calls the      *
* method to display the results on screen.                             *
************************************************************************
FORM build_alv.

  PERFORM build_field_catalog.

*  gs_layout-no_toolbar = lc_true.
*  gs_layout-sel_mode   = 'D'.
  gs_layout-ctab_fname = 'CELLCOLOR'.

*MODIFY ITAB INDEX L_INDEX TRANSPORTING CELLCOLOR.


  CALL METHOD obj_alv->set_table_for_first_display
                EXPORTING
                    i_save        =  'A'
*                    is_variant    =  ls_variant
                     is_layout     =  gs_layout
                CHANGING
                    it_outtab         =  <it_result>
                    it_fieldcatalog   =  it_fieldcat[].

ENDFORM.                    "build_alv


************************************************************************
* Module STATUS_0200 OUTPUT                                            *
************************************************************************
MODULE status_0200 OUTPUT.
  SET TITLEBAR 'TITLE200' .
  SET PF-STATUS 'STATUS200'.
ENDMODULE.                 " STATUS_0200  OUTPUT

************************************************************************
* Module USER_COMMAND_0200 INPUT                                       *
************************************************************************
MODULE user_command_0200 INPUT.

  CASE okcode.
    WHEN 'BACK'.
      IF NOT obj_alv_0200 IS INITIAL.
        CALL METHOD obj_alv_0200->free.
      ENDIF.

      IF NOT obj_cont_0200 IS INITIAL.
        CALL METHOD obj_cont_0200->free.
      ENDIF.

      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      IF NOT obj_alv_0200 IS INITIAL.
        CALL METHOD obj_alv_0200->free.
      ENDIF.

      IF NOT obj_cont_0200 IS INITIAL.
        CALL METHOD obj_cont_0200->free.
      ENDIF.

      LEAVE TO SCREEN 0.
  ENDCASE.
ENDMODULE.                 " USER_COMMAND_0100 INPUT


************************************************************************
* Module PREPARE_SCREEN_0200 OUTPUT                                    *
************************************************************************
MODULE prepare_screen_0200 OUTPUT.

*  IF obj_alv_0200 IS INITIAL.

* Create the container
  CREATE OBJECT obj_cont_0200
    EXPORTING
      repid           =  sy-repid
      dynnr           =  sy-dynnr
      lifetime        =  cntl_lifetime_dynpro
      extension       =  295
      side  = cl_gui_docking_container=>dock_at_bottom.

* Create the ALV control
  CREATE OBJECT obj_alv_0200
    EXPORTING
      i_parent  =  obj_cont_0200.

  CREATE OBJECT obj_event_handler_0200.

  PERFORM build_alv_0200.

* Enable line selection and double clicking
  SET HANDLER obj_event_handler_0200->handle_double_click_0200 FOR
  obj_alv_0200.

* Prepare header data
  o_bukrs = p_bukrs.
  o_fyear = p_gjahr.

*  ELSE.
*
** Note: causes a dump at second calling.
**       Alternative solution is to free the objects after use
**       and recreate the field catalog and screen at each call.
*
*    CALL METHOD obj_alv_0200->refresh_table_display
*             EXPORTING
*                  I_SOFT_REFRESH = gc_true.
*
*  ENDIF.    " obj_cont_0200 IS INITIAL
ENDMODULE.                 " PREPARE_SCREEN_200  OUTPUT


************************************************************************
* Form BUILD_ALV                                                       *
************************************************************************
* No arguments                                                         *
************************************************************************
* Builds the field catalog, sets display parameters and calls the      *
* method to display the results on screen.                             *
************************************************************************
FORM build_alv_0200.

  PERFORM build_field_catalog_0200.

*  gs_layout-no_toolbar = lc_true.
*  gs_layout-sel_mode   = 'D'.

  CALL METHOD obj_alv_0200->set_table_for_first_display
                EXPORTING
                    i_save        =  'A'
*                    is_variant    =  ls_variant
*                    is_layout     =  gs_layout
                CHANGING
                    it_outtab         =  it_detail[]
                    it_fieldcatalog   =  it_fieldcat[].

ENDFORM.                    "build_alv_0200


************************************************************************
* Form INIT_PARAMS                                                     *
************************************************************************
* Initializes selection parameters.                                    *
************************************************************************
FORM init_params.

* Company code
  GET PARAMETER ID 'BUK' FIELD lv_bukrs.
  p_bukrs = lv_bukrs.

* Sales organisation
  GET PARAMETER ID 'VKO' FIELD lv_vkorg.
  p_vkorg = lv_vkorg.

* Company Code
  GET PARAMETER ID 'GJR' FIELD lv_year.
  p_gjahr      = lv_year.

* fiscal year
  IF p_gjahr IS INITIAL.
    p_gjahr    = sy-datum(4).
  ENDIF.

* Start period
  p_start(1)   = 0.
  p_start+1(2) = sy-datum+4(2).

* End period
  p_end(1)     = 0.
  p_end+1(2)   = sy-datum+4(2).

ENDFORM.                    "init_params


************************************************************************
* Form CALC_PERIODS                                                    *
************************************************************************
* Checks if start and end period were entered, search for missing ones *
* and calculate number of periods to forsee number of columns in ALV.  *
************************************************************************
FORM calc_periods.
* If start period was omitted, get first period of fiscal year
  lv_year = p_gjahr.
  IF p_start IS INITIAL.

    CALL FUNCTION 'GM_GET_FISCAL_YEAR_START'
      EXPORTING
        i_fyv                          = 'K4'
        i_fiscalyear                   = lv_year
      IMPORTING
        e_startdate                    = lv_date
      EXCEPTIONS
        invalid_fiscal_year_variant    = 1
        incomplete_fiscal_year_variant = 2
        fyv_not_defined_for_year       = 3
        OTHERS                         = 4.

    IF sy-subrc <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*             WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ELSE.
      p_start = lv_date+4(2).
    ENDIF.
  ENDIF.

* If end period was omitted, get current period of fiscal year
  IF p_end IS INITIAL.
    CALL FUNCTION 'FTI_FISCAL_YEAR_MONTH_GET'
      EXPORTING
        i_bukrs        = p_bukrs
        i_budat        = sy-datum
*       I_DZTERM       = FTIS_DATUM-INITIAL
        i_gjahr        = p_gjahr
      IMPORTING
*       E_GJAHR        = lv_year
        e_monat        = lv_month.

    p_end = lv_month.
  ENDIF.
* Number of periods in this selection
  gv_periods = p_end - p_start + 1.
ENDFORM.                             " calc_periods


************************************************************************
* Form HANDLE_DOUBLE_CLICK                                             *
************************************************************************
*      -->P_E_ROW_ID     text                                          *
*      -->P_E_COLUMN_ID  text                                          *
*      -->P_ES_ROW_NO    text                                          *
************************************************************************
* When a field in the ALV grid has been double clicked, load the       *
* detail overview for that period and rental depot.                    *
************************************************************************
FORM handle_double_click  USING    p_e_row_id
                                   p_e_column_id.
*                                    p_es_row_no STRUCTURE lvc_s_roid.

  DATA: lv_vkbur     TYPE yse_rent_copa-vkbur,
        lv_period    TYPE yse_rent_copa-fperd.

  IF p_e_column_id <> 'PERNR' AND
     p_e_column_id <> 'COTYP'.

    lv_vkbur  = p_e_column_id.
    IF gv_periods = 1.
      lv_period = p_start.
    ELSE.
      lv_period = ( ( p_e_row_id + 5 ) DIV 6 ) - 1.
      lv_period = lv_period + p_start.
    ENDIF.

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = lv_period
      IMPORTING
        output = o_period.

    o_vkbur = lv_vkbur.

*   Get Sales Office name
    SELECT SINGLE bezei
          INTO o_vkbur
          FROM tvkbt
         WHERE vkbur = lv_vkbur.

*   Get all equipments in selected rental depot for selected period
    SELECT equnr vrevu adepr vserv vothr waers
        FROM yse_rent_copa
        INTO CORRESPONDING FIELDS OF TABLE it_detail
       WHERE bukrs = p_bukrs
         AND vkorg = p_vkorg
         AND vkbur = lv_vkbur
         AND fyear = lv_year
         AND fperd = lv_period.

*   Remove equipment number's leading zero's.
    LOOP AT it_detail.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = it_detail-equnr
        IMPORTING
          output = it_detail-equnr.
      MODIFY it_detail.
    ENDLOOP.  " it_detail

    CALL SCREEN 200.
  ENDIF.  " if clicked on figures

ENDFORM.                    " handle_double_click


************************************************************************
* Form HANDLE_DOUBLE_CLICK_0200                                        *
************************************************************************
*      -->P_E_ROW_ID     text                                          *
*      -->P_E_COLUMN_ID  text                                          *
*      -->P_ES_ROW_NO    text                                          *
************************************************************************
* When a field in the ALV grid has been double clicked, start trans-   *
* action KE24 for Revenue and Service costs.                           *
************************************************************************
FORM handle_double_click_0200  USING    p_e_row_id
                                        p_e_column_id.
*p_es_row_no STRUCTURE lvc_s_roid.

  DATA: lv_tmp(7)      TYPE c,
        lv_kokrs       TYPE kokrs.      " Controlling Area

  READ TABLE it_detail INDEX p_e_row_id.


  IF p_e_column_id = 'VREVU' OR
     p_e_column_id = 'VSERV'.

*   Selection screen
    PERFORM bdc_add_screen USING 'RKEB0601' '1000'.
*   OKCode
    PERFORM bdc_add_field  USING 'BDC_OKCODE' '=WEIT'.

*   Other parameters selection screen
    PERFORM bdc_add_screen USING 'SAPLKEC1' '0100'.
*   Select Controlling Areaon tenth line
    PERFORM bdc_add_field  USING 'CEC01-CHOICE(10)' 'X'.
*   Press Page down
    PERFORM bdc_add_field  USING 'BDC_OKCODE' '=P+'.

*   Other parameters selection screen
    PERFORM bdc_add_screen USING 'SAPLKEC1' '0100'.
*   Select Equipment on sixth line
    PERFORM bdc_add_field  USING 'CEC01-CHOICE(06)' 'X'.
*   Press Space to select the option
    PERFORM bdc_add_field  USING 'BDC_OKCODE' '=SPAC'.

*   Equipment range screen
    PERFORM bdc_add_screen USING 'SAPLKEC1' '0350'.
*   Enter Controlling Area
    SELECT SINGLE kokrs
        INTO lv_kokrs
        FROM tka02
       WHERE bukrs = p_bukrs.
    PERFORM bdc_add_field  USING 'CEC02-LOW(01)' lv_kokrs.
*   Enter Equipment number
    PERFORM bdc_add_field  USING 'CEC02-LOW(02)' it_detail-equnr.
*   Press Space ???
    PERFORM bdc_add_field  USING 'BDC_OKCODE' '=SPAC'.

*   Selection screen
    PERFORM bdc_add_screen USING 'RKEB0601' '1000'.
*   Enter Company Code Currency
    PERFORM bdc_add_field  USING 'PALEDGER' '10'.
*   Enter Fiscal Period
    lv_tmp = '0000000'.
    IF o_period+1(1) <> space.
      lv_tmp+1(1) = o_period(1).
      lv_tmp+2(1) = o_period+1(1).
    ELSE.
      lv_tmp+2(1) = o_period(1).
    ENDIF.
    lv_tmp+3(4) = p_gjahr.
    PERFORM bdc_add_field  USING 'PERIO-LOW' lv_tmp.
*   Enter "Read as Posted" radio button
    PERFORM bdc_add_field  USING 'PREADM2' 'X'.
*   Run (F8)
    PERFORM bdc_add_field  USING 'BDC_OKCODE' '=ONLI'.

*   Display warning
    PERFORM bdc_add_screen USING 'SAPMSSY0' '0120'.
*   Press Enter
    PERFORM bdc_add_field  USING 'BDC_OKCODE' '=ENTE'.

*   Execute...
    ls_options-nobiend = 'X'.
    ls_options-dismode = 'E'.
    ls_options-updmode = 'S'.
    CALL TRANSACTION 'KE24' USING it_bdcdata
                     OPTIONS FROM ls_options.

  ENDIF.

ENDFORM.                    " handle_double_click_0200


************************************************************************
* Form CREATE_RESULT_TABLE                                             *
************************************************************************
* No arguments                                                         *
************************************************************************
* Dynamically creates a table based on number of periods and number of *
* sales offices (1 if selected in selection options, otherwise all 4). *
************************************************************************
FORM create_result_table.

  DATA: it_template TYPE TABLE OF lvc_s_fcat,
        wa_template LIKE LINE OF it_template,
        d_ref       TYPE REF TO data,
        dy_line     TYPE REF TO data.

* Build template of internal table
  wa_template-ref_table = 'EQKT'.
  wa_template-ref_field = 'EQKTX'.       " type char 40 field

* If more than one period selected.
  IF gv_periods > 1.
*   Field: Period
    wa_template-ref_table = 'EQKT'.
    wa_template-ref_field = 'EQKTX'.       " type char 40 field
    wa_template-fieldname = 'PERNR'.
    APPEND wa_template TO it_template.
  ENDIF.

* Fieldname: Cost Type denominator
  wa_template-ref_table = 'EQKT'.
  wa_template-ref_field = 'EQKTX'.       " type char 40 field
  wa_template-fieldname = 'COTYP'.
  APPEND wa_template TO it_template.

* If no depot in selection parameters...
  IF p_vkbur IS INITIAL.
*   create a column for each depot in this sales organisation
    wa_template-ref_table = 'YSE_REN_ALV_COPA_ALLOC'.
    wa_template-ref_field = 'VREVU'.       " type CURR field

*   Note: tvkbz could be changed to yse_rent_depot
    SELECT tvkbz~vkbur tvkbt~bezei
        INTO TABLE it_depots
        FROM tvkbz
       INNER JOIN tvkbt
          ON tvkbz~vkbur EQ tvkbt~vkbur
       WHERE vkorg EQ p_vkorg
         AND spras EQ gc_engl.
    SORT it_depots.
    DELETE ADJACENT DUPLICATES FROM it_depots.

    LOOP AT it_depots. " INTO wa_depots.
      gv_text = it_depots-vkbur.
      wa_template-fieldname = gv_text.
      APPEND wa_template TO it_template.
    ENDLOOP.
*   Add one column for unassigned costs
    wa_template-fieldname = 'Unassigned'(T01).
    APPEND wa_template TO it_template.

*   Add one column to add all costs
    wa_template-fieldname = 'Total'(T02).
    APPEND wa_template TO it_template.

  ELSE.
*   Create a single column for the selected depot
    wa_template-ref_table = 'YSE_REN_ALV_COPA_ALLOC'.
    wa_template-ref_field = 'VREVU'.       " type CURR field
    wa_template-fieldname = p_vkbur.
    APPEND wa_template TO it_template.
  ENDIF.

* Build internal table
  CALL METHOD cl_alv_table_create=>create_dynamic_table
    EXPORTING
      it_fieldcatalog = it_template
    IMPORTING
      ep_table        = d_ref.

  ASSIGN d_ref->* TO <it_result>.
  CREATE DATA dy_line LIKE LINE OF <it_result>.
  ASSIGN dy_line->* TO <wa_result>.

ENDFORM.   " create_result_table


************************************************************************
* Form FILL_RESULT_TABLE                                               *
************************************************************************
* No arguments                                                         *
************************************************************************
* Fills the table to be displayed.                                     *
************************************************************************
FORM fill_result_table.

  DATA: lv_column     TYPE i,
        lv_perctr     TYPE i,         " period counter
        lv_period     TYPE i,         " absolute period
        lv_row        TYPE i,         " row counter
        lv_value      TYPE f,
        lv_total      TYPE f,         " Total per line
        lv_revenue    TYPE f,         " Revenue per depot
        lv_tot_rev    TYPE f,         " Total Revenue
        lv_costs      TYPE f,         " Total operating costs
        lv_opgrop     TYPE f,         " Operating gross profit
        lv_tot_opgrop TYPE f,         " Total Oper gross profit
        lv_index      TYPE i.         " row number

* Pre-load depreciation costs for selected year/periods
  SELECT vkbur fperd vrevu
         adepr vserv vothr waers
      FROM yse_rent_copa
      INTO TABLE it_copa
     WHERE bukrs EQ p_bukrs
       AND vkorg EQ p_vkorg
       AND fyear EQ p_gjahr
       AND fperd GE p_start
       AND fperd LE p_end.

* Do for each period.
  lv_perctr = 1.                    " period counter
  WHILE lv_perctr <= gv_periods.

    lv_period = p_start + lv_perctr - 1.
*   Create four records: Revenue - Depreciation - Service - Other
*   plus two margins: Absolute margin - Percentile margin
    lv_row = 1.
    WHILE lv_row < 7.               " 6 rows.
      CLEAR <wa_result>.
      lv_column = 1.
*     If more than one period there is a period denominator
      IF gv_periods > 1.
        ASSIGN COMPONENT lv_column
            OF STRUCTURE <wa_result>
            TO <dyn_field>.
        gv_text = lv_period.
        <dyn_field> = gv_text.              " Period denominator
        lv_column = lv_column + 1.
      ENDIF.

*     Write line denominator
      ASSIGN COMPONENT lv_column
          OF STRUCTURE <wa_result>
          TO <dyn_field>.

      CASE lv_row.
        WHEN 1. <dyn_field> = 'Revenue'(001).
        WHEN 2. <dyn_field> = 'Depreciation'(002).
        WHEN 3. <dyn_field> = 'Service'(003).
        WHEN 4. <dyn_field> = 'Other'(004).
        WHEN 5. <dyn_field> = 'Op. Gross Profit'(T03).
        WHEN 6. <dyn_field> = 'Percentile OGP'(T04).
      ENDCASE.

      lv_column = lv_column + 1.

*     Calculate correct value depending of costtype being written
      CASE lv_row.
        WHEN 1.  " Revenue
*         If more than one depot
          IF p_vkbur IS INITIAL.
            lv_total = 0.
*           Fill in costs for each depot in the selected sales org
            LOOP AT it_depots.
*             Calculate Revenue for each depot
              lv_value = 0.
              LOOP AT it_copa WHERE vkbur = it_depots-vkbur
                                AND fperd = lv_period.
                lv_value = lv_value + it_copa-vrevu.
              ENDLOOP.  " it_copa
              ASSIGN COMPONENT lv_column
                  OF STRUCTURE <wa_result>
                  TO <dyn_field>.
              <dyn_field> = lv_value.
              lv_total = lv_total + lv_value.
              lv_column = lv_column + 1.
            ENDLOOP.
*           Calculate Revenue for unassigned depots.
            lv_value = 0.
            LOOP AT it_copa WHERE vkbur = space
                              AND fperd = lv_period.
              lv_value = lv_value + it_copa-vrevu.
            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_value.
            lv_total = lv_total + lv_value.
            lv_column = lv_column + 1.
*           Calculate sum of revenues.
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_total.
            lv_column = lv_column + 1.
          ELSE.
*           Calculate Revenue for only selected depot
            LOOP AT it_copa WHERE vkbur = p_vkbur
                              AND fperd = lv_period.
              lv_value = lv_value + it_copa-vrevu.
            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_value.
            lv_column = lv_column + 1.
          ENDIF.
        WHEN 2.  " Depreciation costs
*         If more than one depot
          IF p_vkbur IS INITIAL.
            lv_total = 0.
*           Fill in costs for each depot in the selected sales org
            LOOP AT it_depots.
*             Calculate depreciation costs for this depot
              lv_value = 0.
              LOOP AT it_copa WHERE vkbur = it_depots-vkbur
                                AND fperd = lv_period.
                lv_value = lv_value + it_copa-adepr.
              ENDLOOP.  " it_copa
              ASSIGN COMPONENT lv_column
                  OF STRUCTURE <wa_result>
                  TO <dyn_field>.
              <dyn_field> = lv_value.
              lv_total = lv_total + lv_value.
              lv_column = lv_column + 1.
            ENDLOOP.  " it_depots.
*           Calculate Depr Costs for unassigned depots
            lv_value = 0.
            LOOP AT it_copa WHERE vkbur = space
                              AND fperd = lv_period.
              lv_value = lv_value + it_copa-adepr.
            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_value.
            lv_total = lv_total + lv_value.
            lv_column = lv_column + 1.
*           Add sum of Depr Costs
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_total.
            lv_column = lv_column + 1.
          ELSE.
*           Fill only depot field
            lv_value = 0.
            LOOP AT it_copa WHERE vkbur = p_vkbur
                              AND fperd = lv_period.
              lv_value = lv_value + it_copa-adepr.
            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_value.
            lv_column = lv_column + 1.
          ENDIF.
        WHEN 3.  " Service costs
*         If more than one depot
          IF p_vkbur IS INITIAL.
            lv_total = 0.
*           Fill in costs for each depot in the selected sales org
            LOOP AT it_depots.
*             Calculate Service Costs for each depot
              lv_value = 0.
              LOOP AT it_copa WHERE vkbur = it_depots-vkbur
                                AND fperd = lv_period.
                lv_value = lv_value + it_copa-vserv.
              ENDLOOP.  " it_copa
              ASSIGN COMPONENT lv_column OF STRUCTURE <wa_result> TO
              <dyn_field>.
              <dyn_field> = lv_value.
              lv_total = lv_total + lv_value.
              lv_column = lv_column + 1.
            ENDLOOP.
*           Calculate Serv Costs for unassigned depots
            lv_value = 0.
            LOOP AT it_copa WHERE vkbur = space
                              AND fperd = lv_period.
              lv_value = lv_value + it_copa-vserv.
            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_value.
            lv_total = lv_total + lv_value.
            lv_column = lv_column + 1.
*           Add sum of Serv Costs
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_total.
            lv_column = lv_column + 1.
          ELSE.
*           Calculate Service Costs for only selected depot
            lv_value = 0.
            LOOP AT it_copa WHERE vkbur = p_vkbur
                              AND fperd = lv_period.
              lv_value = lv_value + it_copa-vserv.
            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_value.
            lv_column = lv_column + 1.
          ENDIF.
        WHEN 4.  " Other costs
*         If more than one depot
          IF p_vkbur IS INITIAL.
            lv_total = 0.
*           Fill in costs for each depot in the selected sales org
            LOOP AT it_depots. " INTO wa_depots.
*             Calculate Other Costs for each depot
              lv_value = 0.
*              LOOP AT it_copa WHERE vkbur = it_depots-vkbur
*                                AND fperd = lv_period.
*                lv_value = lv_value + it_copa-vothr.
*              ENDLOOP.  " it_copa
              CLEAR it_copa.
              READ TABLE it_copa WITH KEY vkbur = it_depots-vkbur
                                          fperd = lv_period.
              ASSIGN COMPONENT lv_column
                  OF STRUCTURE <wa_result>
                  TO <dyn_field>.
              <dyn_field> = it_copa-vothr.
              lv_total = lv_total + it_copa-vothr.
              lv_column = lv_column + 1.
            ENDLOOP.
*           Add Oth Costs for unassigned depots
            lv_value = 0.
            READ TABLE it_copa WITH KEY vkbur = space
                                        fperd = lv_period.
*            LOOP AT it_copa WHERE vkbur = space
*                              AND fperd = lv_period.
*              lv_value = lv_value + it_copa-vothr.
*            ENDLOOP.  " it_copa
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = it_copa-vothr.
            lv_total = lv_total + it_copa-vothr.
            lv_column = lv_column + 1.
*           Add sum of Oth Costs
            ASSIGN COMPONENT lv_column
                OF STRUCTURE <wa_result>
                TO <dyn_field>.
            <dyn_field> = lv_total.
            lv_column = lv_column + 1.
          ELSE.
*           Calculate Service Costs for only selected depot
            lv_value = 0.
*            LOOP AT it_copa WHERE vkbur = p_vkbur
*                              AND fperd = lv_period.
*              lv_value = lv_value + it_copa-vothr.
*            ENDLOOP.  " it_copa
            CLEAR it_copa.
            READ TABLE it_copa WITH KEY vkbur = it_depots-vkbur
                                        fperd = lv_period.
            ASSIGN COMPONENT lv_column OF STRUCTURE <wa_result> TO
            <dyn_field>.
            <dyn_field> = it_copa-vothr.
            lv_column = lv_column + 1.
          ENDIF.
      ENDCASE.

*     Write record to output table
      APPEND <wa_result> TO <it_result>.
*     Jump to next row
      lv_row = lv_row + 1.  " lv_costtype = lv_costtype + 1.
    ENDWHILE.
*   Jump to next period block
    lv_perctr = lv_perctr + 1.
  ENDWHILE.

  lv_perctr = 1.           " Reset period counter
* For each period
  WHILE lv_perctr <= gv_periods.

*   If more than one depot
    IF p_vkbur IS INITIAL.
      lv_tot_rev = 0.
      lv_tot_opgrop = 0.

*     Loop through each column
      LOOP AT it_depots.
*       Read total revenue
        lv_index = ( ( lv_perctr - 1 ) * 6 ) + 1.
        READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
        ASSIGN COMPONENT it_depots-vkbur
            OF STRUCTURE <wa_result>
            TO <dyn_field>.
        lv_revenue = <dyn_field>.
        lv_tot_rev = lv_tot_rev + lv_revenue.

*       Add 3 cost types
        lv_costs = 0.         " Reset costs
        DO 3 TIMES.
          lv_index = ( ( lv_perctr - 1 ) * 6 ) + 1 + sy-index.
          READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
          ASSIGN COMPONENT it_depots-vkbur
              OF STRUCTURE <wa_result>
              TO <dyn_field>.
          lv_costs = lv_costs + <dyn_field>.
        ENDDO.

*       Calculate absolute Operating Gross Profit
        lv_index = ( ( lv_perctr - 1 ) * 6 ) + 5.
        READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
        ASSIGN COMPONENT it_depots-vkbur
            OF STRUCTURE <wa_result>
            TO <dyn_field>.
        <dyn_field> = lv_revenue - lv_costs.
        lv_opgrop = lv_revenue - lv_costs.
        MODIFY <it_result> FROM <wa_result> INDEX lv_index.
        lv_tot_opgrop = lv_tot_opgrop + lv_opgrop.

*       Calculate percentile Operating Gross Profit
        lv_index = ( ( lv_perctr - 1 ) * 6 ) + 6.
        READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
        ASSIGN COMPONENT it_depots-vkbur
            OF STRUCTURE <wa_result>
            TO <dyn_field>.
        IF lv_revenue <> 0.
          <dyn_field> = ( lv_opgrop / lv_revenue ) * 100.
        ELSE.
          <dyn_field> = 0.
        ENDIF.
        MODIFY <it_result> FROM <wa_result> INDEX lv_index.
      ENDLOOP.  " it_depots
*     Do one more time for unassigned figures
*     Read total revenue
      lv_index = ( ( lv_perctr - 1 ) * 6 ) + 1.
      READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
      ASSIGN COMPONENT 'UNASSIGNED'
          OF STRUCTURE <wa_result>
          TO <dyn_field>.
      lv_revenue = <dyn_field>.
      lv_tot_rev = lv_tot_rev + lv_revenue.

*     Add 3 cost types
      lv_costs = 0.         " Reset costs
      DO 3 TIMES.
        lv_index = ( ( lv_perctr - 1 ) * 6 ) + 1 + sy-index.
        READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
        ASSIGN COMPONENT 'UNASSIGNED'
            OF STRUCTURE <wa_result>
            TO <dyn_field>.
        lv_costs = lv_costs + <dyn_field>.
      ENDDO.

*     Calculate absolute Operating Gross Profit
      lv_index = ( ( lv_perctr - 1 ) * 6 ) + 5.
      READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
      ASSIGN COMPONENT 'UNASSIGNED'
          OF STRUCTURE <wa_result>
          TO <dyn_field>.
      <dyn_field> = lv_revenue - lv_costs.
      lv_opgrop = lv_revenue - lv_costs.
      MODIFY <it_result> FROM <wa_result> INDEX lv_index.
      lv_tot_opgrop = lv_tot_opgrop + lv_opgrop.

*     Calculate percentile Operating Gross Profit
      lv_index = ( ( lv_perctr - 1 ) * 6 ) + 6.
      READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
      ASSIGN COMPONENT 'UNASSIGNED'
          OF STRUCTURE <wa_result>
          TO <dyn_field>.
      IF lv_revenue <> 0.
        <dyn_field> = ( lv_opgrop / lv_revenue ) * 100.
      ELSE.
        <dyn_field> = 0.
      ENDIF.
      MODIFY <it_result> FROM <wa_result> INDEX lv_index.

********************
    ELSE.
*     Read total revenue
      lv_index = ( ( lv_perctr - 1 ) * 6 ) + 1.
      READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
      ASSIGN COMPONENT p_vkbur OF STRUCTURE <wa_result> TO <dyn_field>.
      lv_revenue = <dyn_field>.

*     Add 3 cost types
      lv_costs = 0.         " Reset costs
      DO 3 TIMES.
        lv_index = ( ( lv_perctr - 1 ) * 6 ) + 1 + sy-index.
        READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
       ASSIGN COMPONENT p_vkbur
           OF STRUCTURE <wa_result>
           TO <dyn_field>.
        lv_costs = lv_costs + <dyn_field>.
      ENDDO.

*     Calculate absolute Operating Gross Profit
      lv_index = ( ( lv_perctr - 1 ) * 6 ) + 5.
      READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
      ASSIGN COMPONENT p_vkbur
          OF STRUCTURE <wa_result>
          TO <dyn_field>.
      <dyn_field> = lv_revenue - lv_costs.
      lv_opgrop = lv_revenue - lv_costs.
      MODIFY <it_result> FROM <wa_result> INDEX lv_index.

*     Calculate percentile Operating Gross Profit
      lv_index = ( ( lv_perctr - 1 ) * 6 ) + 6.
      READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
      ASSIGN COMPONENT p_vkbur
          OF STRUCTURE <wa_result>
          TO <dyn_field>.
      IF lv_revenue <> 0.
        <dyn_field> = ( lv_opgrop / lv_revenue ) * 100.
      ELSE.
        <dyn_field> = 0.
      ENDIF.
      MODIFY <it_result> FROM <wa_result> INDEX lv_index.
    ENDIF.    " # depots

*   Add horizontal total Operation Gross Profit
    lv_index = ( ( lv_perctr - 1 ) * 6 ) + 5.
    READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
    ASSIGN COMPONENT 'TOTAL'
        OF STRUCTURE <wa_result>
        TO <dyn_field>.
    <dyn_field> = lv_tot_opgrop.
    MODIFY <it_result> FROM <wa_result> INDEX lv_index.

*   Add total percentile Operation Gross Profit
    lv_index = ( ( lv_perctr - 1 ) * 6 ) + 6.
    READ TABLE <it_result> INDEX lv_index INTO <wa_result>.
    ASSIGN COMPONENT 'TOTAL'
        OF STRUCTURE <wa_result>
        TO <dyn_field>.
    <dyn_field> = ( lv_tot_opgrop / lv_tot_rev ) * 100.
    MODIFY <it_result> FROM <wa_result> INDEX lv_index.

    lv_perctr = lv_perctr + 1.     " Increase period counter
  ENDWHILE.  " lv_perctr.

ENDFORM.                    "fill_result_table

************************************************************************
* Form BUILD_FIELD_CATALOG                                             *
************************************************************************
* No arguments                                                         *
************************************************************************
* Builds the ALV grid's field catalog.                                 *
************************************************************************
FORM build_field_catalog.

  CLEAR it_fieldcat.

* If more than one period selected.
  IF gv_periods > 1.
*   Field: Period
    it_fieldcat-fieldname = 'PERNR'.
    it_fieldcat-outputlen = 6.
    it_fieldcat-coltext = 'Period'(005).
    it_fieldcat-tooltip = 'Fiscal period'(006).
    it_fieldcat-fix_column = 'X'.
    it_fieldcat-emphasize = 'X'.
    APPEND it_fieldcat.
  ENDIF.

* Fieldname: Cost Type denominator
  it_fieldcat-fieldname = 'COTYP'.
  it_fieldcat-outputlen = 14.
  it_fieldcat-coltext = 'Cost type'(007).
  it_fieldcat-tooltip = 'Cost denominator'(008).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* If more than one depot selected
  IF p_vkbur IS INITIAL.
*   Create a column for each depot
    LOOP AT it_depots.
      it_fieldcat-fieldname = it_depots-vkbur.
*      it_fieldcat-hotspot = gc_true.
      it_fieldcat-outputlen = 10.
      it_fieldcat-coltext = it_depots-bezei.
      it_fieldcat-tooltip = it_depots-vkbur.
      it_fieldcat-fix_column = 'X'.
*      it_fieldcat-emphasize = 'X'.
      APPEND it_fieldcat.
    ENDLOOP.
*   Add column for unassigned costs
    it_fieldcat-fieldname = 'UNASSIGNED'.
    it_fieldcat-outputlen = 10.
    it_fieldcat-coltext = 'Unassigned'(T01).
    it_fieldcat-tooltip = 'Unassigned'(T01).
    it_fieldcat-fix_column = 'X'.
    APPEND it_fieldcat.
*   Add column for horizontal totals
    it_fieldcat-fieldname = 'TOTAL'.
    it_fieldcat-outputlen = 10.
    it_fieldcat-coltext = 'Total'(T02).
    it_fieldcat-tooltip = 'Total'(T02).
    it_fieldcat-fix_column = 'X'.
    APPEND it_fieldcat.
  ELSE.
*   Create a single column for the selected depot
    it_fieldcat-fieldname = p_vkbur.
*    it_fieldcat-hotspot = gc_true.
    it_fieldcat-outputlen = 10.
    it_fieldcat-tooltip = p_vkbur.
*   Get Sales Office name
    SELECT SINGLE bezei
        INTO it_fieldcat-coltext
        FROM tvkbt
       WHERE vkbur = p_vkbur.
*    READ TABLE it_depots WITH KEY vkbur = p_vkbur.
*    it_fieldcat-coltext = it_depots-bezei.
    it_fieldcat-fix_column = 'X'.
*    it_fieldcat-emphasize = 'X'.
    APPEND it_fieldcat.
  ENDIF.
ENDFORM.    " build_field_catalog

************************************************************************
* Form BUILD_FIELD_CATALOG_0200                                        *
************************************************************************
* No arguments                                                         *
************************************************************************
* Builds the ALV grid's field catalog.                                 *
************************************************************************
FORM build_field_catalog_0200.

  CLEAR it_fieldcat.
  REFRESH it_fieldcat.

* Field: Equipment number
  it_fieldcat-fieldname = 'EQUNR'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Equipment'(009).
  it_fieldcat-tooltip = 'Equipment number'(010).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Fieldname: Revenue
  it_fieldcat-fieldname = 'VREVU'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Revenue'(011).
  it_fieldcat-tooltip = 'Revenue'(012).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Fieldname: Depreciation
  it_fieldcat-fieldname = 'ADEPR'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Depreciation'(013).
  it_fieldcat-tooltip = 'Depreciation costs'(014).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Fieldname: Service
  it_fieldcat-fieldname = 'VSERV'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Service'(015).
  it_fieldcat-tooltip = 'Service costs'(016).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

* Fieldname: Other
*  it_fieldcat-fieldname = 'VOTHR'.
*  it_fieldcat-outputlen = 10.
*  it_fieldcat-coltext = 'Other'(017).
*  it_fieldcat-tooltip = 'Other costs'(018).
*  it_fieldcat-fix_column = 'X'.
*  it_fieldcat-emphasize = 'X'.
*  APPEND it_fieldcat.

* Fieldname: Currency
  it_fieldcat-fieldname = 'WAERS'.
  it_fieldcat-outputlen = 10.
  it_fieldcat-coltext = 'Currency'(019).
  it_fieldcat-tooltip = 'currency'(020).
  it_fieldcat-fix_column = 'X'.
  it_fieldcat-emphasize = 'X'.
  APPEND it_fieldcat.

ENDFORM.                    "build_field_catalog_0200


************************************************************************
* Form BCD_ADD_SCREEN                                                  *
************************************************************************
*   arguments:                                                         *
*            P_PROGRAM           Program code of transaction           *
*            P_DYNPRO            Screen number                         *
************************************************************************
FORM bdc_add_screen USING p_program p_dynpro.
  CLEAR it_bdcdata.
  it_bdcdata-program  = p_program.
  it_bdcdata-dynpro   = p_dynpro.
  it_bdcdata-dynbegin = 'X'.
  APPEND it_bdcdata.
ENDFORM.    " BDC_ADD_SCREEN


************************************************************************
* Form BCD_ADD_FIELD                                                   *
************************************************************************
*   arguments:                                                         *
*            P_FNAM              Field name                            *
*            P_FVAL              Value                                 *
************************************************************************
FORM bdc_add_field USING p_fnam p_fval.
  IF p_fval <> '/'.
    CLEAR it_bdcdata.
    it_bdcdata-fnam = p_fnam.
    it_bdcdata-fval = p_fval.
    APPEND it_bdcdata.
  ENDIF.
ENDFORM.    " BDC_ADD_FIELD


*&---------------------------------------------------------------------*
*&      Form  Check_Authorization
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_authorization.

  DATA: it_t001k TYPE STANDARD TABLE OF t001k WITH HEADER LINE.

* Get the plants for this company code.
  SELECT * FROM  t001k
      INTO TABLE it_t001k
     WHERE bukrs = p_bukrs.

  LOOP AT it_t001k.
    AUTHORITY-CHECK OBJECT 'I_SWERK'
             ID 'TCD' DUMMY
             ID 'SWERK' FIELD it_t001k-bwkey.

    IF sy-subrc = 4.
*   No authorisation to display data from Sales Organisation p_vkorg
     MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '008' WITH p_bukrs.
      EXIT.
    ELSEIF sy-subrc <> 0.
*   Error checking authorization.
      MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " Check_Authorization

*Text symbol text
*001:Revenue
*002:Depreciation
*003:Service
*004:Other
*005:Period
*006:Fiscal period
*007:Cost type
*008:Cost denominator
*009:Equipment
*010:Equipment number
*011:Revenue
*012:Revenue
*013:Depreciation
*014:Depreciation costs
*015:Service
*016:Service costs
*017:Other
*018:Other costs
*019:Currency
*020:currency
*S01:Options
*T01:Unassigned
*T02:Total
*T03:Op. Gross Profit

*T04:Percentile OGP
*Selection text
*P_BUKRS:        Company code
*P_END:        End date
*P_GJAHR:        Fiscal year
*P_START:        Start date
*P_VKBUR:        Sales off (depot)
*P_VKORG:        Sales organisation
