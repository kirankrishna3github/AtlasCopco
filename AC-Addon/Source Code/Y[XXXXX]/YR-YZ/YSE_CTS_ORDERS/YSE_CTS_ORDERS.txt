*&---------------------------------------------------------------------*
*& Report  YSE_CTS_ORDERS
*&
*& Author:   Johnny Wu
*& Date:  10/29/2012
*&---------------------------------------------------------------------*
*&
*& Description: OR/OI detail report for CTS parts and service
*& CR#: 2651
*& Transaction Code: YSE_CTS_OR
*&
*&---------------------------------------------------------------------*
*& Request No  Date    Programmer  Revision
*&---------------------------------------------------------------------*
*& CD1K973658 10/29/12 SSCJWU      Initial transport                   *
*&
*&---------------------------------------------------------------------*

report yse_cts_orders no standard page heading
                                    line-size 400.

*----------------------------------------------------------------------*
*                            TABLES                                    *
*----------------------------------------------------------------------*
type-pools: slis.
tables: vbak, vbap, vbkd, ce11000, adrc, kna1, rihea, t2501, t005u,
        tvkbt.

*----------------------------------------------------------------------*
*                            CONSTANTS                                 *
*----------------------------------------------------------------------*
constants: gc_ic1         like sy-ucomm value '&IC1',
           gc_x(1)        type c value 'X'.

*----------------------------------------------------------------------*
*                            VARIABLES                                 *
*----------------------------------------------------------------------*
data: begin of gt_vbak occurs 0,
  vbeln     like vbak-vbeln,
  kunnr     like vbak-kunnr,
*  cmwae     like vbak-cmwae,
  vkgrp     like vbak-vkgrp,
  vkorg     like vbak-vkorg,
  vtweg     like vbak-vtweg,
  spart     like vbak-spart,

  name1     like kna1-name1,
  bran1     like kna1-bran1,

  region    like adrc-region,
  country   like adrc-country,
  end of gt_vbak.

data: begin of gt_vbap occurs 0,
  vbeln     like vbap-vbeln,
  posnr     like vbap-posnr,
  objnr     like vbap-objnr,
*  kunnr     like vbak-kunnr,
*  cmwae     like vbak-cmwae,
*  vkgrp     like vbak-vkgrp,
*  vkorg     like vbak-vkorg,
*  vtweg     like vbak-vtweg,
*  spart     like vbak-spart,
*
*  name1     like kna1-name1,
*  bran1     like kna1-bran1,
*
*  region    like adrc-region,
*  country   like adrc-country,
  end of gt_vbap.


data: begin of gt_final occurs 0,
  kaufn         like ce11000-kaufn,"Sales Doc.
  kdpos         like ce11000-kdpos,"Item
  name1         like kna1-name1,"Customer Name
  ww003         like ce11000-ww003,"Acc.Indic.
  ww006         like ce11000-ww006,"GAC
  vtweg         like ce11000-vtweg,"Distr. Chl
*  cmwae         like vbak-cmwae,"Currency
*  frwae         like ce11000-frwae,"Currency
  rec_waers         like ce11000-rec_waers,"Currency
  sttxt         type j_stext,"SysStatus
  matkl         like ce11000-matkl,"Matl Group
  vkbur_txt     like tvkbt-bezei,"Sales Office Text
  vkgrp         like vbak-vkgrp,"Sales Grp
  vkgrp_txt     like tvgrt-bezei, " Sales group(Text)
  segment       like fagl_segm-segment, "Segment
  segment_txt   like fagl_segmt-name, "Segment (Text)
  vkorg         like ce11000-vkorg,"Sales Org.
  vkorg_txt     like tvkot-vtext,"Sales Org.(Text)
  region        like adrc-region,"  Region
  region_txt    like t005u-bezei,"bezei20,"Region (Text)
  ww008         like ce11000-ww008,"District
  ww008_txt     like t171t-bztxt,"Sales district(Text)
  vkbur         like ce11000-vkbur,"Sales Off.
  bran1         like kna1-bran1,"Customer Industrial Code
  bran1_txt     like tbrct-vtext,"Customer Ind.Code(Text)
  kdgrp         like knvv-kdgrp,"Cust.group
  kdgrp_txt     like t151t-ktext," Customer group(Text)
  kndnr         like ce11000-kndnr,"Customer
  spart         like ce11000-spart,"Division
  ww002         like ce11000-ww002, "PLC
  ww002_txt     like t25a1-bezek, "PLC text
  ww006_txt     like t25a3-bezek,"GAC(Text)
  ww007         like ce11000-ww007,"PGC
  ww007_txt     like t25a4-bezek,"PGC(Text)
  werks         like ce11000-werks,"Plant
  werks_txt     like t001w-name1,"Plant(Text)
  equnr         like ce11000-equnr,"Equipment
  equn_txt      like eqkt-eqktx,"Equipment description
  ww005         like ce11000-ww005,"SalesDocTy
  artnr         like ce11000-artnr,"Product
  artnr_txt     like makt-maktx,"Product description
  cont_type(32)   type c,"Contract Type
  net_inv_sls(15) type p decimals 2,"Net invoiced sales Actual
  budat         like ce11000-budat,"Pstg date
*  tot_vv200     type rke2_vv200,"Parts Actual
*  tot_vv300     type rke2_vv300,"Labour Actual
*  tot_vv600     type rke2_vv600,"Ad Hoc Expenses Actual
*  tot_vv500     type rke2_vv500,"Subcontracting Actual
*  tot_vv400     type rke2_vv400,"Mileage Actual
*  tot_vv114     type rke2_vv114,"Fix price accruals Actual
*  unadj_cogs(15)  type p decimals 2,"Unadjusted COGS Actual
*  unadj_gp(15)    type p decimals 2,"Unadjusted Gross Profit Actual
*  tot_vv100     type rke2_vv100,"Revenues Actual
*  tot_vv110     type rke2_vv110,"Discount
*  tot_vv130     type rke2_vv130,"Unadjusted COS Actual
*  %ugp(3)         type p decimals 2,"% UGP Actual
  selected,
  end of gt_final.

data: gv_stai1_lines like sy-tabix.
data: gv_stae1_lines like sy-tabix.

data: g_incl(1) type c,
      g_excl(1) type c.

data: begin of h_status_tab occurs 20.
        include structure jstat.
data: end of h_status_tab.

data: begin of h_status_text_tab occurs 20,
        txt04 like tj02t-txt04.
data: end of h_status_text_tab.

data: begin of gt_stai1 occurs 0,
        low(4) type c,
      end of gt_stai1.

data: begin of gt_stae1 occurs 0,
        low(4) type c,
      end of gt_stae1.

data: gt_fieldcat          type slis_t_fieldcat_alv,
      gt_events_tab        type slis_t_event.
*----------------------------------------------------------------------*
*                          SELECTION SCREEN VARIABLES                  *
*----------------------------------------------------------------------*
selection-screen: begin of block b1 with frame title text-001.
select-options: s_vkorg  for vbak-vkorg obligatory memory id vko no intervals.
select-options: s_vbeln  for  vbak-vbeln matchcode object vmva,
                s_posnr  for  vbap-posnr,
                s_perio  for  ce11000-perio obligatory,
                s_bzirk  for  vbkd-bzirk,
                s_vkbur  for  vbak-vkbur,
                s_vkgrp  for  vbak-vkgrp,
                s_kunnr  for  vbak-kunnr,
                s_region for  adrc-region,
                s_kdgrp  for  vbkd-kdgrp,
                s_bran1  for  kna1-bran1,
                s_prctr  for  ce11000-prctr,
                s_plc    for  ce11000-ww002 obligatory,
                s_gac    for  ce11000-ww006,
                s_pgc    for  ce11000-ww007,
                s_equnr  for  ce11000-equnr,
                s_matkl  for  vbap-matkl,
                s_matnr  for  vbap-matnr.
select-options:
  s_stai1 for rihea-i_estatin matchcode object i_status no intervals,
  s_stae1 for rihea-i_estatex matchcode object i_status no intervals.
selection-screen: end of block b1.

*----------------------------------------------------------------------*
*                          Include programs                            *
*----------------------------------------------------------------------*


*----------------------------------------------------------------------*
*                          Initialization                              *
*----------------------------------------------------------------------*
initialization.

*----------------------------------------------------------------------*
*                          Selection screen validations                *
*----------------------------------------------------------------------*
at selection-screen.

*----------------------------------------------------------------------*
*                          Top of Page for basic list
*----------------------------------------------------------------------*
top-of-page.

*----------------------------------------------------------------------*
*                          main program                                *
*----------------------------------------------------------------------*
start-of-selection.
  perform get_sdi_status.

  perform get_data.

end-of-selection.
  if gt_final[] is initial.
    write: / text-i01.              "No orders selected
    exit.
  else.
    perform display_data.
  endif.
*&---------------------------------------------------------------------*
*&      Form  get_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
form get_data .
  data: ls_ce11000 type ce11000,
        lt_ce11000  type table of ce11000,
        ls_vbap     type vbap,
        ls_vbkd     type vbkd,
        ls_kna1     type kna1,
        ls_adrc     type adrc,
        lv_tabix    type sy-tabix.

  select vbeln kunnr vkgrp vkorg vtweg spart
    into corresponding fields of table gt_vbak
    from vbak
    where
          vbak~vkorg in s_vkorg
      and vbak~vbeln in s_vbeln
      and vbak~vkbur in s_vkbur
      and vbak~vkgrp in s_vkgrp
      and vbak~kunnr in s_kunnr.

  loop at gt_vbak.
    "Check the customer
    select single * into ls_kna1
         from kna1 where kunnr = gt_vbak-kunnr
                     and bran1 in s_bran1.
    if sy-subrc <> 0 .
      delete gt_vbak.
      continue.
    else.
      gt_vbak-name1 =  ls_kna1-name1.
      gt_vbak-bran1 = ls_kna1-bran1.
    endif.

    "Check the address
    select single *
       into ls_adrc
       from adrc where addrnumber eq ls_kna1-adrnr
                   and date_from  eq '00010101'
                   and region     in s_region.
    if sy-subrc <> 0.
      delete gt_vbak.
      continue.
    else.
      gt_vbak-region = ls_adrc-region.
      gt_vbak-country = ls_adrc-country.
    endif.
    modify gt_vbak transporting name1 bran1 region country.
  endloop.


  if gt_vbak[] is not initial.
    sort gt_vbak by vbeln.

    "Parts and service
    select * from ce11000 into table lt_ce11000
      for all entries in gt_vbak
      where vrgar in ('A', 'F', 'B', 'C')
      and kaufn = gt_vbak-vbeln
      and kdpos in s_posnr
*      and kdpos = gt_vbap-posnr
      and matkl in s_matkl
      and paledger = '02'"Currency type 10
      and vtweg in ('01', '11')
      and perio in s_perio
      and prctr in s_prctr
      and ww002 in s_plc
      and ww006 in s_gac
      and ww007 in s_pgc
      and equnr in s_equnr.
  endif.

  loop at lt_ce11000 into ls_ce11000.
    lv_tabix = sy-tabix.
    case ls_ce11000-vrgar. "A/01 Combination
      when 'A'.
        if ls_ce11000-vtweg <> '01'.
          delete lt_ce11000 index lv_tabix.
          continue.
        endif.
      when 'F' or 'B' or 'C'. "F/11, B/11, C/11 Combination
        if ls_ce11000-vtweg <> '11'.
          delete lt_ce11000 index lv_tabix.
          continue.
        endif.
      when others.
    endcase.

    "Check VBAP.
    clear: ls_vbap.
    select single * from vbap into ls_vbap
      where vbeln = ls_ce11000-kaufn
        and posnr = ls_ce11000-kdpos.

    if sy-subrc = 0 .
      if ls_vbap-matnr not in s_matnr.
        delete lt_ce11000 index lv_tabix.
        continue.
      else.
*.. check status inclusive / exlusive
        if not ( gv_stai1_lines is initial
            and gv_stae1_lines is initial ) .
          perform check_statusses using ls_vbap-objnr.
          if not gv_stai1_lines is initial and g_incl = ' '.
            delete lt_ce11000 index lv_tabix.
            continue.
          elseif not gv_stae1_lines is initial and g_excl = 'X'.
            delete lt_ce11000 index lv_tabix.
            continue.
          endif.
        endif.

      endif.
      gt_vbap-vbeln = ls_vbap-vbeln.
      gt_vbap-posnr = ls_vbap-posnr.
      gt_vbap-objnr = ls_vbap-objnr.
      append gt_vbap.
    endif.

    "Check VBKD
    clear: ls_vbkd.
    select single * from vbkd into ls_vbkd
                  where vbeln = ls_ce11000-kaufn
                    and posnr = ls_ce11000-kdpos.
    if sy-subrc <> 0 .
      select single * from vbkd into ls_vbkd
                  where vbeln = ls_ce11000-kaufn
                    and posnr = ''.
    endif.

    if ls_vbkd is not initial.
      if not ( ls_vbkd-bzirk in s_bzirk and ls_vbkd-kdgrp in s_kdgrp ).
        delete lt_ce11000 index lv_tabix.
      endif.
    endif.
  endloop.

  sort gt_vbap by vbeln posnr.

  loop at lt_ce11000 into ls_ce11000.
    clear: gt_final, gt_vbak, gt_vbap.
    read table gt_vbak with key vbeln = ls_ce11000-kaufn binary search.
    read table gt_vbap with key vbeln = ls_ce11000-kaufn
                                posnr = ls_ce11000-kdpos binary search.
*kaufn         like ce11000-kaufn,"Sales Doc.
    gt_final-kaufn = ls_ce11000-kaufn.
*  kdpos         like ce11000-kdpos,"Item
    gt_final-kdpos = ls_ce11000-kdpos.
*  name1         like kna1-name1,"Customer Name
    gt_final-name1 = gt_vbak-name1.
*  ww003         like ce11000-ww003,"Acc.Indic.
    gt_final-ww003 = ls_ce11000-ww003.
*  ww006         like ce11000-ww006,"GAC
    gt_final-ww006 = ls_ce11000-ww006.
*  vtweg         like ce11000-vtweg,"Distr. Chl
    gt_final-vtweg = ls_ce11000-vtweg.
*  cmwae         like vbak-cmwae,"Currency
*    gt_final-cmwae = gt_vbak-cmwae.
*    gt_final-frwae = ls_ce11000-frwae.
    gt_final-REC_WAERS = ls_ce11000-REC_WAERS.
**  SysStatus
*.. Get SysStatus
    if gt_vbap-objnr is not initial.
      call function 'STATUS_TEXT_EDIT'
        exporting
          flg_user_stat    = 'X'
          objnr            = gt_vbap-objnr"gt_final-objnr
          only_active      = 'X'
          spras            = sy-langu
        importing
          line             = gt_final-sttxt
        exceptions
          object_not_found = 1
          others           = 2.
    endif.

*  matkl         like ce11000-matkl,"Matl Group
    gt_final-matkl = ls_ce11000-matkl.
*  vkbur_txt     like tvkbt-bezei,"Sales Office Text
    select single bezei into gt_final-vkbur_txt from tvkbt
      where spras = sy-langu and vkbur = ls_ce11000-vkbur."gt_final-vkbur.
*  vkgrp         like vbak-vkgrp,"Sales Grp
    gt_final-vkgrp = gt_vbak-vkgrp.
*  vkgrp_txt     like tvgrt-bezei, " Sales group(Text)
    select single bezei into gt_final-vkgrp_txt from tvgrt
        where spras = sy-langu and vkgrp = gt_final-vkgrp.
*  segment       like fagl_segm-segment, "Segment
    select single segment  into gt_final-segment from yse_prctr_bl
      where prctr = ls_ce11000-prctr.
*  segment_txt   like fagl_segmt-name, "Segment (Text)
    select single name into gt_final-segment_txt from fagl_segmt
      where langu = sy-langu and segment = gt_final-segment.
*  vkorg         like ce11000-vkorg,"Sales Org.
    gt_final-vkorg = ls_ce11000-vkorg.
*  vkorg_txt     like tvkot-vtext,"Sales Org.(Text)
    select single vtext into gt_final-vkorg_txt from tvkot
        where spras = sy-langu and vkorg = gt_final-vkorg.
*  region        like adrc-region,"  Region
    gt_final-region = gt_vbak-region.
*  region_txt    like t005u-bezei,"bezei20,"Region (Text)
    select single bezei into gt_final-region_txt from t005u
      where spras = sy-langu and land1 = gt_vbak-country
        and bland = gt_final-region.
*  ww008         like ce11000-ww008,"District
    gt_final-ww008 = ls_ce11000-ww008.
*  ww008_txt     like t171t-bztxt,"Sales district(Text)
    select single bztxt into gt_final-ww008_txt from t171t
        where spras = sy-langu and bzirk = gt_final-ww008.
*  vkbur         like ce11000-vkbur,"Sales Off.
    gt_final-vkbur = ls_ce11000-vkbur.
*  bran1         like kna1-bran1,"Customer Industrial Code
    gt_final-bran1 = gt_vbak-bran1.
*  bran1_txt     like tbrct-vtext,"Customer Ind.Code(Text)
    select single vtext into gt_final-bran1_txt from tbrct
        where spras = sy-langu and braco = gt_final-bran1.
*  kdgrp         like knvv-kdgrp,"Cust.group
    select single kdgrp into gt_final-kdgrp from knvv
      where kunnr = gt_vbak-kunnr and vkorg = gt_vbak-vkorg
        and vtweg = gt_vbak-vtweg and spart = gt_vbak-spart.
*  kdgrp_txt     like t151t-ktext," Customer group(Text)
    select single ktext into gt_final-kdgrp_txt from t151t
      where spras = sy-langu and kdgrp = gt_final-kdgrp.
*  kndnr         like ce11000-kndnr,"Customer
    gt_final-kndnr = ls_ce11000-kndnr.
*  spart         like ce11000-spart,"Division
    gt_final-spart = ls_ce11000-spart.
*  ww002         like ce11000-ww002, "PLC
    gt_final-ww002 = ls_ce11000-ww002.
*  ww002_txt     like t25a1-bezek, "PLC text
    select single bezek into gt_final-ww002_txt from t25a1
      where spras = sy-langu and ww002 = gt_final-ww002.
*  ww006_txt     like t25a3-bezek,"GAC(Text)
    select single bezek into gt_final-ww006_txt from t25a3
      where spras = sy-langu and ww006 = gt_final-ww006.
*  ww007         like ce11000-ww007,"PGC
    gt_final-ww007 = ls_ce11000-ww007.
*  ww007_txt     like t25a4-bezek,"PGC(Text)
    select single bezek into gt_final-ww007_txt from t25a4
      where spras = sy-langu and ww007 = gt_final-ww007.
*  werks         like ce11000-werks,"Plant
    gt_final-werks = ls_ce11000-werks.
*  werks_txt     like t001w-name1,"Plant(Text)
    select single name1 into gt_final-werks_txt from t001w
      where werks = gt_final-werks.
*  equnr         like ce11000-equnr,"Equipment
    gt_final-equnr = ls_ce11000-equnr.
*  equn_txt      like eqkt-eqktx,"Equipment description
    select single eqktx into gt_final-equn_txt from eqkt
      where equnr = gt_final-equnr and spras = sy-langu.
*  ww005         like ce11000-ww005,"SalesDocTy
    gt_final-ww005 = ls_ce11000-ww005.
*  artnr         like ce11000-artnr,"Product
    gt_final-artnr = ls_ce11000-artnr.
*  artnr_txt     like makt-maktx,"Product description
    select single maktx into gt_final-artnr_txt from makt
      where matnr = gt_final-artnr and spras = sy-langu.
*  cont_type(32)   type c,"Contract Type
    case gt_final-matkl+4(2).
      when 'TR'.
        gt_final-cont_type = '* Total_Responsibity'.
      when 'PM'.
        gt_final-cont_type = '* Preventive_Maintenance'.
      when 'IP'.
        gt_final-cont_type = '* Inspection'.
      when 'CC'.
        gt_final-cont_type = '* Cover_Care'.
      when 'PP'.
        gt_final-cont_type = '* Parts_Only'.
      when 'XT'.
        gt_final-cont_type = '* AirExtend'.
      when '044Z'.
        gt_final-cont_type = '** Other_Contract_Type'.
      when others.
        gt_final-cont_type = ''.
    endcase.
*  net_inv_sls(15) type p decimals 2,"Net invoiced sales Actual
    gt_final-net_inv_sls = ls_ce11000-vv100 + ls_ce11000-vv110.
*  budat         like ce11000-budat,"Pstg date
    gt_final-budat = ls_ce11000-budat.
**  tot_vv200     type rke2_vv200,"Parts Actual
*    gt_final-tot_vv200 = ls_ce11000-vv200.
**  tot_vv300     type rke2_vv300,"Labour Actual
*    gt_final-tot_vv300 = ls_ce11000-vv300.
**  tot_vv600     type rke2_vv600,"Ad Hoc Expenses Actual
*    gt_final-tot_vv600 = ls_ce11000-vv600.
**  tot_vv500     type rke2_vv500,"Subcontracting Actual
*    gt_final-tot_vv500 = ls_ce11000-vv500.
**  tot_vv400     type rke2_vv400,"Mileage Actual
*    gt_final-tot_vv400 = ls_ce11000-vv400.
**  tot_vv114     type rke2_vv114,"Fix price accruals Actual
*    gt_final-tot_vv114 = ls_ce11000-vv114.
**  unadj_cogs(15)  type p decimals 2,"Unadjusted COGS Actual
*    gt_final-unadj_cogs = ls_ce11000-vv200 + ls_ce11000-vv300 +
*           ls_ce11000-vv400 + ls_ce11000-vv500 + ls_ce11000-vv600 +
*           ls_ce11000-vv112 + ls_ce11000-vv114 + ls_ce11000-vv130 +
*           ls_ce11000-vv140 + ls_ce11000-vv150.
*
**  unadj_gp(15)    type p decimals 2,"Unadjusted Gross Profit Actual
*    gt_final-unadj_gp = gt_final-net_inv_sls - gt_final-unadj_cogs.
**  tot_vv100     type rke2_vv100,"Revenues Actual
*    gt_final-tot_vv100 = ls_ce11000-vv100.
**  tot_vv110     type rke2_vv110,"Discount
*    gt_final-tot_vv110 = ls_ce11000-vv110.
**  tot_vv130     type rke2_vv130,"Unadjusted COS Actual
*    gt_final-tot_vv130 = ls_ce11000-vv130.
**  %ugp(3)         type p decimals 2,"% UGP Actual
*    if not gt_final-net_inv_sls is initial.
*      gt_final-%ugp = 100 * gt_final-unadj_gp / gt_final-net_inv_sls.
*    endif.
    append gt_final.
  endloop.
endform.                    " get_data
*&---------------------------------------------------------------------*
*&      Form  display_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form display_data.
  data: lv_repid type sy-repid.

  perform build_field_catlog.
  perform fill_events_f14.

  lv_repid = sy-repid.

  call function 'REUSE_ALV_GRID_DISPLAY'
     exporting
       i_callback_program                =  lv_repid
       i_save                            = 'A'
       it_events                         =  gt_events_tab[]
*      I_GRID_TITLE                      =
*      I_GRID_SETTINGS                   =
*      is_layout                         =  g_layout
       it_fieldcat                       =  gt_fieldcat[]
     tables
        t_outtab                         =  gt_final.

endform.                    "display_data
*&---------------------------------------------------------------------*
*&      Form  build_field_catlog
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form build_field_catlog.
  data : ls_fcat type slis_fieldcat_alv.

*  kaufn         like ce11000-kaufn,"Sales Doc.
  ls_fcat-fieldname = 'KAUFN'.
  ls_fcat-rollname = 'VBELN'.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero    = 'X'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  kdpos         like ce11000-kdpos,"Item
  ls_fcat-fieldname = 'KDPOS'.
  ls_fcat-rollname = 'POSNR_VA'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  name1         like kna1-name1,"Customer Name
  ls_fcat-fieldname = 'NAME1'.
  ls_fcat-rollname = 'NAME1_GP'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww003         like ce11000-ww003,"Acc.Indic.
  ls_fcat-fieldname = 'WW003'.
  ls_fcat-rollname = 'RKEG_WW003'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww006         like ce11000-ww006,"GAC
  ls_fcat-fieldname = 'WW006'.
  ls_fcat-rollname = 'RKEG_WW006'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.
*  vtweg         like ce11000-vtweg,"Distr. Chl
  ls_fcat-fieldname = 'VTWEG'.
  ls_fcat-rollname = 'VTWEG'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  cmwae         like vbak-cmwae,"Currency
  ls_fcat-fieldname = 'REC_WAERS'.
  ls_fcat-rollname = 'REC_WAERS'.
  ls_fcat-seltext_s = 'Currency'.
  ls_fcat-seltext_m = 'Currency'.
  ls_fcat-seltext_l = 'Currency'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.


*  sttxt         type j_stext,"SysStatus
  ls_fcat-fieldname = 'STTXT'.
  ls_fcat-rollname = 'J_STEXT'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  matkl         like ce11000-matkl,"Matl Group
  ls_fcat-fieldname = 'MATKL'.
  ls_fcat-rollname = 'MATKL'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  vkbur_txt     like tvkbt-bezei,"Sales Office Text
  ls_fcat-fieldname = 'VKBUR_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales office(Text)'(i15).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  vkgrp         like vbak-vkgrp,"Sales Grp
  ls_fcat-fieldname = 'VKGRP'.
  ls_fcat-rollname = 'VKGRP'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  vkgrp_txt     like tvgrt-bezei, " Sales group(Text)
  ls_fcat-fieldname = 'VKGRP_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales group(Text)'(i55).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  segment       like fagl_segm-segment, "Segment
  ls_fcat-fieldname = 'SEGMENT'.
  ls_fcat-rollname = 'FB_SEGMENT'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  segment_txt   like fagl_segmt-name, "Segment (Text)
  ls_fcat-fieldname = 'SEGMENT_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Segment (Text)'(i52).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  vkorg         like ce11000-vkorg,"Sales Org.
  ls_fcat-fieldname = 'VKORG'.
  ls_fcat-rollname = 'VKORG'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  vkorg_txt     like tvkot-vtext,"Sales Org.(Text)
  ls_fcat-fieldname = 'VKORG_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales Org.(Text)'(i12).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  region        like adrc-region,"  Region
  ls_fcat-fieldname = 'REGION'.
  ls_fcat-rollname = 'REGIO'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  region_txt    like t005u-bezei,"bezei20,"Region (Text)
  ls_fcat-fieldname = 'REGION_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Region (Text)'(i13).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww008         like ce11000-ww008,"District
  ls_fcat-fieldname = 'WW008'.
  ls_fcat-rollname = 'BZIRK'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww008_txt     like t171t-bztxt,"Sales district(Text)
  ls_fcat-fieldname = 'WW008_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Sales district(Text)'(i14).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  vkbur         like ce11000-vkbur,"Sales Off.
  ls_fcat-fieldname = 'VKBUR'.
  ls_fcat-rollname = 'VKBUR'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  bran1         like kna1-bran1,"Customer Industrial Code
  ls_fcat-fieldname = 'BRAN1'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer Industrial Code'(i16).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  bran1_txt     like tbrct-vtext,"Customer Ind.Code(Text)
  ls_fcat-fieldname = 'BRAN1_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer Ind.Code(Text)'(i17).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  kdgrp         like knvv-kdgrp,"Cust.group
  ls_fcat-fieldname = 'KDGRP'.
  ls_fcat-rollname = 'KDGRP'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  kdgrp_txt     like t151t-ktext," Customer group(Text)
  ls_fcat-fieldname = 'KDGRP_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Customer group(Text)'(i18).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  kndnr         like ce11000-kndnr,"Customer
  ls_fcat-fieldname = 'KNDNR'.
  ls_fcat-rollname = 'KUNDE_PA'.
  ls_fcat-no_convext = 'X'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  spart         like ce11000-spart,"Division
  ls_fcat-fieldname = 'SPART'.
  ls_fcat-rollname = 'SPART'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww002         like ce11000-ww002, "PLC
  ls_fcat-fieldname = 'WW002'.
  ls_fcat-rollname = 'RKEG_WW002'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww002_txt     like t25a1-bezek, "PLC text
  ls_fcat-fieldname = 'WW002_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'PLC(Text)'(i20).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww006_txt     like t25a3-bezek,"GAC(Text)
  ls_fcat-fieldname = 'WW006_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'GAC(Text)'(i21).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww007         like ce11000-ww007,"PGC
  ls_fcat-fieldname = 'WW007'.
  ls_fcat-rollname = 'RKEG_WW007'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww007_txt     like t25a4-bezek,"PGC(Text)
  ls_fcat-fieldname = 'WW007_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'PGC(Text)'(i22).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  werks         like ce11000-werks,"Plant
  ls_fcat-fieldname = 'WERKS'.
  ls_fcat-rollname = 'WERKS_D'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  werks_txt     like t001w-name1,"Plant(Text)
  ls_fcat-fieldname = 'WERKS_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Plant(Text)'(i23).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  equnr         like ce11000-equnr,"Equipment
  ls_fcat-fieldname = 'EQUNR'.
  ls_fcat-rollname = 'EQUNR'.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero = 'X'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  equn_txt      like eqkt-eqktx,"Equipment description
  ls_fcat-fieldname = 'EQUN_TXT'.
  ls_fcat-outputlen = '40'.
  ls_fcat-seltext_l = 'Equipment description'(i24).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  ww005         like ce11000-ww005,"SalesDocTy
  ls_fcat-fieldname = 'WW005'.
  ls_fcat-rollname = 'AUART'.
  ls_fcat-no_convext = 'X'.
  ls_fcat-no_zero = 'X'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  artnr         like ce11000-artnr,"Product
  ls_fcat-fieldname = 'ARTNR'.
  ls_fcat-outputlen = '10'.
  ls_fcat-seltext_l = 'Product'(i29).
  ls_fcat-no_zero   = 'X'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  artnr_txt     like makt-maktx,"Product description
  ls_fcat-fieldname = 'ARTNR_TXT'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Product description'(i30).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  cont_type(32)   type c,"Contract Type
  ls_fcat-fieldname = 'CONT_TYPE'.
  ls_fcat-outputlen = '32'.
  ls_fcat-seltext_l = 'Contract Type'(i56).
  ls_fcat-no_sum    = 'X'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  net_inv_sls(15) type p decimals 2,"Net invoiced sales Actual
  ls_fcat-fieldname = 'NET_INV_SLS'.
  ls_fcat-outputlen = '15'.
  ls_fcat-seltext_l = 'Net invoiced sales Actual'(i33).
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

*  budat         like ce11000-budat,"Pstg date
  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-rollname = 'DAERF'.
  append ls_fcat to gt_fieldcat.
  clear ls_fcat.

**  tot_vv200     type rke2_vv200,"Parts Actual
*  ls_fcat-fieldname = 'TOT_VV200'.
*  ls_fcat-outputlen = '10'.
*  ls_fcat-seltext_l = 'Parts Actual'(i35).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv300     type rke2_vv300,"Labour Actual
*  ls_fcat-fieldname = 'TOT_VV300'.
*  ls_fcat-outputlen = '10'.
*  ls_fcat-seltext_l = 'Labour Actual'(i36).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv600     type rke2_vv600,"Ad Hoc Expenses Actual
*  ls_fcat-fieldname = 'TOT_VV600'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Ad Hoc Expenses Actual'(i38).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv500     type rke2_vv500,"Subcontracting Actual
*  ls_fcat-fieldname = 'TOT_VV500'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Subcontracting Actual'(i39).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv400     type rke2_vv400,"Mileage Actual
*  ls_fcat-fieldname = 'TOT_VV400'.
*  ls_fcat-outputlen = '10'.
*  ls_fcat-seltext_l = 'Mileage Actual'(i37).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv114     type rke2_vv114,"Fix price accruals Actual
*  ls_fcat-fieldname = 'TOT_VV114'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Fix price accruals Actual'(i41).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  unadj_cogs(15)  type p decimals 2,"Unadjusted COGS Actual
*  ls_fcat-fieldname = 'UNADJ_COGS'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Unadjusted COGS Actual'(i42).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  unadj_gp(15)    type p decimals 2,"Unadjusted Gross Profit Actual
*  ls_fcat-fieldname = 'UNADJ_GP'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Unadjusted Gross Profit Actual'(i43).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv100     type rke2_vv100,"Revenues Actual
*  ls_fcat-fieldname = 'TOT_VV100'.
*  ls_fcat-outputlen = '10'.
*  ls_fcat-seltext_l = 'Revenues Actual'(i31).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv110     type rke2_vv110,"Discount
*  ls_fcat-fieldname = 'TOT_VV110'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Discount'(i32).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  tot_vv130     type rke2_vv130,"Unadjusted COS Actual
*  ls_fcat-fieldname = 'TOT_VV130'.
*  ls_fcat-outputlen = '15'.
*  ls_fcat-seltext_l = 'Unadjusted COS Actual'(i34).
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.
*
**  %ugp(3)         type p decimals 2,"% UGP Actual
*  ls_fcat-fieldname = '%UGP'.
*  ls_fcat-outputlen = '10'.
*  ls_fcat-seltext_l = '% UGP Actual'(i44).
*  ls_fcat-no_sum    = 'X'.
*  append ls_fcat to gt_fieldcat.
*  clear ls_fcat.

endform.                    "build_field_catlog
*&---------------------------------------------------------------------*
*&      Form  fill_events_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
form fill_events_f14 .

  data lv_event       type slis_alv_event.

  call function 'REUSE_ALV_EVENTS_GET'
    exporting
      i_list_type = 0
    importing
      et_events   = gt_events_tab.

*--- allocate form for user-command ---------------------------------*
  read table gt_events_tab with key name = slis_ev_user_command
                        into lv_event.
  if sy-subrc = 0.
*    move gv_form_user_command to lv_event-form.
    lv_event-form = 'USER_COMMAND_L'.
    modify gt_events_tab from lv_event index sy-tabix.
  endif.

endform.                    " fill_events_f14
*&---------------------------------------------------------------------*
*&      Form  user_command_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
form user_command_l using p_ucomm like sy-ucomm
                          p_selfield type slis_selfield.

  p_selfield-refresh = 'S'.
  perform check_pf2_with_object_f16 using p_ucomm.
  perform set_p_selfield_general_f16 using p_selfield.

  case p_ucomm.
    when 'ISEL'.
      p_ucomm = 'DISP'.
      perform fcodes_with_mark_f16 using p_ucomm p_selfield.
  endcase.

endform.                    "user_command_l
*&---------------------------------------------------------------------*
*&      Form  check_pf2_with_object_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*----------------------------------------------------------------------*
form check_pf2_with_object_f16  using    p_ucomm.

  check p_ucomm = gc_ic1.
  p_ucomm = 'ISEL'.

endform.                    " check_pf2_with_object_f16
*&---------------------------------------------------------------------*
*&      Form  set_p_selfield_general_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_SELFIELD  text
*----------------------------------------------------------------------*
form set_p_selfield_general_f16  using f_selfield type slis_selfield.

  f_selfield-col_stable = gc_x.
  f_selfield-row_stable = gc_x.

endform.                    " set_p_selfield_general_f16
*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_UCOMM  text
*      -->P_P_SELFIELD  text
*      -->P_ENDCASE  text
*----------------------------------------------------------------------*
form fcodes_with_mark_f16  using p_ucomm like sy-ucomm
                                p_selfield type slis_selfield.
  data: lv_index like sy-tabix.

  perform check_object_tab_marked_f14 using p_ucomm p_selfield.

  loop at gt_final where selected = gc_x .
    lv_index = sy-tabix.
    perform fcodes_with_mark_l using p_ucomm p_selfield.
    gt_final-selected = ' '.
    modify gt_final index lv_index.
  endloop.

  clear p_ucomm.

endform.                    " fcodes_with_mark_f16
*&---------------------------------------------------------------------*
*&      Form  check_object_tab_marked_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
form check_object_tab_marked_f14  using    p_ucomm like sy-ucomm
                                        p_selfield type slis_selfield.

  read table gt_final with key selected = gc_x.

  if not sy-subrc is initial.
    if not p_selfield-tabindex is initial.
      read table gt_final index p_selfield-tabindex.
      gt_final-selected = gc_x.
      modify gt_final index p_selfield-tabindex.
    endif.
  else.
*--- Checkbox markiert -----------------------------------------------*
    p_selfield-sel_tab_field = 'G_MARK'.
  endif.

endform.                    "check_object_tab_marked_f14
*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
form fcodes_with_mark_l  using   p_ucomm like sy-ucomm
                              p_selfield type slis_selfield.

  data: h_ucomm like sy-ucomm.

  case p_ucomm.
*   Display Contract
    when 'DISP'.
      set parameter id 'KTN' field gt_final-kaufn.
      call transaction 'VA43' and skip first screen.
  endcase.
endform.                    "fcodes_with_mark_l
*&---------------------------------------------------------------------*
*&      Form  check_statusses
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->R_OBJNR    text
*----------------------------------------------------------------------*
form check_statusses using r_objnr.

  clear: g_excl,
         g_incl.

  refresh: h_status_tab,
           h_status_text_tab.

* get active statusses
  call function 'STATUS_READ'
    exporting
      objnr       = r_objnr
      only_active = 'X'
    tables
      status      = h_status_tab
    exceptions
      others      = 01.

  check sy-subrc = 0.

* get status descriptions
  loop at h_status_tab.
    call function 'STATUS_NUMBER_CONVERSION'
      exporting
        language      = sy-langu
        objnr         = r_objnr
        status_number = h_status_tab-stat
      importing
        txt04         = h_status_text_tab-txt04
      exceptions
        others        = 01.
    if sy-subrc = 0.
      append h_status_text_tab.
    endif.
  endloop.

* check status inclusive
  if not gv_stai1_lines is initial.
    loop at h_status_text_tab.
      loop at gt_stai1.
        if gt_stai1-low = h_status_text_tab-txt04.
          g_incl = 'X'.
          exit.
        endif.
      endloop.
      if g_incl = 'X'.
        exit.
      endif.
    endloop.
  endif.

* check status exclusive
  if not gv_stae1_lines is initial.
    loop at h_status_text_tab.
      loop at gt_stae1.
        if gt_stae1-low = h_status_text_tab-txt04.
          g_excl = 'X'.
          exit.
        endif.
      endloop.
      if g_excl = 'X'.
        exit.
      endif.
    endloop.
  endif.

endform.                    "check_statusses
*&---------------------------------------------------------------------*
*&      Form  get_SDI_status
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GT_VBAP_OBJNR  text
*----------------------------------------------------------------------*
form get_sdi_status.
* Fill status tables
  refresh: gt_stai1,
           gt_stae1.

  loop at s_stai1.
    clear gt_stai1.
    move s_stai1-low to gt_stai1-low.
    append gt_stai1.
  endloop.

  loop at s_stae1.
    clear gt_stae1.
    move s_stae1-low to gt_stae1-low.
    append gt_stae1.
  endloop.

* Number of records in the status-tables
  describe table gt_stai1 lines gv_stai1_lines.
  describe table gt_stae1 lines gv_stae1_lines.
endform.                    " get_SDI_status

*Text symbol text£º
*001:Selection screen input
*I01:No order selected!
*I12:Sales Org.(Text)
*I13:Region (Text)
*I14:Sales district(Text)
*I15:Sales office(Text)
*I16:Customer Industrial Code
*I17:Customer Ind.Code(Text)
*I18:Customer group(Text)
*I20:PLC(Text)
*I21:GAC(Text)
*I22:PGC(Text)
*I23:Plant(Text)
*I24:Equipment description
*I29:Product
*I30:Product description
*I31:Revenues Actual
*I32:Discount
*I33:Net invoiced sales Actual
*I34:Unadjusted COS Actual
*I35:Parts Actual
*I36:Labour Actual
*I37:Mileage Actual
*I38:Ad Hoc Expenses Actual
*I39:Subcontracting Actual
*I41:Fix price accruals Actual
*I42:Unadjusted COGS Actual
*I43:Unadjusted Gross Profit Actual
*I44:% UGP Actual
*I52:Segment (Text)
*I55:Sales group(Text)

*I56:Contract Type
*Selection text£º
*S_BRAN1:        Customer industrial code
*S_BZIRK:D       .
*S_EQUNR:D       .
*S_GAC:D       .
*S_KDGRP:D       .
*S_KUNNR:        Customer
*S_MATKL:D       .
*S_MATNR:        Product
*S_PERIO:D       .
*S_PGC:D       .
*S_PLC:D       .
*S_POSNR:D       .
*S_PRCTR:D       .
*S_REGION:D       .
*S_STAE1:        SDI Status excluded
*S_STAI1:        SDI Status included
*S_VBELN:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
*S_VKORG:D       .
