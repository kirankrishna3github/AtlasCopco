*----------------------------------------------------------------------*
***INCLUDE YSE_RU_FI_ACT_OF_RECON_F01.
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  initialization
*&---------------------------------------------------------------------*
*       Perform the necessary initialization actions
*----------------------------------------------------------------------*
FORM initialization .

*** MOD-001 * begin ***
*  IF p_kunnr IS INITIAL.
*    p_kunnr = p_vendor.
*  ENDIF.
  IF s_kunnr[] IS INITIAL.
    s_kunnr[] = s_vendor[].
  ENDIF.
*** MOD-001 * end ***

ENDFORM.                    " initialization

*eject
*&---------------------------------------------------------------------*
*&      Form  select_bsid
*&---------------------------------------------------------------------*
*       Select the relevant customer documents
*----------------------------------------------------------------------*
FORM select_bsid.

  CLEAR gt_doc[].
  gt_bsid-sal_dmbtr_dc = 0.
*** MOD-001 * begin ***
  gt_bsid-sal_dmbtr_lc = 0.
  gt_bsid-sal_dmbtr_dc_eur = 0.
  gt_bsid-sal_dmbtr_dc_usd = 0.
  gt_bsid-sal_dmbtr_dc_rub = 0.
*** MOD-001 * end ***

************************************************************************
* Opening Balance Bookings
************************************************************************
* Calculate bookings total (opening balance)

  CLEAR: gt_clr_bsad[],
         lv_debit_o,                                        "MOD-001
         lv_credit_o.                                       "MOD-001

*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
*   Debit total bookings (opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_o
           FROM bsid
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat < s_bldat-low
             AND shkzg = 'S'
             AND umskz <> 'F'.      "Exclude Payment Requests

*   Credit total bookings (opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_o
           FROM bsid
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat < s_bldat-low
             AND shkzg = 'H'
            AND umskz <> 'F'.            "Exclude Payment Requests

*   Total clearing bookings (opening balance)
    SELECT bukrs gjahr belnr blart shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsad
           FROM bsad
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND budat < s_bldat-low
             AND umskz <> 'F'.           "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
*   Debit total bookings (opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_o
           FROM bsid
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat < s_bldat-low
             AND shkzg = 'S'
             AND umskz <> 'F'.      "Exclude Payment Requests

*   Credit total bookings (opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_o
           FROM bsid
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat < s_bldat-low
             AND shkzg = 'H'
            AND umskz <> 'F'.            "Exclude Payment Requests

*   Total clearing bookings (opening balance)
    SELECT bukrs gjahr belnr blart shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsad
           FROM bsad
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND bldat < s_bldat-low
             AND umskz <> 'F'.           "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

*** MOD-001 * begin ***
* Get customer lines for clearing documents (AB)
  CLEAR gt_clr_bseg[].
  CLEAR gt_doc[].
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_clr_bsad[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_clr_bsad
           WHERE bukrs =  gt_clr_bsad-bukrs
             AND belnr =  gt_clr_bsad-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_clr_bsad-gjahr
             AND koart =  'D'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_clr_bsad.
    IF gt_clr_bsad-belnr >= '0600000000'  AND
       gt_clr_bsad-belnr <= '0699999999'.
*** MOD-001 * begin ***
*    CLEAR lv_check.
*    LOOP AT gt_doc.
*      IF gt_doc-bukrs = gt_clr_bsad-bukrs  AND
*      gt_doc-gjahr = gt_clr_bsad-gjahr  AND
*      gt_doc-belnr = gt_clr_bsad-belnr.
*        lv_check = 'X'.
*      ENDIF.
*    ENDLOOP.
*
*    IF lv_check <> 'X'.
*        SELECT bukrs belnr gjahr shkzg dmbtr hkont
*               APPENDING CORRESPONDING FIELDS OF TABLE gt_clr_bseg
*               FROM bseg
*               WHERE bukrs = gt_clr_bsad-bukrs
*                 AND belnr = gt_clr_bsad-belnr
*                 AND gjahr = gt_clr_bsad-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_clr_bsad-bukrs
                                       gjahr = gt_clr_bsad-gjahr
                                       belnr = gt_clr_bsad-belnr.
      IF sy-subrc NE 0.
        CLEAR lv_dmbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_clr_bsad-bukrs
                                  AND gjahr = gt_clr_bsad-gjahr
                                  AND belnr = gt_clr_bsad-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_clr_bseg-bukrs = gt_clr_bsad-bukrs.
          gt_clr_bseg-belnr = gt_clr_bsad-belnr.
          gt_clr_bseg-gjahr = gt_clr_bsad-gjahr.
          gt_clr_bseg-dmbtr = ABS( lv_dmbtr ).
          IF lv_dmbtr < 0.
            gt_clr_bseg-shkzg = 'H'.
          ELSE.
            gt_clr_bseg-shkzg = 'S'.
          ENDIF.
          gt_clr_bseg-blart = 'AB'.
          APPEND gt_clr_bseg.
        ENDIF.
*** MOD-001 * end ***
        ws_doc-bukrs = gt_clr_bsad-bukrs.
        ws_doc-gjahr = gt_clr_bsad-gjahr.
        ws_doc-belnr = gt_clr_bsad-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.

    ELSE.
      gt_clr_bseg-bukrs = gt_clr_bsad-bukrs.
      gt_clr_bseg-belnr = gt_clr_bsad-belnr.
      gt_clr_bseg-gjahr = gt_clr_bsad-gjahr.
      gt_clr_bseg-shkzg = gt_clr_bsad-shkzg.
      gt_clr_bseg-dmbtr = gt_clr_bsad-dmbtr.
*      gt_clr_bseg-hkont = ' '.                             "MOD-001
      gt_clr_bseg-blart = gt_clr_bsad-blart.                "MOD-001
      APPEND gt_clr_bseg.
    ENDIF.
  ENDLOOP.

* 6-docs in BSID(concerning exchange rate lines) should be removed
*LOOP AT gt_doc.
*    clear lv_dmbtr.
*    clear lv_shkzg.
*    select single dmbtr shkzg from bsid into (lv_dmbtr, lv_shkzg)
*      where bukrs = gt_doc-bukrs and
*            gjahr = gt_doc-gjahr and
*            belnr = gt_doc-belnr.
*    if lv_shkzg = 'S'.
*      lv_debit_o = lv_debit_o - lv_dmbtr.
*    else.
*      lv_credit_o = lv_credit_o - lv_dmbtr.
*    endif.
*ENDLOOP.

* Add the exchange rate lines of BSAD(with values exchange rate accounts of BSEG)
  LOOP AT gt_clr_bseg.
*** MOD-001 * begin ***
*    IF gt_clr_bseg-hkont = '0007960902'  OR
*       gt_clr_bseg-hkont = '0003960902'.    "BSEG values opposite booked
*    IF gt_clr_bseg-blart = 'AB'.
*      IF gt_clr_bseg-shkzg = 'H'.
*        lv_debit_o = lv_debit_o + gt_clr_bseg-dmbtr.
*      ELSE.
*        lv_credit_o = lv_credit_o + gt_clr_bseg-dmbtr.
*      ENDIF.
*    ELSE.
*** MOD-001 * end ***
    IF gt_clr_bseg-shkzg = 'S'.
      lv_debit_o = lv_debit_o + gt_clr_bseg-dmbtr.
    ELSE.
      lv_credit_o = lv_credit_o + gt_clr_bseg-dmbtr.
    ENDIF.
*    ENDIF.                                                 "MOD-001
  ENDLOOP.
  lv_op_sal = lv_debit_o + ( lv_credit_o * ( -1 ) ).

******* Foreign ********

*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
    SELECT blart belnr bukrs gjahr umskz bldat xref1 xref2
            dmbtr wrbtr shkzg waers budat zuonr kkber
           INTO CORRESPONDING FIELDS OF TABLE gt_bsid_tmp_op
           FROM bsid
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3299999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat < s_bldat-low
             AND umskz <> 'F'.           "Exclude Payment Requests

    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsad_tmp_op
             FROM bsad
             WHERE kunnr IN s_kunnr
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3299999999'
               AND budat < s_bldat-low
               AND umskz <> 'F'.         "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
    SELECT blart belnr bukrs gjahr umskz bldat xref1 xref2 dmbtr wrbtr shkzg waers
           budat zuonr kkber                                "MOD-001
           INTO CORRESPONDING FIELDS OF TABLE gt_bsid_tmp_op
           FROM bsid
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
*** MOD-001 * begin ***
*            Exclude document type 'RD' for foreign opening balance
*             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '3000000000' AND '3299999999'
*** MOD-001 * end ***
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat < s_bldat-low
             AND umskz <> 'F'.           "Exclude Payment Requests

*  SELECT blart bukrs gjahr buzei belnr umskz bldat xref1 xref2 waers
    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsad_tmp_op
             FROM bsad
*           WHERE kunnr EQ p_kunnr                          "MOD-001
             WHERE kunnr IN s_kunnr                         "MOD-001
               AND bukrs EQ p_bukrs
*** MOD-001 * begin ***
*              Exclude document type 'RD' for foreign opening balance
*               AND belnr NOT BETWEEN '3000000000' AND '3199999999'
               AND belnr NOT BETWEEN '3000000000' AND '3299999999'
*** MOD-001 * end ***
               AND bldat < s_bldat-low
               AND umskz <> 'F'.         "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

  CLEAR gt_doc[].

*** MOD-001 * begin ***
* Get customer lines for clearing documents (AB)
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_bsad_tmp_op[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr wrbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_bsad_tmp_op
           WHERE bukrs =  gt_bsad_tmp_op-bukrs
             AND belnr =  gt_bsad_tmp_op-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_bsad_tmp_op-gjahr
             AND koart =  'D'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_bsad_tmp_op INTO gt_bsid_tmp_op.

    IF gt_bsid_tmp_op-belnr >= '0600000000'  AND
       gt_bsid_tmp_op-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_bsid_tmp_op-bukrs  AND
*           gt_doc-belnr = gt_bsid_tmp_op-belnr  AND
*           gt_doc-gjahr = gt_bsid_tmp_op-gjahr.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*
*      IF lv_check <> 'X'.
*        SELECT dmbtr wrbtr shkzg
*               INTO CORRESPONDING FIELDS OF gt_bsid_tmp_op
*               FROM bseg
*               WHERE bukrs = gt_bsid_tmp_op-bukrs
*                 AND belnr = gt_bsid_tmp_op-belnr
*                 AND gjahr = gt_bsid_tmp_op-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).
*          IF gt_bsid_tmp-shkzg = 'H'.
*            gt_bsid_tmp_op-shkzg = 'S'.
*          ELSE.
*            gt_bsid_tmp_op-shkzg = 'H'.
*          ENDIF.

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_bsid_tmp_op-bukrs
                                       gjahr = gt_bsid_tmp_op-gjahr
                                       belnr = gt_bsid_tmp_op-belnr.
      IF sy-subrc NE 0.
        CLEAR: lv_dmbtr, lv_wrbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_bsid_tmp_op-bukrs
                                  AND gjahr = gt_bsid_tmp_op-gjahr
                                  AND belnr = gt_bsid_tmp_op-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr + gt_clr_bseg_tmp-wrbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr - gt_clr_bseg_tmp-wrbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_bsid_tmp_op-dmbtr = ABS( lv_dmbtr ).
          gt_bsid_tmp_op-wrbtr = ABS( lv_wrbtr ).
          IF lv_dmbtr < 0.
            gt_bsid_tmp_op-shkzg = 'H'.
          ELSE.
            gt_bsid_tmp_op-shkzg = 'S'.
          ENDIF.
          gt_bsid_tmp_op-blart = 'AB'.
*          gt_bsid_tmp_op-dmbtr = 0.
*** MOD-001 * end ***
          gt_bsid_tmp_op-xflg = 'X'.
          APPEND gt_bsid_tmp_op.
        ENDIF.                                              "MOD-001
*        ENDSELECT.                                         "MOD-001
        ws_doc-bukrs = gt_bsid_tmp_op-bukrs.
        ws_doc-gjahr = gt_bsid_tmp_op-gjahr.
        ws_doc-belnr = gt_bsid_tmp_op-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.
      CLEAR gt_bsid_tmp_op.
    ELSE.
      APPEND gt_bsid_tmp_op.
    ENDIF.

  ENDLOOP.

* Remove the BSID lines (which contain in BSEG the exchange rate lines)
*LOOP at gt_doc.
*  LOOP at gt_bsid_tmp_op.
*   l_tabix = sy-tabix.
*      if gt_bsid_tmp_op-bukrs = gt_doc-bukrs and gt_bsid_tmp_op-belnr = gt_doc-belnr and gt_bsid_tmp_op-gjahr = gt_doc-gjahr and gt_bsid_tmp_op-xflg <> 'X'.
*        DELETE gt_bsid_tmp_op index l_tabix.
*      endif.
*  ENDLOOP.
*ENDLOOP.

  SORT gt_bsid_tmp_op BY bldat.
  LOOP AT gt_bsid_tmp_op.

    CLEAR lv_xref2.
    IF gt_bsid_tmp_op-xref2 <> ' ' AND STRLEN( gt_bsid_tmp_op-xref2 ) < 11 .
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = gt_bsid_tmp_op-xref2
        IMPORTING
          output = lv_xref2.

*      CLEAR lv_aubel_o.                                    "MOD-001
*      lv_aubel_o = lv_xref2.                               "MOD-001
    ENDIF.
* Select the currency of the sales order.
    CLEAR lv_waerk.
* MOD-001 * begin ***
    IF NOT lv_xref2 IS INITIAL  AND
       ( gt_bsid_tmp_op-blart <> 'RV'  AND
         gt_bsid_tmp_op-blart <> 'AB'  AND
         gt_bsid_tmp_op-blart <> 'DR'  AND
         gt_bsid_tmp_op-blart <> 'DA'  AND
         gt_bsid_tmp_op-blart <> 'DG' ).
* MOD-001 * end ***
      SELECT SINGLE waerk INTO lv_waerk
             FROM vbak
*           WHERE vbeln = lv_aubel_o.                       "MOD-001
             WHERE vbeln = lv_xref2.                        "MOD-001
    ENDIF.                                                  "MOD-001

* Foreign Currency value... Invoices (type 'RV', 'DR', 'DA' 'DG') also just take the amount from the document
* Also for clearing documents 'AB'                          "MOD-001
    IF lv_waerk IS NOT INITIAL  AND
* Begin 23/09/2010
       ( gt_bsid_tmp_op-blart <> 'RV'  AND
         gt_bsid_tmp_op-blart <> 'AB'  AND                  "MOD-001
         gt_bsid_tmp_op-blart <> 'DR'  AND
         gt_bsid_tmp_op-blart <> 'DA'  AND
         gt_bsid_tmp_op-blart <> 'DG' ).
* End 23/09/2010

      CLEAR lv_date_c.
      CLEAR lv_date_bkpf.
      CLEAR lv_ukurs_o.

*          IF lv_waerk <> gt_bsid_tmp-waers.

      SELECT SINGLE bldat INTO lv_date_bkpf
             FROM bkpf
             WHERE belnr = gt_bsid_tmp_op-belnr
*               AND bukrs = 'MRUA'                          "MOD-001
               AND bukrs = p_bukrs                          "MOD-001
               AND gjahr = gt_bsid_tmp_op-gjahr.

      CONVERT INVERTED-DATE lv_date_bkpf INTO DATE lv_date_c .
      SELECT SINGLE ukurs INTO lv_ukurs_o
             FROM tcurr
             WHERE kurst = 'DRU'
               AND tcurr = 'RUB'
               AND fcurr = lv_waerk
               AND gdatu = lv_date_c.

      IF lv_ukurs_o IS INITIAL.
        CLEAR lv_gdatu.
        SELECT SINGLE MIN( gdatu ) INTO lv_gdatu
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu > lv_date_c.

        SELECT SINGLE ukurs INTO lv_ukurs_o
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu = lv_gdatu.
      ENDIF.
      IF gt_bsid_tmp_op-shkzg = 'S'.
        IF lv_waerk = 'RUB'.
          lv_ukurs_o = 1.
        ENDIF.
        IF lv_ukurs_o <> 0 AND gt_bsid_tmp_op-dmbtr <> 0.
          gt_bsid_tmp_op-dmbtr = gt_bsid_tmp_op-dmbtr / lv_ukurs_o.
        ENDIF.
        IF lv_waerk = 'RUB'.
          lv_debit_o_rub = lv_debit_o_rub + gt_bsid_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'EUR'.
          lv_debit_o_eur = lv_debit_o_eur + gt_bsid_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'USD'.
          lv_debit_o_usd = lv_debit_o_usd + gt_bsid_tmp_op-dmbtr.
        ENDIF.
      ELSEIF gt_bsid_tmp_op-shkzg = 'H'.
        IF lv_waerk = 'RUB'.
          lv_ukurs_o = 1.
        ENDIF.
        IF lv_ukurs_o <> 0 AND gt_bsid_tmp_op-dmbtr <> 0.
          gt_bsid_tmp_op-dmbtr = gt_bsid_tmp_op-dmbtr / lv_ukurs_o.
        ENDIF.
        IF lv_waerk = 'RUB'.
          lv_credit_o_rub = lv_credit_o_rub + gt_bsid_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'EUR'.
          lv_credit_o_eur = lv_credit_o_eur + gt_bsid_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'USD'.
          lv_credit_o_usd = lv_credit_o_usd + gt_bsid_tmp_op-dmbtr.
        ENDIF.
      ENDIF. "shkzg

    ELSE.
      IF gt_bsid_tmp_op-shkzg = 'S'.
        gt_bsid_tmp_op-dmbtr = gt_bsid_tmp_op-wrbtr.
        IF gt_bsid_tmp_op-waers = 'RUB'.
          lv_debit_o_rub = lv_debit_o_rub + gt_bsid_tmp_op-dmbtr.
        ELSEIF gt_bsid_tmp_op-waers = 'EUR'.
          lv_debit_o_eur = lv_debit_o_eur + gt_bsid_tmp_op-dmbtr.
        ELSEIF gt_bsid_tmp_op-waers = 'USD'.
          lv_debit_o_usd = lv_debit_o_usd + gt_bsid_tmp_op-dmbtr.
        ENDIF.
      ELSEIF gt_bsid_tmp_op-shkzg = 'H'.
        gt_bsid_tmp_op-dmbtr = gt_bsid_tmp_op-wrbtr.
        IF gt_bsid_tmp_op-waers = 'RUB'.
          lv_credit_o_rub = lv_credit_o_rub + gt_bsid_tmp_op-dmbtr.
        ELSEIF gt_bsid_tmp_op-waers = 'EUR'.
          lv_credit_o_eur = lv_credit_o_eur + gt_bsid_tmp_op-dmbtr.
        ELSEIF gt_bsid_tmp_op-waers = 'USD'.
          lv_credit_o_usd = lv_credit_o_usd + gt_bsid_tmp_op-dmbtr.
        ENDIF.
      ENDIF. "shkzg
    ENDIF. "lv_waerk
  ENDLOOP.

  lv_op_sal_rub = lv_debit_o_rub + ( lv_credit_o_rub * ( -1 ) ).
  lv_op_sal_eur = lv_debit_o_eur + ( lv_credit_o_eur * ( -1 ) ).
  lv_op_sal_usd = lv_debit_o_usd + ( lv_credit_o_usd * ( -1 ) ).

*********************************************************************************
* Selected Bookings
*********************************************************************************
* Calculate bookings total (without opening balance)

  CLEAR: gt_clr_bsad[],
         lv_debit_b,                                        "MOD-001
         lv_credit_b.                                       "MOD-001

*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
*   Debit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_b
           FROM bsid
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat IN s_bldat
             AND shkzg = 'S'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Credit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_b
           FROM bsid
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat IN s_bldat
             AND shkzg = 'H'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Debit and Credit total clearing bookings (without opening balance)
    SELECT bukrs gjahr belnr shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsad
           FROM bsad
           WHERE kunnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND budat IN s_bldat
             AND umskz <> 'F'.           "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
*   Debit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_b
           FROM bsid
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat IN s_bldat
             AND shkzg = 'S'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Credit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_b
           FROM bsid
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat IN s_bldat
             AND shkzg = 'H'
             AND umskz <> 'F'.           "Exclude Payment Requests

* Add The opening Balance local currency
*    lv_debit_b = lv_debit_b + lv_debit_o.
*    lv_credit_b = lv_credit_b + lv_credit_o.

*   Debit and Credit total clearing bookings (without opening balance)
    SELECT bukrs gjahr belnr shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsad
           FROM bsad
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND bldat IN s_bldat
             AND umskz <> 'F'.           "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

  CLEAR gt_clr_bseg[].

  CLEAR gt_doc[].

*** MOD-001 * begin ***
* Get customer lines for clearing documents (AB)
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_clr_bsad[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_clr_bsad
           WHERE bukrs =  gt_clr_bsad-bukrs
             AND belnr =  gt_clr_bsad-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_clr_bsad-gjahr
             AND koart =  'D'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_clr_bsad.

    IF gt_clr_bsad-belnr >= '0600000000'  AND
       gt_clr_bsad-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_clr_bsad-bukrs  AND
*           gt_doc-belnr = gt_clr_bsad-belnr  AND
*           gt_doc-gjahr = gt_clr_bsad-gjahr.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*
*      IF lv_check <> 'X'.
*        SELECT bukrs belnr gjahr shkzg dmbtr hkont
*               APPENDING CORRESPONDING FIELDS OF TABLE gt_clr_bseg
*               FROM bseg
*               WHERE bukrs = gt_clr_bsad-bukrs
*                 AND belnr = gt_clr_bsad-belnr
*                 AND gjahr = gt_clr_bsad-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_clr_bsad-bukrs
                                       gjahr = gt_clr_bsad-gjahr
                                       belnr = gt_clr_bsad-belnr.
      IF sy-subrc NE 0.
        CLEAR lv_dmbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_clr_bsad-bukrs
                                  AND gjahr = gt_clr_bsad-gjahr
                                  AND belnr = gt_clr_bsad-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_clr_bseg-bukrs = gt_clr_bsad-bukrs.
          gt_clr_bseg-belnr = gt_clr_bsad-belnr.
          gt_clr_bseg-gjahr = gt_clr_bsad-gjahr.
          gt_clr_bseg-dmbtr = ABS( lv_dmbtr ).
          IF lv_dmbtr < 0.
            gt_clr_bseg-shkzg = 'H'.
          ELSE.
            gt_clr_bseg-shkzg = 'S'.
          ENDIF.
          gt_clr_bseg-blart = 'AB'.
          APPEND gt_clr_bseg.
        ENDIF.
*** MOD-001 * end ***
        ws_doc-bukrs = gt_clr_bsad-bukrs.
        ws_doc-gjahr = gt_clr_bsad-gjahr.
        ws_doc-belnr = gt_clr_bsad-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.
    ELSE.
      gt_clr_bseg-bukrs = gt_clr_bsad-bukrs.
      gt_clr_bseg-belnr = gt_clr_bsad-belnr.
      gt_clr_bseg-gjahr = gt_clr_bsad-gjahr.
      gt_clr_bseg-shkzg = gt_clr_bsad-shkzg.
      gt_clr_bseg-dmbtr = gt_clr_bsad-dmbtr.
*      gt_clr_bseg-hkont = ' '.                             "MOD-001
      gt_clr_bseg-blart = gt_clr_bsad-blart.                "MOD-001
      APPEND gt_clr_bseg.
    ENDIF.

  ENDLOOP.

* 6-docs in BSID(concerning exchange rate lines) should be removed
*LOOP AT gt_doc.
*    clear lv_dmbtr.
*    clear lv_shkzg.
*    select single dmbtr shkzg from bsid into (lv_dmbtr, lv_shkzg)
*      where bukrs = gt_doc-bukrs and
*            gjahr = gt_doc-gjahr and
*            belnr = gt_doc-belnr.
*    if lv_shkzg = 'S'.
*      lv_debit_b = lv_debit_b - lv_dmbtr.
*    else.
*      lv_credit_b = lv_credit_b - lv_dmbtr.
*    endif.
*ENDLOOP.

* Exchange rate lines from BSAD(BSEG values)
  LOOP AT gt_clr_bseg.
*** MOD-001 * begin ***
*    IF gt_clr_bseg-hkont = '0007960902'  OR
*       gt_clr_bseg-hkont = '0003960902'.
*    IF gt_clr_bseg-blart = 'AB'.
*      IF gt_clr_bseg-shkzg = 'H'.
*        lv_debit_b = lv_debit_b + gt_clr_bseg-dmbtr.
*      ELSE.
*        lv_credit_b = lv_credit_b + gt_clr_bseg-dmbtr.
*      ENDIF.
*    ELSE.
*** MOD-001 * end ***
    IF gt_clr_bseg-shkzg = 'S'.
      lv_debit_b = lv_debit_b + gt_clr_bseg-dmbtr.
    ELSE.
      lv_credit_b = lv_credit_b + gt_clr_bseg-dmbtr.
    ENDIF.
*    ENDIF.                                                 "MOD-001
  ENDLOOP.
* Closing Balance local currency (concerning columns 5,6,7)
  lv_bk_sal = lv_debit_b + ( lv_credit_b * ( -1 ) ) + lv_debit_o + ( lv_credit_o * ( -1 ) ) .

* Select records for ALV
*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
    SELECT blart belnr bukrs gjahr umskz bldat xref1 xref2
           dmbtr wrbtr shkzg waers budat zuonr kkber
           INTO CORRESPONDING FIELDS OF TABLE gt_bsid_tmp
           FROM bsid
           WHERE kunnr IN s_kunnr
            AND bukrs EQ p_bukrs
            AND belnr NOT BETWEEN '3000000000' AND '3199999999'
            AND belnr NOT BETWEEN '0600000000' AND '0699999999'
            AND budat IN s_bldat
            AND umskz <> 'F'.            "Exclude Payment Requests

    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsad_tmp
             FROM bsad
             WHERE kunnr IN s_kunnr
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3199999999'
               AND budat IN s_bldat
               AND umskz <> 'F'.         "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
    SELECT blart belnr bukrs gjahr umskz bldat xref1 xref2 dmbtr wrbtr shkzg waers
           budat zuonr kkber                                "MOD-001
           INTO CORRESPONDING FIELDS OF TABLE gt_bsid_tmp
           FROM bsid
*         WHERE kunnr EQ p_kunnr                            "MOD-001
           WHERE kunnr IN s_kunnr                           "MOD-001
            AND bukrs EQ p_bukrs
            AND belnr NOT BETWEEN '3000000000' AND '3199999999'
            AND belnr NOT BETWEEN '0600000000' AND '0699999999'
            AND bldat IN s_bldat
            AND umskz <> 'F'.            "Exclude Payment Requests

*    SELECT blart bukrs gjahr buzei belnr umskz bldat xref1 xref2 waers
    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsad_tmp
             FROM bsad
*           WHERE kunnr EQ p_kunnr                          "MOD-001
             WHERE kunnr IN s_kunnr                         "MOD-001
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3199999999'
               AND bldat IN s_bldat
               AND umskz <> 'F'.         "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

  CLEAR gt_doc[].

*** MOD-001 * begin ***
* Get customer lines for clearing documents (AB)
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_bsad_tmp[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr wrbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_bsad_tmp
           WHERE bukrs =  gt_bsad_tmp-bukrs
             AND belnr =  gt_bsad_tmp-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_bsad_tmp-gjahr
             AND koart =  'D'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_bsad_tmp INTO gt_bsid_tmp.

    IF gt_bsid_tmp-belnr >= '0600000000'  AND
       gt_bsid_tmp-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_bsid_tmp-bukrs  AND
*           gt_doc-belnr = gt_bsid_tmp-belnr  AND
*           gt_doc-gjahr = gt_bsid_tmp-gjahr.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*
*      IF lv_check <> 'X'.
*        SELECT dmbtr wrbtr shkzg hkont
*               INTO CORRESPONDING FIELDS OF gt_bsid_tmp
*               FROM bseg
*               WHERE bukrs = gt_bsid_tmp-bukrs
*                 AND belnr = gt_bsid_tmp-belnr
*                 AND gjahr = gt_bsid_tmp-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).
*          IF gt_bsid_tmp-shkzg = 'H'.
*            gt_bsid_tmp-shkzg = 'S'.
*          ELSE.
*            gt_bsid_tmp-shkzg = 'H'.
*          ENDIF.

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_bsid_tmp-bukrs
                                       gjahr = gt_bsid_tmp-gjahr
                                       belnr = gt_bsid_tmp-belnr.
      IF sy-subrc NE 0.
        CLEAR: lv_dmbtr, lv_wrbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_bsid_tmp-bukrs
                                  AND gjahr = gt_bsid_tmp-gjahr
                                  AND belnr = gt_bsid_tmp-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr + gt_clr_bseg_tmp-wrbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr - gt_clr_bseg_tmp-wrbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_bsid_tmp-dmbtr = ABS( lv_dmbtr ).
          gt_bsid_tmp-wrbtr = ABS( lv_wrbtr ).
          IF lv_dmbtr < 0.
            gt_bsid_tmp-shkzg = 'H'.
          ELSE.
            gt_bsid_tmp-shkzg = 'S'.
          ENDIF.
          gt_bsid_tmp-blart = 'AB'.
*** MOD-001 * end ***
          gt_bsid_tmp-xflg = 'X'.
          APPEND gt_bsid_tmp.
        ENDIF.                                              "MOD-001
*        ENDSELECT.                                         "MOD-001
        ws_doc-bukrs = gt_bsid_tmp-bukrs.
        ws_doc-gjahr = gt_bsid_tmp-gjahr.
        ws_doc-belnr = gt_bsid_tmp-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.
      CLEAR gt_bsid_tmp.
    ELSE.
      APPEND gt_bsid_tmp.
    ENDIF.
  ENDLOOP.

* Remove the BSID lines (which contain in BSEG the exchange rate lines)
*LOOP at gt_doc.
*  LOOP at gt_bsid_tmp.
*   l_tabix = sy-tabix.
*      if gt_bsid_tmp-bukrs = gt_doc-bukrs and gt_bsid_tmp-belnr = gt_doc-belnr and gt_bsid_tmp-gjahr = gt_doc-gjahr and gt_bsid_tmp-xflg <> 'X'.
*        DELETE gt_bsid_tmp index l_tabix.
*      endif.
*  ENDLOOP.
*ENDLOOP.

*** MOD-001 * begin ***
* Process rounding differences for customers (add to corresponding document)
  PERFORM process_rounding_diff_cust
          TABLES gt_bsid_tmp.
*** MOD-001 * end ***

  SORT gt_bsid_tmp BY bldat.

  LOOP AT gt_bsid_tmp.
*       clear gt_bsid.
    CLEAR: lv_xref2, gt_bsid-bldat, gt_bsid-deb_dmbtr_lc, gt_bsid-cre_dmbtr_lc,
           gt_bsid-deb_dmbtr_dc, gt_bsid-cre_dmbtr_dc, gt_bsid-waers, gt_bsid-waers2, gt_bsid-ukurs, gt_bsid-xblnr2,
           gt_bsid-doc_type,
*** MOD-001 * begin ***
           gt_bsid-budat, gt_bsid-zuonr, lv_xblnr, lv_zuonr,
           gt_bsid-deb_dmbtr_dc_eur, gt_bsid-cre_dmbtr_dc_eur,
           gt_bsid-deb_dmbtr_dc_usd, gt_bsid-cre_dmbtr_dc_usd,
           gt_bsid-deb_dmbtr_dc_rub, gt_bsid-cre_dmbtr_dc_rub,
           gt_bsid-kkber, gt_bsid-sgtxt,
*** MOD-001 * end ***
* Begin 23/10/2010
*             gt_bsid-vbeln.
           gt_bsid-xblnr2.
* End 23/10/2010

*** MOD-001 * begin ***
*    SELECT SINGLE zuonr INTO (lv_zuonr)
*           FROM bseg
*           WHERE bukrs = gt_bsid_tmp-bukrs
*             AND belnr = gt_bsid_tmp-belnr
*             AND gjahr = gt_bsid_tmp-gjahr
*             AND kunnr <> ' '.
    SELECT sgtxt INTO (lv_sgtxt)
           FROM bseg
           WHERE bukrs = gt_bsid_tmp-bukrs
             AND belnr = gt_bsid_tmp-belnr
             AND gjahr = gt_bsid_tmp-gjahr
             AND koart = 'D'.
      CONCATENATE gt_bsid-sgtxt lv_sgtxt INTO gt_bsid-sgtxt
                  SEPARATED BY space.
    ENDSELECT.
    IF NOT gt_bsid-sgtxt IS INITIAL.
      SHIFT gt_bsid-sgtxt LEFT DELETING LEADING space.
    ENDIF.

    gt_bsid-xref2 = gt_bsid_tmp-xref2.

*    IF gt_bsid_tmp-blart ='KR'.
*      gt_bsid-doc_type = text-d01.
*    ELSEIF gt_bsid_tmp-blart ='ZC'  OR
*           gt_bsid_tmp-blart ='ZP'  OR
*           gt_bsid_tmp-blart ='DZ'.
*      gt_bsid-doc_type = text-d02.
*    ELSEIF gt_bsid_tmp-blart ='RV'  OR
*           gt_bsid_tmp-blart ='DR'.
*      gt_bsid-doc_type = text-d03.
*    ELSE.
*      gt_bsid-doc_type = text-d04.
*    ENDIF.
    CASE gt_bsid_tmp-blart.
      WHEN 'KR' OR 'KG' OR 'RE'.
        gt_bsid-doc_type = text-d01.
      WHEN 'DZ' OR 'ZC' OR 'KZ' OR 'ZP' OR 'KA'.
        gt_bsid-doc_type = text-d02.
      WHEN 'DR' OR 'RV' OR 'DG' OR 'DA'.
        gt_bsid-doc_type = text-d03.
      WHEN 'AB'.
        gt_bsid-doc_type = text-d04.
      WHEN OTHERS.
    ENDCASE.
*** MOD-001 * end ***

    gt_bsid-bldat = gt_bsid_tmp-bldat.
    gt_bsid-budat = gt_bsid_tmp-budat.                      "MOD-001
    gt_bsid-belnr = gt_bsid_tmp-belnr.                      "MOD-001

*    SELECT SINGLE xblnr INTO gt_bsid-xblnr                 "MOD-001
    SELECT SINGLE xblnr INTO lv_xblnr                       "MOD-001
           FROM bkpf
           WHERE belnr = gt_bsid_tmp-belnr
*             AND bukrs = 'MRUA'                            "MOD-001
             AND bukrs = p_bukrs                            "MOD-001
             AND gjahr = gt_bsid_tmp-gjahr .

*** MOD-001 * Begin ***
*    gt_bsid-xblnr2 = gt_bsid-xblnr.
    CASE gt_bsid_tmp-blart.
      WHEN 'KR' OR 'KG' OR 'RE' OR 'KZ' OR 'ZP' OR 'KA'.
        gt_bsid-xblnr2 = lv_xblnr.
      WHEN 'DR' OR 'RV' OR 'DG' OR 'DA' OR 'AB'.
        gt_bsid-xblnr2 = gt_bsid_tmp-belnr.
      WHEN 'DZ' OR 'ZC'.
        gt_bsid-xblnr2 = gt_bsid_tmp-xref1.
      WHEN OTHERS.
    ENDCASE.

    gt_bsid-zuonr = gt_bsid_tmp-zuonr.
    gt_bsid-kkber = gt_bsid_tmp-kkber.
*** MOD-001 * end ***

    CLEAR lv_ukurs.

    IF gt_bsid_tmp-xref2 <> ' ' AND STRLEN( gt_bsid_tmp-xref2 ) < 11.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = gt_bsid_tmp-xref2
        IMPORTING
          output = lv_xref2.
* Begin 23/09/2010
*       select single vbeln aubel from vbrp into (gt_bsid-vbeln, gt_bsid-aubel) where
*         aubel = lv_xref2.
*   select single aubel from vbrp into (gt_bsid-aubel) where
*          aubel = lv_xref2.
*      gt_bsid-aubel = lv_xref2.                            "MOD-001
* End 23/09/2010
*       select single vbeln aubel from vbrp into (gt_bsid-vbeln, gt_bsid-aubel) where
*         aubel = lv_xref2.
    ELSE.
*         select single vbel2 from bseg into gt_bsid-aubel
*           where vbel2 <> ' ' and
*            bukrs = gt_bsid_tmp-bukrs AND
*            belnr = gt_bsid_tmp-belnr AND
*            gjahr = gt_bsid_tmp-gjahr.

* Begin 23/09/10
*     SELECT single vbeln FROM vbfa INTO  gt_bsid-vbeln
*                    WHERE vbelv = gt_bsid-aubel
*                      AND vbtyp_n = 'M'
*                      AND fktyp <> 'P'.
*         select single vbeln from vbrp into (gt_bsid-vbeln) where
*         aubel = gt_bsid-aubel.
* End 23/09/2010
    ENDIF.

    IF gt_bsid_tmp-shkzg = 'S'.
      gt_bsid-deb_dmbtr_lc = gt_bsid_tmp-dmbtr.
      gt_bsid-cre_dmbtr_lc = 0.
    ELSEIF gt_bsid_tmp-shkzg = 'H'.
      gt_bsid-cre_dmbtr_lc = gt_bsid_tmp-dmbtr.
      gt_bsid-deb_dmbtr_lc = 0.
    ENDIF.
*   First time add opening balance...
    IF lv_first = 'X'.
      gt_bsid-sal_dmbtr_lc = gt_bsid-sal_dmbtr_lc + gt_bsid-deb_dmbtr_lc - gt_bsid-cre_dmbtr_lc + lv_op_sal.
*** MOD-001 * begin ***
      gt_bsid-sal_dmbtr_dc_rub = lv_op_sal_rub.
      gt_bsid-sal_dmbtr_dc_eur = lv_op_sal_eur.
      gt_bsid-sal_dmbtr_dc_usd = lv_op_sal_usd.
*** MOD-001 * end ***
      lv_first = ' ' .
    ELSE.
      gt_bsid-sal_dmbtr_lc = gt_bsid-sal_dmbtr_lc + gt_bsid-deb_dmbtr_lc - gt_bsid-cre_dmbtr_lc.
    ENDIF.

*   Select the  currency of the sales order.
    CLEAR lv_waerk.
* MOD-001 * begin ***
    IF NOT lv_xref2 IS INITIAL  AND
       ( gt_bsid_tmp_op-blart <> 'RV'  AND
         gt_bsid_tmp_op-blart <> 'AB'  AND
         gt_bsid_tmp_op-blart <> 'DR'  AND
         gt_bsid_tmp_op-blart <> 'DA'  AND
         gt_bsid_tmp_op-blart <> 'DG' ).
* MOD-001 * end ***
      SELECT SINGLE waerk INTO lv_waerk
             FROM vbak
             WHERE vbeln = lv_xref2.
    ENDIF.                                                  "MOD-001
*   Foreign Currency
    IF lv_waerk IS NOT INITIAL  AND
* Begin 23/09/2010
       ( gt_bsid_tmp-blart <> 'RV'  AND
         gt_bsid_tmp-blart <> 'AB'  AND                     "MOD-001
         gt_bsid_tmp-blart <> 'DR'  AND
         gt_bsid_tmp-blart <> 'DA'  AND
         gt_bsid_tmp-blart <> 'DG' ).
* End 23/09/2010
      IF lv_waerk = 'USD'.
        gt_bsid-waers = lv_waerk.
        gt_bsid-waers2 = text-h32.
      ELSEIF lv_waerk = 'EUR'.
        gt_bsid-waers = lv_waerk.
        gt_bsid-waers2 = text-h31.
      ELSE.
        SELECT SINGLE ktext waers
               INTO (gt_bsid-waers2, gt_bsid-waers)
               FROM tcurt
               WHERE spras = 'R'
                 AND waers = lv_waerk.
      ENDIF.
    ELSE.
      gt_bsid-waers = gt_bsid_tmp-waers.
      IF gt_bsid_tmp-waers = 'USD'.
        gt_bsid-waers2 = text-h32.
      ELSEIF gt_bsid_tmp-waers = 'EUR'.
        gt_bsid-waers2 = text-h31.
      ELSE.
        SELECT SINGLE ktext waers
               INTO (gt_bsid-waers2, gt_bsid-waers)
               FROM tcurt
               WHERE spras = 'R'
                 AND waers = gt_bsid_tmp-waers.
      ENDIF.
    ENDIF.

*   Foreign Currency value
*** MOD-001 * begin ***
*    IF ( gt_bsid_tmp-hkont <> '0007960902'  AND
*         gt_bsid_tmp-hkont <> '0003960902' ).
*** MOD-001 * end ***
    IF lv_waerk IS NOT INITIAL  AND
* Begin 23/09/2010
       ( gt_bsid_tmp-blart <> 'RV'  AND
         gt_bsid_tmp-blart <> 'AB'  AND                     "MOD-001
         gt_bsid_tmp-blart <> 'DR'  AND
         gt_bsid_tmp-blart <> 'DA'  AND
         gt_bsid_tmp-blart <> 'DG' ).
* End 23/09/2010

      CLEAR lv_date_c.
      CLEAR lv_date_bkpf.

*          IF lv_waerk <> gt_bsid_tmp-waers.

      SELECT SINGLE bldat INTO lv_date_bkpf
             FROM bkpf
             WHERE belnr = gt_bsid_tmp-belnr
*                 AND bukrs = 'MRUA'                        "MOD-001
               AND bukrs = p_bukrs                          "MOD-001
               AND gjahr = gt_bsid_tmp-gjahr.

      CONVERT INVERTED-DATE lv_date_bkpf INTO DATE lv_date_c .
      SELECT SINGLE ukurs  INTO gt_bsid-ukurs
             FROM tcurr
             WHERE kurst = 'DRU'
               AND tcurr = 'RUB'
               AND fcurr = lv_waerk
               AND gdatu = lv_date_c.

      IF gt_bsid-ukurs IS INITIAL.
        CLEAR lv_gdatu.
        SELECT SINGLE MIN( gdatu ) INTO lv_gdatu
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu > lv_date_c.

        SELECT SINGLE ukurs INTO gt_bsid-ukurs
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu = lv_gdatu.
      ENDIF.

      IF gt_bsid_tmp-shkzg = 'S'.
        IF lv_waerk = 'RUB'.
          gt_bsid-ukurs = 1.
        ENDIF.
        gt_bsid-deb_dmbtr_dc = gt_bsid-deb_dmbtr_lc.        "MOD-001
        IF gt_bsid-ukurs <> 0.
          gt_bsid-deb_dmbtr_dc = gt_bsid-deb_dmbtr_lc / gt_bsid-ukurs.
        ENDIF.
        gt_bsid-cre_dmbtr_dc = 0.
        gt_bsid-cre_dmbtr_dc_rub = 0.                       "MOD-001
        gt_bsid-cre_dmbtr_dc_eur = 0.                       "MOD-001
        gt_bsid-cre_dmbtr_dc_usd = 0.                       "MOD-001
        IF lv_waerk = 'RUB'.
          gt_bsid-deb_dmbtr_dc_rub = gt_bsid-deb_dmbtr_dc.  "MOD-001
          lv_debit_b_rub = lv_debit_b_rub + gt_bsid-deb_dmbtr_dc.
          gt_bsid-deb_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsid-deb_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF lv_waerk = 'EUR'.
          gt_bsid-deb_dmbtr_dc_eur = gt_bsid-deb_dmbtr_dc.  "MOD-001
          lv_debit_b_eur = lv_debit_b_eur + gt_bsid-deb_dmbtr_dc.
          gt_bsid-deb_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-deb_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF lv_waerk = 'USD'.
          gt_bsid-deb_dmbtr_dc_usd = gt_bsid-deb_dmbtr_dc.  "MOD-001
          lv_debit_b_usd = lv_debit_b_usd + gt_bsid-deb_dmbtr_dc.
          gt_bsid-deb_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-deb_dmbtr_dc_eur = 0.                     "MOD-001
        ENDIF.

      ELSEIF gt_bsid_tmp-shkzg = 'H'.
        IF lv_waerk = 'RUB'.
          gt_bsid-ukurs = 1.
        ENDIF.
        gt_bsid-cre_dmbtr_dc = gt_bsid-cre_dmbtr_lc.        "MOD-001
        IF gt_bsid-ukurs <> 0.
          gt_bsid-cre_dmbtr_dc = gt_bsid-cre_dmbtr_lc / gt_bsid-ukurs.
        ENDIF.
        gt_bsid-deb_dmbtr_dc = 0.
        gt_bsid-deb_dmbtr_dc_rub = 0.                       "MOD-001
        gt_bsid-deb_dmbtr_dc_eur = 0.                       "MOD-001
        gt_bsid-deb_dmbtr_dc_usd = 0.                       "MOD-001
        IF lv_waerk = 'RUB'.
          gt_bsid-cre_dmbtr_dc_rub = gt_bsid-cre_dmbtr_dc.  "MOD-001
          lv_credit_b_rub = lv_credit_b_rub + gt_bsid-cre_dmbtr_dc.
          gt_bsid-cre_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsid-cre_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF lv_waerk = 'EUR'.
          gt_bsid-cre_dmbtr_dc_eur = gt_bsid-cre_dmbtr_dc.  "MOD-001
          lv_credit_b_eur = lv_credit_b_eur + gt_bsid-cre_dmbtr_dc.
          gt_bsid-cre_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-cre_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF lv_waerk = 'USD'.
          gt_bsid-cre_dmbtr_dc_usd = gt_bsid-cre_dmbtr_dc.  "MOD-001
          lv_credit_b_usd = lv_credit_b_usd + gt_bsid-cre_dmbtr_dc.
          gt_bsid-cre_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-cre_dmbtr_dc_eur = 0.                     "MOD-001
        ENDIF.
      ENDIF.
    ELSE.    "no currency

      SELECT SINGLE kursf INTO gt_bsid-ukurs
             FROM bkpf
             WHERE bukrs = gt_bsid_tmp-bukrs
               AND gjahr = gt_bsid_tmp-gjahr
               AND belnr = gt_bsid_tmp-belnr.
      IF gt_bsid-ukurs = 0.
        gt_bsid-ukurs = 1.
      ENDIF.

      IF gt_bsid_tmp-shkzg = 'S'.
        gt_bsid-deb_dmbtr_dc = gt_bsid_tmp-wrbtr.
        gt_bsid-cre_dmbtr_dc = 0.
        gt_bsid-cre_dmbtr_dc_rub = 0.                       "MOD-001
        gt_bsid-cre_dmbtr_dc_eur = 0.                       "MOD-001
        gt_bsid-cre_dmbtr_dc_usd = 0.                       "MOD-001
        IF gt_bsid_tmp-waers = 'RUB'.
          gt_bsid-deb_dmbtr_dc_rub = gt_bsid-deb_dmbtr_dc.  "MOD-001
          lv_debit_b_rub = lv_debit_b_rub + gt_bsid-deb_dmbtr_dc.
          gt_bsid-deb_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsid-deb_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF gt_bsid_tmp-waers = 'EUR'.
          gt_bsid-deb_dmbtr_dc_eur = gt_bsid-deb_dmbtr_dc.  "MOD-001
          lv_debit_b_eur = lv_debit_b_eur + gt_bsid-deb_dmbtr_dc.
          gt_bsid-deb_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-deb_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF gt_bsid_tmp-waers = 'USD'.
          gt_bsid-deb_dmbtr_dc_usd = gt_bsid-deb_dmbtr_dc.  "MOD-001
          lv_debit_b_usd = lv_debit_b_usd + gt_bsid-deb_dmbtr_dc.
          gt_bsid-deb_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-deb_dmbtr_dc_eur = 0.                     "MOD-001
        ENDIF.
      ELSEIF gt_bsid_tmp-shkzg = 'H'.
        gt_bsid-cre_dmbtr_dc = gt_bsid_tmp-wrbtr.
        gt_bsid-deb_dmbtr_dc = 0.
        gt_bsid-deb_dmbtr_dc_rub = 0.                       "MOD-001
        gt_bsid-deb_dmbtr_dc_eur = 0.                       "MOD-001
        gt_bsid-deb_dmbtr_dc_usd = 0.                       "MOD-001
        IF gt_bsid_tmp-waers = 'RUB'.
          gt_bsid-cre_dmbtr_dc_rub = gt_bsid-cre_dmbtr_dc.  "MOD-001
          lv_credit_b_rub = lv_credit_b_rub + gt_bsid-cre_dmbtr_dc.
          gt_bsid-cre_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsid-cre_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF gt_bsid_tmp-waers = 'EUR'.
          gt_bsid-cre_dmbtr_dc_eur = gt_bsid-cre_dmbtr_dc.  "MOD-001
          lv_credit_b_eur = lv_credit_b_eur + gt_bsid-cre_dmbtr_dc.
          gt_bsid-cre_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-cre_dmbtr_dc_usd = 0.                     "MOD-001
        ELSEIF gt_bsid_tmp-waers = 'USD'.
          gt_bsid-cre_dmbtr_dc_usd = gt_bsid-cre_dmbtr_dc.  "MOD-001
          lv_credit_b_usd = lv_credit_b_usd + gt_bsid-cre_dmbtr_dc.
          gt_bsid-cre_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsid-cre_dmbtr_dc_eur = 0.                     "MOD-001
        ENDIF.
      ENDIF. "shkzg
    ENDIF.
*** MOD-001 * begin ***
*    ELSE.
*     Exchange rate shown for foreign  exchange accounts  HKONT = '0007960902' or HKONT = '0003960902'
*     Clearing document 'AB'
*      SELECT SINGLE kursf INTO gt_bsid-ukurs
*             FROM bkpf
*             WHERE bukrs = gt_bsid_tmp-bukrs
*               AND gjahr = gt_bsid_tmp-gjahr
*               AND belnr = gt_bsid_tmp-belnr.

    IF gt_bsid_tmp-blart = 'AB'.
      gt_bsid-ukurs = 0.
    ENDIF.
*** MOD-001 * end ***

*   Add Opening Balance Foreign Currency
*    lv_credit_b_rub = lv_credit_b_rub + lv_credit_o_rub.
*    lv_credit_b_eur = lv_credit_b_eur + lv_credit_o_eur.
*    lv_credit_b_usd = lv_credit_b_usd + lv_credit_o_usd.

    IF NOT lv_waerk IS INITIAL  AND
* Begin 23/09/2010
       ( gt_bsid_tmp-blart <> 'RV'  AND
         gt_bsid_tmp-blart <> 'AB'  AND                     "MOD-001
         gt_bsid_tmp-blart <> 'DR'  AND
         gt_bsid_tmp-blart <> 'DA'  AND
         gt_bsid_tmp-blart <> 'DG' ).
* End 23/09/2010.
*** MOD-001 * begin of review (see versions) ***
      CASE lv_waerk.
        WHEN 'RUB'.
          IF lv_first_rub = 'X'.   "add opening balance
            lv_bk_sal_rub = lv_bk_sal_rub + lv_op_sal_rub.
            gt_bsid-sal_amount_dc_rub = gt_bsid-sal_amount_dc_rub + lv_op_sal_rub.
            lv_first_rub = ' '.
          ENDIF.
          lv_bk_sal_rub = lv_bk_sal_rub + gt_bsid-deb_dmbtr_dc_rub +
                          ( gt_bsid-cre_dmbtr_dc_rub * ( -1 ) ).       "calculate booked total RUB
          gt_bsid-sal_amount_dc_rub = gt_bsid-sal_amount_dc_rub + gt_bsid-deb_dmbtr_dc_rub +
                                      ( gt_bsid-cre_dmbtr_dc_rub * ( -1 ) ). "calculate total RUB per line
        WHEN 'EUR'.
          IF lv_first_eur = 'X'.   "add opening balance
            lv_bk_sal_eur = lv_bk_sal_eur + lv_op_sal_eur. "calculate booked total EUR
            gt_bsid-sal_amount_dc_eur = gt_bsid-sal_amount_dc_eur + lv_op_sal_eur. "calculate total EUR per line
            lv_first_eur = ' '.
          ENDIF.
          lv_bk_sal_eur = lv_bk_sal_eur + gt_bsid-deb_dmbtr_dc_eur +
                          ( gt_bsid-cre_dmbtr_dc_eur * ( -1 ) ).       "calculate booked total EUR
          gt_bsid-sal_amount_dc_eur = gt_bsid-sal_amount_dc_eur + gt_bsid-deb_dmbtr_dc_eur +
                                      ( gt_bsid-cre_dmbtr_dc_eur * ( -1 ) ). "calculate total EUR per line
        WHEN 'USD'.
          IF lv_first_usd = 'X'.   "add opening balance
            lv_bk_sal_usd = lv_bk_sal_usd + lv_op_sal_usd. "calculate booked total USD
            gt_bsid-sal_amount_dc_usd = gt_bsid-sal_amount_dc_usd + lv_op_sal_usd. "calculate total USD per line
            lv_first_usd = ' '.
          ENDIF.
          lv_bk_sal_usd = lv_bk_sal_usd + gt_bsid-deb_dmbtr_dc_usd +
                          ( gt_bsid-cre_dmbtr_dc_usd * ( -1 ) ). "calculate booked total USD
          gt_bsid-sal_amount_dc_usd = gt_bsid-sal_amount_dc_usd + gt_bsid-deb_dmbtr_dc_usd +
                                      ( gt_bsid-cre_dmbtr_dc_usd * ( -1 ) ). "calculate total USD per line
        WHEN OTHERS.
      ENDCASE.
    ELSE.
      CASE gt_bsid_tmp-waers.
        WHEN 'RUB'.
          IF lv_first_rub = 'X'.   "add opening balance
            lv_bk_sal_rub = lv_bk_sal_rub + lv_op_sal_rub.
            gt_bsid-sal_amount_dc_rub = gt_bsid-sal_amount_dc_rub + lv_op_sal_rub.
            lv_first_rub = ' '.
          ENDIF.
          lv_bk_sal_rub = lv_bk_sal_rub + gt_bsid-deb_dmbtr_dc_rub +
                          ( gt_bsid-cre_dmbtr_dc_rub * ( -1 ) ).       "calculate booked total RUB
          gt_bsid-sal_amount_dc_rub = gt_bsid-sal_amount_dc_rub + gt_bsid-deb_dmbtr_dc_rub +
                                      ( gt_bsid-cre_dmbtr_dc_rub * ( -1 ) ). "calculate total RUB per line
        WHEN 'EUR'.
          IF lv_first_eur = 'X'.   "add opening balance
            lv_bk_sal_eur = lv_bk_sal_eur + lv_op_sal_eur. "calculate booked total EUR
            gt_bsid-sal_amount_dc_eur = gt_bsid-sal_amount_dc_eur + lv_op_sal_eur. "calculate total EUR per line
            lv_first_eur = ' '.
          ENDIF.
          lv_bk_sal_eur = lv_bk_sal_eur + gt_bsid-deb_dmbtr_dc_eur +
                          ( gt_bsid-cre_dmbtr_dc_eur * ( -1 ) ).       "calculate booked total EUR
          gt_bsid-sal_amount_dc_eur = gt_bsid-sal_amount_dc_eur + gt_bsid-deb_dmbtr_dc_eur +
                                      ( gt_bsid-cre_dmbtr_dc_eur * ( -1 ) ). "calculate total EUR per line
        WHEN 'USD'.
          IF lv_first_usd = 'X'.   "add opening balance
            lv_bk_sal_usd = lv_bk_sal_usd + lv_op_sal_usd. "calculate booked total USD
            gt_bsid-sal_amount_dc_usd = gt_bsid-sal_amount_dc_usd + lv_op_sal_usd. "calculate total USD per line
            lv_first_usd = ' '.
          ENDIF.
          lv_bk_sal_usd = lv_bk_sal_usd + gt_bsid-deb_dmbtr_dc_usd +
                          ( gt_bsid-cre_dmbtr_dc_usd * ( -1 ) ). "calculate booked total USD
          gt_bsid-sal_amount_dc_usd = gt_bsid-sal_amount_dc_usd + gt_bsid-deb_dmbtr_dc_usd +
                                      ( gt_bsid-cre_dmbtr_dc_usd * ( -1 ) ). "calculate total USD per line
        WHEN OTHERS.
      ENDCASE.
*** MOD-001 * end of review (see versions) ***

    ENDIF.

*   Grand Total Column 10(Saldo)
*       lv_bk_sal_for = lv_bk_sal_for + gt_bsid-DEB_dmbtr_dc + ( gt_bsid-cre_dmbtr_dc * ( -1 ) ). "calculate booked total FOR
*   Total per Currency Column 10(Saldo)
    IF NOT lv_waerk IS INITIAL  AND
* Begin 23/09/2010
       ( gt_bsid_tmp-blart <> 'RV'  AND
         gt_bsid_tmp-blart <> 'AB'  AND                     "MOD-001
         gt_bsid_tmp-blart <> 'DR'  AND
         gt_bsid_tmp-blart <> 'DA'  AND
         gt_bsid_tmp-blart <> 'DG' ).
* End 23/09/2010.
      IF lv_waerk = 'RUB'.
        gt_bsid-sal_dmbtr_dc =  gt_bsid-sal_amount_dc_rub.
        gt_bsid-sal_dmbtr_dc_rub =  gt_bsid-sal_amount_dc_rub. "MOD-001
      ELSEIF lv_waerk = 'EUR'.
        gt_bsid-sal_dmbtr_dc =  gt_bsid-sal_amount_dc_eur.
        gt_bsid-sal_dmbtr_dc_eur =  gt_bsid-sal_amount_dc_eur. "MOD-001
      ELSEIF lv_waerk = 'USD'.
        gt_bsid-sal_dmbtr_dc =  gt_bsid-sal_amount_dc_usd.
        gt_bsid-sal_dmbtr_dc_usd =  gt_bsid-sal_amount_dc_usd. "MOD-001
      ENDIF.
    ELSE.
      IF gt_bsid_tmp-waers = 'RUB'.
        gt_bsid-sal_dmbtr_dc =  gt_bsid-sal_amount_dc_rub.
        gt_bsid-sal_dmbtr_dc_rub =  gt_bsid-sal_amount_dc_rub. "MOD-001
      ELSEIF gt_bsid_tmp-waers = 'EUR'.
        gt_bsid-sal_dmbtr_dc =  gt_bsid-sal_amount_dc_eur.
        gt_bsid-sal_dmbtr_dc_eur =  gt_bsid-sal_amount_dc_eur. "MOD-001
      ELSEIF gt_bsid_tmp-waers = 'USD'.
        gt_bsid-sal_dmbtr_dc =  gt_bsid-sal_amount_dc_usd.
        gt_bsid-sal_dmbtr_dc_usd =  gt_bsid-sal_amount_dc_usd. "MOD-001
      ENDIF.
    ENDIF.

*** MOD-001 * begin ***
*    CONCATENATE gt_bsid_tmp-blart '/' gt_bsid_tmp-umskz '/' gt_bsid_tmp-belnr
*                INTO gt_bsid-belnr.
*    lv_ukurs = gt_bsid-ukurs.
*    CONCATENATE gt_bsid-xblnr '/' gt_bsid_tmp-xref1 '/' gt_bsid_tmp-xref2 '/' lv_zuonr '/' lv_ukurs
*                INTO gt_bsid-xblnr.
*** MOD-001 * end ***

    APPEND gt_bsid.
  ENDLOOP.

  IF lv_bk_sal IS INITIAL.
    lv_bk_sal = lv_op_sal.
  ENDIF.
  IF lv_bk_sal_usd IS INITIAL.
    lv_bk_sal_usd = lv_op_sal_usd.
  ENDIF.
  IF lv_bk_sal_eur IS INITIAL.
    lv_bk_sal_eur = lv_op_sal_eur.
  ENDIF.
  IF lv_bk_sal_rub IS INITIAL.
    lv_bk_sal_rub = lv_op_sal_rub.
  ENDIF.

ENDFORM.                    " select_bsid

*&---------------------------------------------------------------------*
*&      Form  output_list_bsid
*&---------------------------------------------------------------------*
*       Output the equipment list
*----------------------------------------------------------------------*
FORM output_list_bsid.

* Local variables
  DATA: ls_layout TYPE slis_layout_alv,
        ls_grid   TYPE lvc_s_glay,
        ls_events TYPE slis_alv_event.

  DATA: lt_events TYPE slis_t_event,
        lt_event_exits TYPE slis_t_event_exit,
        lt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA: lv_colpos  TYPE i.                                  "MOD-001

* Fill events
  REFRESH lt_events.
  ls_events-name = 'USER_COMMAND'.
  ls_events-form = 'USER_COMMAND_L'.
  APPEND ls_events TO lt_events.
  ls_events-name = 'PF_STATUS_SET'.
  ls_events-form = 'PF_STATUS_SET'.
  APPEND ls_events TO lt_events.
  ls_events-name = 'TOP_OF_PAGE'.
  ls_events-form = 'TOP_OF_PAGE_BSID'.
  APPEND ls_events TO lt_events.
  ls_events-form = ls_events-name = 'END_OF_LIST'.
  APPEND ls_events TO lt_events.

* Define layout
  CLEAR ls_layout.
*  ls_layout-box_fieldname        = 'SELECTED'.  "field for checkbox
  ls_layout-get_selinfos         = g_x. "show selection screen
  ls_layout-detail_popup         = g_x. "show detail via popup
  ls_layout-detail_initial_lines = g_x. "all fields in detail
  ls_layout-zebra                = g_x. "striped pattern
*  ls_layout-info_fieldname       = 'LINE_COLOR'.

* Define grid settings
* ls_grid-coll_end_l = gc_charx.

* Prepare field catalog
  DATA : ls_fcat TYPE slis_fieldcat_alv.
  DATA:  ls_sort TYPE slis_sortinfo_alv.

  CLEAR lv_colpos.                                          "MOD-001

**---------------------------document date in document----------------------------*
  ls_fcat-fieldname = 'BLDAT'.
  ls_fcat-seltext_m = ' .'(h1a).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'D'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * begin ***
**---------------------------posting date in document------------------*
  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-seltext_m = ' .'(h1b).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
  ls_fcat-inttype = 'D'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***
**--------------------------- Document Type Text ----------------------*
  ls_fcat-fieldname = 'DOC_TYPE'.
  ls_fcat-seltext_m = '. '(h23).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '15'.
*  ls_sort-spos = 1.
  ls_sort-fieldname = ls_fcat-fieldname.
*  ls_sort-up = 'X'.
*  APPEND ls_sort TO gt_sort.
*  ls_fcat-seltext_l = 'Document No'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*         ls_sort.
**--------------------------- Document number--------------------------*
  ls_fcat-fieldname = 'XBLNR2'.
  ls_fcat-seltext_m = '.'(h1c).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '16'.
*  ls_sort-spos = 1.
  ls_sort-fieldname = ls_fcat-fieldname.
*  ls_sort-up = 'X'.
*  APPEND ls_sort TO gt_sort.
*  ls_fcat-seltext_l = 'Document No'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*         ls_sort.
**---------------------------sales order-------------------------------*
*** MOD-001 * begin ***
*  ls_fcat-fieldname = 'AUBEL'.
*  ls_fcat-seltext_m = ' '.
*  ls_fcat-col_pos  = ls_fcat-col_pos + 1.
*  ls_fcat-inttype = 'C'.
*  ls_fcat-outputlen = '12'.
*  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat.
*** MOD-001 * end ***
**---------------------------Quotation Number--------------------------*
*** MOD-001 * begin ***
  ls_fcat-fieldname = 'ZUONR'.
  ls_fcat-seltext_m = ' '(h12).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '12'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***
**---------------------------Debit in local currency (RUB)-------------*
  ls_fcat-fieldname = 'DEB_DMBTR_LC'.
  ls_fcat-seltext_m = ' ()'(h13).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in local currency (RUB)------------*
  ls_fcat-fieldname = 'CRE_DMBTR_LC'.
  ls_fcat-seltext_m = ' ()'(h14).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in local currency (RUB)-------------*
  ls_fcat-fieldname = 'SAL_DMBTR_LC'.
  ls_fcat-seltext_m = ' ()'(h15).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Debit in document currency (EUR)----------*
  ls_fcat-fieldname = 'DEB_DMBTR_DC_EUR'.
  ls_fcat-seltext_m = ' ( )'(h1d).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in document currency (EUR)---------*
  ls_fcat-fieldname = 'CRE_DMBTR_DC_EUR'.
  ls_fcat-seltext_m = ' ( )'(h1e).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in document currency (EUR)----------*
  ls_fcat-fieldname = 'SAL_DMBTR_DC_EUR'.
  ls_fcat-seltext_m = 'Saldo ( )'(h1f).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * begin ***
**---------------------------Debit in document currency (USD)----------*
  ls_fcat-fieldname = 'DEB_DMBTR_DC_USD'.
  ls_fcat-seltext_m = ' ( .)'(h1g).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in document currency (USD)---------*
  ls_fcat-fieldname = 'CRE_DMBTR_DC_USD'.
  ls_fcat-seltext_m = ' ( .)'(h1h).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in document currency (USD)----------*
  ls_fcat-fieldname = 'SAL_DMBTR_DC_USD'.
  ls_fcat-seltext_m = 'Saldo ( .)'(h1i).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Debit in document currency (RUB)----------*
  ls_fcat-fieldname = 'DEB_DMBTR_DC_RUB'.
  ls_fcat-seltext_m = ' ( )'(h1j).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in document currency (RUB)---------*
  ls_fcat-fieldname = 'CRE_DMBTR_DC_RUB'.
  ls_fcat-seltext_m = ' ( )'(h1k).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in document currency (RUB)----------*
  ls_fcat-fieldname = 'SAL_DMBTR_DC_RUB'.
  ls_fcat-seltext_m = ' ( )'(h1l).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***
**---------------------------Secondary Currency (SO)-------------------*
  ls_fcat-fieldname = 'WAERS2'.
  ls_fcat-seltext_m = ''(h19).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Exchange Rate-----------------------------*
  ls_fcat-fieldname = 'UKURS'.
  ls_fcat-seltext_m = ''(h20).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'P'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * begin ***
**---------------------------Credit Control Area-----------------------*
  ls_fcat-fieldname = 'KKBER'.
  ls_fcat-seltext_m = 'Cred.Cntrl Area'(h1m).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '5'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Item Text (combined)----------------------*
  ls_fcat-fieldname = 'SGTXT'.
  ls_fcat-seltext_m = ''(h21).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '60'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Reference---------------------------------*
*  ls_fcat-fieldname = 'XBLNR'.
*  ls_fcat-seltext_m = ''.
*  ls_fcat-col_pos  = ls_fcat-col_pos + 1.
*  ls_fcat-outputlen = '40'.
*  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat.
**---------------------------FI Document Number-------------------------*
  ls_fcat-fieldname = 'BELNR'.
*  ls_fcat-seltext_m = ' '(h22).
  ls_fcat-seltext_m = 'FI-doc.nr.'(h29).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***

*  Begin of MOD-002
*  **---------------------------reference key2-------------------------*
    ls_fcat-fieldname = 'XREF2'.
  ls_fcat-seltext_m = 'Sales. order nr.'. "#EC NOTEXT
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*  *  End of MOD-002

*  IF MCONTAINER IS INITIAL .
*    CREATE OBJECT MCONTAINER
*                  EXPORTING
*                  CONTAINER_NAME = 'OVERVIEW' .
*
*    CREATE OBJECT MALV
*              EXPORTING I_PARENT = MCONTAINER.
*
*     GS_LAYOUT-SEL_MODE = 'X'.
*
*    CALL METHOD MALV->SET_TABLE_FOR_FIRST_DISPLAY
*           EXPORTING
*             IS_LAYOUT = GS_LAYOUT
*           CHANGING
*             IT_FIELDCATALOG = LT_fieldcat
*             IT_OUTTAB = gt_bsid[] .
*    ENDIF.

* Call ALV grid output
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program = 'YSE_RU_FI_ACT_RECONC'
*      i_structure_name   = 'YSE_ACT_RU'
*      i_grid_settings    = ls_grid
      is_layout          = ls_layout
      i_save             = 'A'
      it_fieldcat        = lt_fieldcat
      it_events          = lt_events
*      it_sort            = gt_sort
    TABLES
      t_outtab           = gt_bsid
    EXCEPTIONS
      program_error      = 1
      OTHERS             = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " output_list_bsid

*&---------------------------------------------------------------------*
*&      Form  add_message_to_log
*&---------------------------------------------------------------------*
*       Add a generated message to the application log
*----------------------------------------------------------------------*
FORM add_message_to_log .

* Local variables
  DATA: ls_msg TYPE bal_s_msg.

  MOVE-CORRESPONDING syst TO ls_msg.
  CALL FUNCTION 'BAL_LOG_MSG_ADD'
    EXPORTING
*     I_LOG_HANDLE              =
      i_s_msg                   = ls_msg
*   IMPORTING
*     E_S_MSG_HANDLE            =
*     E_MSG_WAS_LOGGED          =
*     E_MSG_WAS_DISPLAYED       =
    EXCEPTIONS
      log_not_found             = 1
      msg_inconsistent          = 2
      log_is_full               = 3
      OTHERS                    = 4
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* Flag log as having entries
  IF gv_log IS INITIAL.
    gv_log = gc_charx.
  ENDIF.

ENDFORM.                    " add_message_to_log

*&---------------------------------------------------------------------*
*&      Form  select_BSIK
*&---------------------------------------------------------------------*
*       Select vendor documents
*----------------------------------------------------------------------*
FORM select_bsik.

  DATA: BEGIN OF it_ebeln OCCURS 0,
          ebeln LIKE bseg-ebeln,
         END OF it_ebeln.

  CLEAR gt_doc[].

  gt_bsik-sal_dmbtr_dc = 0.
*** MOD-001 * begin ***
  gt_bsik-sal_dmbtr_lc = 0.
  gt_bsik-sal_dmbtr_dc_eur = 0.
  gt_bsik-sal_dmbtr_dc_usd = 0.
  gt_bsik-sal_dmbtr_dc_rub = 0.
*** MOD-001 * end ***

************************************************************************
* Opening Balance Bookings
************************************************************************
* Calculate bookings total (without opening balance)

  CLEAR: gt_clr_bsak[],
         lv_debit_o,                                        "MOD-001
         lv_credit_o.                                       "MOD-001

*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
*   Debit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_o
           FROM bsik
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat < s_bldat-low
             AND shkzg = 'S'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Credit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_o
           FROM bsik
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat < s_bldat-low
             AND shkzg = 'H'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Debit total clearing bookings (without opening balance)
    SELECT bukrs gjahr belnr shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsak
           FROM bsak
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND budat < s_bldat-low
             AND umskz <> 'F'.           "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
*   Debit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_o
           FROM bsik
*         WHERE lifnr EQ p_kunnr
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat < s_bldat-low
             AND shkzg = 'S'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Credit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_o
           FROM bsik
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat < s_bldat-low
             AND shkzg = 'H'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Debit total clearing bookings (without opening balance)
    SELECT bukrs gjahr belnr shkzg
* Begin 23/09/2010
           dmbtr
* End 23/09/2010
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsak
           FROM bsak
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND bldat < s_bldat-low
             AND umskz <> 'F'.           "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

  CLEAR gt_clr_bseg[].

*** MOD-001 * begin ***
* Get vendor lines for clearing documents (AB)
  CLEAR gt_doc[].
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_clr_bsak[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_clr_bsak
           WHERE bukrs =  gt_clr_bsak-bukrs
             AND belnr =  gt_clr_bsak-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_clr_bsak-gjahr
             AND koart =  'K'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_clr_bsak.
    IF gt_clr_bsak-belnr >= '0600000000'  AND
       gt_clr_bsak-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_clr_bsak-bukrs  AND
*           gt_doc-belnr = gt_clr_bsak-belnr  AND
*           gt_doc-gjahr = gt_clr_bsak-gjahr.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*
*      IF lv_check <> 'X'.
*        SELECT bukrs belnr gjahr shkzg dmbtr hkont
*               APPENDING CORRESPONDING FIELDS OF TABLE gt_clr_bseg
*               FROM bseg
*               WHERE bukrs = gt_clr_bsak-bukrs
*                 AND belnr = gt_clr_bsak-belnr
*                 AND gjahr = gt_clr_bsak-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_clr_bsak-bukrs
                                       gjahr = gt_clr_bsak-gjahr
                                       belnr = gt_clr_bsak-belnr.
      IF sy-subrc NE 0.
        CLEAR lv_dmbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_clr_bsak-bukrs
                                  AND gjahr = gt_clr_bsak-gjahr
                                  AND belnr = gt_clr_bsak-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_clr_bseg-bukrs = gt_clr_bsak-bukrs.
          gt_clr_bseg-belnr = gt_clr_bsak-belnr.
          gt_clr_bseg-gjahr = gt_clr_bsak-gjahr.
          gt_clr_bseg-dmbtr = ABS( lv_dmbtr ).
          IF lv_dmbtr < 0.
            gt_clr_bseg-shkzg = 'H'.
          ELSE.
            gt_clr_bseg-shkzg = 'S'.
          ENDIF.
          gt_clr_bseg-blart = 'AB'.
          APPEND gt_clr_bseg.
        ENDIF.
*** MOD-001 * end ***
        ws_doc-bukrs = gt_clr_bsak-bukrs.
        ws_doc-gjahr = gt_clr_bsak-gjahr.
        ws_doc-belnr = gt_clr_bsak-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.
    ELSE.
      gt_clr_bseg-bukrs = gt_clr_bsak-bukrs.
      gt_clr_bseg-belnr = gt_clr_bsak-belnr.
      gt_clr_bseg-gjahr = gt_clr_bsak-gjahr.
      gt_clr_bseg-shkzg = gt_clr_bsak-shkzg.
      gt_clr_bseg-dmbtr = gt_clr_bsak-dmbtr.
*      gt_clr_bseg-hkont = ' '.                             "MOD-001
      gt_clr_bseg-blart = gt_clr_bsak-blart.                "MOD-001
      APPEND gt_clr_bseg.
    ENDIF.

  ENDLOOP.

* 6-docs in BSIK(concerning exchange rate lines) should be removed
*LOOP AT gt_doc.
*    clear lv_dmbtr.
*    clear lv_shkzg.
*    select single dmbtr shkzg from bsik into (lv_dmbtr, lv_shkzg)
*      where bukrs = gt_doc-bukrs and
*            gjahr = gt_doc-gjahr and
*            belnr = gt_doc-belnr.
*    if lv_shkzg = 'S'.
*      lv_debit_o = lv_debit_o - lv_dmbtr.
*    else.
*      lv_credit_o = lv_credit_o - lv_dmbtr.
*    endif.
*ENDLOOP.

* Add lines of BSAK(with values of exchange rate lines in BSEG)
  LOOP AT gt_clr_bseg.
*** MOD-001 * begin ***
*    IF ( gt_clr_bseg-hkont = '0007960902'  OR
*         gt_clr_bseg-hkont = '0003960902' ). "BSEG values book opposite
*    IF gt_clr_bseg-blart = 'AB'.
*      IF gt_clr_bseg-shkzg = 'H'.
*        lv_debit_b = lv_debit_b + gt_clr_bseg-dmbtr.
*      ELSE.
*        lv_credit_b = lv_credit_b + gt_clr_bseg-dmbtr.
*      ENDIF.
*    ELSE.
*** MOD-001 * end ***
    IF gt_clr_bseg-shkzg = 'S'.
      lv_debit_o = lv_debit_o + gt_clr_bseg-dmbtr.
    ELSE.
      lv_credit_o = lv_credit_o + gt_clr_bseg-dmbtr.
    ENDIF.
*    ENDIF.                                                 "MOD-001
  ENDLOOP.
  lv_op_sal = lv_debit_o + ( lv_credit_o * ( -1 ) ).

******* Foreign ********

* Select records for ALV
*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
    SELECT blart belnr bukrs gjahr umskz bldat xref1 xref2
           dmbtr wrbtr shkzg waers budat
           INTO CORRESPONDING FIELDS OF TABLE gt_bsik_tmp_op
           FROM bsik
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3299999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat < s_bldat-low
             AND umskz <> 'F'. "Exclude Payment Requests

    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsak_tmp_op
             FROM bsak
             WHERE lifnr IN s_kunnr
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3299999999'
               AND budat < s_bldat-low
               AND umskz <> 'F'.         "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
    SELECT blart belnr bukrs gjahr umskz bldat xref1 xref2 dmbtr wrbtr shkzg waers
           budat                                            "MOD-001
           INTO CORRESPONDING FIELDS OF TABLE gt_bsik_tmp_op
           FROM bsik
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3299999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat < s_bldat-low
             AND umskz <> 'F'. "Exclude Payment Requests

*    SELECT blart bukrs gjahr buzei belnr umskz bldat xref1 xref2 waers
    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsak_tmp_op
             FROM bsak
*           WHERE lifnr EQ p_kunnr                          "MOD-001
             WHERE lifnr IN s_kunnr                         "MOD-001
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3299999999'
               AND bldat < s_bldat-low
               AND umskz <> 'F'.         "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

*** MOD-001 * begin ***
* Get vendor lines for clearing documents (AB)
  CLEAR gt_doc[].
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_bsak_tmp_op[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr wrbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_bsak_tmp_op
           WHERE bukrs =  gt_bsak_tmp_op-bukrs
             AND belnr =  gt_bsak_tmp_op-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_bsak_tmp_op-gjahr
             AND koart =  'K'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_bsak_tmp_op INTO gt_bsik_tmp_op.
    IF gt_bsik_tmp_op-belnr >= '0600000000'  AND
       gt_bsik_tmp_op-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_bsik_tmp_op-bukrs  AND
*           gt_doc-bukrs = gt_bsik_tmp_op-bukrs  AND
*           gt_doc-bukrs = gt_bsik_tmp_op-bukrs.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*
*      IF lv_check <> 'X'.
*        SELECT dmbtr wrbtr shkzg INTO CORRESPONDING FIELDS OF gt_bsik_tmp_op
*               FROM bseg
*               WHERE bukrs = gt_bsik_tmp_op-bukrs
*                 AND belnr = gt_bsik_tmp_op-belnr
*                 AND gjahr = gt_bsik_tmp_op-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).
*          IF gt_bsik_tmp_op-shkzg = 'H'.
*            gt_bsik_tmp_op-shkzg = 'S'.
*          ELSE.
*            gt_bsik_tmp_op-shkzg = 'H'.
*          ENDIF.

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_bsik_tmp_op-bukrs
                                       gjahr = gt_bsik_tmp_op-gjahr
                                       belnr = gt_bsik_tmp_op-belnr.
      IF sy-subrc NE 0.
        CLEAR: lv_dmbtr, lv_wrbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_bsik_tmp_op-bukrs
                                  AND gjahr = gt_bsik_tmp_op-gjahr
                                  AND belnr = gt_bsik_tmp_op-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr + gt_clr_bseg_tmp-wrbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr - gt_clr_bseg_tmp-wrbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_bsik_tmp_op-dmbtr = ABS( lv_dmbtr ).
          gt_bsik_tmp_op-wrbtr = ABS( lv_wrbtr ).
          IF lv_dmbtr < 0.
            gt_bsid_tmp_op-shkzg = 'H'.
          ELSE.
            gt_bsid_tmp_op-shkzg = 'S'.
          ENDIF.
          gt_bsid_tmp_op-blart = 'AB'.
*          gt_bsik_tmp_op-dmbtr = 0.
*** MOD-001 * end ***
          gt_bsik_tmp_op-xflg = 'X'.
          APPEND gt_bsik_tmp_op.
        ENDIF.                                              "MOD-001
*        ENDSELECT.                                         "MOD-001
*** MOD-001 * begin ***
        ws_doc-bukrs = gt_bsik_tmp_op-bukrs.
        ws_doc-gjahr = gt_bsik_tmp_op-gjahr.
        ws_doc-belnr = gt_bsik_tmp_op-belnr.
        INSERT ws_doc INTO TABLE gt_doc.
*** MOD-001 * end ***
      ENDIF.
      CLEAR gt_bsik_tmp_op.
    ELSE.
      APPEND gt_bsik_tmp_op.
    ENDIF.

  ENDLOOP.

* Remove the BSIk lines (which contain in BSEG the exchange rate lines)
*LOOP at gt_doc.
*  LOOP at gt_bsik_tmp_op.
*   l_tabix = sy-tabix.
*      if gt_bsik_tmp_op-bukrs = gt_doc-bukrs and gt_bsik_tmp_op-belnr = gt_doc-belnr and gt_bsik_tmp_op-gjahr = gt_doc-gjahr and gt_bsik_tmp_op-xflg <> 'X'.
*        DELETE gt_bsik_tmp_op index l_tabix.
*      endif.
*  ENDLOOP.
*ENDLOOP.

  SORT gt_bsik_tmp_op BY bldat.
  LOOP AT gt_bsik_tmp_op.

    CLEAR lv_xref2.
    IF gt_bsik_tmp_op-xref2 <> ' ' AND STRLEN( gt_bsik_tmp_op-xref2 ) < 11.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = gt_bsik_tmp_op-xref2
        IMPORTING
          output = lv_xref2.

*      CLEAR lv_aubel_o.                                    "MOD-001
*      lv_aubel_o = lv_xref2.                               "MOD-001

*       else.
*         select single vbel2 from bseg into lv_aubel_o
*           where vbel2 <> ' ' and
*            bukrs = gt_bsik_tmp_op-bukrs AND
*            belnr = gt_bsik_tmp_op-belnr AND
*            gjahr = gt_bsik_tmp_op-gjahr.
    ENDIF.
* Select the currency of the sales order.
*  clear lv_waerk.
*  select  single waerk from vbak into lv_waerk
*   where vbeln = lv_aubel_o.
* Select the currency of the purchase order.
    CLEAR lv_waerk.
    SELECT SINGLE waers INTO lv_waerk
           FROM ekko
*           WHERE ebeln = lv_aubel_o.                       "MOD-001
           WHERE ebeln = lv_xref2.                          "MOD-001

* Foreign Currency value
    IF lv_waerk IS NOT INITIAL  AND
* Begin 23/09/2010
       ( gt_bsik_tmp_op-blart <> 'KR'  AND
         gt_bsik_tmp_op-blart <> 'KA' ).
* End 23/09/2010

      CLEAR lv_date_c.
      CLEAR lv_date_bkpf.
      CLEAR lv_ukurs_o.

*          IF lv_waerk <> gt_bsid_tmp-waers.

      SELECT SINGLE bldat INTO lv_date_bkpf
             FROM bkpf
             WHERE belnr = gt_bsik_tmp_op-belnr
*               AND bukrs = 'MRUA'                          "MOD-001
               AND bukrs = p_bukrs                          "MOD-001
               AND gjahr = gt_bsik_tmp_op-gjahr.

      CONVERT INVERTED-DATE lv_date_bkpf INTO DATE lv_date_c .
      SELECT SINGLE ukurs INTO lv_ukurs_o
             FROM tcurr
             WHERE kurst = 'DRU'
               AND tcurr = 'RUB'
               AND fcurr = lv_waerk
               AND gdatu = lv_date_c.

      IF lv_ukurs_o IS INITIAL.
        CLEAR lv_gdatu.
        SELECT SINGLE MIN( gdatu ) INTO lv_gdatu
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu > lv_date_c.

        SELECT SINGLE ukurs INTO lv_ukurs_o
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu = lv_gdatu.
      ENDIF.
      IF gt_bsik_tmp_op-shkzg = 'S'.
        IF lv_waerk = 'RUB'.
          lv_ukurs_o = 1.
        ENDIF.
        IF lv_ukurs_o <> 0 AND gt_bsik_tmp_op-dmbtr <> 0.
          gt_bsik_tmp_op-dmbtr = gt_bsik_tmp_op-dmbtr / lv_ukurs_o.
        ENDIF.
        IF lv_waerk = 'RUB'.
          lv_debit_o_rub = lv_debit_o_rub + gt_bsik_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'EUR'.
          lv_debit_o_eur = lv_debit_o_eur + gt_bsik_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'USD'.
          lv_debit_o_usd = lv_debit_o_usd + gt_bsik_tmp_op-dmbtr.
        ENDIF.
      ELSEIF gt_bsik_tmp_op-shkzg = 'H'.
        IF lv_waerk = 'RUB'.
          lv_ukurs_o = 1.
        ENDIF.
        IF lv_ukurs_o <> 0 AND gt_bsik_tmp_op-dmbtr <> 0.
          gt_bsik_tmp_op-dmbtr = gt_bsik_tmp_op-dmbtr / lv_ukurs_o.
        ENDIF.
        IF lv_waerk = 'RUB'.
          lv_credit_o_rub = lv_credit_o_rub + gt_bsik_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'EUR'.
          lv_credit_o_eur = lv_credit_o_eur + gt_bsik_tmp_op-dmbtr.
        ELSEIF lv_waerk = 'USD'.
          lv_credit_o_usd = lv_credit_o_usd + gt_bsik_tmp_op-dmbtr.
        ENDIF.
      ENDIF. "shkzg
    ELSE.
      IF gt_bsik_tmp_op-shkzg = 'S'.
        gt_bsik_tmp_op-dmbtr = gt_bsik_tmp_op-wrbtr.
        IF gt_bsik_tmp_op-waers = 'RUB'.
          lv_debit_o_rub = lv_debit_o_rub + gt_bsik_tmp_op-dmbtr.
        ELSEIF gt_bsik_tmp_op-waers = 'EUR'.
          lv_debit_o_eur = lv_debit_o_eur + gt_bsik_tmp_op-dmbtr.
        ELSEIF gt_bsik_tmp_op-waers = 'USD'.
          lv_debit_o_usd = lv_debit_o_usd + gt_bsik_tmp_op-dmbtr.
        ENDIF.
      ELSEIF gt_bsik_tmp_op-shkzg = 'H'.
        gt_bsik_tmp_op-dmbtr = gt_bsik_tmp_op-wrbtr.
        IF gt_bsik_tmp_op-waers = 'RUB'.
          lv_credit_o_rub = lv_credit_o_rub + gt_bsik_tmp_op-dmbtr.
        ELSEIF gt_bsik_tmp_op-waers = 'EUR'.
          lv_credit_o_eur = lv_credit_o_eur + gt_bsik_tmp_op-dmbtr.
        ELSEIF gt_bsik_tmp_op-waers = 'USD'.
          lv_credit_o_usd = lv_credit_o_usd + gt_bsik_tmp_op-dmbtr.
        ENDIF.
      ENDIF. "shkzg
    ENDIF. "lv_waerk

  ENDLOOP.

  lv_op_sal_rub = lv_debit_o_rub + ( lv_credit_o_rub * ( -1 ) ).
  lv_op_sal_eur = lv_debit_o_eur + ( lv_credit_o_eur * ( -1 ) ).
  lv_op_sal_usd = lv_debit_o_usd + ( lv_credit_o_usd * ( -1 ) ).

************************************************************************
* Selected Bookings
************************************************************************
* Calculate bookings total (without opening balance)

  CLEAR: gt_clr_bsak[],
         lv_debit_b,                                        "MOD-001
         lv_credit_b.                                       "MOD-001

*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
*   Debit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_b
           FROM bsik
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat IN s_bldat
             AND shkzg = 'S'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Credit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_b
           FROM bsik
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat IN s_bldat
             AND shkzg = 'H'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Debit and Credit total clearing bookings (without opening balance)
    SELECT bukrs gjahr belnr shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsak
           FROM bsak
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND budat IN s_bldat
             AND umskz <> 'F'.           "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
*   Debit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_debit_b
           FROM bsik
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat IN s_bldat
             AND shkzg = 'S'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Credit total bookings (without opening balance)
    SELECT SINGLE SUM( dmbtr ) INTO lv_credit_b
           FROM bsik
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat IN s_bldat
             AND shkzg = 'H'
             AND umskz <> 'F'.           "Exclude Payment Requests

*   Add The opening Balance
*    lv_debit_b = lv_debit_b + lv_debit_o.
*    lv_credit_b = lv_credit_b + lv_credit_o.

*   Debit and Credit total clearing bookings (without opening balance)
    SELECT bukrs gjahr belnr shkzg
* Begin 23/09/2010
           dmbtr
* End 23/09/2010
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bsak
           FROM bsak
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND bldat IN s_bldat
             AND umskz <> 'F'.           "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

  CLEAR gt_clr_bseg[].
  CLEAR gt_doc[].

*** MOD-001 * begin ***
* Get vendor lines for clearing documents (AB)
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_clr_bsak[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_clr_bsak
           WHERE bukrs =  gt_clr_bsak-bukrs
             AND belnr =  gt_clr_bsak-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_clr_bsak-gjahr
             AND koart =  'K'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_clr_bsak.

    IF gt_clr_bsak-belnr >= '0600000000'  AND
       gt_clr_bsak-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_clr_bsak-bukrs  AND
*           gt_doc-gjahr = gt_clr_bsak-gjahr  AND
*           gt_doc-belnr = gt_clr_bsak-belnr.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*      IF lv_check <> 'X'.
*        SELECT bukrs belnr gjahr shkzg dmbtr hkont
*               APPENDING CORRESPONDING FIELDS OF TABLE gt_clr_bseg
*               FROM bseg
*               WHERE bukrs = gt_clr_bsak-bukrs
*                 AND belnr = gt_clr_bsak-belnr
*                 AND gjahr = gt_clr_bsak-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_clr_bsak-bukrs
                                       gjahr = gt_clr_bsak-gjahr
                                       belnr = gt_clr_bsak-belnr.
      IF sy-subrc NE 0.
        CLEAR lv_dmbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_clr_bsak-bukrs
                                  AND gjahr = gt_clr_bsak-gjahr
                                  AND belnr = gt_clr_bsak-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_clr_bseg-bukrs = gt_clr_bsak-bukrs.
          gt_clr_bseg-belnr = gt_clr_bsak-belnr.
          gt_clr_bseg-gjahr = gt_clr_bsak-gjahr.
          gt_clr_bseg-dmbtr = ABS( lv_dmbtr ).
          IF lv_dmbtr < 0.
            gt_clr_bseg-shkzg = 'H'.
          ELSE.
            gt_clr_bseg-shkzg = 'S'.
          ENDIF.
          gt_clr_bseg-blart = 'AB'.
          APPEND gt_clr_bseg.
        ENDIF.
*** MOD-001 * end ***
        ws_doc-bukrs = gt_clr_bsak-bukrs.
        ws_doc-gjahr = gt_clr_bsak-gjahr.
        ws_doc-belnr = gt_clr_bsak-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.
    ELSE.
      gt_clr_bseg-bukrs = gt_clr_bsak-bukrs.
      gt_clr_bseg-belnr = gt_clr_bsak-belnr.
      gt_clr_bseg-gjahr = gt_clr_bsak-gjahr.
      gt_clr_bseg-shkzg = gt_clr_bsak-shkzg.
      gt_clr_bseg-dmbtr = gt_clr_bsak-dmbtr.
*      gt_clr_bseg-hkont = ' '.                             "MOD-001
      gt_clr_bseg-blart = gt_clr_bsak-blart.                "MOD-001
      APPEND gt_clr_bseg.
    ENDIF.

  ENDLOOP.

* 6-docs in BSID(concerning exchange rate lines) should be removed
*LOOP AT gt_doc.
*    clear lv_dmbtr.
*    clear lv_shkzg.
*    select single dmbtr shkzg from bsik into (lv_dmbtr, lv_shkzg)
*      where bukrs = gt_doc-bukrs and
*            gjahr = gt_doc-gjahr and
*            belnr = gt_doc-belnr.
*    if lv_shkzg = 'S'.
*      lv_debit_b = lv_debit_b - lv_dmbtr.
*    else.
*      lv_credit_b = lv_credit_b - lv_dmbtr.
*    endif.
*ENDLOOP.

  LOOP AT gt_clr_bseg.
*** MOD-001 * begin ***
*    IF ( gt_clr_bseg-hkont = '0007960902'  OR
*         gt_clr_bseg-hkont =  '0003960902' ).
*    IF gt_clr_bseg-blart = 'AB'.
*      IF gt_clr_bseg-shkzg = 'H'.
*        lv_debit_b = lv_debit_b + gt_clr_bseg-dmbtr.
*      ELSE.
*        lv_credit_b = lv_credit_b + gt_clr_bseg-dmbtr.
*      ENDIF.
*    ELSE.
*** MOD-001 * end ***
    IF gt_clr_bseg-shkzg = 'S'.
      lv_debit_b = lv_debit_b + gt_clr_bseg-dmbtr.
    ELSE.
      lv_credit_b = lv_credit_b + gt_clr_bseg-dmbtr.
    ENDIF.
*    ENDIF.                                                 "MOD-001
  ENDLOOP.
* Closing Balance local currency (concerning columns 5,6,7)
  lv_bk_sal = lv_debit_b + ( lv_credit_b * ( -1 ) ) + lv_debit_o + ( lv_credit_o * ( -1 ) ).

* Select records for ALV
*** MOD-001 * begin ***
  IF p_postd = 'X'.          "Posting date
    SELECT blart  bukrs gjahr buzei umskz belnr bldat xref1 xref2
           dmbtr wrbtr shkzg waers budat
           INTO CORRESPONDING FIELDS OF TABLE gt_bsik_tmp
           FROM bsik
           WHERE lifnr IN s_kunnr
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND budat IN s_bldat
             AND umskz <> 'F'.           "Exclude Payment Requests

    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsak_tmp
             FROM bsak
             WHERE lifnr IN s_kunnr
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3199999999'
               AND budat IN s_bldat
               AND umskz <> 'F'.         "Exclude Payment Requests
  ELSE.                      "Document date
*** MOD-001 * end ***
    SELECT blart  bukrs gjahr buzei umskz belnr bldat xref1 xref2 dmbtr wrbtr shkzg waers
           budat                                            "MOD-001
           INTO CORRESPONDING FIELDS OF TABLE gt_bsik_tmp
           FROM bsik
*         WHERE lifnr EQ p_kunnr                            "MOD-001
           WHERE lifnr IN s_kunnr                           "MOD-001
             AND bukrs EQ p_bukrs
             AND belnr NOT BETWEEN '3000000000' AND '3199999999'
             AND belnr NOT BETWEEN '0600000000' AND '0699999999'
             AND bldat IN s_bldat
             AND umskz <> 'F'.           "Exclude Payment Requests

*  SELECT blart bukrs gjahr buzei belnr umskz bldat xref1 xref2 waers
    SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_bsak_tmp
             FROM bsak
*           WHERE lifnr EQ p_kunnr                          "MOD-001
             WHERE lifnr IN s_kunnr                         "MOD-001
               AND bukrs EQ p_bukrs
               AND belnr NOT BETWEEN '3000000000' AND '3199999999'
               AND bldat IN s_bldat
               AND umskz <> 'F'.         "Exclude Payment Requests
  ENDIF.                                                    "MOD-001

  CLEAR gt_doc[].

*** MOD-001 * begin ***
* Get vendor lines for clearing documents (AB)
  CLEAR gt_clr_bseg_tmp[].

  IF NOT gt_bsak_tmp[] IS INITIAL.
    SELECT bukrs belnr gjahr buzei shkzg dmbtr wrbtr
           INTO CORRESPONDING FIELDS OF TABLE gt_clr_bseg_tmp
           FROM bseg
           FOR ALL ENTRIES IN gt_bsak_tmp
           WHERE bukrs =  gt_bsak_tmp-bukrs
             AND belnr =  gt_bsak_tmp-belnr
             AND belnr >= '0600000000'
             AND belnr <= '0699999999'
             AND gjahr =  gt_bsak_tmp-gjahr
             AND koart =  'K'.
  ENDIF.
*** MOD-001 * end ***

  LOOP AT gt_bsak_tmp INTO gt_bsik_tmp.

    IF gt_bsik_tmp-belnr >= '0600000000'  AND
       gt_bsik_tmp-belnr <= '0699999999'.
*** MOD-001 * begin ***
*      CLEAR lv_check.
*      LOOP AT gt_doc.
*        IF gt_doc-bukrs = gt_bsik_tmp_op-bukrs  AND
*           gt_doc-belnr = gt_bsik_tmp_op-belnr  AND
*           gt_doc-gjahr = gt_bsik_tmp_op-gjahr.
*          lv_check = 'X'.
*        ENDIF.
*      ENDLOOP.
*
*      IF lv_check <> 'X'.
*        SELECT dmbtr wrbtr shkzg hkont
*               INTO CORRESPONDING FIELDS OF gt_bsik_tmp
*               FROM bseg
*               WHERE bukrs = gt_bsik_tmp-bukrs
*                 AND belnr = gt_bsik_tmp-belnr
*                 AND gjahr = gt_bsik_tmp-gjahr
*                 AND ( hkont = '0007960902' OR hkont = '0003960902' ).
*
*          IF gt_bsik_tmp-shkzg = 'H'.
*            gt_bsik_tmp-shkzg = 'S'.
*          ELSE.
*            gt_bsik_tmp-shkzg = 'H'.
*          ENDIF.

      READ TABLE gt_doc WITH TABLE KEY bukrs = gt_bsik_tmp-bukrs
                                       gjahr = gt_bsik_tmp-gjahr
                                       belnr = gt_bsik_tmp-belnr.
      IF sy-subrc NE 0.
        CLEAR: lv_dmbtr, lv_wrbtr.
        LOOP AT gt_clr_bseg_tmp WHERE bukrs = gt_bsik_tmp-bukrs
                                  AND gjahr = gt_bsik_tmp-gjahr
                                  AND belnr = gt_bsik_tmp-belnr.
          IF gt_clr_bseg_tmp-shkzg = 'S'.
            lv_dmbtr = lv_dmbtr + gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr + gt_clr_bseg_tmp-wrbtr.
          ELSE.
            lv_dmbtr = lv_dmbtr - gt_clr_bseg_tmp-dmbtr.
            lv_wrbtr = lv_wrbtr - gt_clr_bseg_tmp-wrbtr.
          ENDIF.
        ENDLOOP.
        IF lv_dmbtr NE 0.
          gt_bsik_tmp-dmbtr = ABS( lv_dmbtr ).
          gt_bsik_tmp-wrbtr = ABS( lv_wrbtr ).
          IF lv_dmbtr < 0.
            gt_bsik_tmp-shkzg = 'H'.
          ELSE.
            gt_bsik_tmp-shkzg = 'S'.
          ENDIF.
          gt_bsik_tmp-blart = 'AB'.
*** MOD-001 * end ***
          gt_bsik_tmp-xflg = 'X'.
          APPEND gt_bsik_tmp.
        ENDIF.                                              "MOD-001
*        ENDSELECT.                                         "MOD-001
        ws_doc-bukrs = gt_bsik_tmp-bukrs.
        ws_doc-gjahr = gt_bsik_tmp-gjahr.
        ws_doc-belnr = gt_bsik_tmp-belnr.
*        APPEND gt_doc.                                     "MOD-001
        INSERT ws_doc INTO TABLE gt_doc.                    "MOD-001
      ENDIF.
      CLEAR gt_bsik_tmp.
    ELSE.
      APPEND gt_bsik_tmp.
    ENDIF.
  ENDLOOP.

* Remove the BSIK lines (which contain in BSEG the exchange rate lines)
*LOOP at gt_doc.
*  LOOP at gt_bsik_tmp.
*   l_tabix = sy-tabix.
*      if gt_bsik_tmp-bukrs = gt_doc-bukrs and gt_bsik_tmp-belnr = gt_doc-belnr and gt_bsik_tmp-gjahr = gt_doc-gjahr and gt_bsik_tmp-xflg <> 'X'.
*        DELETE gt_bsik_tmp index l_tabix.
*      endif.
*  ENDLOOP.
*ENDLOOP.
*   if sy-subrc EQ 0.

  SORT gt_bsik_tmp BY bldat.

  LOOP AT gt_bsik_tmp.
*       clear gt_bsik.
    CLEAR: gt_bsik-bldat, gt_bsik-vbeln, gt_bsik-deb_dmbtr_lc, gt_bsik-cre_dmbtr_lc, gt_bsik-deb_dmbtr_dc,
           gt_bsik-cre_dmbtr_dc, gt_bsik-waers, gt_bsik-waers2, gt_bsik-ukurs, lv_xref2, gt_bsik-doc_type,
           gt_bsik-budat, lv_xblnr,                         "MOD-001
*** MOD-001 * begin ***
           gt_bsik-deb_dmbtr_dc_eur, gt_bsik-cre_dmbtr_dc_eur,
           gt_bsik-deb_dmbtr_dc_usd, gt_bsik-cre_dmbtr_dc_usd,
           gt_bsik-deb_dmbtr_dc_rub, gt_bsik-deb_dmbtr_dc_rub,
*** MOD-001 * end ***
* Begin 23/09/2010
*             gt_bsik-aubel.
           gt_bsik-xblnr2.
* End 23/09/2010
*** MOD-001 * begin ***
*    SELECT SINGLE zuonr INTO (lv_zuonr)
*           FROM bseg
*           WHERE bukrs = gt_bsik_tmp-bukrs
*             AND belnr = gt_bsik_tmp-belnr
*             AND gjahr = gt_bsik_tmp-gjahr
*             AND lifnr <> ' '.

*    IF gt_bsik_tmp-blart ='KR'.
*      gt_bsik-doc_type = text-d01.
*    ELSEIF gt_bsik_tmp-blart ='ZC'  OR
*           gt_bsik_tmp-blart ='ZP'  OR
*           gt_bsik_tmp-blart ='DZ'.
*      gt_bsik-doc_type = text-d02.
*    ELSEIF gt_bsik_tmp-blart ='RV'  OR
*           gt_bsik_tmp-blart ='DR'.
*      gt_bsik-doc_type = text-d03.
*    ELSE.
*      gt_bsik-doc_type = text-d04.
*    ENDIF.
    CASE gt_bsik_tmp-blart.
      WHEN 'KR' OR 'KG' OR 'RE'.
        gt_bsik-doc_type = text-d01.
      WHEN 'DZ' OR 'ZC' OR 'KZ' OR 'ZP' OR 'KA'.
        gt_bsik-doc_type = text-d02.
      WHEN 'DR' OR 'RV' OR 'DG' OR 'DA'.
        gt_bsik-doc_type = text-d03.
      WHEN 'AB'.
        gt_bsik-doc_type = text-d04.
      WHEN OTHERS.
    ENDCASE.
*** MOD-001 * end ***

    gt_bsik-bldat = gt_bsik_tmp-bldat.
    gt_bsik-budat = gt_bsik_tmp-budat.                      "MOD-001
    gt_bsik-belnr = gt_bsik_tmp-belnr.                      "MOD-001

*    SELECT SINGLE xblnr INTO gt_bsid-xblnr                 "MOD-001
    SELECT SINGLE xblnr INTO lv_xblnr                       "MOD-001
           FROM bkpf
           WHERE belnr = gt_bsik_tmp-belnr
*             AND bukrs = 'MRUA'                            "MOD-001
             AND bukrs = p_bukrs                            "MOD-001
             AND gjahr = gt_bsik_tmp-gjahr.

*** MOD-001 * begin ***
*    gt_bsik-xblnr2 = gt_bsik-xblnr.
    CASE gt_bsik_tmp-blart.
      WHEN 'KR' OR 'KG' OR 'RE' OR 'KZ' OR 'ZP' OR 'KA'.
        gt_bsik-xblnr2 = lv_xblnr.
      WHEN 'DR' OR 'RV' OR 'DG' OR 'DA' OR 'AB'.
        gt_bsik-xblnr2 = gt_bsik_tmp-belnr.
      WHEN 'DZ' OR 'ZC'.
        gt_bsik-xblnr2 = gt_bsik_tmp-xref1.
      WHEN OTHERS.
    ENDCASE.
*** MOD-001 * end ***

    CLEAR lv_ukurs.

    DATA: lv_len TYPE i.
    lv_len =  STRLEN( gt_bsik_tmp-xref2 ).
    IF gt_bsik_tmp-xref2 <> ' ' AND STRLEN( gt_bsik_tmp-xref2 ) < 11.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = gt_bsik_tmp-xref2
        IMPORTING
          output = lv_xref2.
    ENDIF.

    CLEAR: lv_ebeln, lv_ebelp, lv_belnr, lv_zuonr.
*
    SELECT SINGLE ebeln ebelp INTO (lv_ebeln, lv_ebelp)
           FROM bseg
           WHERE bukrs = gt_bsik_tmp-bukrs
             AND belnr = gt_bsik_tmp-belnr
             AND gjahr = gt_bsik_tmp-gjahr
             AND buzid = 'W'.
    IF lv_ebeln IS INITIAL.
      SELECT SINGLE ebeln ebelp INTO (lv_ebeln, lv_ebelp)
             FROM bseg
             WHERE bukrs = gt_bsik_tmp-bukrs
               AND belnr = gt_bsik_tmp-belnr
               AND gjahr = gt_bsik_tmp-gjahr
               AND buzid = 'M'.
    ENDIF.
* Begin 23/09/2010
*      select single belnr into (lv_belnr) from rseg
*      where ebeln = lv_ebeln and ebelp = lv_ebelp
*        and gjahr = gt_bsik_tmp-gjahr.
*
*        gt_bsik-aubel = lv_belnr.
    gt_bsik-vbeln =  gt_bsik_tmp-xref2.
*        gt_bsik-vbeln = lv_ebeln.
* End 23/09/2010

    IF gt_bsik_tmp-shkzg = 'S'.
      gt_bsik-deb_dmbtr_lc = gt_bsik_tmp-dmbtr.
      gt_bsik-cre_dmbtr_lc = 0.
    ELSEIF gt_bsik_tmp-shkzg = 'H'.
      gt_bsik-cre_dmbtr_lc = gt_bsik_tmp-dmbtr.
      gt_bsik-deb_dmbtr_lc = 0.
    ENDIF.

*   First time add opening balance...
    IF lv_first = 'X'.
      gt_bsik-sal_dmbtr_lc = gt_bsik-sal_dmbtr_lc + gt_bsik-deb_dmbtr_lc - gt_bsik-cre_dmbtr_lc + lv_op_sal.
*** MOD-001 * begin ***
      gt_bsik-sal_dmbtr_dc_rub = lv_op_sal_rub.
      gt_bsik-sal_dmbtr_dc_eur = lv_op_sal_eur.
      gt_bsik-sal_dmbtr_dc_usd = lv_op_sal_usd.
*** MOD-001 * end ***
      lv_first = ' ' .
    ELSE.
      gt_bsik-sal_dmbtr_lc = gt_bsik-sal_dmbtr_lc + gt_bsik-deb_dmbtr_lc - gt_bsik-cre_dmbtr_lc.
    ENDIF.


*   Select the  currency of the sales order.
    CLEAR lv_waerk.
    SELECT SINGLE waers INTO lv_waerk
           FROM ekko
           WHERE ebeln = lv_ebeln.

*   Foreign Currency
    IF lv_waerk IS NOT INITIAL  AND
* Begin 23/09/2010
       ( gt_bsik_tmp-blart <> 'KR'  AND
         gt_bsik_tmp-blart <> 'KA' ).
* End 23/09/2010
      IF lv_waerk = 'USD'.
        gt_bsik-waers = lv_waerk.
        gt_bsik-waers2 = text-h32.
      ELSEIF lv_waerk = 'EUR'.
        gt_bsik-waers = lv_waerk.
        gt_bsik-waers2 = text-h31.
      ELSE.
        SELECT SINGLE ktext waers INTO (gt_bsik-waers2, gt_bsik-waers)
               FROM tcurt
               WHERE spras = 'R'
                 AND waers = lv_waerk.
      ENDIF.
    ELSE.
      gt_bsik-waers = gt_bsik_tmp-waers.
      IF gt_bsik_tmp-waers = 'USD'.
        gt_bsik-waers2 = text-h32.
      ELSEIF gt_bsik_tmp-waers = 'EUR'.
        gt_bsik-waers2 = text-h31.
      ELSE.
        SELECT SINGLE ktext waers INTO (gt_bsik-waers2, gt_bsik-waers)
               FROM tcurt
               WHERE spras = 'R'
                 AND waers = gt_bsik_tmp-waers.
      ENDIF.
    ENDIF.

*   Foreign Currency Debit value
*** MOD-001 * begin ***
*    IF ( gt_bsik_tmp-hkont <> '0007960902'  AND
*         gt_bsik_tmp-hkont <> '0003960902' ).
    IF gt_bsid_tmp-blart <> 'AB'.
*** MOD-001 * end ***
      IF lv_waerk IS NOT INITIAL  AND
* Begin 23/09/2010
         ( gt_bsik_tmp-blart <> 'KR'  AND
           gt_bsik_tmp-blart <> 'KA' ).
* End 23/09/2010

        CLEAR lv_date_c.
        CLEAR lv_date_bkpf.
        SELECT SINGLE bldat INTO lv_date_bkpf
               FROM bkpf
               WHERE belnr = gt_bsik_tmp-belnr
*                 AND bukrs = 'MRUA'                        "MOD-001
                 AND bukrs = p_bukrs                        "MOD-001
                 AND gjahr = gt_bsik_tmp-gjahr.

        CONVERT INVERTED-DATE lv_date_bkpf INTO DATE lv_date_c .
        SELECT SINGLE ukurs INTO gt_bsik-ukurs
               FROM tcurr
               WHERE kurst = 'DRU'
                 AND tcurr = 'RUB'
                 AND fcurr = lv_waerk
                 AND gdatu = lv_date_c.

        IF gt_bsik-ukurs IS INITIAL.
          CLEAR lv_gdatu.
          SELECT SINGLE MIN( gdatu ) INTO lv_gdatu
                 FROM tcurr
                 WHERE kurst = 'DRU'
                   AND tcurr = 'RUB'
                   AND fcurr = lv_waerk
                   AND gdatu > lv_date_c.

          SELECT SINGLE ukurs INTO gt_bsik-ukurs
                 FROM tcurr
                 WHERE kurst = 'DRU'
                   AND tcurr = 'RUB'
                   AND fcurr = lv_waerk
                   AND gdatu = lv_gdatu.
        ENDIF.

        IF gt_bsik_tmp-shkzg = 'S'.
          IF lv_waerk = 'RUB'.
            gt_bsik-ukurs = 1.
          ENDIF.
          gt_bsik-deb_dmbtr_dc = gt_bsik-deb_dmbtr_lc.      "MOD-001
          IF gt_bsik-ukurs <> 0.
            gt_bsik-deb_dmbtr_dc = gt_bsik-deb_dmbtr_lc / gt_bsik-ukurs.
          ENDIF.
          gt_bsik-cre_dmbtr_dc = 0.
          gt_bsik-cre_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsik-cre_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsik-cre_dmbtr_dc_usd = 0.                     "MOD-001
          IF lv_waerk = 'RUB'.
            gt_bsik-deb_dmbtr_dc_rub = gt_bsik-deb_dmbtr_dc. "MOD-001
            lv_debit_b_rub = lv_debit_b_rub + gt_bsik-deb_dmbtr_dc.
            gt_bsik-deb_dmbtr_dc_eur = 0.                   "MOD-001
            gt_bsik-deb_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF lv_waerk = 'EUR'.
            gt_bsik-deb_dmbtr_dc_eur = gt_bsik-deb_dmbtr_dc. "MOD-001
            lv_debit_b_eur = lv_debit_b_eur + gt_bsik-deb_dmbtr_dc.
            gt_bsik-deb_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-deb_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF lv_waerk = 'USD'.
            gt_bsik-deb_dmbtr_dc_usd = gt_bsik-deb_dmbtr_dc. "MOD-001
            lv_debit_b_usd = lv_debit_b_usd + gt_bsik-deb_dmbtr_dc.
            gt_bsik-deb_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-deb_dmbtr_dc_eur = 0.                   "MOD-001
          ENDIF.
        ELSEIF gt_bsik_tmp-shkzg = 'H'.
          IF lv_waerk = 'RUB'.
            gt_bsik-ukurs = 1.
          ENDIF.
          gt_bsik-cre_dmbtr_dc = gt_bsik-cre_dmbtr_lc.      "MOD-001
          IF gt_bsik-ukurs <> 0.
            gt_bsik-cre_dmbtr_dc = gt_bsik-cre_dmbtr_lc / gt_bsik-ukurs.
          ENDIF.
          gt_bsik-deb_dmbtr_dc = 0.
          gt_bsik-deb_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsik-deb_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsik-deb_dmbtr_dc_usd = 0.                     "MOD-001
          IF lv_waerk = 'RUB'.
            gt_bsik-cre_dmbtr_dc_rub = gt_bsik-cre_dmbtr_dc. "MOD-001
            lv_credit_b_rub = lv_credit_b_rub + gt_bsik-cre_dmbtr_dc.
            gt_bsik-cre_dmbtr_dc_eur = 0.                   "MOD-001
            gt_bsik-cre_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF lv_waerk = 'EUR'.
            gt_bsik-cre_dmbtr_dc_eur = gt_bsik-cre_dmbtr_dc. "MOD-001
            lv_credit_b_eur = lv_credit_b_eur + gt_bsik-cre_dmbtr_dc.
            gt_bsik-cre_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-cre_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF lv_waerk = 'USD'.
            gt_bsid-cre_dmbtr_dc_usd = gt_bsid-cre_dmbtr_dc. "MOD-001
            lv_credit_b_usd = lv_credit_b_usd + gt_bsik-cre_dmbtr_dc.
            gt_bsik-cre_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-cre_dmbtr_dc_eur = 0.                   "MOD-001
          ENDIF.
        ENDIF.
      ELSE.
        SELECT SINGLE kursf INTO gt_bsik-ukurs
               FROM bkpf
               WHERE bukrs = gt_bsik_tmp-bukrs
                 AND gjahr = gt_bsik_tmp-gjahr
                 AND belnr = gt_bsik_tmp-belnr.

        IF gt_bsik_tmp-shkzg = 'S'.
          gt_bsik-deb_dmbtr_dc  = gt_bsik_tmp-wrbtr.
          gt_bsik-cre_dmbtr_dc = 0.
          gt_bsik-cre_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsik-cre_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsik-cre_dmbtr_dc_usd = 0.                     "MOD-001
          IF gt_bsik_tmp-waers = 'RUB'.
            gt_bsik-deb_dmbtr_dc_rub = gt_bsik-deb_dmbtr_dc. "MOD-001
            lv_debit_b_rub = lv_debit_b_rub + gt_bsik-deb_dmbtr_dc .
            gt_bsik-deb_dmbtr_dc_eur = 0.                   "MOD-001
            gt_bsik-deb_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF gt_bsik_tmp-waers = 'EUR'.
            gt_bsik-deb_dmbtr_dc_eur = gt_bsik-deb_dmbtr_dc. "MOD-001
            lv_debit_b_eur = lv_debit_b_eur + gt_bsik-deb_dmbtr_dc .
            gt_bsik-deb_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-deb_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF gt_bsik_tmp-waers = 'USD'.
            gt_bsik-deb_dmbtr_dc_usd = gt_bsik-deb_dmbtr_dc. "MOD-001
            lv_debit_b_usd = lv_debit_b_usd + gt_bsik-deb_dmbtr_dc .
            gt_bsik-deb_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-deb_dmbtr_dc_eur = 0.                   "MOD-001
          ENDIF.
        ELSEIF gt_bsik_tmp-shkzg = 'H'.
          gt_bsik-cre_dmbtr_dc = gt_bsik_tmp-wrbtr.
          gt_bsik-deb_dmbtr_dc = 0.
          gt_bsik-deb_dmbtr_dc_rub = 0.                     "MOD-001
          gt_bsik-deb_dmbtr_dc_eur = 0.                     "MOD-001
          gt_bsik-deb_dmbtr_dc_usd = 0.                     "MOD-001
          IF gt_bsik_tmp-waers = 'RUB'.
            gt_bsik-cre_dmbtr_dc_rub = gt_bsik-cre_dmbtr_dc. "MOD-001
            lv_credit_b_rub = lv_credit_b_rub + gt_bsik-cre_dmbtr_dc.
            gt_bsik-cre_dmbtr_dc_eur = 0.                   "MOD-001
            gt_bsik-cre_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF gt_bsik_tmp-waers = 'EUR'.
            gt_bsik-cre_dmbtr_dc_eur = gt_bsik-cre_dmbtr_dc. "MOD-001
            lv_credit_b_eur = lv_credit_b_eur + gt_bsik-cre_dmbtr_dc.
            gt_bsik-cre_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-cre_dmbtr_dc_usd = 0.                   "MOD-001
          ELSEIF gt_bsik_tmp-waers = 'USD'.
            gt_bsik-cre_dmbtr_dc_usd = gt_bsik-cre_dmbtr_dc. "MOD-001
            lv_credit_b_usd = lv_credit_b_usd + gt_bsik-cre_dmbtr_dc.
            gt_bsik-cre_dmbtr_dc_rub = 0.                   "MOD-001
            gt_bsik-cre_dmbtr_dc_eur = 0.                   "MOD-001
          ENDIF.
        ENDIF. "shkzg
      ENDIF.
    ELSE.
* Exchange rate need to be shown for HKONT = '0007960902' or HKONT = '0003960902'
*     Clearing document 'AB'                                "MOD-001
      SELECT SINGLE kursf INTO gt_bsik-ukurs
             FROM bkpf
             WHERE bukrs = gt_bsik_tmp-bukrs
               AND gjahr = gt_bsik_tmp-gjahr
               AND belnr = gt_bsik_tmp-belnr.
    ENDIF. "  ( HKONT = '0007960902' or HKONT = '0003960902' )
** Add Opening Balance Foreign Currency
*    lv_credit_b_rub = lv_credit_b_rub + lv_credit_o_rub.
*    lv_credit_b_eur = lv_credit_b_eur + lv_credit_o_eur.
*    lv_credit_b_usd = lv_credit_b_usd + lv_credit_o_usd.

    IF NOT lv_waerk IS INITIAL  AND
* Begin 23/09/2010
       ( gt_bsik_tmp-blart <> 'KR'  AND
         gt_bsik_tmp-blart <> 'KA' ).
* End 23/09/2010
*** MOD-001 * begin of review (see versions) ***
      CASE lv_waerk.
        WHEN 'RUB'.
          IF lv_first_rub = 'X'.   "add opening balance
            lv_bk_sal_rub = lv_bk_sal_rub + lv_op_sal_rub.
            gt_bsik-sal_amount_dc_rub = gt_bsik-sal_amount_dc_rub + lv_op_sal_rub.
            lv_first_rub = ' '.
          ENDIF.
          lv_bk_sal_rub = lv_bk_sal_rub + gt_bsik-deb_dmbtr_dc_rub +
                          ( gt_bsik-cre_dmbtr_dc_rub * ( -1 ) ).       "calculate booked total RUB
          gt_bsik-sal_amount_dc_rub = gt_bsik-sal_amount_dc_rub + gt_bsik-deb_dmbtr_dc_rub +
                                      ( gt_bsik-cre_dmbtr_dc_rub * ( -1 ) ). "calculate total RUB per line
        WHEN 'EUR'.
          IF lv_first_eur = 'X'.   "add opening balance
            lv_bk_sal_eur = lv_bk_sal_eur + lv_op_sal_eur. "calculate booked total EUR
            gt_bsik-sal_amount_dc_eur = gt_bsik-sal_amount_dc_eur + lv_op_sal_eur. "calculate total EUR per line
            lv_first_eur = ' '.
          ENDIF.
          lv_bk_sal_eur = lv_bk_sal_eur + gt_bsik-deb_dmbtr_dc_eur +
                          ( gt_bsik-cre_dmbtr_dc_eur * ( -1 ) ).       "calculate booked total EUR
          gt_bsik-sal_amount_dc_eur = gt_bsik-sal_amount_dc_eur + gt_bsik-deb_dmbtr_dc_eur +
                                      ( gt_bsik-cre_dmbtr_dc_eur * ( -1 ) ). "calculate total EUR per line
        WHEN 'USD'.
          IF lv_first_usd = 'X'.   "add opening balance
            lv_bk_sal_usd = lv_bk_sal_usd + lv_op_sal_usd. "calculate booked total USD
            gt_bsik-sal_amount_dc_usd = gt_bsik-sal_amount_dc_usd + lv_op_sal_usd. "calculate total USD per line
            lv_first_usd = ' '.
          ENDIF.
          lv_bk_sal_usd = lv_bk_sal_usd + gt_bsik-deb_dmbtr_dc_usd +
                          ( gt_bsik-cre_dmbtr_dc_usd * ( -1 ) ). "calculate booked total USD
          gt_bsik-sal_amount_dc_usd = gt_bsik-sal_amount_dc_usd + gt_bsik-deb_dmbtr_dc_usd +
                                      ( gt_bsik-cre_dmbtr_dc_usd * ( -1 ) ). "calculate total USD per line
        WHEN OTHERS.
      ENDCASE.
    ELSE.
      CASE gt_bsid_tmp-waers.
        WHEN 'RUB'.
          IF lv_first_rub = 'X'.   "add opening balance
            lv_bk_sal_rub = lv_bk_sal_rub + lv_op_sal_rub.
            gt_bsik-sal_amount_dc_rub = gt_bsik-sal_amount_dc_rub + lv_op_sal_rub.
            lv_first_rub = ' '.
          ENDIF.
          lv_bk_sal_rub = lv_bk_sal_rub + gt_bsik-deb_dmbtr_dc_rub +
                          ( gt_bsik-cre_dmbtr_dc_rub * ( -1 ) ).       "calculate booked total RUB
          gt_bsik-sal_amount_dc_rub = gt_bsik-sal_amount_dc_rub + gt_bsik-deb_dmbtr_dc_rub +
                                      ( gt_bsik-cre_dmbtr_dc_rub * ( -1 ) ). "calculate total RUB per line
        WHEN 'EUR'.
          IF lv_first_eur = 'X'.   "add opening balance
            lv_bk_sal_eur = lv_bk_sal_eur + lv_op_sal_eur. "calculate booked total EUR
            gt_bsik-sal_amount_dc_eur = gt_bsik-sal_amount_dc_eur + lv_op_sal_eur. "calculate total EUR per line
            lv_first_eur = ' '.
          ENDIF.
          lv_bk_sal_eur = lv_bk_sal_eur + gt_bsik-deb_dmbtr_dc_eur +
                          ( gt_bsid-cre_dmbtr_dc_eur * ( -1 ) ).       "calculate booked total EUR
          gt_bsik-sal_amount_dc_eur = gt_bsik-sal_amount_dc_eur + gt_bsik-deb_dmbtr_dc_eur +
                                      ( gt_bsik-cre_dmbtr_dc_eur * ( -1 ) ). "calculate total EUR per line
        WHEN 'USD'.
          IF lv_first_usd = 'X'.   "add opening balance
            lv_bk_sal_usd = lv_bk_sal_usd + lv_op_sal_usd. "calculate booked total USD
            gt_bsik-sal_amount_dc_usd = gt_bsik-sal_amount_dc_usd + lv_op_sal_usd. "calculate total USD per line
            lv_first_usd = ' '.
          ENDIF.
          lv_bk_sal_usd = lv_bk_sal_usd + gt_bsid-deb_dmbtr_dc_usd +
                          ( gt_bsik-cre_dmbtr_dc_usd * ( -1 ) ). "calculate booked total USD
          gt_bsik-sal_amount_dc_usd = gt_bsik-sal_amount_dc_usd + gt_bsik-deb_dmbtr_dc_usd +
                                      ( gt_bsik-cre_dmbtr_dc_usd * ( -1 ) ). "calculate total USD per line
        WHEN OTHERS.
      ENDCASE.
*** MOD-001 * end of review (see versions) ***

    ENDIF.

*   Grand total column 10(Saldo)
*       lv_bk_sal_for = lv_bk_sal_for + gt_bsik-DEB_dmbtr_dc + ( gt_bsik-cre_dmbtr_dc * ( -1 ) ). "calculate booked total FOR
*   Total per Currency for column 10(Saldo)
    IF NOT lv_waerk IS INITIAL  AND
* Begin 23/09/2010
       ( gt_bsik_tmp-blart <> 'KR'  AND
         gt_bsik_tmp-blart <> 'KA' ).
* End 23/09/2010

      IF lv_waerk = 'RUB'.
        gt_bsik-sal_dmbtr_dc =  gt_bsik-sal_amount_dc_rub.
        gt_bsik-sal_dmbtr_dc_rub =  gt_bsik-sal_amount_dc_rub. "MOD-001
      ELSEIF lv_waerk = 'EUR'.
        gt_bsik-sal_dmbtr_dc =  gt_bsik-sal_amount_dc_eur.
        gt_bsik-sal_dmbtr_dc_eur =  gt_bsik-sal_amount_dc_eur. "MOD-001
      ELSEIF lv_waerk = 'USD'.
        gt_bsik-sal_dmbtr_dc =  gt_bsik-sal_amount_dc_usd.
        gt_bsik-sal_dmbtr_dc_usd =  gt_bsik-sal_amount_dc_usd. "MOD-001
      ENDIF.
    ELSE.
      IF gt_bsik_tmp-waers = 'RUB'.
        gt_bsik-sal_dmbtr_dc =  gt_bsik-sal_amount_dc_rub.
        gt_bsik-sal_dmbtr_dc_rub =  gt_bsik-sal_amount_dc_rub. "MOD-001
      ELSEIF gt_bsik_tmp-waers = 'EUR'.
        gt_bsik-sal_dmbtr_dc =  gt_bsik-sal_amount_dc_eur.
        gt_bsik-sal_dmbtr_dc_eur =  gt_bsik-sal_amount_dc_eur. "MOD-001
      ELSEIF gt_bsik_tmp-waers = 'USD'.
        gt_bsik-sal_dmbtr_dc =  gt_bsik-sal_amount_dc_usd.
        gt_bsik-sal_dmbtr_dc_usd =  gt_bsik-sal_amount_dc_usd. "MOD-001
      ENDIF.
    ENDIF.

*** MOD-001 * begin ***
*    CONCATENATE  gt_bsik_tmp-blart '/' gt_bsik_tmp-umskz '/' gt_bsik_tmp-belnr
*                 INTO gt_bsik-belnr.
*    lv_ukurs = gt_bsik-ukurs.
*    CONCATENATE gt_bsik-xblnr '/' gt_bsik_tmp-xref1 '/' gt_bsik_tmp-xref2 '/' lv_zuonr '/' lv_ukurs
*                INTO gt_bsik-xblnr.
*** MOD-001 * end ***

     gt_bsik-xref2 = gt_bsik_tmp-xref2. " MOD-002
    APPEND gt_bsik.

  ENDLOOP.

  IF lv_bk_sal IS INITIAL.
    lv_bk_sal = lv_op_sal.
  ENDIF.
  IF lv_bk_sal_usd IS INITIAL.
    lv_bk_sal_usd = lv_op_sal_usd.
  ENDIF.
  IF lv_bk_sal_eur IS INITIAL.
    lv_bk_sal_eur = lv_op_sal_eur.
  ENDIF.
  IF lv_bk_sal_rub IS INITIAL.
    lv_bk_sal_rub = lv_op_sal_rub.
  ENDIF.
*    endif.

ENDFORM.                    " select_bsik

*&---------------------------------------------------------------------*
*&      Form  output_list_bsik
*&---------------------------------------------------------------------*
*       Output the equipment list
*----------------------------------------------------------------------*
FORM output_list_bsik.

* Local variables
  DATA: ls_layout TYPE slis_layout_alv,
        ls_grid   TYPE lvc_s_glay,
        ls_events TYPE slis_alv_event.

  DATA: lt_events TYPE slis_t_event,
        lt_event_exits TYPE slis_t_event_exit,
        lt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA: lv_colpos  TYPE i.                                  "MOD-001

* Fill events
  REFRESH lt_events.
  ls_events-name = 'USER_COMMAND'.
  ls_events-form = 'USER_COMMAND_L'.
  APPEND ls_events TO lt_events.
  ls_events-name = 'PF_STATUS_SET'.
  ls_events-form = 'PF_STATUS_SET'.
  APPEND ls_events TO lt_events.
  ls_events-name = 'TOP_OF_PAGE'.
  ls_events-form = 'TOP_OF_PAGE_BSID'.
  APPEND ls_events TO lt_events.
  ls_events-form = ls_events-name = 'END_OF_LIST'.
  APPEND ls_events TO lt_events.

* Define layout
  CLEAR ls_layout.
*  ls_layout-box_fieldname        = 'SELECTED'.  "field for checkbox
  ls_layout-get_selinfos         = g_x. "show selection screen
  ls_layout-detail_popup         = g_x. "show detail via popup
  ls_layout-detail_initial_lines = g_x. "all fields in detail
  ls_layout-zebra                = g_x. "striped pattern
*  ls_layout-info_fieldname       = 'LINE_COLOR'.

* Define grid settings
* ls_grid-coll_end_l = gc_charx.

* Prepare field catalog
  DATA : ls_fcat TYPE slis_fieldcat_alv.
  DATA:  ls_sort TYPE slis_sortinfo_alv.

  CLEAR lv_colpos.                                    "MOD-001

**---------------------------document date in document-----------------*
  ls_fcat-fieldname = 'BLDAT'.
  ls_fcat-seltext_m = ' .'(h1a).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'D'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * begin ***
**---------------------------posting date in document------------------*
  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-seltext_m = ' .'(h1b).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
  ls_fcat-inttype = 'D'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***
**--------------------------- Document Type Text ----------------------*
  ls_fcat-fieldname = 'DOC_TYPE'.
  ls_fcat-seltext_m = '. '(h23).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '15'.
*  ls_sort-spos = 1.
  ls_sort-fieldname = ls_fcat-fieldname.
*  ls_sort-up = 'X'.
*  APPEND ls_sort TO gt_sort.
*  ls_fcat-seltext_l = 'Document No'.
  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat,
*         ls_sort.
**--------------------------- Invoice Document number------------------*
  ls_fcat-fieldname = 'XBLNR2'.
  ls_fcat-seltext_m = '.'(h1c).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '16'.
*  ls_sort-spos = 1.
  ls_sort-fieldname = ls_fcat-fieldname.
*  ls_sort-up = 'X'.
*  APPEND ls_sort TO gt_sort.
*  ls_fcat-seltext_l = 'Document No'.
  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat,
*         ls_sort.
**---------------------------sales order-------------------------------*
*** MOD-001 * begin ***
*  ls_fcat-fieldname = 'VBELN'.
*  ls_fcat-seltext_m = ' '.
*  ls_fcat-col_pos  = ls_fcat-col_pos + 1.
*  ls_fcat-inttype = 'C'.
*  ls_fcat-outputlen = '12'.
*  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat.
*** MOD-001 * end ***
**---------------------------Debit in local currency (RUB)-------------*
  ls_fcat-fieldname = 'DEB_DMBTR_LC'.
  ls_fcat-seltext_m = ' ()'(h13).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in local currency (RUB)------------*
  ls_fcat-fieldname = 'CRE_DMBTR_LC'.
  ls_fcat-seltext_m = ' ()'(h14).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in local currency (RUB)-------------*
  ls_fcat-fieldname = 'SAL_DMBTR_LC'.
  ls_fcat-seltext_m = ' ()'(h15).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Debit in document currency (EUR)----------*
  ls_fcat-fieldname = 'DEB_DMBTR_DC_EUR'.
  ls_fcat-seltext_m = ' ( )'(h1d).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in document currency (EUR)---------*
  ls_fcat-fieldname = 'CRE_DMBTR_DC_EUR'.
  ls_fcat-seltext_m = ' ( )'(h1e).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in document currency (EUR)----------*
  ls_fcat-fieldname = 'SAL_DMBTR_DC_EUR'.
  ls_fcat-seltext_m = ' ( )'(h1f).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * begin ***
**---------------------------Debit in document currency (USD)----------*
  ls_fcat-fieldname = 'DEB_DMBTR_DC_USD'.
  ls_fcat-seltext_m = ' ( .)'(h1g).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in document currency (USD)---------*
  ls_fcat-fieldname = 'CRE_DMBTR_DC_USD'.
  ls_fcat-seltext_m = ' ( .)'(h1h).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in document currency (USD)----------*
  ls_fcat-fieldname = 'SAL_DMBTR_DC_USD'.
  ls_fcat-seltext_m = ' ( .)'(h1i).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Debit in document currency (RUB)----------*
  ls_fcat-fieldname = 'DEB_DMBTR_DC_RUB'.
  ls_fcat-seltext_m = ' ( )'(h1j).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Credit in document currency (RUB)---------*
  ls_fcat-fieldname = 'CRE_DMBTR_DC_RUB'.
  ls_fcat-seltext_m = ' ( )'(h1k).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
**---------------------------Saldo in document currency (RUB)----------*
  ls_fcat-fieldname = 'SAL_DMBTR_DC_RUB'.
  ls_fcat-seltext_m = ' ( )'(h1l).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '20'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***
**---------------------------Secondary Currency------------------------*
  ls_fcat-fieldname = 'WAERS2'.
  ls_fcat-seltext_m = ''(h19).
  lv_colpos = lv_colpos + 1.                                "MOD-001
  ls_fcat-col_pos  = lv_colpos.                             "MOD-001
  ls_fcat-inttype = 'C'.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * begin ***
**---------------------------Exchange Rate-----------------------------*
*  ls_fcat-fieldname = 'UKURS'.
*  ls_fcat-seltext_m = ''(h20).
*  ls_fcat-col_pos  = ls_fcat-col_pos + 1.
*  ls_fcat-outputlen = '10'.
*  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat.
**---------------------------Reference---------------------------------*
*  ls_fcat-fieldname = 'XBLNR'.
*  ls_fcat-seltext_m = ''.
*  ls_fcat-col_pos  = ls_fcat-col_pos + 1.
*  ls_fcat-outputlen = '40'.
*  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat.
**---------------------------FI Document Number------------------------*
  ls_fcat-fieldname = 'BELNR'.
*  ls_fcat-seltext_m = ' '(h22).
  ls_fcat-seltext_m = 'FI-doc.nr.'(h29).
  lv_colpos = lv_colpos + 1.
  ls_fcat-col_pos  = lv_colpos.
  ls_fcat-outputlen = '10'.
  APPEND ls_fcat TO lt_fieldcat.
  CLEAR: ls_fcat.
*** MOD-001 * end ***

* begin of MOD-002
**---------------------------Reference Key2------------------------*
*
* ls_fcat-fieldname = 'XREF2'.
**  ls_fcat-seltext_m = ' '(h22).
*  ls_fcat-seltext_m = '  2'.
*  lv_colpos = lv_colpos + 1.
*  ls_fcat-col_pos  = lv_colpos.
*  ls_fcat-outputlen = '20'.
*  APPEND ls_fcat TO lt_fieldcat.
*  CLEAR: ls_fcat.

*  end of MOD-002

*  IF MCONTAINER IS INITIAL .
*    CREATE OBJECT MCONTAINER
*                  EXPORTING
*                  CONTAINER_NAME = 'OVERVIEW' .
*
*    CREATE OBJECT MALV
*              EXPORTING I_PARENT = MCONTAINER.
*
*     GS_LAYOUT-SEL_MODE = 'X'.
*
*    CALL METHOD MALV->SET_TABLE_FOR_FIRST_DISPLAY
*           EXPORTING
*             IS_LAYOUT = GS_LAYOUT
*           CHANGING
*             IT_FIELDCATALOG = LT_fieldcat
*             IT_OUTTAB = gt_bsik[] .
*    ENDIF.

* Call ALV grid output
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program = 'YSE_RU_FI_ACT_RECONC'
*      i_structure_name   = 'YSE_ACT_RU'
*      i_grid_settings    = ls_grid
      is_layout          = ls_layout
      i_save             = 'A'
      it_fieldcat        = lt_fieldcat
      it_events          = lt_events
*      it_sort            = gt_sort
    TABLES
      t_outtab           = gt_bsik
    EXCEPTIONS
      program_error      = 1
      OTHERS             = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " output_list_bsik

*&---------------------------------------------------------------------*
*&      Form  PROCESS_ROUNDING_DIFF_CUST                    "MOD-001
*&---------------------------------------------------------------------*
*       Process rounding differences for customers : doc. type 'RD'
*       (add to corresponding document)
*----------------------------------------------------------------------*
FORM process_rounding_diff_cust
                       TABLES lt_bsid_tmp STRUCTURE gt_bsid_tmp.

  DATA: lt_bsid_rd   TYPE TABLE OF ty_bsid_tmp,
        lt_bsid_doc  TYPE SORTED TABLE OF ty_bsid_tmp
                          WITH NON-UNIQUE KEY bukrs gjahr belnr,
        ls_bsid_rd   TYPE ty_bsid_tmp,
        ls_bsid_doc  TYPE ty_bsid_tmp.

  DATA: lv_tabix  TYPE sytabix,
        lv_xblnr  TYPE xblnr,
        lv_belnr  TYPE belnr_d.


* Rounding documents
  lt_bsid_rd[] = lt_bsid_tmp[].
  DELETE lt_bsid_rd WHERE blart NE 'RD'.

* Other documents
  lt_bsid_doc[] = lt_bsid_tmp[].
  DELETE lt_bsid_doc WHERE blart = 'RD'.

* Process rounding differences
  LOOP AT lt_bsid_rd INTO ls_bsid_rd.

*   Get corresponding document number
    SELECT SINGLE xblnr INTO lv_xblnr
           FROM bkpf
           WHERE bukrs = ls_bsid_rd-bukrs
             AND belnr = ls_bsid_rd-belnr
             AND gjahr = ls_bsid_rd-gjahr.
    CHECK sy-subrc = 0.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = lv_xblnr
      IMPORTING
        output = lv_belnr.
*   Get corresponding document
    READ TABLE lt_bsid_doc WITH TABLE KEY bukrs = ls_bsid_rd-bukrs
                                          gjahr = ls_bsid_rd-gjahr
                                          belnr = lv_belnr
                           INTO ls_bsid_doc.
    lv_tabix = sy-tabix.
*   Modify amount (local currency)
    CHECK sy-subrc = 0.
    IF ls_bsid_rd-shkzg = ls_bsid_doc-shkzg.
      ls_bsid_doc-dmbtr = ls_bsid_doc-dmbtr + ls_bsid_rd-dmbtr.
    ELSE.
      ls_bsid_doc-dmbtr = ls_bsid_doc-dmbtr - ls_bsid_rd-dmbtr.
*     Adjust booking totals
      lv_debit_b  = lv_debit_b - ls_bsid_rd-dmbtr.
      lv_credit_b = lv_credit_b - ls_bsid_rd-dmbtr.
    ENDIF.
*   Modify document
    MODIFY lt_bsid_doc INDEX lv_tabix
                       FROM ls_bsid_doc
                       TRANSPORTING dmbtr.

  ENDLOOP.

* Return documents to process
  lt_bsid_tmp[] = lt_bsid_doc[].

ENDFORM.                    " PROCESS_ROUNDING_DIFF_CUST
