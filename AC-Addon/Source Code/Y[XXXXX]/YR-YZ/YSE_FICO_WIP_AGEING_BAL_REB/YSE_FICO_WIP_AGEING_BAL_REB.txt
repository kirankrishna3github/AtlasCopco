************************************************************************
* Program ID     : YSE_FICO_WIP_AGEING_BAL_REB                         *
* Program Title  : Ageing balance for WIP (Rebook)                     *
* Author         : Jules Smets                                         *
* Date           : 20.04.2011                                          *
* Change Request : CR1955                                              *
* Transport      : CD1K964583                                          *
* Description    : Reporting of WIP ageing balances (+ Rebooking)      *
************************************************************************
* Notes: This program is based on YSE_FICO_WIP_AGEING_BAL              *
************************************************************************
* Change History Log                                                   *
*----------------------------------------------------------------------*
* Mod. nr | Date       | Name               | Transport  | Change ref. *
*----------------------------------------------------------------------*
* MOD-001 | 15/12/2011 | J. Smets           | CD1K969386 | CR2326      *
*----------------------------------------------------------------------*
* MOD-002 | 05/03/2012 | J. Smets           | CD1K970606 | CR2453      *
*----------------------------------------------------------------------*
* MOD-003 | 08/03/2012 | J. Smets           | CD1K970658 | Ticket 21029*
*----------------------------------------------------------------------*
* MOD-004 | 16/07/2012 | Raghav D.V.S.      | CD1K972576 | CR 2580     *
*                                           | CD1K972584 |             *
*                                           | CD1K972624 |             *
*                                           | CD1K972656 |             *
*                                           | CD1K972658 |             *
*                                           | CD1K972660 |             *
*                                           | CD1K972662 |             *
*----------------------------------------------------------------------*
* MOD-005 |31/05/2013  |D Praveen Babu      | CD1K976342 | CR2887      *
* MOD-006 |01/07/2013  |D Praveen Babu      | CD1K976742 | CR2937      *
* MOD-007 |01/07/2013  |D Praveen Babu      | CD1K977005 | CR2967      *
* MOD-008 |12/02/2013  |D Praveen Babu      | CD1K980056 | CR2984      *
*----------------------------------------------------------------------*
* MOD-009 |16/06/2016  |Dashmantha          | CD1K989055 | CR3980      *
*         |            |                    |Performance enhancement   *
*----------------------------------------------------------------------*
* MOD-010 |17/01/2017  |Dashmantha          | CD1K990738 | CR4122      *
* Split posting for a document as per selection screen option lines    *
* items entered to avoid SAP error if line itmes are more than 999     *
* entries for a document                                               *
*----------------------------------------------------------------------*
************************************************************************
REPORT yse_fico_wip_ageing_bal_reb MESSAGE-ID yse_fico
                                   LINE-SIZE 250
                                   NO STANDARD PAGE HEADING.


************************************************************************
* TABLES                                                               *
************************************************************************
TABLES: bsis,
        bsas,
        bseg,
        yse_fico_ageing.                                               "MOD-002, " MOD-004.


***********************************************************************
* OBJECTS                                                             *
***********************************************************************
DATA:  obj_container  TYPE REF TO cl_gui_docking_container,
       obj_alv        TYPE REF TO cl_gui_alv_grid.


************************************************************************
* TYPES                                                                *
************************************************************************
TYPES:
  BEGIN OF str_bsis,
    bukrs   TYPE bsis-bukrs,    " Company Code
    gjahr   TYPE bsis-gjahr,    " Fiscal year
    monat   TYPE bsis-monat,    " Fiscal month
    blart   TYPE bsis-blart,    " Document type
    belnr   TYPE belnr_d,       " Accounting Doc nr
    buzei   TYPE bsis-buzei,    " Line item nr
    bldat   TYPE bsis-bldat,    " Document date
    budat   TYPE bsis-budat,    " Posting date
    shkzg   TYPE bsis-shkzg,    " Debit/Credit indicator
    dmbtr   TYPE bsis-dmbtr,    " Amount in local currency
    waers   TYPE bsis-waers,    " Currency
    prctr   TYPE bsis-prctr,    " Profit Center
    zfbdt   TYPE bsis-zfbdt,    " Baseline date for due date calc
    zuonr   TYPE bsis-zuonr,    " FI doc assignment nr
    hkont   TYPE bsis-hkont,    " GL account
    segment TYPE bsis-segment,  " Segment
  END OF str_bsis,

  BEGIN OF str_output,
    prctr   TYPE bsis-prctr,    " Profit Center
    waers   LIKE bsis-waers,    " Company Code Currency
    blart   LIKE bsis-blart,    " Document Type
    belnr   TYPE belnr_d,       " Accounting Doc Nr
    zuonr   TYPE bsis-sgtxt,    " FI doc assignment nr"++MOD-005
    aufnr   TYPE mseg-aufnr,    " Service order"++MOD-005
    hkont   TYPE bsis-hkont,    " Source GL account"++MOD-005
*    matnr   TYPE matnr,         " Material"++MOD-005
    bldat   LIKE bsis-bldat,    " Document date in doc
    budat   TYPE bsis-budat,    " Posting date
    rast1   LIKE bsid-dmbtr,    " Amount non due
    rast2   LIKE bsid-dmbtr,    " Amount  1-30
    rast3   LIKE bsid-dmbtr,    " Amount 31-60
    rast4   LIKE bsid-dmbtr,    " Amount 61-90
    rast5   LIKE bsid-dmbtr,    " Amount >90
*    zuonr   TYPE bsis-SGTXT,    " FI doc assignment nr"--MOD-005
*    hkont   TYPE bsis-hkont,    " Source GL account"--MOD-005
    gjahr   TYPE bsis-gjahr,    " Fiscal year
    monat   TYPE bsis-monat,    " Fiscal month
    segment TYPE bsis-segment,  " Segment
    hkontt  TYPE bsis-hkont,    " Target GL account
    prctro  TYPE bsis-prctr,    " Original Profit Center
*    aufnr   TYPE mseg-aufnr,   " Service order"--MOD-005
    age(12) TYPE c,"++MOD-005
    bzirk   TYPE bzirk,"++MOD-008
  END OF str_output,

  BEGIN OF t_summ,
    hkontt  TYPE bsis-hkont,"++MOD5
    segment LIKE faglflexa-segment,
    prctr   TYPE bsis-prctr,
    prctro  TYPE bsis-prctr,
*    hkontt  TYPE bsis-hkont,"--MOD5
    rast1   LIKE bsid-dmbtr,
    rast2   LIKE bsid-dmbtr,
    rast3   LIKE bsid-dmbtr,
    rast4   LIKE bsid-dmbtr,
    rast5   LIKE bsid-dmbtr,
    rast6   LIKE bsid-dmbtr,
  END OF t_summ,

  BEGIN OF str_mseg,
    matnr   TYPE mseg-matnr,    " Material
    werks   TYPE mseg-werks,    " Plant
    shkzg   TYPE mseg-shkzg,    " Debit/Credit indicator
    dmbtr   TYPE mseg-dmbtr,    " Amount in local currency
    aufnr   TYPE mseg-aufnr,    " Service order
  END OF str_mseg,

  BEGIN OF str_mvke,
    matnr   TYPE mvke-matnr,
    vkorg   TYPE mvke-vkorg,
    prodh   TYPE mvke-prodh,
  END OF str_mvke,

  BEGIN OF str_mbew,
    matnr   TYPE mbew-matnr,
    bwkey   TYPE mbew-bwkey,
    bklas   TYPE mbew-bklas,
  END OF str_mbew,

*** MOD-002 * begin ***
  BEGIN OF str_bseg,
    belnr   TYPE belnr_d,       " Accounting Doc nr
    gjahr   TYPE bseg-gjahr,    " Fiscal year
    buzei   TYPE bseg-buzei,    " Line item nr
    zuonr   TYPE bseg-zuonr,    " FI doc assignment nr
  END OF str_bseg.
*** MOD-002 * end ***


************************************************************************
* INTERNAL TABLES                                                      *
************************************************************************
DATA:
  it_wips            TYPE TABLE OF str_bsis        WITH HEADER LINE,
  it_mseg            TYPE TABLE OF str_mseg        WITH HEADER LINE,
  it_mvkei           TYPE TABLE OF str_mvke        WITH HEADER LINE,
  it_mvke            TYPE HASHED TABLE OF str_mvke
                          WITH UNIQUE KEY matnr vkorg
                          WITH HEADER LINE,
  it_mbewi           TYPE TABLE OF str_mbew        WITH HEADER LINE,
  it_mbew            TYPE HASHED TABLE OF str_mbew
                          WITH UNIQUE KEY matnr bwkey
                          WITH HEADER LINE,
*** MOD-002 * begin ***
  it_wipsc           TYPE TABLE OF str_bsis        WITH HEADER LINE,
  it_bsegi           TYPE TABLE OF str_bseg        WITH HEADER LINE,
  it_bseg            TYPE HASHED TABLE OF str_bseg
                          WITH UNIQUE KEY belnr gjahr
                          WITH HEADER LINE,
*** MOD-002 * end ***
  it_output          TYPE TABLE OF str_output      WITH HEADER LINE,
  it_output2         TYPE TABLE OF str_output      WITH HEADER LINE,
  wa_output          TYPE str_output,
  it_fieldcat        TYPE lvc_t_fcat               WITH HEADER LINE.

DATA: it_summ        TYPE TABLE OF t_summ." WITH OUT HEADER LINE.
DATA: it_summ2       TYPE TABLE OF t_summ WITH HEADER LINE.
DATA: wa_summ        TYPE t_summ,
      gt_err         LIKE bdcmsgcoll OCCURS 0 WITH HEADER LINE.
DATA: i_bdcdata      LIKE bdcdata OCCURS 0 WITH HEADER LINE,
      i_bdcdata1     LIKE bdcdata OCCURS 0 WITH HEADER LINE,"MOD-5++
      struct_bdcdata TYPE bdcdata.

DATA: it_yse_fico_ageing TYPE STANDARD TABLE OF yse_fico_ageing WITH HEADER LINE.  " Mod-004


*Begin of ++MOD5
DATA: gv_xintb     TYPE xfeld,
      gv_hkont     TYPE hkont,
      gv_msgtxt    LIKE t100-text.
DATA: it_output3 TYPE STANDARD TABLE OF str_output,
      it_output4 TYPE STANDARD TABLE OF str_output,
      wa_output1 TYPE str_output,
      wa_output2 TYPE str_output,
      wa_output3 TYPE str_output,
      wa_output4 TYPE str_output.
*End of ++MOD5
* Begin of insertion by MOD-010
DATA : it_summ_tmp  TYPE TABLE OF t_summ,
       wa_summ_tmp  TYPE t_summ,
       gv_cnt       TYPE i,
       gv_tot_cnt   TYPE i,
       gv_lines     TYPE i.
* End of insertion by MOD-010
************************************************************************
* CONSTANTS                                                            *
************************************************************************
CONSTANTS:
  gc_true       TYPE c  VALUE 'X',          " True
  gc_error(10)  TYPE c  VALUE '* ERROR *'.


************************************************************************
* VARIABLES                                                            *
************************************************************************
DATA:
  gv_monat(2)  TYPE n,                  " Fiscal period
  gv_gjahr     LIKE t009b-bdatj,        " Fiscal year
  gv_waers     LIKE t001-waers,         " Currency
  gv_last_2(3) TYPE n  VALUE 30,        " Due date intervals
  gv_last_3(3) TYPE n  VALUE 60,
  gv_last_4(3) TYPE n  VALUE 90,
  okcode       LIKE sy-ucomm,           " return param screen 100
  gv_variant   TYPE disvariant,         " ALV layout variant
  gv_layout    TYPE lvc_s_layo.         " ALV layout

DATA: gv_date    LIKE bsid-budat,
      gv_error   TYPE c,
      gv_mode    TYPE c             VALUE 'N',
      gv_period  LIKE t009b-poper,
      gv_year    LIKE bkpf-gjahr.


************************************************************************
* SELECTION SCREEN                                                     *
************************************************************************
SELECTION-SCREEN BEGIN OF BLOCK s1 WITH FRAME TITLE text-001.
PARAMETERS:
  p_bukrs  LIKE bsis-bukrs OBLIGATORY,      " Company code
  p_keydat LIKE bsis-bldat OBLIGATORY.      " Key date
SELECT-OPTIONS:
  so_hknt1 FOR bsis-hkont  OBLIGATORY       " G/L Accounts
                           NO INTERVALS,
  so_hknt2 FOR bsis-hkont  OBLIGATORY       " G/L Accounts
                           NO INTERVALS.
SELECTION-SCREEN END OF BLOCK s1.

SELECTION-SCREEN BEGIN OF BLOCK s2 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 01(30) text-003.   " Due date sorted list
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS:rastbis1(1) DEFAULT '0',
           rastbis2(5) DEFAULT '1-30',
           rastbis3(8) DEFAULT '31-60',
           rastbis4(8) DEFAULT '61-90'.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK s2.

SELECTION-SCREEN BEGIN OF BLOCK s3 WITH FRAME TITLE text-034.
PARAMETERS: p_post  AS CHECKBOX.
PARAMETERS: p_postd  TYPE budat.
PARAMETERS: p_rpostd TYPE budat.
SELECTION-SCREEN END OF BLOCK s3.

SELECTION-SCREEN BEGIN OF BLOCK s4 WITH FRAME TITLE text-055.
PARAMETERS: p_maxl   TYPE i DEFAULT '400' OBLIGATORY. "+ MOD-010
SELECTION-SCREEN END OF BLOCK s4.
************************************************************************
* AT SELECTION SCREEN                                                  *
************************************************************************
AT SELECTION-SCREEN.

  PERFORM check_authorization.

* Checks in case of repostings
  IF p_post = 'X'.

    IF p_postd IS INITIAL.
      MESSAGE e027(yse_fico).
    ENDIF.

    IF p_rpostd IS INITIAL.
      MESSAGE e028(yse_fico).
    ENDIF.

    IF p_postd IS INITIAL.
      MESSAGE e027(yse_fico).
    ENDIF.

    IF p_rpostd IS INITIAL.
      MESSAGE e028(yse_fico).
    ENDIF.

    IF p_rpostd <= p_postd.
      MESSAGE e029(yse_ficfo).
    ENDIF.

*   Check if the posting and reverse posting date in an open period
    gv_date = p_postd.

    CALL FUNCTION 'FI_PERIOD_DETERMINE'
      EXPORTING
        i_budat = gv_date
        i_bukrs = p_bukrs
      IMPORTING
        e_gjahr = gv_year
        e_poper = gv_period.

    CALL FUNCTION 'FI_PERIOD_CHECK'
      EXPORTING
        i_bukrs          = p_bukrs     " Company Code
        i_gjahr          = gv_year     " This is we got from FM used above
        i_koart          = '+'
        i_konto          = '+'
        i_monat          = gv_period   " This is we got from FM used above
      EXCEPTIONS
        error_period     = 1
        error_period_acc = 2
        invalid_input    = 3
        OTHERS           = 4.

    IF sy-subrc <> 0.
      MESSAGE e030(yse_fico).
    ENDIF.

    CLEAR gv_date.
    gv_date = p_rpostd.

    CALL FUNCTION 'FI_PERIOD_DETERMINE'
      EXPORTING
        i_budat = gv_date
        i_bukrs = p_bukrs
      IMPORTING
        e_gjahr = gv_year
        e_poper = gv_period.

    CALL FUNCTION 'FI_PERIOD_CHECK'
      EXPORTING
        i_bukrs          = p_bukrs     " Company Code
        i_gjahr          = gv_year     " This is we got from FM used above
        i_koart          = '+'
        i_konto          = '+'
        i_monat          = gv_period   " This is we got from FM used above
      EXCEPTIONS
        error_period     = 1
        error_period_acc = 2
        invalid_input    = 3
        OTHERS           = 4.

    IF sy-subrc <> 0.
      MESSAGE e031(yse_fico).
    ENDIF.

  ENDIF.


************************************************************************
* START-OF-SELECTION                                                   *
************************************************************************
START-OF-SELECTION.

  PERFORM calc_period.

  PERFORM load_company_code_currency.

  PERFORM get_last_due_dates.

*----------------------------------------------*
* First selection (Accounts 1441901 / 1441903) *
*----------------------------------------------*
  PERFORM load_postings.

  PERFORM calc_due_ageing.

* Summarize table it_output by segment/profitcenter into it_summ
*  LOOP AT it_output INTO wa_output."MOD-006 --
*     MOVE-CORRESPONDING wa_output TO it_summ."MOD-006 --
*     MOVE-CORRESPONDING wa_output TO wa_summ."MOD-006 --
*Begin of MOD-006 --
*    clear:wa_summ-rast2,wa_summ-rast3,wa_summ-rast4,wa_summ-rast5.
*    if wa_output-age = '1-30'.
*      wa_summ-rast2 = wa_output-rast2.
*    ELSEIF wa_output-age = '31-60'.
*      wa_summ-rast3 = wa_output-rast2.
*    ELSEIF wa_output-age = '61-90'.
*      wa_summ-rast4 = wa_output-rast2.
*    ELSEIF wa_output-age = '>90'.
*      wa_summ-rast5 = wa_output-rast2.
*    endif.
*    COLLECT wa_summ into it_summ.
*End of MOD-006 --
*    COLLECT it_summ."MOD-006 --
*  ENDLOOP."MOD-006 --
*Begin of MOD-006 --
* Reposting
*  IF p_post = 'X'.
*    PERFORM reposting." TABLES it_summ.
*    IF gv_error = 'N'.
*      PERFORM reverse_reposting." TABLES it_summ.
*    ENDIF.
*  ENDIF.
*End of MOD-006 --
  REFRESH:it_summ.
*------------------------------------*
* Second selection (Account 1441902) *
*------------------------------------*
  PERFORM load_postings2.

  PERFORM calc_due_ageing2.

* Summarize table it_output by segment/profitcenter into it_summ2
  LOOP AT it_output2 INTO wa_output.
*    IF wa_output-prctr NE gc_error."MOD-006 --
*     MOVE-CORRESPONDING wa_output TO it_summ."MOD-006 --
*     MOVE-CORRESPONDING wa_output TO wa_summ."MOD-006 --
*Begin of MOD-006 --
*      clear:wa_summ-rast2,wa_summ-rast3,wa_summ-rast4,wa_summ-rast5.
*      if wa_output-age = '1-30'.
*        wa_summ-rast2 = wa_output-rast2.
*      ELSEIF wa_output-age = '31-60'.
*        wa_summ-rast3 = wa_output-rast2.
*      ELSEIF wa_output-age = '61-90'.
*        wa_summ-rast4 = wa_output-rast2.
*      ELSEIF wa_output-age = '>90'.
*        wa_summ-rast5 = wa_output-rast2.
*      endif.
*      COLLECT wa_summ into it_summ.
*End of MOD-005 --
*    COLLECT it_summ."MOD-006 --
*   Add to output table (ALV)
*    ENDIF."MOD-006 --
    it_output = wa_output.
    APPEND it_output.
  ENDLOOP.
*Begin of MOD-006 --
* Reposting
*  IF p_post = 'X'.
*    PERFORM reposting." TABLES it_summ2.
*    IF gv_error = 'N'.
*      PERFORM reverse_reposting." TABLES it_summ2.
*    ENDIF.
*  ENDIF.
*End of MOD-006 --
  SORT it_output BY belnr.
*** MOD-005 *Begin of change
  PERFORM nullify_debit_credit_near_amt.
*** MOD-005 *End of change
*** MOD-006 *Begin of change
*Posting for Labour only
  IF p_post = 'X'.
    REFRESH: it_output3[],it_summ[].
    it_output3[] = it_output[].
    LOOP AT so_hknt2.
      DELETE it_output3 WHERE hkont = so_hknt2-low.
    ENDLOOP.
    LOOP AT it_output3 INTO wa_output.
      MOVE-CORRESPONDING wa_output TO wa_summ.
      COLLECT wa_summ INTO it_summ.
      CLEAR wa_summ.
    ENDLOOP.

* Begin of insertion by MOD-010
    PERFORM split_doc_post.
* End of insertion by MOD-010

* Begin of deletion by MOD-010
*    PERFORM reposting." TABLES it_summ.
*    IF gv_error = 'N'.
*      PERFORM reverse_reposting." TABLES it_summ.
*    ENDIF.
* End of deletion by MOD-010

  ENDIF.
*Posting for spare parts only
  IF p_post = 'X'.
    REFRESH: it_output3[],it_summ[].
    it_output3[] = it_output[].
    LOOP AT so_hknt1.
      DELETE it_output3 WHERE hkont = so_hknt1-low.
    ENDLOOP.
    LOOP AT it_output3 INTO wa_output.
      MOVE-CORRESPONDING wa_output TO wa_summ.
      COLLECT wa_summ INTO it_summ.
      CLEAR wa_summ.
    ENDLOOP.

* Begin of insertion by MOD-010
    PERFORM split_doc_post.
* End of insertion by MOD-010

* Begin of deletion by MOD-010
*    PERFORM reposting." TABLES it_summ.
*    IF gv_error = 'N'.
*      PERFORM reverse_reposting." TABLES it_summ.
*    ENDIF.
* End of deletion by MOD-010
  ENDIF.

  REFRESH:it_output3[].
*** MOD-006 *End of change

************************************************************************
* END-OF-SELECTION                                                     *
************************************************************************
END-OF-SELECTION.

  IF sy-batch NE 'X'.
*   Display in ALV-grid
    CALL SCREEN 100.
  ELSE.
    PERFORM batch_report.
  ENDIF.


************************************************************************
* MODULE STATUS_100 OUTPUT                                             *
************************************************************************
MODULE status_0100 OUTPUT.

  SET PF-STATUS '100'.
  SET TITLEBAR '100'.

ENDMODULE.       " STATUS_0100 OUTPUT


************************************************************************
* MODULE PREPARE_SCREEN OUTPUT                                         *
************************************************************************
MODULE prepare_screen OUTPUT.

  IF obj_container IS INITIAL.
*   Create a container
    CREATE OBJECT obj_container
      EXPORTING
        repid             =  sy-repid
        dynnr             =  sy-dynnr
        lifetime          =  cntl_lifetime_dynpro
*       ratio             =  90.
        extension         =  5000.

*   Create an ALV control
    CREATE OBJECT obj_alv
      EXPORTING
        i_parent = obj_container.

*   Set parameters regarding layout, etc.
    gv_variant-report = sy-cprog.
    gv_layout-cwidth_opt = gc_true.
    gv_layout-no_toolbar = ' '.

*   Create the field catalog
    PERFORM build_field_catalog.

*   Display the data in the ALV control
    CALL METHOD obj_alv->set_table_for_first_display
      EXPORTING
        i_save          = 'A'
        is_variant      = gv_variant
        is_layout       = gv_layout
      CHANGING
        it_outtab       = it_output[]
        it_fieldcatalog = it_fieldcat[].
  ELSE.
*   If ALV exists, refresh data without changing layout
    CALL METHOD obj_alv->refresh_table_display
      EXPORTING
        i_soft_refresh = 'X'.
  ENDIF.

ENDMODULE.    " PREPARE_SCREEN OUTPUT


***********************************************************************
** Module USER_COMMAND_0100 INPUT                                     *
***********************************************************************
MODULE user_command_0100 INPUT.

  CASE okcode.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
  ENDCASE.  " okcode

ENDMODULE.  " USER_COMMAND_0100 INPUT


************************************************************************
* FORM CHECK_AUTHORIZATION                                             *
************************************************************************
FORM check_authorization.

  AUTHORITY-CHECK OBJECT 'F_KNA1_BUK'
                      ID 'BUKRS' FIELD p_bukrs
                      ID 'ACTVT' DUMMY.

  IF sy-subrc = 4.
*   No authorisation to display the data
    MESSAGE ID 'YSE_RENTAL' TYPE 'E' NUMBER '040' WITH p_bukrs.
  ELSEIF sy-subrc <> 0.
*   Error checking authorization.
    MESSAGE ID 'YSE_RENTAL' TYPE 'E' NUMBER '046'.
  ENDIF.

ENDFORM.                    " Check_Authorization


************************************************************************
* FORM CALC_PERIOD                                                     *
************************************************************************
* Get the last day in the selected period                              *
************************************************************************
FORM calc_period.

  DATA:
    lv_periv     LIKE t001-periv,         " Fiscal year variant
    lv_period    LIKE t009b-poper.        " Posting period


  SELECT SINGLE periv INTO lv_periv
         FROM t001
         WHERE bukrs = p_bukrs.

  CALL FUNCTION 'G_PERIOD_GET'
    EXPORTING
      company                        = p_bukrs
      date                           = p_keydat
      variant                        = lv_periv
    IMPORTING
      period                         = lv_period
      year                           = gv_gjahr
    EXCEPTIONS
      ledger_not_assigned_to_company = 1
      period_not_defined             = 2
      variant_not_defined            = 3
      OTHERS                         = 4.

  IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ELSE.
    gv_monat = lv_period.
  ENDIF.

ENDFORM.                    " FIND_PERIOD


************************************************************************
* FORM LOAD_COMPANY_CODE_CURRENCY                                      *
************************************************************************
FORM load_company_code_currency.

  SELECT SINGLE waers INTO gv_waers
         FROM t001
         WHERE bukrs EQ p_bukrs.

ENDFORM.                    " load_company_code_currency


************************************************************************
* FORM GET_LAST_DUE_DATES                                              *
************************************************************************
FORM get_last_due_dates.

  SEARCH rastbis2 FOR '-'.
  MOVE rastbis2+sy-fdpos TO gv_last_2.

  SEARCH rastbis3 FOR '-'.
  MOVE rastbis3+sy-fdpos TO gv_last_3.

  SEARCH rastbis4 FOR '-'.
  MOVE rastbis4+sy-fdpos TO gv_last_4.

ENDFORM.   " get_last_due_dates


************************************************************************
* FORM LOAD_POSTINGS                                                   *
************************************************************************
FORM load_postings.

  SELECT bukrs gjahr monat blart
         belnr buzei bldat budat
         shkzg dmbtr  waers prctr
         zfbdt zuonr hkont segment
         INTO TABLE it_wips
         FROM bsis                          " -> Postings table
         WHERE bukrs EQ p_bukrs             " Company Code
           AND hkont IN so_hknt1            " General Ledger Account
           AND budat LE p_keydat.           " Posting date >= key date

* Read all clearings with document date before the keydate
* and clearing date after the key date
  SELECT bukrs gjahr monat blart
         belnr buzei bldat budat
         shkzg dmbtr waers prctr
         zfbdt zuonr hkont segment
         APPENDING TABLE it_wips
         FROM bsas                          " -> Clearings table
         WHERE bukrs EQ p_bukrs             " Company Code
           AND hkont IN so_hknt1            " General Ledger Account
           AND budat LE p_keydat            " Posting date <= Key date
           AND augdt GT p_keydat.           " Clearing date > key date

  SORT it_wips.

  LOOP AT it_wips.
    IF it_wips-segment IS INITIAL.
      it_wips-segment = it_wips-prctr.
      MODIFY it_wips.
    ENDIF.
  ENDLOOP.

ENDFORM.  " load_postings


************************************************************************
* FORM CALC_DUE_AGEING                                                 *
************************************************************************
* Analyses the interval entries and extracts the amount of days        *
* to calculate the due dates                                           *
************************************************************************
FORM calc_due_ageing.

  DATA: lv_days_overdue  TYPE i,
        lv_vbeln         TYPE vbeln,
        lv_posnr         TYPE posnr,
        lv_qmnum         TYPE qmnum,
        lv_objnr          TYPE aufk-objnr,
        wa_wips          TYPE str_bsis.
*  Data:lt_mseg_temp      TYPE STANDARD TABLE OF str_mseg,
*       wa_mseg_temp      type str_mseg.
*  Data:ANW_STAT_EXISTING  TYPE  XFELD,
*       E_STSMA            LIKE  JSTO-STSMA,
*       LINE               LIKE  BSVX-STTXT,
*       USER_LINE          LIKE  BSVX-STTXT,
*       STONR              LIKE  TJ30-STONR.
  DATA:l_lin TYPE i.
  RANGES: lr_bwart   FOR mseg-bwart.
  CONSTANTS: lc_neg           TYPE shkzg VALUE 'H'.
* Movement types to select
  lr_bwart-sign   = 'I'.
  lr_bwart-option = 'EQ'.
  lr_bwart-low    = '261'.
  APPEND lr_bwart.
  lr_bwart-low    = '262'.
  APPEND lr_bwart.
  lr_bwart-low    = '561'.
  APPEND lr_bwart.
  lr_bwart-low    = '562'.
  APPEND lr_bwart.
  lr_bwart-low    = '961'.
  APPEND lr_bwart.
  lr_bwart-low    = '962'.
  APPEND lr_bwart.
*** MOD-004 * begin of change
  SELECT *
    FROM yse_fico_ageing
    INTO TABLE it_yse_fico_ageing.
  LOOP AT it_yse_fico_ageing INTO yse_fico_ageing.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = yse_fico_ageing-prctr
      IMPORTING
        output = yse_fico_ageing-prctr.
    MODIFY it_yse_fico_ageing FROM yse_fico_ageing TRANSPORTING prctr.
  ENDLOOP.

  LOOP AT it_wips INTO wa_wips.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = wa_wips-prctr
      IMPORTING
        output = wa_wips-prctr.
    MODIFY it_wips FROM wa_wips TRANSPORTING prctr.
  ENDLOOP.
*** MOD-004 * End of change
  LOOP AT it_wips.
    CLEAR  it_output.
*   Copy standard fields
    MOVE-CORRESPONDING it_wips TO it_output.
    it_output-prctro = it_wips-prctr.
*** MOD-004 * begin of change
    READ TABLE it_yse_fico_ageing WITH KEY prctr = it_output-prctro hkont = it_output-hkont.
    IF sy-subrc = 0.
      it_output-prctr = it_yse_fico_ageing-zprctr_new.
    ENDIF.
*** MOD-004 * end of change

*** MOD-001 * begin of comment ***
**   Segment
*    SELECT SINGLE segment INTO it_output-segment
*           FROM yse_prctr_bl
*           WHERE prctr = it_wips-prctr.
*** MOD-001 * end of comment ***

    lv_days_overdue = p_keydat - it_wips-bldat.

*   Check debit/credit indicator and adjust accordingly
    IF it_wips-shkzg = lc_neg.
      it_wips-dmbtr = 0 - it_wips-dmbtr.
    ENDIF.
*   Insert amounts in correct interval
    IF lv_days_overdue <= gv_last_2.
      it_output-rast2  = it_wips-dmbtr.
      it_output-hkontt = '0001443902'.
      it_output-age = '1-30'."++MOD-005
    ELSEIF lv_days_overdue <= gv_last_3.
*      it_output-rast3  = it_wips-dmbtr."--MOD-005
      it_output-rast2  = it_wips-dmbtr."++MOD-005
      it_output-hkontt = '0001443902'.
      it_output-age = '31-60'."++MOD-005
    ELSEIF lv_days_overdue <= gv_last_4.
*      it_output-rast4  = it_wips-dmbtr."--MOD-005
      it_output-rast2  = it_wips-dmbtr."++MOD-005
      it_output-hkontt = '0001444902'.
      it_output-age = '61-90'."++MOD-005
    ELSE.
*      it_output-rast5  = it_wips-dmbtr.  " it_output-rast6"--MOD-005
      it_output-rast2  = it_wips-dmbtr."++MOD-005
      it_output-hkontt = '0001445902'.
      it_output-age = '>90'."++MOD-005
    ENDIF.
*Begin of ++MOD-005
*   Get material segment via service orders
    SPLIT it_wips-zuonr AT '/' INTO: lv_vbeln lv_posnr.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = lv_vbeln
      IMPORTING
        output = lv_vbeln.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = lv_posnr
      IMPORTING
        output = lv_posnr.
    CLEAR it_mseg[].
*End of ++MOD-005
*Begin of ++MOD-006
    SELECT SINGLE aufnr
                  FROM aufk
                  INTO it_output-aufnr
                  WHERE kdauf = lv_vbeln
                    AND kdpos = lv_posnr.
    IF sy-subrc NE 0.
*End of ++MOD-006
*Begin of ++MOD-005
      SELECT SINGLE qmnum
                    FROM vbak
                    INTO lv_qmnum
                    WHERE vbeln = lv_vbeln.
      IF sy-subrc EQ 0.
        SELECT SINGLE aufnr
                      FROM viqmel
                      INTO it_output-aufnr
                      WHERE qmnum = lv_qmnum.
      ENDIF.
    ENDIF.
*End of ++MOD-005
*    if it_output-aufnr is not INITIAL."++MOD-006
    APPEND it_output.
*    endif."++MOD-006
  ENDLOOP.    " it_wips


ENDFORM.                    " calculate_due_ageing


************************************************************************
* ALV GRID                                                             *
************************************************************************


************************************************************************
* FORM BUILD_FIELD_CATALOG                                             *
************************************************************************
FORM build_field_catalog.

  DATA: lv_text(30).


  CLEAR it_fieldcat.

  it_fieldcat-fieldname = 'PRCTR'.
  it_fieldcat-coltext   = 'Profit ctr'(006).
  it_fieldcat-tooltip   = 'Profit center'(005).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'WAERS'.
  it_fieldcat-coltext   = 'Curr'(007).
  it_fieldcat-tooltip   = 'Currency code'(008).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'BLART'.
  it_fieldcat-coltext   = 'Doc Type'(009).
  it_fieldcat-tooltip   = 'Document type'(010).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'BELNR'.
  it_fieldcat-coltext   = 'Account doc'(011).
  it_fieldcat-tooltip   = 'Account document'(012).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'BLDAT'.
  it_fieldcat-coltext   = 'Doc date'(013).
  it_fieldcat-tooltip   = 'Document date'(014).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'BUDAT'.
  it_fieldcat-coltext   = 'Post date'(015).
  it_fieldcat-tooltip   = 'Posting date'(016).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'RAST1'.
  it_fieldcat-coltext   = 'None due'(017).
  it_fieldcat-tooltip   = 'Outside selected intervals'(018).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'RAST2'.
  MOVE 'Overdue 1 - 30' TO lv_text.
  it_fieldcat-coltext   = lv_text.
  it_fieldcat-tooltip   = lv_text.
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'RAST3'.
  MOVE 'Overdue 31 - 60' TO lv_text.
  it_fieldcat-coltext   = lv_text.
  it_fieldcat-tooltip   = lv_text.
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'RAST4'.
  MOVE 'Overdue 61 - 90' TO lv_text.
  it_fieldcat-coltext   = lv_text.
  it_fieldcat-tooltip   = lv_text.
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'RAST5'.
  MOVE 'Overdue > 90' TO lv_text.
  it_fieldcat-coltext   = lv_text.   " 'Overdue >90'(019).
  it_fieldcat-tooltip   = lv_text.   " 'Overdue >90'(020).
  it_fieldcat-tabname   = 'IT_OUTPUT'."MOD-007++
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'ZUONR'.
  it_fieldcat-coltext   = 'Assignment'(021).
  it_fieldcat-tooltip   = 'Assignment number'(022).
  it_fieldcat-tabname   = 'IT_OUTPUT'.
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'HKONT'.
  it_fieldcat-coltext   = 'Source GL account'(023).
  it_fieldcat-tooltip   = 'Source General Ledger account'(024).
  it_fieldcat-edit_mask = '==ALPHA'.
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'HKONTT'.
  it_fieldcat-coltext   = 'Target GL account'(035).
  it_fieldcat-tooltip   = 'Target General Ledger account'(036).
  it_fieldcat-edit_mask = '==ALPHA'.
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'GJAHR'.
  it_fieldcat-coltext   = 'Fisc year'(025).
  it_fieldcat-tooltip   = 'Fiscal year'(026).
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'MONAT'.
  it_fieldcat-coltext   = 'Fisc period'(027).
  it_fieldcat-tooltip   = 'Fiscal period'(028).
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'SEGMENT'.
  it_fieldcat-coltext   = 'Segment'(032).
  it_fieldcat-tooltip   = 'Segment for Segmental Reporting'(033).
  it_fieldcat-edit_mask = '==ALPHA'.
  APPEND it_fieldcat.

  it_fieldcat-fieldname = 'AUFNR'.
  it_fieldcat-coltext   = 'Service Order'(037).
  it_fieldcat-tooltip   = 'Service Order number'(038).
  it_fieldcat-edit_mask = '==ALPHA'.
  APPEND it_fieldcat.
*Begin of MOD-008++
  it_fieldcat-fieldname = text-052.
  it_fieldcat-coltext   = text-053."'Sales District'(037).
  it_fieldcat-tooltip   = text-053."'Sales District'(038).
  it_fieldcat-tabname   = 'IT_OUTPUT'.
  APPEND it_fieldcat.
*End of MOD-008++
ENDFORM.    " build_field_catalog


************************************************************************
* FORM REPOSTING                                                       *
************************************************************************
FORM reposting ." TABLES it_summ.

  DATA: lv_account TYPE saknr,
        lv_date TYPE d,
        lv_wrbtr TYPE char16,
        lv_rast TYPE t_summ-rast1,
        lv_newbs(2) TYPE c,
        lv_first TYPE c.


* 1st posting
  REFRESH: i_bdcdata,
           gt_err.

* Post document: Header Data
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0100'  'X'  ''   ''
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  CLEAR lv_date.
  WRITE p_postd TO lv_date.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BLDAT'  lv_date
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BUDAT'  lv_date
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BLART'  'SA'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BUKRS' p_bukrs
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-WAERS'  gv_waers
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  CLEAR lv_date.
  WRITE p_keydat TO lv_date.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-XBLNR'  lv_date
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BKTXT'  'WIP Ageing-Reclass'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  lv_first = 'Y'.
  SORT it_summ .
  LOOP AT it_summ INTO wa_summ.
*Begin of MOD-6++
    gv_hkont = '1441910'.
    AT FIRST.
      gv_xintb = ' '.
      PERFORM call_fss0.
    ENDAT.
    gv_hkont = wa_summ-hkontt.
    AT NEW hkontt.
      gv_xintb = ' '.
      PERFORM call_fss0.
    ENDAT.
*End of MOD-6++
    wa_summ-rast1 = wa_summ-rast1 + wa_summ-rast2 + wa_summ-rast3.
    wa_summ-rast2 = wa_summ-rast4.
    wa_summ-rast3 = wa_summ-rast5.
    IF wa_summ-rast1 IS NOT INITIAL OR wa_summ-rast2 IS NOT INITIAL OR
       wa_summ-rast3 IS NOT INITIAL.
***
      IF wa_summ-rast1 IS NOT INITIAL.
        IF lv_first = 'N'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMF05A'  '0330'  'X'  ''   ''
                   CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
        IF wa_summ-rast1 < 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '50'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSEIF wa_summ-rast1 > 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '40'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

*        lv_account = '1443901'.
        lv_account = wa_summ-hkontt.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RF05A-NEWKO' lv_account
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Item 1
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMF05A'  '0300' 'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        CLEAR lv_wrbtr.
        CLEAR lv_rast.
        lv_rast = ABS( wa_summ-rast1 ).
        WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Coding block
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLKACB'  '0002'  'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
        lv_first = 'N'.
      ENDIF.
***
      IF wa_summ-rast2 IS NOT INITIAL.
        IF lv_first = 'N'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMF05A'  '0330'  'X'  ''   ''
                   CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
        IF wa_summ-rast2 < 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '50'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSEIF wa_summ-rast2 > 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '40'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

*        lv_account = '1444901'.
        lv_account = wa_summ-hkontt.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RF05A-NEWKO' lv_account
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Item 1
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMF05A'  '0300' 'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        CLEAR lv_wrbtr.
        CLEAR lv_rast.
        lv_rast = ABS( wa_summ-rast2 ).
        WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Coding block
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLKACB'  '0002'  'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        lv_first = 'N'.
      ENDIF.
***
      IF wa_summ-rast3 IS NOT INITIAL.
        IF lv_first = 'N'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMF05A'  '0330'  'X'  ''   ''
                   CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
        IF wa_summ-rast3 < 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '50'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSEIF wa_summ-rast3 > 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '40'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

*        lv_account = '1445901'.
        lv_account = wa_summ-hkontt.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RF05A-NEWKO' lv_account
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Item 1
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMF05A'  '0300' 'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        CLEAR lv_wrbtr.
        CLEAR lv_rast.
        lv_rast = ABS( wa_summ-rast3 ).
        WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Coding block
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLKACB'  '0002'  'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
        lv_first = 'N'.
      ENDIF.

      CLEAR lv_wrbtr.
      CLEAR lv_rast.
      CLEAR lv_newbs.

      lv_rast = wa_summ-rast1 + wa_summ-rast2 + wa_summ-rast3.
      IF lv_rast < 0.
        lv_newbs = '40'.
      ELSE.
        lv_newbs = '50'.
      ENDIF.
      lv_rast =  ABS( lv_rast ).
      WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0330'  'X'  ''   ''
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'RF05A-NEWBS'  lv_newbs
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'RF05A-NEWKO'  '1441910'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '/00'
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

*     Add G/L Account Item
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0300'  'X'  ''   ''
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

*     Coding block
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLKACB'  '0002'  'X'  ''   ''
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctro
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

*** MOD-001 * begin insert ***
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'COBL-SEGMENT'  wa_summ-segment
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
*** MOD-001 * end insert ***

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

    ENDIF.

  ENDLOOP.

* End posting and Save
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0330'  'X'  ''   ''
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.


  gv_error = 'N'.
  CALL TRANSACTION 'FB01' USING i_bdcdata
  UPDATE 'S' MODE gv_mode MESSAGES INTO gt_err.
  IF sy-subrc = 0.
    gv_error = 'N'.
    LOOP AT gt_err.
      IF gt_err-msgtyp = 'A' OR gt_err-msgtyp = 'E'.
        gv_error = 'Y'.
      ENDIF.
    ENDLOOP.
  ELSE.
    gv_error = 'Y'.
  ENDIF.
*Begin of MOD-6++
  gv_hkont = '1441910'.
  gv_xintb = 'X'.
  PERFORM call_fss0.
  LOOP AT it_summ INTO wa_summ.
    gv_hkont = wa_summ-hkontt.
    AT NEW hkontt.
      gv_xintb = 'X'.
      PERFORM call_fss0.
    ENDAT.
  ENDLOOP.
*End of MOD-6++
ENDFORM.                    "reposting


*&---------------------------------------------------------------------*
*&      Form  reverse_reposting
*&---------------------------------------------------------------------*
*      -->IT_SUMM    text
*----------------------------------------------------------------------*
FORM reverse_reposting."  TABLES  it_summ.

  DATA: lv_account TYPE saknr,
        lv_date TYPE d,
        lv_wrbtr TYPE char16,
        lv_rast TYPE t_summ-rast1,
        lv_newbs(2) TYPE c,
        lv_first TYPE c.



* 1st posting
  REFRESH: i_bdcdata,
           gt_err.

* Post document: Header Data
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0100'  'X'  ''   ''
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  CLEAR lv_date.
  WRITE p_rpostd TO lv_date.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BLDAT'  lv_date
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BUDAT'  lv_date
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BLART'  'SA'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BUKRS' p_bukrs
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-WAERS'  gv_waers
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  CLEAR lv_date.
  WRITE p_keydat TO lv_date.
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-XBLNR'  lv_date
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    ''  ''  ''  'BKPF-BKTXT'  'WIP Ageing-Reclass'
          CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  lv_first = 'Y'.

  LOOP AT it_summ INTO wa_summ.
*Begin of MOD-6++
    gv_hkont = '1441910'.
    AT FIRST.
      gv_xintb = ' '.
      PERFORM call_fss0.
    ENDAT.
    gv_hkont = wa_summ-hkontt.
    AT NEW hkontt.
      gv_xintb = ' '.
      PERFORM call_fss0.
    ENDAT.
*End of MOD-6++
    wa_summ-rast1 = wa_summ-rast1 + wa_summ-rast2 + wa_summ-rast3.
    wa_summ-rast2 = wa_summ-rast4.
    wa_summ-rast3 = wa_summ-rast5.
    IF wa_summ-rast1 IS NOT INITIAL OR wa_summ-rast2 IS NOT INITIAL OR
        wa_summ-rast3 IS NOT INITIAL.
***
      IF wa_summ-rast1 IS NOT INITIAL.
        IF lv_first = 'N'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMF05A'  '0330'  'X'  ''   ''
                   CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
        IF wa_summ-rast1 < 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '40'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSEIF wa_summ-rast1 > 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '50'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

*        lv_account = '1443901'.
        lv_account = wa_summ-hkontt.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RF05A-NEWKO' lv_account
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Item 1
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMF05A'  '0300' 'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        CLEAR lv_wrbtr.
        CLEAR lv_rast.
        lv_rast = ABS( wa_summ-rast1 ).
        WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Coding block
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLKACB'  '0002'  'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
        lv_first = 'N'.
      ENDIF.
***
      IF wa_summ-rast2 IS NOT INITIAL.
        IF lv_first = 'N'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMF05A'  '0330'  'X'  ''   ''
                   CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
        IF wa_summ-rast2 < 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '40'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSEIF wa_summ-rast2 > 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '50'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

*        lv_account = '1444901'.
        lv_account = wa_summ-hkontt.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RF05A-NEWKO' lv_account
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.


        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Item 1
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMF05A'  '0300' 'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        CLEAR lv_wrbtr.
        CLEAR lv_rast.
        lv_rast = ABS( wa_summ-rast2 ).
        WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Coding block
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLKACB'  '0002'  'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        lv_first = 'N'.
      ENDIF.
***
      IF wa_summ-rast3 IS NOT INITIAL.
        IF lv_first = 'N'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMF05A'  '0330'  'X'  ''   ''
                   CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.
        IF wa_summ-rast3 < 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '40'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ELSEIF wa_summ-rast3 > 0.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-NEWBS'  '50'
                  CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

*        lv_account = '1445901'.
        lv_account = wa_summ-hkontt.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'RF05A-NEWKO' lv_account
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Item 1
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMF05A'  '0300' 'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        CLEAR lv_wrbtr.
        CLEAR lv_rast.
        lv_rast = ABS( wa_summ-rast3 ).
        WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*       Coding block
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLKACB'  '0002'  'X'  ''   ''
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctr
                CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
                 CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
        lv_first = 'N'.
      ENDIF.

      CLEAR lv_wrbtr.
      CLEAR lv_rast.
      CLEAR lv_newbs.

      lv_rast = wa_summ-rast1 + wa_summ-rast2 + wa_summ-rast3.
      IF lv_rast < 0.
        lv_newbs = '50'.
      ELSE.
        lv_newbs = '40'.
      ENDIF.
      lv_rast =  ABS( lv_rast ).
      WRITE lv_rast TO lv_wrbtr CURRENCY gv_waers.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0330'  'X'  ''   ''
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'RF05A-NEWBS'  lv_newbs
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'RF05A-NEWKO'  '1441910'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '/00'
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

*     Add G/L Account Item
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0300'  'X'  ''   ''
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

*     Coding block
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLKACB'  '0002'  'X'  ''   ''
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'COBL-PRCTR'  wa_summ-prctro
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

*** MOD-001 * begin insert ***
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'COBL-SEGMENT'  wa_summ-segment
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
*** MOD-001 * end insert ***

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '=ENTE'
               CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

    ENDIF.
  ENDLOOP.

* End booking and Save
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0330'  'X'  ''   ''
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
           CHANGING struct_bdcdata.
  APPEND struct_bdcdata  TO i_bdcdata.
  CLEAR  struct_bdcdata.

  CALL TRANSACTION 'FB01' USING i_bdcdata
  UPDATE 'S' MODE gv_mode MESSAGES INTO gt_err.
*Begin of MOD-6++
  gv_hkont = '1441910'.
  gv_xintb = 'X'.
  PERFORM call_fss0.
  LOOP AT it_summ INTO wa_summ.
    gv_hkont = wa_summ-hkontt.
    AT NEW hkontt.
      gv_xintb = 'X'.
      PERFORM call_fss0.
    ENDAT.
  ENDLOOP.
*End of MOD-6++
ENDFORM.                    "reverse_reposting


************************************************************************
* FORM LOAD_POSTINGS2                                                  *
************************************************************************
FORM load_postings2.

  CLEAR it_wips[].

  SELECT bukrs gjahr monat blart
         belnr buzei bldat budat
         shkzg dmbtr waers prctr
         zfbdt zuonr hkont segment
         INTO TABLE it_wips
         FROM bsis                          " -> Postings table
         WHERE bukrs EQ p_bukrs             " Company Code
           AND hkont IN so_hknt2            " General Ledger Account
           AND budat LE p_keydat.           " Posting date >= key date


* Read all clearings with document date before the keydate
* and clearing date after the key date
  SELECT bukrs gjahr monat blart
         belnr buzei bldat budat
         shkzg dmbtr waers prctr
         zfbdt zuonr hkont segment
         APPENDING TABLE it_wips
         FROM bsas                          " -> Clearings table
         WHERE bukrs EQ p_bukrs             " Company Code
           AND hkont IN so_hknt2            " General Ledger Account
           AND budat LE p_keydat            " Posting date <= Key date
           AND augdt GT p_keydat.           " Clearing date > key date

  SORT it_wips.

  LOOP AT it_wips.
    IF it_wips-segment IS INITIAL.
      it_wips-segment = it_wips-prctr.
      MODIFY it_wips.
    ENDIF.
  ENDLOOP.

*** MOD-002 * begin ***
* Modify entries from segment reclass program (YSE_RECLASS_POSTING)
* --> Assignment with sales document
  it_wipsc[] = it_wips[].
  DELETE it_wipsc WHERE zuonr CA '/'.
  CHECK NOT it_wipsc[] IS INITIAL.

  SELECT belnr gjahr buzei zuonr
         INTO TABLE it_bsegi
         FROM bseg
         FOR ALL ENTRIES IN it_wipsc
         WHERE bukrs =  p_bukrs
           AND belnr =  it_wipsc-belnr
           AND gjahr =  it_wipsc-gjahr
           AND buzei NE it_wipsc-buzei.
  DELETE it_bsegi WHERE zuonr NA '/'.
  SORT it_bsegi BY belnr gjahr.
  DELETE ADJACENT DUPLICATES FROM it_bsegi COMPARING belnr gjahr.
  it_bseg[] = it_bsegi[].
    FREE: it_wipsc, it_bsegi.

  LOOP AT it_wips WHERE zuonr NA '/'.
    READ TABLE it_bseg WITH TABLE KEY belnr = it_wips-belnr
                                      gjahr = it_wips-gjahr.
    IF sy-subrc = 0.
      it_wips-zuonr   = it_bseg-zuonr.
      MODIFY it_wips.
    ENDIF.
  ENDLOOP.
  FREE it_bseg.
*** MOD-002 * end ***

ENDFORM.  " load_postings2


************************************************************************
* FORM CALC_DUE_AGEING2                                                *
************************************************************************
* Analyses the interval entries and extracts the amount of days        *
* to calculate the due dates                                           *
************************************************************************
FORM calc_due_ageing2.
  DATA:lt_mseg_temp       TYPE STANDARD TABLE OF str_mseg,
       wa_mseg_temp       TYPE str_mseg.
  DATA:anw_stat_existing  TYPE  xfeld,
       e_stsma            LIKE  jsto-stsma,
       line               LIKE  bsvx-sttxt,
       user_line          LIKE  bsvx-sttxt,
       stonr              LIKE  tj30-stonr.

  RANGES: lr_bwart   FOR mseg-bwart,
          lr_bklas   FOR mbew-bklas.

  DATA:lv_days_overdue  TYPE i,
       lv_vbeln         TYPE vbeln,
       lv_posnr         TYPE posnr,
       lv_vkorg         TYPE vkorg,
       lv_dmbtr_totm    TYPE dmbtr,
       lv_dmbtr_totp    TYPE dmbtr,
       lv_tabix         TYPE sytabix,
       lv_objnr         TYPE aufk-objnr.

  CONSTANTS: lc_neg  TYPE shkzg VALUE 'H'.


* Movement types to select
  lr_bwart-sign   = 'I'.
  lr_bwart-option = 'EQ'.
  lr_bwart-low    = '261'.
  APPEND lr_bwart.
  lr_bwart-low    = '262'.
  APPEND lr_bwart.
  lr_bwart-low    = '561'.
  APPEND lr_bwart.
  lr_bwart-low    = '562'.
  APPEND lr_bwart.
  lr_bwart-low    = '961'.
  APPEND lr_bwart.
  lr_bwart-low    = '962'.
  APPEND lr_bwart.

* Atlas Copco valuation classes
  lr_bklas-sign   = 'I'.
  lr_bklas-option = 'EQ'.
  lr_bklas-low    = '3040'.
  APPEND lr_bklas.
  lr_bklas-low    = '3070'.
  APPEND lr_bklas.
  lr_bklas-low    = '7900'.
  APPEND lr_bklas.
  lr_bklas-low    = '7920'.
  APPEND lr_bklas.

  LOOP AT it_wips.
    CLEAR  it_output2.
*   Copy standard fields
    MOVE-CORRESPONDING it_wips TO it_output2.
    it_output2-prctro = it_wips-prctr.
    lv_days_overdue = p_keydat - it_wips-bldat.

*   Check debit/credit indicator and adjust accordingly
    IF it_wips-shkzg = lc_neg.
      it_wips-dmbtr = 0 - it_wips-dmbtr.
    ENDIF.

*   Get Sales order number (and item nr.) from field ZUONR
    SPLIT it_wips-zuonr AT '/' INTO: lv_vbeln lv_posnr.
*   Leading zeros (when needed)
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = lv_vbeln
      IMPORTING
        output = lv_vbeln.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'"MOD-006++
      EXPORTING
        input  = lv_posnr
      IMPORTING
        output = lv_posnr.
*   Get sales organization
    SELECT SINGLE vkorg INTO lv_vkorg
           FROM vbak
           WHERE vbeln = lv_vbeln.

*   Get material segment via service orders
    CLEAR it_mseg[].
    SELECT m~matnr m~werks m~shkzg m~dmbtr m~aufnr
           INTO TABLE it_mseg
           FROM aufk AS a
           INNER JOIN mseg AS m
                      ON a~aufnr = m~aufnr
           INNER JOIN mkpf AS h                             "MOD-003
                      ON m~mblnr = h~mblnr  AND             "MOD-003
                         m~mjahr = h~mjahr                  "MOD-003
           WHERE a~kdauf =  lv_vbeln
             AND m~bwart IN lr_bwart
             AND h~budat LE p_keydat.                       "MOD-003

*Begin of ++MOD-006
    SELECT SINGLE aufnr
                  FROM aufk
                  INTO it_output2-aufnr
                  WHERE kdauf = lv_vbeln
                    AND kdpos = lv_posnr.
*End of ++MOD-006
*   Check if material segments found
    IF NOT it_mseg[] IS INITIAL.
*     Get profitcenters (in product hierarchy)
      CLEAR it_mvkei[].
      SELECT matnr vkorg prodh
             INTO TABLE it_mvkei
             FROM mvke
             FOR ALL ENTRIES IN it_mseg
             WHERE matnr = it_mseg-matnr
               AND vkorg = lv_vkorg.
      SORT it_mvkei BY matnr vkorg.
      DELETE ADJACENT DUPLICATES FROM it_mvkei
             COMPARING matnr vkorg.
      it_mvke[] = it_mvkei[].

*     Get valuation class
      CLEAR it_mbewi[].
      SELECT matnr bwkey bklas
             INTO TABLE it_mbewi
             FROM mbew
             FOR ALL ENTRIES IN it_mseg
             WHERE matnr = it_mseg-matnr
               AND bwkey = it_mseg-werks.
      SORT it_mbewi BY matnr bwkey.
      DELETE ADJACENT DUPLICATES FROM it_mbewi
             COMPARING matnr bwkey.
      it_mbew[] = it_mbewi[].

*     Process material segments
      DESCRIBE TABLE it_mseg LINES lv_tabix.
      CLEAR: lv_dmbtr_totm,
             lv_dmbtr_totp.
*     Total amount of material segments
      LOOP AT it_mseg.
*       Check debit/credit indicator
        IF it_mseg-shkzg = lc_neg.
          lv_dmbtr_totm = lv_dmbtr_totm - it_mseg-dmbtr.
        ELSE.
          lv_dmbtr_totm = lv_dmbtr_totm + it_mseg-dmbtr.
        ENDIF.
      ENDLOOP.

*     Check if total not zero.
      IF lv_dmbtr_totm = 0.
        it_output2-prctr = it_output2-segment = gc_error.
        APPEND it_output2.
        CONTINUE.       " Next document
      ENDIF.

*     Process individual material segments
      LOOP AT it_mseg ."where aufnr = it_output2-aufnr.
*        it_output2-aufnr = it_mseg-aufnr."MOD-006--
*       Check debit/credit indicator and adjust accordingly
        IF it_mseg-shkzg = lc_neg.
          it_mseg-dmbtr = 0 - it_mseg-dmbtr.
        ENDIF.
*       Amount
        it_mseg-dmbtr = it_mseg-dmbtr * it_wips-dmbtr / lv_dmbtr_totm.
*       Cumulate amount posted
        lv_dmbtr_totp = lv_dmbtr_totp + it_mseg-dmbtr.
*       Adjust amount (last line)
        IF sy-tabix = lv_tabix.
          it_mseg-dmbtr = it_mseg-dmbtr +
                          ( it_wips-dmbtr - lv_dmbtr_totp ).
        ENDIF.
*       Profitcenter
        CLEAR it_mvke.
        READ TABLE it_mvke WITH TABLE KEY matnr = it_mseg-matnr
                                          vkorg = lv_vkorg.
        it_output2-prctr  = it_mvke-prodh(4).
*        it_output2-matnr  = it_mvke-matnr.
*** MOD-004 * begin of change
        READ TABLE it_yse_fico_ageing WITH KEY prctr = it_output2-prctr hkont = it_output2-hkont.
        IF sy-subrc = 0.
          it_output2-prctr = it_yse_fico_ageing-zprctr_new.
        ENDIF.
*** MOD-004 * end of change

*** MOD-001 * begin of comment ***
**       Leading zeros (when needed)
*        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*          EXPORTING
*            input  = it_output2-prctr
*          IMPORTING
*            output = it_output2-prctr.
**       Segment
*        SELECT SINGLE segment INTO it_output2-segment
*               FROM yse_prctr_bl
*               WHERE prctr = it_output2-prctr.
**       Suppress leading zeros (when needed)
*        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*          EXPORTING
*            input  = it_output2-prctr
*          IMPORTING
*            output = it_output2-prctr.
*** MOD-001 * end of comment ***

*       Valuation class
        CLEAR it_mbew.
        READ TABLE it_mbew WITH TABLE KEY matnr = it_mseg-matnr
                                          bwkey = it_mseg-werks.
*       Insert amounts in correct interval
        IF lv_days_overdue <= gv_last_2.
          it_output2-rast2  = it_mseg-dmbtr.
          IF it_mbew-bklas IN lr_bklas.
            it_output2-hkontt = '0001443901'.
          ELSE.
            it_output2-hkontt = '0001443902'.
          ENDIF.
          it_output2-age = '1-30'."++MOD-005
        ELSEIF lv_days_overdue <= gv_last_3.
*          it_output2-rast3  = it_mseg-dmbtr."--MOD-005
          it_output2-rast2  = it_mseg-dmbtr."++MOD-005
          IF it_mbew-bklas IN lr_bklas.
            it_output2-hkontt = '0001443901'.
          ELSE.
            it_output2-hkontt = '0001443902'.
          ENDIF.
          it_output2-age = '31-60'."++MOD-005
        ELSEIF lv_days_overdue <= gv_last_4.
*          it_output2-rast4  = it_mseg-dmbtr."--MOD-005
          it_output2-rast2  = it_mseg-dmbtr."++MOD-005
          IF it_mbew-bklas IN lr_bklas.
            it_output2-hkontt = '0001444901'.
          ELSE.
            it_output2-hkontt = '0001444902'.
          ENDIF.
          it_output2-age = '61-90'."++MOD-005
        ELSE.
*          it_output2-rast5  = it_mseg-dmbtr."--MOD-005
          it_output2-rast2  = it_mseg-dmbtr."++MOD-005
          IF it_mbew-bklas IN lr_bklas.
            it_output2-hkontt = '0001445901'.
          ELSE.
            it_output2-hkontt = '0001445902'.
          ENDIF.
          it_output2-age = '>90'."++MOD-005
        ENDIF.

        APPEND it_output2.

      ENDLOOP.  " it_mseg

    ENDIF.      "it_mseg initial.

  ENDLOOP.      " it_wips

ENDFORM.                    " calculate_due_ageing2

*&---------------------------------------------------------------------*
*&      Form  BATCH_REPORT
*&---------------------------------------------------------------------*
*       Print report to spool ((batch processing
*----------------------------------------------------------------------*
FORM batch_report .

* Header
  WRITE: /01 sy-datum,
         100 'WIP ageing overview'(h01).
  ULINE AT /01(240).
  WRITE: /01 'Profit ctr'(006),
          13 'Accnt doc'(040),
          25 'Type'(041),
          31 'Doc.date'(042),
          43 'Post.date'(043),
          56 'Curr'(007),
          69 'None due'(017),
          82 'Overdue 1-30'(044),
          98 'Overdue 31-60'(045),
         115 'Overdue 61-90'(046),
         133 'Overdue > 90'(047),
         147 'Assignment'(021),
         167 'Source GL acc'(048),
         182 'Target GL acc'(049),
         197 'Fisc.year'(050),
         208 'Fisc.per'(051),
         218 'Service Order'(037),
         233 'Segment'(032).
  ULINE AT /01(240).

* Detail
  LOOP AT it_output INTO wa_output.
    WRITE: /01 wa_output-prctr,
            13 wa_output-belnr,
            25 wa_output-blart,
            31 wa_output-bldat,
            43 wa_output-budat,
            56 wa_output-waers,
            61 wa_output-rast1,
            78 wa_output-rast2,
            95 wa_output-rast3,
           112 wa_output-rast4,
           129 wa_output-rast5,
           147 wa_output-zuonr,
           167 wa_output-hkont,
           182 wa_output-hkontt,
           197 wa_output-gjahr,
           208 wa_output-monat,
           218 wa_output-aufnr,
           233 wa_output-segment.
  ENDLOOP.

ENDFORM.                    " BATCH_REPORT
*&---------------------------------------------------------------------*
*&      Form  NULLIFY_DEBIT_CREDIT_NEAR_AMT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM nullify_debit_credit_near_amt .
  TYPES: BEGIN OF ty_acc,
          sign      TYPE c,
          option(2) TYPE c,
          low       TYPE bsis-hkont,
          high      TYPE bsis-hkont,
          END OF ty_acc.
  TYPES: BEGIN OF ty_aufk,
         aufnr TYPE aufnr,
         kdauf TYPE kdauf,
         kdpos TYPE kdpos,
         END OF ty_aufk.
  TYPES: BEGIN OF ty_vbkd,
         vbeln TYPE vbeln,
         posnr TYPE posnr,
         bzirk TYPE bzirk,
         END OF ty_vbkd.
  DATA: it_acc  TYPE STANDARD TABLE OF ty_acc,
        lt_aufk TYPE STANDARD TABLE OF ty_aufk,
        lt_vbkd TYPE STANDARD TABLE OF ty_vbkd,
        ls_vbkd TYPE ty_vbkd,
        ls_aufk TYPE ty_aufk,
        wa_acc  TYPE ty_acc.
  DATA: l_wip   TYPE c,
        l_bldat TYPE bldat,
        l_budat TYPE budat,
        l_lin   TYPE i,
        l_idx   TYPE i,
        l_idx1  TYPE i,
        l_idx2  TYPE i,
        l_h     TYPE c,
        l_s     TYPE c,
        l_zuonr TYPE vbeln,
        l_posnr TYPE posnr,
        v_bal   TYPE dmbtr,
        v_bal1  TYPE dmbtr.

  wa_acc-sign   = 'I'.
  wa_acc-option = 'EQ'.
  wa_acc-low    = '0001441901'.
  APPEND wa_acc TO it_acc.
  CLEAR wa_acc.

  wa_acc-sign   = 'I'.
  wa_acc-option = 'EQ'.
  wa_acc-low    = '0001441903'.
  APPEND wa_acc TO it_acc.
  CLEAR wa_acc.
*Begin of MOD-008++
  it_output4[] = it_output[].
  SORT it_output4 BY belnr zuonr aufnr.
  DELETE ADJACENT DUPLICATES FROM it_output4 COMPARING aufnr.
  IF NOT it_output4[] IS INITIAL.
    SELECT aufnr
           kdauf
           kdpos
           FROM aufk
           INTO TABLE lt_aufk
           FOR ALL ENTRIES IN it_output4
           WHERE aufnr EQ it_output4-aufnr.
    REFRESH:it_output4[].
  ENDIF.
  IF NOT lt_aufk[] IS INITIAL.
    SELECT vbeln
           posnr
           bzirk
           FROM vbkd
           INTO TABLE lt_vbkd
           FOR ALL ENTRIES IN lt_aufk
           WHERE vbeln EQ lt_aufk-kdauf.
      SORT lt_vbkd BY vbeln posnr.        "+MOD-009
  ENDIF.
*End of MOD-008++
*  Check WIP accounts
  LOOP AT so_hknt1.
    READ TABLE it_acc INTO wa_acc WITH KEY low = so_hknt1-low.
    IF sy-subrc EQ 0.
      l_wip = 'X'.
      EXIT.
    ENDIF.
  ENDLOOP.
  IF l_wip EQ 'X'.
    LOOP AT it_output INTO wa_output.
      CLEAR:l_h,l_s.
      MOVE-CORRESPONDING: wa_output TO wa_output1.
      IF wa_output-rast2 LT '0' .
        wa_output1-rast2 = wa_output-rast2 * ( -1 ).
        l_h = 'X'.
        IF wa_output-zuonr+0(1) NE '0'.
          SPLIT wa_output-zuonr AT '/' INTO: l_zuonr l_posnr.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              input  = l_zuonr
            IMPORTING
              output = l_zuonr.
          CONCATENATE  l_zuonr '/' '0000' l_posnr INTO wa_output1-zuonr.
        ENDIF.
      ENDIF.
      IF l_h EQ 'X'.
*Begin of MOD-008++
        SPLIT wa_output1-zuonr AT '/' INTO: l_zuonr l_posnr.
        READ TABLE lt_vbkd INTO ls_vbkd WITH KEY vbeln = l_zuonr
                                                 posnr = l_posnr
                                        BINARY SEARCH.            "+MOD-009
        IF sy-subrc EQ 0.
          MOVE:ls_vbkd-bzirk TO wa_output1-bzirk.
        ENDIF.
*End of MOD-008++
        APPEND wa_output1 TO it_output3.
        CLEAR:l_h,ls_vbkd.
      ENDIF.
      IF wa_output-rast2 GT '0' .
        wa_output1-rast2 = wa_output-rast2 .
        l_s = 'X'.
        IF wa_output-zuonr+0(1) NE '0'.
          SPLIT wa_output-zuonr AT '/' INTO: l_zuonr l_posnr.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              input  = l_zuonr
            IMPORTING
              output = l_zuonr.
          CONCATENATE l_zuonr '/' '0000' l_posnr INTO wa_output1-zuonr.
        ENDIF.
      ENDIF.
      IF l_s EQ 'X'.
*Begin of MOD-008++
        SPLIT wa_output1-zuonr AT '/' INTO: l_zuonr l_posnr.
        READ TABLE lt_vbkd INTO ls_vbkd WITH KEY vbeln = l_zuonr
                                                 posnr = l_posnr
                                        BINARY SEARCH.            "+MOD-009.
        IF sy-subrc EQ 0.
          MOVE:ls_vbkd-bzirk TO wa_output1-bzirk.
        ENDIF.
*End of MOD-008++
        APPEND wa_output1 TO it_output4.
        CLEAR:l_s,ls_vbkd.
      ENDIF.
*      endif.
      CLEAR wa_output1.
    ENDLOOP.

    REFRESH: it_output.
    SORT it_output3 BY zuonr aufnr hkont prctr rast2.
    SORT it_output4 BY zuonr aufnr hkont prctr rast2.

*Profit Center wise nullify with service order is not initial
    LOOP AT it_output3 INTO wa_output.
      CLEAR:l_idx.
      l_idx = sy-tabix.
      READ TABLE it_output4 INTO wa_output1 WITH KEY zuonr = wa_output-zuonr
                                                     aufnr = wa_output-aufnr
                                                     hkont = wa_output-hkont
                                                     prctr = wa_output-prctr
                                                     rast2 = wa_output-rast2
                                                     BINARY SEARCH.           "+ MOD-009
      IF sy-subrc EQ 0.
        DELETE it_output4 INDEX sy-tabix.
        DELETE it_output3 INDEX l_idx.
      ENDIF.
    ENDLOOP.

    SORT it_output3 BY zuonr aufnr hkont prctr rast2 DESCENDING.
    SORT it_output4 BY zuonr aufnr hkont prctr rast2 DESCENDING.
    LOOP AT it_output3 INTO wa_output.
      CLEAR:l_idx,l_idx1.
      l_idx = sy-tabix.
      READ TABLE it_output4 INTO wa_output2 WITH KEY zuonr = wa_output-zuonr
                                                     aufnr = wa_output-aufnr
                                                     hkont = wa_output-hkont
                                                     prctr = wa_output-prctr.
      IF sy-subrc EQ 0.
        l_idx2 = sy-tabix.
        LOOP AT it_output4 INTO wa_output1 FROM l_idx2.
          l_idx1 = sy-tabix.
          IF wa_output1-zuonr EQ wa_output-zuonr AND
             wa_output1-aufnr EQ wa_output-aufnr AND
             wa_output1-hkont EQ wa_output-hkont AND
             wa_output1-prctr EQ wa_output-prctr.
            v_bal =  wa_output1-rast2 - wa_output-rast2 .
            IF v_bal GT '0'.
              wa_output1-rast2 =  v_bal.
              CLEAR wa_output3.
              MODIFY it_output4 INDEX l_idx1 FROM wa_output1 TRANSPORTING rast2.
              DELETE it_output3 INDEX l_idx.
              CLEAR:wa_output1,v_bal.
              EXIT.
            ELSEIF v_bal EQ '0'.
              DELETE it_output3 INDEX l_idx.
              DELETE it_output4 INDEX l_idx1.
              CLEAR:wa_output1,v_bal.
              EXIT.
            ELSEIF v_bal LT '0'.
              wa_output-rast2 = v_bal * ( -1 ).
              MODIFY it_output3 INDEX l_idx FROM wa_output TRANSPORTING rast2.
              DELETE it_output4 INDEX l_idx1.
              CLEAR:v_bal.
            ENDIF.
          ELSE.
            EXIT.
          ENDIF.
        ENDLOOP.

      ENDIF.
    ENDLOOP.

*Service order wise nullify
    LOOP AT it_output3 INTO wa_output.
      l_idx = sy-tabix.
      READ TABLE it_output4 INTO wa_output2 WITH KEY zuonr = wa_output-zuonr
                                                     aufnr = wa_output-aufnr
                                                     hkont = wa_output-hkont.
      IF sy-subrc EQ 0.
        l_idx2 = sy-tabix.
        LOOP AT it_output4 INTO wa_output1 FROM l_idx2.
          l_idx1 = sy-tabix.
          IF wa_output1-zuonr EQ wa_output-zuonr AND
             wa_output1-aufnr EQ wa_output-aufnr AND
             wa_output1-hkont EQ wa_output-hkont .
            v_bal =  wa_output1-rast2 - wa_output-rast2 .
            IF v_bal GT '0'.
              wa_output1-rast2 =  v_bal.
              CLEAR wa_output3.
              MODIFY it_output4 INDEX l_idx1 FROM wa_output1 TRANSPORTING rast2.
              DELETE it_output3 INDEX l_idx.
              CLEAR:wa_output1,v_bal.
              EXIT.
            ELSEIF v_bal EQ '0'.
              DELETE it_output3 INDEX l_idx.
              DELETE it_output4 INDEX l_idx1.
              CLEAR:wa_output1,v_bal.
              EXIT.
            ELSEIF v_bal LT '0'.
              wa_output-rast2 = v_bal * ( -1 ).
              MODIFY it_output3 INDEX l_idx FROM wa_output TRANSPORTING rast2.
              DELETE it_output4 INDEX l_idx1.
              CLEAR:v_bal.
            ENDIF.
          ELSE.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDLOOP.
    LOOP AT it_output3 INTO wa_output.
      MOVE:wa_output TO wa_output1.
      CLEAR: wa_output1-rast2,wa_output1-rast3,wa_output1-rast4,wa_output1-rast5.
      IF wa_output-age EQ '1-30'.
        v_bal = wa_output-rast2 * ( -1 ).
        CLEAR wa_output-rast2.
        MOVE:v_bal TO wa_output-rast2.
        MOVE:wa_output-rast2 TO wa_output1-rast2.
      ELSEIF wa_output-age EQ '31-60'.
        v_bal = wa_output-rast2 * ( -1 ).
        CLEAR wa_output-rast2.
        MOVE:v_bal TO wa_output-rast2.
        MOVE:wa_output-rast2 TO wa_output1-rast3.
      ELSEIF wa_output-age EQ '61-90'.
        v_bal = wa_output-rast2 * ( -1 ).
        CLEAR wa_output-rast2.
        MOVE:v_bal TO wa_output-rast2.
        MOVE:wa_output-rast2 TO wa_output1-rast4.
      ELSEIF wa_output-age EQ '>90'.
        v_bal = wa_output-rast2 * ( -1 ).
        CLEAR wa_output-rast2.
        MOVE:v_bal TO wa_output-rast2.
        MOVE:wa_output-rast2 TO wa_output1-rast5.
      ENDIF.
      APPEND wa_output1 TO it_output.
      CLEAR wa_output1.
    ENDLOOP.
    LOOP AT it_output4 INTO wa_output.
      MOVE:wa_output TO wa_output1.
      CLEAR: wa_output1-rast2,wa_output1-rast3,wa_output1-rast4,wa_output1-rast5.
      IF wa_output-age EQ '1-30'.
        MOVE:wa_output-rast2 TO wa_output1-rast2.
      ELSEIF wa_output-age EQ '31-60'.
        MOVE:wa_output-rast2 TO wa_output1-rast3.
      ELSEIF wa_output-age EQ '61-90'.
        MOVE:wa_output-rast2 TO wa_output1-rast4.
      ELSEIF wa_output-age EQ '>90'.
        MOVE:wa_output-rast2 TO wa_output1-rast5.
      ENDIF.
      IF wa_output-rast2 GT '0'.
        APPEND wa_output1 TO it_output.
        CLEAR wa_output1.
      ENDIF.
    ENDLOOP.
  ENDIF.
ENDFORM.                    " NULLIFY_DEBIT_CREDIT_NEAR_AMT
*&---------------------------------------------------------------------*
*&      Form  CALL_FSS0
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM call_fss0 .
  REFRESH: i_bdcdata1, gt_err.

  PERFORM bdc_dynpro      USING 'SAPLGL_ACCOUNT_MASTER_MAINTAIN' '2001'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=ACC_MOD'.
  PERFORM bdc_field       USING 'GLACCOUNT_SCREEN_KEY-SAKNR' gv_hkont.
  PERFORM bdc_field       USING 'GLACCOUNT_SCREEN_KEY-BUKRS' p_bukrs.

  PERFORM bdc_dynpro      USING 'SAPLGL_ACCOUNT_MASTER_MAINTAIN' '2001'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=TAB02'.

  PERFORM bdc_dynpro      USING 'SAPLGL_ACCOUNT_MASTER_MAINTAIN' '2001'.
  PERFORM bdc_field       USING 'BDC_OKCODE' '=SAVE'.
  PERFORM bdc_field       USING 'GLACCOUNT_SCREEN_CCODE-XINTB' gv_xintb.

  CALL TRANSACTION 'FSS0' USING i_bdcdata1
                          MODE gv_mode
                          UPDATE 'S'
                          MESSAGES INTO gt_err.

* Check for errors
  LOOP AT gt_err WHERE msgtyp = 'E'
                    OR msgtyp = 'A'.
    CALL FUNCTION 'RH_MESSAGE_GET'
      EXPORTING
*        SPRSL                   = SY-LANGU
        arbgb                   = gt_err-msgid
        msgnr                   = gt_err-msgnr
        msgv1                   = gt_err-msgv1
        msgv2                   = gt_err-msgv2
        msgv3                   = gt_err-msgv3
        msgv4                   = gt_err-msgv4
      IMPORTING
        msgtext                 = gv_msgtxt
      EXCEPTIONS
        message_not_found       = 1
        OTHERS                  = 2.

    WRITE: / gv_msgtxt.
  ENDLOOP.
  REFRESH:gt_err.
ENDFORM.                    " CALL_FSS0
*----------------------------------------------------------------------*
*        Start new screen                                              *
*----------------------------------------------------------------------*
FORM bdc_dynpro USING program dynpro.

  CLEAR i_bdcdata1.
  i_bdcdata1-program  = program.
  i_bdcdata1-dynpro   = dynpro.
  i_bdcdata1-dynbegin = 'X'.
  APPEND i_bdcdata1.

ENDFORM.                    "BDC_DYNPRO

*----------------------------------------------------------------------*
*        Insert field                                                  *
*----------------------------------------------------------------------*
FORM bdc_field USING fnam fval.

  CLEAR i_bdcdata1.
  i_bdcdata1-fnam = fnam.
  i_bdcdata1-fval = fval.
  APPEND i_bdcdata1.

ENDFORM.                    "bdc_field
*&---------------------------------------------------------------------*
*&      Form  SPLIT_DOC_POST
*&---------------------------------------------------------------------*
*       Split the posting documents into multiple if items cross more
*       than 999 or entered count on selection screen
*----------------------------------------------------------------------*
FORM SPLIT_DOC_POST .

    it_summ_tmp[] = it_summ[].
    REFRESH it_summ[].

    DESCRIBE TABLE it_summ_tmp LINES gv_lines.

    LOOP AT it_summ_tmp INTO wa_summ_tmp.
      wa_summ = wa_summ_tmp.
      APPEND wa_summ TO it_summ.

      gv_cnt      = gv_cnt + 1.
      gv_tot_cnt  = gv_tot_cnt + 1.
* If gv_cnt becomes equal to selection screen entered max lines count or total
* count of line itmes equal to total line item in internal table then post
      IF gv_cnt     EQ p_maxl   OR
         gv_tot_cnt EQ gv_lines.
        CLEAR gv_cnt.
        PERFORM reposting." TABLES it_summ.
        IF gv_error = 'N'.
          PERFORM reverse_reposting." TABLES it_summ.
        ENDIF.
* Refresh the table it_summ to accept the new/remaining entries to post
        REFRESH it_summ[].
      ENDIF.
    ENDLOOP.

    REFRESH it_summ_tmp[].

    CLEAR: gv_cnt,
           gv_tot_cnt,
           gv_lines,
           wa_summ,
           wa_summ_tmp.

ENDFORM.                    " SPLIT_DOC_POST

*List header: Column headings

*001:Profit ctr  Accnt doc   Type  Doc.date    Post.date    Curr          Non Due     Overdue 1-30    Overdue 31-60    Overdue 61-90     Overdue > 90  Assignment          Source GL acc  Target GL acc  Fisc.year  Fisc.per  Service order  Segment
*Text symbol text
*001:General selections
*002:Further selections
*003:Ageing time in days
*004:Delete old data
*005:Profit center
*006:Profit ctr
*007:Curr
*008:Currency code
*009:Doc Type
*010:Document type
*011:Account doc
*012:Account document
*013:Doc date
*014:Document date
*015:Post date
*016:Posting date
*017:None due
*018:Outside selected intervals
*019:Overdue >90
*020:Overdue >90
*021:Assignment
*022:Assignment number
*023:Source GL account
*024:Source General Ledger account
*025:Fisc year
*026:Fiscal year
*027:Fisc period
*028:Fiscal period
*030:Download for BW not possible if the inter
*031:vals are not default.
*032:Segment
*033:Segment for Segmental Reporting
*034:Reclass Postings
*035:Target GL account
*036:Target General Ledger account
*037:Service Order
*038:Service Order number
*040:Accnt doc
*041:Type
*042:Doc.date
*043:Post.date
*044:Overdue 1-30
*045:Overdue 31-60
*046:Overdue 61-90
*047:Overdue > 90
*048:Source GL acc
*049:Target GL acc
*050:Fisc.year
*051:Fisc.per
*052:BZIRK
*053:Sales District
*055:Split Line Itmes

*H01:WIP ageing overview
*Selection text
*P_BUKRS:        Company code
*P_KEYDAT:        Keydate
*P_MAXL:        Max Lines
*P_POST:        Create reclass postings in FI
*P_POSTD:        Posting date reposting
*P_RPOSTD:        Posting date reposting reverse
*RASTBIS1:        Ageing time 0
*RASTBIS2:        Ageing time  30
*RASTBIS3:        Ageing time  60
*RASTBIS4:        Ageing time  90
*SO_HKNT1:        G/L Account
*SO_HKNT2:        G/L Account (Spareparts PC)
