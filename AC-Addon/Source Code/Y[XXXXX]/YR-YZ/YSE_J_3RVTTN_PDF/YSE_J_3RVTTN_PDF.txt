REPORT YSE_J_3RVTTN MESSAGE-ID VW
                LINE-SIZE 85
                NO STANDARD PAGE HEADING.

* extended syntax checker should not detect any 'UNUSED VARIABLES'Error
SET EXTENDED CHECK OFF.

*------- Includes
INCLUDE VTTKDATA.                      "Shipment Header
INCLUDE VTTSDATA.                      "Shipment Stages
INCLUDE VTTPDATA.                      "Shipment Items
INCLUDE VBPADATA.                      "Partner
INCLUDE VTFADATA.                      "Flow
INCLUDE SADRDATA.                      "Address
INCLUDE VTLFDATA.                      "Deliveries selected
INCLUDE RVADTABL.                      "Messages
INCLUDE VSEDATA.                       "shipping units
INCLUDE RV56ACOM.                      "I/O-Structure

*------- Tables
TABLES: VBPLA, T005, T005T, T604T, MARC,
        VBDPL, MARM, vbfa, vbdkl, tcurx,
        addr1_val, likp,
        spell, komser, usr03, bnka.

* reactivate extended syntax checker ...
  SET EXTENDED CHECK ON.

*------- Types

TYPES: CMR_01_TYPE       LIKE CMR_01,
       CMR_02_TYPE       LIKE CMR_02,
       CMR_03_TYPE       LIKE CMR_03,
       CMR_04_TYPE       LIKE CMR_04,
       CMR_06FF_TYPE     LIKE CMR_06FF,
       CMR_06FF_TAB_TYPE LIKE CMR_06FF OCCURS 0,
       CMR_06A_TYPE      LIKE CMR_06A,
       CMR_14_TYPE       LIKE CMR_14,
       CMR_15_TYPE       LIKE CMR_15,
       CMR_16_TYPE       LIKE CMR_16,
       CMR_17_TYPE       LIKE CMR_17,
       CMR_20_TYPE       LIKE CMR_20,
       CMR_21_TYPE       LIKE CMR_21.

TYPES: BEGIN OF CMR_TYPE,
         LANGUAGE LIKE T005-SPRAS,
         COUNTRY  LIKE T005-LAND1,
         CMR_01   TYPE CMR_01_TYPE,
         CMR_02   TYPE CMR_02_TYPE,
         CMR_03   TYPE CMR_03_TYPE,
         CMR_04   TYPE CMR_04_TYPE,
         CMR_06FF TYPE CMR_06FF_TAB_TYPE,
         CMR_06A  TYPE CMR_06A_TYPE,
         CMR_14   TYPE CMR_14_TYPE,
         CMR_15   TYPE CMR_15_TYPE,
         CMR_16   TYPE CMR_16_TYPE,
         CMR_17   TYPE CMR_17_TYPE,
         CMR_20   TYPE CMR_20_TYPE,
         CMR_21   TYPE CMR_21_TYPE,
       END OF CMR_TYPE.

TYPES: CMR_TAB_TYP TYPE CMR_TYPE OCCURS 0.

CONSTANTS: c_posnr(6) TYPE C VALUE '000000'.
*------- General Data
DATA: RETCODE LIKE SY-SUBRC,           "Return code
      XSCREEN(1) TYPE C,               "Output on printer or screen
      X_OPEN TYPE C.

DATA: "|CMR_FORM           TYPE CMR_TAB_TYP,     "Documents to print
      SOMETHING_TO_PRINT TYPE BOOLEAN.         "Flag for printing

DATA: BEGIN OF PROTOCOL_TAB OCCURS 0,
         MSG_ARBGB LIKE SYST-MSGID,
         MSG_NR    LIKE SYST-MSGNO,
         MSG_TY    LIKE SYST-MSGTY,
         MSG_V1    LIKE SYST-MSGV1,
         MSG_V2    LIKE SYST-MSGV2,
         MSG_V3    LIKE SYST-MSGV3,
         MSG_V4    LIKE SYST-MSGV4.
DATA: END OF PROTOCOL_TAB.

* IMP RU Begin of insert Currency should always be RUB
data: lv_convert TYPE C,
      lv_kursk like komk-kurrf.
* IMP RU End of insert Currency should always be RUB

*------- Constant values
CONSTANTS:
  TN               LIKE VBPLK-GEWEI VALUE 'TO ',
  M                LIKE VBPLK-GEWEI VALUE 'M  '.

data: gc_badi_name type ref to J_3RV_1T_BADI,    "users' field filling
      gc_badi_descr type ref to J_3RV_AFS_DESCR. "AFS-material description

data: LANGUAGE LIKE sy-langu,
      aland like sadr-land1.

data: begin of ztrn.
* IMP RU Begin of delete
*      include structure J_3RT1_HEAD. "structure for header
* IMP RU End of delete
* IMP RU Begin of insert
       include structure YSE_J_3RT1_HEAD. "structure for header
* IMP RU End of insert

data: end of ztrn.

data: ltrn type YSE_J_3RT1_PG1. "internal table for page 1
data: wa_ltrn like line of ltrn.

data: begin of z_ltrn occurs 0. "internal table for page 1
* IMP RU Begin of delete
*      include structure J_3RT1_LINE.
* IMP RU End of delete
* IMP RU Begin of insert
      include structure YSE_J_3RT1_LINE.
* IMP RU End of insert
data: end of z_ltrn.
data: tabnam type YSE_J_3RT1_PG2. "internal table for page 2
data: wa_tabnam like line of tabnam.

* IMP RU Begin of insert
types: begin of wa_hu,
        venum like vekp-venum,
       end of wa_hu.
* IMP RU End of insert

types: begin of wa_ltr,
        werks like mseg-werks,
        lgort like mseg-lgort,
        charg like mseg-charg,
        key_field(105),
        matdet(100),
        wa_ltrn like line of ltrn,
       end of wa_ltr.
data: tt_ltr type standard table of wa_ltr with header line.

* IMP RU Begin of insert
data: tt_HU type standard table of wa_HU with header line.
* IMP RU End of insert

data: SEL LIKE ADDR1_SEL.
DATA: TOTAM     LIKE VBDPL-LFIMG.      "material quantity TOTAL
DATA: TOTPLC    type i.                "place quantity TOTAL
* IMP RU Begin of insert
DATA: TOTCAS    type i.                "Case quantity TOTAL
* IMP RU Begin of insert
DATA: TOTWT     LIKE VBDPL-BRGEW.      "gross weight TOTAL
DATA: TOTNT     LIKE VBDPL-NTGEW,      "net weight TOTAL
      P_TOTNT   LIKE VBDPL-NTGEW.
DATA: TOTVOL    LIKE VBDPL-NETWR.      "Amount w/o VAT TOTAL
DATA: TOTSUM    LIKE VBDPL-NETWR.      "Amount TOTAL
DATA: TOTNDS    LIKE VBDPL-NETPR.      "VAT amount TOTAL
DATA: SUM  TYPE P DECIMALS 3.       "Amount
* IMP RU Begin of insert
DATA: SUM2  TYPE P DECIMALS 3.       "Cases
* IMP RU End of insert
DATA: MM TYPE I, ONEHUNDRED TYPE I, PP(2).
DATA: NUM_LINE TYPE I, LIN_CNT TYPE I, lines_v TYPE I,
      NUM_LINE2 TYPE I,
      SPEL_NETO(100), num_lin type i, cnt type i,
      DEC_NET LIKE SPELL-DECIMAL,
      SPEL_BRTO(100), save_bukrs type t001-bukrs,
      DEC_BRT LIKE SPELL-DECIMAL,
      SPEL_LIMFG(100). "OKPO(10), OKDP(14).
DATA: NN TYPE i, AV_NETPR LIKE VBAP-KZWI3,
      ZAP TYPE i, numnakl type i, seqnum type n length 2,
      AV_NETWR LIKE VBAP-KZWI3.
* IMP RU Begin of delete
* DATA: vkorg type VTRLK-vkorg, kunwe type VTRLK-kunwe,
* IMP RU End of delete

* IMP RU Begin of insert
 DATA: vkorg type VTRLK-vkorg, kunwe type VTRLK-kunwe,
       lv_vbeln like slk-vbeln,
       lv_tknum like ztrn-tknum,
       lv_vhart TYPE VEKP-vhart,
       lv_counter(3) TYPE n,
       lv_venum TYPE VEKP-venum,
       it_venum type table of vekp-venum with header line,
       it_venum2 type table of vekp-venum with header line,
       it_venum3 type table of vekp-venum with header line,
       teller TYPE I,
       lv_GI_date TYPE likp-wadat,
       lv_year TYPE GJAHR,
       lv_month TYPE CHAR2,
       lv_day TYPE CHAR2,
       ADRNR_RE like slk-adrnr_ag,
       ADRNR_VKORG like slk-adrnr_ag,
       KUNNR_RE like VBPA-kunnr,
       lv_tarag like VEKP-tarag,
       lv_tot_tarag like VEKP-tarag,
       lv_tot_tarag2 like VEKP-tarag,
       lv_gross like VEKP-brgew,
       lv_gewei like VEKP-gewei,
       lv_laeng like VEKP-laeng,
       lv_breit like VEKP-breit,
       lv_hoehe like VEKP-hoehe,
       lv_meabm like VEKP-meabm,
       lv_laeng_c(17) type c,
       lv_breit_c(17) type c,
       lv_hoehe_c(17) type c,
       tot_tarag like VEKP-tarag,
       tot_gross like VEKP-tarag,
* IMP RU End of insert

      vstel type VTRLK-vstel, kunag type VTRLK-kunag.
DATA: BEGIN OF TKOMSER OCCURS 5.
        INCLUDE STRUCTURE RISERLS.
DATA: END   OF TKOMSER.

DATA: BEGIN OF TKOMSER_PRINT OCCURS 5.
        INCLUDE STRUCTURE KOMSER.
DATA: END   OF TKOMSER_PRINT.

DATA: STUZ  LIKE  MARM-UMREZ,
      STUN  LIKE  MARM-UMREN,
      MSEHT LIKE T006A-MSEHT.

* IMP RU Begin of insert
 DATA: lv_landx50 like t005t-landx50,
       lv_region like t005u-bezei,
       lv_bukrs like TVKO-bukrs,
       int1 type i.
* IMP RU End of insert

DATA: BEGIN OF TVBDPL OCCURS 0.    "Internal table for items
        INCLUDE STRUCTURE VBDPL.
DATA: END OF TVBDPL.
DATA: BEGIN OF HDOC,
        VBTYP LIKE VBAK-VBTYP,
        AUART LIKE VBAK-AUART,
        WAERK LIKE VBAK-WAERK,
        KNUMV LIKE VBAK-KNUMV,
        KALSM LIKE VBAK-KALSM,
        FKART LIKE VBRK-FKART,
      END OF HDOC.
DATA: BEGIN OF PDOC,
        LSMENG LIKE VBAP-LSMENG,
        VRKME  LIKE VBAP-VRKME,
        MATNR  LIKE VBAP-MATNR,
        KZWI3  LIKE VBAP-KZWI3,
        KZWI4  LIKE VBAP-KZWI4,
        KZWI5  LIKE VBAP-KZWI5,
        KZWI6  LIKE VBAP-KZWI6,
* IMP RU Begin of insert  currency always RUB
        CMPRE LIKE  VBAP-CMPRE,
* IMP RU End of insert currency always RUB
      END OF PDOC.

types: begin of vend_bank,
         lifnr like lfbk-lifnr,
         bankadat(140),
      end of vend_bank.
types: begin of partn_bank,
         kunnr like knbk-kunnr,
         bankadat(140),
       end of partn_bank.
data: eknam_bank type vend_bank,
      payer_bank type partn_bank.

*----------------------------------------------------------------------*
*        Aufruf der Entry-Routine aus der Nachrichtensteuerung         *
*----------------------------------------------------------------------*
FORM ENTRY USING RETURN_CODE US_SCREEN.  "#EC *

  CLEAR RETCODE.
  XSCREEN = US_SCREEN.
  PERFORM PROCESSING.
  IF RETCODE NE 0.
    RETURN_CODE = 1.
  ELSE.
    RETURN_CODE = 0.
  ENDIF.

ENDFORM.

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM PROCESSING.

  PERFORM INITIALIZE_DATA.

  PERFORM GET_DATA.

  IF ( SOMETHING_TO_PRINT = TRUE ).
    if not seqnum is initial.
      seqnum = seqnum + 1.
      concatenate vttkvb-tknum '-' seqnum into ztrn-tknum.
      shift ztrn-tknum left deleting leading '0'.
    endif.
    PERFORM PRINT_FORM.
  ELSE.
    LOOP AT PROTOCOL_TAB.
      MOVE PROTOCOL_TAB-MSG_ARBGB TO SYST-MSGID.
      MOVE PROTOCOL_TAB-MSG_NR    TO SYST-MSGNO.
      MOVE PROTOCOL_TAB-MSG_TY    TO SYST-MSGTY.
      MOVE PROTOCOL_TAB-MSG_V1    TO SYST-MSGV1.
      MOVE PROTOCOL_TAB-MSG_V2    TO SYST-MSGV2.
      MOVE PROTOCOL_TAB-MSG_V3    TO SYST-MSGV3.
      MOVE PROTOCOL_TAB-MSG_V4    TO SYST-MSGV4.
      PERFORM PROTOCOL_UPDATE.
    ENDLOOP.
    RETCODE = 1.
  ENDIF.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM INITIALIZE_DATA                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM INITIALIZE_DATA.

  CLEAR:   PROTOCOL_TAB.
  REFRESH:   "CMR_FORM,
           PROTOCOL_TAB.
  SOMETHING_TO_PRINT = TRUE.
  clear X_OPEN.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM OPEN_FORM                                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  US_SCREEN                                                     *
*  -->  US_COUNTRY                                                    *
*---------------------------------------------------------------------*
FORM OPEN_FORM USING  US_SCREEN  LIKE XSCREEN
                      US_COUNTRY LIKE SADR-LAND1.            "SADR40A

***INCLUDE RVADOPFO .

DATA: LVF_DEVICE(30)    TYPE   C,
      LVF_DIALOG(1)     TYPE   C   VALUE ' ',
      LVS_RECIPIENT     LIKE   SWOTOBJID,
      LVS_SENDER        LIKE   SWOTOBJID,
      LVS_SNAST         TYPE   SNAST,
      LVF_PROGRAM       LIKE   SY-REPID,
      LVS_COMM_TYPE     TYPE   AD_COMM,
      LVS_COMM_VALUES   TYPE   SZADR_COMM_VALUES.


* reset return code
  RETCODE = 0.

* if there is a communication strategy used ...
  IF NOT NAST-TCODE IS INITIAL AND NAST-NACHA EQ '5'.

*   ... use stratagy to get communication type
    CALL FUNCTION 'ADDR_GET_NEXT_COMM_TYPE'
         EXPORTING
              STRATEGY           = NAST-TCODE
*             ADDRESS_TYPE       =
*             ADDRESS_NUMBER     = VBDKA-ADRNR
*             PERSON_NUMBER      = VBDKA-ADRNP
              ADDRESS_NUMBER     = ADDR_KEY-ADDRNUMBER
              PERSON_NUMBER      = ADDR_KEY-PERSNUMBER
         IMPORTING
              COMM_TYPE          = LVS_COMM_TYPE
              COMM_VALUES        = LVS_COMM_VALUES
*        TABLES
*             STRATEGY_TABLE     =
         EXCEPTIONS
              ADDRESS_NOT_EXIST  = 1
              PERSON_NOT_EXIST   = 2
              NO_COMM_TYPE_FOUND = 3
              INTERNAL_ERROR     = 4
              PARAMETER_ERROR    = 5
              OTHERS             = 6.
    IF SY-SUBRC <> 0.
      retcode = sy-subrc.
      SYST-MSGTY = 'E'.
      perform protocol_update.
    ENDIF.

  ENDIF.


* convert communication data
  MOVE-CORRESPONDING NAST TO LVS_SNAST.
  MOVE SY-REPID           TO LVF_PROGRAM.
  CALL FUNCTION 'CONVERT_COMM_TYPE_DATA'
       EXPORTING
            PI_COMM_TYPE              = LVS_COMM_TYPE
            PI_COMM_VALUES            = LVS_COMM_VALUES
            PI_SCREEN                 = US_SCREEN
*           PI_NEWID                  =
            PI_COUNTRY                = US_COUNTRY
            PI_REPID                  = LVF_PROGRAM
            PI_SNAST                  = LVS_SNAST
       IMPORTING
            PE_ITCPO                  = ITCPO
            PE_DEVICE                 = LVF_DEVICE
            PE_MAIL_RECIPIENT         = LVS_RECIPIENT
            PE_MAIL_SENDER            = LVS_SENDER
       EXCEPTIONS
            COMM_TYPE_NOT_SUPPORTED   = 1
            RECIPIENT_CREATION_FAILED = 2
            SENDER_CREATION_FAILED    = 3
            OTHERS                    = 4.
  IF SY-SUBRC <> 0.
    RETCODE = SY-SUBRC.
    SYST-MSGTY = 'E'.
    PERFORM PROTOCOL_UPDATE.
  ENDIF.

  check retcode eq 0.

* if there is no communication type
  IF  LVS_COMM_TYPE IS INITIAL.
*   set device
    CASE NAST-NACHA.
      WHEN '1'.
        LVF_DEVICE = 'PRINTER'.
        ITCPO-TDNEWID = 'X'.
      WHEN '2'.
        LVF_DEVICE = 'TELEFAX'.
        ITCPO-TDTELENUM = NAST-TELFX.
        IF NAST-TLAND IS INITIAL.
          ITCPO-TDTELELAND = US_COUNTRY.
        ELSE.
          ITCPO-TDTELELAND = NAST-TLAND.
        ENDIF.
        ITCPO-TDSENDDATE = NAST-VSDAT.
        ITCPO-TDSENDTIME = NAST-VSURA.
        ITCPO-TDFAXUSER  = NAST-USNAM.
      WHEN '3'.
        LVF_DEVICE = 'TELETEX'.
        ITCPO-TDTELENUM = NAST-TELTX.
        IF NAST-TLAND IS INITIAL.
          ITCPO-TDTELELAND = US_COUNTRY.
        ELSE.
          ITCPO-TDTELELAND = NAST-TLAND.
        ENDIF.
        ITCPO-TDSENDDATE = NAST-VSDAT.
        ITCPO-TDSENDTIME = NAST-VSURA.
     WHEN '4'.
        LVF_DEVICE = 'TELEX'.
        ITCPO-TDTELENUM = NAST-TELX1.
        IF NAST-TLAND IS INITIAL.
          ITCPO-TDTELELAND = US_COUNTRY.
        ELSE.
          ITCPO-TDTELELAND = NAST-TLAND.
        ENDIF.
        ITCPO-TDSENDDATE = NAST-VSDAT.
        ITCPO-TDSENDTIME = NAST-VSURA.
      WHEN OTHERS.
        LVF_DEVICE = 'PRINTER'.
    ENDCASE.
  ENDIF.

* OTF-Output, wenn Browser-Druck
  if nast-sort1 = 'EBPP'.
    itcpo-tdgetotf = 'X'.
  endif.

PERFORM OPEN_FORM_pdf.

ENDFORM.  "open_form

FORM PRINT_FORM.            "SADR40A

PERFORM OPEN_FORM USING XSCREEN slk-aland.

perform GET_BANK.

  concatenate ztrn-eknam eknam_bank-bankadat into ztrn-eknam
     separated by space.
  condense ztrn-eknam.

 if nast-kschl <> 'ZU01' and nast-kschl <> 'ZU02'.
   clear ztrn-eknam.
 endif.

* IMP RU Begin delete
*  concatenate ztrn-plnam payer_bank-bankadat into ztrn-plnam
*     separated by space.
*  condense ztrn-plnam.
* IMP RU End delete

* get BAdI instance
TRY.
get badi gc_badi_name.
CATCH cx_badi_not_implemented. "#EC NO_HANDLER
CATCH cx_badi_multiply_implemented.
  MESSAGE e001(J3R_LEGAL_FORMS).
CATCH cx_badi_initial_context.
  MESSAGE e002(J3R_LEGAL_FORMS).
ENDTRY.

* IMP RU Begin of delete
* BADI: update fields
*IF gc_badi_name IS BOUND.
*  CALL BADI gc_badi_name->UPDATE_PAGE1
*    changing
*       i_ztrn   = ztrn
*       i_ltrn   = ltrn
*    exceptions
*       OTHERS   = 1.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.
*endif.
* IMP RU End of delete

DATA: desc, sumrz type FLAG,
      price(15), afs_detailes(100),
      cnt type i, num type i, key_field(105).

DATA : BEGIN OF i_totcas OCCURS 0,
        venum LIKE vepo-venum,
        counter TYPE i,
       END OF i_totcas.

  CLEAR desc. clear sumrz.

* Get BADI instance
  TRY.
    get badi gc_badi_descr.
    CATCH cx_badi_not_implemented. "#EC NO_HANDLER
    CATCH cx_badi_multiply_implemented.
      MESSAGE e001(J3R_LEGAL_FORMS).
    CATCH cx_badi_initial_context.
      MESSAGE e002(J3R_LEGAL_FORMS).
  ENDTRY.

  IF gc_badi_descr IS BOUND.
    desc = 'X'.
  ENDIF.

  select single sumrz from J_3r_lo_output into sumrz
     where KSCHL    = TNAPR-KSCHL
       and NACHA    = TNAPR-NACHA
       and KAPPL    = TNAPR-KAPPL.

  LOOP at tt_ltr.
    IF desc eq 'X'.
      clear AFS_DETAILES.
      CALL BADI gc_badi_descr->MATERIAL_DETAILS
        exporting
           MATNR    = tt_ltr-wa_ltrn-MATNR
           WERKS    = tt_ltr-WERKS
           LGORT    = tt_ltr-LGORT
           CHARG    = tt_ltr-CHARG
        importing
           DETAILES = AFS_DETAILES.
*        exceptions
*           OTHERS   = 1.
*      IF sy-subrc <> 0.
*        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*      else.
        tt_ltr-matdet = AFS_DETAILES.
*      ENDIF.
    ENDIF.

    price = tt_ltr-wa_ltrn-netpr.
    concatenate tt_ltr-wa_ltrn-MATNR tt_ltr-WERKS tt_ltr-LGORT tt_ltr-wa_ltrn-prejsk_num
       tt_ltr-wa_ltrn-artikul tt_ltr-wa_ltrn-VRKME tt_ltr-wa_ltrn-pack_type PRICE
       tt_ltr-wa_ltrn-seq_num
          into tt_ltr-key_field.
    condense tt_ltr-key_field.
    modify tt_ltr.
  ENDLOOP.

  if not sumrz is initial.
    refresh ltrn. clear wa_ltrn.
    sort tt_ltr by key_field.
    clear cnt. clear key_field. clear NUM_LINE. clear num.
    DESCRIBE TABLE tt_ltr LINES NUM_LINE.
    loop at tt_ltr.
    num = num + 1.
      if sy-tabix eq 1.
        clear tt_ltr-wa_ltrn-numlev.
        move-corresponding tt_ltr-wa_ltrn to wa_ltrn.
        key_field = tt_ltr-key_field.
        cnt = cnt + 1.
      else.
        if tt_ltr-key_field eq key_field.
          wa_ltrn-brgew = wa_ltrn-brgew + tt_ltr-wa_ltrn-brgew.
          wa_ltrn-ntgew = wa_ltrn-ntgew + tt_ltr-wa_ltrn-ntgew.
          wa_ltrn-lfimg = wa_ltrn-lfimg + tt_ltr-wa_ltrn-lfimg.
          wa_ltrn-netwr = wa_ltrn-netwr + tt_ltr-wa_ltrn-netwr.
          wa_ltrn-place = wa_ltrn-place + tt_ltr-wa_ltrn-place.
          cnt = cnt + 1.
        else.
          if cnt = 1.
            clear wa_ltrn-arktx.
            concatenate tt_ltr-wa_ltrn-arktx tt_ltr-matdet into wa_ltrn-arktx.
          endif.
          append wa_ltrn  to ltrn.
          clear wa_ltrn. clear cnt.
          clear tt_ltr-wa_ltrn-numlev.
          move-corresponding tt_ltr-wa_ltrn to wa_ltrn.
          key_field = tt_ltr-key_field.
          cnt = cnt + 1.
        endif.
      endif.
      if num = NUM_LINE.
        if cnt = 1.
          clear wa_ltrn-arktx.
          concatenate tt_ltr-wa_ltrn-arktx tt_ltr-matdet into wa_ltrn-arktx.
        endif.
        append wa_ltrn  to ltrn.
      endif.
    endloop.
  elseif desc eq 'X'.
    refresh ltrn. clear wa_ltrn.
    Loop at tt_ltr.
      move-corresponding tt_ltr-wa_ltrn to wa_ltrn.
      clear wa_ltrn-arktx.
      concatenate tt_ltr-wa_ltrn-arktx tt_ltr-matdet into wa_ltrn-arktx.
      append wa_ltrn  to ltrn.
      clear wa_ltrn.
    endloop.
  endif.
  refresh tt_ltr.

move ltrn[] to z_ltrn[].
clear wa_ltrn. refresh ltrn. clear zap.
clear num_line. clear num_lin. clear nn.
describe table z_ltrn lines num_line.
clear totwt. clear totnt. clear totsum. clear totplc. clear totcas. clear tot_tarag. clear tot_gross.
clear cnt. clear numnakl.

loop at z_ltrn.
  cnt = cnt + 1.
  zap = zap + 1.  "number of records
  move z_ltrn to wa_ltrn.
  num_lin = num_lin + 1.
  nn = num_lin.
  at end of numlev.
   if wa_ltrn-numlev is initial and cnt ne num_line.
    nn = nn + wa_ltrn-lfimg.
    zap = zap - 1.
   endif.
  endat.
  if nn > 10.
   num_lin = num_lin - 1.
   clear wa_ltrn.
  else.
***********
    TOTWT = TOTWT + wa_ltrn-BRGEW.       "gross weight TOTAL
    TOTNT = TOTNT + wa_ltrn-NTGEW.       "net weight TOTAL
    TOTSUM = TOTSUM + wa_ltrn-NETWR.     "amount with VAT  TOTAL
    totplc = totplc + wa_ltrn-place.  "??? number of places
    totcas = totcas + wa_ltrn-HANDL_NBR.  " number of cases
    tot_tarag = tot_tarag + wa_ltrn-BRGEW.
    tot_gross = tot_gross + wa_ltrn-BRGEW.
    if not wa_ltrn-matnr is initial.
      wa_tabnam-matnr = wa_ltrn-matnr.
      wa_tabnam-place = wa_ltrn-place.
      wa_tabnam-arktx = wa_ltrn-arktx.
      collect wa_tabnam into tabnam.
    endif.
************
   append wa_ltrn to ltrn.
  endif.
  mm = num_lin.
  if num_line eq cnt and num_lin < 10
     or nn > 10 and num_lin < 10.
    clear wa_ltrn.
    do.
     if mm < 10.
       append wa_ltrn to ltrn.
       mm = mm + 1.
     else.
       exit.
     endif.
    enddo.
  endif.
  if mm = 10.
  ztrn-BRGEW = TOTWT.
  ztrn-NTGEW = TOTNT.
if nast-kschl = 'ZU01'.
  ztrn-netwr = TOTSUM.
endif.
  clear mm.
 CLEAR it_venum3[].
 LOOP AT ltrn into wa_ltrn.
 CLEAR it_venum2[].
 CLEAR lines_v.
 select venum from vepo into table it_venum2
    where vbeln eq wa_ltrn-VBELN
      and matnr eq wa_ltrn-MATNR
      and posnr eq wa_ltrn-POSNR.
 describe table it_venum2 lines lines_v.
 if not lines_v is initial.
  LOOP AT it_venum2.
    it_venum3 = it_venum2.
    append it_venum3.
  ENDLOOP.
 endif.
 ENDLOOP.

 SORT it_venum3.
 DELETE ADJACENT DUPLICATES from it_venum3.
 LOOP AT it_venum3.
   select single gewei tarag from vekp into (lv_gewei, lv_tot_tarag2)
     where venum = it_venum3.
   PERFORM UNIT_CONVERSION_SIMPLE USING lv_gewei TN
                                  changing lv_tot_tarag2.
   tot_tarag = tot_tarag + lv_tot_tarag2.
 ENDLOOP.

  ztrn-tot_tarag = TOT_TARAG.
  ztrn-tot_gross = TOT_GROSS.
  perform itogi.
  clear wa_ltrn. clear num_lin. clear zap.
* IMP RU Begin of delete
* BADI: update page 2 and totals
*  IF gc_badi_name IS BOUND.
*    CALL BADI gc_badi_name->UPDATE_TOTALS
*      exporting
*         i_ltrn   = ltrn
*      changing
*         i_ztrn   = ztrn
*         i_tabnam = tabnam
*      exceptions
*         OTHERS   = 1.
*    IF sy-subrc <> 0.
*      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                  WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*    ENDIF.
*  endif.
* IMP RU End of delete
  perform print_pdf.
  refresh ltrn. clear wa_tabnam. refresh tabnam.
  clear totwt. clear totnt. clear totsum. clear totplc. clear totcas. clear tot_tarag. clear tot_gross.
  numnakl = numnakl + 1.
  pp = numnakl.
  concatenate ztrn-tknum '/' pp into ztrn-tknum.
  if nn > 10.
    clear nn.
    move z_ltrn to wa_ltrn.
    num_lin = num_lin + 1.
    nn = nn + 1.
***********
    TOTWT = TOTWT + wa_ltrn-BRGEW.
    TOTNT = TOTNT + wa_ltrn-NTGEW.
    TOTSUM = TOTSUM + wa_ltrn-NETWR.
    totplc = totplc + wa_ltrn-place.  "??? number of places
    totcas = totcas + wa_ltrn-HANDL_NBR.
    tot_tarag = tot_tarag + wa_ltrn-BRGEW.
    tot_gross = tot_gross + wa_ltrn-BRGEW.
   if not wa_ltrn-matnr is initial.
    wa_tabnam-matnr = wa_ltrn-matnr.
    wa_tabnam-place = wa_ltrn-place.
    collect wa_tabnam into tabnam.
   endif.
************
    append wa_ltrn to ltrn.
  endif.
  endif.
endloop.

PERFORM CLOSE_FORM_pdf.
ENDFORM.


*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM PROTOCOL_UPDATE.

  CHECK XSCREEN = FALSE.               "output on printer

  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
       EXPORTING
            MSG_ARBGB = SYST-MSGID
            MSG_NR    = SYST-MSGNO
            MSG_TY    = SYST-MSGTY
            MSG_V1    = SYST-MSGV1
            MSG_V2    = SYST-MSGV2
            MSG_V3    = SYST-MSGV3
            MSG_V4    = SYST-MSGV4.

ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM GET_DATA.

  DATA: SHIPMENT_NUM LIKE VTTK-TKNUM,
        CMR_RECORD   TYPE CMR_TYPE,
        SADR_BEGIN   LIKE SADR,
        SADR_END     LIKE SADR,
        CMR_XVTTS    LIKE XVTTS OCCURS 0 WITH HEADER LINE.
                                       "print relevant segments
  DATA: FLAG TYPE BOOLEAN, ln type i.

  select single spras from T002C into language
     where spras = 'R'
       and LAINST = 'X'.
  if sy-subrc eq 0.
    SET LANGUAGE language.
  else.
    language = sy-langu.
  endif.

  SHIPMENT_NUM = NAST-OBJKY.
  clear ztrn.


  CALL FUNCTION 'RV_SHIPMENT_PRINT_VIEW'
       EXPORTING
            SHIPMENT_NUMBER     = SHIPMENT_NUM
            OPTION_TVTK         = TRUE          "Shipmenttype Y/N
            OPTION_TTDS         = TRUE          "Disposition Y/N
            LANGUAGE            = LANGUAGE
            OPTION_ITEMS        = TRUE          "Transport Items Y/N
            OPTION_SALES_ORDERS = TRUE          "Transport Segments Y/N
            OPTION_EXPORT_DATA  = TRUE          "Partners Y/N
            OPTION_SEGMENTS     = TRUE          "Sales orders Y/N
            OPTION_PARTNERS     = TRUE          "Export data Y/N
            OPTION_PACKAGES     = TRUE          "Packages Y/N
            OPTION_FLOW         = TRUE          "Flow Y/N
            OPTION_NO_REFRESH   = FALSE         "Refresh Tables Y/N
       IMPORTING
            F_VTTKVB            = VTTKVB        "Shipment Head
            F_TVTK              = TVTK          "Shipmenttype
            F_TVTKT             = TVTKT         "Description Shipmenttye
            F_TTDS              = TTDS          "Disposition
            F_TTDST             = TTDST         "Description Disposition
            F_VBPLA             = VBPLA         "Packages
       TABLES
            F_VTTP              = XVTTP         "Shipment Items
            F_TRLK              = SLK           "Delivery
            F_TRLP              = SLP           "Delivery Item
            F_VTTS              = XVTTS         "Shipment Segments
            F_VTSP              = XVTSP         "Segments/Items
            F_VBPA              = XVBPA         "Partner
            F_VBADR             = XVBADR        "Address
            F_VTFA              = XVTFA         "Flow
            F_VBPLK             = XVBPLK        "Shipment Unit Header
            F_VBPLP             = XVBPLP        "Shipment Unit
            F_VBPLS             = XVBPLS        "Shipment Unit Sum
       EXCEPTIONS
            NOT_FOUND           = 1
            OTHERS              = 2.

  IF NOT ( SY-SUBRC IS INITIAL ).
* save protocol record
    PROTOCOL_TAB-MSG_ARBGB = 'VW'.
    PROTOCOL_TAB-MSG_NR    = '010'.
    PROTOCOL_TAB-MSG_TY    = 'E'.
    PROTOCOL_TAB-MSG_V1    = SHIPMENT_NUM.
    APPEND PROTOCOL_TAB.
* set flag nothing to print
    SOMETHING_TO_PRINT = FALSE.
  ELSE.
    ztrn-tknum = vttkvb-tknum.
    ztrn-erdat = vttkvb-erdat.
    ztrn-p_day = vttkvb-erdat+6.
    ztrn-p_month = vttkvb-erdat+4(2).
    ztrn-p_gjahr = vttkvb-erdat(4).
* expeditor adress
    select single adrnr from lfa1 into SEL-ADDRNUMBER
      where lifnr eq vttkvb-tdlnr.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
         EXPORTING
              INPUT  = SEL-ADDRNUMBER
         IMPORTING
              OUTPUT = SEL-ADDRNUMBER.
    clear addr1_val.
    sel-nation = 'R'.
    CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    if sy-subrc ne 0.
      clear sel-nation.
      CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    endif.
    concatenate ztrn-eknam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
       ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
       ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
       ADDR1_VAL-TEL_NUMBER into ztrn-eknam separated by space.

  CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
       EXPORTING
            USER_NAME              = VTTKVB-ERNAM
       IMPORTING
*            USER_ADDRESS           = USER_ADDRESS
            USER_USR03             = USR03
       EXCEPTIONS
            USER_ADDRESS_NOT_FOUND = 1
            OTHERS                 = 2."USR0340A

  IF SY-SUBRC NE 0.
    CLEAR PROTOCOL_TAB.
*    PROTOCOL_TAB-MSORT = '    '.
    PROTOCOL_TAB-MSG_ARBGB = 'FB'.
    PROTOCOL_TAB-MSG_TY = 'I'.
    PROTOCOL_TAB-MSG_NR = '240'.
    PROTOCOL_TAB-MSG_V1 = VTTKVB-ERNAM.
    APPEND PROTOCOL_TAB.
  ENDIF.
  ztrn-name1 = USR03-name1.
  ztrn-name2 = USR03-name2.
  ztrn-telnr = USR03-telnr.

*the first line of leg
*    PERFORM GET_LEGS_TO_PRINT TABLES CMR_XVTTS.
*  CLEAR:   CMR_XVTTS.
*  REFRESH: CMR_XVTTS.

*  SORT XVTTS BY TSRFO.
* check legs
*  LOOP AT XVTTS.
*    PERFORM CHECK_PRINT_RELEVANCE USING    XVTTS
*                                  CHANGING FLAG.
* exit if the first print-relevant leg was found
*    move XVTTS TO CMR_XVTTS.
*    APPEND CMR_XVTTS.
*    EXIT.
*  ENDLOOP.

    FLAG = TRUE.
*    LOOP AT CMR_XVTTS.   "the first line of leg
*      CLEAR: CMR_RECORD,
*             SADR_BEGIN,
*             SADR_END.
** get address data of leg (begin and end)
*      PERFORM GET_ADDRESS_DATA_OF_LEG USING CMR_XVTTS
*                                     SADR_BEGIN
*                                     SADR_END.
** set country and language
*      CMR_RECORD-COUNTRY  = SADR_BEGIN-LAND1.
*      CMR_RECORD-LANGUAGE = SY-LANGU.
*      SELECT SINGLE SPRAS INTO CMR_RECORD-LANGUAGE FROM T005
*                          WHERE LAND1 = CMR_RECORD-COUNTRY.
*      APPEND CMR_RECORD TO CMR_FORM.

*********

    seqnum = 0.
    clear wa_ltrn. refresh ltrn.
    clear wa_tabnam. refresh tabnam.
    clear num_lin.
    clear totplc. clear TOTSUM. clear totcas. clear tot_tarag. clear tot_gross.
    clear: ztrn-gewei, ztrn-brgew, ztrn-ntgew.
    clear tt_ltr. refresh tt_ltr.
* IMP RU Begin of delete
*    clear: vkorg, kunwe, vstel, kunag.
*    sort slk by vkorg kunwe vstel kunag.
* IMP RU End of delete

* IMP RU Begin of insert
     clear: vkorg, kunwe, vstel, kunag.
     sort slk by vkorg kunwe vstel kunag.
* IMP RU End of insert

    loop at slk.  " delivery heads
      if sy-tabix eq 1.
       SAVE_BUKRS = slk-bukrs.
       select single paval from t001z into ztrn-CHIEF_ACC
          where bukrs eq SAVE_BUKRS
            and   party eq 'SAPR15'.
      endif.
*********************************************
      if sy-tabix ne 1.
* IMP RU Begin of delete
*       if slk-vkorg ne vkorg or slk-kunwe ne kunwe or
*          slk-vstel ne vstel or slk-kunag ne kunag.
* IMP RU End of delete

        seqnum = seqnum + 1.
        concatenate vttkvb-tknum '-' seqnum into ztrn-tknum.
        shift ztrn-tknum left deleting leading '0'.
        PERFORM PRINT_FORM.
        clear wa_ltrn. refresh ltrn.
        clear wa_tabnam. refresh tabnam.
        clear num_lin.
        clear totplc. clear TOTSUM. clear totcas. clear tot_tarag. clear tot_gross.
        clear: ztrn-gewei, ztrn-brgew, ztrn-ntgew.
        clear tt_ltr. refresh tt_ltr.
* IMP RU Begin of delete
*       endif.
* IMP RU end of delete
      endif.
**************************************************
* IMP RU Begin of delete
*  if vstel ne slk-vstel.
* departure point adress
*    vstel = slk-vstel.
* IMP RU End of delete

    SEL-ADDRNUMBER = slk-adrnr_vst.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
         EXPORTING
              INPUT  = SEL-ADDRNUMBER
         IMPORTING
              OUTPUT = SEL-ADDRNUMBER.
    sel-nation = 'R'.
    clear addr1_val.
    CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.

    if sy-subrc ne 0.
      clear sel-nation.
      CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    endif.
* IMP RU Begin of delete
*    concatenate ztrn-ponam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*       ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*       ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*       ADDR1_VAL-TEL_NUMBER into ztrn-ponam separated by space.
*  endif.
* IMP RU End of delete

* IMP RU Begin of insert
clear lv_landx50.
clear lv_region.

      select single landx50 from T005T into lv_landx50
         where spras = language
           and land1 = ADDR1_VAL-COUNTRY.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
    select single bezei from T005U into lv_region
      where spras = language
        and land1 = ADDR1_VAL-COUNTRY
        and bland = addr1_val-region.
*endif.

  concatenate
      lv_landx50 addr1_val-POST_CODE1 lv_region
      addr1_val-CITY2 addr1_val-CITY1 addr1_val-HOME_CITY
      addr1_val-STREET addr1_val-STR_SUPPL3 addr1_val-location addr1_val-HOUSE_NUM1 addr1_val-HOUSE_NUM2
      addr1_val-ROOMNUMBER addr1_val-TEL_NUMBER into ztrn-ponam separated by ', '.

   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-ponam WITH ','.
   REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-ponam WITH ','.
 clear int1.
   int1 = strlen( ztrn-ponam ).
   if int1 > 1.
   int1 = int1 - 1.
   ztrn-ponam = ztrn-ponam+0(int1).
   endif.
* IMP RU End of insert


* IMP RU Begin of delete
*  if slk-kunwe ne kunwe.
*    kunwe = slk-kunwe.
* IMP RU End of delete



* IMP RU Begin of insert
* bill to partner

select single ADRNR KUNNR from vbpa into (ADRNR_RE, KUNNR_RE)
  where parvw = 'RE' and VBELN = slk-vbeln_vauf.

    SEL-ADDRNUMBER = ADRNR_RE.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
         EXPORTING
              INPUT  = SEL-ADDRNUMBER
         IMPORTING
              OUTPUT = SEL-ADDRNUMBER.
    sel-nation = 'R'.
    clear addr1_val.
    CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.

    if sy-subrc ne 0.
      clear sel-nation.
      CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    endif.

clear lv_landx50.
clear lv_region.

   select single landx50 from T005T into lv_landx50
         where spras = language
           and land1 = ADDR1_VAL-COUNTRY.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
    select single bezei from T005U into lv_region
      where spras = language
        and land1 = ADDR1_VAL-COUNTRY
        and bland = addr1_val-region.
*endif.

  concatenate
      ADDR1_VAL-NAME1 ADDR1_VAL-NAME2 ADDR1_VAL-NAME3 ADDR1_VAL-NAME4 lv_landx50 addr1_val-POST_CODE1 lv_region
      addr1_val-CITY2 addr1_val-CITY1 addr1_val-HOME_CITY
      addr1_val-STREET addr1_val-STR_SUPPL3 addr1_val-location addr1_val-HOUSE_NUM1 addr1_val-HOUSE_NUM2
      addr1_val-ROOMNUMBER addr1_val-TEL_NUMBER into ztrn-renam separated by ', '.

   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-renam WITH ','.
   REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-renam WITH ','.
 clear int1.
   int1 = strlen( ztrn-renam ).
   if int1 > 1.
   int1 = int1 - 1.
   ztrn-renam = ztrn-renam+0(int1).
   endif.

* IMP RU End of insert


* Destination address

    SEL-ADDRNUMBER = slk-ADRNR_WE.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
         EXPORTING
              INPUT  = SEL-ADDRNUMBER
         IMPORTING
              OUTPUT = SEL-ADDRNUMBER.
    sel-nation = 'R'.
    clear addr1_val.
    CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
*              SADR              = SADR
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    if sy-subrc ne 0.
      clear sel-nation.
      CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    endif.

* IMP RU Begin of delete
*    concatenate ztrn-prnam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*       ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*       ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*       ADDR1_VAL-TEL_NUMBER into ztrn-prnam separated by space.
* IMP RU End of delete

   clear ztrn-gpnam.
* goods receiver adress


* IMP RU BEGIN INSERT

clear lv_landx50.
clear lv_region.

select single landx50 from T005T into lv_landx50
         where spras = language
           and land1 = ADDR1_VAL-COUNTRY.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
    select single bezei from T005U into lv_region
      where spras = language
        and land1 = ADDR1_VAL-COUNTRY
        and bland = addr1_val-region.
*endif.

  concatenate
      lv_landx50 addr1_val-POST_CODE1 lv_region
      addr1_val-CITY2 addr1_val-CITY1 addr1_val-HOME_CITY
      addr1_val-STREET addr1_val-STR_SUPPL3 addr1_val-location addr1_val-HOUSE_NUM1 addr1_val-HOUSE_NUM2
      addr1_val-ROOMNUMBER addr1_val-TEL_NUMBER into ztrn-gpnam separated by ','.

   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-gpnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-gpnam WITH ','.
 clear int1.
   int1 = strlen( ztrn-gpnam ).
   if int1 > 1.
   int1 = int1 - 1.
   ztrn-gpnam = ztrn-gpnam+0(int1).
   endif.

 if nast-kschl = 'ZU01' or nast-kschl = 'ZU02'.
   clear ztrn-gpnam.
 endif.
* IMP RU END INSERT

* IMP RU Begin of delete
*  endif.
* IMP RU End of delete

* IMP RU Begin of delete
*  if slk-vkorg ne vkorg.
*      vkorg = slk-vkorg.
* IMP RU End of delete
* IMP RU Begin of insert
select single adrnr from tvko into ADRNR_VKORG
  where VKORG = slk-VKORG.
* IMP RU End of insert
* goods consignor adress

      SEL-ADDRNUMBER = ADRNR_VKORG.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
           EXPORTING
              INPUT  = SEL-ADDRNUMBER
           IMPORTING
              OUTPUT = SEL-ADDRNUMBER.

      sel-nation = 'R'.
      clear addr1_val.
      CALL FUNCTION 'ADDR_GET'
           EXPORTING
              ADDRESS_SELECTION = SEL
           IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
           EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    if sy-subrc ne 0.
      clear sel-nation.
      CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.
    endif.

      clear ztrn-gonam.
* IMP RU Begin of delete
*      concatenate ztrn-gonam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*         ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*         ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*         ADDR1_VAL-TEL_NUMBER into ztrn-gonam separated by space.
* IMP RU End of delete

* IMP RU BEGIN INSERT

clear lv_landx50.
clear lv_region.

select single landx50 from T005T into lv_landx50
         where spras = language
           and land1 = ADDR1_VAL-COUNTRY.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
    select single bezei from T005U into lv_region
      where spras = language
        and land1 = ADDR1_VAL-COUNTRY
        and bland = addr1_val-region.
*endif.

  concatenate
      ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
      ADDR1_VAL-NAME3 ADDR1_VAL-NAME4 lv_landx50 addr1_val-POST_CODE1 lv_region
      addr1_val-CITY2 addr1_val-CITY1 addr1_val-HOME_CITY
      addr1_val-STREET addr1_val-STR_SUPPL3 addr1_val-location addr1_val-HOUSE_NUM1 addr1_val-HOUSE_NUM2
      addr1_val-ROOMNUMBER addr1_val-TEL_NUMBER into ztrn-gonam separated by ', '.

   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-gonam WITH ','.
   REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-gonam WITH ','.
 clear int1.
   int1 = strlen( ztrn-gonam ).
   if int1 > 1.
   int1 = int1 - 1.
   ztrn-gonam = ztrn-gonam+0(int1).
   endif.
* IMP RU END INSERT

* IMP RU Begin of delete
*  endif.
* IMP RU End of delete

* IMP RU Begin of delete
*  if slk-kunag ne kunag.
*     kunag = slk-kunag.
* IMP RU End of delete

* payer adress
        SEL-ADDRNUMBER = slk-adrnr_ag.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
             EXPORTING
                INPUT  = SEL-ADDRNUMBER
             IMPORTING
                OUTPUT = SEL-ADDRNUMBER.
        sel-nation = 'R'.
        clear addr1_val.
        CALL FUNCTION 'ADDR_GET'
             EXPORTING
                ADDRESS_SELECTION = SEL
             IMPORTING
                ADDRESS_VALUE     = ADDR1_VAL
             EXCEPTIONS
                PARAMETER_ERROR   = 1
                ADDRESS_NOT_EXIST = 2
                VERSION_NOT_EXIST = 3
                INTERNAL_ERROR    = 4
                OTHERS            = 5.
        if sy-subrc ne 0.
          clear sel-nation.
          CALL FUNCTION 'ADDR_GET'
             EXPORTING
                  ADDRESS_SELECTION = SEL
             IMPORTING
                  ADDRESS_VALUE     = ADDR1_VAL
             EXCEPTIONS
                  PARAMETER_ERROR   = 1
                  ADDRESS_NOT_EXIST = 2
                  VERSION_NOT_EXIST = 3
                  INTERNAL_ERROR    = 4
                  OTHERS            = 5.
        endif.

        clear ztrn-plnam.
* IMP RU BEGIN DELETE
*        concatenate ztrn-plnam ADDR1_VAL-NAME1 ADDR1_VAL-NAME2
*           ADDR1_VAL-NAME3 ADDR1_VAL-POST_CODE1 ADDR1_VAL-CITY1
*           ADDR1_VAL-CITY2 ADDR1_VAL-STREET ADDR1_VAL-HOUSE_NUM1
*           ADDR1_VAL-TEL_NUMBER into ztrn-plnam separated by space.
* IMP RU BEGIN DELETE

* IMP RU BEGIN INSERT
select single landx50 from T005T into lv_landx50
         where spras = language
           and land1 = ADDR1_VAL-COUNTRY.

*if addr1_val-region ne '77' and addr1_val-region ne '78'.
    select single bezei from T005U into lv_region
      where spras = language
        and land1 = ADDR1_VAL-COUNTRY
        and bland = addr1_val-region.
*endif.

  concatenate
      ADDR1_VAL-NAME1 ADDR1_VAL-NAME2 ADDR1_VAL-NAME3 ADDR1_VAL-NAME4 lv_landx50 addr1_val-POST_CODE1 lv_region
      addr1_val-CITY2 addr1_val-CITY1 addr1_val-HOME_CITY
      addr1_val-STREET addr1_val-STR_SUPPL3 addr1_val-location addr1_val-HOUSE_NUM1 addr1_val-HOUSE_NUM2
      addr1_val-ROOMNUMBER addr1_val-TEL_NUMBER into ztrn-plnam separated by ', '.

   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', , ,' IN ztrn-plnam WITH ','.
   REPLACE ALL OCCURRENCES OF ', ,' IN ztrn-plnam WITH ','.
 clear int1.
   int1 = strlen( ztrn-plnam ).
   if int1 > 1.
   int1 = int1 - 1.
   ztrn-plnam = ztrn-plnam+0(int1).
   endif.
* IMP RU END INSERT

* IMP RU Begin of delete
*  endif.
* IMP RU End of delete

* IMP RU Begin insert
* Retrieve Header data: Sales Order Nbr

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = slk-vbeln_vauf
      IMPORTING
        output = ztrn-SALORD.

* Retrieve Header data: Outbound Delivery Number + Shipment Number.
  clear lv_vbeln.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = slk-vbeln
      IMPORTING
        output = lv_vbeln.

clear lv_tknum.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
         input  = ztrn-tknum
      IMPORTING
        output = lv_tknum.

  concatenate lv_vbeln  ' / '  lv_tknum into ztrn-OUTB_SHIPNR.

* Retrieve OKPO Code
 select single bukrs from tvko into lv_bukrs where vkorg = slk-vkorg.

  SELECT SINGLE PAVAL FROM T001Z INTO ztrn-SAPR02
    WHERE BUKRS EQ lv_bukrs
    AND   PARTY EQ 'SAPR02'.

* Retrieve GI date:

* select single wadat from likp into lv_GI_date
*  where vbeln = slk-vbeln.


    ztrn-lv_day = vttkvb-erdat+6.
    ztrn-lv_month = vttkvb-erdat+4(2).
    ztrn-lv_year = vttkvb-erdat(4).
    ztrn-lv_GI_date = vttkvb-erdat.

* Retrieve VAT code AG (sold-to Partner)
 select single stcd1 from kna1 into
    ztrn-stceg_ag
   where kunnr EQ slk-kunag.

* Retrieve VAT code AG (sold-to Partner)
 select single stcd3 from kna1 into
    ztrn-stceg_re
   where kunnr EQ KUNNR_RE.

* IMP RU End insert

* convert all units to t
      PERFORM UNIT_CONVERSION_SIMPLE USING slk-GEWEI TN
                                  changing slk-BRGEW.

      PERFORM UNIT_CONVERSION_SIMPLE USING slk-GEWEI TN
                                  changing slk-NTGEW.
      slk-GEWEI = TN.
      ztrn-GEWEI = slk-GEWEI.
      ztrn-BRGEW = ztrn-BRGEW + slk-BRGEW.
      ztrn-NTGEW = ztrn-NTGEW + slk-NTGEW.
      PERFORM ITEM_PRINT.
    endloop.
  endif.
ENDFORM.

FORM ITOGI.

* IMP RU Begin of insert
* Unique HU's
SORT tt_hu BY venum.
DELETE ADJACENT DUPLICATES FROM tt_hu COMPARING venum.
* retrieve Net weight/Gross weight in digits + wordings per HU

*Calculate total (unique) cases
*    clear i_totcas[].
*    select venum count(*) from vepo into table i_totcas
*    where vbeln eq slk-VBELN
*    group by venum.
*    describe table i_totcas lines totcas.


*  TOT_TARAG = TOT_TARAG / 10.
*
*clear ztrn-tot_tarag_w.
*if tot_tarag is not initial.
*  CALL FUNCTION 'SPELL_AMOUNT'
*       EXPORTING
*            AMOUNT    = TOT_TARAG
*            CURRENCY  = 'ZCURR'        "######### ###### ### #####-
*            FILLER    = ' '            "### ##### SPELL
*            LANGUAGE  = language
*       IMPORTING
*            IN_WORDS  = SPELL
*       EXCEPTIONS
*            NOT_FOUND = 1
*            TOO_LARGE = 2
*            OTHERS    = 3.
*  ztrn-tot_tarag_w = SPELL-WORD.
* endif.

*clear ztrn-tot_gross_w.
*if tot_gross is not initial.
*TOT_GROSS = TOT_GROSS / 10.
*
*  CALL FUNCTION 'SPELL_AMOUNT'
*       EXPORTING
*            AMOUNT    = TOT_GROSS
*            CURRENCY  = 'ZCURR'        "######### ###### ### #####-
*            FILLER    = ' '            "### ##### SPELL
*            LANGUAGE  = language
*       IMPORTING
*            IN_WORDS  = SPELL
*       EXCEPTIONS
*            NOT_FOUND = 1
*            TOO_LARGE = 2
*            OTHERS    = 3.
*  ztrn-tot_gross_w = SPELL-WORD.
*endif.




* IMP RU End of insert

*    describe table ltrn lines num_line.  "Number of records
    SUM  = zap / 10.

  CALL FUNCTION 'SPELL_AMOUNT'
       EXPORTING
            AMOUNT    = SUM
            CURRENCY  = 'ZCURR'        "######### ###### ### #####-
            FILLER    = ' '            "### ##### SPELL
            LANGUAGE  = language
       IMPORTING
            IN_WORDS  = SPELL
       EXCEPTIONS
            NOT_FOUND = 1
            TOO_LARGE = 2
            OTHERS    = 3.
  ztrn-totlin = SPELL-WORD.


  SUM  = totplc / 10.
  ztrn-tot_plc_n = totplc.
  CALL FUNCTION 'SPELL_AMOUNT'
       EXPORTING
            AMOUNT    = SUM
            CURRENCY  = 'ZCURR'
            FILLER    = ' '
            LANGUAGE  = language
       IMPORTING
            IN_WORDS  = SPELL
       EXCEPTIONS
            NOT_FOUND = 1
            TOO_LARGE = 2
            OTHERS    = 3.
ztrn-totplc = SPELL-WORD.

* IMP RU Begin of insert
SUM2  = totcas / 10.

  CALL FUNCTION 'SPELL_AMOUNT'
       EXPORTING
            AMOUNT    = SUM2
            CURRENCY  = 'ZCURR'
            FILLER    = ' '
            LANGUAGE  = language
       IMPORTING
            IN_WORDS  = SPELL
       EXCEPTIONS
            NOT_FOUND = 1
            TOO_LARGE = 2
            OTHERS    = 3.
ztrn-totcas = SPELL-WORD.
* IMP RU End of insert

if totsum is not initial.
  CALL FUNCTION 'SPELL_AMOUNT'
       EXPORTING
            AMOUNT    = TOTSUM
            CURRENCY  = HDOC-WAERK     " ###### ######### ####
            FILLER    = ' '
            LANGUAGE  = language
       IMPORTING
            IN_WORDS  = SPELL
       EXCEPTIONS
            NOT_FOUND = 1
            TOO_LARGE = 2
            OTHERS    = 3.
  concatenate SPELL-WORD spell-decimal(2) text-001
     into ztrn-totsum separated by space.
endif.

    describe table tabnam lines num_lin.  "Number of records
    SUM  = NUM_LIN / 10.
                             "### ###### ######### ############
  CALL FUNCTION 'SPELL_AMOUNT'
       EXPORTING
            AMOUNT    = SUM
            CURRENCY  = 'ZCURR'        "######### ###### ### #####-
            FILLER    = ' '            "### ##### SPELL
            LANGUAGE  = language
       IMPORTING
            IN_WORDS  = SPELL
       EXCEPTIONS
            NOT_FOUND = 1
            TOO_LARGE = 2
            OTHERS    = 3.
    ztrn-totnam = SPELL-WORD.

    clear num_lin.
*    clear totplc. clear TOTSUM.

ENDFORM.

**---------------------------------------------------------------------*
**       FORM GET_ADDRESS_DATA_OF_LEG                                  *
**---------------------------------------------------------------------*
**       ........                                                      *
**---------------------------------------------------------------------*
**  -->  LEG                                                           *
**  -->  SADR_BEGIN                                                    *
**  -->  SADR_END                                                      *
**---------------------------------------------------------------------*
*FORM GET_ADDRESS_DATA_OF_LEG USING LEG          LIKE      XVTTS
*                                   SADR_BEGIN   STRUCTURE SADR  "SADR40A
*                                   SADR_END     STRUCTURE SADR. "SADR40A
*
*  DATA:
*    L_DEPT LIKE LOC_DEPT,
*    L_DEST LIKE LOC_DEST.
*
*  MOVE-CORRESPONDING LEG TO L_DEPT.
*  CALL FUNCTION 'ST_LOCATION_ADDR_READ'
*       EXPORTING
*            I_LOCATION         = L_DEPT
*       IMPORTING
*            E_SADR             = SADR_BEGIN
*       EXCEPTIONS
*            ADDRESS_NOT_FOUND  = 1
*            OTHERS             = 2.
*  IF SY-SUBRC NE 0.
*    SYST-MSGID = 'VW'.
*    SYST-MSGNO = '002'.
*    SYST-MSGTY = 'E'.
*    SYST-MSGV1 = TEXT-001.
*    SYST-MSGV2 = 'SADR'.
*    PERFORM PROTOCOL_UPDATE.
**    CLEAR SADR_BEGIN.
*  ENDIF.
*
*  MOVE-CORRESPONDING LEG TO L_DEST.
*  CALL FUNCTION 'ST_LOCATION_ADDR_READ'
*       EXPORTING
*            I_LOCATION         = L_DEST
*       IMPORTING
*            E_SADR             = SADR_END
*       EXCEPTIONS
*            ADDRESS_NOT_FOUND  = 1
*            OTHERS             = 2.
*  IF SY-SUBRC NE 0.
*    SYST-MSGID = 'VW'.
*    SYST-MSGNO = '002'.
*    SYST-MSGTY = 'E'.
*    SYST-MSGV1 = TEXT-001.
*    SYST-MSGV2 = 'SADR'.
*    PERFORM PROTOCOL_UPDATE.
*    CLEAR SADR_END.
*  ENDIF.
*
*ENDFORM.

*---------------------------------------------------------------------*
*       FORM UNIT_CONVERSION_SIMPLE                                   *
*---------------------------------------------------------------------*
FORM UNIT_CONVERSION_SIMPLE USING VALUE(UNIT_IN)  LIKE T006-MSEHI
                                  VALUE(UNIT_OUT) LIKE T006-MSEHI
                         CHANGING INPUT TYPE ANY.
if not unit_in is initial.
  CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
       EXPORTING
            INPUT    = INPUT
            UNIT_IN  = UNIT_IN
            UNIT_OUT = UNIT_OUT
       IMPORTING
            OUTPUT   = INPUT.
endif.
ENDFORM.

**---------------------------------------------------------------------*
**       FORM GET_LEGS_TO_PRINT                                        *
**---------------------------------------------------------------------*
**       ........                                                      *
**---------------------------------------------------------------------*
**  -->  LEGS_TAB                                                      *
**---------------------------------------------------------------------*
*FORM GET_LEGS_TO_PRINT TABLES LEGS_TAB STRUCTURE XVTTS.
*
**  DATA: FLAG TYPE BOOLEAN.
*
*  CLEAR:   LEGS_TAB.
*  REFRESH: LEGS_TAB.
** save protocol record (general)
*  PROTOCOL_TAB-MSG_ARBGB = 'VW'.
*  PROTOCOL_TAB-MSG_NR    = '080'.
*  PROTOCOL_TAB-MSG_TY    = 'E'.
*  PROTOCOL_TAB-MSG_V1    = VTTKVB-TKNUM.
*  APPEND PROTOCOL_TAB.
*
** set there is nothing to print if there are no legs
**  SOMETHING_TO_PRINT = FALSE.
*
*  SORT XVTTS BY TSRFO.
** check legs
*  LOOP AT XVTTS.
**    PERFORM CHECK_PRINT_RELEVANCE USING    XVTTS
**                                  CHANGING FLAG.
** exit if the first print-relevant leg was found
**    IF ( FLAG = TRUE ).
*      APPEND XVTTS TO LEGS_TAB.
*      EXIT.
**    ENDIF.
*  ENDLOOP.
*
*ENDFORM.

**---------------------------------------------------------------------*
**       FORM CHECK_PRINT_RELEVANCE                                    *
**---------------------------------------------------------------------*
**       ........                                                      *
**---------------------------------------------------------------------*
**  -->  LEG                                                           *
**  -->  FLAG                                                          *
**---------------------------------------------------------------------*
*FORM CHECK_PRINT_RELEVANCE USING    LEG LIKE XVTTS
*                           CHANGING FLAG.
*
*  FLAG = FALSE.
*  SOMETHING_TO_PRINT = FALSE.
*
*  IF ( LEG-LAUFK = LAUFK-1 ) OR ( LEG-LAUFK = LAUFK-4 ).
*    IF ( LEG-TDLNR = NAST-PARNR ).
*      FLAG = TRUE.
*      SOMETHING_TO_PRINT = TRUE.
*    ELSE.
** save protocol record (wrong laufk)
*      PROTOCOL_TAB-MSG_ARBGB = 'VW'.
*      PROTOCOL_TAB-MSG_NR    = '082'.
*      PROTOCOL_TAB-MSG_TY    = 'I'.
*      PROTOCOL_TAB-MSG_V1    = LEG-TSNUM.
*      APPEND PROTOCOL_TAB.
*    ENDIF.
*  ELSE.
** save protocol record (wrong tdlnr)
*    PROTOCOL_TAB-MSG_ARBGB = 'VW'.
*    PROTOCOL_TAB-MSG_NR    = '081'.
*    PROTOCOL_TAB-MSG_TY    = 'I'.
*    PROTOCOL_TAB-MSG_V1    = LEG-TSNUM.
*    APPEND PROTOCOL_TAB.
*  ENDIF.
*
*ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_SHIPING_UNITS                                        *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VBPLK_TO_CHECK                                                *
*  -->  VBPLK_TO_PRINT                                                *
*---------------------------------------------------------------------*
FORM GET_SHIPING_UNITS TABLES VBPLK_TO_CHECK STRUCTURE XVBPLK
                              VBPLK_TO_PRINT STRUCTURE XVBPLK.

  DATA: LIN     LIKE SY-TABIX.
  DATA: H_VBPLK LIKE VBPLK OCCURS 0.

  DESCRIBE TABLE VBPLK_TO_CHECK LINES LIN.

  CHECK NOT ( LIN IS INITIAL ).

* print-relevant shiping units
  LOOP AT VBPLK_TO_CHECK WHERE ( VELTP <> VELTP_TPM ).
    APPEND VBPLK_TO_CHECK TO VBPLK_TO_PRINT.
    DELETE VBPLK_TO_CHECK.
  ENDLOOP.

* get child shiping units to check
  LOOP AT VBPLK_TO_CHECK.
    LOOP AT XVBPLK WHERE ( UEVEL = VBPLK_TO_CHECK-VENUM ).
      APPEND XVBPLK TO H_VBPLK.
    ENDLOOP.
  ENDLOOP.

  REFRESH: VBPLK_TO_CHECK.
  VBPLK_TO_CHECK[] = H_VBPLK[].

* check child shiping units
  PERFORM GET_SHIPING_UNITS TABLES VBPLK_TO_CHECK
                                   VBPLK_TO_PRINT.

ENDFORM.

FORM ITEM_PRINT.

DATA: LIN TYPE I, PR TYPE I, PR1 TYPE I.
DATA: lv_exidv TYPE exidv.

  LOOP AT slp where vbeln eq slk-vbeln.
  if slp-charg <> ' ' and slp-matkl <> '03'.
  clear tkomser. refresh tkomser.
  clear wa_ltrn. clear tt_ltr.
  move-corresponding slp to wa_ltrn.

  IF wa_ltrn-LFIMG = 0.           "If number of items = 0 then don't output
      CONTINUE.                   "go to the next step
  ENDIF.
  NUM_LINE = NUM_LINE + 1.

    SELECT SINGLE MSEHT FROM T006A      "Unit of Measurement for item
           into wa_ltrn-MSEHT
    WHERE SPRAS EQ language AND MSEHI EQ wa_ltrn-VRKME.

    "coefficients for conversion to base units of measure
    SELECT SINGLE * FROM MARM
       WHERE MATNR EQ wa_ltrn-MATNR AND MEINH EQ wa_ltrn-VRKME.
    STUZ = MARM-UMREZ.     STUN = MARM-UMREN.

   SELECT * FROM VBFA        "find billing document number
    WHERE   VBELV EQ slk-VBELN
      AND VBTYP_V EQ slk-VGTYP
        AND POSNV EQ slp-POSNR
      AND VBTYP_N EQ 'M'.
   ENDSELECT.
  IF SY-SUBRC NE 0.
   SELECT SINGLE * FROM VBFA      "find sales document number
    WHERE   VBELN EQ slk-VBELN
      AND VBELV EQ slp-VGBEL
      AND VBTYP_V EQ slp-VGTYP
      AND VBTYP_N EQ slk-VBTYP
        AND POSNN EQ slp-POSNR
        AND POSNV EQ slp-VGPOS.

  SELECT SINGLE VBTYP KALSM WAERK KNUMV AUART
                   FROM VBAK INTO     "Header of Sales Document
     (HDOC-VBTYP, HDOC-KALSM, HDOC-WAERK, HDOC-KNUMV, HDOC-AUART)
  WHERE VBELN = VBFA-VBELV.

* IMP RU Begin of insert Currency should always be RUB

if hdoc-waerk <> 'RUB'.
   lv_convert = 'X'.
   hdoc-waerk = 'RUB'.
endif.

* IMP RU End of insert Currency should always be RUB

* IMP RU Begin of chane Currency should always be RUB

*    SELECT SINGLE MATNR VRKME LSMENG KZWI3 KZWI4 KZWI5 KZWI6
*                  FROM VBAP INTO     "Find sales document position
*      (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
*      PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6)
*    WHERE   VBELN EQ VBFA-VBELV
*        AND POSNR EQ VBFA-POSNV.
    SELECT SINGLE MATNR VRKME LSMENG KZWI3 KZWI4 KZWI5 KZWI6 CMPRE
                  FROM VBAP INTO     "Find sales document position
      (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
      PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6, PDOC-CMPRE)
    WHERE   VBELN EQ VBFA-VBELV
        AND POSNR EQ VBFA-POSNV.
* IMP RU End of chane Currency should always be RUB
    IF SY-SUBRC = 0.
      SELECT SINGLE * FROM MARM      "Required quantity in base unit
         WHERE MATNR EQ PDOC-MATNR AND MEINH EQ PDOC-VRKME.
      PDOC-LSMENG =
                    PDOC-LSMENG * MARM-UMREZ / MARM-UMREN.
    ENDIF.

  ELSE.
  SELECT SINGLE VBTYP KALSM WAERK KNUMV FKART
                   FROM VBRK INTO   "Header of Billing Document
     (HDOC-VBTYP, HDOC-KALSM, HDOC-WAERK, HDOC-KNUMV, HDOC-FKART)
  WHERE VBELN = VBFA-VBELN.
* IMP RU Begin of insert Currency should always be RUB

if hdoc-waerk <> 'RUB'.
   lv_convert = 'X'.
   hdoc-waerk = 'RUB'.
endif.

* IMP RU End of insert Currency should always be RUB

    SELECT SINGLE MATNR VRKME FKIMG KZWI3 KZWI4 KZWI5 KZWI6
                      FROM VBRP INTO    "Item of Billing Document
      (PDOC-MATNR, PDOC-VRKME, PDOC-LSMENG,
      PDOC-KZWI3, PDOC-KZWI4, PDOC-KZWI5, PDOC-KZWI6)
    WHERE   VBELN EQ VBFA-VBELN
        AND POSNR EQ VBFA-POSNN.
    IF SY-SUBRC = 0.
      SELECT SINGLE * FROM MARM       "Required quantity in base unit
         WHERE MATNR EQ PDOC-MATNR AND MEINH EQ PDOC-VRKME.
      PDOC-LSMENG =
                    PDOC-LSMENG * MARM-UMREZ / MARM-UMREN.
      slp-VGPOS = VBFA-POSNN.
    ENDIF.

  ENDIF.

* Retrieve the type of package + nbr of cases
* IMP RU Begin of insert
clear lv_venum.
clear lv_vhart.
clear lv_exidv.
clear lv_laeng.
clear lv_breit.
clear lv_hoehe.
clear lv_gewei.
clear it_venum[].

 select venum from vepo into table it_venum
    where vbeln eq slk-VBELN
      and matnr eq PDOC-MATNR
      and werks eq slp-WERKS
      and posnr eq slp-POSNR.
 clear num_line2.
 DESCRIBE TABLE it_venum LINES NUM_LINE2.
* When more than 1 Handling Unit per batch
 if num_line2 > 1.
   LOOP at it_venum.
    tt_HU-venum = it_venum.
    append tt_hu.
    select single exidv from vekp into lv_exidv
      where venum = it_venum.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = lv_exidv
        IMPORTING
          output = lv_exidv.
    concatenate wa_ltrn-handl_ext lv_exidv into wa_ltrn-handl_ext separated by ' '.
   ENDLOOP.
 endif.
 select single venum from vepo into lv_venum
    where vbeln eq slk-VBELN
      and matnr eq PDOC-MATNR
      and werks eq slp-WERKS
      and posnr eq slp-POSNR.
 if sy-subrc eq 0. "HU found for current item
  select single vhart exidv laeng breit hoehe meabm from vekp into (lv_vhart, lv_exidv, lv_laeng, lv_breit, lv_hoehe, lv_meabm)
   where venum = lv_venum.
    if sy-subrc eq 0.
       select single vtext from TVTYT into wa_ltrn-vtext
        where traty = lv_vhart and spras = nast-spras.
        if num_line2 = 1 .
         CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
         EXPORTING
           input  = lv_exidv
         IMPORTING
           output = lv_exidv.
         wa_ltrn-handl_ext = lv_exidv.
        endif.
        PERFORM UNIT_CONVERSION_SIMPLE USING lv_meabm M
                                  changing lv_laeng.
        PERFORM UNIT_CONVERSION_SIMPLE USING lv_meabm M
                                  changing lv_breit.
        PERFORM UNIT_CONVERSION_SIMPLE USING lv_meabm M
                                  changing lv_hoehe.
        lv_laeng_c = lv_laeng.
        lv_breit_c = lv_breit.
        lv_hoehe_c = lv_hoehe.
        REPLACE ALL OCCURRENCES OF '.' IN lv_hoehe_c WITH ','.
        REPLACE ALL OCCURRENCES OF '.' IN lv_laeng_c WITH ','.
        REPLACE ALL OCCURRENCES OF '.' IN lv_breit_c WITH ','.
        concatenate lv_laeng_c lv_breit_c lv_hoehe_c into wa_ltrn-l_b_h separated by 'x'.
        condense wa_ltrn-l_b_h.
    else.
      clear wa_ltrn-vtext.
      clear wa_ltrn-handl_ext.
      clear wa_ltrn-l_b_h.
    endif.
 endif.

 lv_counter = 0.
    select count(*) from vepo into lv_counter
    where vbeln eq slk-VBELN
      and matnr eq PDOC-MATNR
      and werks eq slp-WERKS
      and posnr eq slp-POSNR.


CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
     EXPORTING
        input  = lv_counter
    IMPORTING
        OUTPUT = lv_counter.


wa_ltrn-HANDL_NBR = lv_counter.

* Retrieve all HU's to be able to identify the unique HU's
if not lv_venum is initial and num_line2 = 1.
  tt_HU-venum = lv_venum.
  append tt_hu.
endif.
* IMP RU End of insert




                                "currency multiplier
  TCURX-CURRDEC = 2.
  SELECT SINGLE * FROM TCURX WHERE CURRKEY = HDOC-WAERK.
  IF TCURX-CURRDEC = 0.
    ONEHUNDRED = 100.           "w/o decimal places
  ELSE.
    ONEHUNDRED = 1.
  ENDIF.

* IMP RU Begin of insert currency always RUB
    clear lv_kursk.
    select single kursk from vbkd into lv_kursk
    where VBELN = slp-VGBEL and POSNR = slp-VGPOS.
    if sy-subrc <> 0.
     select single kursk from vbkd into lv_kursk
     where VBELN = slp-VGBEL and POSNR = c_posnr.
    endif.
* IMP RU End of insert currency always RUB


    """"""  Variant of subtotals use  """""""
    slp-NETPR = PDOC-KZWI3.             "sum w/o VAT of order item
    AV_NETPR = PDOC-KZWI5.              "VAT sum for order item
* IMP RU Begin of change currency always RUB
*   AV_NETWR = PDOC-KZWI4.              "Sum with VAT for order item
    AV_NETWR = PDOC-CMPRE.              "Sum with VAT for order item
* IMP RU End of change  currency always RUB

    IF NOT  PDOC-LSMENG IS INITIAL.
* IMP RU Begin of change currency always RUB
*     slp-NETWR =                      "sum w/o VAT of delivery item
*         slp-NETPR * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
*     AV_NETPR =                       "VAT sum for delivery item
*         AV_NETPR * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
*     AV_NETWR =                       "Sum with VAT for delivery item
*         AV_NETWR * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
*     slp-NETPR =                      "Price w/o VAT for delivery item
*                 slp-NETPR * STUZ / STUN / PDOC-LSMENG.

     slp-NETWR =                      "Net Price Qty 1 with Freight
         AV_NETPR * STUZ / STUN / PDOC-LSMENG.
     AV_NETPR =                       "Total without Freight with VAT
         PDOC-KZWI5 * slp-LFIMG * STUZ / STUN / PDOC-LSMENG.
     AV_NETWR =                       "Total price with Freight->CMPRE with VAT
         PDOC-CMPRE * slp-LFIMG.
     slp-NETPR =                      "Net price qty 1 with Freight
                 slp-NETPR * STUZ / STUN / PDOC-LSMENG.
* IMP RU End of change currency always RUB
    ENDIF.

    slp-NETPR = slp-NETPR * ONEHUNDRED.  "Price w/o VAT
    slp-NETWR = slp-NETWR * ONEHUNDRED.  "sum w/o VAT
    AV_NETPR = AV_NETPR * ONEHUNDRED.    "VAT sum
    AV_NETWR = AV_NETWR * ONEHUNDRED.    "Sum with VAT
                                       """""
* IMP RU Begin of insert currency always RUB
    if nast-kschl = 'ZU01'.
    slp-NETPR = slp-NETPR * lv_kursk. " net price qty 1 with Freight
    slp-NETWR = ( AV_NETWR * lv_kursk ). " total with Freight
    elseif nast-kschl = 'ZU05'.
    slp-NETPR = slp-NETWR * lv_kursk. " net price qty 1 without Freight
    slp-NETWR = ( AV_NETPR * 118 / 100 ) * lv_kursk. " total without Freight
    endif.

* IMP RU End of insert currency always RUB
*************
* IMP RU End of delete currency always RUB
*    slp-NETWR = AV_NETWR.            "Sum with VAT
* IMP RU End of delete currency always RUB
if nast-kschl = 'ZU01'.
    wa_ltrn-netwr = slp-NETWR.
    wa_ltrn-netpr = slp-NETPR.       "Price w/o VAT
endif.



    SELECT SINGLE MSEH3 FROM T006A
        INTO wa_ltrn-vrkme
      WHERE SPRAS EQ language AND MSEHI EQ wa_ltrn-vrkme
        AND MSEH3 > '  '.  "#EC CI_GENBUFF

      PERFORM UNIT_CONVERSION_SIMPLE USING slp-GEWEI TN
                                  changing wa_ltrn-BRGEW.

      PERFORM UNIT_CONVERSION_SIMPLE USING slp-GEWEI TN
                                  changing wa_ltrn-NTGEW.
      wa_ltrn-GEWEI = TN.
      slp-BRGEW = wa_ltrn-BRGEW.
      slp-NTGEW = wa_ltrn-NTGEW.
    wa_ltrn-place = wa_ltrn-lfimg.
    clear tkomser.
    perform GET_SERIAL_NO.
    describe table tkomser lines lin.
* IMP RU Begin of insert
    clear wa_ltrn-serdes.
        clear teller.

        LOOP AT TKOMSER.

          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = TKOMSER-SERNR
          IMPORTING
            OUTPUT = TKOMSER-SERNR.

           if teller = 0.
            wa_ltrn-SERDES =  TKOMSER-SERNR.
          else.
           concatenate wa_ltrn-SERDES TKOMSER-SERNR into wa_ltrn-SERDES separated by '-'.
          endif.
          add 1 to teller.
        ENDLOOP.


* IMP RU End of insert
    if lin eq 0 or lin ne slp-lfimg.
      append wa_ltrn to ltrn.
    elseif lin eq 1.
     concatenate wa_ltrn-arktx '(' tkomser-sernr ')' into wa_ltrn-arktx.
     append wa_ltrn to ltrn.
    else.
      clear wa_ltrn-brgew.
      clear wa_ltrn-ntgew.
      append wa_ltrn to ltrn.
      clear wa_ltrn-place.
      wa_ltrn-brgew = slp-brgew / lin.
      wa_ltrn-ntgew = slp-ntgew / lin.
      clear wa_ltrn-lfimg.
      clear wa_ltrn-matnr.
      clear wa_ltrn-vrkme.
      clear wa_ltrn-netpr.
      clear wa_ltrn-netwr.
      wa_ltrn-numlev = 1. "num_lin.
      loop at tkomser.
        wa_ltrn-arktx = tkomser-sernr.
        append wa_ltrn to ltrn.
      endloop.
    endif.
*AFS items
    move-corresponding wa_ltrn to tt_ltr-wa_ltrn.
    tt_ltr-werks = slp-werks.
    tt_ltr-lgort = slp-lgort.
    tt_ltr-charg = slp-charg.
    append tt_ltr.
   endif. " charg
  ENDLOOP.

ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_SERIAL_NO                                            *
*---------------------------------------------------------------------*
*       In this routine the serialnumbers are fetched from the        *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM GET_SERIAL_NO.

  CHECK slp-ANZSN > 0.
* Read the Serialnumbers of a Position.
  REFRESH TKOMSER.
  CALL FUNCTION 'SERIAL_LS_PRINT'
       EXPORTING
            VBELN  = slk-VBELN
            POSNR  = slp-POSNR
       TABLES
            ISERLS = TKOMSER.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
       EXPORTING
            I_BOUNDARY_LEFT             = '(_'
            I_BOUNDARY_RIGHT            = '_)'
            I_SEP_CHAR_STRINGS          = ',_'
            I_SEP_CHAR_INTERVAL         = '_-_'
            I_USE_INTERVAL              = 'X'
            I_BOUNDARY_METHOD           = 'C'
            I_LINE_LENGTH               = 50
            I_NO_ZERO                   = 'X'
            I_ALPHABET                  = SY-ABCDE
            I_DIGITS                    = '0123456789'
            I_SPECIAL_CHARS             = '-'
            I_WITH_SECOND_DIGIT         = ' '
       TABLES
            SERIALS                     = TKOMSER
            SERIALS_PRINT               = TKOMSER_PRINT
       EXCEPTIONS
            BOUNDARY_MISSING            = 01
            INTERVAL_SEPARATION_MISSING = 02
            LENGTH_TO_SMALL             = 03
            INTERNAL_ERROR              = 04
            WRONG_METHOD                = 05
            WRONG_SERIAL                = 06
            TWO_EQUAL_SERIALS           = 07
            SERIAL_WITH_WRONG_CHAR      = 08
            SERIAL_SEPARATION_MISSING   = 09.

  IF SY-SUBRC NE 0.
    PERFORM PROTOCOL_UPDATE.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  OPEN_FORM_pdf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM OPEN_FORM_pdf .
data: fp_outputparams   type sfpoutputparams.

fp_outputparams-PDFTAGGED = 'X'.

PERFORM FILL_OUTPUTPARAMS_PDF USING    ITCPO
                              CHANGING FP_OUTPUTPARAMS.

call function 'FP_JOB_OPEN'
  CHANGING
    ie_outputparams = fp_outputparams
  EXCEPTIONS
    cancel          = 1
    usage_error     = 2
    system_error    = 3
    internal_error  = 4
    others          = 5.
if sy-subrc <> 0.
  message id sy-msgid type sy-msgty number sy-msgno
          with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
endif.
  X_OPEN = 'X'.

ENDFORM.                    " OPEN_FORM_pdf
*&---------------------------------------------------------------------*
*&      Form  print_pdf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM print_pdf .
  DATA: ls_function           TYPE rs38l_fnam.
  DATA: fp_docparams      type sfpdocparams,
        l_errstr type string.

*        form  TYPE FPNAME.
*data : w_cx_root  TYPE REF TO CX_ROOT,
*       mesg TYPE STRING.

 perform read_fm using TNAPR-SFORM
                   changing ls_function.



* Call the generated functional module
* set locale RU_ru
if language = 'R'.
  fp_docparams-langu = 'R'.
  fp_docparams-country = 'RU'.
endif.
call function ls_function
  EXPORTING
    /1bcdwb/docparams   = fp_docparams
    f_ztrn              = ztrn
    f_ltrn              = ltrn
    f_tnam              = tabnam
*  IMPORTING
*    /1bcdwb/formoutput   =
  EXCEPTIONS
    usage_error     = 1
    system_error    = 2
    internal_error  = 3.

if sy-subrc <> 0.
CALL FUNCTION 'FP_GET_LAST_ADS_ERRSTR'
  IMPORTING
    E_ADSERRSTR = l_errstr.
endif.

ENDFORM.                    " print_pdf
*&---------------------------------------------------------------------*
*&      Form  CLOSE_FORM_pdf
*&---------------------------------------------------------------------*
*----------------------------------------------------------------------*
FORM CLOSE_FORM_pdf .
  CHECK NOT X_OPEN IS INITIAL.
*Close the spool job
call function 'FP_JOB_CLOSE'
*           IMPORTING
*             E_RESULT             =
 exceptions
   usage_error          = 1
   system_error         = 2
   internal_error       = 3
   others               = 4
          .
if sy-subrc <> 0.
  message id sy-msgid type sy-msgty number sy-msgno
          with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
endif.

  CLEAR X_OPEN.
ENDFORM.                    " CLOSE_FORM_pdf

*&---------------------------------------------------------------------*
*&      Form  read_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM read_fm USING    P_TNAPR_SFORM
                   CHANGING P_FM_NAME.

* determine the name of the generated function module
*
      TRY.
        CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
            EXPORTING
               i_name     = P_TNAPR_SFORM
            IMPORTING
               e_funcname = P_FM_NAME.
        CATCH cx_fp_api.
      ENDTRY.

      IF P_FM_NAME IS INITIAL.
*        MESSAGE e848 WITH t001f-fornr_pdf save_bukrs
*           save_repid save_forid.
      message id 'FB' type 'I' number sy-msgno
              with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ENDIF.

ENDFORM.                    " read_fm
*&---------------------------------------------------------------------*
*&      Form  FILL_OUTPUTPARAMS_PDF
*&---------------------------------------------------------------------*
*      -->IS_ITCPO TYPE ITCPO
*      <--XS_OUTPUTPARAMS TYPE SFPOUTPUTPARAMS
*----------------------------------------------------------------------*
FORM FILL_OUTPUTPARAMS_PDF
                      USING    IS_ITCPO TYPE ITCPO
                      CHANGING XS_OUTPUTPARAMS TYPE SFPOUTPUTPARAMS.
  CLEAR XS_OUTPUTPARAMS-NOPRINT.
  XS_OUTPUTPARAMS-NOPRIBUTT = XS_OUTPUTPARAMS-NODIALOG = xscreen.
  XS_OUTPUTPARAMS-DEVICE     = IS_ITCPO-TDPRINTER.
  XS_OUTPUTPARAMS-PREVIEW    = IS_ITCPO-TDPREVIEW.
  XS_OUTPUTPARAMS-DEST       = IS_ITCPO-TDDEST.
  XS_OUTPUTPARAMS-REQNEW     = IS_ITCPO-TDNEWID.
  XS_OUTPUTPARAMS-REQIMM     = IS_ITCPO-TDIMMED.
  XS_OUTPUTPARAMS-REQDEL     = IS_ITCPO-TDDELETE.
  XS_OUTPUTPARAMS-REQFINAL   = IS_ITCPO-TDFINAL.
  XS_OUTPUTPARAMS-SENDDATE   = IS_ITCPO-TDSENDDATE.
  XS_OUTPUTPARAMS-SENDTIME   = IS_ITCPO-TDSENDTIME.
  XS_OUTPUTPARAMS-SCHEDULE   = IS_ITCPO-TDSCHEDULE.
  XS_OUTPUTPARAMS-COPIES     = IS_ITCPO-TDCOPIES.
  XS_OUTPUTPARAMS-DATASET    = IS_ITCPO-TDDATASET.
  XS_OUTPUTPARAMS-SUFFIX1    = IS_ITCPO-TDSUFFIX1.
  XS_OUTPUTPARAMS-SUFFIX2    = IS_ITCPO-TDSUFFIX2.
  XS_OUTPUTPARAMS-COVTITLE   = IS_ITCPO-TDCOVTITLE.
  XS_OUTPUTPARAMS-COVER      = IS_ITCPO-TDCOVER.
  XS_OUTPUTPARAMS-RECEIVER   = IS_ITCPO-TDRECEIVER.
  XS_OUTPUTPARAMS-DIVISION   = IS_ITCPO-TDDIVISION.
  XS_OUTPUTPARAMS-LIFETIME   = IS_ITCPO-TDLIFETIME.
  XS_OUTPUTPARAMS-AUTHORITY  = IS_ITCPO-TDAUTORITY.
  XS_OUTPUTPARAMS-RQPOSNAME  = IS_ITCPO-RQPOSNAME.
  XS_OUTPUTPARAMS-ARCMODE    = IS_ITCPO-TDARMOD.
  XS_OUTPUTPARAMS-NOARMCH    = IS_ITCPO-TDNOARMCH.
  XS_OUTPUTPARAMS-TITLE      = IS_ITCPO-TDTITLE.
  XS_OUTPUTPARAMS-NOPREVIEW  = IS_ITCPO-TDNOPREV.

ENDFORM.                    " fill_outputparams_PDF


FORM GET_BANK.
 data answer.
* bank data:
* 1. eknam (f_ztrn-eknam) vttkvb-tdlnr
* 2. payer (f_ztrn-plnam) likp-kunag

 clear answer.

    SELECT SINGLE PAVAL FROM T001Z INTO answer
      WHERE BUKRS EQ save_bukrs
      AND   PARTY EQ 'SAPRB1'.


 IF ANSWER EQ '1'.

  eknam_bank-lifnr = vttkvb-tdlnr.
  payer_bank-kunnr = likp-kunag.

 perform vend_bank_data using eknam_bank-lifnr
                     changing eknam_bank-bankadat.

 perform partn_bank_data using payer_bank-kunnr
                     changing payer_bank-bankadat.

 ELSE.
   clear eknam_bank.
   clear payer_bank.
 ENDIF.
ENDFORM.                    " GET_BANK

*&---------------------------------------------------------------------*
*&      Form  partn_bank_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM partn_bank_data  USING    P_kunnr
                      CHANGING P_BANKADAT.

data: ADDR1_VAL type ADDR1_VAL.
data: BANKS like KNBK-BANKS,   "Bank country key
      BANKL like KNBK-BANKL,       "Bank Key
      BANKN like KNBK-BANKN,       "Bank Account Number
      BKONT like KNBK-BKONT.       "Bank Control Key

clear p_bankadat.

      SELECT  SINGLE BANKS BANKL BANKN BKONT FROM KNBK
         into (BANKS, BANKL, BANKN, BKONT)
         WHERE  kunnr = P_kunnr.

      SELECT  SINGLE * FROM  BNKA
         WHERE  BANKS  = BANKS
         AND    BANKL  = BANKL.

clear sel.
sel-addrnumber = BNKA-Adrnr.
     clear addr1_val. sel-nation = 'R'.
    CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.

 if sy-subrc eq 0.
   concatenate ADDR1_VAL-name1 ADDR1_VAL-name2 ADDR1_VAL-name3
     ADDR1_VAL-name4 ADDR1_VAL-city1 into p_bankadat separated by space.
 else.
   concatenate bnka-banka bnka-ort01 into p_bankadat separated by space.
 endif.

 concatenate p_bankadat text-003 bnka-BNKLZ text-004 bnka-BRNCH
    text-005 BKONT into p_bankadat separated by space.
 concatenate p_bankadat BANKN into p_bankadat.

ENDFORM.                    " partn_bank_data

*&---------------------------------------------------------------------*
*&      Form  vend_bank_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM vend_bank_data  USING p_lifnr
                  CHANGING P_BANKADAT.

data: ADDR1_VAL type ADDR1_VAL.
data: BANKS like LFBK-BANKS,       "Bank country key
      BANKL like LFBK-BANKL,       "Bank Key
      BANKN like LFBK-BANKN,       "Bank Account Number
      BKONT like LFBK-BKONT.       "Bank Control Key

clear p_bankadat.

      SELECT  SINGLE BANKS BANKL BANKN BKONT FROM LFBK
         into (BANKS, BANKL, BANKN, BKONT)
         WHERE  lifnr = p_lifnr.

      SELECT  SINGLE * FROM  BNKA
         WHERE  BANKS  = BANKS
         AND    BANKL  = BANKL.

clear sel.
sel-addrnumber = BNKA-Adrnr.
     clear addr1_val. sel-nation = 'R'.
    CALL FUNCTION 'ADDR_GET'
         EXPORTING
              ADDRESS_SELECTION = SEL
         IMPORTING
              ADDRESS_VALUE     = ADDR1_VAL
         EXCEPTIONS
              PARAMETER_ERROR   = 1
              ADDRESS_NOT_EXIST = 2
              VERSION_NOT_EXIST = 3
              INTERNAL_ERROR    = 4
              OTHERS            = 5.

 if sy-subrc eq 0.
   concatenate ADDR1_VAL-name1 ADDR1_VAL-name2 ADDR1_VAL-name3
     ADDR1_VAL-name4 ADDR1_VAL-city1 into p_bankadat separated by space.
 else.
   concatenate bnka-banka bnka-ort01 into p_bankadat separated by space.
 endif.

 concatenate p_bankadat text-003 bnka-BNKLZ text-004 bnka-BRNCH
    text-005 BKONT into p_bankadat separated by space.
 concatenate p_bankadat BANKN into p_bankadat.

ENDFORM.                    " vend_bank_data

*Text symbol text
*001:kop.
*003:BIK
*004:cor/acc
*005:set/acc
