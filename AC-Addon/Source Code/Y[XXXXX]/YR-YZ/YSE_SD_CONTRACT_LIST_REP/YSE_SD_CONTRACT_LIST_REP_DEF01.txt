*----------------------------------------------------------------------*
***INCLUDE YSE_SD_CONTRACT_LIST_REP_DEF01 .
*----------------------------------------------------------------------*

*----------------------------------------------------------------------*
FORM initialize_data.

  CLEAR: it_contract, it_vbep,
         se_allowed_auart, it_sort, gt_fieldcat.
  REFRESH: it_contract, it_vbep,
         se_allowed_auart, it_sort, gt_fieldcat.



ENDFORM.                    " INITIALIZE_DATA

*&---------------------------------------------------------------------*
*&      Form  select_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM select_data.
  DATA: l_lin TYPE i,
        lv_condfilter TYPE tp_conditions,
        lv_period  TYPE i,
        lt_condfilter TYPE TABLE OF tp_conditions.

  DATA: lt_veda     TYPE HASHED TABLE OF tp_veda WITH HEADER LINE
                       WITH UNIQUE KEY vbeln vposn,
*        lt_fplnr     TYPE HASHED TABLE OF tp_fplnr WITH HEADER LINE
*                       WITH UNIQUE KEY fplnr,
        lt_vbkd     TYPE HASHED TABLE OF tp_vbkd WITH HEADER LINE
                       WITH UNIQUE KEY vbeln posnr.
  FIELD-SYMBOLS: <l_konp> TYPE tp_konp.


  SELECT *
      FROM yse_rent_duratio
      INTO TABLE gt_duration.
  SORT gt_duration.

*VBAK - VBAP - VBUK - KNA1
  SELECT a~vbeln
         a~auart
         a~audat
         a~ernam
         a~kunnr
         a~vkorg
         a~vtweg
         a~spart
         a~vkbur
         a~vkbur
         a~vkgrp
         a~waerk
         a~erdat
         a~erzet
         a~vbtyp
         a~vdatu
         a~lifsk
         a~faksk
         a~kvgr2
         a~knumv                                            "20080404
         b~posnr
         b~matnr
         b~arktx
         b~zzequnr
         b~zzsernr
         b~kwmeng
         b~pstyv
         b~netpr
         b~kpein
         b~vrkme
         b~netwr
         b~werks
         b~vstel
         b~vkaus
         b~pmatn                                            "20080410
         b~abgru
         c~gbstk
         c~lfstk
*         c~fkstk
         e~fksaa
         c~cmgst
         d~name1
         d~adrnr
         b~kzwi2                                            "20080404
         b~kzwi3                                            "20080404
         INTO CORRESPONDING FIELDS OF TABLE it_contract
         FROM vbak AS a
         INNER JOIN vbap AS b ON a~vbeln = b~vbeln
         INNER JOIN vbuk AS c ON a~vbeln = c~vbeln
         INNER JOIN kna1 AS d ON a~kunnr = d~kunnr
         INNER JOIN vbup AS e ON a~vbeln = e~vbeln AND b~posnr = e~posnr
         WHERE a~vbeln IN se_vbeln
         AND a~audat IN se_audat
         AND a~ernam IN se_ernam
         AND a~vkbur IN se_vkbur
         AND a~vkgrp IN se_vkgrp
         AND a~auart IN se_auart
         AND a~vkorg IN se_vkorg
         AND a~vtweg IN se_vtweg
         AND a~spart IN se_spart
         AND a~kunnr IN se_kunnr
         AND b~matnr IN se_matnr
         AND b~zzequnr IN se_equnr
         AND b~zzsernr IN se_sernr.

  SORT it_contract BY vbeln posnr.
  IF NOT it_contract[] IS INITIAL.
* Contract Data
    SELECT vbeln vposn vbegdat venddat vlaufk vkuesch vkuegru veindat vwundat
       FROM veda
       INTO TABLE lt_veda
       FOR ALL ENTRIES IN it_contract
       WHERE vbeln = it_contract-vbeln.

    SELECT vbeln posnr etenr wadat edatu
       FROM vbep
       INTO TABLE it_vbep
       FOR ALL ENTRIES IN it_contract
       WHERE vbeln = it_contract-vbeln
         AND posnr = it_contract-posnr
         AND bmeng > 0.

    SORT it_vbep BY vbeln posnr wadat DESCENDING.

* First select lines with  a billing Plan
    SELECT vbeln posnr kursk prsdt bstkd fplnr
          vbkd~zterm
       FROM vbkd
       INTO TABLE lt_vbkd
       FOR ALL ENTRIES IN it_contract
       WHERE vbeln = it_contract-vbeln
         AND posnr = it_contract-posnr.

*    SELECT  fplnr fksaf
*       FROM fplt
*       INTO TABLE lt_fplnr
*       FOR ALL ENTRIES IN lt_vbkd
*       WHERE fplnr = lt_vbkd-fplnr
*         AND fpltr EQ ( SELECT MAX( fpltr )
*                        FROM fplt
*                        WHERE fplnr EQ lt_vbkd-fplnr ).



    CLEAR: l_lin.
    it_contract_tmp[] = it_contract[].
    DELETE it_contract_tmp WHERE zzequnr IS INITIAL.
    DESCRIBE TABLE it_contract_tmp LINES l_lin.
    IF l_lin GT 0.
      SELECT DISTINCT equi~equnr iloa~bukrs
        FROM equi
        JOIN equz ON equi~equnr = equz~equnr
        JOIN iloa ON equz~iloan = iloa~iloan
        INTO TABLE it_itob
        FOR ALL ENTRIES IN it_contract_tmp
        WHERE equi~equnr EQ it_contract_tmp-zzequnr
          AND bukrs <> ''.
    ENDIF.

* get payment terms from customer masters

    SELECT vbpa~vbeln vbpa~posnr vbpa~parvw vbpa~kunnr
           knvv~zterm
          FROM vbpa
          JOIN knvv ON knvv~kunnr = vbpa~kunnr
          INTO TABLE it_partner
          FOR ALL ENTRIES IN it_contract
          WHERE vbpa~vbeln = it_contract-vbeln
                AND ( vbpa~posnr = '000000' OR vbpa~posnr = it_contract-posnr )
                AND vbpa~parvw = 'RG'    " PAYER
*              AND vbpa~parvw = 'RE'.    " BILL TO
                AND knvv~vkorg = it_contract-vkorg
                AND knvv~vtweg = it_contract-vtweg
                AND knvv~spart = it_contract-spart.

* create a shorter table for later selections
    REFRESH lt_condfilter.
    LOOP AT it_contract ASSIGNING <x_contract>.


* MOVE vbkd to contract
      READ TABLE lt_vbkd WITH KEY vbeln = <x_contract>-vbeln
                                  posnr = <x_contract>-posnr.
      IF sy-subrc EQ 0.
        <x_contract>-kursk   = lt_vbkd-kursk.
        <x_contract>-prsdt   = lt_vbkd-prsdt.
        <x_contract>-bstkd   = lt_vbkd-bstkd.
        <x_contract>-zterm   = lt_vbkd-zterm.
*      <x_contract>-fkstk   = lt_vbkd-fksaf.
      ENDIF.



*  START move VEDA data to it_contract.
      READ TABLE lt_veda WITH KEY vbeln = <x_contract>-vbeln
                                  vposn = <x_contract>-posnr.
      IF sy-subrc EQ 0.
        <x_contract>-vbegdat = lt_veda-vbegdat.
        <x_contract>-venddat = lt_veda-venddat.
        <x_contract>-vlaufk  = lt_veda-vlaufk.
        <x_contract>-vkuesch = lt_veda-vkuesch.
        <x_contract>-vkuegru = lt_veda-vkuegru.
        <x_contract>-veindat = lt_veda-veindat.
        <x_contract>-vwundat = lt_veda-vwundat.
        IF <x_contract>-vlaufk IS INITIAL.
          READ TABLE lt_veda WITH KEY vbeln = <x_contract>-vbeln
                                      vposn = '000000'.
          IF sy-subrc EQ 0.
            <x_contract>-vlaufk  = lt_veda-vlaufk.
          ENDIF.
        ENDIF.
      ELSE.
        READ TABLE lt_veda WITH KEY vbeln = <x_contract>-vbeln
                                    vposn = '000000'.
        IF sy-subrc EQ 0.
          <x_contract>-vbegdat = lt_veda-vbegdat.
          <x_contract>-venddat = lt_veda-venddat.
          <x_contract>-vlaufk  = lt_veda-vlaufk.
          <x_contract>-vkuesch = lt_veda-vkuesch.
          <x_contract>-vkuegru = lt_veda-vkuegru.
          <x_contract>-veindat = lt_veda-veindat.
          <x_contract>-vwundat = lt_veda-vwundat.
        ENDIF.
      ENDIF.

* because of user-exit problem, wrong LAUFK was stored
*     Calculate period length
      lv_period = <x_contract>-venddat - <x_contract>-vbegdat + 1.
*     Find most appropriate config entry
      CLEAR gt_duration.
      LOOP AT gt_duration WHERE low  <= lv_period AND
                                high >= lv_period.
        EXIT.
      ENDLOOP.
      <x_contract>-vlaufk2 = gt_duration-vlaufk.
*  END move VEDA data to it_contract.

      MOVE <x_contract>-vkorg  TO lv_condfilter-vkorg.
      MOVE <x_contract>-vtweg  TO lv_condfilter-vtweg.
      MOVE <x_contract>-matnr  TO lv_condfilter-matnr.
      MOVE <x_contract>-pmatn  TO lv_condfilter-pmatn.
      APPEND lv_condfilter TO lt_condfilter.
    ENDLOOP.
    SORT lt_condfilter.
    DELETE ADJACENT DUPLICATES FROM lt_condfilter.

* get material masters reference material
    SELECT matnr vkorg vtweg pmatn
         FROM mvke
         INTO TABLE it_mvke
         FOR ALL ENTRIES IN lt_condfilter
         WHERE  ( mvke~matnr = lt_condfilter-matnr
                 OR mvke~matnr = lt_condfilter-pmatn )
               AND vkorg = lt_condfilter-vkorg
               AND vtweg = lt_condfilter-vtweg.

* set new condfilter just for conditions
    REFRESH lt_condfilter.
    LOOP AT it_contract ASSIGNING <x_contract>
          WHERE pstyv = 'ZMVN' OR pstyv = 'ZNOD' OR pstyv = 'ZRNS'.
      MOVE <x_contract>-vkorg  TO lv_condfilter-vkorg.
      MOVE <x_contract>-vtweg  TO lv_condfilter-vtweg.
      MOVE <x_contract>-matnr  TO lv_condfilter-matnr.
      MOVE <x_contract>-pmatn  TO lv_condfilter-pmatn.
      MOVE <x_contract>-vkaus  TO lv_condfilter-vkaus.
      MOVE <x_contract>-vlaufk TO lv_condfilter-zzvlaufk.
      MOVE <x_contract>-vlaufk2 TO lv_condfilter-zzvlaufk2.
      APPEND lv_condfilter TO lt_condfilter.
    ENDLOOP.
    SORT lt_condfilter.
    DELETE ADJACENT DUPLICATES FROM lt_condfilter.


* get original list price conditions:
* (tr vk13, see YSE_UPLOAD_PRICES for more types)

* ZREN - A914 - Sales org./Distr. Chl/Material/Usage
    SELECT kschl vkorg vtweg matnr  vkaus  knumh datab datbi
          FROM a914
          INTO CORRESPONDING FIELDS OF TABLE it_conditions
          FOR ALL ENTRIES IN lt_condfilter
          WHERE kappl = 'V'
            AND kschl = 'ZREN'
            AND vkorg = lt_condfilter-vkorg
            AND vtweg = lt_condfilter-vtweg
            AND ( matnr = lt_condfilter-matnr OR matnr = lt_condfilter-pmatn )
            AND vkaus = lt_condfilter-vkaus.
*
** ZRER - A913 - Sales org./Distr. Chl/Material/Val.categ./Usage
    SELECT kschl vkorg vtweg matnr zzvlaufk vkaus knumh datab datbi
          FROM a913
          APPENDING CORRESPONDING FIELDS OF TABLE it_conditions
          FOR ALL ENTRIES IN lt_condfilter
          WHERE kappl = 'V'
            AND kschl = 'ZRED'
            AND vkorg = lt_condfilter-vkorg
            AND vtweg = lt_condfilter-vtweg
            AND ( matnr = lt_condfilter-matnr OR matnr = lt_condfilter-pmatn )
            AND ( zzvlaufk = lt_condfilter-zzvlaufk OR zzvlaufk = lt_condfilter-zzvlaufk2 )
            AND vkaus = lt_condfilter-vkaus.

    IF NOT it_conditions[] IS INITIAL.
      SELECT knumh kopos kbetr konwa kpein kmein kumza kumne meins
          FROM konp
          INTO TABLE it_konp
          FOR ALL ENTRIES IN it_conditions
          WHERE knumh = it_conditions-knumh.
    ENDIF.
    LOOP AT it_konp ASSIGNING <l_konp>.
      IF NOT <l_konp>-meins IS INITIAL AND <l_konp>-kumne > 0.
        <l_konp>-kpein = <l_konp>-kpein * <l_konp>-kumza / <l_konp>-kumne.
        <l_konp>-kmein = <l_konp>-meins.
        CLEAR <l_konp>-meins.
        CLEAR <l_konp>-kumza.
        CLEAR <l_konp>-kumne.
      ENDIF.
    ENDLOOP.

    SELECT *
    INTO TABLE it_konv
    FROM konv
    FOR ALL ENTRIES IN it_contract
    WHERE knumv EQ   it_contract-knumv
    AND kposn   EQ   it_contract-posnr.




  ENDIF.
ENDFORM.                    " SELECT_DATA


*----------------------------------------------------------------------*
*   Form  PROCESS_DATA                                                 *
*----------------------------------------------------------------------*
*   .....                                                              *
*----------------------------------------------------------------------*
FORM process_data.
  DATA: lv_conditions TYPE tp_conditions,
        lv_condition_ok TYPE tp_conditions,
        lv_partner TYPE tp_partner,
        lv_tabix LIKE sy-tabix,
        lv_mvke TYPE tp_mvke,
        lv_konp TYPE tp_konp,
        lv_price LIKE konv-kbetr,
        lv_kbetr LIKE konv-kbetr,
        lv_konv LIKE konv,
        p_vbeln TYPE vbeln.

  SORT it_conditions BY vkorg vtweg matnr vkaus kschl.
  SORT it_konp BY knumh kopos.

  LOOP AT it_contract.

*START 20080404
* Discount rate
    IF it_contract-kzwi2 > 0.
      IF it_contract-vbeln NE p_vbeln.
        CLEAR lt_vbap_kschl[].
*        it_contract-discount = ( it_contract-kzwi2 - it_contract-kzwi3 ) / it_contract-kzwi2  * 100.
        CALL FUNCTION 'YSE_CHECK_CONDITIONS_SALES'
          EXPORTING
            im_vbeln            = it_contract-vbeln
            im_posnr            = it_contract-posnr
            im_venddat          = it_contract-venddat
            im_vbegdat          = it_contract-vbegdat
*       IMPORTING
*         EX_RESULT           =
          TABLES
            it_vbap_kschl       = lt_vbap_kschl.
        MOVE it_contract-vbeln TO p_vbeln.
      ENDIF.
      READ TABLE lt_vbap_kschl WITH KEY vbeln = it_contract-vbeln
                                        posnr = it_contract-posnr.

      IF sy-subrc EQ 0 AND lt_vbap_kschl-refnet NE 0.
        it_contract-discount =  ( lt_vbap_kschl-refnet - lt_vbap_kschl-newnet ) * 100
                                / lt_vbap_kschl-refnet.

*        it_contract-netpr = lt_vbap_kschl-newnet.
      ENDIF.




    ENDIF.

*END 20080404

    READ TABLE it_vbep WITH KEY vbeln = it_contract-vbeln
                                posnr = it_contract-posnr
                       BINARY SEARCH
                                .
    IF sy-subrc EQ 0.
      it_contract-wadat   = it_vbep-wadat.
      it_contract-edatu   = it_vbep-edatu.
*      it_contract-meins   = it_vbep-meins.
    ENDIF.

    READ TABLE it_itob WITH KEY equnr = it_contract-zzequnr.
    IF sy-subrc EQ 0.
      it_contract-bukrs = it_itob-bukrs.
    ENDIF.

* START SET THE LIGHTS

* 1. Red light when list price has been changed
* (vs. condition records ZRED or ZREN based on master data select via Sales org, usage and (pricing ref) material¨¤

* get first possible line index number

*    IF     it_contract-pstyv = 'ZMVN'  " only for specific item categories
*       OR  it_contract-pstyv = 'ZNOD'
*       OR  it_contract-pstyv = 'ZRNS'
*       OR  it_contract-pstyv = 'ZREN'.


   IF     it_contract-pstyv in lr_pstyv.
*    READ TABLE it_conditions TRANSPORTING NO FIELDS
*       WITH KEY  vkorg = it_contract-vkorg         "zred, zren
*                 vtweg = it_contract-vtweg       "zred, zren
*                 matnr = it_contract-matnr       "zred, zren
*                 vkaus = it_contract-vkaus       "zred, zren
*           BINARY SEARCH.

      lv_tabix = sy-tabix.
      CLEAR lv_condition_ok.
      LOOP AT it_conditions INTO lv_conditions
           WHERE  vkorg = it_contract-vkorg         "zred, zren
             AND  vtweg = it_contract-vtweg       "zred, zren
             AND  ( matnr = it_contract-matnr       "zred, zren
             OR     matnr =   it_contract-pmatn )
             AND  vkaus = it_contract-vkaus.       "zred, zren

*   check if still looping records that we need
*          IF lv_conditions-matnr <> it_contract-matnr
*                OR lv_conditions-vkaus <> it_contract-vkaus.
*            EXIT.
*          ENDIF.
        IF NOT ( lv_conditions-datab <= it_contract-audat
             AND lv_conditions-datbi >= it_contract-audat ).
          CONTINUE.
        ENDIF.

*   vbak-kvgr2 (Contract Additional data) decideds which condition to use
        IF it_contract-kvgr2 = 'PCB' AND lv_conditions-kschl = 'ZRED'."  (A913)
          IF lv_conditions-zzvlaufk = it_contract-vlaufk.
            lv_condition_ok = lv_conditions.
            EXIT.
          ELSEIF lv_conditions-zzvlaufk = it_contract-vlaufk2.  " the real one
            lv_condition_ok = lv_conditions.
            EXIT.
          ELSE.
            CONTINUE.
          ENDIF.
        ELSEIF it_contract-kvgr2 = 'PCM' AND lv_conditions-kschl = 'ZREN'."  (A914)
          lv_condition_ok = lv_conditions.
          EXIT.

        ENDIF.
      ENDLOOP.
* finally let's test the list price
      IF lv_condition_ok IS INITIAL.
        it_contract-led_listpr = c_yellow.
      ELSE.
        READ TABLE it_konp INTO lv_konp WITH KEY knumh = lv_condition_ok-knumh
                                    kopos = '01'
                           BINARY SEARCH.

* Convert to Base Unit of Measure
        IF lv_konp-kmein <> it_contract-vrkme.
          CALL FUNCTION 'ISM_SD_CONVERT_TO_BASIC_UNIT'
            EXPORTING
              in_unit          = lv_konp-kmein
              in_quantity      = lv_konp-kpein
              in_matnr         = it_contract-matnr
            IMPORTING
              out_quantity     = lv_konp-kpein
              out_unit         = lv_konp-kmein
            EXCEPTIONS
              conversion_error = 1
              OTHERS           = 2.
          IF sy-subrc = 0.
            CALL FUNCTION 'ISM_SD_CONVERT_TO_BASIC_UNIT'
              EXPORTING
                in_unit          = it_contract-vrkme
                in_quantity      = it_contract-kwmeng
                in_matnr         = it_contract-matnr
              IMPORTING
                out_quantity     = it_contract-kwmeng
                out_unit         = it_contract-vrkme
              EXCEPTIONS
                conversion_error = 1
                OTHERS           = 2.
            IF sy-subrc <> 0.
            ENDIF.
          ENDIF.
        ENDIF.

        lv_price =  lv_konp-kbetr * it_contract-kwmeng / lv_konp-kpein.
        IF lv_konp-kbetr = it_contract-kzwi2 AND lv_konp-konwa = it_contract-waerk.
          it_contract-led_listpr = c_green.
        ELSE.
          it_contract-led_listpr = c_red.
        ENDIF.

* determine the active condition.
        PERFORM determine_active_condition
                    TABLES
                       it_konv
                       it_contract
*              USING
*                 t_vbak
*                 p_posnr
                    CHANGING
                       lv_kschl
                       p_refnet
                       p_newnet
                       p_fix.
*        perform determine_active_condtion

        READ TABLE it_konv INTO lv_konv
          WITH KEY knumv = it_contract-knumv
                   kposn = it_contract-posnr
                   kschl = lv_kschl.


        IF lv_konv-kherk EQ 'A' AND
           lv_konv-ksteu NE 'C' AND
           lv_konv-kbetr GT 0   AND
           lv_konv-kinak NE 'Y'.
          it_contract-led_listpr = c_green.
        ELSE.
          it_contract-led_listpr = c_red.
        ENDIF.




      ENDIF.
    ENDIF.  " only some item categories


* 2. Red light when payment terms have been changed (vs. customer master of payer)
    READ TABLE it_partner INTO lv_partner WITH KEY
                vbeln = it_contract-vbeln
                posnr = it_contract-posnr
                parvw = 'RG'.              "payer

    IF sy-subrc <> 0.
      READ TABLE it_partner INTO lv_partner WITH KEY
                vbeln = it_contract-vbeln
                posnr = '000000'
                parvw = 'RG'.              "payer
    ENDIF.

    IF sy-subrc = 0.
      IF lv_partner-zterm <> it_contract-zterm.
        it_contract-led_payterm = c_red.
      ELSE.
        it_contract-led_payterm = c_green.
      ENDIF.
    ELSE.
      it_contract-led_payterm = c_yellow.
    ENDIF.

* 3. Red light when pricing reference material has been changed (vs. material master)
    READ TABLE it_mvke INTO lv_mvke WITH KEY
                matnr = it_contract-matnr
                vkorg = it_contract-vkorg
                vtweg = it_contract-vtweg.
    IF sy-subrc <> 0.
      it_contract-led_refmat = c_yellow.
    ELSE.
      IF lv_mvke-pmatn = it_contract-pmatn.
        it_contract-led_refmat = c_green.
      ELSE.
        it_contract-led_refmat = c_red.
      ENDIF.
    ENDIF.
* END OF SET THE LIGHTS


*    CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
*      EXPORTING
*        input                = it_contract-vrkme
**   LANGUAGE             = SY-LANGU
*     IMPORTING
*       output               = it_contract-vrkme
*              .


    MODIFY it_contract.
  ENDLOOP.


ENDFORM.                    " PROCESS_DATA


*----------------------------------------------------------------------*
*   Form  DISPLAY_DATA                                                 *
*----------------------------------------------------------------------*
*   .....                                                              *
*----------------------------------------------------------------------*
FORM display_data.

  PERFORM fill_field_catalog.
  PERFORM prepare_sort.
  PERFORM change_catalog.
  PERFORM alv_output.

ENDFORM.                    " DISPLAY_DATA


*----------------------------------------------------------------------*
*       Form  FILL_FIELD_CATALOG                                       *
*----------------------------------------------------------------------*
*       text                                                           *
*----------------------------------------------------------------------*
FORM fill_field_catalog.

*  x_repid = sy-repid.
*  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
*       EXPORTING
*            i_program_name         = x_repid
*            i_internal_tabname     = 'IT_CONTRACT'
**           i_structure_name       =
**           i_client_never_display = 'X'
*            i_inclname             = x_repid
**           i_bypassing_buffer     =
**           i_buffer_active        =
*       CHANGING
*            ct_fieldcat            = it_fieldcat[]
*       EXCEPTIONS
*            inconsistent_interface = 1
*            program_error          = 2
*            OTHERS                 = 3.
*  IF sy-subrc <> 0.
**   message id sy-msgid type sy-msgty number sy-msgno
**           with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VBELN'.
  gs_fieldcat-seltext_l = 'Sales document'(k01).
  gs_fieldcat-seltext_s = 'Sales document'(k01).
  gs_fieldcat-no_zero   = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'AUART'.
  gs_fieldcat-seltext_l = 'Document type'(k02).
  gs_fieldcat-seltext_s = 'Document type'(k02).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'AUART'.

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'LED_LISTPR'.
  gs_fieldcat-seltext_l = 'Listprice changed'(k60).
  gs_fieldcat-seltext_s = 'Listprice'(k61).
  gs_fieldcat-icon = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'LED_PAYTERM'.
  gs_fieldcat-seltext_l = 'Payment term changed'(k62).
  gs_fieldcat-seltext_s = 'Payterm'(k63).
  gs_fieldcat-icon = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'LED_REFMAT'.
  gs_fieldcat-seltext_l = 'Reference material changed'(k64).
  gs_fieldcat-seltext_s = 'Refmat'(k65).
  gs_fieldcat-icon = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VBEGDAT'.
  gs_fieldcat-seltext_l = 'Start date'(k03).
  gs_fieldcat-seltext_s = 'Start date'(k03).
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VENDDAT'.
  gs_fieldcat-seltext_l = 'End date'(k04).
  gs_fieldcat-seltext_s = 'End date'(k04).
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'AUDAT'.
  gs_fieldcat-seltext_l = 'Document date'(k05).
  gs_fieldcat-seltext_s = 'Document date'(k05).
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VLAUFK'.
  gs_fieldcat-seltext_l = 'Val.period category'(k06).
  gs_fieldcat-seltext_s = 'Val.period category'(k06).
  gs_fieldcat-ref_tabname   = 'VEDA'.
  gs_fieldcat-ref_fieldname = 'VLAUFK'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ERNAM'.
  gs_fieldcat-seltext_l = 'Created by'(k07).
  gs_fieldcat-seltext_s = 'Created by'(k07).
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'KUNNR'.
  gs_fieldcat-seltext_l = 'Sold-to-party'(k08).
  gs_fieldcat-seltext_s = 'Sold-to-party'(k08).
  gs_fieldcat-no_zero   = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'NAME1'.
  gs_fieldcat-seltext_l = 'Customer description'(k09).
  gs_fieldcat-seltext_s = 'Customer description'(k09).
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'POSNR'.
  gs_fieldcat-seltext_l = 'Item'(k10).
  gs_fieldcat-seltext_s = 'Item'(k10).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'MATNR'.
  gs_fieldcat-seltext_l = 'Material'(k11).
  gs_fieldcat-seltext_s = 'Material'(k11).
  gs_fieldcat-no_zero   = 'X'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ARKTX'.
  gs_fieldcat-seltext_l = 'Material description'(k12).
  gs_fieldcat-seltext_s = 'Material description'(k12).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ZZEQUNR'.
  gs_fieldcat-seltext_l = 'Equipment'(k13).
  gs_fieldcat-seltext_s = 'Equipment'(k13).
  gs_fieldcat-no_zero   = 'X'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.

  gs_fieldcat-fieldname = 'ZZSERNR'.
  gs_fieldcat-seltext_l = 'Serial Number'(K66).
  gs_fieldcat-seltext_s = 'Serial Number'(K66).
  gs_fieldcat-no_zero   = 'X'.

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'KWMENG'.
  gs_fieldcat-seltext_l = 'Order quantity'(k14).
  gs_fieldcat-seltext_s = 'Order quantity'(k14).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'PSTYV'.
  gs_fieldcat-seltext_l = 'Item category'(k15).
  gs_fieldcat-seltext_s = 'Item category'(k15).
  gs_fieldcat-ref_tabname   = 'VBAP'.
  gs_fieldcat-ref_fieldname = 'PSTYV'.

  APPEND gs_fieldcat TO gt_fieldcat.

*  CLEAR gs_fieldcat.
*  gs_fieldcat-fieldname = 'MEINS'.
*  gs_fieldcat-seltext_l = 'Base unit of measure'(k16).
*  gs_fieldcat-seltext_s = 'Base unit of measure'(k16).

*  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VKAUS'.
  gs_fieldcat-seltext_l = 'Usage'(k43).
  gs_fieldcat-seltext_s = 'Usage'(k43).
  gs_fieldcat-ref_tabname   = 'VBAP'.
  gs_fieldcat-ref_fieldname = 'VKAUS'.


  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'NETPR'.
  gs_fieldcat-seltext_l = 'Net price'(k17).
  gs_fieldcat-seltext_s = 'Net price'(k17).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'KPEIN'.
  gs_fieldcat-seltext_l = 'Pricing unit'(k18).
  gs_fieldcat-seltext_s = 'Pricing unit'(k18).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VRKME'.
  gs_fieldcat-seltext_l = 'Unit of measure'(k19).
  gs_fieldcat-seltext_s = 'Unit of measure'(k19).
  gs_fieldcat-edit_mask  = '==CUNIT'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'NETWR'.
  gs_fieldcat-seltext_l = 'Net value'(k20).
  gs_fieldcat-seltext_s = 'Net value'(k20).

  APPEND gs_fieldcat TO gt_fieldcat.

* START 20080404
*  CLEAR gs_fieldcat.
*  gs_fieldcat-fieldname = 'LISTPR'.
*  gs_fieldcat-seltext_l = 'Rental List Price'(k56).
*  gs_fieldcat-seltext_s = text-k56.
*  APPEND gs_fieldcat TO gt_fieldcat.
*
*  CLEAR gs_fieldcat.
*  gs_fieldcat-fieldname = 'STOTAL2'.
*  gs_fieldcat-seltext_l = 'Subtotal 2'(k57).
*  gs_fieldcat-seltext_s = text-k57.
*  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'DISCOUNT'.
  gs_fieldcat-seltext_l = 'Applied discount %'(k58).
  gs_fieldcat-seltext_s = 'Discount %'(k59).
  APPEND gs_fieldcat TO gt_fieldcat.

* END 20080404


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'GBSTK'.
  gs_fieldcat-seltext_l = 'Overall status'(k21).
  gs_fieldcat-seltext_s = 'Overall status'(k21).
  gs_fieldcat-ref_tabname   = 'VBUK'.
  gs_fieldcat-ref_fieldname = 'GBSTK'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'LFSTK'.
  gs_fieldcat-seltext_l = 'Delivery status'(k22).
  gs_fieldcat-seltext_s = 'Delivery status'(k22).
  gs_fieldcat-ref_tabname   = 'VBUK'.
  gs_fieldcat-ref_fieldname = 'LFSTK'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'LIFSK'.
  gs_fieldcat-seltext_l = 'Delivery block'(k42).
  gs_fieldcat-seltext_s = 'Delivery block'(k42).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'LIFSK'.
  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
*  gs_fieldcat-fieldname = 'FKSTK'.
  gs_fieldcat-fieldname = 'FKSAA'.
  gs_fieldcat-seltext_l = 'Billing status'(k23).
  gs_fieldcat-seltext_s = 'Billing status'(k23).
  gs_fieldcat-ref_tabname   = 'VBUK'.
  gs_fieldcat-ref_fieldname = 'FKSTK'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'FAKSK'.
  gs_fieldcat-seltext_l = 'Billing block'(k44).
  gs_fieldcat-seltext_s = 'Billing block'(k44).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'FAKSK'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'KVGR2'.
  gs_fieldcat-seltext_l = 'Billing type'(k45).
  gs_fieldcat-seltext_s = 'Billing type'(k45).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'KVGR2'.

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'CMGST'.
  gs_fieldcat-seltext_l = 'Overall credit status'(k24).
  gs_fieldcat-seltext_s = 'Overall credit status'(k24).
  gs_fieldcat-ref_tabname   = 'VBUK'.
  gs_fieldcat-ref_fieldname = 'CMGST'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VKORG'.
  gs_fieldcat-seltext_l = 'Sales organisation'(k25).
  gs_fieldcat-seltext_s = 'Sales organisation'(k25).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'VKORG'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VTWEG'.
  gs_fieldcat-seltext_l = 'Distribution channel'(k26).
  gs_fieldcat-seltext_s = 'Distribution channel'(k26).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'SPART'.
  gs_fieldcat-seltext_l = 'Division'(k27).
  gs_fieldcat-seltext_s = 'Division'(k27).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'WERKS'.
  gs_fieldcat-seltext_l = 'Plant'(k28).
  gs_fieldcat-seltext_s = 'Plant'(k28).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VSTEL'.
  gs_fieldcat-seltext_l = 'Shipping point/Rec.point'(k29).
  gs_fieldcat-seltext_s = 'Shipping point/Rec.point'(k29).
  gs_fieldcat-ref_tabname   = 'VBAP'.
  gs_fieldcat-ref_fieldname = 'VSTEL'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VKBUR'.
  gs_fieldcat-seltext_l = 'Sales office'(k30).
  gs_fieldcat-seltext_s = 'Sales office'(k30).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'VKBUR'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VKGRP'.
  gs_fieldcat-seltext_l = 'Sales group'(k31).
  gs_fieldcat-seltext_s = 'Sales group'(k31).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'VKGRP'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VDATU'.
  gs_fieldcat-seltext_l = 'Requested delivery date'(k55).
  gs_fieldcat-seltext_s = 'Requested delivery date'(k55).

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'EDATU'.
  gs_fieldcat-seltext_l = 'Delivery date'(k32).
  gs_fieldcat-seltext_s = 'Delivery date'(k32).

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'WADAT'.
  gs_fieldcat-seltext_l = 'Goods issue date'(k33).
  gs_fieldcat-seltext_s = 'Goods issue date'(k33).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'WAERK'.
  gs_fieldcat-seltext_l = 'Doc.currency'(k34).
  gs_fieldcat-seltext_s = 'Doc.currency'(k34).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'KURSK'.
  gs_fieldcat-seltext_l = 'Exchange rate'(k35).
  gs_fieldcat-seltext_s = 'Exchange rate'(k35).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ADRNR'.
  gs_fieldcat-seltext_l = 'Sold-to-adress'(k36).
  gs_fieldcat-seltext_s = 'Sold-to-adress'(k36).
  gs_fieldcat-no_zero   = 'X'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VBTYP'.
  gs_fieldcat-seltext_l = 'SD doc.category'(k37).
  gs_fieldcat-seltext_s = 'SD doc.category'(k37).
  gs_fieldcat-ref_tabname   = 'VBAK'.
  gs_fieldcat-ref_fieldname = 'VBTYP'.

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'PRSDT'.
  gs_fieldcat-seltext_l = 'Pricing date'(k38).
  gs_fieldcat-seltext_s = 'Pricing date'(k38).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VKUESCH'.
  gs_fieldcat-seltext_l = 'Cancellation proc.'(k39).
  gs_fieldcat-seltext_s = 'Cancellation proc.'(k39).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ERDAT'.
  gs_fieldcat-seltext_l = 'Creation date'(k40).
  gs_fieldcat-seltext_s = 'Creation date'(k40).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ERZET'.
  gs_fieldcat-seltext_l = 'Creation time'(k41).
  gs_fieldcat-seltext_s = 'Creation time'(k41).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VKUEGRU'.
  gs_fieldcat-seltext_l = 'Reason for cancellation of contract'(k49).
  gs_fieldcat-seltext_s = 'Reason for cancellation of contract'(k49).
  gs_fieldcat-ref_tabname   = 'VEDA'.
  gs_fieldcat-ref_fieldname = 'VKUEGRU'.

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VEINDAT'.
  gs_fieldcat-seltext_l = 'Receipt of cancellation'(k47).
  gs_fieldcat-seltext_s = 'Receipt of cancellation'(k47).

  APPEND gs_fieldcat TO gt_fieldcat.

  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'VWUNDAT'.
  gs_fieldcat-seltext_l = 'Requested cancellation date'(k48).
  gs_fieldcat-seltext_s = 'Requested cancellation date'(k48).

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'ABGRU'.
  gs_fieldcat-seltext_l = 'Reason for rejection'(k50).
  gs_fieldcat-seltext_s = 'Reason for rejection'(k50).
  gs_fieldcat-ref_tabname   = 'VBAP'.
  gs_fieldcat-ref_fieldname = 'ABGRU'.

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'BSTKD'.
  gs_fieldcat-seltext_l = 'PO number'(k51).
  gs_fieldcat-seltext_s = 'PO number'(k51).

  APPEND gs_fieldcat TO gt_fieldcat.


  CLEAR gs_fieldcat.
  gs_fieldcat-fieldname = 'BUKRS'.
  gs_fieldcat-seltext_l = 'Company Number'(k52).
  gs_fieldcat-seltext_s = 'Company Number'(k52).

  APPEND gs_fieldcat TO gt_fieldcat.

ENDFORM.                    " FILL_FIELD_CATALOG


*----------------------------------------------------------------------*
*       Form  PREPARE_SORT                                             *
*----------------------------------------------------------------------*
*       text                                                           *
*----------------------------------------------------------------------*
FORM prepare_sort.

*  CLEAR str_sort.
*  str_sort-spos      = '1'.
*  str_sort-fieldname = 'PRCTR'.
*  str_sort-up        = 'X'.
*  APPEND str_sort TO it_sort.

ENDFORM.                    " PREPARE_SORT


*----------------------------------------------------------------------*
*       Form  CHANGE_CATALOG                                           *
*----------------------------------------------------------------------*
*       text                                                           *
*----------------------------------------------------------------------*
FORM change_catalog.

  gs_layout-colwidth_optimize   = 'X'.
*  gs_layout-confirmation_prompt = 'X'.
*  gs_layout-key_hotspot         = 'X'.
  gs_layout-detail_titlebar     = 'RENTAL CONTRACT OVERVIEW'.

ENDFORM.                    " CHANGE_CATALOG


*----------------------------------------------------------------------*
*       Form  ALV_OUTPUT                                               *
*----------------------------------------------------------------------*
*       text                                                           *
*----------------------------------------------------------------------*
FORM alv_output.

  gs_sd_alv_variant = g_variant.

  w_callback_program    = sy-repid.
  w_callback_subroutine = 'HOTSPOT_CLICK'.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
       EXPORTING
*           i_interface_check           = ' '
*           i_bypassing_buffer          =
*           i_buffer_active             = ' '
            i_callback_program          = w_callback_program
*           i_callback_program          = 'YSE_SD_COMMISSION_SALESREP'
*           i_callback_pf_status_set    = ' '
            i_callback_user_command     = w_callback_subroutine
*           i_callback_top_of_page      = ' '
*           i_callback_html_top_of_page = ' '
*           i_callback_html_end_of_list = ' '
*           i_structure_name            =
*           i_background_id             = ' '
            i_grid_title                = 'Rental contract overview'
*           i_grid_settings             =
            is_layout                   = gs_layout
            it_fieldcat                 = gt_fieldcat
*           it_excluding                =
*           it_special_groups           =
            it_sort                     = it_sort
*           it_filter                   =
*           is_sel_hide                 =
            i_default                   = 'X'
            i_save                      = 'A'
            is_variant                  = gs_sd_alv_variant
*           it_events                   =
*           it_event_exit               =
*           is_print                    =
*           is_reprep_id                =
            i_screen_start_column       = 0
            i_screen_start_line         = 0
            i_screen_end_column         = 0
            i_screen_end_line           = 0
*           it_alv_graphics             =
*           it_add_fieldcat             =
*           it_hyperlink                =
*      importing
*           e_exit_caused_by_caller     =
*           es_exit_caused_by_user      =
       TABLES
            t_outtab                    = it_contract
       EXCEPTIONS
            program_error               = 1
            OTHERS                      = 2.
  IF sy-subrc NE 0.
*   message id sy-msgid type sy-msgty number sy-msgno
*           with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " ALV_OUTPUT


*----------------------------------------------------------------------*
*  Form  ALV_OUTPUT                                                    *
*----------------------------------------------------------------------*
*  Handles calling of transactions to edit Sales Orders, Deliveries    *
*  and Invoices when clicking on a hotspot.                            *
*----------------------------------------------------------------------*
FORM hotspot_click USING p_ucomm    LIKE sy-ucomm
                         p_selfield TYPE slis_selfield.

  IF NOT p_selfield-value IS INITIAL.
    IF p_ucomm EQ '&IC1'.    " SAP standard code for clicking
      CASE p_selfield-fieldname.
        WHEN 'VBELN'.
*         Display Sales Order
          SET PARAMETER ID 'AUN' FIELD p_selfield-value.   " 'KTN'
          CALL TRANSACTION 'VA03' AND SKIP FIRST SCREEN.
*        WHEN 'VBELN_J'.
**         Display Delivery
*          SET PARAMETER ID 'VL' FIELD p_selfield-value.
*          CALL TRANSACTION 'VL03N' AND SKIP FIRST SCREEN.
*        WHEN 'VBELN_M'.
**         Display Billing document
*          SET PARAMETER ID 'VF' FIELD p_selfield-value.
*          CALL TRANSACTION 'VF03' AND SKIP FIRST SCREEN.
      ENDCASE.
    ENDIF.    " hotspot click
  ENDIF.    " value not initial
ENDFORM.   " hotspot_click


*&---------------------------------------------------------------------*
*&      Form  check_authorization
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_authorization .

  DATA:
     BEGIN OF lt_vkorg OCCURS 0,
       vkorg LIKE tvko-vkorg,
     END OF lt_vkorg.

  SELECT DISTINCT vkorg
      INTO TABLE lt_vkorg
      FROM tvko
     WHERE vkorg IN se_vkorg.

  LOOP AT lt_vkorg.
    AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
                        ID 'VKORG' FIELD lt_vkorg-vkorg
                        ID 'VTWEG' DUMMY
                        ID 'SPART' DUMMY
                        ID 'ACTVT' DUMMY.

    IF sy-subrc = 4.
*   No authorisation to display data from Sales Organisation p_vkorg
      MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '006'
        WITH lt_vkorg-vkorg.
    ELSEIF sy-subrc <> 0.
*   Error checking authorization.
      MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
    ENDIF.

  ENDLOOP.


ENDFORM.                    " check_authorization

*----------------------------------------------------------------------*
*   Form  EXISTENCE_VARIANT                                            *
*----------------------------------------------------------------------*
*   Does the variant exist ?                                           *
*----------------------------------------------------------------------*
FORM existence_variant USING var LIKE g_variant-variant.

  IF NOT var IS INITIAL.
    g_variant-variant = var.
    CALL FUNCTION 'REUSE_ALV_VARIANT_EXISTENCE'
      EXPORTING
        i_save     = g_variant_save
      CHANGING
        cs_variant = g_variant.
  ELSE.
    PERFORM variant_init.
  ENDIF.

ENDFORM.                    " EXISTENCE_VARIANT


*----------------------------------------------------------------------*
*   Form  GET_DEFAULT_VARIANT                                          *
*----------------------------------------------------------------------*
*   If there is an existing default variant - get it                   *
*----------------------------------------------------------------------*
FORM get_default_variant USING var.

  gx_variant = g_variant.
  CALL FUNCTION 'REUSE_ALV_VARIANT_DEFAULT_GET'
    EXPORTING
      i_save     = g_variant_save
    CHANGING
      cs_variant = gx_variant
    EXCEPTIONS
      not_found  = 2.

  IF sy-subrc IS INITIAL.
    var = gx_variant-variant.
  ENDIF.

ENDFORM.                    " GET_DEFAULT_VARIANT

*----------------------------------------------------------------------*
*   Form  VARIANT_INPUTHELP                                            *
*----------------------------------------------------------------------*
*   F4 - help for variants                                             *
*----------------------------------------------------------------------*
FORM variant_inputhelp USING var.

  CLEAR h_exit.
  CLEAR gx_variant.

  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      is_variant    = g_variant
      i_save        = g_variant_save
    IMPORTING
      e_exit        = h_exit
      es_variant    = gx_variant
    EXCEPTIONS
      not_found     = 1
      program_error = 2
      OTHERS        = 3.

  IF sy-subrc IS INITIAL AND h_exit IS INITIAL.
    g_variant-variant = gx_variant-variant.
    var               = gx_variant-variant.
  ENDIF.

ENDFORM.                    " VARIANT_INPUTHELP


*----------------------------------------------------------------------*
*   Form  VARIANT_INIT                                                 *
*----------------------------------------------------------------------*
*   Initialize variant                                                 *
*----------------------------------------------------------------------*
FORM variant_init.

  CLEAR g_variant.

  x_repid = sy-repid.
  g_variant-report    = x_repid.

ENDFORM.                    "variant_init


*&---------------------------------------------------------------------*
*&      Form  DETERMINE_ACTIVE_CONDTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM determine_active_condition  TABLES   it_konv STRUCTURE konv
                                          t_con STRUCTURE it_contract
*                                 USING    t_vbak STRUCTURE vbak
*                                          p_posnr
                                 CHANGING p_lv_kschl
                                          p_ref_net
                                          p_new_net
                                          p_fix.

  DATA: lv_fa_day   TYPE komp-anz_tage,
        lv_fac_mon  TYPE komp-anz_monate.



* step 1 Calculated Billing or Monthy billing (PCB or PCM)
  IF t_con-kvgr2 EQ 'PCB'.
* Step 1, * step 1.1 check on Condition ZRAD
    READ TABLE it_konv WITH KEY knumv = t_con-knumv
                               kposn = t_con-posnr
                               kschl = 'ZRAD'
                               kinak = ''.
    IF sy-subrc EQ 0.
      MOVE:  t_con-kzwi4 TO p_new_net,
             t_con-kzwi3 TO p_ref_net,
             it_konv-kschl  TO p_lv_kschl,
            'X'            TO p_fix.
    ELSEIF sy-subrc EQ 4.
      READ TABLE it_konv WITH KEY knumv = t_con-knumv
                                 kposn = t_con-posnr
                                 kschl = 'ZRND'
                                 kinak = ''.
      IF sy-subrc EQ 0.
        MOVE:  t_con-kzwi3 TO p_new_net,
               t_con-kzwi2 TO p_ref_net,
               it_konv-kschl  TO p_lv_kschl.
      ELSEIF sy-subrc EQ 4.
        READ TABLE it_konv WITH KEY knumv = t_con-knumv
                         kposn = t_con-posnr
                         kschl = 'ZRED'
                         kinak = ''.
        MOVE:  t_con-kzwi3 TO p_new_net,
               t_con-kzwi2 TO p_ref_net,
               it_konv-kschl  TO p_lv_kschl.
      ENDIF.
    ENDIF.
  ELSEIF t_con-kvgr2 EQ 'PCM'..
* Step 1, * step 1.1 check on Condition ZRAN
    READ TABLE it_konv WITH KEY knumv = t_con-knumv
                               kposn = t_con-posnr
                               kschl = 'ZRAN'
                               kinak = ''.
    IF sy-subrc EQ 0.
      MOVE:  t_con-kzwi4 TO p_new_net,
             t_con-kzwi3 TO p_ref_net,
             it_konv-kschl  TO p_lv_kschl,
            'X'            TO p_fix.
    ELSEIF sy-subrc EQ 4.
      READ TABLE it_konv WITH KEY knumv = t_con-knumv
                                 kposn = t_con-posnr
                                 kschl = 'ZRNN'
                                 kinak = ''.
      IF sy-subrc EQ 0.
        MOVE:  t_con-kzwi3 TO p_new_net,
               t_con-kzwi2 TO p_ref_net,
               it_konv-kschl  TO p_lv_kschl.
      ELSEIF sy-subrc EQ 4.
        READ TABLE it_konv WITH KEY knumv = t_con-knumv
                         kposn = t_con-posnr
                         kschl = 'ZREN'
                         kinak = ''.
        MOVE:  t_con-kzwi3 TO p_new_net,
               t_con-kzwi2 TO p_ref_net,
               it_konv-kschl  TO p_lv_kschl.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " DETERMINE_ACTIVE_CONDTION
*&---------------------------------------------------------------------*
*&      Form  INITIALIZE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM initialize .

  SELECT SINGLE * FROM usr05
          WHERE bname EQ sy-uname AND
                parid EQ 'VKO'.  "sales organisation
  IF sy-subrc EQ 0.
*Check that the value in the parameter is an actual sales org
    TRANSLATE usr05-parva TO UPPER CASE.                 "#EC TRANSLANG
    SELECT SINGLE * FROM tvko
               WHERE vkorg EQ usr05-parva.
    IF sy-subrc EQ 0.
      CLEAR se_vkorg.
      REFRESH se_vkorg.
      se_vkorg-sign = 'I'.
      se_vkorg-option = 'EQ'.
      se_vkorg-low = usr05-parva.
      APPEND se_vkorg.
    ENDIF.
  ENDIF.

  CLEAR se_auart.
  REFRESH se_auart.
  se_auart-sign = 'I'.
  se_auart-option = 'EQ'.
  se_auart-low = 'ZQP'.
  APPEND se_auart.

  se_auart-low = 'ZQP1'.
  APPEND se_auart.

  se_auart-low = 'ZQP2'.
  APPEND se_auart.

  se_auart-low = 'ZRIB'.
  APPEND se_auart.

* fill pstyv range
  lr_pstyv-sign = 'I'.
  lr_pstyv-option = 'EQ'.
  lr_pstyv-low = 'ZREN'.
  APPEND lr_pstyv.

  lr_pstyv-low = 'ZNOD'.
  APPEND lr_pstyv.

  lr_pstyv-low = 'ZMIL'.
  APPEND lr_pstyv.

  lr_pstyv-low = 'ZRNN'.
  APPEND lr_pstyv.

  lr_pstyv-low = 'ZMVN'.
  APPEND lr_pstyv.

  lr_pstyv-low = 'ZRNS'.
  APPEND lr_pstyv.

  lr_pstyv-low = 'ZMWD'.
  APPEND lr_pstyv.

ENDFORM.                    " INITIALIZE
