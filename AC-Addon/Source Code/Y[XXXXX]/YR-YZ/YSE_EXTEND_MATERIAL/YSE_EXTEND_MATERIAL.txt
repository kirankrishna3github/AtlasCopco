***********************************************************************************
* Program ID        : yse_extend_material
* Author            : Yang Lei
* Date              : 17/05/2017
***********************************************************************************
* Description       :
***********************************************************************************

REPORT  yse_extend_material NO STANDARD PAGE HEADING LINE-SIZE 255.


TYPES: BEGIN OF ty_upload,
         v_text(250)  TYPE c,            " FILE UPLOAD TEXT
       END OF ty_upload.
DATA: gt_upload TYPE TABLE OF ty_upload.

TYPES: BEGIN OF ty_item,
          matnr     TYPE ekpo-matnr,
          matnr_ref TYPE ekpo-matnr,
          werks     TYPE rmmg1-werks,
          vkorg     TYPE rmmg1-vkorg,
          vtweg     TYPE rmmg1-vtweg,
          werks_ref TYPE rmmg1-werks,
          vkorg_ref TYPE rmmg1-vkorg,
          vtweg_ref TYPE rmmg1-vtweg,
          dwerk     TYPE mvke-dwerk,
          ekgrp     TYPE marc-ekgrp,
       END OF ty_item,

       BEGIN OF ty_err,
         matnr TYPE ekpo-matnr,
         msg   TYPE char100,
       END OF ty_err.
DATA: gt_item_list TYPE TABLE OF ty_item.



DATA: gv_filename TYPE string.
CONSTANTS: c_filetype(10)   TYPE c VALUE 'ASC',     " FILE TYPE
           c_blanc          TYPE c VALUE ' ',
    con_tab  TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.


PARAMETERS: p_file TYPE ibipparms-path LOWER CASE.

*.................. Selection screen validations...................... *

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file.
  CALL FUNCTION 'F4_FILENAME'
    IMPORTING
      file_name = p_file.


START-OF-SELECTION.
  PERFORM get_item_list.
  PERFORM create_material.

TOP-OF-PAGE.
  WRITE:
    /001 'Material',
     015 'Message'.

*&---------------------------------------------------------------------*
*&      Form  get_item_list
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_item_list .
  DATA: ls_item TYPE ty_item,
        lv_string TYPE string.
  "Upload the item list.
  gv_filename = p_file.
  PERFORM get_from_pres IN PROGRAM yam_common_routines
                                    TABLES  gt_upload
                                    USING   gv_filename
                                            c_filetype
                                            c_blanc.

  LOOP AT gt_upload INTO lv_string.
    SPLIT lv_string AT con_tab
     INTO ls_item-matnr
          ls_item-matnr_ref
          ls_item-werks
          ls_item-vkorg
          ls_item-vtweg
          ls_item-werks_ref
          ls_item-vkorg_ref
          ls_item-vtweg_ref
          ls_item-dwerk
          ls_item-ekgrp.

    CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
      EXPORTING
        input        = ls_item-matnr
      IMPORTING
        output       = ls_item-matnr
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.

    CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
      EXPORTING
        input        = ls_item-matnr_ref
      IMPORTING
        output       = ls_item-matnr_ref
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.

    APPEND ls_item TO gt_item_list.
  ENDLOOP.
ENDFORM.                    " get_item_list
*&---------------------------------------------------------------------*
*&      Form  create_material
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM create_material .
  DATA: ls_item  TYPE ty_item,
        lv_msg   TYPE char100,
        ls_get_mara  TYPE bapi_mara_ga,
        ls_get_marc  TYPE bapi_marc_ga,
        ls_get_mpop  TYPE bapi_mpop_ga,
        ls_get_mpgd  TYPE bapi_mpgd_ga,
        ls_get_mard  TYPE bapi_mard_ga,
        ls_get_mbew  TYPE bapi_mbew_ga,
        ls_get_mlgn  TYPE bapi_mlgn_ga,
        ls_get_mvke  TYPE bapi_mvke_ga,
        ls_get_mlgt  TYPE bapi_mlgt_ga,
        lt_get_makt  TYPE STANDARD TABLE OF bapi_makt_ga,
        ls_get_makt  TYPE bapi_makt_ga,
        lt_get_marm  TYPE STANDARD TABLE OF bapi_marm_ga,
        ls_get_marm  TYPE bapi_marm_ga,
        lt_get_mean  TYPE STANDARD TABLE OF bapi_mean_ga,
        ls_get_mean  TYPE bapi_mean_ga,
        lt_get_mltx  TYPE STANDARD TABLE OF bapi_mltx_ga,
        ls_get_mltx  TYPE bapi_mltx_ga,
        lt_get_mlan  TYPE STANDARD TABLE OF bapi_mlan_ga,
        ls_get_mlan  TYPE bapi_mlan_ga,
        ls_set_mara  TYPE bapi_mara,
        ls_set_marax TYPE bapi_marax,
        ls_set_marc  TYPE bapi_marc,
        ls_set_marcx TYPE bapi_marcx,
        ls_set_mbew  TYPE bapi_mbew,
        ls_set_mbewx TYPE bapi_mbewx,
        ls_set_mvke  TYPE bapi_mvke,
        ls_set_mvkex TYPE bapi_mvkex,
        lt_set_makt  TYPE STANDARD TABLE OF bapi_makt,
        ls_set_makt  TYPE bapi_makt,
        lt_set_marm  TYPE STANDARD TABLE OF bapi_marm,
        ls_set_marm  TYPE bapi_marm,
        lt_set_marmx TYPE STANDARD TABLE OF bapi_marmx,
        ls_set_marmx TYPE bapi_marmx,
        lt_set_mean  TYPE STANDARD TABLE OF bapi_mean,
        ls_set_mean  TYPE bapi_mean,
        lt_set_mltx  TYPE STANDARD TABLE OF bapi_mltx,
        ls_set_mltx  TYPE bapi_mean,
        lt_set_mlan  TYPE STANDARD TABLE OF bapi_mlan,
        ls_set_mlan  TYPE bapi_mlan,
        ls_ret       TYPE bapiret2,
        lt_ret2      TYPE STANDARD TABLE OF bapi_matreturn2,
        ls_ret2      TYPE bapi_matreturn2,
        lt_get_extension TYPE STANDARD TABLE OF bapiparex,
        lt_get_return    TYPE STANDARD TABLE OF bapireturn,
        ls_headdata  TYPE bapimathead.
  DATA:
    lt_down TYPE STANDARD TABLE OF ty_item,
    lv_len    TYPE i,
    lv_path   TYPE string,
    lt_string TYPE stringtab,
    ls_string LIKE LINE OF lt_string.

  LOOP AT gt_item_list INTO ls_item.
    CALL FUNCTION 'BAPI_MATERIAL_GETALL'
      EXPORTING
        material                         = ls_item-matnr_ref
        plant                            = ls_item-werks_ref
        salesorganisation                = ls_item-vkorg_ref
        distributionchannel              = ls_item-vtweg_ref
      IMPORTING
        clientdata                       = ls_get_mara
        plantdata                        = ls_get_marc
*       forecastparameters               = ls_get_mpop
*       planningdata                     = ls_get_mpgd
*       storagelocationdata              = ls_get_mard
        valuationdata                    = ls_get_mbew
*       warehousenumberdata              = ls_get_mlgn
        salesdata                        = ls_get_mvke
*       storagetypedata                  = ls_get_mlgt
      TABLES
        materialdescription              = lt_get_makt
        unitsofmeasure                   = lt_get_marm
        internationarticlenumbers        = lt_get_mean
        materialtext                     = lt_get_mltx
        taxclassifications               = lt_get_mlan
*       extensionout                     = lt_get_extension
        return                           = lt_get_return
              .

    ls_headdata-material        = ls_item-matnr.
    ls_headdata-ind_sector      = 'M'.
    ls_headdata-matl_type       = 'ZMAT'.
    ls_headdata-basic_view      = 'X'.
    ls_headdata-sales_view      = 'X'.
    ls_headdata-purchase_view   = 'X'.
    ls_headdata-mrp_view        = 'X'.
*    ls_headdata-forecast_view   = 'X'.
*    ls_headdata-work_sched_view = 'X'.
*    ls_headdata-storage_view    = 'X'.
*    ls_headdata-warehouse_view  = 'X'.
    ls_headdata-quality_view    = 'X'.
    ls_headdata-account_view    = 'X'.
    ls_headdata-cost_view       = 'X'.

*   Set MARA
    MOVE-CORRESPONDING ls_get_mara TO ls_set_mara.
    PERFORM set_allx:
      USING ls_set_mara-del_flag                       CHANGING ls_set_marax-del_flag,
      USING ls_set_mara-matl_group                     CHANGING ls_set_marax-matl_group,
      USING ls_set_mara-old_mat_no                     CHANGING ls_set_marax-old_mat_no,
      USING ls_set_mara-base_uom                       CHANGING ls_set_marax-base_uom,
      USING ls_set_mara-base_uom_iso                   CHANGING ls_set_marax-base_uom_iso,
      USING ls_set_mara-po_unit                        CHANGING ls_set_marax-po_unit,
      USING ls_set_mara-po_unit_iso                    CHANGING ls_set_marax-po_unit_iso,
      USING ls_set_mara-document                       CHANGING ls_set_marax-document,
      USING ls_set_mara-doc_type                       CHANGING ls_set_marax-doc_type,
      USING ls_set_mara-doc_vers                       CHANGING ls_set_marax-doc_vers,
      USING ls_set_mara-doc_format                     CHANGING ls_set_marax-doc_format,
      USING ls_set_mara-doc_chg_no                     CHANGING ls_set_marax-doc_chg_no,
      USING ls_set_mara-page_no                        CHANGING ls_set_marax-page_no,
      USING ls_set_mara-no_sheets                      CHANGING ls_set_marax-no_sheets,
      USING ls_set_mara-prod_memo                      CHANGING ls_set_marax-prod_memo,
      USING ls_set_mara-pageformat                     CHANGING ls_set_marax-pageformat,
      USING ls_set_mara-size_dim                       CHANGING ls_set_marax-size_dim,
      USING ls_set_mara-basic_matl                     CHANGING ls_set_marax-basic_matl,
      USING ls_set_mara-std_descr                      CHANGING ls_set_marax-std_descr,
      USING ls_set_mara-dsn_office                     CHANGING ls_set_marax-dsn_office,
      USING ls_set_mara-pur_valkey                     CHANGING ls_set_marax-pur_valkey,
      USING ls_set_mara-net_weight                     CHANGING ls_set_marax-net_weight,
      USING ls_set_mara-unit_of_wt                     CHANGING ls_set_marax-unit_of_wt,
      USING ls_set_mara-unit_of_wt_iso                 CHANGING ls_set_marax-unit_of_wt_iso,
      USING ls_set_mara-container                      CHANGING ls_set_marax-container,
      USING ls_set_mara-stor_conds                     CHANGING ls_set_marax-stor_conds,
      USING ls_set_mara-temp_conds                     CHANGING ls_set_marax-temp_conds,
      USING ls_set_mara-trans_grp                      CHANGING ls_set_marax-trans_grp,
      USING ls_set_mara-haz_mat_no                     CHANGING ls_set_marax-haz_mat_no,
      USING ls_set_mara-division                       CHANGING ls_set_marax-division,
      USING ls_set_mara-competitor                     CHANGING ls_set_marax-competitor,
      USING ls_set_mara-qty_gr_gi                      CHANGING ls_set_marax-qty_gr_gi,
      USING ls_set_mara-proc_rule                      CHANGING ls_set_marax-proc_rule,
      USING ls_set_mara-sup_source                     CHANGING ls_set_marax-sup_source,
      USING ls_set_mara-season                         CHANGING ls_set_marax-season,
      USING ls_set_mara-label_type                     CHANGING ls_set_marax-label_type,
      USING ls_set_mara-label_form                     CHANGING ls_set_marax-label_form,
      USING ls_set_mara-prod_hier                      CHANGING ls_set_marax-prod_hier,
      USING ls_set_mara-cad_id                         CHANGING ls_set_marax-cad_id,
      USING ls_set_mara-allowed_wt                     CHANGING ls_set_marax-allowed_wt,
      USING ls_set_mara-pack_wt_un                     CHANGING ls_set_marax-pack_wt_un,
      USING ls_set_mara-pack_wt_un_iso                 CHANGING ls_set_marax-pack_wt_un_iso,
      USING ls_set_mara-allwd_vol                      CHANGING ls_set_marax-allwd_vol,
      USING ls_set_mara-pack_vo_un                     CHANGING ls_set_marax-pack_vo_un,
      USING ls_set_mara-pack_vo_un_iso                 CHANGING ls_set_marax-pack_vo_un_iso,
      USING ls_set_mara-wt_tol_lt                      CHANGING ls_set_marax-wt_tol_lt,
      USING ls_set_mara-vol_tol_lt                     CHANGING ls_set_marax-vol_tol_lt,
      USING ls_set_mara-var_ord_un                     CHANGING ls_set_marax-var_ord_un,
      USING ls_set_mara-batch_mgmt                     CHANGING ls_set_marax-batch_mgmt,
      USING ls_set_mara-sh_mat_typ                     CHANGING ls_set_marax-sh_mat_typ,
      USING ls_set_mara-fill_level                     CHANGING ls_set_marax-fill_level,
      USING ls_set_mara-stack_fact                     CHANGING ls_set_marax-stack_fact,
      USING ls_set_mara-mat_grp_sm                     CHANGING ls_set_marax-mat_grp_sm,
      USING ls_set_mara-authoritygroup                 CHANGING ls_set_marax-authoritygroup,
      USING ls_set_mara-qm_procmnt                     CHANGING ls_set_marax-qm_procmnt,
      USING ls_set_mara-catprofile                     CHANGING ls_set_marax-catprofile,
      USING ls_set_mara-minremlife                     CHANGING ls_set_marax-minremlife,
      USING ls_set_mara-shelf_life                     CHANGING ls_set_marax-shelf_life,
      USING ls_set_mara-stor_pct                       CHANGING ls_set_marax-stor_pct,
      USING ls_set_mara-pur_status                     CHANGING ls_set_marax-pur_status,
      USING ls_set_mara-sal_status                     CHANGING ls_set_marax-sal_status,
      USING ls_set_mara-pvalidfrom                     CHANGING ls_set_marax-pvalidfrom,
      USING ls_set_mara-svalidfrom                     CHANGING ls_set_marax-svalidfrom,
      USING ls_set_mara-envt_rlvt                      CHANGING ls_set_marax-envt_rlvt,
      USING ls_set_mara-prod_alloc                     CHANGING ls_set_marax-prod_alloc,
      USING ls_set_mara-qual_dik                       CHANGING ls_set_marax-qual_dik,
      USING ls_set_mara-manu_mat                       CHANGING ls_set_marax-manu_mat,
      USING ls_set_mara-mfr_no                         CHANGING ls_set_marax-mfr_no,
      USING ls_set_mara-inv_mat_no                     CHANGING ls_set_marax-inv_mat_no,
      USING ls_set_mara-manuf_prof                     CHANGING ls_set_marax-manuf_prof,
      USING ls_set_mara-hazmatprof                     CHANGING ls_set_marax-hazmatprof,
      USING ls_set_mara-high_visc                      CHANGING ls_set_marax-high_visc,
      USING ls_set_mara-looseorliq                     CHANGING ls_set_marax-looseorliq,
      USING ls_set_mara-closed_box                     CHANGING ls_set_marax-closed_box,
      USING ls_set_mara-appd_b_rec                     CHANGING ls_set_marax-appd_b_rec,
      USING ls_set_mara-matcmpllvl                     CHANGING ls_set_marax-matcmpllvl,
      USING ls_set_mara-par_eff                        CHANGING ls_set_marax-par_eff,
      USING ls_set_mara-round_up_rule_expiration_date  CHANGING ls_set_marax-round_up_rule_expiration_date,
      USING ls_set_mara-period_ind_expiration_date     CHANGING ls_set_marax-period_ind_expiration_date,
      USING ls_set_mara-prod_composition_on_packaging  CHANGING ls_set_marax-prod_composition_on_packaging,
      USING ls_set_mara-item_cat                       CHANGING ls_set_marax-item_cat,
      USING ls_set_mara-haz_mat_no_external            CHANGING ls_set_marax-haz_mat_no_external,
      USING ls_set_mara-haz_mat_no_guid                CHANGING ls_set_marax-haz_mat_no_guid,
      USING ls_set_mara-haz_mat_no_version             CHANGING ls_set_marax-haz_mat_no_version,
      USING ls_set_mara-inv_mat_no_external            CHANGING ls_set_marax-inv_mat_no_external,
      USING ls_set_mara-inv_mat_no_guid                CHANGING ls_set_marax-inv_mat_no_guid,
      USING ls_set_mara-inv_mat_no_version             CHANGING ls_set_marax-inv_mat_no_version,
      USING ls_set_mara-material_fixed                 CHANGING ls_set_marax-material_fixed,
      USING ls_set_mara-cm_relevance_flag              CHANGING ls_set_marax-cm_relevance_flag,
      USING ls_set_mara-sled_bbd                       CHANGING ls_set_marax-sled_bbd,
      USING ls_set_mara-gtin_variant                   CHANGING ls_set_marax-gtin_variant,
      USING ls_set_mara-serialization_level            CHANGING ls_set_marax-serialization_level,
      USING ls_set_mara-pl_ref_mat                     CHANGING ls_set_marax-pl_ref_mat,
      USING ls_set_mara-extmatlgrp                     CHANGING ls_set_marax-extmatlgrp,
      USING ls_set_mara-uomusage                       CHANGING ls_set_marax-uomusage,
      USING ls_set_mara-gds_relevant                   CHANGING ls_set_marax-gds_relevant,
      USING ls_set_mara-pl_ref_mat_external            CHANGING ls_set_marax-pl_ref_mat_external,
      USING ls_set_mara-pl_ref_mat_guid                CHANGING ls_set_marax-pl_ref_mat_guid,
      USING ls_set_mara-pl_ref_mat_version             CHANGING ls_set_marax-pl_ref_mat_version,
      USING ls_set_mara-we_origin_acceptance           CHANGING ls_set_marax-we_origin_acceptance,
      USING ls_set_mara-std_hu_type                    CHANGING ls_set_marax-std_hu_type,
      USING ls_set_mara-pilferable                     CHANGING ls_set_marax-pilferable,
      USING ls_set_mara-whse_storage_condition         CHANGING ls_set_marax-whse_storage_condition,
      USING ls_set_mara-whse_material_group            CHANGING ls_set_marax-whse_material_group,
      USING ls_set_mara-handling_indicator             CHANGING ls_set_marax-handling_indicator,
      USING ls_set_mara-haz_mat_relevant               CHANGING ls_set_marax-haz_mat_relevant,
      USING ls_set_mara-hu_type                        CHANGING ls_set_marax-hu_type,
      USING ls_set_mara-variable_tare_weight           CHANGING ls_set_marax-variable_tare_weight,
      USING ls_set_mara-max_allowed_capacity           CHANGING ls_set_marax-max_allowed_capacity,
      USING ls_set_mara-overcapacity_tolerance         CHANGING ls_set_marax-overcapacity_tolerance,
      USING ls_set_mara-max_allowed_length             CHANGING ls_set_marax-max_allowed_length,
      USING ls_set_mara-max_allowed_width              CHANGING ls_set_marax-max_allowed_width,
      USING ls_set_mara-max_allowed_heigth             CHANGING ls_set_marax-max_allowed_heigth,
      USING ls_set_mara-max_dimension_un               CHANGING ls_set_marax-max_dimension_un,
      USING ls_set_mara-max_dimension_un_iso           CHANGING ls_set_marax-max_dimension_un_iso,
      USING ls_set_mara-countryori                     CHANGING ls_set_marax-countryori,
      USING ls_set_mara-countryori_iso                 CHANGING ls_set_marax-countryori_iso,
      USING ls_set_mara-matfrgtgrp                     CHANGING ls_set_marax-matfrgtgrp,
      USING ls_set_mara-quarantine_period              CHANGING ls_set_marax-quarantine_period,
      USING ls_set_mara-quarantine_period_un           CHANGING ls_set_marax-quarantine_period_un,
      USING ls_set_mara-quarantine_period_un_iso       CHANGING ls_set_marax-quarantine_period_un_iso,
      USING ls_set_mara-quality_insp_grp               CHANGING ls_set_marax-quality_insp_grp,
      USING ls_set_mara-serial_number_profile          CHANGING ls_set_marax-serial_number_profile,
      USING ls_set_mara-ewm_cw_tolerance_group         CHANGING ls_set_marax-ewm_cw_tolerance_group,
      USING ls_set_mara-ewm_cw_input_control           CHANGING ls_set_marax-ewm_cw_input_control,
      USING ls_set_mara-pckging_smartform              CHANGING ls_set_marax-pckging_smartform,
      USING ls_set_mara-pacod                          CHANGING ls_set_marax-pacod,
      USING ls_set_mara-dg_pckging_status              CHANGING ls_set_marax-dg_pckging_status,
      USING ls_set_mara-adjust_profile                 CHANGING ls_set_marax-adjust_profile.

*   Set MARC
    IF ls_get_marc IS NOT INITIAL.
      MOVE-CORRESPONDING ls_get_marc TO ls_set_marc.
      ls_set_marc-PUR_GROUP = ls_item-ekgrp.

      ls_set_marcx-plant = ls_set_marc-plant.
      PERFORM set_allx:
        USING ls_set_marc-del_flag                     CHANGING ls_set_marcx-del_flag,
        USING ls_set_marc-abc_id                       CHANGING ls_set_marcx-abc_id,
        USING ls_set_marc-crit_part                    CHANGING ls_set_marcx-crit_part,
        USING ls_set_marc-pur_group                    CHANGING ls_set_marcx-pur_group,
        USING ls_set_marc-issue_unit                   CHANGING ls_set_marcx-issue_unit,
        USING ls_set_marc-issue_unit_iso               CHANGING ls_set_marcx-issue_unit_iso,
        USING ls_set_marc-mrpprofile                   CHANGING ls_set_marcx-mrpprofile,
        USING ls_set_marc-mrp_type                     CHANGING ls_set_marcx-mrp_type,
        USING ls_set_marc-mrp_ctrler                   CHANGING ls_set_marcx-mrp_ctrler,
        USING ls_set_marc-plnd_delry                   CHANGING ls_set_marcx-plnd_delry,
        USING ls_set_marc-gr_pr_time                   CHANGING ls_set_marcx-gr_pr_time,
        USING ls_set_marc-period_ind                   CHANGING ls_set_marcx-period_ind,
        USING ls_set_marc-assy_scrap                   CHANGING ls_set_marcx-assy_scrap,
        USING ls_set_marc-lotsizekey                   CHANGING ls_set_marcx-lotsizekey,
        USING ls_set_marc-proc_type                    CHANGING ls_set_marcx-proc_type,
        USING ls_set_marc-spproctype                   CHANGING ls_set_marcx-spproctype,
        USING ls_set_marc-reorder_pt                   CHANGING ls_set_marcx-reorder_pt,
        USING ls_set_marc-safety_stk                   CHANGING ls_set_marcx-safety_stk,
        USING ls_set_marc-minlotsize                   CHANGING ls_set_marcx-minlotsize,
        USING ls_set_marc-maxlotsize                   CHANGING ls_set_marcx-maxlotsize,
        USING ls_set_marc-fixed_lot                    CHANGING ls_set_marcx-fixed_lot,
        USING ls_set_marc-round_val                    CHANGING ls_set_marcx-round_val,
        USING ls_set_marc-max_stock                    CHANGING ls_set_marcx-max_stock,
        USING ls_set_marc-ord_costs                    CHANGING ls_set_marcx-ord_costs,
        USING ls_set_marc-dep_req_id                   CHANGING ls_set_marcx-dep_req_id,
        USING ls_set_marc-stor_costs                   CHANGING ls_set_marcx-stor_costs,
        USING ls_set_marc-alt_bom_id                   CHANGING ls_set_marcx-alt_bom_id,
        USING ls_set_marc-discontinu                   CHANGING ls_set_marcx-discontinu,
        USING ls_set_marc-eff_o_day                    CHANGING ls_set_marcx-eff_o_day,
        USING ls_set_marc-follow_up                    CHANGING ls_set_marcx-follow_up,
        USING ls_set_marc-grp_reqmts                   CHANGING ls_set_marcx-grp_reqmts,
        USING ls_set_marc-mixed_mrp                    CHANGING ls_set_marcx-mixed_mrp,
        USING ls_set_marc-sm_key                       CHANGING ls_set_marcx-sm_key,
        USING ls_set_marc-backflush                    CHANGING ls_set_marcx-backflush,
        USING ls_set_marc-production_scheduler         CHANGING ls_set_marcx-production_scheduler,
        USING ls_set_marc-proc_time                    CHANGING ls_set_marcx-proc_time,
        USING ls_set_marc-setuptime                    CHANGING ls_set_marcx-setuptime,
        USING ls_set_marc-interop                      CHANGING ls_set_marcx-interop,
        USING ls_set_marc-base_qty                     CHANGING ls_set_marcx-base_qty,
        USING ls_set_marc-inhseprodt                   CHANGING ls_set_marcx-inhseprodt,
        USING ls_set_marc-stgeperiod                   CHANGING ls_set_marcx-stgeperiod,
        USING ls_set_marc-stge_pd_un                   CHANGING ls_set_marcx-stge_pd_un,
        USING ls_set_marc-stge_pd_un_iso               CHANGING ls_set_marcx-stge_pd_un_iso,
        USING ls_set_marc-over_tol                     CHANGING ls_set_marcx-over_tol,
        USING ls_set_marc-unlimited                    CHANGING ls_set_marcx-unlimited,
        USING ls_set_marc-under_tol                    CHANGING ls_set_marcx-under_tol,
        USING ls_set_marc-replentime                   CHANGING ls_set_marcx-replentime,
        USING ls_set_marc-replace_pt                   CHANGING ls_set_marcx-replace_pt,
        USING ls_set_marc-ind_post_to_insp_stock       CHANGING ls_set_marcx-ind_post_to_insp_stock,
        USING ls_set_marc-ctrl_key                     CHANGING ls_set_marcx-ctrl_key,
        USING ls_set_marc-doc_reqd                     CHANGING ls_set_marcx-doc_reqd,
        USING ls_set_marc-loadinggrp                   CHANGING ls_set_marcx-loadinggrp,
        USING ls_set_marc-batch_mgmt                   CHANGING ls_set_marcx-batch_mgmt,
        USING ls_set_marc-quotausage                   CHANGING ls_set_marcx-quotausage,
        USING ls_set_marc-serv_level                   CHANGING ls_set_marcx-serv_level,
        USING ls_set_marc-split_ind                    CHANGING ls_set_marcx-split_ind,
        USING ls_set_marc-availcheck                   CHANGING ls_set_marcx-availcheck,
        USING ls_set_marc-fy_variant                   CHANGING ls_set_marcx-fy_variant,
        USING ls_set_marc-corr_fact                    CHANGING ls_set_marcx-corr_fact,
        USING ls_set_marc-setup_time                   CHANGING ls_set_marcx-setup_time,
        USING ls_set_marc-base_qty_plan                CHANGING ls_set_marcx-base_qty_plan,
        USING ls_set_marc-ship_proc_time               CHANGING ls_set_marcx-ship_proc_time,
        USING ls_set_marc-sup_source                   CHANGING ls_set_marcx-sup_source,
        USING ls_set_marc-auto_p_ord                   CHANGING ls_set_marcx-auto_p_ord,
        USING ls_set_marc-sourcelist                   CHANGING ls_set_marcx-sourcelist,
        USING ls_set_marc-comm_code                    CHANGING ls_set_marcx-comm_code,
        USING ls_set_marc-countryori                   CHANGING ls_set_marcx-countryori,
        USING ls_set_marc-countryori_iso               CHANGING ls_set_marcx-countryori_iso,
        USING ls_set_marc-regionorig                   CHANGING ls_set_marcx-regionorig,
        USING ls_set_marc-comm_co_un                   CHANGING ls_set_marcx-comm_co_un,
        USING ls_set_marc-comm_co_un_iso               CHANGING ls_set_marcx-comm_co_un_iso,
        USING ls_set_marc-expimpgrp                    CHANGING ls_set_marcx-expimpgrp,
        USING ls_set_marc-profit_ctr                   CHANGING ls_set_marcx-profit_ctr,
        USING ls_set_marc-ppc_pl_cal                   CHANGING ls_set_marcx-ppc_pl_cal,
        USING ls_set_marc-rep_manuf                    CHANGING ls_set_marcx-rep_manuf,
        USING ls_set_marc-pl_ti_fnce                   CHANGING ls_set_marcx-pl_ti_fnce,
        USING ls_set_marc-consummode                   CHANGING ls_set_marcx-consummode,
        USING ls_set_marc-bwd_cons                     CHANGING ls_set_marcx-bwd_cons,
        USING ls_set_marc-fwd_cons                     CHANGING ls_set_marcx-fwd_cons,
        USING ls_set_marc-alternative_bom              CHANGING ls_set_marcx-alternative_bom,
        USING ls_set_marc-bom_usage                    CHANGING ls_set_marcx-bom_usage,
        USING ls_set_marc-planlistgrp                  CHANGING ls_set_marcx-planlistgrp,
        USING ls_set_marc-planlistcnt                  CHANGING ls_set_marcx-planlistcnt,
        USING ls_set_marc-lot_size                     CHANGING ls_set_marcx-lot_size,
        USING ls_set_marc-specprocty                   CHANGING ls_set_marcx-specprocty,
        USING ls_set_marc-prod_unit                    CHANGING ls_set_marcx-prod_unit,
        USING ls_set_marc-prod_unit_iso                CHANGING ls_set_marcx-prod_unit_iso,
        USING ls_set_marc-iss_st_loc                   CHANGING ls_set_marcx-iss_st_loc,
        USING ls_set_marc-mrp_group                    CHANGING ls_set_marcx-mrp_group,
        USING ls_set_marc-comp_scrap                   CHANGING ls_set_marcx-comp_scrap,
        USING ls_set_marc-cert_type                    CHANGING ls_set_marcx-cert_type,
        USING ls_set_marc-cycle_time                   CHANGING ls_set_marcx-cycle_time,
        USING ls_set_marc-covprofile                   CHANGING ls_set_marcx-covprofile,
        USING ls_set_marc-cc_ph_inv                    CHANGING ls_set_marcx-cc_ph_inv,
        USING ls_set_marc-variance_key                 CHANGING ls_set_marcx-variance_key,
        USING ls_set_marc-serno_prof                   CHANGING ls_set_marcx-serno_prof,
        USING ls_set_marc-repmanprof                   CHANGING ls_set_marcx-repmanprof,
        USING ls_set_marc-neg_stocks                   CHANGING ls_set_marcx-neg_stocks,
        USING ls_set_marc-qm_rgmts                     CHANGING ls_set_marcx-qm_rgmts,
        USING ls_set_marc-plng_cycle                   CHANGING ls_set_marcx-plng_cycle,
        USING ls_set_marc-round_prof                   CHANGING ls_set_marcx-round_prof,
        USING ls_set_marc-refmatcons                   CHANGING ls_set_marcx-refmatcons,
        USING ls_set_marc-d_to_ref_m                   CHANGING ls_set_marcx-d_to_ref_m,
        USING ls_set_marc-mult_ref_m                   CHANGING ls_set_marcx-mult_ref_m,
        USING ls_set_marc-auto_reset                   CHANGING ls_set_marcx-auto_reset,
        USING ls_set_marc-ex_cert_id                   CHANGING ls_set_marcx-ex_cert_id,
        USING ls_set_marc-ex_cert_no_new               CHANGING ls_set_marcx-ex_cert_no_new,
        USING ls_set_marc-ex_cert_dt                   CHANGING ls_set_marcx-ex_cert_dt,
        USING ls_set_marc-milit_id                     CHANGING ls_set_marcx-milit_id,
        USING ls_set_marc-insp_int                     CHANGING ls_set_marcx-insp_int,
        USING ls_set_marc-co_product                   CHANGING ls_set_marcx-co_product,
        USING ls_set_marc-plan_strgp                   CHANGING ls_set_marcx-plan_strgp,
        USING ls_set_marc-sloc_exprc                   CHANGING ls_set_marcx-sloc_exprc,
        USING ls_set_marc-bulk_mat                     CHANGING ls_set_marcx-bulk_mat,
        USING ls_set_marc-cc_fixed                     CHANGING ls_set_marcx-cc_fixed,
        USING ls_set_marc-determ_grp                   CHANGING ls_set_marcx-determ_grp,
        USING ls_set_marc-qm_authgrp                   CHANGING ls_set_marcx-qm_authgrp,
        USING ls_set_marc-task_list_type               CHANGING ls_set_marcx-task_list_type,
        USING ls_set_marc-pur_status                   CHANGING ls_set_marcx-pur_status,
        USING ls_set_marc-prodprof                     CHANGING ls_set_marcx-prodprof,
        USING ls_set_marc-safty_t_id                   CHANGING ls_set_marcx-safty_t_id,
        USING ls_set_marc-safetytime                   CHANGING ls_set_marcx-safetytime,
        USING ls_set_marc-plord_ctrl                   CHANGING ls_set_marcx-plord_ctrl,
        USING ls_set_marc-batchentry                   CHANGING ls_set_marcx-batchentry,
        USING ls_set_marc-pvalidfrom                   CHANGING ls_set_marcx-pvalidfrom,
        USING ls_set_marc-matfrgtgrp                   CHANGING ls_set_marcx-matfrgtgrp,
        USING ls_set_marc-prodverscs                   CHANGING ls_set_marcx-prodverscs,
        USING ls_set_marc-mat_cfop                     CHANGING ls_set_marcx-mat_cfop,
        USING ls_set_marc-eu_list_no                   CHANGING ls_set_marcx-eu_list_no,
        USING ls_set_marc-eu_mat_grp                   CHANGING ls_set_marcx-eu_mat_grp,
        USING ls_set_marc-cas_no                       CHANGING ls_set_marcx-cas_no,
        USING ls_set_marc-prodcom_no                   CHANGING ls_set_marcx-prodcom_no,
        USING ls_set_marc-ctrl_code                    CHANGING ls_set_marcx-ctrl_code,
        USING ls_set_marc-jit_relvt                    CHANGING ls_set_marcx-jit_relvt,
        USING ls_set_marc-mat_grp_trans                CHANGING ls_set_marcx-mat_grp_trans,
        USING ls_set_marc-handlg_grp                   CHANGING ls_set_marcx-handlg_grp,
        USING ls_set_marc-supply_area                  CHANGING ls_set_marcx-supply_area,
        USING ls_set_marc-fair_share_rule              CHANGING ls_set_marcx-fair_share_rule,
        USING ls_set_marc-push_distrib                 CHANGING ls_set_marcx-push_distrib,
        USING ls_set_marc-deploy_horiz                 CHANGING ls_set_marcx-deploy_horiz,
        USING ls_set_marc-min_lot_size                 CHANGING ls_set_marcx-min_lot_size,
        USING ls_set_marc-max_lot_size                 CHANGING ls_set_marcx-max_lot_size,
        USING ls_set_marc-fix_lot_size                 CHANGING ls_set_marcx-fix_lot_size,
        USING ls_set_marc-lot_increment                CHANGING ls_set_marcx-lot_increment,
        USING ls_set_marc-prod_conv_type               CHANGING ls_set_marcx-prod_conv_type,
        USING ls_set_marc-distr_prof                   CHANGING ls_set_marcx-distr_prof,
        USING ls_set_marc-period_profile_safety_time   CHANGING ls_set_marcx-period_profile_safety_time,
        USING ls_set_marc-fxd_price                    CHANGING ls_set_marcx-fxd_price,
        USING ls_set_marc-avail_check_all_proj_segments  CHANGING ls_set_marcx-avail_check_all_proj_segments,
        USING ls_set_marc-overallprf                   CHANGING ls_set_marcx-overallprf,
        USING ls_set_marc-mrp_relevancy_dep_requirements CHANGING ls_set_marcx-mrp_relevancy_dep_requirements,
        USING ls_set_marc-min_safety_stk               CHANGING ls_set_marcx-min_safety_stk,
        USING ls_set_marc-no_costing                   CHANGING ls_set_marcx-no_costing,
        USING ls_set_marc-unit_group                   CHANGING ls_set_marcx-unit_group,
        USING ls_set_marc-follow_up_external           CHANGING ls_set_marcx-follow_up_external,
        USING ls_set_marc-follow_up_guid               CHANGING ls_set_marcx-follow_up_guid,
        USING ls_set_marc-follow_up_version            CHANGING ls_set_marcx-follow_up_version,
        USING ls_set_marc-refmatcons_external          CHANGING ls_set_marcx-refmatcons_external,
        USING ls_set_marc-refmatcons_guid              CHANGING ls_set_marcx-refmatcons_guid,
        USING ls_set_marc-refmatcons_version           CHANGING ls_set_marcx-refmatcons_version,
        USING ls_set_marc-rotation_date                CHANGING ls_set_marcx-rotation_date,
        USING ls_set_marc-original_batch_flag          CHANGING ls_set_marcx-original_batch_flag,
        USING ls_set_marc-original_batch_ref_material  CHANGING ls_set_marcx-original_batch_ref_material,
        USING ls_set_marc-original_batch_ref_material_e  CHANGING ls_set_marcx-original_batch_ref_material_e,
        USING ls_set_marc-original_batch_ref_material_v  CHANGING ls_set_marcx-original_batch_ref_material_v,
        USING ls_set_marc-original_batch_ref_material_g  CHANGING ls_set_marcx-original_batch_ref_material_g,
        USING ls_set_marc-iuid_relevant                CHANGING ls_set_marcx-iuid_relevant,
        USING ls_set_marc-iuid_type                    CHANGING ls_set_marcx-iuid_type,
        USING ls_set_marc-uid_iea                      CHANGING ls_set_marcx-uid_iea.
    ENDIF.

*   Set MBEW
    IF ls_get_mbew IS NOT INITIAL.
      MOVE-CORRESPONDING ls_get_mbew TO ls_set_mbew.

      PERFORM set_allx:
        USING ls_set_mbew-val_area                     CHANGING ls_set_mbewx-val_area,
        USING ls_set_mbew-val_type                     CHANGING ls_set_mbewx-val_type,
        USING ls_set_mbew-del_flag                     CHANGING ls_set_mbewx-del_flag,
        USING ls_set_mbew-price_ctrl                   CHANGING ls_set_mbewx-price_ctrl,
        USING ls_set_mbew-moving_pr                    CHANGING ls_set_mbewx-moving_pr,
        USING ls_set_mbew-std_price                    CHANGING ls_set_mbewx-std_price,
        USING ls_set_mbew-price_unit                   CHANGING ls_set_mbewx-price_unit,
        USING ls_set_mbew-val_class                    CHANGING ls_set_mbewx-val_class,
        USING ls_set_mbew-pr_ctrl_pp                   CHANGING ls_set_mbewx-pr_ctrl_pp,
        USING ls_set_mbew-mov_pr_pp                    CHANGING ls_set_mbewx-mov_pr_pp,
        USING ls_set_mbew-std_pr_pp                    CHANGING ls_set_mbewx-std_pr_pp,
        USING ls_set_mbew-pr_unit_pp                   CHANGING ls_set_mbewx-pr_unit_pp,
        USING ls_set_mbew-vclass_pp                    CHANGING ls_set_mbewx-vclass_pp,
        USING ls_set_mbew-pr_ctrl_py                   CHANGING ls_set_mbewx-pr_ctrl_py,
        USING ls_set_mbew-mov_pr_py                    CHANGING ls_set_mbewx-mov_pr_py,
        USING ls_set_mbew-std_pr_py                    CHANGING ls_set_mbewx-std_pr_py,
        USING ls_set_mbew-vclass_py                    CHANGING ls_set_mbewx-vclass_py,
        USING ls_set_mbew-pr_unit_py                   CHANGING ls_set_mbewx-pr_unit_py,
        USING ls_set_mbew-val_cat                      CHANGING ls_set_mbewx-val_cat,
        USING ls_set_mbew-future_pr                    CHANGING ls_set_mbewx-future_pr,
        USING ls_set_mbew-valid_from                   CHANGING ls_set_mbewx-valid_from,
        USING ls_set_mbew-taxprice_1                   CHANGING ls_set_mbewx-taxprice_1,
        USING ls_set_mbew-commprice1                   CHANGING ls_set_mbewx-commprice1,
        USING ls_set_mbew-taxprice_3                   CHANGING ls_set_mbewx-taxprice_3,
        USING ls_set_mbew-commprice3                   CHANGING ls_set_mbewx-commprice3,
        USING ls_set_mbew-plnd_price                   CHANGING ls_set_mbewx-plnd_price,
        USING ls_set_mbew-plndprice1                   CHANGING ls_set_mbewx-plndprice1,
        USING ls_set_mbew-plndprice2                   CHANGING ls_set_mbewx-plndprice2,
        USING ls_set_mbew-plndprice3                   CHANGING ls_set_mbewx-plndprice3,
        USING ls_set_mbew-plndprdate1                  CHANGING ls_set_mbewx-plndprdate1,
        USING ls_set_mbew-plndprdate2                  CHANGING ls_set_mbewx-plndprdate2,
        USING ls_set_mbew-plndprdate3                  CHANGING ls_set_mbewx-plndprdate3,
        USING ls_set_mbew-lifo_fifo                    CHANGING ls_set_mbewx-lifo_fifo,
        USING ls_set_mbew-poolnumber                   CHANGING ls_set_mbewx-poolnumber,
        USING ls_set_mbew-taxprice_2                   CHANGING ls_set_mbewx-taxprice_2,
        USING ls_set_mbew-commprice2                   CHANGING ls_set_mbewx-commprice2,
        USING ls_set_mbew-deval_ind                    CHANGING ls_set_mbewx-deval_ind,
        USING ls_set_mbew-orig_group                   CHANGING ls_set_mbewx-orig_group,
        USING ls_set_mbew-overhead_grp                 CHANGING ls_set_mbewx-overhead_grp,
        USING ls_set_mbew-qty_struct                   CHANGING ls_set_mbewx-qty_struct,
        USING ls_set_mbew-ml_active                    CHANGING ls_set_mbewx-ml_active,
        USING ls_set_mbew-ml_settle                    CHANGING ls_set_mbewx-ml_settle,
        USING ls_set_mbew-orig_mat                     CHANGING ls_set_mbewx-orig_mat,
        USING ls_set_mbew-vm_so_stk                    CHANGING ls_set_mbewx-vm_so_stk,
        USING ls_set_mbew-vm_p_stock                   CHANGING ls_set_mbewx-vm_p_stock,
        USING ls_set_mbew-matl_usage                   CHANGING ls_set_mbewx-matl_usage,
        USING ls_set_mbew-mat_origin                   CHANGING ls_set_mbewx-mat_origin,
        USING ls_set_mbew-in_house                     CHANGING ls_set_mbewx-in_house,
        USING ls_set_mbew-tax_cml_un                   CHANGING ls_set_mbewx-tax_cml_un.
    ENDIF.

*   Set MVKE
    IF ls_get_mvke IS NOT INITIAL.
      MOVE-CORRESPONDING ls_get_mvke TO ls_set_mvke.
      ls_set_mvke-DELYG_PLNT = ls_item-dwerk.

      ls_set_mvkex-sales_org  = ls_set_mvke-sales_org.
      ls_set_mvkex-distr_chan = ls_set_mvke-distr_chan.
      PERFORM set_allx:
        USING ls_set_mvke-del_flag                     CHANGING ls_set_mvkex-del_flag,
        USING ls_set_mvke-matl_stats                   CHANGING ls_set_mvkex-matl_stats,
        USING ls_set_mvke-rebate_grp                   CHANGING ls_set_mvkex-rebate_grp,
        USING ls_set_mvke-comm_group                   CHANGING ls_set_mvkex-comm_group,
        USING ls_set_mvke-cash_disc                    CHANGING ls_set_mvkex-cash_disc,
        USING ls_set_mvke-sal_status                   CHANGING ls_set_mvkex-sal_status,
        USING ls_set_mvke-valid_from                   CHANGING ls_set_mvkex-valid_from,
        USING ls_set_mvke-min_order                    CHANGING ls_set_mvkex-min_order,
        USING ls_set_mvke-min_dely                     CHANGING ls_set_mvkex-min_dely,
        USING ls_set_mvke-min_mto                      CHANGING ls_set_mvkex-min_mto,
        USING ls_set_mvke-dely_unit                    CHANGING ls_set_mvkex-dely_unit,
        USING ls_set_mvke-dely_uom                     CHANGING ls_set_mvkex-dely_uom,
        USING ls_set_mvke-dely_uom_iso                 CHANGING ls_set_mvkex-dely_uom_iso,
        USING ls_set_mvke-sales_unit                   CHANGING ls_set_mvkex-sales_unit,
        USING ls_set_mvke-sales_unit_iso               CHANGING ls_set_mvkex-sales_unit_iso,
        USING ls_set_mvke-item_cat                     CHANGING ls_set_mvkex-item_cat,
        USING ls_set_mvke-delyg_plnt                   CHANGING ls_set_mvkex-delyg_plnt,
        USING ls_set_mvke-prod_hier                    CHANGING ls_set_mvkex-prod_hier,
        USING ls_set_mvke-pr_ref_mat                   CHANGING ls_set_mvkex-pr_ref_mat,
        USING ls_set_mvke-mat_pr_grp                   CHANGING ls_set_mvkex-mat_pr_grp,
        USING ls_set_mvke-acct_assgt                   CHANGING ls_set_mvkex-acct_assgt,
        USING ls_set_mvke-matl_grp_1                   CHANGING ls_set_mvkex-matl_grp_1,
        USING ls_set_mvke-matl_grp_2                   CHANGING ls_set_mvkex-matl_grp_2,
        USING ls_set_mvke-matl_grp_3                   CHANGING ls_set_mvkex-matl_grp_3,
        USING ls_set_mvke-matl_grp_4                   CHANGING ls_set_mvkex-matl_grp_4,
        USING ls_set_mvke-matl_grp_5                   CHANGING ls_set_mvkex-matl_grp_5,
        USING ls_set_mvke-prod_att_1                   CHANGING ls_set_mvkex-prod_att_1,
        USING ls_set_mvke-prod_att_2                   CHANGING ls_set_mvkex-prod_att_2,
        USING ls_set_mvke-prod_att_3                   CHANGING ls_set_mvkex-prod_att_3,
        USING ls_set_mvke-prod_att_4                   CHANGING ls_set_mvkex-prod_att_4,
        USING ls_set_mvke-prod_att_5                   CHANGING ls_set_mvkex-prod_att_5,
        USING ls_set_mvke-prod_att_6                   CHANGING ls_set_mvkex-prod_att_6,
        USING ls_set_mvke-prod_att_7                   CHANGING ls_set_mvkex-prod_att_7,
        USING ls_set_mvke-prod_att_8                   CHANGING ls_set_mvkex-prod_att_8,
        USING ls_set_mvke-prod_att_9                   CHANGING ls_set_mvkex-prod_att_9,
        USING ls_set_mvke-prod_att10                   CHANGING ls_set_mvkex-prod_att10,
        USING ls_set_mvke-round_prof                   CHANGING ls_set_mvkex-round_prof,
        USING ls_set_mvke-var_sales_un                 CHANGING ls_set_mvkex-var_sales_un,
        USING ls_set_mvke-unit_group                   CHANGING ls_set_mvkex-unit_group,
        USING ls_set_mvke-pr_ref_mat_external          CHANGING ls_set_mvkex-pr_ref_mat_external,
        USING ls_set_mvke-pr_ref_mat_guid              CHANGING ls_set_mvkex-pr_ref_mat_guid,
        USING ls_set_mvke-pr_ref_mat_version           CHANGING ls_set_mvkex-pr_ref_mat_version.
    ENDIF.

*   Set MAKT
    LOOP AT lt_get_makt INTO ls_get_makt.
      MOVE-CORRESPONDING ls_get_makt TO ls_set_makt.
      APPEND ls_set_makt TO lt_set_makt.
    ENDLOOP.

*   Set MARM
    LOOP AT lt_get_marm INTO ls_get_marm.
      MOVE-CORRESPONDING ls_get_marm TO ls_set_marm.
      APPEND ls_set_marm TO lt_set_marm.

      PERFORM set_allx:
        USING ls_set_marm-alt_unit                     CHANGING ls_set_marmx-alt_unit,
        USING ls_set_marm-alt_unit_iso                 CHANGING ls_set_marmx-alt_unit_iso,
        USING ls_set_marm-numerator                    CHANGING ls_set_marmx-numerator,
        USING ls_set_marm-denominatr                   CHANGING ls_set_marmx-denominatr,
        USING ls_set_marm-ean_upc                      CHANGING ls_set_marmx-ean_upc,
        USING ls_set_marm-ean_cat                      CHANGING ls_set_marmx-ean_cat,
        USING ls_set_marm-length                       CHANGING ls_set_marmx-length,
        USING ls_set_marm-width                        CHANGING ls_set_marmx-width,
        USING ls_set_marm-height                       CHANGING ls_set_marmx-height,
        USING ls_set_marm-unit_dim                     CHANGING ls_set_marmx-unit_dim,
        USING ls_set_marm-unit_dim_iso                 CHANGING ls_set_marmx-unit_dim_iso,
        USING ls_set_marm-volume                       CHANGING ls_set_marmx-volume,
        USING ls_set_marm-volumeunit                   CHANGING ls_set_marmx-volumeunit,
        USING ls_set_marm-volumeunit_iso               CHANGING ls_set_marmx-volumeunit_iso,
        USING ls_set_marm-gross_wt                     CHANGING ls_set_marmx-gross_wt,
        USING ls_set_marm-unit_of_wt                   CHANGING ls_set_marmx-unit_of_wt,
        USING ls_set_marm-unit_of_wt_iso               CHANGING ls_set_marmx-unit_of_wt_iso,
        USING ls_set_marm-sub_uom                      CHANGING ls_set_marmx-sub_uom,
        USING ls_set_marm-sub_uom_iso                  CHANGING ls_set_marmx-sub_uom_iso,
        USING ls_set_marm-gtin_variant                 CHANGING ls_set_marmx-gtin_variant,
        USING ls_set_marm-nesting_factor               CHANGING ls_set_marmx-nesting_factor,
        USING ls_set_marm-maximum_stacking             CHANGING ls_set_marmx-maximum_stacking,
        USING ls_set_marm-capacity_usage               CHANGING ls_set_marmx-capacity_usage,
        USING ls_set_marm-ewm_cw_uom_type              CHANGING ls_set_marmx-ewm_cw_uom_type.
      APPEND ls_set_marmx TO lt_set_marmx.
    ENDLOOP.

*   Set MEAN
    LOOP AT lt_get_mean INTO ls_get_mean.
      MOVE-CORRESPONDING ls_get_mean TO ls_set_mean.
      APPEND ls_set_mean TO lt_set_mean.
    ENDLOOP.

*   Set MLTX
    LOOP AT lt_get_mltx INTO ls_get_mltx.
      MOVE-CORRESPONDING ls_get_mltx TO ls_set_mltx.
      APPEND ls_set_mltx TO lt_set_mltx.
    ENDLOOP.

*   Set MLAN
    LOOP AT lt_get_mlan INTO ls_get_mlan.
      MOVE-CORRESPONDING ls_get_mlan TO ls_set_mlan.
      APPEND ls_set_mlan TO lt_set_mlan.
    ENDLOOP.

    CALL FUNCTION 'BAPI_MATERIAL_SAVEDATA'
      EXPORTING
        headdata                   = ls_headdata
        clientdata                 = ls_set_mara
        clientdatax                = ls_set_marax
        plantdata                  = ls_set_marc
        plantdatax                 = ls_set_marcx
*       FORECASTPARAMETERS         =
*       FORECASTPARAMETERSX        =
*       PLANNINGDATA               =
*       PLANNINGDATAX              =
*       STORAGELOCATIONDATA        =
*       STORAGELOCATIONDATAX       =
        valuationdata              = ls_set_mbew
        valuationdatax             = ls_set_mbewx
*       WAREHOUSENUMBERDATA        =
*       WAREHOUSENUMBERDATAX       =
        salesdata                  = ls_set_mvke
        salesdatax                 = ls_set_mvkex
*       STORAGETYPEDATA            =
*       STORAGETYPEDATAX           =
*       FLAG_ONLINE                = ' '
*       FLAG_CAD_CALL              = ' '
*       NO_DEQUEUE                 = ' '
*       NO_ROLLBACK_WORK           = ' '
      IMPORTING
        return                     = ls_ret
      TABLES
        materialdescription        = lt_set_makt
        unitsofmeasure             = lt_set_marm
        unitsofmeasurex            = lt_set_marmx
        internationalartnos        = lt_set_mean
        materiallongtext           = lt_set_mltx
        taxclassifications         = lt_set_mlan
        returnmessages             = lt_ret2
*       PRTDATA                    =
*       PRTDATAX                   =
*       EXTENSIONIN                =
*       EXTENSIONINX               =
              .

    MESSAGE ID ls_ret-ID
          TYPE ls_ret-TYPE
        NUMBER ls_ret-NUMBER
          WITH ls_ret-MESSAGE_V1
               ls_ret-MESSAGE_V2
               ls_ret-MESSAGE_V3
               ls_ret-MESSAGE_V4
          INTO lv_msg.

    WRITE:
      /001 ls_item-matnr,
       015 lv_msg.

    IF ls_ret-TYPE = 'E'.
      CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
      APPEND ls_item TO lt_down.
    ELSE.
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'.
    ENDIF.
  ENDLOOP.

  CHECK lt_down IS NOT INITIAL.

  lv_len = strlen( p_file ).
  lv_len = lv_len - 4.
  lv_path = p_file+0(lv_len).

  CONCATENATE lv_path
              '_err.txt'
         INTO lv_path.

  LOOP AT lt_down INTO ls_item.
    CONCATENATE ls_item-matnr
                ls_item-matnr_ref
                ls_item-werks
                ls_item-vkorg
                ls_item-vtweg
                ls_item-werks_ref
                ls_item-vkorg_ref
                ls_item-vtweg_ref
                ls_item-dwerk
                ls_item-ekgrp
           INTO ls_string
           SEPARATED BY con_tab.
    APPEND ls_string TO lt_string.
  ENDLOOP.

  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      filename                        = lv_path
    TABLES
      data_tab                        = lt_string
    EXCEPTIONS
      file_write_error                = 1
      no_batch                        = 2
      gui_refuse_filetransfer         = 3
      invalid_type                    = 4
      no_authority                    = 5
      unknown_error                   = 6
      header_not_allowed              = 7
      separator_not_allowed           = 8
      filesize_not_allowed            = 9
      header_too_long                 = 10
      dp_error_create                 = 11
      dp_error_send                   = 12
      dp_error_write                  = 13
      unknown_dp_error                = 14
      access_denied                   = 15
      dp_out_of_memory                = 16
      disk_full                       = 17
      dp_timeout                      = 18
      file_not_found                  = 19
      dataprovider_exception          = 20
      control_flush_error             = 21
      OTHERS                          = 22
            .
  IF sy-subrc <> 0.
     MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH SY-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " create_material
*&---------------------------------------------------------------------*
*&      Form  set_allx
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  field1        text
*  <--  field2        text
*----------------------------------------------------------------------*
FORM set_allx    USING    field1 TYPE any
                 CHANGING field2 TYPE any.
  IF field1 IS NOT INITIAL.
    field2 = 'X'.
  ENDIF.
ENDFORM.

*Text symbol text
*BK1:Header Information
*E00:Error opening dataset, return code:
*I01:Session name
*I02:Open session
*I03:Insert transaction
*I04:Close Session
*I05:Return code =
*I06:Error session created
*S01:Session name
*S02:User
*S03:Keep session
*S04:Lock date
*S05:Processing Mode
*S06:Update Mode
*S07:Generate session
*S08:Call transaction
*S09:Error sessn
*S10:Nodata indicator

*S11:Short log
*Selection text
*P_BSTKD:D       .
*P_FILE:        Upload file
*P_KUNNR1:D       .
*P_KUNNR2:D       .
*P_LINES:        Item lines
*P_SPART:D       .
*P_VKBUR:D       .
*P_VKGRP:D       .
*P_VKORG:D       .
*P_VTWEG:D       .
