*&---------------------------------------------------------------------*
*& Report  YSE_ACT_EQUIPMENT_DATA_EXTR
*&
*&---------------------------------------------------------------------*
*&                                                                     *
*& ACT! : Equipment Data extraction                                    *
*&                                                                     *
*&---------------------------------------------------------------------*
*  Author                : Jules Smets
*  Date                  : 28.08.2012
*  Change Request Number :
*  Transport request Nr. : CD1K973036
*----------------------------------------------------------------------*
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NR.|   DATE     | NAME            | CORRECTION NR.| CHANGE REF. *
*----------------------------------------------------------------------*
* MOD-001 | 19.03.2014 | Jules Smets     | CD1K980489    | CR1794 (Act)*
*----------------------------------------------------------------------*
* MOD-002 | 27.08.2014 | Jules Smets     | CD1K980489    |             *
*----------------------------------------------------------------------*

************************************************************************

REPORT  yse_act_equipment_data_extr.

TABLES: equi,
        equz,
        eqkt,
        eqbs,
        iloa,
        iflot,
        iflotx,
        bgmkobj,
        crhd,
*** MOD-002 * begin ***
        afih,
        aufk,
*** MOD-002 * end ***
        mara.


TYPES: BEGIN OF ty_dlfl,
         objnr      TYPE j_objnr,
      END OF ty_dlfl.

TYPES: BEGIN OF ty_bgmkobj,
         objnr      TYPE j_objnr,
         gaart      TYPE gaart,
         gwldt      TYPE gwldt,
         gwlen      TYPE gwlen,
         mganr      TYPE mganr,
       END OF ty_bgmkobj.

TYPES: BEGIN OF ty_crhd,
         objid      TYPE cr_objid,
         arbpl      TYPE arbpl,
       END OF ty_crhd.

TYPES: BEGIN OF ty_mara,
         matnr      TYPE matnr,
         bismt      TYPE bismt,
       END OF ty_mara.

*** MOD-002 * begin ***
TYPES: BEGIN OF ty_aufk,
         equnr      TYPE equnr,
         aufnr      TYPE aufnr,
         erdat      TYPE auferfdat,
       END OF ty_aufk.
*** MOD-002 * end ***

DATA: gt_dlfl  TYPE HASHED TABLE OF ty_dlfl
                    WITH UNIQUE KEY objnr
                    WITH HEADER LINE,
      gt_dlfli TYPE TABLE OF ty_dlfl
                    WITH HEADER LINE.

DATA: gt_eqbs TYPE HASHED TABLE OF eqbs
                   WITH UNIQUE KEY equnr
                   WITH HEADER LINE.

DATA: gt_bgmkobj  TYPE HASHED TABLE OF ty_bgmkobj
                       WITH UNIQUE KEY objnr gaart
                       WITH HEADER LINE,
      gt_bgmkobji TYPE TABLE OF ty_bgmkobj
                       WITH HEADER LINE.

DATA: gt_crhd  TYPE HASHED TABLE OF ty_crhd
                    WITH UNIQUE KEY objid
                    WITH HEADER LINE,
      gt_crhdi TYPE TABLE OF ty_crhd.

DATA: gt_mara  TYPE HASHED TABLE OF ty_mara
                    WITH UNIQUE KEY matnr
                    WITH HEADER LINE,
      gt_marai TYPE TABLE OF ty_mara.

*** MOD-002 * begin ***
DATA: gt_aufk  TYPE HASHED TABLE OF ty_aufk
                    WITH UNIQUE KEY equnr
                    WITH HEADER LINE,
      gt_aufki TYPE TABLE OF ty_aufk
                    WITH HEADER LINE.
*** MOD-002 * end ***

DATA: BEGIN OF gt_sel  OCCURS 0,
        eqtyp      TYPE eqtyp,
        equnr      TYPE equnr,
        datab      TYPE datab,
        eqktx      TYPE ktx01,
        eqart      TYPE eqart,
        brgew      TYPE obj_weight,
        groes      TYPE gross,
        invnr      TYPE invnr,
        inbdt      TYPE ilom_datab,
        answt      TYPE answt,
        ansdt      TYPE andti,
        waers      TYPE waers,
        herst      TYPE herst,
        herld      TYPE herld,
        typbz      TYPE typbz,
        baujj      TYPE baujj,
        baumm      TYPE baumm,
        mapar      TYPE mapar,
        serge      TYPE serge,
        swerk      TYPE swerk,
        stort      TYPE pmloc,
        msgrp      TYPE raumnr,
        beber      TYPE beber,
        ppsid      TYPE ppsid,
        abckz      TYPE abckz,
        eqfnr      TYPE eqfnr,
        bukrs      TYPE bukrs,
        anlnr      TYPE anln1,
        kostl      TYPE kostl,
        proid      TYPE ps_psp_pnr,
        daufn      TYPE daufn,
        aufnr      TYPE ilom_ordst,
        iwerk      TYPE iwerk,
        ingrp      TYPE ingrp,
        gewrk      TYPE lgwid,
        rbnr       TYPE rbnr,
        tplnr      TYPE tplnr,
        hequi      TYPE hequi,
        heqnr      TYPE heqnr,
        tidnr      TYPE tidnr,
        submt      TYPE submt,
        vkorg      TYPE vkorg,
        vtweg      TYPE vtweg,
        spart      TYPE spart,
        vkbur      TYPE vkbur,
        vkgrp      TYPE vkgrp,
        liznr      TYPE liznr,
        matnr      TYPE matnr,
        sernr      TYPE gernr,
        charge     TYPE charg_d,
        datlwb     TYPE datlwb,
        erdat      TYPE erdat,
        gewei      TYPE gewei,
        pltxt      TYPE pltxt,
        objnr_e    TYPE j_objnr,            "EQUI
        objnr_l    TYPE j_objnr,            "IFLOT
      END OF gt_sel.

DATA: BEGIN OF gt_out  OCCURS 0,
        eqtyp      TYPE eqtyp,              "Category
        tab01(1)   TYPE c,
        equnr      TYPE equnr,              "Equipment nr.
        tab02(1)   TYPE c,
        datab      TYPE datab,              "Valid on
        tab03(1)   TYPE c,
        eqktx      TYPE ktx01,              "Description
        tab04(1)   TYPE c,
        eqart      TYPE eqart,              "Type
        tab05(1)   TYPE c,
        brgew_c(17) TYPE c,                 "Gross Weight
        tab06(1)   TYPE c,
        groes      TYPE gross,              "Size/dimension
        tab07(1)   TYPE c,
        invnr      TYPE invnr,              "Inventory nr.
        tab08(1)   TYPE c,
        inbdt      TYPE ilom_datab,         "Start-up date
        tab09(1)   TYPE c,
        answt_c(17) TYPE c,                 "Acquisition value
        tab10(1)   TYPE c,
        ansdt      TYPE andti,              "Acquisition date
        tab11(1)   TYPE c,
        waers      TYPE waers,              "Currency
        tab12(1)   TYPE c,
        herst      TYPE herst,              "Manufacturer
        tab13(1)   TYPE c,
        herld      TYPE herld,              "Manufacturer country
        tab14(1)   TYPE c,
        typbz      TYPE typbz,              "Manufacturer model number
        tab15(1)   TYPE c,
        baujj      TYPE baujj,              "Construction year
        tab16(1)   TYPE c,
        baumm      TYPE baumm,              "Construction month
        tab17(1)   TYPE c,
        mapar      TYPE mapar,              "Manufacturer part number
        tab18(1)   TYPE c,
        serge      TYPE serge,              "Manufacturer serial number
        tab19(1)   TYPE c,
        swerk      TYPE swerk,              "Maintenance plant
        tab20(1)   TYPE c,
        stort      TYPE pmloc,              "Location
        tab21(1)   TYPE c,
        msgrp      TYPE raumnr,             "Room
        tab22(1)   TYPE c,
        beber      TYPE beber,              "Plant section
        tab23(1)   TYPE c,
        arbpl_l    TYPE arbpl,              "Work Center (location)
        tab24(1)   TYPE c,
        abckz      TYPE abckz,              "ABC indicator
        tab25(1)   TYPE c,
        eqfnr      TYPE eqfnr,              "Sort field
        tab26(1)   TYPE c,
        bukrs      TYPE bukrs,              "Company Code
        tab27(1)   TYPE c,
        anlnr      TYPE anln1,              "Asset number
        tab28(1)   TYPE c,
        kostl      TYPE kostl,              "Cost Center
        tab29(1)   TYPE c,
        proid      TYPE ps_psp_pnr,         "WBS element
        tab30(1)   TYPE c,
        daufn      TYPE daufn,              "Standing order
        tab31(1)   TYPE c,
        aufnr      TYPE ilom_ordst,         "Settlemznt order
        tab32(1)   TYPE c,
        iwerk      TYPE iwerk,              "(Maintenance) Planning Plant
        tab33(1)   TYPE c,
        ingrp      TYPE ingrp,              "Planner Group
        tab34(1)   TYPE c,
        arbpl_m    TYPE arbpl,              "Main Work Center
        tab35(1)   TYPE c,
        rbnr       TYPE rbnr,               "Catalog Profile
        tab36(1)   TYPE c,
        tplnr      TYPE tplnr,              "Functional Location
        tab37(1)   TYPE c,
        hequi      TYPE hequi,              "Superordinate Equipment
        tab38(1)   TYPE c,
        heqnr      TYPE heqnr,              "Equipment position
        tab39(1)   TYPE c,
        tidnr      TYPE tidnr,              "Technical identification nr
        tab40(1)   TYPE c,
        submt      TYPE submt,              "Construction type
        tab41(1)   TYPE c,
        gwldt_c    TYPE gwldt,              "Begin warranty date (Customer)
        tab42(1)   TYPE c,
        gwlen_c    TYPE gwlen,              "End warranty date (Customer)
        tab43(1)   TYPE c,
        mganr_c    TYPE mganr,              "Master warranty nr. (Customer)
        tab44(1)   TYPE c,
        gwldt_v    TYPE gwldt,              "Begin warranty date (Vendor)
        tab45(1)   TYPE c,
        gwlen_v    TYPE gwlen,              "End warranty date (Vendor)
        tab46(1)   TYPE c,
        mganr_v    TYPE mganr,              "Master warranty nr. (Vendor)
        tab47(1)   TYPE c,
        vkorg      TYPE vkorg,              "Sales Organization
        tab48(1)   TYPE c,
        vtweg      TYPE vtweg,              "Distribution channel
        tab49(1)   TYPE c,
        spart      TYPE spart,              "Division
        tab50(1)   TYPE c,
        vkbur      TYPE vkbur,              "Sales Office
        tab51(1)   TYPE c,
        vkgrp      TYPE vkgrp,              "Sales group
        tab52(1)   TYPE c,
        liznr      TYPE liznr,              "Equipment license nr
        tab53(1)   TYPE c,
        matnr(18)  TYPE c,                  "Material
        tab54(1)   TYPE c,
        sernr      TYPE gernr,              "Serial nr.
        tab55(1)   TYPE c,
        lbbsa      TYPE	lbbsa,              "Stock Type of Goods Movement
        tab56(1)   TYPE c,
        b_werk     TYPE	werks_d,            "Plant
        tab57(1)   TYPE c,
        b_lager    TYPE	lgort_d,            "Storage Location
        tab58(1)   TYPE c,
        bukrs1     TYPE bukrs,              "Company code
        tab59(1)   TYPE c,
        b_charge   TYPE	b_charge,           "Batch Number
        tab60(1)   TYPE c,
        charge     TYPE charg_d,            "Master Batch
        tab61(1)   TYPE c,
        sobkz      TYPE	sobkz,              "Special Stock Indicator
        tab62(1)   TYPE c,
        datlwb     TYPE datlwb,             "Date of Last Goods Movement
        tab63(1)   TYPE c,
        kunnr      TYPE	b_kunnr,            "Customer account number
        tab64(1)   TYPE c,
        lifnr      TYPE	b_lifnr,            "Vendor account number
        tab65(1)   TYPE c,
        kdauf      TYPE kdauf,              "Sales Order Number
        tab66(1)   TYPE c,
        ps_psp_pnr TYPE	ps_psp_pnr,         "WBS Element
        tab67(1)   TYPE c,
        erdat      TYPE erdat,              "Creation date
        tab68(1)   TYPE c,
        pltxt      TYPE pltxt,              "Description Funct. Loc.
*** MOD-002 * begin ***
        tab69(1)   TYPE c,
        aufnr_lo   TYPE aufnr,              "Last Order
        tab70(1)   TYPE c,
        erdat_lo   TYPE auferfdat,          "Creation Date Last Order
*** MOD-002 * end ***
        tab99(1)   TYPE c,
      END OF gt_out.

DATA: BEGIN OF gt_outh  OCCURS 0,
        eqtyp      TYPE fieldname,              "Category
        tab01(1)   TYPE c,
        equnr      TYPE fieldname,              "Equipment nr.
        tab02(1)   TYPE c,
        datab      TYPE fieldname,              "Valid on
        tab03(1)   TYPE c,
        eqktx      TYPE fieldname,              "Description
        tab04(1)   TYPE c,
        eqart      TYPE fieldname,              "Type
        tab05(1)   TYPE c,
        brgew_c    TYPE fieldname,              "Gross Weight
        tab06(1)   TYPE c,
        groes      TYPE fieldname,              "Size/dimension
        tab07(1)   TYPE c,
        invnr      TYPE fieldname,              "Inventory nr.
        tab08(1)   TYPE c,
        inbdt      TYPE fieldname,              "Start-up date
        tab09(1)   TYPE c,
        answt_c    TYPE fieldname,              "Acquisition value
        tab10(1)   TYPE c,
        ansdt      TYPE fieldname,              "Acquisition date
        tab11(1)   TYPE c,
        waers      TYPE fieldname,              "Currency
        tab12(1)   TYPE c,
        herst      TYPE fieldname,              "Manufacturer
        tab13(1)   TYPE c,
        herld      TYPE fieldname,              "Manufacturer country
        tab14(1)   TYPE c,
        typbz      TYPE fieldname,              "Manufacturer model number
        tab15(1)   TYPE c,
        baujj      TYPE fieldname,              "Construction year
        tab16(1)   TYPE c,
        baumm      TYPE fieldname,              "Construction month
        tab17(1)   TYPE c,
        mapar      TYPE fieldname,              "Manufacturer part number
        tab18(1)   TYPE c,
        serge      TYPE fieldname,              "Manufacturer serial number
        tab19(1)   TYPE c,
        swerk      TYPE fieldname,              "Maintenance plant
        tab20(1)   TYPE c,
        stort      TYPE fieldname,              "Location
        tab21(1)   TYPE c,
        msgrp      TYPE fieldname,              "Room
        tab22(1)   TYPE c,
        beber      TYPE fieldname,              "Plant section
        tab23(1)   TYPE c,
        arbpl_l    TYPE fieldname,              "Work Center (location)
        tab24(1)   TYPE c,
        abckz      TYPE fieldname,              "ABC indicator
        tab25(1)   TYPE c,
        eqfnr      TYPE fieldname,              "Sort field
        tab26(1)   TYPE c,
        bukrs      TYPE fieldname,              "Company Code
        tab27(1)   TYPE c,
        anlnr      TYPE fieldname,              "Asset number
        tab28(1)   TYPE c,
        kostl      TYPE fieldname,              "Cost Center
        tab29(1)   TYPE c,
        proid      TYPE fieldname,              "WBS element
        tab30(1)   TYPE c,
        daufn      TYPE fieldname,              "Standing order
        tab31(1)   TYPE c,
        aufnr      TYPE fieldname,              "Settlemznt order
        tab32(1)   TYPE c,
        iwerk      TYPE fieldname,              "(Maintenance) Planning Plant
        tab33(1)   TYPE c,
        ingrp      TYPE fieldname,              "Planner Group
        tab34(1)   TYPE c,
        arbpl_m    TYPE fieldname,              "Main Work Center
        tab35(1)   TYPE c,
        rbnr       TYPE fieldname,              "Catalog Profile
        tab36(1)   TYPE c,
        tplnr      TYPE fieldname,              "Functional Location
        tab37(1)   TYPE c,
        hequi      TYPE fieldname,              "Superordinate Equipment
        tab38(1)   TYPE c,
        heqnr      TYPE fieldname,              "Equipment position
        tab39(1)   TYPE c,
        tidnr      TYPE fieldname,              "Technical identification nr
        tab40(1)   TYPE c,
        submt      TYPE fieldname,              "Construction type
        tab41(1)   TYPE c,
        gwldt_c    TYPE fieldname,              "Begin warranty date (Customer)
        tab42(1)   TYPE c,
        gwlen_c    TYPE fieldname,              "End warranty date (Customer)
        tab43(1)   TYPE c,
        mganr_c    TYPE fieldname,              "Master warranty nr. (Customer)
        tab44(1)   TYPE c,
        gwldt_v    TYPE fieldname,              "Begin warranty date (Vendor)
        tab45(1)   TYPE c,
        gwlen_v    TYPE fieldname,              "End warranty date (Vendor)
        tab46(1)   TYPE c,
        mganr_v    TYPE fieldname,              "Master warranty nr. (Vendor)
        tab47(1)   TYPE c,
        vkorg      TYPE fieldname,              "Sales Organization
        tab48(1)   TYPE c,
        vtweg      TYPE fieldname,              "Distribution channel
        tab49(1)   TYPE c,
        spart      TYPE fieldname,              "Division
        tab50(1)   TYPE c,
        vkbur      TYPE fieldname,              "Sales Office
        tab51(1)   TYPE c,
        vkgrp      TYPE fieldname,              "Sales group
        tab52(1)   TYPE c,
        liznr      TYPE fieldname,              "Equipment license nr
        tab53(1)   TYPE c,
        matnr      TYPE fieldname,              "Material
        tab54(1)   TYPE c,
        sernr      TYPE fieldname,              "Serial nr.
        tab55(1)   TYPE c,
        lbbsa      TYPE	fieldname,              "Stock Type of Goods Movement
        tab56(1)   TYPE c,
        b_werk     TYPE	fieldname,              "Plant
        tab57(1)   TYPE c,
        b_lager    TYPE	fieldname,              "Storage Location
        tab58(1)   TYPE c,
        bukrs1     TYPE fieldname,              "Company code
        tab59(1)   TYPE c,
        b_charge   TYPE	fieldname,              "Batch Number
        tab60(1)   TYPE c,
        charge     TYPE fieldname,              "Master Batch
        tab61(1)   TYPE c,
        sobkz      TYPE	fieldname,              "Special Stock Indicator
        tab62(1)   TYPE c,
        datlwb     TYPE fieldname,              "Date of Last Goods Movement
        tab63(1)   TYPE c,
        kunnr      TYPE	fieldname,              "Customer account number
        tab64(1)   TYPE c,
        lifnr      TYPE	fieldname,              "Vendor account number
        tab65(1)   TYPE c,
        kdauf      TYPE fieldname,              "Sales Order Number
        tab66(1)   TYPE c,
        ps_psp_pnr TYPE	fieldname,              "WBS Element
        tab67(1)   TYPE c,
        erdat      TYPE fieldname,              "Creation date
        tab68(1)   TYPE c,
        pltxt      TYPE fieldname,              "Description Funct. Loc.
*** MOD-002 * begin ***
        tab69(1)   TYPE c,
        aufnr_lo   TYPE fieldname,              "Last Order
        tab70(1)   TYPE c,
        erdat_lo   TYPE fieldname,              "Creation Date Last Order
*** MOD-002 * end ***
        tab99(1)   TYPE c,
      END OF gt_outh.


DATA: gv_directory(25) TYPE c VALUE '/var/load/xxx/UK/read/',
      gv_ofile         LIKE /sapdmc/lsoinp-filename,
      gv_logsys        LIKE tbdlst-logsys,
      gv_error         TYPE xfeld,
      gv_matnr(18)     TYPE c,
      gv_bismt(18)     TYPE c,
      gv_mat10(10)     TYPE c,
      gv_length(3)     TYPE n.

CONSTANTS: gc_stat_dlfl  TYPE j_status  VALUE 'I0076',
           gc_stat_inac  TYPE j_status  VALUE 'I0320',
           gc_stat_zscr  TYPE j_status  VALUE 'E0005'.

SELECTION-SCREEN  BEGIN OF BLOCK sel  WITH FRAME  TITLE text-s01.
PARAMETERS: p_bukrs      LIKE iloa-bukrs  OBLIGATORY
                                          MEMORY ID buk.
SELECTION-SCREEN SKIP.
SELECT-OPTIONS: s_equnr  FOR equi-equnr.
PARAMETERS:     p_eqart  LIKE equi-eqart  OBLIGATORY.
SELECTION-SCREEN  END OF BLOCK sel.


************************************************************************
*       I N I T I A L I Z A T I O N    E V E N T                       *
************************************************************************
INITIALIZATION.

* Logical system
  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = gv_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.


************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.

* Select data
  PERFORM select_data.

* Check anything selected
  IF gt_sel[] IS INITIAL.
    MESSAGE ID 'YSE_GENERAL' TYPE 'S' NUMBER '000'
            WITH 'No equipments selected'(e01).
    RETURN.
  ENDIF.

* Build output
  PERFORM build_output.

* Save output.
  PERFORM save_output.

  IF gv_error IS INITIAL.
    WRITE: /01 'Program ended succesfully'(i01).
  ENDIF.


************************************************************************
*       S U B R O U T I N E S                                          *
************************************************************************

*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
*       Select data
*----------------------------------------------------------------------*
FORM select_data .

  DATA: lt_iflotx TYPE TABLE OF iflotx.
  FIELD-SYMBOLS: <ls_sel>    LIKE LINE OF gt_sel,
                 <ls_iflotx> TYPE iflotx.

* Equipment data
  SELECT e~eqtyp e~equnr z~datab t~eqktx e~eqart e~brgew
         e~groes e~invnr e~inbdt e~answt e~ansdt e~waers
         e~herst e~herld e~typbz e~baujj e~baumm z~mapar
         e~serge l~swerk l~stort l~msgrp l~beber l~ppsid
         l~abckz l~eqfnr l~bukrs l~anlnr l~kostl l~proid
         l~daufn l~aufnr z~iwerk z~ingrp z~gewrk z~rbnr
         l~tplnr z~hequi z~heqnr z~tidnr f~submt l~vkorg
         l~vtweg l~spart l~vkbur l~vkgrp z~liznr e~matnr
         e~sernr e~charge e~datlwb e~erdat e~gewei
*         x~pltxt
         e~objnr AS objnr_e
         f~objnr AS objnr_l
         INTO CORRESPONDING FIELDS OF TABLE gt_sel
         FROM equi AS e
         INNER JOIN equz AS z
                    ON z~equnr = e~equnr
         INNER JOIN eqkt AS t
                    ON t~equnr = e~equnr
         INNER JOIN iloa AS l
                    ON l~iloan = z~iloan
*         INNER JOIN iflot AS f
*                    ON f~tplnr = l~tplnr
         LEFT OUTER JOIN iflot AS f
                    ON f~tplnr = l~tplnr
*         INNER JOIN iflotx AS x
*                    ON x~tplnr = f~tplnr
         WHERE e~equnr IN s_equnr
           AND e~eqart =  p_eqart
           AND z~datbi =  '99991231'
           AND l~bukrs =  p_bukrs
           AND t~spras =  'E'.
*           AND x~spras =  'E'.

  CHECK NOT gt_sel[] IS INITIAL.

  SELECT * FROM iflotx
    INTO TABLE lt_iflotx
    FOR ALL ENTRIES IN gt_sel
    WHERE tplnr EQ gt_sel-tplnr
      AND spras EQ 'E'.
  SORT lt_iflotx ASCENDING BY tplnr.
  LOOP AT gt_sel ASSIGNING <ls_sel>.
    CHECK <ls_sel>-tplnr IS NOT INITIAL.
    READ TABLE lt_iflotx ASSIGNING <ls_iflotx>
      WITH KEY tplnr = <ls_sel>-tplnr
      BINARY SEARCH.
    IF sy-subrc EQ 0.
      <ls_sel>-pltxt = <ls_iflotx>-pltxt.
    ENDIF.
  ENDLOOP.


*** MOD-001 * begin ***
** Check for deleted/scrapped equipments or functional locations
*  SELECT objnr
*         INTO TABLE gt_dlfli
*         FROM jest
*         FOR ALL ENTRIES IN gt_sel
*         WHERE ( objnr = gt_sel-objnr_e   OR
*                 objnr = gt_sel-objnr_l )
*           AND ( stat  = gc_stat_dlfl     OR
*                 stat  = gc_stat_inac     OR
*                 stat  = gc_stat_zscr )
*           AND inact = ' '.
*  SORT gt_dlfli BY objnr.
*  DELETE ADJACENT DUPLICATES FROM gt_dlfli
*                                  COMPARING objnr.
*  gt_dlfl[] = gt_dlfli[].
*  FREE gt_dlfli.
*
*  LOOP AT gt_sel.
**   Check for deleted equipments
*    READ TABLE gt_dlfl WITH TABLE KEY objnr = gt_sel-objnr_e.
*    IF sy-subrc = 0.
*      DELETE gt_sel.
*      CONTINUE.
*    ENDIF.
**   Check for deleted functional locations
*    READ TABLE gt_dlfl WITH TABLE KEY objnr = gt_sel-objnr_l.
*    IF sy-subrc = 0.
*      DELETE gt_sel.
*      CONTINUE.
*    ENDIF.
*  ENDLOOP.
*  FREE gt_dlfl.
*
*  CHECK NOT gt_sel[] IS INITIAL.
*** MOD-001 * end ***

* Serial Number Stock Segment
  SELECT * INTO TABLE gt_eqbs
           FROM eqbs
           FOR ALL ENTRIES IN gt_sel
           WHERE equnr = gt_sel-equnr.

* Master Warranty
  SELECT j_objnr gaart gwldt gwlen mganr
         INTO TABLE gt_bgmkobji
         FROM bgmkobj
         FOR ALL ENTRIES IN gt_sel
         WHERE j_objnr = gt_sel-objnr_e
           AND ( gaart = '1' OR
                 gaart = '2' ).
  SORT gt_bgmkobji BY objnr gaart.
  DELETE ADJACENT DUPLICATES FROM gt_bgmkobji
                                  COMPARING objnr gaart.
  gt_bgmkobj[] = gt_bgmkobji[].
  FREE gt_bgmkobji.

* Work Centers
  SELECT objid arbpl INTO TABLE gt_crhdi
         FROM crhd
         FOR ALL ENTRIES IN gt_sel
         WHERE objty = 'A '
           AND ( objid = gt_sel-ppsid OR
                 objid = gt_sel-gewrk ).
  SORT gt_crhdi BY objid.
  DELETE ADJACENT DUPLICATES FROM gt_crhdi
                                  COMPARING objid.
  gt_crhd[] = gt_crhdi[].
  FREE gt_crhdi.

* Materials
  SELECT matnr bismt INTO TABLE gt_marai
         FROM mara
         FOR ALL ENTRIES IN gt_sel
         WHERE matnr = gt_sel-matnr.
  SORT gt_marai BY matnr.
  DELETE ADJACENT DUPLICATES FROM gt_marai
                                  COMPARING matnr.
  gt_mara[] = gt_marai[].
  FREE gt_marai.

*** MOD-002 * begin ***
* Last Order data
  SELECT h~equnr o~aufnr o~erdat
         INTO TABLE gt_aufki
         FROM afih AS h
         INNER JOIN aufk AS o
                    ON o~aufnr = h~aufnr
         FOR ALL ENTRIES IN gt_sel
         WHERE h~equnr = gt_sel-equnr.
  SORT gt_aufki BY equnr aufnr DESCENDING.
  DELETE ADJACENT DUPLICATES FROM gt_aufki
         COMPARING equnr.
  gt_aufk[] = gt_aufki[].
  FREE gt_aufki.
*** MOD-002 * end ***

ENDFORM.                    " SELECT_DATA

*&---------------------------------------------------------------------*
*&      Form  BUILD_OUTPUT
*&---------------------------------------------------------------------*
*       Build table fot output file
*----------------------------------------------------------------------*
FORM build_output .

  LOOP AT gt_sel.

    CLEAR: gt_out.
    MOVE '|' TO: gt_out-tab01, gt_out-tab02, gt_out-tab03, gt_out-tab04,
                 gt_out-tab05, gt_out-tab06, gt_out-tab07, gt_out-tab08,
                 gt_out-tab09, gt_out-tab10, gt_out-tab11, gt_out-tab12,
                 gt_out-tab13, gt_out-tab14, gt_out-tab15, gt_out-tab16,
                 gt_out-tab17, gt_out-tab18, gt_out-tab19, gt_out-tab20,
                 gt_out-tab21, gt_out-tab22, gt_out-tab23, gt_out-tab24,
                 gt_out-tab25, gt_out-tab26, gt_out-tab27, gt_out-tab28,
                 gt_out-tab29, gt_out-tab30, gt_out-tab31, gt_out-tab32,
                 gt_out-tab33, gt_out-tab34, gt_out-tab35, gt_out-tab36,
                 gt_out-tab37, gt_out-tab38, gt_out-tab39, gt_out-tab40,
                 gt_out-tab41, gt_out-tab42, gt_out-tab43, gt_out-tab44,
                 gt_out-tab45, gt_out-tab46, gt_out-tab47, gt_out-tab48,
                 gt_out-tab49, gt_out-tab50, gt_out-tab51, gt_out-tab52,
                 gt_out-tab53, gt_out-tab54, gt_out-tab55, gt_out-tab56,
                 gt_out-tab57, gt_out-tab58, gt_out-tab59, gt_out-tab60,
                 gt_out-tab61, gt_out-tab62, gt_out-tab63, gt_out-tab64,
                 gt_out-tab65, gt_out-tab66, gt_out-tab67, gt_out-tab68,
*** MOD-002 * begin ***
                 gt_out-tab69, gt_out-tab70,
*** MOD-002 * end ***
                 gt_out-tab99.

    MOVE-CORRESPONDING gt_sel TO gt_out.

*   Serial number
    CALL FUNCTION 'CONVERSION_EXIT_GERNR_OUTPUT'
      EXPORTING
        input  = gt_out-sernr
      IMPORTING
        output = gt_out-sernr.
    CALL FUNCTION 'CONVERSION_EXIT_GERNR_INPUT'
      EXPORTING
        input  = gt_out-sernr
      IMPORTING
        output = gt_out-sernr.

*   Material number
    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
      EXPORTING
        input  = gt_sel-matnr
      IMPORTING
        output = gv_matnr.
    gv_length = STRLEN( gv_matnr ).
    IF gv_length GE 10.
      gt_out-matnr = gv_matnr.
    ELSE.
      CLEAR gt_mara.
      READ TABLE gt_mara WITH TABLE KEY matnr = gt_sel-matnr.
      CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
        EXPORTING
          input  = gt_mara-bismt
        IMPORTING
          output = gv_bismt.
      gv_length = STRLEN( gv_bismt ).
      IF gv_length = 10.
        gt_out-matnr = gv_bismt.
      ELSE.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
          EXPORTING
            input  = gv_matnr
          IMPORTING
            output = gv_mat10.
        gt_out-matnr = gv_mat10.
      ENDIF.
    ENDIF.

    MOVE gt_sel-bukrs TO gt_out-bukrs1.
    WRITE gt_sel-brgew TO gt_out-brgew_c UNIT gt_sel-gewei.
    WRITE gt_sel-answt TO gt_out-answt_c CURRENCY gt_sel-waers.

*   Serial Number Stock Segment
    READ TABLE gt_eqbs WITH TABLE KEY equnr = gt_sel-equnr.
    IF sy-subrc = 0.
      MOVE-CORRESPONDING gt_eqbs TO gt_out.
    ENDIF.

*   Warranty - Customer
    READ TABLE gt_bgmkobj WITH TABLE KEY objnr = gt_sel-objnr_e
                                         gaart = '1'.
    IF sy-subrc = 0.
      gt_out-gwldt_c = gt_bgmkobj-gwldt.
      gt_out-gwlen_c = gt_bgmkobj-gwlen.
      gt_out-mganr_c = gt_bgmkobj-mganr.
    ENDIF.
*   Warranty - Vendor
    READ TABLE gt_bgmkobj WITH TABLE KEY objnr = gt_sel-objnr_e
                                         gaart = '2'.
    IF sy-subrc = 0.
      gt_out-gwldt_v = gt_bgmkobj-gwldt.
      gt_out-gwlen_v = gt_bgmkobj-gwlen.
      gt_out-mganr_v = gt_bgmkobj-mganr.
    ENDIF.

*   Work Center (location)
    READ TABLE gt_crhd WITH TABLE KEY objid = gt_sel-ppsid.
    IF sy-subrc = 0.
      gt_out-arbpl_l = gt_crhd-arbpl.
    ENDIF.
*   Main Work Center
    READ TABLE gt_crhd WITH TABLE KEY objid = gt_sel-gewrk.
    IF sy-subrc = 0.
      gt_out-arbpl_m = gt_crhd-arbpl.
    ENDIF.

*** MOD-002 * begin ***
*   Last Order data
    READ TABLE gt_aufk WITH TABLE KEY equnr = gt_sel-equnr.
    IF sy-subrc = 0.
      gt_out-aufnr_lo = gt_aufk-aufnr.
      gt_out-erdat_lo = gt_aufk-erdat.
    ENDIF.
*** MOD-002 * end ***

    APPEND gt_out.

  ENDLOOP.

ENDFORM.                    " BUILD_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  SAVE_OUTPUT
*&---------------------------------------------------------------------*
*       Save output file
*----------------------------------------------------------------------*
FORM save_output .

  CONCATENATE 'EQUIPMENT' 'DATA' p_bukrs p_eqart
             INTO gv_ofile SEPARATED BY '_'.

  REPLACE 'xxx' IN gv_directory WITH gv_logsys(3).
  CONCATENATE gv_directory gv_ofile INTO gv_ofile.

  OPEN DATASET gv_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc <> 0.
    WRITE: / text-e02, gv_ofile.
    gv_error = 'X'.
    EXIT.
  ENDIF.

* Fill header
  PERFORM fill_header.
  LOOP AT gt_outh.
    TRANSFER gt_outh TO gv_ofile.
  ENDLOOP.

* Fill output
  LOOP AT gt_out.
    TRANSFER gt_out TO gv_ofile.
  ENDLOOP.

ENDFORM.                    " SAVE_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  FILL_HEADER
*&---------------------------------------------------------------------*
*       Fill header
*----------------------------------------------------------------------*
FORM fill_header .

  CLEAR: gt_outh.
  MOVE '|' TO: gt_outh-tab01, gt_outh-tab02, gt_outh-tab03, gt_outh-tab04,
               gt_outh-tab05, gt_outh-tab06, gt_outh-tab07, gt_outh-tab08,
               gt_outh-tab09, gt_outh-tab10, gt_outh-tab11, gt_outh-tab12,
               gt_outh-tab13, gt_outh-tab14, gt_outh-tab15, gt_outh-tab16,
               gt_outh-tab17, gt_outh-tab18, gt_outh-tab19, gt_outh-tab20,
               gt_outh-tab21, gt_outh-tab22, gt_outh-tab23, gt_outh-tab24,
               gt_outh-tab25, gt_outh-tab26, gt_outh-tab27, gt_outh-tab28,
               gt_outh-tab29, gt_outh-tab30, gt_outh-tab31, gt_outh-tab32,
               gt_outh-tab33, gt_outh-tab34, gt_outh-tab35, gt_outh-tab36,
               gt_outh-tab37, gt_outh-tab38, gt_outh-tab39, gt_outh-tab40,
               gt_outh-tab41, gt_outh-tab42, gt_outh-tab43, gt_outh-tab44,
               gt_outh-tab45, gt_outh-tab46, gt_outh-tab47, gt_outh-tab48,
               gt_outh-tab49, gt_outh-tab50, gt_outh-tab51, gt_outh-tab52,
               gt_outh-tab53, gt_outh-tab54, gt_outh-tab55, gt_outh-tab56,
               gt_outh-tab57, gt_outh-tab58, gt_outh-tab59, gt_outh-tab60,
               gt_outh-tab61, gt_outh-tab62, gt_outh-tab63, gt_outh-tab64,
               gt_outh-tab65, gt_outh-tab66, gt_outh-tab67, gt_outh-tab68,
*** MOD-002 * begin ***
               gt_outh-tab69, gt_outh-tab70,
*** MOD-002 * end ***
               gt_outh-tab99.

  gt_outh-eqtyp      = 'EQTYP'.              "Category
  gt_outh-equnr      = 'EQUNR'.              "Equipment nr.
  gt_outh-datab      = 'DATAB'.              "Valid on
  gt_outh-eqktx      = 'KTX01'.              "Description
  gt_outh-eqart      = 'EQART'.              "Type
  gt_outh-brgew_c    = 'BRGEW'.              "Gross Weight
  gt_outh-groes      = 'GROSS'.              "Size/dimension
  gt_outh-invnr      = 'INVNR'.              "Inventory nr.
  gt_outh-inbdt      = 'ILOM_DATAB'.         "Start-up date
  gt_outh-answt_c    = 'ANSWT'.              "Acquisition value
  gt_outh-ansdt      = 'ANDTI'.              "Acquisition date
  gt_outh-waers      = 'WAERS'.              "Currency
  gt_outh-herst      = 'HERST'.              "Manufacturer
  gt_outh-herld      = 'HERLD'.              "Manufacturer country
  gt_outh-typbz      = 'TYPBZ'.              "Manufacturer model number
  gt_outh-baujj      = 'BAUJJ'.              "Construction year
  gt_outh-baumm      = 'BAUMM'.              "Construction month
  gt_outh-mapar      = 'MAPAR'.              "Manufacturer part number
  gt_outh-serge      = 'SERGE'.              "Manufacturer serial number
  gt_outh-swerk      = 'SWERK'.              "Maintenance plant
  gt_outh-stort      = 'PMLOC'.              "Location
  gt_outh-msgrp      = 'RAUMNR'.             "Room
  gt_outh-beber      = 'BEBER'.              "Plant section
  gt_outh-arbpl_l    = 'ARBPL_L'.            "Work Center (location)
  gt_outh-abckz      = 'ABCKZ'.              "ABC indicator
  gt_outh-eqfnr      = 'EQFNR'.              "Sort field
  gt_outh-bukrs      = 'BUKRS'.              "Company Code
  gt_outh-anlnr      = 'ANLN1'.              "Asset number
  gt_outh-kostl      = 'KOSTL'.              "Cost Center
  gt_outh-proid      = 'PS_PSP_PNR'.         "WBS element (Function Location)
  gt_outh-daufn      = 'DAUFN'.              "Standing order
  gt_outh-aufnr      = 'ILOM_ORDST'.         "Settlement order
  gt_outh-iwerk      = 'IWERK'.              "(Maintenance) Planning Plant
  gt_outh-ingrp      = 'INGRP'.              "Planner Group
  gt_outh-arbpl_m    = 'ARBPL_M'.            "Main Work Center
  gt_outh-rbnr       = 'RBNR'.               "Catalog Profile
  gt_outh-tplnr      = 'TPLNR'.              "Functional Location
  gt_outh-hequi      = 'HEQUI'.              "Superordinate Equipment
  gt_outh-heqnr      = 'HEQNR'.              "Equipment position
  gt_outh-tidnr      = 'TIDNR'.              "Technical identification nr
  gt_outh-submt      = 'SUBMT'.              "Construction type
  gt_outh-gwldt_c    = 'GWLDT_c'.            "Begin warranty date (Customer)
  gt_outh-gwlen_c    = 'GWLEN_c'.            "End warranty date (Customer)
  gt_outh-mganr_c    = 'MGANR_c'.            "Master warranty nr. (Customer)
  gt_outh-gwldt_v    = 'GWLDT_v'.            "Begin warranty date (Vendor)
  gt_outh-gwlen_v    = 'GWLEN_v'.            "End warranty date (Vendor)
  gt_outh-mganr_v    = 'MGANR_v'.            "Master warranty nr. (Vendor)
  gt_outh-vkorg      = 'VKORG'.              "Sales Organization
  gt_outh-vtweg      = 'VTWEG'.              "Distribution channel
  gt_outh-spart      = 'SPART'.              "Division
  gt_outh-vkbur      = 'VKBUR'.              "Sales Office
  gt_outh-vkgrp      = 'VKGRP'.              "Sales group
  gt_outh-liznr      = 'LIZNR'.              "Equipment license nr
  gt_outh-matnr      = 'MATNR'.              "Material
  gt_outh-sernr      = 'GERNR'.              "Serial nr.
  gt_outh-lbbsa      = 'LBBSA'.              "Stock Type of Goods Movement
  gt_outh-b_werk     = 'WERKS_D'.            "Plant
  gt_outh-b_lager    = 'LGORT_D'.            "Storage Location
  gt_outh-bukrs1     = 'BUKRS_M'.            "Company code Material
  gt_outh-b_charge   = 'B_CHARGE'.           "Batch Number
  gt_outh-charge     = 'CHARGE_D'.           "Master Batch
  gt_outh-sobkz      = 'SOBKZ'.              "Special Stock Indicator
  gt_outh-datlwb     = 'DATLWB'.             "Date of Last Goods Movement
  gt_outh-kunnr      = 'KUNNR'.              "Customer account number
  gt_outh-lifnr      = 'LIFNR'.              "Vendor account number
  gt_outh-kdauf      = 'KDAUF'.              "Sales Order Number
  gt_outh-ps_psp_pnr = 'PS_PSP_PNR_S'.       "WBS Element (Serial Nr Stock Segm.)
  gt_outh-erdat      = 'ERDAT'.              "Creation date
  gt_outh-pltxt      = 'PLTXT'.              "Description Funct. Loc.
*** MOD-002 * begin ***
  gt_outh-aufnr_lo   = 'AUFNR_L'.            "Last Order
  gt_outh-erdat_lo   = 'ERDAT_L'.            "Creation date Last Order
*** MOD-002 * begin ***
  APPEND gt_outh.

  gt_outh-eqtyp      = 'Category'.
  gt_outh-equnr      = 'Equipment'.
  gt_outh-datab      = 'Valid on'.
  gt_outh-eqktx      = 'Description'.
  gt_outh-eqart      = 'Type'.
  gt_outh-brgew_c    = 'Gross Weight'.
  gt_outh-groes      = 'Size/Dimension'.
  gt_outh-invnr      = 'Inventory Nr.'.
  gt_outh-inbdt      = 'Start-up Date'.
  gt_outh-answt_c    = 'Acquisition Value'.
  gt_outh-ansdt      = 'Acquis. Date'.
  gt_outh-waers      = 'Currency'.
  gt_outh-herst      = 'Manufacturer'.
  gt_outh-herld      = 'Manuf. Country'.
  gt_outh-typbz      = 'Manuf. Model Nr.'.
  gt_outh-baujj      = 'Construction Year'.
  gt_outh-baumm      = 'Constr. Month'.
  gt_outh-mapar      = 'Manuf. Part Nr.'.
  gt_outh-serge      = 'Manuf. Serial Nr.'.
  gt_outh-swerk      = 'Maint. Plant'.
  gt_outh-stort      = 'Location'.
  gt_outh-msgrp      = 'Room'.
  gt_outh-beber      = 'Plant Section'.
  gt_outh-arbpl_l    = 'Work Center (Loc.)'.
  gt_outh-abckz      = 'ABC Ind.'.
  gt_outh-eqfnr      = 'Sort field'.
  gt_outh-bukrs      = 'Company'.
  gt_outh-anlnr      = 'Asset'.
  gt_outh-kostl      = 'Cost Center'.
  gt_outh-proid      = 'WBS Element (FL)'.
  gt_outh-daufn      = 'Standing Order'.
  gt_outh-aufnr      = 'Settlement Order'.
  gt_outh-iwerk      = 'Planning Plant'.
  gt_outh-ingrp      = 'Planner Group'.
  gt_outh-arbpl_m    = 'Main Work Center'.
  gt_outh-rbnr       = 'Catalog Profile'.
  gt_outh-tplnr      = 'Functional Loc.'.
  gt_outh-hequi      = 'Main Equipment'.
  gt_outh-heqnr      = 'Equipment Pos.'.
  gt_outh-tidnr      = 'Techn. Identification'.
  gt_outh-submt      = 'Construction Type'.
  gt_outh-gwldt_c    = 'Begin Warranty (Cust.)'.
  gt_outh-gwlen_c    = 'End Warranty (Cust.)'.
  gt_outh-mganr_c    = 'Master Warranty (Cust.)'.
  gt_outh-gwldt_v    = 'Begin warranty (Vend.)'.
  gt_outh-gwlen_v    = 'End warranty (Vend.)'.
  gt_outh-mganr_v    = 'Master Warranty (Vend.)'.
  gt_outh-vkorg      = 'Sales Org.'.
  gt_outh-vtweg      = 'Distr. Channel'.
  gt_outh-spart      = 'Division'.
  gt_outh-vkbur      = 'Sales Office'.
  gt_outh-vkgrp      = 'Sales group'.
  gt_outh-liznr      = 'Equipment License'.
  gt_outh-matnr      = 'Material'.
  gt_outh-sernr      = 'Serial Nr.'.
  gt_outh-lbbsa      = 'Stock Type (G.M.)'.
  gt_outh-b_werk     = 'Plant'.
  gt_outh-b_lager    = 'Storage Loc.'.
  gt_outh-bukrs1     = 'Comp. (Mat.)'.
  gt_outh-b_charge   = 'Batch Nr.'.
  gt_outh-charge     = 'Master Batch'.
  gt_outh-sobkz      = 'Special Stock Ind.'.
  gt_outh-datlwb     = 'Last Goods Mov.'.
  gt_outh-kunnr      = 'Customer'.
  gt_outh-lifnr      = 'Vendor'.
  gt_outh-kdauf      = 'Sales Order'.
  gt_outh-ps_psp_pnr = 'WBS Element (Ser.)'.
  gt_outh-erdat      = 'Creation Date'.
  gt_outh-pltxt      = 'Description Funct. Loc.'.
*** MOD-002 * begin ***
  gt_outh-aufnr_lo   = 'Last Order'.
  gt_outh-erdat_lo   = 'Last Order Date'.
*** MOD-002 * begin ***
  APPEND gt_outh.

ENDFORM.                    " FILL_HEADER

*Text symbol text£º
*E01:No equipments selected
*E02:Could not open output file
*I01:Program ended succesfully

*S01:Selection
*Selection text£º
*P_BUKRS:D       .
*P_EQART:        Type
*S_EQUNR:D       .
