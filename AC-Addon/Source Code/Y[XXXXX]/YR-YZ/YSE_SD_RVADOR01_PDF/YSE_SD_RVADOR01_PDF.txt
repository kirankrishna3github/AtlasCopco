*---------------------------------------------------------------------*
*              Print of an order confirmation by SAPscript
*---------------------------------------------------------------------*
* SEED project
* Done by Jespers Pieter
* This program was copied from print program RVADOR01
* this printprogram is used for AM quotation (YSE_SDQUOT_01) and
* SD quotation (YSE_SDQUOTATION)
*---------------------------------------------------------------------*
*=====================================================================*
* Change History Log                                                  *
*---------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number | Change Ref*
*---------------------------------------------------------------------*
* MOD-001 |27/02/2007| Tom Van Oevelen| XXXXxxxxxx        | XXXXxxxxxx*
* Description:                                                        *
* I have used this program to prototype the output of a smartform to  *
* a PDF file                                                          *
*---------------------------------------------------------------------*
* MOD-002 |11/05/2009| Jules Smets    | XXXXxxxxxx        | CR0415    *
*                                                                     *
* Description:  ATP check for Quotation (SD)                          *
*---------------------------------------------------------------------*
* MOD-003 |21/04/2010| Geert Rutten   | CD1K956178        | CR1102    *
*                                                                     *
* Description: Payment Req.(Russia) for Sjot onQuotation              *
*              output type ZN02                                       *
*---------------------------------------------------------------------*
* MOD-004 |01/07/2010| Lakshmi Reddy  | CD1K957776        | CR1508    *
*                                                                     *
* Description: Only active conditions should be considered for        *
*              discount for Quatations.Check the condition KOMV-KINAK *
*              as blank in the smartform while calculating discount.  *
***********************************************************************
*---------------------------------------------------------------------*
REPORT yse_sd_rvador01_pdf LINE-COUNT 100 MESSAGE-ID vn.

TABLES: komk,                          "Communicationarea for conditions
        komp,                          "Communicationarea for conditions
        komvd,                         "Communicationarea for conditions
        vbco3,                         "Communicationarea for view
        vbdka,                         "Headerview
        vbdpa,                         "Itemview
        vbdpau,                        "Subitemnumbers
        conf_out,                      "Configuration data
        sadr,                          "Addresses
        tvag,                          "Reason for rejection
        vedka,                         "Servicecontract head data
        vedpa,                         "Servicecontract position data
        vedkn,                         "Servicecontract head notice data
        vedpn,                         "Servicecontract pos. notice data
        riserls,                       "Serialnumbers
        komser,                        "Serialnumbers for print
        tvbur,                         "Sales office
        tvko,                          "Sales organisation
        adrs,                          "Communicationarea for Address
        fpltdr,                        "billing schedules
        wtad_addis_in_so_print,        "additional
        vbpa,
        wtad_buying_print_extra_text.  "texts belonging to additional

TYPE-POOLS szadr.

INCLUDE rvadtabl.
INCLUDE rvdirekt.
INCLUDE vedadata.

* data for access to central address maintenance
INCLUDE sdzavdat.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
TYPE-POOLS: addi.

DATA price_print_mode(1) TYPE c.       "Print-mode
DATA: retcode   LIKE sy-subrc.         "Returncode
DATA: repeat(1) TYPE c.
DATA: xscreen(1) TYPE c.               "Output on printer or screen
DATA: BEGIN OF steu,                   "Controldata for output
        vdkex(1) TYPE c,
        vdpex(1) TYPE c,
        kbkex(1) TYPE c,
        kbpex(1) TYPE c,
      END OF steu.


DATA: BEGIN OF tvbdpa OCCURS 0.        "Internal table for items
        INCLUDE STRUCTURE vbdpa.
DATA: END OF tvbdpa.

DATA: BEGIN OF tkomv OCCURS 50.
        INCLUDE STRUCTURE komv.
DATA: END OF tkomv.

DATA: BEGIN OF tkomvd OCCURS 50.
        INCLUDE STRUCTURE komvd.
DATA: END OF tkomvd.

DATA: BEGIN OF tvbdpau OCCURS 5.
        INCLUDE STRUCTURE vbdpau.
DATA: END   OF tvbdpau.

DATA: BEGIN OF tkomcon OCCURS 50.
        INCLUDE STRUCTURE conf_out.
DATA: END   OF tkomcon.

DATA: BEGIN OF tkomservh OCCURS 1.
        INCLUDE STRUCTURE vedka.
DATA: END   OF tkomservh.

DATA: BEGIN OF tkomservp OCCURS 5.
        INCLUDE STRUCTURE vedpa.
DATA: END   OF tkomservp.

DATA: BEGIN OF tkomservhn OCCURS 5.
        INCLUDE STRUCTURE vedkn.
DATA: END   OF tkomservhn.

DATA: BEGIN OF tkomservpn OCCURS 5.
        INCLUDE STRUCTURE vedpn.
DATA: END   OF tkomservpn.

DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
DATA: END   OF tkomser_print.

DATA: BEGIN OF tfpltdr OCCURS 5.
        INCLUDE STRUCTURE fpltdr.
DATA: END   OF tfpltdr.

* begin of insert MOD-003
DATA:   gv_vbtyp      TYPE vbak-vbtyp,
        lv_fpltr_use  TYPE fplt-fpltr,
        lv_fplnr_use  TYPE fplt-fplnr,
        lv_fakwr_use  TYPE fplt-fakwr,
        lv_fproz_use  TYPE fplt-fproz,
        lv_fpltr_use2(6) TYPE c.
* end of insert MOD-003

DATA: taddi_print TYPE addi_so_print_itab WITH HEADER LINE.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: pr_kappl(01)   TYPE c VALUE 'V'. "Application for pricing

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: nast_anzal LIKE nast-anzal.      "Number of outputs (Orig. + Cop.)
DATA: nast_tdarmod LIKE nast-tdarmod.  "Archiving only one time

* current language for read buffered.
DATA: gf_language LIKE sy-langu.

DATA: wa_knvk_contact TYPE knvk.
DATA: wa_adcp_contact TYPE adcp.
DATA: wa_tpfkt_contact TYPE tpfkt.
DATA: it_ztext TYPE TABLE OF ttext.
DATA: wa_tvbdpa_extra TYPE vbdpa.
DATA: wa_tvbdpa_extra1 TYPE vbdpa.
DATA: wa_tkomv TYPE komv.
DATA: wa_veda TYPE veda.
DATA: wa_vbak TYPE vbak.
DATA: wa_tvgrt TYPE tvgrt.
DATA: it_tvbdpa_extra TYPE TABLE OF vbdpa.
DATA: w_vtext TYPE t685t-vtext.
DATA: wa_vbpa_bill_to TYPE vbpa.
DATA: wa_vbpa_ship_to TYPE vbpa.
DATA: v_vkaus TYPE abrvw.
DATA: v_bezei TYPE bezei20.
DATA: v_tel TYPE telf1.
DATA: v_fax TYPE telfx.
*&---------------------------------------------------------------------*
*&      Form  ENTRY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry USING return_code TYPE i
                 us_screen TYPE c.
  DATA: lf_retcode TYPE sy-subrc.

* Begin of insert MOD-003
  DATA: lt_sellist LIKE spopli OCCURS 5 WITH HEADER LINE,
        lt_fplt LIKE fplt OCCURS 0 WITH HEADER LINE.

  DATA: lv_auart TYPE vbak-auart,
        lv_vgbel TYPE vbak-vgbel,
        lv_fplnr TYPE fplt-fplnr,
        lv_fpltr TYPE fplt-fpltr,
        lv_fplnr_out(10) TYPE c,
        lv_fpltr_out(6) TYPE c,
        lv_fakwr_out(13) TYPE c,
        lv_lines TYPE f,
        lv_answer(3) TYPE c,
        lv_fakwr TYPE fplt-fakwr,
        lv_tetxt TYPE fplt-tetxt.

  IF nast-kschl = 'ZN02'.

    SELECT SINGLE vbtyp vgbel auart
      INTO (gv_vbtyp, lv_vgbel, lv_auart) FROM vbak
      WHERE vbeln = nast-objky.

    IF gv_vbtyp = 'B'.
      SELECT SINGLE fplnr INTO lv_fplnr
            FROM vbkd WHERE vbeln EQ nast-objky
                        AND posnr EQ '000000'
                        AND fplnr NE space.

      REFRESH lt_sellist.
      SELECT fplnr fpltr tetxt fakwr
          INTO (lv_fplnr, lv_fpltr, lv_tetxt, lv_fakwr)
          FROM fplt
          WHERE fplnr EQ lv_fplnr
            AND tetxt EQ 'Z006'.

        lv_fakwr_out = lv_fakwr.
        CONCATENATE lv_fplnr lv_fpltr lv_tetxt lv_fakwr_out INTO lt_sellist-varoption SEPARATED BY ' - '.
        APPEND lt_sellist.
      ENDSELECT.

      DESCRIBE TABLE lt_sellist LINES lv_lines.
      IF lv_lines > 1.
        CLEAR: lv_answer.

        CALL FUNCTION 'POPUP_TO_DECIDE_LIST'
          EXPORTING
            start_col                = 30
            start_row                = 15
            textline1                = 'More than 1 payment request found'
*            textline2                =
            textline3                = 'Please choose one'
            titel                    = 'List of payment requests'
          IMPORTING
            answer                   = lv_answer
          TABLES
            t_spopli                 = lt_sellist
          EXCEPTIONS
            not_enough_answers       = 1
            too_much_answers         = 2
            too_much_marks           = 3
            OTHERS                   = 4.

        IF lv_answer NE 'A'.
          READ TABLE lt_sellist INDEX lv_answer.
          IF sy-subrc = 0.
            MOVE lt_sellist-varoption+00(10) TO lv_fplnr_out.
            MOVE lt_sellist-varoption+13(06) TO lv_fpltr_out.
          ENDIF.
        ELSE.
          MESSAGE e001(00) WITH 'No payment request was selected !'.
        ENDIF.
      ENDIF. "more than 1 line --> popup

      IF lv_fplnr_out IS NOT INITIAL. " popup was necessary and we need to pick up values
        lv_fpltr_use = lv_fpltr_out.
        lv_fplnr_use = lv_fplnr_out.
        SELECT SINGLE fakwr fproz INTO (lv_fakwr_use, lv_fproz_use) FROM fplt
          WHERE fplnr = lv_fplnr_use AND
                fpltr = lv_fpltr_use.
      ELSE. " NO popup... we can just take the values of the only valid billing plan item
        lv_fpltr_use = lv_fpltr.
        lv_fplnr_use = lv_fplnr.
        SELECT SINGLE fakwr fproz INTO (lv_fakwr_use, lv_fproz_use) FROM fplt
          WHERE fplnr = lv_fplnr_use
            AND fpltr = lv_fpltr_use.
      ENDIF.
    ENDIF. " vbtyp = 'B'

  ENDIF.
* End of insert MOD-003

*insert for confirmations: get the quotation nr
  DATA: l_vbelv LIKE vbfa-vbelv.
  IF nast-kschl = 'ZOC2' OR nast-kschl = 'ZOC3'.
    SELECT SINGLE vbelv INTO l_vbelv FROM vbfa WHERE vbeln = nast-objky
                                                 AND vbtyp_v = 'B'.
    nast-objky =  l_vbelv.
  ENDIF.


*end insert


  CLEAR retcode.
  xscreen = us_screen.
*  PERFORM PROCESSING.
  PERFORM processing_sf  USING us_screen
                      CHANGING lf_retcode.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM processing.

  PERFORM get_data.
  CHECK retcode = 0.
  PERFORM form_open USING xscreen vbdka-land1.
  CHECK retcode = 0.
  PERFORM form_title_print.
  CHECK retcode = 0.
  PERFORM validity_print.
  CHECK retcode = 0.
  PERFORM header_data_print.
  CHECK retcode = 0.
  PERFORM header_serv_print.
  CHECK retcode = 0.
  PERFORM header_notice_print.
  CHECK retcode = 0.
  PERFORM header_inter_print.
  CHECK retcode = 0.
  PERFORM header_text_print.
  CHECK retcode = 0.
  PERFORM item_print.
  CHECK retcode = 0.
  PERFORM end_print.
  CHECK retcode = 0.
  PERFORM form_close.
  CHECK retcode = 0.

ENDFORM.                    "PROCESSING

***********************************************************************
*       S U B R O U T I N E S                                         *
***********************************************************************

*---------------------------------------------------------------------*
*       FORM ALTERNATIVE_ITEM                                         *
*---------------------------------------------------------------------*
*       A text is printed, if the item is an alternative item.        *
*---------------------------------------------------------------------*

FORM alternative_item.

  CHECK vbdpa-grpos CN '0'.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ALTERNATIVE_ITEM'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ALTERNATIVE_ITEM

*---------------------------------------------------------------------*
*       FORM CHECK_REPEAT                                             *
*---------------------------------------------------------------------*
*       A text is printed, if it is a repeat print for the document.  *
*---------------------------------------------------------------------*

FORM check_repeat.

  CLEAR repeat.
  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'.
    CHECK *nast-vstat = '1'.
    repeat = 'X'.
    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT

*---------------------------------------------------------------------*
*       FORM DELIVERY_DATE                                            *
*---------------------------------------------------------------------*
*       If the delivery date in the item is different to the header   *
*       date and there are no scheduled quantities, the delivery date *
*       is printed in the item block.                                 *
*---------------------------------------------------------------------*

FORM delivery_date.

  IF vbdka-lfdat =  space AND
     vbdpa-lfdat NE space AND
     vbdpa-etenr_da = space.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'ITEM_DELIVERY_DATE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                    "DELIVERY_DATE

*---------------------------------------------------------------------*
*       FORM DIFFERENT_CONSIGNEE                                      *
*---------------------------------------------------------------------*
*       If the consignee in the item is different to the header con-  *
*       signee, it is printed by this routine.                        *
*---------------------------------------------------------------------*

FORM different_consignee.

  CHECK vbdka-name1_we NE vbdpa-name1_we
    OR  vbdka-name2_we NE vbdpa-name2_we
    OR  vbdka-name3_we NE vbdpa-name3_we
    OR  vbdka-name4_we NE vbdpa-name4_we.
  CHECK vbdpa-name1_we NE space
    OR  vbdpa-name2_we NE space
    OR  vbdpa-name3_we NE space
    OR  vbdpa-name4_we NE space.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_CONSIGNEE'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "DIFFERENT_CONSIGNEE

*---------------------------------------------------------------------*
*       FORM DIFFERENT_REFERENCE_NO                                   *
*---------------------------------------------------------------------*
*       If the reference number in the item is different to the header*
*       reference number, it is printed by this routine.              *
*---------------------------------------------------------------------*

FORM different_reference_no.

  CHECK vbdpa-vbeln_vang NE vbdka-vbeln_vang
    OR  vbdpa-vbtyp_vang NE vbdka-vbtyp_vang.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_REFERENCE_NO'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "DIFFERENT_REFERENCE_NO

*---------------------------------------------------------------------*
*       FORM DIFFERENT_TERMS                                          *
*---------------------------------------------------------------------*
*       If the terms in the item are different to the header terms,   *
*       they are printed by this routine.                             *
*---------------------------------------------------------------------*
FORM different_terms.

  DATA: us_vposn   LIKE vedpa-vposn.
  DATA: us_text(1) TYPE c.             "Flag for Noticetext was printed

  IF vbdpa-zterm NE vbdka-zterm AND
     vbdpa-zterm NE space.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'ITEM_TERMS_OF_PAYMENT'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.
  IF vbdpa-inco1 NE space.
    IF vbdpa-inco1 NE vbdka-inco1 OR
       vbdpa-inco2 NE vbdka-inco2.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_TERMS_OF_DELIVERY'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDIF.

* Print different validity-data for the position
  READ TABLE tkomservp WITH KEY vbdpa-posnr.
  IF sy-subrc EQ 0.
    vedpa = tkomservp.
    IF vedpa-vbegdat NE space       AND
       vedpa-venddat NE space       AND
       NOT vedpa-vbegdat IS INITIAL AND
       NOT vedpa-venddat IS INITIAL.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_TERMS_OF_SERV1'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSEIF vedpa-vbegdat NE space AND
           NOT vedpa-vbegdat IS INITIAL.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_TERMS_OF_SERV2'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_TERMS_OF_SERV3'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDIF.

* Notice-rules for the positions.
  MOVE vbdpa-posnr TO us_vposn.
  CLEAR us_text.
  LOOP AT tkomservpn WHERE vposn = us_vposn.
    vedpn = tkomservpn.
    IF us_text IS INITIAL.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_TERMS_OF_NOTTXT'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      us_text = charx.
    ENDIF.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'ITEM_TERMS_OF_NOTICE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDLOOP.
  IF NOT us_text IS INITIAL.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'EMPTY_LINE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                    "DIFFERENT_TERMS

*---------------------------------------------------------------------*
*       FORM END_PRINT                                                *
*---------------------------------------------------------------------*
*                                                                     *
*---------------------------------------------------------------------*

FORM end_print.

  PERFORM get_header_prices.

  CALL FUNCTION 'CONTROL_FORM'
    EXPORTING
      command = 'PROTECT'.

  PERFORM header_price_print.

  IF NOT price_print_mode EQ chara.
* Pricing data init
    CALL FUNCTION 'RV_PRICE_PRINT_GET_BUFFER'
      EXPORTING
        i_init   = charx
      TABLES
        t_tkomv  = tkomv
        t_tkomvd = tkomvd.

  ENDIF.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'END_VALUES'.
  CALL FUNCTION 'CONTROL_FORM'
    EXPORTING
      command = 'ENDPROTECT'.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'SUPPLEMENT_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "END_PRINT

*---------------------------------------------------------------------*
*       FORM FORM_CLOSE                                               *
*---------------------------------------------------------------------*
*       End of printing the form                                      *
*---------------------------------------------------------------------*

FORM form_close.

  DATA da_clear_vbeln(1) TYPE c.

* bei Druckansicht im Anlegen gibt es noch keine Belegnummer - f¨¹r die
* Anzeige tempor#re Belegnummer ¨¹bergeben und danach zur¨¹cknehmen, damit
* Folgeverarbeitung noch funktioniert
  IF vbdka-vbeln IS INITIAL.
    da_clear_vbeln = charx.
    vbdka-vbeln = '$000000001'.
  ENDIF.

  CALL FUNCTION 'CLOSE_FORM'
    EXCEPTIONS
      OTHERS = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
    retcode = 1.
  ENDIF.
  SET COUNTRY space.

  IF da_clear_vbeln EQ charx.
    CLEAR vbdka-vbeln.
  ENDIF.

ENDFORM.                    "FORM_CLOSE

*---------------------------------------------------------------------*
*       FORM FORM_OPEN                                                *
*---------------------------------------------------------------------*
*       Start of printing the form                                    *
*---------------------------------------------------------------------*
*  -->  US_SCREEN  Output on screen                                   *
*                  ' ' = printer                                      *
*                  'X' = screen                                       *
*  -->  US_COUNTRY County for telecommunication and SET COUNTRY       *
*---------------------------------------------------------------------*

FORM form_open USING us_screen TYPE c
                     us_country TYPE c.

* Send confirmation to user who send the document.
  IF  nast-nacha EQ '2'.
    nast-usnam = vbdka-ernam.
*  get fax country key
    IF nast-teltx IS INITIAL AND nast-manue NE 'X'.
      PERFORM get_fax_land USING nast-tland.
    ENDIF.
  ENDIF.

  INCLUDE rvadopfo.

ENDFORM.                    "FORM_OPEN

*---------------------------------------------------------------------*
*       FORM FORM_TITLE_PRINT                                         *
*---------------------------------------------------------------------*
*       Printing of the form title depending of the field VBTYP       *
*---------------------------------------------------------------------*

FORM form_title_print.

  CASE vbdka-vbtyp.
    WHEN 'A'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_A'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'B'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_B'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'C'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_C'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'E'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_E'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'F'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_F'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'G'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_F'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'H'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_H'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'K'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_K'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN 'L'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_L'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    WHEN OTHERS.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TITLE_OTHERS'
          window  = 'TITLE'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
  ENDCASE.
  IF repeat NE space.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'REPEAT'
        window  = 'REPEAT'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                    "FORM_TITLE_PRINT

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*

FORM get_data.

  DATA: us_veda_vbeln     LIKE veda-vbeln.
  DATA: us_veda_posnr_low LIKE veda-vposn.

  DATA: da_mess LIKE vbfs OCCURS 0 WITH HEADER LINE.

  CALL FUNCTION 'RV_PRICE_PRINT_GET_MODE'
    IMPORTING
      e_print_mode = price_print_mode.

  IF price_print_mode EQ chara.
*    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
*      TABLES
*        tkomv = tkomv.
    REFRESH tkomv.
    CLEAR tkomv.
  ENDIF.

  CLEAR komk.
  CLEAR komp.

  vbco3-mandt = sy-mandt.
  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DOCUMENT_PRINT_VIEW'
    EXPORTING
      comwa                       = vbco3
    IMPORTING
      kopf                        = vbdka
    TABLES
      pos                         = tvbdpa
      mess                        = da_mess
    EXCEPTIONS
      fehler_bei_datenbeschaffung = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
    retcode = 1.
    EXIT.
  ELSE.
    LOOP AT da_mess.
      sy-msgid = da_mess-msgid.
      sy-msgno = da_mess-msgno.
      sy-msgty = da_mess-msgty.
      sy-msgv1 = da_mess-msgv1.
      sy-msgv2 = da_mess-msgv2.
      sy-msgv3 = da_mess-msgv3.
      sy-msgv4 = da_mess-msgv4.
      PERFORM protocol_update.
    ENDLOOP.
  ENDIF.

* fill address key --> necessary for emails
  addr_key-addrnumber = vbdka-adrnr.
  addr_key-persnumber = vbdka-adrnp.
  addr_key-addr_type  = vbdka-address_type.

* Fetch servicecontract-data and notice-data for head and position.
  us_veda_vbeln     = vbdka-vbeln.
  us_veda_posnr_low = posnr_low.
  CALL FUNCTION 'SD_VEDA_GET_PRINT_DATA'
    EXPORTING
      i_document_number = us_veda_vbeln
      i_language        = sy-langu
      i_posnr_low       = us_veda_posnr_low
    TABLES
      print_data_pos    = tkomservp
      print_data_head   = tkomservh
      print_notice_pos  = tkomservpn
      print_notice_head = tkomservhn.

  PERFORM get_controll_data.

  PERFORM sender.
  PERFORM check_repeat.
  PERFORM tvbdpau_create.

ENDFORM.                    "GET_DATA

*---------------------------------------------------------------------*
*       FORM GET_ITEM_BILLING_SCHEDULES                               *
*---------------------------------------------------------------------*
*       In this routine the billing schedules are fetched from the    *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM get_item_billing_schedules.

  REFRESH tfpltdr.
  CHECK NOT vbdpa-fplnr IS INITIAL.

  CALL FUNCTION 'BILLING_SCHED_PRINTVIEW_READ'
    EXPORTING
      i_fplnr    = vbdpa-fplnr
      i_language = nast-spras
      i_vbeln    = vbdka-vbeln
    TABLES
      zfpltdr    = tfpltdr.

ENDFORM.                    "GET_ITEM_BILLING_SCHEDULES

*&---------------------------------------------------------------------*
*&      Form  ITEM_BILLING_SCHEDULES_PRINT
*&---------------------------------------------------------------------*
*       This routine prints the billing shedules of a salesdocument    *
*       position.                                                      *
*----------------------------------------------------------------------*
FORM  item_billing_schedules_print.

  DATA: first_line(1) TYPE c.

  first_line = charx.
  LOOP AT tfpltdr.
    fpltdr = tfpltdr.
*   Output of the following printlines
    IF NOT fpltdr-perio IS INITIAL.
*     periodische Fakturen
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_BILLING_SCHEDULE_PERIODIC'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
*     bei periodischen nur eine Zeile
      EXIT.
    ELSEIF fpltdr-fareg CA '14'.
*     prozentuale Teilfakturierung
      IF NOT first_line IS INITIAL.
        CLEAR first_line.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_BILLING_SCHEDULE_PERCENT_HEADER'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_BILLING_SCHEDULE_PERCENT'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ELSEIF fpltdr-fareg CA '235'.
*     wertm##ige  Teilfakturierung
      IF NOT first_line IS INITIAL.
        CLEAR first_line.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_BILLING_SCHEDULE_VALUE_HEADER'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_BILLING_SCHEDULE_VALUE'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ELSEIF fpltdr-fareg CA '3'.
*     Schlu#rechnung
    ENDIF.
  ENDLOOP.
ENDFORM.                    "ITEM_BILLING_SCHEDULES_PRINT
*eject

*&---------------------------------------------------------------------*
*&      FORM  GET_ITEM_ADDIS
*&---------------------------------------------------------------------*
*       Additionals data are fetched from database
*----------------------------------------------------------------------*
FORM get_item_addis.

  CLEAR: taddi_print.

  CALL FUNCTION 'WTAD_ADDIS_IN_SO_PRINT'
       EXPORTING
            fi_vbeln              = vbdka-vbeln
            fi_posnr              = vbdpa-posnr
*           FI_LANGUAGE           = SY-LANGU
       TABLES
            fet_addis_in_so_print = taddi_print
       EXCEPTIONS
            addis_not_active      = 1
            no_addis_for_so_item  = 2
            OTHERS                = 3.

ENDFORM.                               " GET_ITEM_ADDIS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS                                 *
*---------------------------------------------------------------------*
*       In this routine the configuration data item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_characteristics.

  DATA da_t_cabn LIKE cabn OCCURS 10 WITH HEADER LINE.
  DATA: BEGIN OF da_key,
          mandt LIKE cabn-mandt,
          atinn LIKE cabn-atinn,
        END   OF da_key.

  REFRESH tkomcon.
  CHECK NOT vbdpa-cuobj IS INITIAL AND
            vbdpa-attyp NE var_typ.

  CALL FUNCTION 'VC_I_GET_CONFIGURATION'
    EXPORTING
      instance      = vbdpa-cuobj
      language      = nast-spras
      print_sales   = charx
    TABLES
      configuration = tkomcon
    EXCEPTIONS
      OTHERS        = 4.

  RANGES : da_in_cabn FOR da_t_cabn-atinn.
* Beschreibung der Merkmale wegen Objektmerkmalen auf sdcom-vkond holen
  CLEAR da_in_cabn. REFRESH da_in_cabn.
  LOOP AT tkomcon.
    da_in_cabn-option = 'EQ'.
    da_in_cabn-sign   = 'I'.
    da_in_cabn-low    = tkomcon-atinn.
    APPEND da_in_cabn.
  ENDLOOP.

  CLEAR da_t_cabn. REFRESH da_t_cabn.
  CALL FUNCTION 'CLSE_SELECT_CABN'
*    EXPORTING
*         KEY_DATE                     = SY-DATUM
*         BYPASSING_BUFFER             = ' '
*         WITH_PREPARED_PATTERN        = ' '
*         I_AENNR                      = ' '
*    IMPORTING
*         AMBIGUOUS_OBJ_CHARACTERISTIC =
     TABLES
          in_cabn                      = da_in_cabn
          t_cabn                       = da_t_cabn
     EXCEPTIONS
          no_entry_found               = 1
          OTHERS                       = 2.

* Preisfindungsmerkmale / Merkmale auf VCSD_UPDATE herausnehmen
  SORT da_t_cabn.
  LOOP AT tkomcon.
    da_key-mandt = sy-mandt.
    da_key-atinn = tkomcon-atinn.
    READ TABLE da_t_cabn WITH KEY da_key BINARY SEARCH.
    IF sy-subrc <> 0 OR
       ( ( da_t_cabn-attab = 'SDCOM' AND
          da_t_cabn-atfel = 'VKOND'       ) OR
        ( da_t_cabn-attab = 'VCSD_UPDATE' ) ) .
      DELETE tkomcon.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_PRICES                                          *
*---------------------------------------------------------------------*
*       In this routine the price data for the item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_prices.

  CLEAR: komp,
         tkomv.

  IF komk-knumv NE vbdka-knumv OR
     komk-knumv IS INITIAL.
    CLEAR komk.
    komk-mandt = sy-mandt.
    komk-kalsm = vbdka-kalsm.
    komk-kappl = pr_kappl.
    komk-waerk = vbdka-waerk.
    komk-knumv = vbdka-knumv.
    komk-knuma = vbdka-knuma.
    komk-vbtyp = vbdka-vbtyp.
    komk-land1 = vbdka-land1.
    komk-vkorg = vbdka-vkorg.
    komk-vtweg = vbdka-vtweg.
    komk-spart = vbdka-spart.
    komk-bukrs = vbdka-bukrs_vf.
    komk-hwaer = vbdka-waers.
    komk-prsdt = vbdka-erdat.
    komk-kurst = vbdka-kurst.
    komk-kurrf = vbdka-kurrf.
    komk-kurrf_dat = vbdka-kurrf_dat.
  ENDIF.
  komp-kposn = vbdpa-posnr.
  komp-kursk = vbdpa-kursk.
  komp-kursk_dat = vbdpa-kursk_dat.
  IF vbdka-vbtyp CA 'HKNOT6'.
    IF vbdpa-shkzg CA ' A'.
      komp-shkzg = 'X'.
    ENDIF.
  ELSE.
    IF vbdpa-shkzg CA 'BX'.
      komp-shkzg = 'X'.
    ENDIF.
  ENDIF.

*>>>air22296

  DATA: komkh LIKE  komkh,
        komph LIKE  komph.

  CLEAR: komkh, komph.
  CALL FUNCTION 'SD_DOCUMENT_GET_KOMKH_KOMPH'
    EXPORTING
      i_vbeln                   = vbdka-vbeln
      i_posnr                   = vbdpa-posnr
      i_komkh                   = komkh
      i_komph                   = komph
*   I_ANREICHERN              = ' '
   IMPORTING
     e_komkh                   = komkh
     e_komph                   = komph
*   E_KNUMH                   =
*   E_CUOBJ_CH                =
*   E_LFDAT                   =
 EXCEPTIONS
   document_not_found        = 1
   item_not_found            = 2
   item_number_missing       = 3
   OTHERS                    = 4
            .
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  MOVE-CORRESPONDING komph TO komp.
  MOVE-CORRESPONDING komkh TO komk.
*<<<<

  IF price_print_mode EQ chara.
    CALL FUNCTION 'RV_PRICE_PRINT_ITEM'
      EXPORTING
        comm_head_i = komk
        comm_item_i = komp
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
        comm_item_e = komp
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ELSE.
    CALL FUNCTION 'RV_PRICE_PRINT_ITEM_BUFFER'
      EXPORTING
        comm_head_i = komk
        comm_item_i = komp
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
        comm_item_e = komp
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ENDIF.

ENDFORM.                    "GET_ITEM_PRICES

*---------------------------------------------------------------------*
*       FORM GET_HEADER_PRICES                                        *
*---------------------------------------------------------------------*
*       In this routine the price data for the header is fetched from *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_header_prices.

  LOOP AT tvbdpa.

    CALL FUNCTION 'SD_TAX_CODE_MAINTAIN'
      EXPORTING
        key_knumv           = vbdka-knumv
        key_kposn           = tvbdpa-posnr
        i_application       = ' '
        i_pricing_procedure = vbdka-kalsm
      TABLES
        xkomv               = tkomv.


  ENDLOOP.

  IF price_print_mode EQ chara.

    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
      TABLES
        tkomv = tkomv.

    CALL FUNCTION 'RV_PRICE_PRINT_HEAD'
      EXPORTING
        comm_head_i = komk
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ELSE.
    CALL FUNCTION 'RV_PRICE_PRINT_HEAD_BUFFER'
      EXPORTING
        comm_head_i = komk
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ENDIF.

ENDFORM.                    "GET_HEADER_PRICES

*&---------------------------------------------------------------------*
*&      Form  HEADER_DATA_PRINT
*&---------------------------------------------------------------------*
*       Printing of header data like terms, weights ....               *
*----------------------------------------------------------------------*

FORM header_data_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_DATA'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                               " HEADER_DATA_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_PRICE_PRINT                                       *
*---------------------------------------------------------------------*
*       Printout of the header prices                                 *
*---------------------------------------------------------------------*

FORM header_price_print.

  LOOP AT tkomvd.

    AT FIRST.
      IF komk-supos NE 0.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_SUM'.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'UNDER_LINE'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ENDAT.

    komvd = tkomvd.
    IF komvd-koaid = 'D'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TAX_LINE'.
    ELSE.
      IF NOT komvd-kntyp EQ 'f'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'SUM_LINE'.
      ENDIF.
    ENDIF.
  ENDLOOP.
  DESCRIBE TABLE tkomvd LINES sy-tfill.
  IF sy-tfill = 0.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'UNDER_LINE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                    "HEADER_PRICE_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_TEXT_PRINT                                        *
*---------------------------------------------------------------------*
*       Printout of the headertexts                                   *
*---------------------------------------------------------------------*

FORM header_text_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "HEADER_TEXT_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_BILLING_CORRECTION_HEADER                          *
*---------------------------------------------------------------------*
*       In the case of a billing correction, the header of the item   *
*       debit memo / credit memo position, is printed by this routine *
*---------------------------------------------------------------------*

FORM item_billing_correction_header USING us_ganf TYPE c
                                          us_lanf TYPE c.


  CHECK vbdka-vbklt EQ vbklt_rech_korr.

  IF vbdka-vbtyp = vbtyp_ganf.
*   Gutschriftsanforderung
    IF vbdpa-shkzg = charx.
      IF us_ganf IS INITIAL.
        MOVE charx TO us_ganf.
        MOVE space TO us_lanf.

        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'CORRECTION_TEXT_K'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ELSE.
      IF us_lanf IS INITIAL.
        MOVE charx TO us_lanf.
        MOVE space TO us_ganf.

        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'CORRECTION_TEXT_L'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  IF vbdka-vbtyp = vbtyp_lanf.
*   Lastschriftssanforderung
    IF vbdpa-shkzg = space.
      IF us_lanf IS INITIAL.
        MOVE charx TO us_lanf.
        MOVE space TO us_ganf.

        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'CORRECTION_TEXT_L'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ELSE.
      IF us_ganf IS INITIAL.
        MOVE charx TO us_ganf.
        MOVE space TO us_lanf.

        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'CORRECTION_TEXT_K'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    "ITEM_BILLING_CORRECTION_HEADER
*&---------------------------------------------------------------------*
*&      Form  ITEM_ADDIS_PRINT
*&---------------------------------------------------------------------*
*       Printout of item additionals
*----------------------------------------------------------------------*
FORM item_addis_print.

  LOOP AT taddi_print.
    MOVE-CORRESPONDING taddi_print TO wtad_addis_in_so_print.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'ITEM_ADDI_SO_INFO'
      EXCEPTIONS
        OTHERS  = 1.
    LOOP AT taddi_print-addi_so_extra_text_info
            INTO wtad_buying_print_extra_text.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_ADDI_EXTRA_TEXT'
        EXCEPTIONS
          OTHERS  = 1.
    ENDLOOP.
  ENDLOOP.

ENDFORM.                               " ITEM_ADDIS_PRINT
*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_PRINT                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics -> configuration         *
*---------------------------------------------------------------------*

FORM item_characteristics_print.

  LOOP AT tkomcon.
    conf_out = tkomcon.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_DELIVERY_CONFIRMATION                               *
*---------------------------------------------------------------------*
*       If the delivery date is not confirmed, a text is printed      *
*---------------------------------------------------------------------*

FORM item_delivery_confirmation.

  CHECK vbdka-vbtyp NE vbtyp_ganf AND vbdka-vbtyp NE vbtyp_lanf.
  CHECK vbdpa-lfdat = space.
  CHECK vbdpa-kwmeng NE 0.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_DELIVERY_CONFIRMATION'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_DELIVERY_CONFIRMATION
*---------------------------------------------------------------------*
*       FORM ITEM_AGREED_DELIVERY_TIME                                *
*---------------------------------------------------------------------*
*       If an agreed delivery time and the corresponding text is      *
*       available on item level, the text is printed                  *
*---------------------------------------------------------------------*

FORM item_agreed_delivery_time.

  CHECK vbdka-vbtyp EQ 'B' OR vbdka-vbtyp EQ 'G'.
  CHECK vbdpa-delco NE space AND vbdpa-delco_bez NE space.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_AGREED_DELIVERY_TIME'
    EXCEPTIONS
      element = 1
      window  = 2.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_AGREED_DELIVERY_TIME

*---------------------------------------------------------------------*
*       FORM ITEM_PRICE_PRINT                                         *
*---------------------------------------------------------------------*
*       Printout of the item prices                                   *
*---------------------------------------------------------------------*

FORM item_price_print.

  LOOP AT tkomvd.
    komvd = tkomvd.
    IF sy-tabix = 1 AND
     ( komvd-koaid = charb OR
       komvd-kschl = space ).
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_PRICE_QUANTITY'.
    ELSE.
      IF komvd-kntyp NE 'f'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_LINE_PRICE_TEXT'.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_LINE_REBATE_IN_KIND'.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_PRICE_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_PRINT                                               *
*---------------------------------------------------------------------*
*       Printout of the items                                         *
*---------------------------------------------------------------------*

FORM item_print.

  DATA: da_subrc LIKE sy-subrc,
        da_dragr LIKE tvag-dragr.
  DATA: da_ganf(1) TYPE c,      "Print flag for billing correction
        da_lanf(1) TYPE c.      "Print flag for billing correction

  CALL FUNCTION 'WRITE_FORM'           "First header
       EXPORTING  element = 'ITEM_HEADER'
       EXCEPTIONS OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.
  CALL FUNCTION 'WRITE_FORM'           "Activate header
       EXPORTING  element = 'ITEM_HEADER'
                  type    = 'TOP'
       EXCEPTIONS OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

  LOOP AT tvbdpa.
    vbdpa = tvbdpa.

    IF vbdpa-dragr EQ space.           "Print rejected item?
      IF vbdpa-posnr_neu NE space.     "Item
        PERFORM item_billing_correction_header USING da_ganf da_lanf.
        PERFORM get_item_serials.
        PERFORM get_item_characteristics.
        PERFORM get_item_billing_schedules.
        PERFORM get_item_prices.
        PERFORM get_item_addis.
        CALL FUNCTION 'CONTROL_FORM'
          EXPORTING
            command = 'ENDPROTECT'.
        CALL FUNCTION 'CONTROL_FORM'
          EXPORTING
            command = 'PROTECT'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_LINE'.
        PERFORM item_rejected.
        PERFORM item_price_print.
        CALL FUNCTION 'CONTROL_FORM'
          EXPORTING
            command = 'ENDPROTECT'.
        PERFORM item_text_print.
        PERFORM item_serials_print.
        PERFORM item_characteristics_print.
        PERFORM item_addis_print.
        PERFORM item_reference_billing.
        PERFORM alternative_item.
        PERFORM delivery_date.
        PERFORM item_delivery_confirmation.
        PERFORM item_agreed_delivery_time.
        PERFORM item_billing_schedules_print.
        PERFORM different_reference_no.
        PERFORM different_terms.
        PERFORM different_consignee.
        PERFORM schedule_header.
        PERFORM main_item.
      ELSE.
        PERFORM schedule_print.
      ENDIF.
    ENDIF.
  ENDLOOP.

  CALL FUNCTION 'WRITE_FORM'           "Deactivate Header
       EXPORTING  element  = 'ITEM_HEADER'
                  function = 'DELETE'
                  type     = 'TOP'
       EXCEPTIONS OTHERS   = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_PRINT
*---------------------------------------------------------------------*
*       FORM ITEM_REFERENCE_BILLING                                  *
*---------------------------------------------------------------------*
*       If the reference number of the billing is printed by this     *
*       routine. In case (debit memo / credit memo)                   *
*---------------------------------------------------------------------*

FORM item_reference_billing.

  CHECK vbdka-vbklt EQ vbklt_rech_korr.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_REFERENCE_BILLING'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_REFERENCE_BILLING


*---------------------------------------------------------------------*
*       FORM ITEM_REJECTED                                            *
*---------------------------------------------------------------------*
*       A text is printed, if the item is rejected                    *
*---------------------------------------------------------------------*

FORM item_rejected.

  CHECK NOT vbdpa-abgru IS INITIAL.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_REJECTED'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_REJECTED

*---------------------------------------------------------------------*
*       FORM MAIN_ITEM                                                *
*---------------------------------------------------------------------*
*       A text is printed, if the item is a main item                 *
*---------------------------------------------------------------------*

FORM main_item.

  LOOP AT tvbdpau INTO vbdpau
                  WHERE posnr EQ vbdpa-posnr.
    IF vbdpau-uposb IS INITIAL.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ONE_SUBITEM'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'SEVERAL_SUBITEMS'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "MAIN_ITEM

*---------------------------------------------------------------------*
*       FORM ITEM_TEXT_PRINT                                          *
*---------------------------------------------------------------------*
*       Printout of the item texts                                    *
*---------------------------------------------------------------------*

FORM item_text_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_TEXT_PRINT

*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*

FORM protocol_update.

  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE

*---------------------------------------------------------------------*
*       FORM SCHEDULE_HEADER                                          *
*---------------------------------------------------------------------*
*       If there are schedules in the item, then here is printed the  *
*       header for the schedules.                                     *
*---------------------------------------------------------------------*

FORM schedule_header.

  CHECK vbdpa-etenr_da NE space.
  CALL FUNCTION 'CONTROL_FORM'
    EXPORTING
      command = 'PROTECT'.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_SCHEDULE_HEADER'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SCHEDULE_HEADER

*---------------------------------------------------------------------*
*       FORM SCHEDULE_PRINT                                           *
*---------------------------------------------------------------------*
*       This routine prints the schedules for an item.                *
*---------------------------------------------------------------------*

FORM schedule_print.

  CHECK vbdpa-lfrel EQ 'X'.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_SCHEDULE_PRINT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SCHEDULE_PRINT

*---------------------------------------------------------------------*
*       FORM SENDER                                                   *
*---------------------------------------------------------------------*
*       This routine determines the address of the sender (Table VKO) *
*---------------------------------------------------------------------*

FORM sender.

  SELECT SINGLE * FROM tvko  WHERE vkorg = vbdka-vkorg.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'TVKO'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
    EXIT.
  ENDIF.

  CLEAR gv_fb_addr_get_selection.
  gv_fb_addr_get_selection-addrnumber = tvko-adrnr.         "SADR40A
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = gv_fb_addr_get_selection
      address_group     = 'CA01'
    IMPORTING
      sadr              = sadr
    EXCEPTIONS
      OTHERS            = 01.
  IF sy-subrc NE 0.
    CLEAR sadr.
  ENDIF.                                                    "SADR40A
  vbdka-sland = sadr-land1.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'SADR'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.
*  SELECT SINGLE * FROM TVBUR  WHERE VKBUR = VBDKA-VKBUR.
*  IF SY-SUBRC NE 0.
*    SYST-MSGID = 'VN'.
*    SYST-MSGNO = '203'.
*    SYST-MSGTY = 'E'.
*    SYST-MSGV1 = 'TVBUR'.
*    SYST-MSGV2 = SYST-SUBRC.
*    PERFORM PROTOCOL_UPDATE.
*  ENDIF.

ENDFORM.                    "SENDER

*---------------------------------------------------------------------*
*       FORM TVBDPAU_CREATE                                           *
*---------------------------------------------------------------------*
*       This routine is creating a table which includes the subitem-  *
*       numbers                                                       *
*---------------------------------------------------------------------*

FORM tvbdpau_create.

  CLEAR tvbdpau.
  REFRESH tvbdpau.
  LOOP AT tvbdpa.
    IF tvbdpa-uepos IS INITIAL OR
       tvbdpa-uepos NE tvbdpau-posnr.
* Append work area to internal table TVBDPAU
      IF tvbdpau-uposv > 0.
        APPEND tvbdpau.
        CLEAR tvbdpau.
      ENDIF.
* Start filling new work area
      tvbdpau-posnr = tvbdpa-posnr.

      IF NOT tvbdpa-uepos IS INITIAL AND
         tvbdpa-uepos NE tvbdpau-posnr.
        tvbdpau-posnr = tvbdpa-uepos.
        tvbdpau-uepvw = tvbdpa-uepvw.
        tvbdpau-uposv = tvbdpa-posnr.
      ENDIF.

    ELSE.
      IF tvbdpau-uposv IS INITIAL OR
         tvbdpau-uposv > tvbdpa-posnr.
        tvbdpau-uposv = tvbdpa-posnr.
      ENDIF.
      IF tvbdpau-uposb < tvbdpa-posnr AND
         tvbdpau-uposv < tvbdpa-posnr.
        tvbdpau-uposb = tvbdpa-posnr.
      ENDIF.
      tvbdpau-uepvw = tvbdpa-uepvw.    "UPOS-Verwendung
    ENDIF.
  ENDLOOP.
  IF tvbdpau-uposv > 0.
    APPEND tvbdpau.
  ENDIF.
  SORT tvbdpau.

ENDFORM.                    "TVBDPAU_CREATE

*---------------------------------------------------------------------*
*       FORM VALIDITY_PRINT                                           *
*---------------------------------------------------------------------*
*       This routine is printing the period of validity for offers    *
*       and contracts                                                 *
*---------------------------------------------------------------------*

FORM validity_print.

  CHECK steu-vdkex EQ space.
  CASE vbdka-vbtyp.
    WHEN 'B'.
      IF vbdka-angdt CN '0' OR
         vbdka-bnddt CN '0'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'VALIDITY_OFFER'
            window  = 'VALIDITY'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    WHEN 'E'.
      IF vbdka-guebg CN '0' OR
         vbdka-gueen CN '0'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'VALIDITY_CONTRACT'
            window  = 'VALIDITY'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    WHEN 'F'.
      IF vbdka-guebg CN '0' OR
         vbdka-gueen CN '0'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'VALIDITY_CONTRACT'
            window  = 'VALIDITY'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    WHEN 'G'.
      IF vbdka-guebg CN '0' OR
         vbdka-gueen CN '0'.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'VALIDITY_CONTRACT'
            window  = 'VALIDITY'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
  ENDCASE.

ENDFORM.                    "VALIDITY_PRINT

*&---------------------------------------------------------------------*
*&      Form  HEADER_NOTICE_PRINT
*&---------------------------------------------------------------------*
*       This routine prints the notice-rules of the contract-header.   *
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM header_notice_print.

  DATA: us_text(1) TYPE c.
  "Kz. falls Text f¨¹r K¨¹ndigungsbed.

* K¨¹ndigungsbedingungen auf Kopfebene.
  CLEAR us_text.
  LOOP AT tkomservhn.
    vedkn = tkomservhn.
    IF us_text IS INITIAL.
*     For the first time a headertext is printed.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'HEADER_TERMS_OF_NOTTXT'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      us_text = charx.
    ENDIF.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'HEADER_TERMS_OF_NOTICE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDLOOP.
* If notice-rules exists a empty line is printed.
  IF NOT us_text IS INITIAL.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'EMPTY_LINE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                               " HEADER_NOTICE_PRINT
*eject

*&---------------------------------------------------------------------*
*&      Form  GET_ITEM_SERIALS
*&---------------------------------------------------------------------*
*       This routine give back the serialnumbers of salesdocument      *
*       position. The numbers are processed as print-lines in the      *
*       table KOMSER_PRINT.                                            *
*----------------------------------------------------------------------*
*  -->  US_VBELN  Salesdocument
*  -->  US_POSNR  Position of the salesdocument
*----------------------------------------------------------------------*
FORM get_item_serials.

  DATA: key_data LIKE rserob,
        sernos LIKE rserob OCCURS 0 WITH HEADER LINE.

  key_data-taser = 'SER02'.
  key_data-sdaufnr = vbdka-vbeln.
  key_data-posnr = vbdpa-posnr.
  IF key_data-sdaufnr IS INITIAL AND NOT
     key_data-posnr IS INITIAL.
* beim Anlegen ist Belegnummer leer - deshalb Dummy-Belegnummer
    key_data-sdaufnr = char$.
  ENDIF.

* Read the Serialnumbers of a Position.
  REFRESH: tkomser,
           tkomser_print.
  CALL FUNCTION 'GET_SERNOS_OF_DOCUMENT'
    EXPORTING
      key_data            = key_data
    TABLES
      sernos              = sernos
    EXCEPTIONS
      key_parameter_error = 1
      no_supported_access = 2
      no_data_found       = 3
      OTHERS              = 4.
  IF sy-subrc NE 0 AND
     sy-subrc NE 3.
    PERFORM protocol_update.
  ENDIF.

  CHECK sy-subrc EQ 0.
* Serialnummern ¨¹bergeben
  tkomser-vbeln = sernos-sdaufnr.
  tkomser-posnr = sernos-posnr.
  LOOP AT sernos.
    tkomser-sernr = sernos-sernr.
    APPEND tkomser.
  ENDLOOP.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
    EXPORTING
      i_boundary_left             = '(_'
      i_boundary_right            = '_)'
      i_sep_char_strings          = ',_'
      i_sep_char_interval         = '_-_'
      i_use_interval              = 'X'
      i_boundary_method           = 'C'
      i_line_length               = 50
      i_no_zero                   = 'X'
      i_alphabet                  = sy-abcde
      i_digits                    = '0123456789'
      i_special_chars             = '-'
      i_with_second_digit         = ' '
    TABLES
      serials                     = tkomser
      serials_print               = tkomser_print
    EXCEPTIONS
      boundary_missing            = 01
      interval_separation_missing = 02
      length_to_small             = 03
      internal_error              = 04
      wrong_method                = 05
      wrong_serial                = 06
      two_equal_serials           = 07
      serial_with_wrong_char      = 08
      serial_separation_missing   = 09.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.


ENDFORM.                               " GET_ITEM_SERIALS
*eject


*&---------------------------------------------------------------------*
*&      Form  ITEM_SERIALS_PRINT
*&---------------------------------------------------------------------*
*       This routine prints the serialnumbers of a salesdocument       *
*       position.                                                      *
*----------------------------------------------------------------------*
FORM item_serials_print.

  DATA: first_line(1) TYPE c.

  first_line = charx.
  LOOP AT tkomser_print.
    komser = tkomser_print.
    IF NOT first_line IS INITIAL.
*     Output of the Headerline
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_HEADER'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      CLEAR first_line.
    ELSE.
*     Output of the following printlines
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.
* If serialnumbers exists a empty line is printed.
  IF first_line IS INITIAL.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'EMPTY_LINE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                               " ITEM_SERIALS_PRINT
*eject


*&---------------------------------------------------------------------*
*&      Form  HEADER_INTER_PRINT
*&---------------------------------------------------------------------*
*       Prints the message that if other condition for the positions   *
*       exists they are printed there.                                 *
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM header_inter_print.

  CHECK NOT steu-vdkex IS INITIAL.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_TERMS_OF_TXTEND'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                               " HEADER_INTER_PRINT

*&---------------------------------------------------------------------*
*&      Form  GET_CONTROLL_DATA
*&---------------------------------------------------------------------*
*       Checks if servicedata for the header exists.                   *
*       Checks if servicedata for the position exists.                 *
*       Checks if noticedata for the header exists.                    *
*       Checks if noticedata for the position exists.                  *
*----------------------------------------------------------------------*
FORM get_controll_data.

  DATA: lines TYPE i.

* Exists servicedata for the header?
  DESCRIBE TABLE tkomservh LINES lines.
  IF lines GT 0.
    steu-vdkex = 'X'.
  ENDIF.

* Exists servicedata for the position?
  DESCRIBE TABLE tkomservp LINES lines.
  IF lines GT 0.
    steu-vdpex = 'X'.
  ENDIF.

* Exists noticedata for the header?
  DESCRIBE TABLE tkomservhn LINES lines.
  IF lines GT 0.
    steu-kbkex = 'X'.
  ENDIF.

* Exists noticedata for the position?
  DESCRIBE TABLE tkomservpn LINES lines.
  IF lines GT 0.
    steu-kbpex = 'X'.
  ENDIF.

ENDFORM.                               " GET_CONTROLL_DATA
*eject


*&---------------------------------------------------------------------*
*&      Form  HEADER_SERV_PRINT
*&---------------------------------------------------------------------*
*       Output of the validity of a service-contract.                  *
*----------------------------------------------------------------------*
FORM header_serv_print.

  CHECK NOT steu-vdkex IS INITIAL.
  READ TABLE tkomservh INDEX 1.
  MOVE tkomservh TO vedka.

* Output of the validity.
  IF NOT vedka-venddat IS INITIAL OR
     vedka-venddat EQ space.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'HEADER_TERMS_OF_SERV1'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ELSEIF vedka-vbegdat NE space AND
         NOT vedka-vbegdat IS INITIAL.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'HEADER_TERMS_OF_SERV2'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ELSE.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'HEADER_TERMS_OF_SERV3'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                               " HEADER_SERV_PRINT

*&---------------------------------------------------------------------*
*&      Form  get_fax_land
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_NAST_TLAND  text
*----------------------------------------------------------------------*
FORM get_fax_land USING   p_nast_land LIKE nast-tland.

  DATA  l_land    LIKE nast-tland .
  CLEAR l_land.


  IF NOT addr_key-addrnumber IS INITIAL.
    CALL FUNCTION 'WFMC_FAXNUMBER_FOR_ADDRESS'
      EXPORTING
        adrnr          = addr_key-addrnumber
      IMPORTING
        tland          = l_land
      EXCEPTIONS
        addr_not_exist = 1
        OTHERS         = 2.
    IF sy-subrc = 0 AND NOT l_land IS INITIAL.
      p_nast_land = l_land.
    ENDIF.

  ENDIF.
ENDFORM.                    " get_fax_land
*&---------------------------------------------------------------------*
*&      Form  processing_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM processing_sf USING proc_screen
                   CHANGING cf_retcode.

  DATA: ls_print_data_to_read TYPE lbbil_print_data_to_read.
  DATA: ls_bil_invoice TYPE lbbil_invoice.
  DATA: lf_fm_name            TYPE rs38l_fnam.
  DATA: ls_control_param      TYPE ssfctrlop.
  DATA: ls_composer_param     TYPE ssfcompop.
  DATA: ls_recipient          TYPE swotobjid.
  DATA: ls_sender             TYPE swotobjid.
  DATA: lf_formname           TYPE tdsfname.
  DATA: ls_addr_key           LIKE addr_key.
  DATA: ls_dlv-land           LIKE vbrk-land1.
  DATA: ls_job_info           TYPE ssfcrescl.



* SmartForm from customizing table TNAPR
  lf_formname = tnapr-sform.

* determine print data
*  PERFORM set_print_data_to_read USING    lf_formname
*                                 CHANGING ls_print_data_to_read
*                                 cf_retcode.

*  IF cf_retcode = 0.
* select print data
*    PERFORM GET_DATA_NEW USING    LS_PRINT_DATA_TO_READ
*                         CHANGING LS_ADDR_KEY
*                                  LS_DLV-LAND
*                                  LS_BIL_INVOICE
*                                  CF_RETCODE.

*----------------------------------
*Get the necessary data from the quotation (see the processing perform
*for sapscripts in this program)
    PERFORM get_data_sf.

    PERFORM header_serv_print_sf.

    PERFORM item_print_sf.

*    PERFORM get_extra_data.

    PERFORM get_extra_data2.

    PERFORM get_header_prices.                              "air22296
*----------------------------------

*  ENDIF.

*  IF cf_retcode = 0.
    PERFORM set_print_param USING    ls_addr_key
                                     ls_dlv-land
                            CHANGING ls_control_param
                                     ls_composer_param
                                     ls_recipient
                                     ls_sender
                                     cf_retcode.
*  ENDIF.
*---------------------
*Remember, following fields are not filled in:
*- ls_addr_key
*- ls_dlv-land
*---------------------
*>>>air22296: for other font countries,we will pick another layout
  DATA: l_sform TYPE tdsfname,
        l_land1 TYPE land1_gp,
        l_bukrs TYPE bukrs.

  CLEAR l_land1.
*  SELECT SINGLE land1 INTO l_land1 FROM  t001
*         WHERE  bukrs  = vbdka-bukrs_vf.
*
*  CALL FUNCTION 'YSE_LAY_GET_FNAME'
*    EXPORTING
*      tnapr = tnapr
*      land1 = l_land1
*    IMPORTING
*      sform = l_sform.
*
*  IF NOT l_sform IS INITIAL.
*    lf_formname = l_sform.
*  ELSE.
*    lf_formname = tnapr-sform.
*  ENDIF.
* SmartForm from customizing table TNAPR
*  lf_formname = tnapr-sform.
*<<<air22296
*  IF cf_retcode = 0.
** determine smartform function module for invoice
*    CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
*         EXPORTING  formname           = lf_formname
**                 variant            = ' '
**                 direct_call        = ' '
*         IMPORTING  fm_name            = lf_fm_name
*         EXCEPTIONS no_form            = 1
*                    no_function_module = 2
*                    OTHERS             = 3.
*    IF sy-subrc <> 0.
**   error handling
*      cf_retcode = sy-subrc.
*      PERFORM protocol_update.
*    ENDIF.
*  ENDIF.

*  IF cf_retcode = 0.
*    PERFORM check_repeat.
*    IF ls_composer_param-tdcopies EQ 0.
*      nast_anzal = 1.
*    ELSE.
*      nast_anzal = ls_composer_param-tdcopies.
*    ENDIF.
*    ls_composer_param-tdcopies = 1.
*    DO nast_anzal TIMES.
** In case of repetition only one time archiving
*      IF sy-index > 1 AND nast-tdarmod = 3.
*        nast_tdarmod = nast-tdarmod.
*        nast-tdarmod = 1.
*        ls_composer_param-tdarmod = 1.
*      ENDIF.
*      IF sy-index NE 1 AND repeat IS INITIAL.
*        repeat = 'X'.
*      ENDIF.
* call smartform invoice

*There are more tables that we give to the function like:
*tkomservp
*tkomservh
*tkomservpn
*tkomservhn
*tkomcon
*taddi_print
*vbc03
* Begin of insert MOD-003
*      IF nast-kschl = 'ZN02'.
*        IF lv_fplnr_use IS NOT INITIAL.
*
*          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*            EXPORTING
*              input  = lv_fplnr_use
*            IMPORTING
*              output = lv_fplnr_use.
*        ENDIF.
*
*        IF lv_fpltr_use IS NOT INITIAL.
*          lv_fpltr_use2 = lv_fpltr_use.
*          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*            EXPORTING
*              input  = lv_fpltr_use2
*            IMPORTING
*              output = lv_fpltr_use2.
*        ENDIF.
*      ENDIF.
* End of insert MOD-003

*only for this project, put the language to E.  Should be removed later!
*      nast-spras = 'E'.
*      ls_control_param-langu = 'E'.

*      CALL FUNCTION lf_fm_name
*           EXPORTING
*                      archive_index        = toa_dara
*                      archive_parameters   = arc_params
*                      control_parameters   = ls_control_param
**                 mail_appl_obj        =
*                      mail_recipient       = ls_recipient
*                      mail_sender          = ls_sender
*                      output_options       = ls_composer_param
*                      user_settings        = space
**                      is_bil_invoice       = ls_bil_invoice
*                      is_nast              = nast
*                      is_repeat            = repeat
*                      vbdka                = vbdka
*                      sadr                 = sadr
*                      wa_knvk_contact      = wa_knvk_contact
*                      wa_adcp_contact      = wa_adcp_contact
*                      wa_tpfkt_contact     = wa_tpfkt_contact
*                      wa_veda              = wa_veda
*                      wa_vbak              = wa_vbak
*                      wa_vbpa_ship_to      = wa_vbpa_ship_to
*                      wa_vbpa_bill_to      = wa_vbpa_bill_to
*                      is_bil_invoice       = ls_bil_invoice
*                      wa_tvgrt             = wa_tvgrt
** begin of insert MOD-003
*                      lv_fplnr_use         = lv_fplnr_use
*                      lv_fpltr_use         = lv_fpltr_use2
*                      lv_fakwr_use         = lv_fakwr_use
*                      lv_fproz_use         = lv_fproz_use
** end of insert MOD-003
*           IMPORTING  job_output_info      = ls_job_info
**                     document_output_info =
**                     job_output_options   =
*           TABLES     tvbdpa               = tvbdpa
*                      tkomser              = tkomser
*                      tfpltdr              = tfpltdr
*                      tkomv                = tkomv
*                      tvbdpa_extra         = it_tvbdpa_extra
*           EXCEPTIONS formatting_error     = 1
*                      internal_error       = 2
*                      send_error           = 3
*                      user_canceled        = 4
*                      OTHERS               = 5.
*
*      IF sy-subrc <> 0.
**   error handling
*        cf_retcode = sy-subrc.
*        PERFORM protocol_update.
** get SmartForm protocoll and store it in the NAST protocoll
*        PERFORM add_smfrm_prot.
** begin of change MOD-003
*      ELSE.
**...... Update 'print indicator' on billing plan line when payment request is printed
*        IF nast-kschl = 'ZAM6' AND proc_screen = ' ' AND gv_vbtyp = 'B'.
*          UPDATE fplt SET faksp = 'ZP' WHERE fplnr = lv_fplnr_use
*                                         AND fpltr = lv_fpltr_use.
*        ENDIF.
** end of change MOD-003
*      ENDIF.
*    ENDDO.
** get SmartForm spoolid and store it in the NAST protocoll
*    DATA ls_spoolid LIKE LINE OF ls_job_info-spoolids.
*    LOOP AT ls_job_info-spoolids INTO ls_spoolid.
*      IF ls_spoolid NE space.
*        PERFORM protocol_update_spool USING '342' ls_spoolid
*                                            space space space.
*
**       MOD-001 - start of modification for PDF output
**        IF nast-kschl = 'ZAM5'.
*        IF nast-nacha = '8'.
**         Define variable to build suggested file name
*          DATA: lv_fname TYPE string.
**         Build suggested filename
*          CONCATENATE wa_vbak-auart
*                      '_'
*                      wa_vbak-vbeln
*                      '.pdf'
*                 INTO lv_fname.
**         Call function to convert the spool to a local PDF file
*          CALL FUNCTION 'YSE_PRINT_PDF'
*            EXPORTING
*              ps_spoolid = ls_spoolid
*              pv_fname   = lv_fname.
*        ENDIF.
**       MOD-001 - end of modif
*
*      ENDIF.
*    ENDLOOP.
*    ls_composer_param-tdcopies = nast_anzal.
*    IF NOT nast_tdarmod IS INITIAL.
*      nast-tdarmod = nast_tdarmod.
*      CLEAR nast_tdarmod.
*    ENDIF.
*
*  ENDIF.

* get SmartForm protocoll and store it in the NAST protocoll
* PERFORM ADD_SMFRM_PROT.

  DATA: lv_formname TYPE fpname,
        lv_fmname   TYPE funcname,
        ls_params   TYPE sfpoutputparams,
        ls_docparams TYPE sfpdocparams.

  lv_formname = 'YSE_SDQUOTATION_PDF_Z1'.

  CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
    EXPORTING
      i_name     = lv_formname
    IMPORTING
      e_funcname = lv_fmname.

  ls_params-pdftagged = 'X'.
  ls_params-nodialog = space.
  ls_params-preview  = 'X'.
  ls_params-reqnew   = 'X'.

  ls_docparams-langu = nast-spras.

*  CALL FUNCTION 'FP_JOB_OPEN'
*    CHANGING
*      ie_outputparams = ls_params
*    EXCEPTIONS
*      cancel          = 1
*      usage_error     = 2
*      system_error    = 3
*      internal_error  = 4
*      OTHERS          = 5.
*  IF sy-subrc <> 0.
*    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
*  ENDIF.

ls_docparams-fillable = 'X'.

  CALL FUNCTION '/1BCDWB/SM00000051'
    EXPORTING
*      archive_index      = toa_dara
*      archive_parameters = arc_params
*      control_parameters = ls_control_param
*      mail_recipient     = ls_recipient
*      mail_sender        = ls_sender
*      output_options     = ls_composer_param
*      user_settings      = space
      /1bcdwb/docparams  = ls_docparams
      is_nast            = nast
      is_repeat          = repeat
      vbdka              = vbdka
      sadr               = sadr
      wa_knvk_contact    = wa_knvk_contact
      wa_adcp_contact    = wa_adcp_contact
      wa_tpfkt_contact   = wa_tpfkt_contact
      wa_veda            = wa_veda
      wa_vbak            = wa_vbak
      wa_vbpa_ship_to    = wa_vbpa_ship_to
      wa_vbpa_bill_to    = wa_vbpa_bill_to
      is_bil_invoice     = ls_bil_invoice
      wa_tvgrt           = wa_tvgrt
    TABLES
      tvbdpa             = tvbdpa
      tkomser            = tkomser
      tfpltdr            = tfpltdr
      tkomv              = tkomv
      tvbdpa_extra       = it_tvbdpa_extra
    EXCEPTIONS
      formatting_error   = 1
      internal_error     = 2
      send_error         = 3
      user_canceled      = 4
      OTHERS             = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

*  CALL FUNCTION 'FP_JOB_CLOSE'
** IMPORTING
**   E_RESULT             =
** EXCEPTIONS
**   USAGE_ERROR          = 1
**   SYSTEM_ERROR         = 2
**   INTERNAL_ERROR       = 3
**   OTHERS               = 4
*            .
*  IF sy-subrc <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*  ENDIF.

ENDFORM.                    " processing_sf
*&---------------------------------------------------------------------*
*&      Form  set_print_param
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_ADDR_KEY  text
*      -->P_LS_DLV_LAND  text
*      <--P_LS_CONTROL_PARAM  text
*      <--P_LS_COMPOSER_PARAM  text
*      <--P_LS_RECIPIENT  text
*      <--P_LS_SENDER  text
*      <--P_CF_RETCODE  text
*----------------------------------------------------------------------*
FORM set_print_param USING    is_addr_key LIKE addr_key
                              is_dlv-land LIKE vbrk-land1
                     CHANGING cs_control_param TYPE ssfctrlop
                              cs_composer_param TYPE ssfcompop
                              cs_recipient TYPE  swotobjid
                              cs_sender TYPE  swotobjid
                              cf_retcode TYPE sy-subrc.

  DATA: ls_itcpo     TYPE itcpo.
  DATA: lf_repid     TYPE sy-repid.
  DATA: lf_device    TYPE tddevice.
  DATA: ls_recipient TYPE swotobjid.
  DATA: ls_sender    TYPE swotobjid.

  lf_repid = sy-repid.

  CALL FUNCTION 'WFMC_PREPARE_SMART_FORM'
    EXPORTING
      pi_nast       = nast
      pi_country    = is_dlv-land
      pi_addr_key   = is_addr_key
      pi_repid      = lf_repid
      pi_screen     = xscreen
    IMPORTING
      pe_returncode = cf_retcode
      pe_itcpo      = ls_itcpo
      pe_device     = lf_device
      pe_recipient  = cs_recipient
      pe_sender     = cs_sender.

  IF cf_retcode = 0.
    MOVE-CORRESPONDING ls_itcpo TO cs_composer_param.
*   CS_CONTROL_PARAM-NO_OPEN
*   CS_CONTROL_PARAM-NO_CLOSE
    cs_control_param-device      = lf_device.
    cs_control_param-no_dialog   = 'X'.
    cs_control_param-preview     = xscreen.
    cs_control_param-getotf      = ls_itcpo-tdgetotf.
    cs_control_param-langu       = nast-spras.
*   CS_CONTROL_PARAM-REPLANGU1
*   CS_CONTROL_PARAM-REPLANGU2
*   CS_CONTROL_PARAM-REPLANGU3
*   CS_CONTROL_PARAM-STARTPAGE
  ENDIF.

ENDFORM.                    " set_print_param
*&---------------------------------------------------------------------*
*&      Form  add_smfrm_prot
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM add_smfrm_prot .

  DATA: lt_errortab             TYPE tsferror.
* DATA: LF_MSGNR                TYPE SY-MSGNO.
  FIELD-SYMBOLS: <fs_errortab>  TYPE LINE OF tsferror.

* get smart form protocoll
  CALL FUNCTION 'SSF_READ_ERRORS'
    IMPORTING
      errortab = lt_errortab.

* add smartform protocoll to nast protocoll
  LOOP AT lt_errortab ASSIGNING <fs_errortab>.
*   CLEAR LF_MSGNR.
*   LF_MSGNR = <FS_ERRORTAB>-ERRNUMBER.
    CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
         EXPORTING
              msg_arbgb = <fs_errortab>-msgid
*             MSG_NR    = LF_MSGNR
              msg_nr    = <fs_errortab>-msgno
              msg_ty    = <fs_errortab>-msgty
              msg_v1    = <fs_errortab>-msgv1
              msg_v2    = <fs_errortab>-msgv2
              msg_v3    = <fs_errortab>-msgv3
              msg_v4    = <fs_errortab>-msgv4
         EXCEPTIONS
              OTHERS    = 1.
  ENDLOOP.


ENDFORM.                    " add_smfrm_prot
*&---------------------------------------------------------------------*
*&      Form  protocol_update_spool
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_4225   text
*      -->P_LS_SPOOLID  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*----------------------------------------------------------------------*
FORM protocol_update_spool  USING    syst_msgno
                                     p_ls_spoolid
                                     p_space1
                                     p_space2
                                     p_space3.
  syst-msgid = 'VN'.
  syst-msgno = syst_msgno.
  syst-msgv1 = p_ls_spoolid.
  CONDENSE syst-msgv1.
  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = p_space1
      msg_v3    = p_space2
      msg_v4    = p_space3
    EXCEPTIONS
      OTHERS    = 1.


ENDFORM.                    " protocol_update_spool
*&---------------------------------------------------------------------*
*&      Form  get_data_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_data_sf .

  DATA: us_veda_vbeln     LIKE veda-vbeln.
  DATA: us_veda_posnr_low LIKE veda-vposn.

  DATA: da_mess LIKE vbfs OCCURS 0 WITH HEADER LINE.

  CALL FUNCTION 'RV_PRICE_PRINT_GET_MODE'
    IMPORTING
      e_print_mode = price_print_mode.

  IF price_print_mode EQ chara.
*in comment AIR22296: 06072007
*    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
*      TABLES
*        tkomv = tkomv.


    REFRESH tkomv.
    CLEAR tkomv.
  ENDIF.

  CLEAR komk.
  CLEAR komp.

  vbco3-mandt = sy-mandt.
  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DOCUMENT_PRINT_VIEW'
    EXPORTING
      comwa                       = vbco3
    IMPORTING
      kopf                        = vbdka
    TABLES
      pos                         = tvbdpa
      mess                        = da_mess
    EXCEPTIONS
      fehler_bei_datenbeschaffung = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
    retcode = 1.
    EXIT.
  ELSE.
    LOOP AT da_mess.
      sy-msgid = da_mess-msgid.
      sy-msgno = da_mess-msgno.
      sy-msgty = da_mess-msgty.
      sy-msgv1 = da_mess-msgv1.
      sy-msgv2 = da_mess-msgv2.
      sy-msgv3 = da_mess-msgv3.
      sy-msgv4 = da_mess-msgv4.
      PERFORM protocol_update.
    ENDLOOP.
  ENDIF.

* fill address key --> necessary for emails
  addr_key-addrnumber = vbdka-adrnr.
  addr_key-persnumber = vbdka-adrnp.
  addr_key-addr_type  = vbdka-address_type.

* Fetch servicecontract-data and notice-data for head and position.
  us_veda_vbeln     = vbdka-vbeln.
  us_veda_posnr_low = posnr_low.
  CALL FUNCTION 'SD_VEDA_GET_PRINT_DATA'
    EXPORTING
      i_document_number = us_veda_vbeln
      i_language        = sy-langu
      i_posnr_low       = us_veda_posnr_low
    TABLES
      print_data_pos    = tkomservp
      print_data_head   = tkomservh
      print_notice_pos  = tkomservpn
      print_notice_head = tkomservhn.

  PERFORM get_controll_data.

  PERFORM sender.
  PERFORM get_extra_data.
  PERFORM check_repeat.
  PERFORM tvbdpau_create.


ENDFORM.                    " get_data_sf
*&---------------------------------------------------------------------*
*&      Form  header_serv_print_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM header_serv_print_sf .

  CHECK NOT steu-vdkex IS INITIAL.
  READ TABLE tkomservh INDEX 1.
  MOVE tkomservh TO vedka.


ENDFORM.                    " header_serv_print_sf
*&---------------------------------------------------------------------*
*&      Form  item_print_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM item_print_sf .

  DATA: da_subrc LIKE sy-subrc,
        da_dragr LIKE tvag-dragr.
  DATA: da_ganf(1) TYPE c,      "Print flag for billing correction
        da_lanf(1) TYPE c.      "Print flag for billing correction



  LOOP AT tvbdpa.
    vbdpa = tvbdpa.

    IF vbdpa-dragr EQ space.           "Print rejected item?
      IF vbdpa-posnr_neu NE space.     "Item
*        PERFORM ITEM_BILLING_CORRECTION_HEADER USING DA_GANF DA_LANF.
        PERFORM get_item_serials.
        PERFORM get_item_characteristics.
        PERFORM get_item_billing_schedules.
        PERFORM get_item_prices.
        PERFORM get_item_addis.
      ENDIF.
    ENDIF.
  ENDLOOP.
*>>> air22296
  SELECT * FROM konv INTO TABLE tkomv WHERE knumv = vbdka-knumv.
*<<< air22296



ENDFORM.                    " item_print_sf
*&---------------------------------------------------------------------*
*&      Form  get_extra_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_extra_data .
  CLEAR: wa_knvk_contact,
         wa_adcp_contact,
         wa_tpfkt_contact,
         wa_tvbdpa_extra,
         wa_tkomv.

  FREE: it_ztext,
        it_tvbdpa_extra.

  it_tvbdpa_extra[] = tvbdpa[].

**Get the contact person
*  SELECT SINGLE * FROM knvk INTO wa_knvk_contact
*                WHERE kunnr EQ vbdka-kunnr.
*
**Get the phone and fax of contact
*  IF sy-subrc EQ 0.
*    SELECT SINGLE * FROM adcp INTO wa_adcp_contact
*                  WHERE persnumber EQ wa_knvk_contact-prsnr AND
*                        date_from <= sy-datum AND
*                        date_to >= sy-datum.
**Get the title of the contact
*    SELECT SINGLE * FROM tpfkt INTO wa_tpfkt_contact
*                  WHERE pafkt EQ wa_knvk_contact-pafkt AND
*                  spras EQ nast-spras.
*    IF sy-subrc NE 0.
*      SELECT SINGLE * FROM tpfkt INTO wa_tpfkt_contact
*                WHERE pafkt EQ wa_knvk_contact-pafkt AND
*                spras EQ 'E'.
*    ENDIF.
*
*  ENDIF.
*
**If the telephone number of the contact person is not available we need
**to get it from the customer master
*  IF wa_adcp_contact-tel_number IS INITIAL OR
*     wa_adcp_contact-fax_number IS INITIAL.
*    CLEAR: v_tel, v_fax.
*    SELECT SINGLE telf1 telfx FROM kna1 INTO (v_tel, v_fax)
*                      WHERE kunnr EQ vbdka-kunnr.
**Fill tel
*    IF wa_adcp_contact-tel_number IS INITIAL.
*      wa_adcp_contact-tel_number = v_tel.
*    ENDIF.
**Fill fax
*    IF wa_adcp_contact-fax_number IS INITIAL.
*      wa_adcp_contact-fax_number = v_fax.
*    ENDIF.
*
*  ENDIF.
*




**Get the ADRNR for the ship-to party
*  SELECT SINGLE * FROM vbpa INTO wa_vbpa_ship_to
*                WHERE vbeln EQ vbdka-vbeln AND
*                      posnr EQ '000000' AND
*                      parvw EQ 'WE'.
*
**Get the ADRNR for the bill-to party
*  SELECT SINGLE * FROM vbpa INTO wa_vbpa_bill_to
*                WHERE vbeln EQ vbdka-vbeln AND
*                      posnr EQ '000000' AND
*                      parvw EQ 'RE'.

*  FREE IT_ZTEXT.
*  CLEAR IT_ZTEXT.
**Get the payment term description in the language of the SF
*  CALL FUNCTION 'FI_PRINT_ZTERM'
*   EXPORTING
*     I_ZTERM               = VBDKA-ZTERM
*     I_LANGU               = SADR-SPRAS
**   I_XT052U              = ' '
**   I_T052                =
*    TABLES
*      T_ZTEXT               = IT_ZTEXT
*   EXCEPTIONS
*     ZTERM_NOT_FOUND       = 1
*     OTHERS                = 2
*            .
*  IF SY-SUBRC <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*  ENDIF.
*
*  CLEAR VBDKA-ZTERM_TX4.
*  READ TABLE IT_ZTEXT INDEX 1 INTO VBDKA-ZTERM_TX4.

*-------------------------------------------------------------
*Above function does not work properly so we do it manually!!
  CLEAR vbdka-zterm_tx4.
  SELECT SINGLE text1 FROM t052u INTO vbdka-zterm_tx4
                WHERE zterm EQ vbdka-zterm AND
                      spras EQ nast-spras.
  IF sy-subrc NE 0.
    SELECT SINGLE text1 FROM t052u INTO vbdka-zterm_tx4
                WHERE zterm EQ vbdka-zterm AND
                      spras EQ 'E'.

  ENDIF.
*-------------------------------------------------------------


**Get the sub items to be inserted!!!
**- ZINV Rental Insurance
**- ZENV Rental Env Fee
*
*
*>>>put in comment: only for rental(air22296 on 24/08/2007)

*  LOOP AT tvbdpa INTO wa_tvbdpa_extra.
*    wa_tvbdpa_extra-grpos = wa_tvbdpa_extra-posnr.
*    CLEAR: v_vkaus, v_bezei.
*    SELECT SINGLE vkaus FROM vbap INTO v_vkaus
*                    WHERE vbeln EQ vbdka-vbeln AND
*                          posnr EQ wa_tvbdpa_extra-posnr.
*    IF sy-subrc EQ 0.
**Find in language of NAST
*      SELECT SINGLE bezei FROM tvlvt INTO v_bezei
*                   WHERE spras EQ nast-spras AND
*                         abrvw EQ v_vkaus.
*      IF sy-subrc NE 0.
**Find in english
*        SELECT SINGLE bezei FROM tvlvt INTO v_bezei
*                     WHERE spras EQ 'E' AND
*                           abrvw EQ v_vkaus.
*      ENDIF.
*      wa_tvbdpa_extra-matkl_bez = v_bezei.
*    ENDIF.
*    CLEAR wa_tvbdpa_extra-posex.
***Determine if it is a rental item, a sales item, ...
*    PERFORM determine_type_item.
*
*    APPEND wa_tvbdpa_extra TO it_tvbdpa_extra.
*    CLEAR wa_tvbdpa_extra1.
*    wa_tvbdpa_extra1 = wa_tvbdpa_extra.
*    CLEAR wa_tvbdpa_extra.
*
*    LOOP AT tkomv INTO wa_tkomv
*                 WHERE kposn EQ wa_tvbdpa_extra1-posnr.
*      IF wa_tkomv-kschl EQ 'ZINS'.
*        wa_tvbdpa_extra-grpos = wa_tvbdpa_extra1-posnr.
*        wa_tvbdpa_extra-kwmeng = wa_tvbdpa_extra1-kwmeng.
*        wa_tvbdpa_extra-pstyv = wa_tvbdpa_extra1-pstyv.
**Find the description of this in its language???
*        CLEAR w_vtext.
*        SELECT SINGLE vtext FROM t685t INTO w_vtext
*                     WHERE spras EQ nast-spras AND
*                           kschl EQ 'ZINS'.
*        IF sy-subrc EQ 0.
*          wa_tvbdpa_extra-arktx = w_vtext.
*        ELSE.
*          SELECT SINGLE vtext FROM t685t INTO w_vtext
*                       WHERE spras EQ 'E' AND
*                             kschl EQ 'ZINS'.
*          wa_tvbdpa_extra-arktx = w_vtext.
*        ENDIF.
*
**Determine if it is a rental item, a sales item, ...
*        PERFORM determine_type_item.
*        wa_tvbdpa_extra-posex+1(4) = 'ZINS'.
*
**        APPEND WA_TVBDPA_EXTRA TO IT_TVBDPA_EXTRA.
*      ELSEIF wa_tkomv-kschl EQ 'ZENV'.
*        wa_tvbdpa_extra-grpos = wa_tvbdpa_extra1-posnr.
*        wa_tvbdpa_extra-kwmeng = wa_tvbdpa_extra1-kwmeng.
*        wa_tvbdpa_extra-pstyv = wa_tvbdpa_extra1-pstyv.
*
**Find the description of this in its language???
*        CLEAR w_vtext.
*        SELECT SINGLE vtext FROM t685t INTO w_vtext
*                     WHERE spras EQ nast-spras AND
*                           kschl EQ 'ZENV'.
*        IF sy-subrc EQ 0.
*          wa_tvbdpa_extra-arktx = w_vtext.
*        ELSE.
*          SELECT SINGLE vtext FROM t685t INTO w_vtext
*                       WHERE spras EQ 'E' AND
*                             kschl EQ 'ZENV'.
*          wa_tvbdpa_extra-arktx = w_vtext.
*        ENDIF.
*
**Determine if it is a rental item, a sales item, ...
*        PERFORM determine_type_item.
*        wa_tvbdpa_extra-posex+1(4) = 'ZENV'.
*
**        APPEND WA_TVBDPA_EXTRA TO IT_TVBDPA_EXTRA.
*      ENDIF.
*      CLEAR wa_tkomv.
*    ENDLOOP.
*    CLEAR wa_tvbdpa_extra.
*  ENDLOOP.

*---------------------------------
*Search for the conditions Z032 --
*---------------------------------
**If at least 1 exists in minimum 1 item, then add only 1 line
*  CLEAR wa_tvbdpa_extra.
*  LOOP AT tkomv INTO wa_tkomv
*                WHERE kschl EQ 'Z032'.
**        WA_TVBDPA_EXTRA-KWMENG = 1.
*
**Find the description of this in its language???
*    CLEAR w_vtext.
*    SELECT SINGLE vtext FROM t685t INTO w_vtext
*                 WHERE spras EQ nast-spras AND
*                       kschl EQ 'Z032'.
*    IF sy-subrc EQ 0.
*      wa_tvbdpa_extra-arktx = w_vtext.
*    ELSE.
*      SELECT SINGLE vtext FROM t685t INTO w_vtext
*                   WHERE spras EQ 'E' AND
*                         kschl EQ 'Z032'.
*      wa_tvbdpa_extra-arktx = w_vtext.
*    ENDIF.
*CONCATENATE 'D' WA_TVBDPA_EXTRA-ARKTX INTO WA_TVBDPA_EXTRA-ARKTX.
*"?????
*Misuse this field to hold the id so we can distinguish later which item
*we are talking about
*    CLEAR wa_tvbdpa_extra-posex.
*    wa_tvbdpa_extra-posex = 'D'.
**Put this on rental so the logic in the smartform will execute the
**condition search
**Also fill in posnr otherwise description will indent in smartform
**    WA_TVBDPA_EXTRA-POSNR = '000100'.
*    APPEND wa_tvbdpa_extra TO it_tvbdpa_extra.
*    CLEAR wa_tvbdpa_extra.
*    EXIT.
*  ENDLOOP.
**---------------------------------
**Search for the conditions ZTRA --
**---------------------------------
**If at least 1 exists in minimum 1 item, then add only 1 line
*  CLEAR WA_TVBDPA_EXTRA.
*  LOOP AT TKOMV INTO WA_TKOMV
*                WHERE KSCHL EQ 'ZTRA'.
**        WA_TVBDPA_EXTRA-KWMENG = 1.
*
**Find the description of this in its language???
*    CLEAR W_VTEXT.
*    SELECT SINGLE VTEXT FROM T685T INTO W_VTEXT
*                 WHERE SPRAS EQ NAST-SPRAS AND
*                       KSCHL EQ 'ZTRA'.
*    IF SY-SUBRC EQ 0.
*      WA_TVBDPA_EXTRA-ARKTX = W_VTEXT.
*    ELSE.
*      SELECT SINGLE VTEXT FROM T685T INTO W_VTEXT
*                   WHERE SPRAS EQ 'E' AND
*                         KSCHL EQ 'ZTRA'.
*      WA_TVBDPA_EXTRA-ARKTX = W_VTEXT.
*    ENDIF.
*    CONCATENATE 'T:' WA_TVBDPA_EXTRA-ARKTX INTO WA_TVBDPA_EXTRA-ARKTX.
**Misuse this field to hold the id so we can distinguish later which
*item we are talking about
*    CLEAR WA_TVBDPA_EXTRA-POSEX.
*    WA_TVBDPA_EXTRA-POSEX = 'T'.
**Put this on rental so the logic in the smartform will execute the
*condition search
**Also fill in posnr otherwise description will indent in smartform
**    WA_TVBDPA_EXTRA-POSNR = '000100'.
*    APPEND WA_TVBDPA_EXTRA TO IT_TVBDPA_EXTRA.
*    CLEAR WA_TVBDPA_EXTRA.
*    EXIT.
*  ENDLOOP.




*Get the estimated rental start and end
  SELECT SINGLE * FROM veda INTO wa_veda
            WHERE vbeln EQ vbdka-vbeln AND
                  vposn EQ '000000'.

*Get vbak info
  SELECT SINGLE * FROM vbak INTO wa_vbak
              WHERE vbeln EQ vbdka-vbeln.

*Get the description of the sales group
  SELECT SINGLE * FROM tvgrt INTO wa_tvgrt
             WHERE vkgrp EQ vbdka-vkgrp.

ENDFORM.                    " get_extra_data
*&---------------------------------------------------------------------*
*&      Form  get_data_new
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_PRINT_DATA_TO_READ  text
*      <--P_LS_ADDR_KEY  text
*      <--P_LS_DLV_LAND  text
*      <--P_LS_BIL_INVOICE  text
*      <--P_CF_RETCODE  text
*----------------------------------------------------------------------*
FORM get_data_new
     USING    is_print_data_to_read TYPE lbbil_print_data_to_read
     CHANGING cs_addr_key           LIKE addr_key
              cs_dlv-land           LIKE vbrk-land1
              cs_bil_invoice        TYPE lbbil_invoice
              cf_retcode.


  IF nast-objky+10 NE space.
    nast-objky = nast-objky+16(10).
  ELSE.
    nast-objky = nast-objky.
  ENDIF.


* read print data
  CALL FUNCTION 'LB_BIL_INV_OUTP_READ_PRTDATA'
    EXPORTING
      if_bil_number         = nast-objky
      if_parvw              = nast-parvw
      if_parnr              = nast-parnr
      if_language           = nast-spras
      is_print_data_to_read = is_print_data_to_read
    IMPORTING
      es_bil_invoice        = cs_bil_invoice
    EXCEPTIONS
      records_not_found     = 1
      records_not_requested = 2
      OTHERS                = 3.
  IF sy-subrc <> 0.
*  error handling
    cf_retcode = sy-subrc.
    PERFORM protocol_update.
  ENDIF.

* get nast partner adress for communication strategy
  PERFORM get_addr_key USING    cs_bil_invoice-hd_adr
                       CHANGING cs_addr_key.

* get delivery land
  PERFORM get_dlv-land USING    cs_bil_invoice-hd_gen
                       CHANGING cs_dlv-land.


ENDFORM.                    " get_data_new

*&---------------------------------------------------------------------*
*&      Form  get_addr_key
*&---------------------------------------------------------------------*
FORM get_addr_key USING    it_hd_adr   TYPE lbbil_invoice-hd_adr
                  CHANGING cs_addr_key LIKE addr_key.

  FIELD-SYMBOLS <fs_hd_adr> TYPE LINE OF lbbil_invoice-hd_adr.

  READ TABLE it_hd_adr ASSIGNING <fs_hd_adr>
                       WITH KEY bil_number = nast-objky
                                partn_role = nast-parvw.
  IF sy-subrc = 0.
    cs_addr_key-addrnumber = <fs_hd_adr>-addr_no.
    cs_addr_key-persnumber = <fs_hd_adr>-person_numb.
    cs_addr_key-addr_type  = <fs_hd_adr>-address_type.
  ENDIF.

ENDFORM.                               " get_addr_key

*&---------------------------------------------------------------------*
*&      Form  get_dlv_land
*&---------------------------------------------------------------------*
FORM get_dlv-land USING    it_hd_gen   TYPE lbbil_invoice-hd_gen
                  CHANGING cs_dlv-land LIKE vbrk-land1.

  DATA: ls_address TYPE kna1.

  CALL FUNCTION 'VIEW_KNA1'
    EXPORTING
      kunde     = nast-parnr
    IMPORTING
      anschrift = ls_address
    EXCEPTIONS
      no_kna1   = 1
      OTHERS    = 2.

  IF sy-subrc <> 0.
    PERFORM protocol_update.
  ENDIF.

  cs_dlv-land = ls_address-land1.


ENDFORM.                               " get_dlv_land
*---------------------------------------------------------------------*
*       FORM SET_PRINT_DATA_TO_READ                                   *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*
FORM set_print_data_to_read
         USING    if_formname LIKE tnapr-sform
         CHANGING cs_print_data_to_read TYPE lbbil_print_data_to_read
                  cf_retcode.

  FIELD-SYMBOLS: <fs_print_data_to_read> TYPE xfeld.
  DATA: lt_fieldlist TYPE tsffields.

* set print data requirements
  DO.
    ASSIGN COMPONENT sy-index OF STRUCTURE
                     cs_print_data_to_read TO <fs_print_data_to_read>.
    IF sy-subrc <> 0. EXIT. ENDIF.
    <fs_print_data_to_read> = 'X'.
  ENDDO.

  CALL FUNCTION 'SSF_FIELD_LIST'
    EXPORTING
      formname                = if_formname
*     VARIANT                 = ' '
    IMPORTING
      fieldlist               = lt_fieldlist
   EXCEPTIONS
     no_form                  = 1
     no_function_module       = 2
     OTHERS                   = 3.
  IF sy-subrc <> 0.
*  error handling
    cf_retcode = sy-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SET_PRINT_DATA_TO_READ
*&---------------------------------------------------------------------*
*&      Form  determine_type_item
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM determine_type_item .

*Determine if it is a rental item, a sales item, ...
  CLEAR wa_tvbdpa_extra-posex.
  IF wa_tvbdpa_extra-pstyv EQ 'ZMVN' OR
     wa_tvbdpa_extra-pstyv EQ 'ZREN'.
*Rental
    wa_tvbdpa_extra-posex = 'R'.
    CONCATENATE 'R:' wa_tvbdpa_extra-arktx INTO wa_tvbdpa_extra-arktx.

  ELSEIF wa_tvbdpa_extra-pstyv EQ 'ZTAR' .
*Sales
    READ TABLE tkomv INTO wa_tkomv
                WITH KEY kposn = wa_tvbdpa_extra-posnr
                         kschl = 'ZPRO'.
    IF sy-subrc EQ 0.
*OK, then its really a sales item
      wa_tvbdpa_extra-posex = 'V'.
      CONCATENATE 'V:' wa_tvbdpa_extra-arktx INTO wa_tvbdpa_extra-arktx
.
    ENDIF.

  ELSEIF wa_tvbdpa_extra-pstyv EQ 'ZRC1' OR
         wa_tvbdpa_extra-pstyv EQ 'ZRC2' .

*transport
    READ TABLE tkomv INTO wa_tkomv
                WITH KEY kposn = wa_tvbdpa_extra-posnr
                         kschl = 'ZTRA'.
    IF sy-subrc EQ 0.
*OK, then its really a transport item
      wa_tvbdpa_extra-posex = 'T'.
      CONCATENATE 'T:' wa_tvbdpa_extra-arktx INTO wa_tvbdpa_extra-arktx
.
    ELSE.
*transport not found, try service
      READ TABLE tkomv INTO wa_tkomv
                  WITH KEY kposn = wa_tvbdpa_extra-posnr
                           kschl = 'ZSER'.
      IF sy-subrc EQ 0.
*OK, then its really a service item
        wa_tvbdpa_extra-posex = 'S'.
        CONCATENATE 'S:' wa_tvbdpa_extra-arktx INTO
        wa_tvbdpa_extra-arktx.
      ENDIF.

    ENDIF.

  ENDIF.

ENDFORM.                    " determine_type_item
*&---------------------------------------------------------------------*
*&      Form  get_extra_data2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_extra_data2 .


*Get the estimated rental start and end
  SELECT SINGLE * FROM veda INTO wa_veda
            WHERE vbeln EQ vbdka-vbeln AND
                  vposn EQ '000000'.

*Get vbak info
  SELECT SINGLE * FROM vbak INTO wa_vbak
              WHERE vbeln EQ vbdka-vbeln.

*Get the description of the sales group
  SELECT SINGLE * FROM tvgrt INTO wa_tvgrt
             WHERE vkgrp EQ vbdka-vkgrp.


ENDFORM.                    " get_extra_data2

*Selection text£º
*XSCREEN:        Output on screen (x=yes)
