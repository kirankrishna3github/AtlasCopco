* CHANGE HISTORY LOG                                                         *
*----------------------------------------------------------------------------*
* MOD.NR. | DATE       | NAME               | CORRECTION NR. | CHANGE REF. # *
*----------------------------------------------------------------------------*
* MOD-001 | 19.09.2014 | Dashmantha         | CD1K983138     | CR3364        *
*  Your Reference should be updatd for document types GDS and SCL Doc. types *
*  in place of Sales document                                                *
*----------------------------------------------------------------------------*
* MOD-002 | 22.04.2015 | Anda               | CD1K985317     | CR3517        *
* Regarding ZFOR-the output of shipment, changes of template of excel file   *
*----------------------------------------------------------------------------*
* MOD-003 | 10.11.2016 | Dashmantha         | CD1K990097     | CR3825        *
* Addition of new column in forwarder file for dangerous goods               *
*----------------------------------------------------------------------------*
REPORT rv56td01 MESSAGE-ID vw
                LINE-SIZE 85
                NO STANDARD PAGE HEADING.

* extended syntax checker should not detect any 'UNUSED VARIABLES'Error
SET EXTENDED CHECK OFF.

*------- Includes
INCLUDE vttkdata.                      "Shipment Header
INCLUDE vttsdata.                      "Shipment Stages
INCLUDE vttpdata.                      "Shipment Items
INCLUDE vbpadata.                      "Partner
INCLUDE vtfadata.                      "Flow
INCLUDE sadrdata.                      "Address
INCLUDE vtlfdata.                      "Deliveries selected
INCLUDE rvadtabl.                      "Messages
INCLUDE vsedata.                       "shipping units
INCLUDE rv56acom.                      "I/O-Structure

*------- Tables
TABLES: vbpla, t005, t005t, t604t, marc.

TABLES: cmr_01,
        cmr_02,
        cmr_03,
        cmr_04,
        cmr_06ff,
        cmr_06a,
        cmr_14,
        cmr_15,
        cmr_16,
        cmr_17,
        cmr_20,
        cmr_21.

* reactivate extended syntax checker ...
SET EXTENDED CHECK ON.

*------- Types

TYPES: cmr_01_type       LIKE cmr_01,
       cmr_02_type       LIKE cmr_02,
       cmr_03_type       LIKE cmr_03,
       cmr_04_type       LIKE cmr_04,
       cmr_06ff_type     LIKE cmr_06ff,
       cmr_06ff_tab_type LIKE cmr_06ff OCCURS 0,
       cmr_06a_type      LIKE cmr_06a,
       cmr_14_type       LIKE cmr_14,
       cmr_15_type       LIKE cmr_15,
       cmr_16_type       LIKE cmr_16,
       cmr_17_type       LIKE cmr_17,
       cmr_20_type       LIKE cmr_20,
       cmr_21_type       LIKE cmr_21.

TYPES: BEGIN OF cmr_type,
         language LIKE t005-spras,
         country  LIKE t005-land1,
         cmr_01   TYPE cmr_01_type,
         cmr_02   TYPE cmr_02_type,
         cmr_03   TYPE cmr_03_type,
         cmr_04   TYPE cmr_04_type,
         cmr_06ff TYPE cmr_06ff_tab_type,
         cmr_06a  TYPE cmr_06a_type,
         cmr_14   TYPE cmr_14_type,
         cmr_15   TYPE cmr_15_type,
         cmr_16   TYPE cmr_16_type,
         cmr_17   TYPE cmr_17_type,
         cmr_20   TYPE cmr_20_type,
         cmr_21   TYPE cmr_21_type,
       END OF cmr_type.

TYPES: cmr_tab_typ TYPE cmr_type OCCURS 0.

*------- General Data
DATA: retcode LIKE sy-subrc,           "Return code
      xscreen(1) TYPE c.               "Output on printer or screen

DATA: cmr_form           TYPE cmr_tab_typ,     "Documents to print
      something_to_print TYPE boolean.         "Flag for printing

DATA: BEGIN OF protocol_tab OCCURS 0,
         msg_arbgb LIKE syst-msgid,
         msg_nr    LIKE syst-msgno,
         msg_ty    LIKE syst-msgty,
         msg_v1    LIKE syst-msgv1,
         msg_v2    LIKE syst-msgv2,
         msg_v3    LIKE syst-msgv3,
         msg_v4    LIKE syst-msgv4.
DATA: END OF protocol_tab.

*------- Constant values
CONSTANTS:
  two              LIKE adrs-anzzl  VALUE 2,   "number of lines
  three            LIKE adrs-anzzl  VALUE 3,   "number of lines
  four             LIKE adrs-anzzl  VALUE 4,   "number of lines
  five             LIKE adrs-anzzl  VALUE 5,   "number of lines
  kg               LIKE vbplk-gewei VALUE 'KG ',
  m3               LIKE vbplk-gewei VALUE 'M3 ',


  cmr_foname       LIKE tnapr-fonam VALUE 'SD_SHIPMENT_CMR'.

DATA: l_szadr TYPE TABLE OF yse_printform_table
    WITH HEADER LINE.
*----------------------------------------------------------------------*
*        Aufruf der Entry-Routine aus der Nachrichtensteuerung         *
*----------------------------------------------------------------------*
FORM entry USING return_code us_screen.                     "#EC *

  CLEAR retcode.
  xscreen = us_screen.
*  PERFORM processing.

  IF nast-spras = 'R'.
    PERFORM entry(yse_forwarder_zfor_mrua) USING return_code us_screen.
  ELSE.
    PERFORM create_xls_file.
    IF retcode NE 0.
      return_code = 1.
    ELSE.
      return_code = 0.
    ENDIF.
  ENDIF.

ENDFORM.                    "ENTRY

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM processing.

  PERFORM initialize_data.

  PERFORM get_data.

  IF ( something_to_print = true ).
    PERFORM print_cmr_documents USING cmr_form.
  ELSE.
    LOOP AT protocol_tab.
      MOVE protocol_tab-msg_arbgb TO syst-msgid.
      MOVE protocol_tab-msg_nr    TO syst-msgno.
      MOVE protocol_tab-msg_ty    TO syst-msgty.
      MOVE protocol_tab-msg_v1    TO syst-msgv1.
      MOVE protocol_tab-msg_v2    TO syst-msgv2.
      MOVE protocol_tab-msg_v3    TO syst-msgv3.
      MOVE protocol_tab-msg_v4    TO syst-msgv4.
      PERFORM protocol_update.
    ENDLOOP.
    retcode = 1.
  ENDIF.
ENDFORM.                    "PROCESSING

*---------------------------------------------------------------------*
*       FORM INITIALIZE_DATA                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM initialize_data.

  CLEAR:   protocol_tab.
  REFRESH: cmr_form,
           protocol_tab.
  something_to_print = true.

ENDFORM.                    "INITIALIZE_DATA

*---------------------------------------------------------------------*
*       FORM PRINT_CMR_DOCUMENTS                                      *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  DOC                                                           *
*---------------------------------------------------------------------*
FORM print_cmr_documents USING doc TYPE cmr_tab_typ.

  DATA: doc_rec TYPE cmr_type.

  LOOP AT doc INTO doc_rec.
    PERFORM open_form USING xscreen doc_rec-country.
    IF ( retcode IS INITIAL ).
      PERFORM print_document_body USING doc_rec.
      PERFORM close_form.
    ENDIF.
    IF NOT ( retcode IS INITIAL ).
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "PRINT_CMR_DOCUMENTS

*---------------------------------------------------------------------*
*       FORM PRINT_DOCUMENT_BODY                                      *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  DOC_REC                                                       *
*---------------------------------------------------------------------*
FORM print_document_body USING doc_rec TYPE cmr_type.

  PERFORM write_form USING 'CMR-PAGE' space.

* cmr_14 must be assigned first because of field tdname needed for texts
  cmr_14 = doc_rec-cmr_14.
  PERFORM write_form USING 'CMR-14-1' space.
  PERFORM write_form USING 'CMR-14-2' space.
  cmr_01 = doc_rec-cmr_01.
  PERFORM write_form USING 'CMR-1' space.
  cmr_02 = doc_rec-cmr_02.
  PERFORM write_form USING 'CMR-2' space.
  cmr_03 = doc_rec-cmr_03.
  PERFORM write_form USING 'CMR-3' space.
  cmr_04 = doc_rec-cmr_04.
  PERFORM write_form USING 'CMR-4' space.
  PERFORM write_form USING 'CMR-5' 'TEXTE'.
  cmr_06a = doc_rec-cmr_06a.
  PERFORM write_form USING 'CMR-6A' space.
  PERFORM write_form USING 'CMR-13' 'TEXTE'.
  cmr_15 = doc_rec-cmr_15.
  PERFORM write_form USING 'CMR-15' space.
  cmr_16 = doc_rec-cmr_16.
  PERFORM write_form USING 'CMR-16' space.
  cmr_17 = doc_rec-cmr_17.
  PERFORM write_form USING 'CMR-17' space.
  PERFORM write_form USING 'CMR-18' 'TEXTE'.
  PERFORM write_form USING 'CMR-19' 'TEXTE'.
  cmr_20 = doc_rec-cmr_20.
  PERFORM write_form USING 'CMR-20' space.
  cmr_21 = doc_rec-cmr_21.
  PERFORM write_form USING 'CMR-21' space.

  LOOP AT doc_rec-cmr_06ff INTO cmr_06ff.
    PERFORM write_form USING 'MAIN' 'ITEM_LINE'.
    IF NOT ( sy-subrc IS INITIAL ).
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "PRINT_DOCUMENT_BODY

*---------------------------------------------------------------------*
*       FORM OPEN_FORM                                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  US_SCREEN                                                     *
*  -->  US_COUNTRY                                                    *
*---------------------------------------------------------------------*
FORM open_form USING  us_screen  LIKE xscreen
                      us_country LIKE sadr-land1.           "SADR40A

  INCLUDE rvadopfo.

ENDFORM.                    "OPEN_FORM

*---------------------------------------------------------------------*
*       FORM CLOSE_FORM                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM close_form.

  CALL FUNCTION 'CLOSE_FORM'
    EXCEPTIONS
      OTHERS = 1.

  IF NOT ( sy-subrc IS INITIAL ).
    PERFORM protocol_update.
    retcode = 1.
  ENDIF.

ENDFORM.                    "CLOSE_FORM

*---------------------------------------------------------------------*
*       FORM WRITE_FORM                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VALUE(WINDOW)                                                 *
*  -->  VALUE(ELEMENT)                                                *
*---------------------------------------------------------------------*
FORM write_form USING    value(window)  TYPE c
                         value(element) TYPE c.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = element
      window  = window
    EXCEPTIONS
      element = 1
      window  = 2.

  IF NOT ( sy-subrc IS INITIAL ).
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "WRITE_FORM

*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM protocol_update.

  CHECK xscreen = false.               "output on printer

  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4.

ENDFORM.                    "PROTOCOL_UPDATE

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM get_data.

  DATA: shipment_num LIKE vttk-tknum,
        language     LIKE nast-spras,
        cmr_record   TYPE cmr_type,
        sadr_begin   LIKE sadr,                             "SADR40A
        sadr_end     LIKE sadr,                             "SADR40A
        cmr_xvtts    LIKE xvtts OCCURS 0 WITH HEADER LINE.
  "print relevant segments

  language     = nast-spras.
  shipment_num = nast-objky.

  CALL FUNCTION 'RV_SHIPMENT_PRINT_VIEW'
    EXPORTING
      shipment_number     = shipment_num
      option_tvtk         = true          "Shipmenttype Y/N
      option_ttds         = true          "Disposition Y/N
      language            = language
      option_items        = true          "Transport Items Y/N
      option_sales_orders = true          "Transport Segments Y/N
      option_export_data  = true          "Partners Y/N
      option_segments     = true          "Sales orders Y/N
      option_partners     = true          "Export data Y/N
      option_packages     = true          "Packages Y/N
      option_flow         = true          "Flow Y/N
      option_no_refresh   = false         "Refresh Tables Y/N
    IMPORTING
      f_vttkvb            = vttkvb        "Shipment Head
      f_tvtk              = tvtk          "Shipmenttype
      f_tvtkt             = tvtkt         "Description Shipmenttye
      f_ttds              = ttds          "Disposition
      f_ttdst             = ttdst         "Description Disposition
      f_vbpla             = vbpla         "Packages
    TABLES
      f_vttp              = xvttp         "Shipment Items
      f_trlk              = slk           "Delivery
      f_trlp              = slp           "Delivery Item
      f_vtts              = xvtts         "Shipment Segments
      f_vtsp              = xvtsp         "Segments/Items
      f_vbpa              = xvbpa         "Partner
      f_vbadr             = xvbadr        "Address
      f_vtfa              = xvtfa         "Flow
      f_vbplk             = xvbplk        "Shipment Unit Header
      f_vbplp             = xvbplp        "Shipment Unit
      f_vbpls             = xvbpls        "Shipment Unit Sum
    EXCEPTIONS
      not_found           = 1
      OTHERS              = 2.

  IF NOT ( sy-subrc IS INITIAL ).
* save protocol record
    protocol_tab-msg_arbgb = 'VW'.
    protocol_tab-msg_nr    = '010'.
    protocol_tab-msg_ty    = 'E'.
    protocol_tab-msg_v1    = shipment_num.
    APPEND protocol_tab.
* set flag nothing to print
    something_to_print = false.
  ELSE.
    PERFORM get_legs_to_print TABLES cmr_xvtts.
    LOOP AT cmr_xvtts.
      CLEAR: cmr_record,
             sadr_begin,
             sadr_end.
* convert all units to kg and m3
      PERFORM unit_conversion TABLES xvbplk slp.
* get address data of leg (begin and end)
      PERFORM get_address_data_of_leg USING cmr_xvtts
                                            sadr_begin
                                            sadr_end.
* set country and language
      cmr_record-country  = sadr_begin-land1.
      cmr_record-language = sy-langu.
      SELECT SINGLE spras INTO cmr_record-language FROM t005
                          WHERE land1 = cmr_record-country.
* get sender data
      PERFORM get_data_cmr_01 USING cmr_record
                                    sadr_begin
                                    sadr_begin-land1.
* get consignee data
      PERFORM get_data_cmr_02 USING cmr_record
                                    sadr_end
                                    sadr_begin-land1.
* get place of delivery of the goods
      PERFORM get_data_cmr_03 USING cmr_record
                                    sadr_end
                                    sadr_begin-land1.
* get place and date of taking over the goods
      PERFORM get_data_cmr_04 USING cmr_record
                                    sadr_begin
                                    sadr_begin-land1
                                    cmr_xvtts.
* get position data
      PERFORM get_data_cmr_06ff USING  cmr_record
                                       cmr_xvtts.

* get instructions as to payment for carriage and
* save shipment number for printing texts
      PERFORM get_data_cmr_14 USING  cmr_record
                                     cmr_xvtts.

* get carrier data
      PERFORM get_data_cmr_16 USING cmr_record
                                    sadr_begin-land1
                                    cmr_xvtts.

* get established in/on
      PERFORM get_data_cmr_21 USING cmr_record.

      APPEND cmr_record TO cmr_form.
    ENDLOOP.
  ENDIF.

ENDFORM.                    "GET_DATA

*---------------------------------------------------------------------*
*       FORM GET_ADDRESS_DATA_OF_LEG                                  *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VALUE(LEG)                                                    *
*  -->  SADR_BEGIN                                                    *
*  -->  SADR_END                                                      *
*---------------------------------------------------------------------*
FORM get_address_data_of_leg USING value(leg)   LIKE      xvtts
                                   sadr_begin   STRUCTURE sadr"SADR40A
                                   sadr_end     STRUCTURE sadr."SADR40A

  DATA:
    l_dept LIKE loc_dept,
    l_dest LIKE loc_dest.

  MOVE-CORRESPONDING leg TO l_dept.
  CALL FUNCTION 'ST_LOCATION_ADDR_READ'
    EXPORTING
      i_location        = l_dept
    IMPORTING
      e_sadr            = sadr_begin
    EXCEPTIONS
      address_not_found = 1
      OTHERS            = 2.
  IF sy-subrc NE 0.
    syst-msgid = 'VW'.
    syst-msgno = '002'.
    syst-msgty = 'E'.
    syst-msgv1 = text-001.
    syst-msgv2 = 'SADR'.
    PERFORM protocol_update.
    CLEAR sadr_begin.
  ENDIF.

  MOVE-CORRESPONDING leg TO l_dest.
  CALL FUNCTION 'ST_LOCATION_ADDR_READ'
    EXPORTING
      i_location        = l_dest
    IMPORTING
      e_sadr            = sadr_end
    EXCEPTIONS
      address_not_found = 1
      OTHERS            = 2.
  IF sy-subrc NE 0.
    syst-msgid = 'VW'.
    syst-msgno = '002'.
    syst-msgty = 'E'.
    syst-msgv1 = text-001.
    syst-msgv2 = 'SADR'.
    PERFORM protocol_update.
    CLEAR sadr_end.
  ENDIF.

ENDFORM.                    "GET_ADDRESS_DATA_OF_LEG

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_01                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(H_SADR)                                                 *
*  -->  VALUE(SENDER_COUNTRY)                                         *
*---------------------------------------------------------------------*
FORM get_data_cmr_01
                  USING cmr_rec         TYPE      cmr_type
                  value(h_sadr)         STRUCTURE sadr      "SADR40A
                  value(sender_country) LIKE      sadr-land1."SADR40A

  DATA: h_adrs LIKE adrs,
        language LIKE t005-spras.

  IF NOT ( h_sadr IS INITIAL ).
    MOVE-CORRESPONDING h_sadr TO h_adrs.
    h_adrs-inlnd = sender_country.
* country
    language = sy-langu.
    SELECT SINGLE spras INTO language FROM t005
                                      WHERE land1 = sender_country.
    SELECT SINGLE * FROM t005t WHERE spras = language    AND
                                     land1 = h_adrs-land1.
    IF ( sy-subrc IS INITIAL ).
      SET LOCALE LANGUAGE language.
      TRANSLATE t005t-landx TO UPPER CASE.               "#EC TRANSLANG
      SET LOCALE LANGUAGE space.
      cmr_rec-cmr_01-line4 = t005t-landx.
    ENDIF.
* address
    h_adrs-anzzl = four.
    PERFORM address_into_printform USING h_adrs.
    cmr_rec-cmr_01-line0 = h_adrs-line0(40).
    cmr_rec-cmr_01-line1 = h_adrs-line1(40).
    cmr_rec-cmr_01-line2 = h_adrs-line2(40).
    cmr_rec-cmr_01-line3 = h_adrs-line3(40).
  ENDIF.

ENDFORM.                    "GET_DATA_CMR_01

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_02                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(H_SADR)                                                 *
*  -->  VALUE(SENDER_COUNTRY)                                         *
*---------------------------------------------------------------------*
FORM get_data_cmr_02 USING cmr_rec         TYPE      cmr_type
                     value(h_sadr)         STRUCTURE sadr   "SADR40A
                     value(sender_country) LIKE      sadr-land1."SADR40A

  DATA: h_adrs   LIKE adrs,
        language LIKE t005-spras.

  IF NOT ( h_sadr IS INITIAL ).
    MOVE-CORRESPONDING h_sadr TO h_adrs.
    h_adrs-inlnd = sender_country.
    IF ( h_adrs-land1 = h_adrs-inlnd ).
* country
      language = sy-langu.
      SELECT SINGLE spras INTO language FROM t005
                                        WHERE land1 = sender_country.
      SELECT SINGLE * FROM t005t WHERE spras = language    AND
                                       land1 = h_adrs-land1.
      IF ( sy-subrc IS INITIAL ).
        SET LOCALE LANGUAGE language.
        TRANSLATE t005t-landx TO UPPER CASE.             "#EC TRANSLANG
        SET LOCALE LANGUAGE space.
        cmr_rec-cmr_02-line4 = t005t-landx.
      ENDIF.
* address
      h_adrs-anzzl = four.
      PERFORM address_into_printform USING h_adrs.
      cmr_rec-cmr_02-line0 = h_adrs-line0(40).
      cmr_rec-cmr_02-line1 = h_adrs-line1(40).
      cmr_rec-cmr_02-line2 = h_adrs-line2(40).
      cmr_rec-cmr_02-line3 = h_adrs-line3(40).
    ELSE.
      h_adrs-anzzl = five.
      PERFORM address_into_printform USING h_adrs.
      cmr_rec-cmr_02-line0 = h_adrs-line0(40).
      cmr_rec-cmr_02-line1 = h_adrs-line1(40).
      cmr_rec-cmr_02-line2 = h_adrs-line2(40).
      cmr_rec-cmr_02-line3 = h_adrs-line3(40).
      cmr_rec-cmr_02-line4 = h_adrs-line4(40).
    ENDIF.
  ENDIF.

ENDFORM.                    "GET_DATA_CMR_02

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_03                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(H_SADR)                                                 *
*  -->  VALUE(SENDER_COUNTRY)                                         *
*---------------------------------------------------------------------*
FORM get_data_cmr_03 USING cmr_rec         TYPE      cmr_type
                     value(h_sadr)         STRUCTURE sadr   "SADR40A
                     value(sender_country) LIKE      sadr-land1."SADR40A

  DATA: h_adrs   LIKE adrs,
        language LIKE t005-spras.

  IF NOT ( h_sadr IS INITIAL ).
    MOVE-CORRESPONDING h_sadr TO h_adrs.
    h_adrs-inlnd = sender_country.
    IF ( h_adrs-land1 = h_adrs-inlnd ).
* country
      language = sy-langu.
      SELECT SINGLE spras INTO language FROM t005
                                        WHERE land1 = sender_country.
      SELECT SINGLE * FROM t005t WHERE spras = language     AND
                                       land1 = h_adrs-land1.
      IF ( sy-subrc IS INITIAL ).
        SET LOCALE LANGUAGE language.
        TRANSLATE t005t-landx TO UPPER CASE.             "#EC TRANSLANG
        SET LOCALE LANGUAGE space.
        cmr_rec-cmr_03-line2 = t005t-landx.
      ENDIF.
* address
      h_adrs-anzzl = two.
      PERFORM address_into_printform USING h_adrs.
      cmr_rec-cmr_03-line0 = h_adrs-line0(40).
      cmr_rec-cmr_03-line1 = h_adrs-line1(40).
    ELSE.
      h_adrs-anzzl = three.
      PERFORM address_into_printform USING h_adrs.
      cmr_rec-cmr_03-line0 = h_adrs-line0(40).
      cmr_rec-cmr_03-line1 = h_adrs-line1(40).
      cmr_rec-cmr_03-line2 = h_adrs-line2(40).
    ENDIF.
  ENDIF.

ENDFORM.                    "GET_DATA_CMR_03

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_04                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(H_SADR)                                                 *
*  -->  VALUE(SENDER_COUNTRY)                                         *
*  -->  VALUE(LEG)                                                    *
*---------------------------------------------------------------------*
FORM get_data_cmr_04 USING cmr_rec         TYPE      cmr_type
                     value(h_sadr)         STRUCTURE sadr   "SADR40A
                     value(sender_country) LIKE      sadr-land1"SADR40A
                     value(leg)            LIKE      xvtts.

  DATA: h_adrs   LIKE adrs,
        language LIKE t005-spras.

  IF NOT ( h_sadr IS INITIAL ).
    MOVE-CORRESPONDING h_sadr TO h_adrs.
    h_adrs-inlnd = sender_country.
* country
    language = sy-langu.
    SELECT SINGLE spras INTO language FROM t005
                                      WHERE land1 = sender_country.
    SELECT SINGLE * FROM t005t WHERE spras = language     AND
                                     land1 = h_adrs-land1.
    IF ( sy-subrc IS INITIAL ).
      SET LOCALE LANGUAGE language.
      TRANSLATE t005t-landx TO UPPER CASE.               "#EC TRANSLANG
      SET LOCALE LANGUAGE space.
      cmr_rec-cmr_04-line1 = t005t-landx.
    ENDIF.
* short-address
    h_adrs-anzzl = four.
    PERFORM address_into_printform USING h_adrs.
    cmr_rec-cmr_04-line0 = h_adrs-linek(40).
  ENDIF.

* date
* actual date of the begining of the leg
  IF NOT ( leg-datbg IS INITIAL ).
    cmr_rec-cmr_04-line2 = leg-datbg.
* actual date of the begining of the shipment (complition)
  ELSEIF NOT ( vttkvb-dtabf IS INITIAL ).
    cmr_rec-cmr_04-line2 = vttkvb-dtabf.
* planed date of the begining of the leg
  ELSEIF NOT ( leg-dptbg IS INITIAL ).
    cmr_rec-cmr_04-line2 = leg-dptbg.
* planed date of the begining of the shipment (complition)
  ELSEIF NOT ( vttkvb-dpabf IS INITIAL ).
    cmr_rec-cmr_04-line2 = vttkvb-dpabf.
  ENDIF.

ENDFORM.                    "GET_DATA_CMR_04

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_06FF                                        *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(LEG)                                                    *
*---------------------------------------------------------------------*
FORM get_data_cmr_06ff USING  cmr_rec    TYPE  cmr_type
                              value(leg) LIKE  xvtts.

  DATA: vbplk_to_check LIKE xvbplk OCCURS 0 WITH HEADER LINE.
  DATA: vbplk_to_print LIKE xvbplk OCCURS 0 WITH HEADER LINE.

* view shiping units in shipment ********************************
* get shiping units to be printed
  LOOP AT xvbplk WHERE kzobe = true.
    APPEND xvbplk TO vbplk_to_check.
  ENDLOOP.
  PERFORM get_shiping_units TABLES vbplk_to_check
                                   vbplk_to_print.
* condense shiping units to be printed
  PERFORM condense_shiping_units TABLES vbplk_to_print
                                 USING  cmr_rec.

* view materials on leg *****************************************
* condense materials shiped on leg
  PERFORM condense_materials USING  cmr_rec
                                    leg.

  SORT cmr_rec-cmr_06ff ASCENDING BY pos10 pos09.

ENDFORM.                    "GET_DATA_CMR_06FF

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_14                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(LEG)                                                    *
*---------------------------------------------------------------------*
FORM get_data_cmr_14 USING  cmr_rec    TYPE  cmr_type
                            value(leg) LIKE  xvtts.

  DATA: h_inco1 LIKE vtts-inco1 OCCURS 0 WITH HEADER LINE.

  DATA: lin LIKE sy-tabix.

* save shipment number for printing texts ****************
  cmr_rec-cmr_14-tdname = vttkvb-tknum.

* get incoterms ******************************************
  IF NOT ( leg-inco1 IS INITIAL ).
* check on leg if <> initial
    h_inco1 = leg-inco1.
    APPEND leg-inco1 TO h_inco1.
  ELSE.
* check delivery inco
    LOOP AT xvtsp WHERE tsnum = leg-tsnum.        "get shipment-position
      READ TABLE xvttp WITH KEY tpnum = xvtsp-tpnum. "get delivery
      IF ( sy-subrc IS INITIAL ).
        READ TABLE slk WITH KEY vbeln = xvttp-vbeln.
        IF ( sy-subrc IS INITIAL ).
          h_inco1 = slk-inco1.
          COLLECT h_inco1.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.

  DESCRIBE TABLE h_inco1 LINES lin.
  IF ( lin = 1 ).
* inco is definite (unique) --> print it
    CASE h_inco1.
      WHEN 'EXW' OR 'CFR' OR 'CIF' OR 'CPT' OR 'CIP' OR
           'DAF' OR 'DES' OR 'DEQ' OR 'DDU' OR 'DDP'.
        cmr_rec-cmr_14-unfrei = true.
      WHEN 'FCA' OR 'FAS' OR 'FOB'.
        cmr_rec-cmr_14-frei = true.
    ENDCASE.
  ENDIF.

ENDFORM.                    "GET_DATA_CMR_14

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_16                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(SENDER_COUNTRY)                                         *
*  -->  VALUE(LEG)                                                    *
*---------------------------------------------------------------------*
FORM get_data_cmr_16 USING cmr_rec         TYPE cmr_type
                     value(sender_country) LIKE sadr-land1  "SADR40A
                     value(leg)            LIKE xvtts.

  DATA: found    TYPE boolean,
        h_sadr   LIKE sadr,                                 "SADR40A
        h_adrs   LIKE adrs,
        language LIKE t005-spras.

  CLEAR: h_adrs,
         h_sadr.
  found = false.
  READ TABLE xvbpa WITH KEY lifnr = leg-tdlnr.

  IF ( sy-subrc IS INITIAL ) AND NOT ( xvbpa-adrnr IS INITIAL ).
    PERFORM address_get_data USING xvbpa-adrnr xvbpa-adrda h_sadr.
    IF ( sy-subrc IS INITIAL ).
      MOVE-CORRESPONDING h_sadr TO h_adrs.
      found = true.
    ENDIF.
  ELSE.
    SELECT SINGLE * FROM lfa1 WHERE lifnr = leg-tdlnr.
    IF ( sy-subrc IS INITIAL ).
      MOVE-CORRESPONDING lfa1 TO h_adrs.
      found = true.
    ENDIF.
  ENDIF.

  IF ( found = true ).
    h_adrs-inlnd = sender_country.
    IF ( h_adrs-land1 = h_adrs-inlnd ).
      language = sy-langu.
      SELECT SINGLE spras INTO language FROM t005
                                        WHERE land1 = sender_country.
      SELECT SINGLE * FROM t005t WHERE spras = language    AND
                                       land1 = h_adrs-land1.
      IF ( sy-subrc IS INITIAL ).
        SET LOCALE LANGUAGE language.
        TRANSLATE t005t-landx TO UPPER CASE.             "#EC TRANSLANG
        SET LOCALE LANGUAGE space.
        cmr_rec-cmr_16-line4 = t005t-landx.
      ENDIF.
      h_adrs-anzzl = four.
      PERFORM address_into_printform USING h_adrs.
      cmr_rec-cmr_16-line0 = h_adrs-line0(40).
      cmr_rec-cmr_16-line1 = h_adrs-line1(40).
      cmr_rec-cmr_16-line2 = h_adrs-line2(40).
      cmr_rec-cmr_16-line3 = h_adrs-line3(40).
    ELSE.
      h_adrs-anzzl = five.
      PERFORM address_into_printform USING h_adrs.
      cmr_rec-cmr_16-line0 = h_adrs-line0(40).
      cmr_rec-cmr_16-line1 = h_adrs-line1(40).
      cmr_rec-cmr_16-line2 = h_adrs-line2(40).
      cmr_rec-cmr_16-line3 = h_adrs-line3(40).
      cmr_rec-cmr_16-line4 = h_adrs-line4(40).
    ENDIF.
  ENDIF.

ENDFORM.                    "GET_DATA_CMR_16

*---------------------------------------------------------------------*
*       FORM GET_DATA_CMR_21                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*---------------------------------------------------------------------*
FORM get_data_cmr_21 USING cmr_rec         TYPE cmr_type.

  DATA:
    l_addr1_sel LIKE addr1_sel,
    h_sadr      LIKE sadr.                                  "SADR40A

* established in (short-address)
  IF NOT ( ttds-adrnr IS INITIAL ).                         "SADR40A
    l_addr1_sel-addrnumber = ttds-adrnr.                    "SADR40A
    CALL FUNCTION 'ADDR_GET'
      EXPORTING
        address_selection = l_addr1_sel
        address_group     = 'CA01'        "it's a Customizing-Address
      IMPORTING
        sadr              = h_sadr
      EXCEPTIONS
        OTHERS            = 1.
    IF NOT ( sy-subrc IS INITIAL ).
      syst-msgid = 'VW'.
      syst-msgno = '002'.
      syst-msgty = 'E'.
      syst-msgv1 = text-001.
      syst-msgv2 = 'SADR'.
      syst-msgv3 = ttds-adrnr.                              "SADR40A
      PERFORM protocol_update.
    ELSE.
      IF NOT ( h_sadr-ort01 IS INITIAL ).
        cmr_rec-cmr_21-pos00 = h_sadr-ort01(25).
      ENDIF.
    ENDIF.
  ENDIF.
* established on is generated by functionality of SapSkript
* cmr_rec-cmr_21-pos01 = sy-datum.

ENDFORM.                    "GET_DATA_CMR_21

*---------------------------------------------------------------------*
*       FORM UNIT_CONVERSION                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VBPLK_TAB                                                     *
*  -->  VTRLP_TAB                                                     *
*---------------------------------------------------------------------*
FORM unit_conversion TABLES vbplk_tab STRUCTURE xvbplk
                            vtrlp_tab STRUCTURE slp.

  LOOP AT vbplk_tab.
    PERFORM unit_conversion_simple USING vbplk_tab-brgew
                                         vbplk_tab-brgew
                                         vbplk_tab-gewei_max kg.

    PERFORM unit_conversion_simple USING vbplk_tab-ntgew
                                         vbplk_tab-ntgew
                                         vbplk_tab-gewei_max kg.

    PERFORM unit_conversion_simple USING vbplk_tab-magew
                                         vbplk_tab-magew
                                         vbplk_tab-gewei_max kg.

    PERFORM unit_conversion_simple USING vbplk_tab-tarag
                                         vbplk_tab-tarag
                                         vbplk_tab-gewei kg.
    vbplk_tab-gewei_max = kg.
    vbplk_tab-gewei     = kg.

    PERFORM unit_conversion_simple USING vbplk_tab-btvol
                                         vbplk_tab-btvol
                                         vbplk_tab-voleh_max m3.

    PERFORM unit_conversion_simple USING vbplk_tab-ntvol
                                         vbplk_tab-ntvol
                                         vbplk_tab-voleh_max m3.

    PERFORM unit_conversion_simple USING vbplk_tab-mavol
                                         vbplk_tab-mavol
                                         vbplk_tab-voleh_max m3.

    PERFORM unit_conversion_simple USING vbplk_tab-tavol
                                         vbplk_tab-tavol
                                         vbplk_tab-voleh m3.
    vbplk_tab-voleh_max = m3.
    vbplk_tab-voleh     = m3.

    MODIFY vbplk_tab.
  ENDLOOP.

  LOOP AT vtrlp_tab.
    PERFORM unit_conversion_simple USING vtrlp_tab-brgew
                                         vtrlp_tab-brgew
                                         vtrlp_tab-gewei kg.

    PERFORM unit_conversion_simple USING vtrlp_tab-ntgew
                                         vtrlp_tab-ntgew
                                         vtrlp_tab-gewei kg.
    vbplk_tab-gewei = kg.

    PERFORM unit_conversion_simple USING vtrlp_tab-volum
                                         vtrlp_tab-volum
                                         vtrlp_tab-voleh m3.
    vtrlp_tab-voleh = m3.

    MODIFY vtrlp_tab.
  ENDLOOP.

ENDFORM.                    "UNIT_CONVERSION

*---------------------------------------------------------------------*
*       FORM UNIT_CONVERSION_SIMPLE                                   *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VALUE(INPUT)                                                  *
*  -->  OUTPUT                                                        *
*  -->  VALUE(UNIT_IN)                                                *
*  -->  VALUE(UNIT_OUT)                                               *
*---------------------------------------------------------------------*
FORM unit_conversion_simple USING value(input)    TYPE any
                                        output    TYPE any
                                  value(unit_in)  LIKE t006-msehi
                                  value(unit_out) LIKE t006-msehi.

  CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
    EXPORTING
      input    = input
      unit_in  = unit_in
      unit_out = unit_out
    IMPORTING
      output   = output.

ENDFORM.                    "UNIT_CONVERSION_SIMPLE

*---------------------------------------------------------------------*
*       FORM CONDENSE_SHIPING_UNITS                                   *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VBPLK_TO_PRINT                                                *
*  -->  CMR_REC                                                       *
*---------------------------------------------------------------------*
FORM condense_shiping_units TABLES vbplk_to_print STRUCTURE xvbplk
                            USING  cmr_rec        TYPE      cmr_type.

  DATA: BEGIN OF vbplk_condensed OCCURS 0,
          vhilm     LIKE vbplk-vhilm,
          vebez     LIKE vbplk-vebez,
          tarag     LIKE vbplk-tarag,
          tavol     LIKE vbplk-tavol,
          number    LIKE sy-tabix.
  DATA: END OF vbplk_condensed.
  DATA: cmr_rec_06ff TYPE cmr_06ff_type.                    "Workarea
  DATA: l_exidv      LIKE vbplk-exidv.

* condense shiping units by vhilm
  LOOP AT vbplk_to_print.
    CLEAR: vbplk_condensed.
    MOVE-CORRESPONDING vbplk_to_print TO vbplk_condensed.
    vbplk_condensed-number = 1.
    COLLECT vbplk_condensed.
  ENDLOOP.

* generate output of shiping units
  LOOP AT vbplk_condensed.
    CLEAR: cmr_rec_06ff.
    IF ( vbplk_condensed-number = 1 ).
      READ TABLE vbplk_to_print WITH KEY vhilm = vbplk_condensed-vhilm.
* cmr_rec_06ff-pos06 is only 10 chars but exidv is 20 chars !
* so leading blanks or zeroes are ignored
      IF NOT vbplk_to_print-exidv2 IS INITIAL.
        l_exidv = vbplk_to_print-exidv2.
      ELSE.
        l_exidv = vbplk_to_print-exidv.
      ENDIF.
      SHIFT l_exidv LEFT DELETING LEADING ' 0'.
      cmr_rec_06ff-pos06 = l_exidv(10).
    ENDIF.
    cmr_rec_06ff-pos07 = vbplk_condensed-number.
    cmr_rec_06ff-pos08 = vbplk_condensed-vebez(40).
    cmr_rec_06ff-pos11 = vbplk_condensed-tarag.
    cmr_rec_06ff-pos12 = vbplk_condensed-tavol.
    cmr_rec_06ff-gewei = kg.
    cmr_rec_06ff-voleh = m3.

    APPEND cmr_rec_06ff TO cmr_rec-cmr_06ff.
  ENDLOOP.

ENDFORM.                    "CONDENSE_SHIPING_UNITS

*---------------------------------------------------------------------*
*       FORM CONDENSE_MATERIALS                                       *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  CMR_REC                                                       *
*  -->  VALUE(LEG)                                                    *
*---------------------------------------------------------------------*
FORM condense_materials USING  cmr_rec    TYPE  cmr_type
                               value(leg) LIKE xvtts.

  DATA: tmp_slp LIKE slp OCCURS 0 WITH HEADER LINE.      "copy of slp

  DATA: BEGIN OF vtrlp_condensed OCCURS 0,
          matnr     LIKE vtrlp-matnr,
          arktx     LIKE vtrlp-arktx,
          stawn     LIKE vtrlp-stawn,
          brgew     LIKE vtrlp-brgew,
          volum     LIKE vtrlp-volum.
  DATA: END OF vtrlp_condensed.

  DATA: tmp_t604t LIKE t604t OCCURS 0 WITH HEADER LINE.

  DATA: cmr_rec_06ff TYPE cmr_06ff_type.                "Workarea

* find relevant delivery-positions
  LOOP AT xvtsp WHERE tsnum = leg-tsnum.          "get shipment-position
    READ TABLE xvttp WITH KEY tpnum = xvtsp-tpnum. "get delivery
    LOOP AT slp WHERE vbeln = xvttp-vbeln.         "get delivery(item)
      APPEND slp TO tmp_slp.
    ENDLOOP.
  ENDLOOP.

* get stawn
  PERFORM get_stawn TABLES tmp_slp
                    USING  cmr_rec-country.

* condense delivery-positions by stawn if it is not initial
* otherwise condense by matnr
  LOOP AT tmp_slp.
    CLEAR: vtrlp_condensed.
    MOVE-CORRESPONDING tmp_slp TO vtrlp_condensed.
    IF NOT ( vtrlp_condensed-stawn IS INITIAL ).
      CLEAR: vtrlp_condensed-matnr,
             vtrlp_condensed-arktx.
    ENDIF.
    COLLECT vtrlp_condensed.
  ENDLOOP.

* get stawn-text
  SELECT * FROM t604t INTO TABLE tmp_t604t            "#EC CI_SGLSELECT
                      FOR ALL ENTRIES IN vtrlp_condensed
                      WHERE spras = cmr_rec-language     AND
                            land1 = cmr_rec-country      AND
                            stawn = vtrlp_condensed-stawn.

* generate output of condensed materials
  LOOP AT vtrlp_condensed.
    CLEAR: cmr_rec_06ff.
    IF ( vtrlp_condensed-stawn IS INITIAL ).
      cmr_rec_06ff-pos09 = vtrlp_condensed-arktx(14).
    ELSE.
      READ TABLE tmp_t604t WITH KEY spras = cmr_rec-language
                                    land1 = cmr_rec-country
                                    stawn = vtrlp_condensed-stawn.
      IF ( sy-subrc IS INITIAL ).
        cmr_rec_06ff-pos09 = tmp_t604t-text1(14).
      ENDIF.
      cmr_rec_06ff-pos10      = vtrlp_condensed-stawn(8).
      cmr_rec_06ff-pos10+8(2) = '* '.
    ENDIF.
    cmr_rec_06ff-pos11 = vtrlp_condensed-brgew.
    cmr_rec_06ff-pos12 = vtrlp_condensed-volum.
    cmr_rec_06ff-gewei = kg.
    cmr_rec_06ff-voleh = m3.

    APPEND cmr_rec_06ff TO cmr_rec-cmr_06ff.
  ENDLOOP.

ENDFORM.                    "CONDENSE_MATERIALS

*---------------------------------------------------------------------*
*       FORM GET_STAWN                                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  TMP_SLP                                                       *
*  -->  SENDER_COUNTRY                                                *
*---------------------------------------------------------------------*
FORM get_stawn TABLES tmp_slp STRUCTURE slp
               USING  sender_country    LIKE t604-land1.

  DATA: BEGIN OF tmp_marc OCCURS 0,
          matnr LIKE marc-matnr,
          werks LIKE marc-werks,
          stawn LIKE marc-stawn.
  DATA: END OF tmp_marc.

  DATA: BEGIN OF tmp_t001w OCCURS 0,
          werks LIKE t001w-werks,
          land1 LIKE t001w-land1.
  DATA: END OF tmp_t001w.
* deleted lines of n_729272
* v_n_729272
  DATA:
    tmp_marc_comb LIKE slp OCCURS 0 WITH HEADER LINE.
  DATA:
    BEGIN OF tmp_matnr OCCURS 0,
               matnr LIKE marc-matnr,
    END OF tmp_matnr.

*------------------------------------------------------------------
* The commodity code STAWN is determined for each delivery item.
* It is retrieved from the material master MARC segment
* using the item's material number and plant.
* If it is not found, it is retrieved by a second access from
* any other plant of the same country.
*------------------------------------------------------------------
* v_n_736942
* do not process unless there is a departure country code
  CHECK NOT sender_country IS INITIAL.
* do not process unless there are delivery items
  CHECK NOT tmp_slp[] IS INITIAL.
* ^_n_736942
* get all plants in sender_country
  SELECT werks land1
         FROM t001w
         INTO CORRESPONDING FIELDS OF TABLE tmp_t001w
         WHERE land1 = sender_country.

  SORT tmp_t001w BY werks land1.

* combinations of material and plant
  tmp_marc_comb[] = tmp_slp[].
* v_n_736942
* reduce to those delivery items where the STAWN is missing
  DELETE tmp_marc_comb WHERE NOT stawn IS INITIAL.
  CHECK NOT tmp_marc_comb[] IS INITIAL.
* ^_n_736942
  SORT tmp_marc_comb BY matnr werks.
  DELETE ADJACENT DUPLICATES
         FROM tmp_marc_comb
         COMPARING matnr werks.

* get all stawn for all material/plant combinations
  CHECK NOT tmp_marc_comb[] IS INITIAL.
  SELECT matnr werks stawn
         FROM marc
         INTO TABLE tmp_marc
         FOR ALL ENTRIES IN tmp_marc_comb
         WHERE matnr =  tmp_marc_comb-matnr
         AND   werks =  tmp_marc_comb-werks
         AND   stawn NE space.               "not initial
  SORT tmp_marc BY matnr werks.

* retrieve the stawn
  LOOP AT tmp_slp.
    CHECK tmp_slp-stawn IS INITIAL.                         "n_980662
    CLEAR sy-subrc.
    IF tmp_slp-werks IS INITIAL.
      sy-subrc = 4.
    ELSE.
*     retrieve with material/plant
      READ TABLE tmp_marc
           WITH KEY matnr = tmp_slp-matnr
                    werks = tmp_slp-werks
           BINARY SEARCH.
    ENDIF.
    IF NOT sy-subrc IS INITIAL.
*     check if retrieval was already done for this material
      READ TABLE tmp_matnr
           WITH KEY matnr = tmp_slp-matnr
           BINARY SEARCH.
      IF NOT sy-subrc IS INITIAL.
*       indicator for 2nd access by material only
        tmp_matnr-matnr = tmp_slp-matnr.
        INSERT tmp_matnr INDEX sy-tabix.
*       prepare all plants of the same country
        REFRESH tmp_marc_comb.
        tmp_marc_comb-matnr = tmp_slp-matnr.
        LOOP AT tmp_t001w.
          tmp_marc_comb-werks = tmp_t001w-werks.
          APPEND tmp_marc_comb.
        ENDLOOP.
        IF NOT tmp_marc_comb[] IS INITIAL.
*         determine stawn for all plants
          SELECT matnr werks stawn
                 FROM marc
                 APPENDING TABLE tmp_marc
                 FOR ALL ENTRIES IN tmp_marc_comb
                 WHERE matnr =  tmp_marc_comb-matnr
                 AND   werks =  tmp_marc_comb-werks
                 AND   stawn NE space.               "not initial
          IF sy-subrc IS INITIAL.
            SORT tmp_marc BY matnr werks.
          ELSE.
            CONTINUE.
          ENDIF.
        ENDIF.
      ENDIF.
*     retrieve stawn with material only
      READ TABLE tmp_marc
           WITH KEY matnr = tmp_slp-matnr
           BINARY SEARCH.
    ENDIF.
* insert the stawn
    IF sy-subrc IS INITIAL.
      tmp_slp-stawn = tmp_marc-stawn.
      MODIFY tmp_slp.
    ENDIF.
  ENDLOOP.

* ^_n_729272

ENDFORM.                    "GET_STAWN

*---------------------------------------------------------------------*
*       FORM ADDRESS_GET_DATA                                         *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VALUE(ADRNR)                                                  *
*  -->  SADR                                                          *
*---------------------------------------------------------------------*
FORM address_get_data USING value(adrnr) LIKE      sadr-adrnr"SADR40A
                            value(adrda) LIKE      vbpa-adrda
                            sadr         STRUCTURE sadr.    "SADR40A

  DATA:
    l_addr1_sel LIKE addr1_sel,
    l_read_sadr_only LIKE szad_field-flag.

  l_addr1_sel-addrnumber = adrnr.

  IF adrda CO 'DEF'.
    CLEAR l_read_sadr_only.
  ELSE.
    l_read_sadr_only = 'X'.
  ENDIF.

  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = l_addr1_sel
      read_sadr_only    = l_read_sadr_only
    IMPORTING
      sadr              = sadr
    EXCEPTIONS
      OTHERS            = 1.

  IF NOT ( sy-subrc IS INITIAL ).
    syst-msgid = 'VW'.
    syst-msgno = '002'.
    syst-msgty = 'E'.
    syst-msgv1 = text-001.
    syst-msgv2 = 'SADR'.
    syst-msgv3 = adrnr.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ADDRESS_GET_DATA

*---------------------------------------------------------------------*
*       FORM ADDRESS_INTO_PRINTFORM                                   *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  ADRS                                                          *
*---------------------------------------------------------------------*
FORM address_into_printform USING adrs         LIKE adrs.

  CALL FUNCTION 'ADDRESS_INTO_PRINTFORM'
    EXPORTING
      adrswa_in  = adrs
    IMPORTING
      adrswa_out = adrs.

ENDFORM.                    "ADDRESS_INTO_PRINTFORM

*---------------------------------------------------------------------*
*       FORM GET_LEGS_TO_PRINT                                        *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  LEGS_TAB                                                      *
*---------------------------------------------------------------------*
FORM get_legs_to_print TABLES legs_tab STRUCTURE xvtts.

  DATA: flag TYPE boolean.

  CLEAR:   legs_tab.
  REFRESH: legs_tab.
* save protocol record (general)
  protocol_tab-msg_arbgb = 'VW'.
  protocol_tab-msg_nr    = '080'.
  protocol_tab-msg_ty    = 'E'.
  protocol_tab-msg_v1    = vttkvb-tknum.
  APPEND protocol_tab.

* set there is nothing to print if there are no legs
  something_to_print = false.

  SORT xvtts BY tsrfo.
* check legs
  LOOP AT xvtts.
    PERFORM check_print_relevance USING    xvtts
                                  CHANGING flag.
* exit if the first print-relevant leg was found
    IF ( flag = true ).
      APPEND xvtts TO legs_tab.
      EXIT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "GET_LEGS_TO_PRINT

*---------------------------------------------------------------------*
*       FORM CHECK_PRINT_RELEVANCE                                    *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  LEG                                                           *
*  -->  FLAG                                                          *
*---------------------------------------------------------------------*
FORM check_print_relevance USING    leg LIKE xvtts
                           CHANGING flag.

  flag = false.
  something_to_print = false.

  IF ( leg-laufk = laufk-1 ) OR ( leg-laufk = laufk-4 ).
    IF ( leg-tdlnr = nast-parnr ).
      flag = true.
      something_to_print = true.
    ELSE.
* save protocol record (wrong laufk)
      protocol_tab-msg_arbgb = 'VW'.
      protocol_tab-msg_nr    = '082'.
      protocol_tab-msg_ty    = 'I'.
      protocol_tab-msg_v1    = leg-tsnum.
      APPEND protocol_tab.
    ENDIF.
  ELSE.
* save protocol record (wrong tdlnr)
    protocol_tab-msg_arbgb = 'VW'.
    protocol_tab-msg_nr    = '081'.
    protocol_tab-msg_ty    = 'I'.
    protocol_tab-msg_v1    = leg-tsnum.
    APPEND protocol_tab.
  ENDIF.

ENDFORM.                    "CHECK_PRINT_RELEVANCE

*---------------------------------------------------------------------*
*       FORM GET_SHIPING_UNITS                                        *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VBPLK_TO_CHECK                                                *
*  -->  VBPLK_TO_PRINT                                                *
*---------------------------------------------------------------------*
FORM get_shiping_units TABLES vbplk_to_check STRUCTURE xvbplk
                              vbplk_to_print STRUCTURE xvbplk.

  DATA: lin     LIKE sy-tabix.
  DATA: h_vbplk LIKE vbplk OCCURS 0.

  DESCRIBE TABLE vbplk_to_check LINES lin.

  CHECK NOT ( lin IS INITIAL ).

* print-relevant shiping units
  LOOP AT vbplk_to_check WHERE ( veltp <> veltp_tpm ).
    APPEND vbplk_to_check TO vbplk_to_print.
    DELETE vbplk_to_check.
  ENDLOOP.

* get child shiping units to check
  LOOP AT vbplk_to_check.
    LOOP AT xvbplk WHERE ( uevel = vbplk_to_check-venum ).
      APPEND xvbplk TO h_vbplk.
    ENDLOOP.
  ENDLOOP.

  REFRESH: vbplk_to_check.
  vbplk_to_check[] = h_vbplk[].

* check child shiping units
  PERFORM get_shiping_units TABLES vbplk_to_check
                                   vbplk_to_print.

ENDFORM.                    "GET_SHIPING_UNITS
*&---------------------------------------------------------------------*
*&      Form  create_xls_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM create_xls_file .
  TABLES: tve1t, ekpv, vbak, vbap, vbfa, knvk, ekbe.

  TYPES: BEGIN OF tp_tab_char,
  "CD1K971250 begin
  vkorg(20) TYPE c,
  spart(20) TYPE c,
  werks(20) TYPE c,
  vstel(20) TYPE c,
  "CD1K971250 end
  tknum(20) TYPE c,
***begin of mod-002 add
  bstkd(35)   TYPE c,
***end of mod-002 add
  delivery(20) TYPE c ,
  exidv(20) TYPE c ,
  bezei(20) TYPE c ,
  laeng(20) TYPE c ,
  breit(20) TYPE c ,
  hoehe(20) TYPE c ,
  meabm(20) TYPE c ,
  btvol(20) TYPE c ,
  voleh(20) TYPE c ,
  brgew(20) TYPE c ,
  gewei(20) TYPE c ,
  so_po(20) TYPE c ,
  vsbed_descr(20) TYPE c ,
  we_comp(41) TYPE c ,
  we_city(20) TYPE c ,
  we_street(110) TYPE c ,
  we_postal(20) TYPE c ,
  we_tel(20) TYPE c ,
  we_fax(20) TYPE c ,
  contact_name(50) TYPE c ,
  contact_tel(20) TYPE c ,
  "CD1K980837 begin
  name1(35)  TYPE c,  "Port of discharge
  name2(35)  TYPE c,  "Address line
  soldto(40) TYPE c,  "Sold-to party
***begin of mod-002 add
  name1_kv(35)   TYPE c,
  tel_number(30)   TYPE c,
  smtp_addr(241)   TYPE c,
***end of mod-002 add
  tdlnr(160) TYPE c,  "Forwarding Agent
  DGCLAS TYPE YSE_DGCLASS, " DG Class values for material
  "CD1K980837 end
          END OF tp_tab_char.

* Begin insertion by MOD-003.
    TYPES: BEGIN OF ty_delivery,
           vbeln TYPE vbeln_vl,
           END OF ty_delivery.

    TYPES: BEGIN OF ty_lips,
           vbeln  TYPE vbeln_vl,
           matnr  TYPE matnr,
           END OF ty_lips.

    DATA: gt_lips           TYPE STANDARD TABLE OF ty_lips,
          gt_delivery       TYPE STANDARD TABLE OF ty_delivery,
          gt_yse_matnr_dgl  TYPE STANDARD TABLE OF yse_matnr_dgl,
          wa_yse_matnr_dgl  TYPE yse_matnr_dgl,
          wa_delivery       TYPE ty_delivery,
          wa_lips           TYPE ty_lips.
* End insertiin by MOD-003

  DATA: it_tab_char1 TYPE STANDARD TABLE OF tp_tab_char.
  DATA: wa_tab_char1 TYPE tp_tab_char.
  DATA: lv_vsbed TYPE ekpv-vsbed.
  DATA: lv_spart TYPE ekpv-spart.                           "CD1K971250
  DATA: lv_type TYPE c.
  DATA: lv_kunnr LIKE ekpv-kunnr.
  DATA: lv_adrnr LIKE vbpa-adrnr.
  DATA: lv_parnr LIKE vbpa-parnr.
  DATA: lv_adrda LIKE vbpa-adrda.

  DATA: shipment_num LIKE vttk-tknum.
  DATA: lv_file TYPE string.

  DATA: lv_file1(132) TYPE c.

  DATA: lv_par1(40) TYPE c.
  DATA: lv_par2(40) TYPE c.
  DATA: it_tab TYPE STANDARD TABLE OF yse_forwarder_zfor.
  DATA: wa_tab TYPE yse_forwarder_zfor.
  DATA: lv_len1 TYPE i,
        lv_len2 TYPE i.
  DATA: i_szadr TYPE yse_printform_table OCCURS 0.
  DATA: w_szadr TYPE yse_printform_table,
        street4 TYPE stras_gp,
        street5 TYPE stras_gp.

  "CD1K980837 begin
  TABLES: stxh.
  DATA: l_vbelv TYPE vbfa-vbelv,
        l_kunnr TYPE vbak-kunnr,
        l_sdabw TYPE vbkd-sdabw,
        l_route TYPE vbap-route,
        l_tdlnr TYPE vttk-tdlnr,
        l_adrnr TYPE lfa1-adrnr,
        w_adrc TYPE adrc.
  DATA: t_lines TYPE TABLE OF tline WITH HEADER LINE.
  "CD1K980837 end
* Begin of insertion by MOD-001
  TYPES: BEGIN OF ty_vbak,
         vbeln  TYPE vbeln_va,
         bsark  TYPE bsark,
         ihrez  TYPE ihrez,
         END OF ty_vbak.

  TYPES: BEGIN OF ty_vbkd,
         vbeln    TYPE vbeln,
         posnr    TYPE posnr,
         ihrez_e  TYPE ihrez_e,
         END OF ty_vbkd.

  DATA: lt_yse_forwarder_t TYPE STANDARD TABLE OF yse_forwarder_t,
        wa_yse_forwarder_t TYPE yse_forwarder_t,
        wa_vbak            TYPE ty_vbak,
        wa_vbkd            TYPE ty_vbkd.
* End of insertion by MOD-001

  PERFORM get_custom_data.

*Fill the structure

* Begin of insertion by MOD-001
* Fetch the document types data
  SELECT * FROM yse_forwarder_t
           INTO TABLE lt_yse_forwarder_t.
  IF sy-subrc = 0.
    SORT lt_yse_forwarder_t BY bsark ASCENDING.
  ENDIF.
* End of insertion bt MOD-001

  LOOP AT slk.   "deliveries
    wa_tab-delivery = slk-vbeln.
    LOOP AT xvbplk   "handling units
            WHERE vpobjkey EQ slk-vbeln.
      wa_tab-tknum = vttkvb-tknum.
      wa_tab-delivery = slk-vbeln.
* Begin of insertion by MOD-003.
      wa_delivery-vbeln = slk-vbeln.
* End of insertion by MOD-003,

*Get the description for vegr1
      IF NOT xvbplk-vegr1 IS INITIAL.
        CLEAR tve1t-bezei.
        SELECT SINGLE bezei FROM tve1t INTO tve1t-bezei
                    WHERE vegr1 EQ xvbplk-vegr1 AND
                          spras EQ 'EN'.
        wa_tab-bezei = tve1t-bezei.
      ENDIF.
*>>>AIR22296 on 11/12/2007 (add exidv2)
      IF NOT xvbplk-exidv2 IS INITIAL.
        wa_tab-exidv = xvbplk-exidv2.
      ELSE.
        wa_tab-exidv = xvbplk-exidv.
      ENDIF.

      wa_tab-laeng = xvbplk-laeng.
      wa_tab-breit = xvbplk-breit.
      wa_tab-hoehe = xvbplk-hoehe.
      wa_tab-meabm = xvbplk-meabm.
      wa_tab-btvol = xvbplk-btvol.

      IF NOT xvbplk-voleh_max IS INITIAL.
        wa_tab-voleh = xvbplk-voleh_max.
      ELSE.
        wa_tab-voleh = xvbplk-voleh.
      ENDIF.

      wa_tab-brgew = xvbplk-brgew.

      IF NOT xvbplk-gewei_max IS INITIAL.
        wa_tab-gewei = xvbplk-gewei_max.
      ELSE.
        wa_tab-gewei = xvbplk-gewei.
      ENDIF.


*-------------------------------------------------------
*For the field SO_PO we need to decide which flow we are in
*It can contain either a sales order or a purchase order
*since we only wants the most recent one:
      DATA: BEGIN OF it_01 OCCURS 0,
        vbeln TYPE vbeln.
      DATA: END OF it_01.
      "CD1K980171  begin
      DATA:lv_bstnk TYPE bstnk.
      "CD1K980171 end
      CLEAR lv_type.
      SELECT vbelv FROM vbfa INTO TABLE it_01
                 WHERE vbeln EQ wa_tab-delivery AND
                       vbtyp_v EQ 'C'.
      IF sy-subrc EQ 0.
*Sales order flow
*VBFA-VBELV  contains the sales order
        DELETE ADJACENT DUPLICATES FROM it_01.
        SORT it_01 BY vbeln ASCENDING.
        LOOP AT it_01.
        ENDLOOP.
        wa_tab-so_po = it_01-vbeln.
        "CD1K980171  begin
        SELECT SINGLE bstnk INTO lv_bstnk FROM vbak WHERE vbeln = it_01-vbeln AND vkorg = 'CN06'.
        IF sy-subrc = 0.
          SELECT SINGLE vbeln INTO wa_tab-so_po FROM ekkn WHERE ebeln = lv_bstnk.
        ENDIF.
        "CD1K980171 end
        lv_type = 'S'.
      ELSE.
*PO flow
        CLEAR ekbe-ebeln.
        SELECT SINGLE ebeln FROM ekbe INTO ekbe-ebeln
                         WHERE belnr EQ wa_tab-delivery.

        wa_tab-so_po = ekbe-ebeln.
        lv_type = 'P'.
      ENDIF.
*-------------------------------------------------------


*Get the description for VSBED
      CLEAR: lv_vsbed, lv_kunnr.
      IF lv_type EQ 'S'.
        SELECT SINGLE vsbed kunnr spart FROM vbak INTO
                  (lv_vsbed, lv_kunnr, lv_spart)            "CD1K971250
                   WHERE vbeln EQ wa_tab-so_po.

      ELSEIF lv_type EQ 'P'.
        SELECT SINGLE vsbed kunnr spart FROM ekpv INTO
                  (lv_vsbed, lv_kunnr, lv_spart)            "CD1K971250
                   WHERE ebeln EQ wa_tab-so_po.
      ENDIF.

      IF lv_vsbed EQ 'Z1'.
        wa_tab-vsbed_descr = text-001.  "normal
      ELSEIF lv_vsbed EQ 'Z2' OR
             lv_vsbed EQ 'Z3'.
        wa_tab-vsbed_descr = text-002.  "express
      ENDIF.

*      IF lv_type EQ 'S'. "sales order flow
*new logic to get the contact person: one function



      CALL FUNCTION 'YSE_GET_CONTACT_PERSON'
        EXPORTING
          ls_vbeln = wa_tab-delivery
          ls_parvw = 'ZP'
        TABLES
          szadr    = l_szadr.

      CLEAR l_szadr.
      READ TABLE l_szadr WITH KEY line_type = 'N'.
      IF sy-subrc = 0.
        wa_tab-contact_name = l_szadr-address_line.
      ENDIF.


      CLEAR l_szadr.
      READ TABLE l_szadr WITH KEY line_type = 'T'.
      IF sy-subrc = 0.
        wa_tab-contact_tel = l_szadr-address_line.
      ENDIF.


*Select the 6 fields
*--------------------------------------------------
*Select the shipping partner from the delivery
      CLEAR vbpa.
      SELECT SINGLE kunnr adrnr adrda FROM vbpa INTO (vbpa-kunnr,
      vbpa-adrnr, vbpa-adrda)
                   WHERE vbeln EQ wa_tab-delivery AND
                         posnr EQ '000000' AND
                         parvw EQ 'WE'.
*>>>AIR22296: alway work with vbpa (5/12/2007)
*      IF vbpa-adrda EQ 'B' OR
*         vbpa-adrda EQ 'C' OR
*         vbpa-adrda EQ 'E' OR
*         vbpa-adrda EQ 'F'.
*This means it was manually changed in the sales order

*Adress number
      CLEAR adrc.
      SELECT SINGLE * FROM adrc INTO adrc
                WHERE addrnumber EQ vbpa-adrnr.
      CONCATENATE adrc-name1 adrc-name2
      INTO wa_tab-we_comp SEPARATED BY space.
*      wa_tab-we_comp = adrc-name1.

      wa_tab-we_city = adrc-city1.

*>>>air22296 on 17/12 here we insert street4 and street5

      CALL FUNCTION 'YSE_ADDR_GET'
       EXPORTING
         address_number         = vbpa-adrnr
*    SPRAS                  =
*    CHECKING_COUNTRY       =
     display                = 'Z1'
*  IMPORTING
*    SHOWLAND               =
       TABLES
         szadr                  = i_szadr
                .
*street 4

      CLEAR: w_szadr, street4.
      READ TABLE i_szadr INTO w_szadr WITH KEY line_type = '8'.
      IF sy-subrc = 0.
        street4 = w_szadr-address_line.
      ENDIF.
*street 5
      CLEAR: w_szadr, street5.
      READ TABLE i_szadr INTO w_szadr WITH KEY line_type = 'I'.
      IF sy-subrc = 0.
        street5 = w_szadr-address_line.
      ENDIF.

      CONCATENATE adrc-street street4 street5 INTO wa_tab-we_street
        SEPARATED BY space.
*>>>air22296
*      wa_tab-we_street = adrc-street.
      wa_tab-we_postal = adrc-post_code1.
      wa_tab-we_tel = adrc-tel_number.
      wa_tab-we_fax = adrc-fax_number.
      IF wa_tab-we_tel IS INITIAL OR
         wa_tab-we_fax IS INITIAL.
        CLEAR kna1.
        SELECT SINGLE * FROM kna1 INTO kna1
                  WHERE kunnr EQ vbpa-kunnr.
        IF wa_tab-we_tel IS INITIAL.
          wa_tab-we_tel = kna1-telf1.
        ENDIF.

        IF wa_tab-we_fax IS INITIAL.
          wa_tab-we_fax = kna1-telfx.
        ENDIF.
      ENDIF.
*      ELSE.
**Shipping partner data
*        CLEAR kna1.
*        SELECT SINGLE * FROM kna1 INTO kna1
*                  WHERE kunnr EQ vbpa-kunnr.
*        wa_tab-we_comp = kna1-name1.
*        wa_tab-we_city = kna1-ort01.
*        wa_tab-we_street = kna1-stras.
*        wa_tab-we_postal = kna1-pstlz.
*        wa_tab-we_tel = kna1-telf1.
*        wa_tab-we_fax = kna1-telfx.
*      ENDIF.

*--------------------------------------------------
      MOVE-CORRESPONDING wa_tab TO wa_tab_char1.
      WRITE wa_tab-exidv TO wa_tab_char1-exidv LEFT-JUSTIFIED.
      WRITE wa_tab-laeng TO wa_tab_char1-laeng UNIT wa_tab-meabm
      LEFT-JUSTIFIED.
      WRITE wa_tab-breit TO wa_tab_char1-breit UNIT wa_tab-meabm
      LEFT-JUSTIFIED.
      WRITE wa_tab-hoehe TO wa_tab_char1-hoehe UNIT wa_tab-meabm
      LEFT-JUSTIFIED.
      WRITE wa_tab-btvol TO wa_tab_char1-btvol UNIT wa_tab-voleh
      LEFT-JUSTIFIED.
      WRITE wa_tab-brgew TO wa_tab_char1-brgew UNIT wa_tab-gewei
      LEFT-JUSTIFIED.

      "CD1K971250 begin
      wa_tab_char1-vkorg = slk-vkorg.
      wa_tab_char1-spart = lv_spart.
      wa_tab_char1-werks = slk-werks.
      wa_tab_char1-vstel = slk-vstel.
      "CD1K971250 end

      "CD1K980837 begin
      "Sold-to party
      CLEAR: l_vbelv,l_kunnr,l_sdabw.
      SELECT SINGLE vbelv FROM vbfa INTO l_vbelv WHERE vbeln = slk-vbeln AND vbtyp_n = 'J'.
      IF sy-subrc = 0.
        SELECT SINGLE kna1~name1
                 FROM vbak
           INNER JOIN kna1 ON kna1~kunnr = vbak~kunnr
                 INTO wa_tab_char1-soldto
                WHERE vbeln = l_vbelv.

        SELECT SINGLE sdabw FROM vbkd INTO l_sdabw WHERE vbeln = l_vbelv. "Consignee Code

        CLEAR: stxh,t_lines,t_lines[].
        SELECT SINGLE * FROM stxh
         WHERE tdobject = 'VBBK'
           AND tdname   = l_vbelv
           AND tdid     = 'SL01'
           AND tdspras  = 'E'.
        IF sy-subrc = 0.
          CALL FUNCTION 'READ_TEXT'
            EXPORTING
              id       = stxh-tdid
              language = stxh-tdspras
              name     = stxh-tdname
              object   = stxh-tdobject
            TABLES
              lines    = t_lines.
          READ TABLE t_lines INDEX 1.
          IF sy-subrc = 0.
            l_kunnr = t_lines-tdline.
            CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
              EXPORTING
                input  = l_kunnr
              IMPORTING
                output = l_kunnr.
          ENDIF.
        ENDIF.

      ENDIF.

      "Port of discharge "Address line
      CLEAR: l_route.
      SELECT SINGLE route FROM vttk INTO l_route WHERE tknum = vttkvb-tknum. "Transport Mode

      SELECT SINGLE name1 name2 FROM yrd_icos_cst_adr INTO (wa_tab_char1-name1, wa_tab_char1-name2)
              WHERE kunnr = l_kunnr
                AND knref = l_sdabw
                AND route = l_route.
      "Forwarding Agent
      CLEAR: l_tdlnr,l_adrnr,w_adrc.
      SELECT SINGLE tdlnr FROM vttk INTO l_tdlnr WHERE tknum = vttkvb-tknum.
      IF sy-subrc = 0.
        SELECT SINGLE adrnr FROM lfa1 INTO l_adrnr WHERE lifnr = l_tdlnr.
        IF sy-subrc = 0.
          SELECT SINGLE * FROM adrc INTO w_adrc WHERE addrnumber = l_adrnr.
          IF sy-subrc = 0.
            CONCATENATE w_adrc-name1 '/' w_adrc-street '/' w_adrc-country '-' w_adrc-post_code1 w_adrc-city1
                   INTO wa_tab_char1-tdlnr SEPARATED BY space.
          ENDIF.
        ENDIF.
      ENDIF.
      "CD1K980837 end
*
* Begin of insertion by MOD-001
      SELECT SINGLE vbeln
                    bsark
                    ihrez FROM vbak
                          INTO wa_vbak WHERE vbeln = wa_tab_char1-so_po.
      IF sy-subrc = 0.
        READ TABLE lt_yse_forwarder_t INTO wa_yse_forwarder_t
                                      WITH KEY bsark = wa_vbak-bsark
                                      BINARY SEARCH.
        IF sy-subrc = 0.
          SELECT SINGLE vbeln
                        posnr
                        ihrez_e
                        FROM vbkd
                        INTO wa_vbkd WHERE vbeln = wa_vbak-vbeln.
          IF sy-subrc = 0.
            wa_tab_char1-so_po = wa_vbkd-ihrez_e.
          ENDIF.
        ENDIF.
      ENDIF.
* End of insertion by MOD-001
******begin of mod-002 insert
      SELECT SINGLE bstkd
        FROM vbkd
        INTO wa_tab_char1-BSTKD
        WHERE vbeln = wa_vbak-vbeln.
      CLEAR: vbpa.
      SELECT SINGLE kunnr adrnr parnr FROM vbpa INTO (vbpa-kunnr,
      vbpa-adrnr, vbpa-parnr)
                   WHERE vbeln EQ wa_tab-so_po AND
                         posnr EQ '000000' AND
                         parvw EQ 'AP'.
*        Sold to party contacter
      SELECT SINGLE name1
        INTO wa_tab_char1-name1_kv
        FROM knvk
        WHERE parnr = vbpa-parnr.
*     tel_number
      SELECT SINGLE tel_number
        FROM adrc
        INTO wa_tab_char1-tel_number
        WHERE addrnumber =     vbpa-adrnr
          AND nation = space.
*        smtp_addr
      SELECT SINGLE smtp_addr
        FROM adr6
        INTO wa_tab_char1-smtp_addr
        WHERE addrnumber =     vbpa-adrnr.
******end of mod-002 insert
      APPEND wa_tab_char1 TO it_tab_char1.
* Begin of insrtion by MOD-003
      APPEND wa_delivery TO gt_delivery.
      CLEAR wa_delivery.
* End of insrtion by MOD-003
      CLEAR: wa_tab, wa_tab_char1.
    ENDLOOP.
  ENDLOOP.

*Create the filepath
  CLEAR: lv_par1, lv_par2.
  GET PARAMETER ID 'YSE_FORWARDER_LOC1' FIELD lv_par1.
  GET PARAMETER ID 'YSE_FORWARDER_LOC2' FIELD lv_par2.

  CLEAR: lv_len1, lv_len2, lv_file, lv_file1.
  IF NOT lv_par1 IS INITIAL OR
     NOT lv_par2 IS INITIAL.

    lv_len1 = STRLEN( lv_par1 ).
    lv_len2 = STRLEN( lv_par2 ).

    lv_file1 = lv_par1.

    IF NOT lv_par2 IS INITIAL.
*      LV_FILE1+LV_LEN1(1) = '\'.
*      LV_LEN1 = LV_LEN1 + 1.
      lv_file1+lv_len1(lv_len2) = lv_par2.
    ENDIF.

    CONCATENATE lv_file1 '\' vttkvb-tknum '.xls' INTO lv_file.

  ELSE.
*if nothing in the user parameter, put it on the C:\
    CONCATENATE 'C:\' vttkvb-tknum '.xls' INTO lv_file.

  ENDIF.


*Put in the header for the file
  CLEAR wa_tab_char1.
  " CD1K971250
  wa_tab_char1-vkorg = text-025.
  wa_tab_char1-spart = text-026.
  wa_tab_char1-werks = text-027.
  wa_tab_char1-vstel = text-028.
  " CD1K971250

  wa_tab_char1-tknum = text-003.
****begin of mod-002 insert
  wa_tab_char1-bstkd = text-085.
****end of mod-002 insert
  wa_tab_char1-delivery = text-004.
  wa_tab_char1-exidv = text-005.
  wa_tab_char1-bezei = text-006.
  wa_tab_char1-laeng = text-007.
  wa_tab_char1-breit = text-008.
  wa_tab_char1-hoehe = text-009.
  wa_tab_char1-meabm = text-010.
  wa_tab_char1-btvol = text-011.
  wa_tab_char1-voleh = text-012.
  wa_tab_char1-brgew = text-013.
  wa_tab_char1-gewei = text-014.
  wa_tab_char1-so_po = text-015.
  wa_tab_char1-vsbed_descr = text-016.
  wa_tab_char1-we_comp = text-017.
  wa_tab_char1-we_city = text-018.
  wa_tab_char1-we_street = text-019.
  wa_tab_char1-we_postal = text-020.
  wa_tab_char1-we_tel = text-021.
  wa_tab_char1-we_fax = text-022.
  wa_tab_char1-contact_name = text-023.
  wa_tab_char1-contact_tel = text-024.
  "CD1K980837 begin
  wa_tab_char1-name1  = text-029.  "Port of discharge
  wa_tab_char1-name2  = text-030.  "Address line
  wa_tab_char1-soldto = text-031.  "Sold-to party
****begin of mod-002 insert
  wa_tab_char1-name1_kv = text-081.
  wa_tab_char1-tel_number = text-082.
  wa_tab_char1-smtp_addr = text-083.
****end of mod-002 insert
  wa_tab_char1-tdlnr  = text-032.  "Forwarding Agent
  wa_tab_char1-DGCLAS = text-033.  " DG Class
  "CD1K980837 end
  INSERT wa_tab_char1 INTO it_tab_char1 INDEX 1.

* Begin insertion by MOD-003.
    IF  NOT it_tab_char1[] IS INITIAL .
      SORT gt_delivery BY vbeln.
      DELETE ADJACENT DUPLICATES FROM gt_delivery COMPARING vbeln.

* Fetch the MATNR using the Delivery number from LIPS table
      SELECT vbeln matnr FROM lips
                         INTO TABLE gt_lips
                         FOR ALL ENTRIES IN gt_delivery
                         WHERE vbeln = gt_delivery-vbeln.
      IF sy-subrc = 0.
        SORT gt_lips BY vbeln matnr.
* Fetch the DG level using MATNR from table yse_matnr_dgl
        SELECT * FROM yse_matnr_dgl
                 INTO TABLE gt_yse_matnr_dgl
                 FOR ALL ENTRIES IN gt_lips
                 WHERE matnr = gt_lips-matnr.
        IF sy-subrc = 0.
          SORT gt_yse_matnr_dgl BY matnr.
* Update the DG class of the delivery in forwarder file based on Material and
* DG value avaialble in yse_matnr_dgl.
          LOOP AT it_tab_char1 INTO wa_tab_char1
                               WHERE vkorg = 'CN06'.
            READ TABLE gt_lips INTO wa_lips
                               WITH KEY vbeln = wa_tab_char1-delivery
                               BINARY SEARCH.
            IF sy-subrc = 0.
              READ TABLE gt_yse_matnr_dgl INTO wa_yse_matnr_dgl
                                          WITH KEY matnr = wa_lips-matnr
                                          BINARY SEARCH.
              IF sy-subrc = 0.
                wa_tab_char1-dgclas = wa_yse_matnr_dgl-dgclas.
                MODIFY it_tab_char1 FROM wa_tab_char1
                                    TRANSPORTING dgclas.
                CLEAR: wa_yse_matnr_dgl,
                       wa_tab_char1,
                       wa_lips.
              ENDIF.
            ENDIF.
          ENDLOOP.
        ENDIF.
      ENDIF.
    ENDIF.
* End insertion by MOD-003.

  IF nast-vsztp NE '4'.
*Do not use the frontend function for option 4 'transfer immediately'
*Because this is frontend function and output is in background
*otherwise it dumps!!!

    CALL METHOD cl_gui_frontend_services=>gui_download
      EXPORTING
        filename                = lv_file
        filetype                = 'ASC'
        codepage                = '8400'
        write_field_separator   = 'X'
      CHANGING
        data_tab                = it_tab_char1
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        not_supported_by_gui    = 22
        error_no_gui            = 23
        OTHERS                  = 24.

    IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDIF.

ENDFORM.                    " create_xls_file
*&---------------------------------------------------------------------*
*&      Form  get_custom_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_custom_data .
  DATA: shipment_num LIKE vttk-tknum,
        language     LIKE nast-spras,
        cmr_record   TYPE cmr_type,
        sadr_begin   LIKE sadr,                             "SADR40A
        sadr_end     LIKE sadr,                             "SADR40A
        cmr_xvtts    LIKE xvtts OCCURS 0 WITH HEADER LINE.
  "print relevant segments

  language     = nast-spras.
  shipment_num = nast-objky.

  CALL FUNCTION 'RV_SHIPMENT_PRINT_VIEW'
    EXPORTING
      shipment_number     = shipment_num
      option_tvtk         = true          "Shipmenttype Y/N
      option_ttds         = true          "Disposition Y/N
      language            = language
      option_items        = true          "Transport Items Y/N
      option_sales_orders = true          "Transport Segments Y/N
      option_export_data  = true          "Partners Y/N
      option_segments     = true          "Sales orders Y/N
      option_partners     = true          "Export data Y/N
      option_packages     = true          "Packages Y/N
      option_flow         = true          "Flow Y/N
      option_no_refresh   = false         "Refresh Tables Y/N
    IMPORTING
      f_vttkvb            = vttkvb        "Shipment Head
      f_tvtk              = tvtk          "Shipmenttype
      f_tvtkt             = tvtkt         "Description Shipmenttye
      f_ttds              = ttds          "Disposition
      f_ttdst             = ttdst         "Description Disposition
      f_vbpla             = vbpla         "Packages
    TABLES
      f_vttp              = xvttp         "Shipment Items
      f_trlk              = slk           "Delivery
      f_trlp              = slp           "Delivery Item
      f_vtts              = xvtts         "Shipment Segments
      f_vtsp              = xvtsp         "Segments/Items
      f_vbpa              = xvbpa         "Partner
      f_vbadr             = xvbadr        "Address
      f_vtfa              = xvtfa         "Flow
      f_vbplk             = xvbplk        "Shipment Unit Header
      f_vbplp             = xvbplp        "Shipment Unit
      f_vbpls             = xvbpls        "Shipment Unit Sum
    EXCEPTIONS
      not_found           = 1
      OTHERS              = 2.

ENDFORM.                    " get_custom_data

*Text symbol text
*001:Normal
*002:Express
*003:Shipment No
*004:Delivery No
*005:Case No
*006:Goods description
*007:Length
*008:Width
*009:Height
*010:LxWxH UOM
*011:Volume
*012:Volume UOM
*013:Weight
*014:Weight UOM
*015:Order no
*016:Tr.Mode
*017:Company
*018:City
*019:Street + No
*020:Postal code
*021:Tel
*022:Fax
*023:Contact person
*024:Tel CP
*025:Sales Org.
*026:Division
*027:Plant
*028:Shipping Point
*029:Port of discharge
*030:Address line
*031:Sold-to party
*032:Forwarding Agent
*033:DG Class
*081:Sold to party contacter
*082:Sold to party contacter Telephone
*083:Sold to party contacter Mail
*085:Contract no(SO's PO no.)
