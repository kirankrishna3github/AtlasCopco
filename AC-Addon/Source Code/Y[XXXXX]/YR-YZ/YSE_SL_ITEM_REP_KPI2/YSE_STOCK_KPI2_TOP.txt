*&---------------------------------------------------------------------*
*&  Include           YSE_STOCK_ITEM_TOP_V2
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&  Include          YSE_STOCK_OVERVIEW_TOP                            *
*&---------------------------------------------------------------------*
* MOD-004|20160704|Anda Wu         |CD1K989216|    CR3998              *
*       Bugfix: Report changes after flow adjustment in CR3832         *
************************************************************************

* Tables
TABLES:
  MARA, MARD, VBAP, YSE_EM_SOHISTMIG, YSE_STOCK_OVERVIEW_ITEM, MVKE,
  MARC, EINE, YSE_EM_MATPLANT, MBEW, ekko,likp, MCHA, MCHB, RF02K.

* Constants
CONSTANTS:
  C_X(1)   TYPE C VALUE 'X',
  C_PO_REPLENISHMENT(4) TYPE C VALUE 'ZNB1',
  C_PSTYP_STOCK_TR(1)   TYPE C VALUE '7'.

* Ranges
RANGES:
  R_PRDHA         FOR MARA-PRDHA,
  R_BWART_RECEIPT FOR MSEG-BWART,
  R_BWART_ISSUE   FOR MSEG-BWART,
  R_BWART_ALL     FOR MSEG-BWART,
  S_LIFNR10       FOR LFA1-LIFNR.

* Variables
DATA:
  GV_WAERS     LIKE T001-WAERS,
  GV_EKORG     TYPE EKORG,
  GV_VKORG     TYPE VKORG,
  GV_GAC(4)    TYPE C,
  GV_PGC(4)    TYPE C,
  GV_PLC(4)    TYPE C,
  GV_NORESULT  TYPE C,
  GV_LIFNR     LIKE LFA1-LIFNR,
  GV_WHTYPE    LIKE YSE_EM_PLANT-WHTYPE,
  OK_CODE      LIKE SY-UCOMM,
  SAVE_OK_CODE LIKE SY-UCOMM,
  MY_CONTAINER TYPE REF TO CL_GUI_DOCKING_CONTAINER,
  MY_ALV       TYPE REF TO CL_GUI_ALV_GRID,
  MY_HANDLER   TYPE REF TO LCL_EVENT_HANDLER,
  V_DAT        LIKE SY-DATUM,
  V_TIM        LIKE SY-UZEIT.


* Working Areas
DATA:
  WA_OUTPUT  TYPE YSE_BATCH_STOCK_OVERVIEW_ITEM,
  WA_LAYOUT  TYPE LVC_S_LAYO,
  WA_VARIANT TYPE DISVARIANT,
  BEGIN OF WA_MATERIAL,
    MATNR LIKE VBAP-MATNR,
    WERKS LIKE MARD-WERKS,
    VKORG LIKE MVKE-VKORG,
    LGORT LIKE MARD-LGORT,
    MTART LIKE MARA-MTART,
    MATKL LIKE MARA-MATKL,
    PRDHA LIKE MARA-PRDHA,
    MAKTX LIKE MAKT-MAKTX,
    DISMM LIKE MARC-DISMM,
****BEGIN OF MOD-004 INSERT
    BWTAR LIKE MCHA-BWTAR,
****END OF MOD-004 INSERT
    ERSDA LIKE MCHB-ERSDA,
    CHARG LIKE MCHB-CHARG,
    CLABS LIKE MCHB-CLABS,
    CINSM LIKE MCHB-CINSM,
    CSPEM LIKE MCHB-CSPEM,
    CRETM LIKE MCHB-CRETM,
    CUMLM LIKE MCHB-CUMLM,
  END OF WA_MATERIAL,
  BEGIN OF WA_FCHDR,
    MATNR LIKE YSE_EM_FCHDR-MATNR,
    CONFC LIKE YSE_EM_FCHDR-CONFC,
  END OF WA_FCHDR,
  BEGIN  OF WA_MSKU,
    MATNR LIKE VBAP-MATNR,
    WERKS LIKE MARD-WERKS,
    KULAB LIKE MSKU-KULAB,
  END OF WA_MSKU,
  BEGIN  OF WA_MSKA,
    MATNR LIKE MSKA-MATNR,
    WERKS LIKE MSKA-WERKS,
    CHARG LIKE MSKA-CHARG,
    KALAB LIKE MSKA-KALAB,
  END OF WA_MSKA,
  BEGIN OF WA_EORD,
    MATNR LIKE VBAP-MATNR,
    WERKS LIKE EORD-WERKS,
    LIFNR LIKE EORD-LIFNR,
    FLIFN LIKE EORD-FLIFN,
    KTOKK LIKE LFA1-KTOKK,
  END OF WA_EORD,
  BEGIN OF WA_MBEW ,
    MATNR LIKE MBEW-MATNR,
    WERKS LIKE MARC-WERKS,
    BWTAR LIKE MBEW-BWTAR,
    STPRS LIKE MBEW-STPRS,
* begin of insertion MOD-006
    verpr like mbew-verpr,
* end of insertion MOD-006
    PEINH LIKE MBEW-PEINH,
  END OF WA_MBEW.
DATA: BEGIN OF WA_ALLOC_EXT,
        MATNR	LIKE MARA-MATNR,
        WERKS LIKE MARC-WERKS,
        LGORT LIKE MARD-LGORT,
        ALLOC_QUANTITY LIKE VBAP-KWMENG,
      END OF WA_ALLOC_EXT,
      BEGIN OF WA_EKPO,
        EBELN LIKE EKPO-EBELN,
        EBELP LIKE EKPO-EBELP,
        MATNR LIKE VBAP-MATNR,
        WERKS LIKE EKPO-WERKS,
        LGORT LIKE EKPO-LGORT,
        MENGE LIKE EKPO-MENGE,
      END OF WA_EKPO,
      BEGIN OF WA_OPEN_PO,
        MATNR LIKE VBAP-MATNR,
        WERKS LIKE VBAP-WERKS,
        LGORT LIKE VBAP-LGORT,
        QTY LIKE EKPO-MENGE,
      END OF WA_OPEN_PO,
      BEGIN OF WA_TRANSIT,
        VBELN LIKE LIPS-VBELN,
        POSNR LIKE LIPS-POSNR,
        MATNR LIKE VBAP-MATNR,
        WERKS LIKE LIPS-WERKS,
        LGORT LIKE LIPS-LGORT,
        LFIMG LIKE LIPS-LFIMG,
      END OF WA_TRANSIT,
      BEGIN OF WA_TRANSIT_AGGR,
        MATNR LIKE VBAP-MATNR,
        WERKS LIKE VBAP-WERKS,
        LGORT LIKE LIPS-LGORT,
        LFIMG LIKE LIPS-LFIMG,
      END OF WA_TRANSIT_AGGR,
      BEGIN OF WA_EKBE ,
        EBELN LIKE EKBE-EBELN,
        EBELP LIKE EKBE-EBELP,
        ZEKKN LIKE EKBE-ZEKKN,
        VGABE LIKE EKBE-VGABE,
        GJAHR LIKE EKBE-GJAHR,
        BELNR LIKE EKBE-BELNR,
        BUZEI LIKE EKBE-BUZEI,
        MATNR LIKE VBAP-MATNR,
        WERKS LIKE EKBE-WERKS,
        MENGE LIKE EKPO-MENGE,
        BWART LIKE EKBE-BWART,
      END OF WA_EKBE,
      BEGIN OF WA_EINE,
        MATNR LIKE EINA-MATNR,
        WERKS LIKE EINE-WERKS,
        NETPR LIKE EINE-NETPR,
        PEINH LIKE EINE-PEINH,
        WAERS LIKE EINE-WAERS,
        APLFZ LIKE EINE-APLFZ,
        EVERS LIKE EINE-EVERS,
      END OF WA_EINE,
      BEGIN OF WA_VBAP,
        VBELN  TYPE VBELN_VA,
        POSNR  TYPE POSNR_VA,
        MATNR  TYPE MATNR,
        KWMENG TYPE KWMENG,
        WERKS  TYPE WERKS_EXT,
        LGORT  TYPE LGORT_D,
        ABGRU  LIKE VBAP-ABGRU,
      END OF WA_VBAP,
* Begin of insert MOD-007
      BEGIN OF WA_VBAP2,
        VBELN  TYPE VBELN_VA,
        POSNR  TYPE POSNR_VA,
        MATNR  TYPE MATNR,
        KWMENG TYPE KWMENG,
        WERKS  TYPE WERKS_EXT,
        VBTYP  TYPE VBTYP,
      END OF WA_VBAP2,
      BEGIN OF WA_VBAP3,
        VBELN  TYPE VBELN_VA,
        VBELV  TYPE VBELN_VA,
      END OF WA_VBAP3,
* End of insert MOD-007
      BEGIN OF WA_VBEP,
        VBELN  TYPE VBELN,
        POSNR  TYPE POSNR,
        BMENG TYPE BMENG,
      END OF WA_VBEP,
      BEGIN OF WA_LIPS,
        VBELV TYPE VBELN_VON,
        POSNV TYPE POSNR_VON,
        MATNR TYPE MATNR,
        LGORT TYPE LGORT_D,
        LFIMG TYPE LFIMG,
        WERKS TYPE WERKS_D,
      END OF WA_LIPS,


  BEGIN OF STR_REC  ,            " Receipt date
    mblnr like mkpf-mblnr,
    MATNR TYPE MATNR,
    WERKS TYPE WERKS_D,
    BUDAT TYPE BUDAT,
    ebeln like ekko-ebeln,
  END OF STR_REC,

  BEGIN OF STR_REC1  ,            " Receipt date
    mblnr like mkpf-mblnr,
    MATNR TYPE MATNR,
    NFMAT TYPE MARC-NFMAT,
    WERKS TYPE WERKS_d,
    BUDAT TYPE BUDAT,
    ebeln like mseg-ebeln,
  END OF STR_REC1,

      BEGIN OF WA_RESB,
        MATNR LIKE VBAP-MATNR,
        WERKS LIKE RESB-WERKS,
        LGORT LIKE RESB-LGORT,
        BDMNG LIKE RESB-BDMNG,
        ENMNG LIKE RESB-ENMNG,
        VMENG LIKE RESB-VMENG,
        UMREZ LIKE RESB-UMREZ,
        UMREN LIKE RESB-UMREN,
        XWAOK LIKE RESB-XWAOK,
      END OF WA_RESB,
      BEGIN OF WA_MARC,
        MATNR LIKE MARC-MATNR,
        WERKS LIKE MARC-WERKS,
        EISBE LIKE MARC-EISBE,
      END OF WA_MARC,

      BEGIN OF WA_EBAN,
        MATNR LIKE EBAN-MATNR,
        RESWK LIKE EBAN-RESWK,
        MENGE LIKE EBAN-MENGE,
      END OF WA_EBAN,
      BEGIN OF WA_SUPERS,
        MATNR LIKE EBAN-MATNR,
        NFMAT LIKE MARC-NFMAT,
      END OF WA_SUPERS,

      BEGIN OF WA_MVKE,
        MATNR LIKE MVKE-MATNR,
        VKORG LIKE MVKE-VKORG,
        VTWEG LIKE MVKE-VTWEG,
        PRODH LIKE MVKE-PRODH,
*        WERKS LIKE MARC-WERKS,
        MTPOS LIKE MVKE-MTPOS,
        MVGR5 LIKE MVKE-MVGR5,
        MVGR4 LIKE MVKE-MVGR4,
      END OF WA_MVKE,

      WA_T179 TYPE T179.

*Begin of Insertion by MOD-005

 TYPES: BEGIN OF ty_ekbe1,
       EBELN TYPE EBELN,
       SHKZG TYPE SHKZG,
       matnr TYPE matnr,
       werks TYPE werks,
       CHARG TYPE CHARG_D,
      END OF ty_ekbe1.
 TYPES:BEGIN OF ty_rseg,
       BELNR TYPE BELNR_D,
       EBELN TYPE EBELN,
       MATNR TYPE MATNR,
       BUKRS TYPE BUKRS,
       WERKS TYPE WERKS_D,
       WRBTR TYPE WRBTR,
       MENGE TYPE MENGE_D,
       SHKZG TYPE SHKZG,
       BWTAR TYPE BWTAR_D,
       END OF ty_rseg.

 TYPES: BEGIN OF ty_rbkp,
        BELNR TYPE BELNR_D,
        bukrs TYPE bukrs,
        waers TYPE WAERS,
        KURSF TYPE KURSF,
       END OF ty_rbkp.

DATA: gv_bukrs TYPE bukrs,
      lv_unit_price TYPE wrbtr,
      lv_wrbtr TYPE wrbtr.

DATA: it_ekbe1     TYPE ty_ekbe1 OCCURS 0 WITH HEADER LINE,
       it_rseg      TYPE ty_rseg  OCCURS 0 WITH HEADER LINE,
       it_rbkp      TYPE ty_rbkp  OCCURS 0 WITH HEADER LINE,
       it_material1 like wa_material OCCURS 0 WITH HEADER LINE,
       wa_rseg      TYPE ty_rseg,
       wa_rbkp      type ty_rbkp.

CONSTANTS: gc_bukrs TYPE C LENGTH 4 VALUE 'MRUA'.

*End of Insertion by MOD-005

* Internal tables
DATA:
  IT_OUTPUT        TYPE YSE_BATCH_STOCK_OVERVIEW_ITEM OCCURS 0,
  IT_OUTPUT1       TYPE YSE_BATCH_STOCK_OVERVIEW_ITEM OCCURS 0,
  IT_MATERIAL      LIKE WA_MATERIAL        OCCURS 0 WITH HEADER LINE,
  IT_FCHDR         LIKE WA_FCHDR           OCCURS 0 WITH HEADER LINE,
  IT_MSKU          LIKE WA_MSKU            OCCURS 0 WITH HEADER LINE,
  IT_MVGR5         LIKE TVM5T              OCCURS 0 WITH HEADER LINE,
  IT_MSKA          LIKE WA_MSKA            OCCURS 0 WITH HEADER LINE,
  IT_MATPLANT      LIKE YSE_EM_MATPLANT    OCCURS 0 WITH HEADER LINE,
  IT_SUPERS        LIKE WA_SUPERS          OCCURS 0 WITH HEADER LINE,
  IT_T141T         LIKE T141T              OCCURS 0 WITH HEADER LINE,
  GT_REC_DAT       LIKE STR_REC1           OCCURS 0 WITH HEADER LINE,
  GT_REC_DAT1      LIKE STR_REC            OCCURS 0 WITH HEADER LINE,
  GT_ISS_DAT       LIKE STR_REC1           OCCURS 0 WITH HEADER LINE,
  GT_ISS_DAT1      LIKE STR_REC            OCCURS 0 WITH HEADER LINE,
  IT_EORD          LIKE WA_EORD            OCCURS 0 WITH HEADER LINE,
  IT_EVERS         LIKE T027B              OCCURS 0 WITH HEADER LINE,
  IT_MBEW          LIKE WA_MBEW            OCCURS 0 WITH HEADER LINE,
  IT_MVKE          LIKE WA_MVKE            OCCURS 0 WITH HEADER LINE,
  IT_ALLOC         LIKE WA_ALLOC_EXT       OCCURS 0 WITH HEADER LINE,
  IT_STBO_SO       LIKE IT_ALLOC           OCCURS 0 WITH HEADER LINE,
  IT_EKPO          LIKE WA_EKPO            OCCURS 0 WITH HEADER LINE,
  IT_OPEN_PO       LIKE WA_OPEN_PO         OCCURS 0 WITH HEADER LINE,
  IT_TRANSIT       LIKE WA_TRANSIT         OCCURS 0 WITH HEADER LINE,
  IT_TRANSIT_AGGR  LIKE WA_TRANSIT_AGGR    OCCURS 0 WITH HEADER LINE,
  IT_EKBE          LIKE WA_EKBE            OCCURS 0 WITH HEADER LINE,
  IT_EINE          LIKE WA_EINE            OCCURS 0 WITH HEADER LINE,
  IT_VBAP          LIKE WA_VBAP            OCCURS 0 WITH HEADER LINE,
  IT_VBEP          LIKE WA_VBEP            OCCURS 0 WITH HEADER LINE,
  IT_LIPS          LIKE WA_LIPS            OCCURS 0 WITH HEADER LINE,
  IT_RESB          LIKE WA_RESB            OCCURS 0 WITH HEADER LINE,
  IT_EBAN          LIKE WA_EBAN            OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZOR       LIKE WA_VBAP2           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZO03       LIKE WA_VBAP2           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZRE1       LIKE WA_VBAP2           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZOR_6       LIKE WA_VBAP3           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZO03_6       LIKE WA_VBAP3           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZRE1_6       LIKE WA_VBAP3           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZOR_12       LIKE WA_VBAP3           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZO03_12       LIKE WA_VBAP3           OCCURS 0 WITH HEADER LINE,
  IT_VBAP_HT_ZRE1_12       LIKE WA_VBAP3           OCCURS 0 WITH HEADER LINE,
  LV_NBR_ZOR_6 TYPE i,
  LV_NBR_ZOR_12 TYPE i,
  LV_NBR_ZO03_6 TYPE i,
  LV_NBR_ZO03_12 TYPE i,
  LV_NBR_ZRE1_6 TYPE i,
  LV_NBR_ZRE1_12 TYPE i,
  BEGIN OF IT_A017 OCCURS 0,
    KAPPL LIKE A017-KAPPL,
    KSCHL LIKE A017-KSCHL,
    LIFNR LIKE A017-LIFNR,
    MATNR LIKE A017-MATNR,
    EKORG LIKE A017-EKORG,
    WERKS LIKE A017-WERKS,
    ESOKZ LIKE A017-ESOKZ,
    DATBI LIKE A017-DATBI,
    DATAB LIKE A017-DATAB,
    KNUMH LIKE A017-KNUMH,
    KOPOS LIKE KONP-KOPOS,
    KBETR LIKE KONP-KBETR,
    KPEIN LIKE KONP-KPEIN,
    KONWA LIKE KONP-KONWA,
  END OF IT_A017,

  BEGIN OF IT_LIFNR OCCURS 0,
    LIFNR LIKE LFA1-LIFNR,
  END OF IT_LIFNR,

  IT_FIELDCAT      TYPE LVC_T_FCAT,
  BEGIN OF IT_PLANT                        OCCURS 0,
    WERKS          LIKE YSE_EM_PLANT-WERKS,
    WHTYPE         LIKE YSE_EM_PLANT-WHTYPE,
    WHSTDES        LIKE YSE_EM_PLANT-WHSTDES,
    NAME1          LIKE T001W-NAME1,
  END OF  IT_PLANT,
  BEGIN OF IT_DISMOD  OCCURS 0,
    DISMOD TYPE ZDISTRMODE_TXT,
  END OF IT_DISMOD,
  BEGIN OF IT_STOCKPOL  OCCURS 0,
    STOCKPOL TYPE ZSTOPO,
  END OF IT_STOCKPOL,

  BEGIN OF IT_RETURN_TAB                   OCCURS 0.
        INCLUDE STRUCTURE DDSHRETVAL. DATA:
      END OF IT_RETURN_TAB,
      IT_T179          TYPE T179               OCCURS 0.

DATA:
  BEGIN OF IT_MSEG                     OCCURS 0,
    MBLNR TYPE MKPF-MBLNR,
    MJAHR TYPE MKPF-MJAHR,
    ZEILE TYPE MSEG-ZEILE,
    BUDAT TYPE MKPF-BUDAT,
    BWART TYPE MSEG-BWART,
    MATNR TYPE MSEG-MATNR,
    EBELN TYPE MSEG-EBELN,
  END OF IT_MSEG,
  BEGIN OF IT_REC OCCURS 0,
    MATNR TYPE MSEG-MATNR,
    BUDAT TYPE MKPF-BUDAT,
  END OF IT_REC,
  BEGIN OF IT_ISS OCCURS 0,
    MATNR TYPE MSEG-MATNR,
    BUDAT TYPE MKPF-BUDAT,
  END OF IT_ISS,
  BEGIN OF IT_EKPO2 OCCURS 0 ,
    EBELN LIKE EKPO-EBELN,
    EBELP LIKE EKPO-EBELP,
    MATNR LIKE VBAP-MATNR,
    LGORT LIKE EKPO-LGORT,
    MENGE LIKE EKPO-MENGE,
  END OF IT_EKPO2,
  BEGIN OF IT_EKBE2 OCCURS 0,
    EBELN LIKE EKPO-EBELN,
    EBELP LIKE EKPO-EBELP,
    MATNR LIKE VBAP-MATNR,
    MENGE LIKE EKPO-MENGE,
    BELNR LIKE EKBE-BELNR,
    BWART LIKE EKBE-BWART,
  END OF IT_EKBE2.



DATA: LV_TDNAME LIKE THEAD-TDNAME,
      IT_LINES LIKE TLINE OCCURS 0 WITH HEADER LINE.

DATA: WA_PER_1YRBACK   LIKE YSE_EM_SOHIST-PERIOD,
      WA_PER_LASTMONTH LIKE YSE_EM_SOHIST-PERIOD.

DATA: IT_YSE_EM_PL_CENTR LIKE YSE_EM_PL_CENTR
         OCCURS 0 WITH HEADER LINE.

DATA: IT_YSE_EM_PL_DISTR LIKE YSE_EM_PL_DISTR
         OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF IT_TVKWZ OCCURS 0,
        VKORG      LIKE TVKWZ-VKORG,
        VTWEG      LIKE TVKWZ-VTWEG,
        WERKS      LIKE TVKWZ-WERKS.
DATA: END OF IT_TVKWZ.
RANGES: R_BZIRK      FOR YSE_EM_PL_DISTR-BZIRK.

DATA: BEGIN OF WA_SOHIST ,
  MATNR LIKE VBAP-MATNR,
  ZMENG LIKE YSE_EM_SOHIST-ZMENG,
  ZLINE LIKE YSE_EM_SOHIST-ZLINE,
END OF  WA_SOHIST.

DATA: IT_YSE_EM_SOHIST LIKE  YSE_EM_SOHIST OCCURS 0 WITH HEADER LINE.

DATA: IT_SOHIST LIKE  WA_SOHIST OCCURS 0 WITH HEADER LINE.


*   internal table for last receipt date and last issue date
DATA: IT_SURPLUS TYPE YSE_SURPLUS_HD01 OCCURS 0 WITH HEADER LINE.

DATA  IT_FCVAL LIKE TABLE OF YSE_EM_FCVAL WITH HEADER LINE.

DATA: P_VKORG LIKE MVKE-VKORG.
