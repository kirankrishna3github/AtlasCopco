*---------------------------------------------------------------------*
*                       Cash Journal
*---------------------------------------------------------------------*
* Done by Geert Rutten
* This program is a copy from program RFCASH20
* and is changed for MRUA (not show ALV but show print document instead)
* Transaction cod FBCJC3 to link this program for Russia only
* 12 Aug 2010
*---------------------------------------------------------------------*
*=====================================================================*
* Change History Log                                                  *
*---------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number | Change Ref*
*---------------------------------------------------------------------*
***********************************************************************

REPORT  YSE_RFCASH20                                .

********************************************************************
* Declarations *****************************************************
********************************************************************

* Type-Pools
TYPE-POOLS: slis.

* Types
TYPES: BEGIN OF ty_currency,
         currency LIKE tcj_c_journals-currency,
       END OF ty_currency.
*TYPES: BEGIN OF ty_gl_account,                                 "530875
*         gl_account LIKE tcj_transactions-gl_account,          "530875
*       END OF ty_gl_account.                                   "530875
TYPES: BEGIN OF ty_header_expand,
         header_exp TYPE c,
       END OF ty_header_expand.
TYPES: BEGIN OF ty_item_line,
         line(17) TYPE c,
       END OF ty_item_line.
TYPES: BEGIN OF ty_icon,
         icon(4) TYPE c,
       END OF ty_icon.

data: begin of hd_cash.           "structure for header Cash Movement Document
        include structure YSE_J_3RF_CASH_M_HDR.
data: end of hd_cash.

data: lv_name1 TYPE name1_gp.

data: it_cash type YSE_J_3RF_CASH_M_TABLE, "internal table for items
      wa_cash type YSE_J_3RF_CASH_M_dtl.
DATA: RETCODE   LIKE SY-SUBRC,
      lv_accountant TYPE USNAM,
      pfull_name TYPE J_3RF_SNPN,
      lv_counting TYPE i.

TYPES: BEGIN OF ty_sum,
         sum TYPE cjamount,
       END OF ty_sum.
TYPES: BEGIN OF itycj_postings.
INCLUDE TYPE iscj_postings.
INCLUDE TYPE ty_currency.
* INCLUDE TYPE ty_gl_account.                                   "530875
INCLUDE TYPE ty_header_expand.
INCLUDE TYPE ty_item_line.
INCLUDE TYPE ty_icon.
INCLUDE TYPE ty_sum.
TYPES: END OF itycj_postings.

* Includes
INCLUDE <icon>.
INCLUDE <symbol>.

* Tables
TABLES: tcj_c_journals,
        tcj_transactions,                                             "*
        tcj_cj_names.

* Local tables
DATA: lt_fieldcat          TYPE slis_t_fieldcat_alv,
      lt_events            TYPE slis_t_event,
      lt_sp_group          TYPE slis_t_sp_group_alv,
      lt_list_top_of_page  TYPE slis_t_listheader,
      itcj_header_postings LIKE iscj_postings OCCURS 0 WITH HEADER LINE,
      itcj_item_postings   LIKE iscj_postings OCCURS 0 WITH HEADER LINE,
      itcj_postings        LIKE iscj_postings OCCURS 0 WITH HEADER LINE,
      itcj_split_postings  LIKE iscj_postings OCCURS 0 WITH HEADER LINE,
      titcj_postings      TYPE itycj_postings OCCURS 0 WITH HEADER LINE,
      titcj_postings2     TYPE itycj_postings OCCURS 0 WITH HEADER LINE,
      titcj_split_postings TYPE itycj_postings OCCURS 0 WITH HEADER LINE,
      titcj_split_postings2 TYPE itycj_postings OCCURS 0 WITH HEADER LINE,
      lt_dummy_table1      LIKE iscj_postings OCCURS 0 WITH HEADER LINE,
     lt_dummy_table2      LIKE tcj_wtax_items OCCURS 0 WITH HEADER LINE,
      lt_dummy_table3      LIKE iscj_postings OCCURS 0 WITH HEADER LINE,
      lt_dummy_table4      LIKE tcj_cpd       OCCURS 0 WITH HEADER LINE,
      fp_outputparams   type sfpoutputparams,
      fp_docparams      type sfpdocparams,
      ls_function           TYPE rs38l_fnam,
      lang like T002-spras,
      l_errstr type string.
* Local structures
DATA: ls_layout          TYPE slis_layout_alv,
      ls_keyinfo         TYPE slis_keyinfo_alv,
      ls_colorf          TYPE slis_specialcol_alv,
      ls_tcj_print       LIKE tcj_print,
      ls_event           TYPE slis_alv_event,
      ls_variant         LIKE disvariant,
      ls_print           TYPE slis_print_alv,
      ls_journals        LIKE tcj_c_journals,
      ls_cj_names        LIKE tcj_cj_names,
      ls_t001            LIKE t001,
      ls_tcurt           LIKE tcurt,
*     ls_transaction     LIKE tcj_transactions,                 "530875
      tls_postings       LIKE LINE OF titcj_postings,
      tls_split_postings LIKE LINE OF titcj_split_postings.

* Local data
DATA: ld_tabname_header TYPE slis_tabname,
      ld_tabname_item   TYPE slis_tabname,
      ld_repid          LIKE  sy-repid,
      ld_save(1)        TYPE  c,
      ld_exit(1)        TYPE c,
      ld_once           TYPE c,
      ld_len            TYPE i,
      ld_beg_balance    TYPE cjamount,
      ld_run_balance    TYPE cjamount,
      ld_run_balance2   TYPE cjamount,
      ld_run_balance3   TYPE cjamount,
      ld_amount_saved_e TYPE cjamount,
      ld_amount_saved_r TYPE cjamount,
      ld_tot_receipts   TYPE cjamount,
      ld_tot_payments   TYPE cjamount,
      ld_tot_rcp_num    TYPE i,
      ld_tot_pay_num    TYPE i,
      ld_numb_saved     TYPE i,
      ld_lines          TYPE i,
      ld_linsz          TYPE i,                          "1369208
      ld_line           TYPE i,
      ld_payments       TYPE cjamount,
      ld_receipts       TYPE cjamount,
      ld_sum            TYPE cjamount,
      ld_user_specific  TYPE char1,                       "609593
      ld_waers          TYPE tcj_c_journals-currency. "Hw 0502865
 DATA ld_old_posting_number TYPE cjbelnr.                 "603115
 data endcheck type c.                 "Hw 500617
 data pagno type sy-pagno.                                      "1259906
 data : lv_cash_account2(20)  TYPE c,
        lv_akont type saknr,
        lv_date_beg_mth like sy-datum,
        lv_date_end_mth like sy-datum.

* Local Constants
CONSTANTS: lc_formname_top_of_page TYPE slis_formname
                                                    VALUE 'TOP_OF_PAGE',
           lc_formname_end_of_list TYPE slis_formname
                                                    VALUE 'END_OF_LIST'.

tables: bkpf, skb1, tnapr.
************************************************************************
* Selection screen definition ******************************************
************************************************************************

* Submitted by FCJ_PRINT_JOURNAL
SELECT-OPTIONS: sd_bukrs FOR tcj_c_journals-comp_code obligatory.
Parameter sd_canum type tcj_c_journals-cajo_number obligatory."Hw0502865
SELECT-OPTIONS date FOR sy-datum obligatory NO-EXTENSION.    "Hw 0502865
*PARAMETERS     title        LIKE tcj_cj_names-cajo_name.    "Hw 0502865

* Other input
*PARAMETERS     ld_allcj           AS CHECKBOX.              "Hw 0502865
PARAMETERS     ld_zebra           AS CHECKBOX.
PARAMETERS: PAGEY LIKE RFCASH-PAGEY.
PARAMETERS:
       TITLE       LIKE RFPDO1-ALLGLINE.                       "1259906
SELECT-OPTIONS: SAKNR FOR  SKB1-SAKNR.
SELECT-OPTIONS: WAERS FOR BKPF-WAERS.

************************************************************************
************************************************************************
************************************************************************

INITIALIZATION.

  CLEAR: ld_beg_balance, ld_run_balance, ld_run_balance2,
         ld_run_balance3, ld_payments, ld_receipts, ld_lines,
         ld_amount_saved_e, ld_amount_saved_r, ld_numb_saved.


************************************************************************
************************************************************************
************************************************************************

* Call selection screen

START-OF-SELECTION.
Select Single CURRENCY FROM TCJ_C_JOURNALS INTO ld_waers
       WHERE COMP_CODE = sd_bukrs-low
       AND CAJO_NUMBER = sd_canum.           "Hw 0502865

IF date-high is initial.     "HW 0502865
   date-high = date-low.     "HW 0502865
ENDIF.                       "HW 0502865

  ld_repid = sy-repid.

* Define keyinfo
  ls_keyinfo-header01 = 'CAJO_NUMBER'.
  ls_keyinfo-item01   = 'CAJO_NUMBER'.

  ls_keyinfo-header02 = 'POSTING_NUMBER'.
  ls_keyinfo-item02   = 'POSTING_NUMBER'.

* Sort items
  ls_keyinfo-header03 = space.
  ls_keyinfo-item03   = 'POSITION_NUMBER'.


* Define output list fields
  PERFORM fieldcat_init USING lt_fieldcat.


* ALV variant: Use variant with the same name as the report variant!!!
  CLEAR ls_tcj_print.
  CALL FUNCTION 'FCJ_GET_PRINT_PARAMETER'
       EXPORTING
            i_comp_code         = sd_bukrs-low         "Hw 0502865
            IMPORTING
            e_tcj_print         = ls_tcj_print
       EXCEPTIONS
            no_parameters_found = 1
            OTHERS              = 2.
  IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.
  CLEAR ls_variant.
  ls_variant-report  = ld_repid.
  ls_variant-variant = ls_tcj_print-varia.


* Additional activity at certain processing events
  REFRESH lt_events.
  CLEAR ls_event.
  ls_event-name = 'TOP_OF_PAGE'.
  ls_event-form = 'RFCASH20_TOP_OF_PAGE'.
  APPEND ls_event TO lt_events.

* Not available!
* CLEAR ls_event.
* ls_event-name = 'END_OF_PAGE'.
* ls_event-form = 'RFCASH20_END_OF_PAGE'.
* APPEND ls_event TO lt_events.

  CLEAR ls_event.
  ls_event-name = 'END_OF_LIST'.
  ls_event-form = 'RFCASH20_END_OF_LIST'.
  APPEND ls_event TO lt_events.

  CLEAR ls_event.
  ls_event-name = 'TOP_OF_LIST'.
  ls_event-form = 'RFCASH20_TOP_OF_LIST'.
  APPEND ls_event TO lt_events.

*  event to calculate the intermediate balance                  "887477
   CLEAR ls_event.                                              "887477
   ls_event-name = 'AFTER_LINE_OUTPUT'.                         "887477
   ls_event-form = 'RFCASH20_AFTER_LINE_OUTPUT'.                "887477
   APPEND ls_event TO lt_events.                                "887477

  IF 1 = 2.
    PERFORM rfcash20_top_of_list.
    PERFORM rfcash20_top_of_page.
    PERFORM rfcash20_end_of_list.
*   PERFORM rfcash20_after_line_output USING rs_lineinfo.
  ENDIF.

  CLEAR ls_layout.
  ls_layout-zebra             = ld_zebra.
* ls_layout-colwidth_optimize = 'X'.
  ls_layout-expand_fieldname  = 'HEADER_EXP'.

  CLEAR ls_print.
  ls_print-no_coverpage = 'X'.
  ls_print-no_print_listinfos = 'X'.

************************************************************************
  SELECT SINGLE * FROM tcj_c_journals
    INTO ls_journals
    WHERE comp_code  = sd_bukrs-low
      AND cajo_number = sd_canum.                        "Hw 0502865

  If Sy-subrc ne '0'.                                    "Hw 494272
     MESSAGE I011(F5A) WITH Sd_canum sd_bukrs-low.            "Hw 502865
     exit.                                                "Hw 494272
   Endif.                                                 "Hw 494272

   CALL FUNCTION 'FCJ_GET_ALL_POSTINGS'
       EXPORTING
            i_comp_code         = sd_bukrs-low
            i_cajo_number       = sd_canum
            i_display_period_lo = date-low
            i_display_period_hi = date-high
       TABLES
            itcj_postings       = titcj_postings
            itcj_split_postings = titcj_split_postings.

  LOOP AT titcj_postings.
    titcj_postings-currency = ld_waers.                  "Hw 502865
    APPEND titcj_postings TO titcj_split_postings.
    IF titcj_postings-document_status = 'S'.
      titcj_postings-icon = '@09@'.
    ELSEIF ( titcj_postings-document_status = 'P'
      AND titcj_postings-h_receipts >= 0
      AND titcj_postings-h_payments >= 0 ) OR  "488135 (Or hinzugef¨¹gt)
      ( titcj_postings-document_status = 'P'   "488135 Scheckeinreichung
      AND titcj_postings-h_receipts < 0                        "488135
      AND Not titcj_postings-check_stack is INITIAL ).         "488135
      titcj_postings-icon = '@08@'.
    ELSEIF titcj_postings-document_status = 'P'
      AND ( titcj_postings-h_receipts < 0
            OR titcj_postings-h_payments < 0 ).
      titcj_postings-icon = '@02@'.
    ELSEIF titcj_postings-document_status = 'R'.
      titcj_postings-icon = '@02@'.
    ENDIF.
    IF NOT titcj_postings-split IS INITIAL. "put * in front if syntaxerr
      titcj_postings-header_exp    = 'X'.   "put * in front if syntaxerr
      titcj_postings-transact_name = '*'.   "put * in front if syntaxerr
    ENDIF.                                  "put * in front if syntaxerr

    IF NOT titcj_postings-H_RECEIPTS is initial.             "HW 492108
      titcj_postings-H_NET_PAYMENT_WT = titcj_postings-H_NET_PAYMENT_WT
      * ( -1 ).                                              "HW 492108
      titcj_postings-H_TAX_AMOUNT = titcj_postings-H_TAX_AMOUNT
      * ( -1 ).                                              "HW0501803

    Endif.                                                   "HW 492108

    MODIFY titcj_postings.
  ENDLOOP.

  LOOP AT titcj_split_postings.
    IF NOT titcj_split_postings-H_RECEIPTS is initial.        "HW0501803
     titcj_split_postings-P_TAX_AMOUNT =
     titcj_split_postings-P_TAX_AMOUNT * ( -1 ).              "HW0501803
    Endif.
    IF titcj_split_postings-position_type = 'T'  "put * in front if err
    OR titcj_split_postings-position_type = 'P'.                "798886
      DELETE titcj_split_postings.               "put * in front if err
    ELSE.                                        "put * in front if err
      titcj_split_postings-position_number
                     = ( titcj_split_postings-position_number + 1 ) / 3.
      titcj_split_postings-line = '.................'.
* Begin of deletion note 530875
*     IF titcj_split_postings-vendor_no IS INITIAL AND
*        titcj_split_postings-customer IS INITIAL.
*        CLEAR ls_transaction.
*        CALL FUNCTION 'FCJ_GET_TRANSACTION_FROM_NAME2'
*         EXPORTING
*           I_COMP_CODE             = titcj_split_postings-comp_code
*           I_TRANSACTION_NAME      = titcj_split_postings-transact_name
*           I_LANGU                 = sy-langu
*          IMPORTING
*            E_TRANSACTION           = ls_transaction
*          EXCEPTIONS
*            NAME_NOT_EXISTENT       = 1
*            OTHERS                  = 2
*                  .
*        IF SY-SUBRC <> 0.
**         MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**                 WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*        ENDIF.
*   titcj_split_postings-gl_account = ls_transaction-gl_account.
*     ENDIF.
* End of deletion note 530875
      MODIFY titcj_split_postings.
    ENDIF.                                       "put * in front if err

  ENDLOOP.

  SORT titcj_split_postings BY posting_number position_number.

************************************************************************
  AUTHORITY-CHECK OBJECT 'S_ALV_LAYO'                      "609593
                 ID 'ACTVT' FIELD '23'.                    "609593
  IF sy-subrc IS INITIAL.                                  "609593
* Authority is given                                       "609593
    ld_user_specific = 'A'."user-specific AND standards    "609593
  ELSE.                                                    "609593
    ld_user_specific = 'U'."user-specific                  "609593
  ENDIF.                                                   "609593

If SD_BUKRS-low <> 'MRUA'.

  CALL FUNCTION 'REUSE_ALV_HIERSEQ_LIST_DISPLAY'
    EXPORTING
*     I_INTERFACE_CHECK              = ' '
      i_callback_program             = ld_repid
*     I_CALLBACK_PF_STATUS_SET       = ' '
*     I_CALLBACK_USER_COMMAND        = ' '
      is_layout                      = ls_layout
      it_fieldcat                    = lt_fieldcat
*     IT_EXCLUDING                   =
*     IT_SPECIAL_GROUPS              =
*     IT_SORT                        =
*     IT_FILTER                      =
*     IS_SEL_HIDE                    =
*     I_SCREEN_START_COLUMN          = 0
*     I_SCREEN_START_LINE            = 0
*     I_SCREEN_END_COLUMN            = 0
*     I_SCREEN_END_LINE              = 0
*     I_DEFAULT                      = 'X'
*i_save                        = 'A' "user-specific AND standards"609593
      i_save                         = ld_user_specific    "609593
      is_variant                     = ls_variant
      it_events                      = lt_events
*     IT_EVENT_EXIT                  =
      i_tabname_header               = 'TITCJ_POSTINGS'
      i_tabname_item                 = 'TITCJ_SPLIT_POSTINGS'
*     I_STRUCTURE_NAME_HEADER        =
*     I_STRUCTURE_NAME_ITEM          =
      is_keyinfo                     = ls_keyinfo
      is_print                       = ls_print
*     IS_REPREP_ID                   =
*     I_BYPASSING_BUFFER             =
*     I_BUFFER_ACTIVE                =
*   IMPORTING
*     E_EXIT_CAUSED_BY_CALLER        =
*     ES_EXIT_CAUSED_BY_USER         =
    TABLES
      t_outtab_header                = titcj_postings
      t_outtab_item                  = titcj_split_postings
    EXCEPTIONS
      program_error                  = 1
      OTHERS                         = 2
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  ELSE. " MRUA (Russia) wants to see a Cash-Movement document instead of the ALV
* Retrieve values needed to show in Cash Movements Document
     CALL FUNCTION 'FCJ_GET_DATA_FOR_SCREEN'
    EXPORTING
      i_comp_code                 = ls_journals-comp_code
      i_cajo_number               = ls_journals-cajo_number
      i_display_period_lo         = date-low
      i_display_period_hi         = date-high
    IMPORTING
      e_beginning_balance         = ld_beg_balance
      e_running_balance           = ld_run_balance2
      E_TOTAL_RECEIPTS            = ld_tot_receipts
      E_TOTAL_REC_NUMBER          = ld_tot_rcp_num
      E_TOTAL_PAYMENTS            = ld_tot_payments
      E_TOTAL_PAYM_NUMBER         = ld_tot_pay_num
*     E_TOTAL_CHECKS              =
*     E_TOTAL_CHECKS_NUMBER       =
*     E_COMP_NAME                 =
*     E_CAJO_NAME                 =
*     E_CURRENCY1                 =
*     E_CURRENCY2                 =
*     E_CURRENCY3                 =
*     E_CURRENCY4                 =
*     E_CURRENCY5                 =
    TABLES
      e_postings                  = lt_dummy_table1
      e_wtax_items                = lt_dummy_table2
      e_split_postings            = lt_dummy_table3
      e_cpd                       = lt_dummy_table4.

* Retrieve Cashier name
    clear lv_accountant.
    select single accountant from tcj_documents into lv_accountant
      where comp_code = ls_journals-comp_code and
            cajo_number =  ls_journals-cajo_number and
            posting_number = TITCJ_POSTINGS-POSTING_NUMBER.


  if lv_accountant is not initial.
   call function 'J_3RT_FIO_USER'
     exporting
       p_bname                = lv_accountant
*      P_DATE                 =
       P_LANG                 = 'R'
     importing
       full_name              = pfull_name.

    if not pfull_name is initial.
      hd_cash-cash_name = pfull_name.
    endif.
   endif.



    hd_cash-cajo_number = sd_canum.
    hd_cash-total_pay = ld_tot_receipts.
    hd_cash-total_rcp = ld_tot_payments.
    hd_cash-total_beg_bal = ld_beg_balance.
    hd_cash-total_end_bal = ld_run_balance2.
    hd_cash-total_rcp_num = ld_tot_rcp_num.
    hd_cash-total_pay_num = ld_tot_pay_num.
    hd_cash-waers = ld_waers.

    LOOP at TITCJ_POSTINGS.
     clear wa_cash.
     wa_cash-POST_NBR = TITCJ_POSTINGS-POSTING_NUMBER.
     wa_cash-receipt = TITCJ_POSTINGS-H_RECEIPTS.
     wa_cash-payment = TITCJ_POSTINGS-H_PAYMENTS.
* Vendor number,name + Reference(document_number)
     if not titcj_postings-vendor_no is initial.
      clear lv_name1.
      select single name1 from lfa1 into lv_name1
         where lifnr = titcj_postings-vendor_no.

      clear lv_akont.
      select single akont from lfb1 into lv_akont
        where lifnr = TITCJ_POSTINGS-VENDOR_NO and bukrs = 'MRUA'.

      clear lv_CASH_ACCOUNT2.
      select single altkt from skb1 into lv_CASH_ACCOUNT2
      where saknr = lv_akont and bukrs = 'MRUA'.

      if lv_CASH_ACCOUNT2 is initial.
       lv_CASH_ACCOUNT2 = TITCJ_POSTINGS-VENDOR_NO.
      endif.

      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = lv_CASH_ACCOUNT2
          IMPORTING
            OUTPUT = wa_cash-account.
     endif.

* Customer number, name + Reference
     if not titcj_postings-customer is initial.
      clear lv_name1.
      select single name1 from kna1 into lv_name1
        where kunnr = titcj_postings-customer.

      clear lv_akont.
      select single akont from knb1 into lv_akont
        where kunnr = TITCJ_POSTINGS-CUSTOMER and bukrs = 'MRUA'.

      select single altkt from skb1 into lv_CASH_ACCOUNT2
      where saknr = lv_akont and bukrs = 'MRUA'.

      if lv_CASH_ACCOUNT2 is initial.
       lv_CASH_ACCOUNT2 = TITCJ_POSTINGS-CUSTOMER.
      endif.

      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = lv_CASH_ACCOUNT2
          IMPORTING
            OUTPUT = wa_cash-account.
     endif.
* Take G/L Account if vendor and customer account is empty
     if wa_cash-account is initial.
      select single altkt from skb1 into lv_CASH_ACCOUNT2
      where saknr = TITCJ_POSTINGS-GL_ACCOUNT and bukrs = 'MRUA'.

           CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = lv_CASH_ACCOUNT2
          IMPORTING
            OUTPUT = wa_cash-account.
     endif.


      concatenate TITCJ_POSTINGS-BP_NAME TITCJ_POSTINGS-document_number TITCJ_POSTINGS-position_text into wa_cash-REF separated by ' '.

     append wa_cash to it_cash.
    ENDLOOP.
* Last document date
    hd_cash-doc_date = TITCJ_POSTINGS-document_date.

    if LS_JOURNALS-currency = 'RUB'.
     hd_cash-CURRENCY_TXT_HDR = '§²§å§Ò§Ý§Ú'.
     hd_cash-CURRENCY_TXT_DTL = '§â§å§Ò.§Ü§à§á.'.
    endif.
    if LS_JOURNALS-currency = 'EUR'.
     hd_cash-CURRENCY_TXT_HDR = '§¦§Ó§â§à'.
     hd_cash-CURRENCY_TXT_DTL = '§¦§Ó§â§à'.
    endif.
    if LS_JOURNALS-currency = 'USD'.
     hd_cash-CURRENCY_TXT_HDR = '§¥§à§Ý§Ý§Ñ§â§í §³§º§¡'.
     hd_cash-CURRENCY_TXT_DTL = '§¥§à§Ý§Ý§Ñ§â§í §³§º§¡'.
    endif.

* Page number retrieval

 CALL FUNCTION 'LAST_DAY_OF_MONTHS'
         EXPORTING
             day_in            = date-low
         IMPORTING
             last_day_of_month = lv_date_end_mth.

  concatenate  lv_date_end_mth(4) lv_date_end_mth+4(2) '01' into lv_date_beg_mth.


  CALL FUNCTION 'FCJ_GET_ALL_POSTINGS'
       EXPORTING
            i_comp_code         = sd_bukrs-low
            i_cajo_number       = sd_canum
            i_display_period_lo = lv_date_beg_mth
            i_display_period_hi = lv_date_end_mth
       TABLES
            itcj_postings       = titcj_postings2
            itcj_split_postings = titcj_split_postings2.

SORT titcj_postings2 BY POSTING_DATE.
DELETE ADJACENT DUPLICATES FROM titcj_postings2 COMPARING POSTING_DATE.
clear lv_counting.
loop at titcj_postings2.
  lv_counting = lv_counting + 1.
  if titcj_postings2-POSTING_DATE = date-low.
    hd_cash-counter = lv_counting.
   exit.
  endif.
endloop.


*Sets output parameters and opens the spool job

  fp_outputparams-nodialog = 'X'.
  fp_outputparams-preview = 'X'.
  fp_outputparams-dest = 'XX02'.

  call function 'FP_JOB_OPEN'
    CHANGING
      ie_outputparams = fp_outputparams
    EXCEPTIONS
      cancel          = 1
      usage_error     = 2
      system_error    = 3
      internal_error  = 4
      others          = 5.
  if sy-subrc <> 0.
    message id sy-msgid type sy-msgty number sy-msgno
            with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  endif.

  TNAPR-SFORM = 'YSE_J_3RF_CASH_M'.

  perform read_fm using TNAPR-SFORM
                  changing ls_function.

  IF retcode = 0.
* Call the generated functional module
* set locale RU_ru
    fp_docparams-langu = 'R'.
    fp_docparams-country = 'RU'.
    IF NOT ls_function IS INITIAL.
      call function ls_function
        EXPORTING
          /1bcdwb/docparams    = fp_docparams
          is_header            = hd_cash
          is_detail            = it_cash
        EXCEPTIONS
          usage_error     = 1
          system_error    = 2
          internal_error  = 3.
    ELSE.
      EXIT.
    ENDIF.

    if sy-subrc <> 0.
       CALL FUNCTION 'FP_GET_LAST_ADS_ERRSTR'
       IMPORTING
           E_ADSERRSTR = l_errstr.
    endif.

*Close the spool job
    call function 'FP_JOB_CLOSE'
*           IMPORTING
*             E_RESULT             =
     exceptions
       usage_error          = 1
       system_error         = 2
       internal_error       = 3
       others               = 4
              .
    if sy-subrc <> 0.
      message id sy-msgid type sy-msgty number sy-msgno
              with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    endif.
  endif. "retcode
  ENDIF.


*&---------------------------------------------------------------------*
*&      Form  fieldcat_init
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_FIELDCAT  text
*----------------------------------------------------------------------*
FORM fieldcat_init USING p_lt_fieldcat TYPE slis_t_fieldcat_alv.


  DATA: ls_fieldcat TYPE slis_fieldcat_alv.
  ld_len                   = 17.

* Template
*  CLEAR ls_fieldcat.
*  ls_fieldcat-fieldname    = 'CAJO_NUMBER'.
*  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
*  ls_fieldcat-ref_tabname  = 'TCJ_C_JOURNALS'.
*  ls_fieldcat-key          = 'X'.
*  ls_fieldcat-key_sel      = 'X'.
*  ls_fieldcat-no_out       = 'X'.
*  ls_fieldcat-do_sum       = 'X'.
*  ls_fieldcat-cfieldname   = 'CURRENCY'.
*  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
*  ls_fieldcat-icon         = 'X'.
*  ls_fieldcat-just         = 'R'.
*  ls_fieldcat-emphasize    = 'C610'.
*  ls_fieldcat-datatype     = .
*  ls_fieldcat-outputlen    = .
*  ls_fieldcat-seltext_l    = .
*  ls_fieldcat-seltext_m    = .
*  ls_fieldcat-seltext_s    = .
*  ls_fieldcat-reptext_ddic = .
*  ls_fieldcat-col_pos      = '1'.
*  ls_fieldcat-row_pos      = '1'.
*  APPEND ls_fieldcat TO p_lt_fieldcat.

************************************************************************
* HEADER-TABLE *********************************************************
************************************************************************

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'COMP_CODE'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_C_JOURNALS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CAJO_NUMBER'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_C_JOURNALS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'FISC_YEAR'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'POSTING_NUMBER'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  ls_fieldcat-seltext_l    = text-001.
  ls_fieldcat-seltext_m    = text-001.
  ls_fieldcat-seltext_s    = text-001.
  ls_fieldcat-reptext_ddic = text-001.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'TRANSACT_NAME'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_TRANS_NAMES'.
  ls_fieldcat-seltext_l    = text-004.
  ls_fieldcat-seltext_m    = text-004.
  ls_fieldcat-seltext_s    = text-004.
  ls_fieldcat-reptext_ddic = text-004.
  ls_fieldcat-outputlen    = 15.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'D_POSTING_NUMB'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'POSTING_DATE'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.                                       "602733
  ls_fieldcat-fieldname    = 'DOCUMENT_DATE'.              "602733
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.             "602733
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.              "602733
  ls_fieldcat-key          = 'X'.                          "602733
  ls_fieldcat-key_sel      = 'X'.                          "602733
  APPEND ls_fieldcat TO p_lt_fieldcat.                     "602733

  CLEAR ls_fieldcat.                                       "642171
  ls_fieldcat-fieldname    = 'PRINT_IND'.                  "642171
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.             "642171
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.              "642171
  ls_fieldcat-outputlen    = 8.                            "642171
  ls_fieldcat-key_sel      = 'X'.                          "642171
  APPEND ls_fieldcat TO p_lt_fieldcat.                     "642171

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'H_PAYMENTS'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-seltext_l    = text-002.
  ls_fieldcat-seltext_m    = text-002.
  ls_fieldcat-seltext_s    = text-002.
  ls_fieldcat-reptext_ddic = text-002.
  ls_fieldcat-outputlen    = 12.
  ls_fieldcat-do_sum       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'H_NET_PAYMENT_WT'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-no_out       = 'X'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-outputlen    = 12.
  ls_fieldcat-do_sum       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'H_RECEIPTS'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-seltext_l    = text-003.
  ls_fieldcat-seltext_m    = text-003.
  ls_fieldcat-seltext_s    = text-003.
  ls_fieldcat-reptext_ddic = text-003.
  ls_fieldcat-outputlen    = 12.
  ls_fieldcat-do_sum       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'H_TAX_AMOUNT'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-outputlen    = 12.
  ls_fieldcat-do_sum       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CURRENCY'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_C_JOURNALS'.
  ls_fieldcat-tech         = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

   CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'DOCUMENT_NUMBER'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.


  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CHECK_NUMBER'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CHECK_ISSUER'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CHECK_STACK'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CHECK_STATUS'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'REVBELNR'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'BUPLA'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'SECCO'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'BP_NAME'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'ICON'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-datatype     = 'C'.
  ls_fieldcat-ddic_outputlen = 4.
  ls_fieldcat-outputlen    =   4.
  ls_fieldcat-icon         = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'TEXT1'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'TEXT2'.
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.                                           "1114552
  ls_fieldcat-fieldname    = 'VATDATE'.                        "1114552
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.                 "1114552
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.                  "1114552
  ls_fieldcat-no_out       = 'X'.                              "1114552
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1114552

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'LZBKZ'.                          "1433657
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.                 "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'LANDL'.                          "1433657
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.                 "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'EXCH_RATE'.                      "1433657
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.                 "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'H_NET_AMOUNT'.                   "1433657
  ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.                 "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_DOCUMENTS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

************************************************************************
* ITEM-TABLE ***********************************************************
************************************************************************

* Template

* CLEAR ls_fieldcat.
* ls_fieldcat-fieldname    = 'CAJO_NUMBER'.
* ls_fieldcat-tabname      = 'TITCJ_POSTINGS'.
* ls_fieldcat-ref_tabname  = 'TCJ_C_JOURNALS'.
* ls_fieldcat-key          = 'X'.
* ls_fieldcat-key_sel      = 'X'.
* ls_fieldcat-no_out       = 'X'.
* ls_fieldcat-do_sum       = 'X'.
* ls_fieldcat-cfieldname   = 'CURRENCY'.
* ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
* ls_fieldcat-icon         = 'X'.
* ls_fieldcat-just         = 'R'.
* ls_fieldcat-emphasize    = 'C610'.
* ls_fieldcat-datatype     = .
* ls_fieldcat-outputlen    = .
* ls_fieldcat-seltext_l    = .
* ls_fieldcat-seltext_m    = .
* ls_fieldcat-seltext_s    = .
* ls_fieldcat-reptext_ddic = .
* ls_fieldcat-col_pos      = '1'.
* ls_fieldcat-row_pos      = '1'.
* APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'POSITION_NUMBER'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-key          = 'X'.
  ls_fieldcat-key_sel      = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'LINE'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-datatype     = 'C'.
  ls_fieldcat-ddic_outputlen = ld_len.
  ls_fieldcat-outputlen    = ld_len.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'TRANSACT_NAME'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_TRANS_NAMES'.
  ls_fieldcat-seltext_l    = text-004.
  ls_fieldcat-seltext_m    = text-004.
  ls_fieldcat-seltext_s    = text-004.
  ls_fieldcat-reptext_ddic = text-004.
  ls_fieldcat-outputlen    = 15.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'P_PAYMENTS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-seltext_l    = text-002.
  ls_fieldcat-seltext_m    = text-002.
  ls_fieldcat-seltext_s    = text-002.
  ls_fieldcat-reptext_ddic = text-002.
  ls_fieldcat-outputlen    = 12.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'P_RECEIPTS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-seltext_l    = text-003.
  ls_fieldcat-seltext_m    = text-003.
  ls_fieldcat-seltext_s    = text-003.
  ls_fieldcat-reptext_ddic = text-003.
  ls_fieldcat-outputlen    = 12.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'P_TAX_AMOUNT'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-outputlen    = 12.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'P_NET_AMOUNT'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-cfieldname   = 'CURRENCY'.
  ls_fieldcat-ctabname     = 'TITCJ_POSTINGS'.
  ls_fieldcat-just         = 'R'.
  ls_fieldcat-outputlen    = 12.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'TAX_CODE'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'TAXJURCODE'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.                                                  "*
  ls_fieldcat-fieldname    = 'GL_ACCOUNT'.                            "*
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.                  "*
  ls_fieldcat-ref_tabname  = 'TCJ_TRANSACTIONS'.                      "*
  ls_fieldcat-no_out       = 'X'.                                     "*
  APPEND ls_fieldcat TO p_lt_fieldcat.                                "*
                                                                      "*
  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'VENDOR_NO'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'CUSTOMER'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'POSITION_TEXT'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-outputlen    = 15.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'ALLOC_NMBR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'GSBER'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'PRCTR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'VNAME'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'GEBER'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

* Desactivated after first import in CP& due to compilation error
* Switch handle is not known yet  (only valid after upgrade ! )
*  IF NOT cl_psm_core_switch_check=>psm_fm_core_bud_per_rev_1( ) "EhP4
*    IS INITIAL.
*    CLEAR ls_fieldcat.
*    ls_fieldcat-fieldname    = 'BUDGET_PD'.
*    ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
*    ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
*    ls_fieldcat-no_out       = 'X'.
*    APPEND ls_fieldcat TO p_lt_fieldcat.
*  ENDIF.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'PARGB'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'RMVCT'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'FKBER'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KOKRS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KOSTL'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'LSTAR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'AUFNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'AFPOS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'BEMOT'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KSTRG'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'PRZNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'PPRCTR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'PS_PSP_PNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'NPLNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'VORNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'ANLN1'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'ANLN2'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'BZDAT'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'ANBWA'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'WERKS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'BWTAR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'MATNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KDAUF'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KDEIN'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KDPOS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'FIKRS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'FISTL'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'FIPOS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KBLNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'KBLPOS'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname    = 'PERNR'.
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.
  ls_fieldcat-no_out       = 'X'.
  APPEND ls_fieldcat TO p_lt_fieldcat.

  CLEAR ls_fieldcat.                                           "1398042
  ls_fieldcat-fieldname    = 'SEGMENT'.                        "1398042
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.           "1398042
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.                  "1398042
  ls_fieldcat-no_out       = 'X'.                              "1398042
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1398042

  CLEAR ls_fieldcat.                                           "1398042
  ls_fieldcat-fieldname    = 'PSEGMENT'.                       "1398042
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.           "1398042
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.                  "1398042
  ls_fieldcat-no_out       = 'X'.                              "1398042
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1398042

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'GRANT_NBR'.                      "1433657
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.           "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'VBUND'.                          "1433657
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.           "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'TAX_PERCENT'.                    "1433657
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.           "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657

  CLEAR ls_fieldcat.                                           "1433657
  ls_fieldcat-fieldname    = 'P_FWBAS'.                        "1433657
  ls_fieldcat-tabname      = 'TITCJ_SPLIT_POSTINGS'.           "1433657
  ls_fieldcat-ref_tabname  = 'TCJ_POSITIONS'.                  "1433657
  ls_fieldcat-no_out       = 'X'.                              "1433657
  APPEND ls_fieldcat TO p_lt_fieldcat.                         "1433657


ENDFORM.                    " fieldcat_init
*&---------------------------------------------------------------------*
*&      Form  rfcash20_top_of_list
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM rfcash20_top_of_list.

 clear endcheck.                            "Hw 500617

  CLEAR ls_cj_names.
  CALL FUNCTION 'FCJ_GET_CAJO_DATA2'
    EXPORTING
      i_comp_code             = ls_journals-comp_code
      i_cajo_number           = ls_journals-cajo_number
      i_langu                 = sy-langu
    IMPORTING
*     E_TCJ_C_JOURNALS        =
      e_tcj_cj_names          = ls_cj_names
    EXCEPTIONS
      cajo_not_existent       = 1
      OTHERS                  = 2
            .
  IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CLEAR ls_t001.
  CALL FUNCTION 'FI_COMPANY_CODE_DATA'
       EXPORTING
            i_bukrs      = ls_journals-comp_code
       IMPORTING
            e_t001       = ls_t001
       EXCEPTIONS
            system_error = 1
            OTHERS       = 2.
  IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CLEAR ls_tcurt.
  SELECT SINGLE * FROM tcurt INTO ls_tcurt
    WHERE spras = sy-langu AND waers = ld_waers.      "Hw 0502865

  CALL FUNCTION 'FCJ_GET_DATA_FOR_SCREEN'
    EXPORTING
      i_comp_code                 = ls_journals-comp_code
      i_cajo_number               = ls_journals-cajo_number
      i_display_period_lo         = date-low
      i_display_period_hi         = date-high
    IMPORTING
      e_beginning_balance         = ld_beg_balance
      e_running_balance           = ld_run_balance2
*     E_TOTAL_RECEIPTS            =
*     E_TOTAL_REC_NUMBER          =
*     E_TOTAL_PAYMENTS            =
*     E_TOTAL_PAYM_NUMBER         =
*     E_TOTAL_CHECKS              =
*     E_TOTAL_CHECKS_NUMBER       =
*     E_COMP_NAME                 =
*      E_CAJO_NAME                 =
*     E_CURRENCY1                 =
*     E_CURRENCY2                 =
*     E_CURRENCY3                 =
*     E_CURRENCY4                 =
*     E_CURRENCY5                 =
    TABLES
      e_postings                  = lt_dummy_table1
      e_wtax_items                = lt_dummy_table2
      e_split_postings            = lt_dummy_table3
      e_cpd                       = lt_dummy_table4
            .
* start intermediate balance with opening balance               "887477
  ld_run_balance = ld_beg_balance.                              "887477

  ld_run_balance3 = ld_beg_balance.
  CLEAR: ld_amount_saved_e, ld_amount_saved_r, ld_numb_saved.         "*
  CLEAR ld_old_posting_number.                                 "603115
  LOOP AT titcj_postings.
    titcj_postings-sum = ld_run_balance3.
    MODIFY titcj_postings.
    ld_run_balance3 = ld_run_balance3 + titcj_postings-h_receipts
                                      - titcj_postings-h_payments.
    IF titcj_postings-icon = '@09@'. "saved only
*If subtotals are created, additional line items with identical"603115
*posting_numbers are created by the ALV basis                  "603115
     IF titcj_postings-posting_number NE ld_old_posting_number."603115
      ld_amount_saved_e = ld_amount_saved_e + titcj_postings-h_payments.
      ld_amount_saved_r = ld_amount_saved_r + titcj_postings-h_receipts.
      ld_numb_saved     = ld_numb_saved + 1.
      CLEAR ld_old_posting_number.                             "603115
      ld_old_posting_number = titcj_postings-posting_number.   "603115
     ENDIF.                                                    "603115
    ENDIF.
  ENDLOOP.


ENDFORM.                    " rfcash20_top_of_list
*&---------------------------------------------------------------------*
*&      Form  rfcash20_top_of_page
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM rfcash20_top_of_page.

* get list width                                                "1369208
CALL FUNCTION 'REUSE_ALV_LIST_LAYOUT_INFO_GET'                  "1369208
IMPORTING                                                       "1369208
    E_WIDTH                          = ld_linsz                 "1369208
EXCEPTIONS                                                      "1369208
    OTHERS                           = 3                        "1369208
          .                                                     "1369208
IF SY-SUBRC <> 0.                                               "1369208
   ld_linsz = sy-linsz.                                         "1369208
ENDIF.                                                          "1369208

* ld_run_balance = ld_beg_balance.                              "887477
  ld_line        = ld_linsz - 28.                               "1369208

* Line 1
* First column
  WRITE           ls_t001-butxt.
* Second column
  WRITE AT 24     text-020.      " 'journal'
* Third column
  pagno = pagey + sy-pagno.                                     "1259906
  WRITE AT 50     text-023.      " 'page'
  WRITE           pagno.                                        "1259906

* Line 2
* First column
  WRITE AT /      ls_t001-ort01.
* Second column
  WRITE AT 22     ls_cj_names-cajo_name.
* Third column
  WRITE AT 50     ls_journals-currency.
  WRITE           ls_tcurt-ktext.

* Line 3
* First column
  WRITE AT /      ls_journals-comp_code.
* Second column
  WRITE AT 24     ls_journals-cajo_number.
  WRITE           '/'.
  WRITE           ls_journals-gl_account.
* Third column
  WRITE AT 50     sy-datlo.
  WRITE AT 63     sy-timlo.

* Line 4
* First column
* Second column
  WRITE AT /19    date-low.
  WRITE AT 30     '-'.
  WRITE AT 32     date-high.
* Third column
  WRITE AT 50(10) sy-repid.
  WRITE AT 60     '/'.
  WRITE AT 62     sy-uname.

* Line 5: Beginning balance
  IF sy-pagno = 1.
    ULINE AT /1(ld_linsz).                                      "1369208
    FORMAT COLOR 3.
    WRITE AT /      sy-vline.
    WRITE           text-030. " 'Beginning balance
    WRITE AT ld_line(20) ld_beg_balance CURRENCY ls_journals-currency.
    WRITE           ls_journals-currency.
    WRITE AT ld_linsz sy-vline.                                 "1369208
    FORMAT COLOR OFF.
  ENDIF.

* Line 6: Intermediate balance
* Not on first page!
  IF sy-pagno >= 2 and not endcheck = 'X'.  "Hw 500617 Zeile abgewandelt
    ULINE AT /1(ld_linsz).                                      "1369208
    FORMAT COLOR 3.
    WRITE AT /       sy-vline.
    WRITE            text-033. " 'Intermediate sum

*** Begin of note 887477
*** Be careful if new posting started already
*** IF titcj_split_postings-position_number = 1.
***   WRITE AT ld_line(20) titcj_postings-sum
***                                       CURRENCY ls_journals-currency.
** ELSE.
***   ld_sum = titcj_postings-sum + titcj_postings-h_receipts
***                               - titcj_postings-h_payments.
***   WRITE AT ld_line(20) ld_sum CURRENCY ls_journals-currency.
*** ENDIF.
*   write amount of intermediate balance
    WRITE AT ld_line(20) ld_run_balance CURRENCY ls_journals-currency.
*** End of note 887477

    WRITE           ls_journals-currency.
    WRITE AT ld_linsz sy-vline.                                 "1369208
    FORMAT COLOR OFF.
  ENDIF.


ENDFORM.                    " rfcash20_top_of_page
*&---------------------------------------------------------------------*
*&      Form  RFCASH20_AFTER_LINE_OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_RS_LINEINFO  text
*----------------------------------------------------------------------*
FORM rfcash20_after_line_output USING rs_lineinfo TYPE slis_lineinfo.


  IF rs_lineinfo-tabname = 'TITCJ_POSTINGS'
    AND NOT rs_lineinfo-tabindex = 0.
    ld_lines       = ld_lines + 1.
    ld_payments    = ld_payments    + titcj_postings-h_payments.
    ld_receipts    = ld_receipts    + titcj_postings-h_receipts.
    ld_run_balance = ld_run_balance + titcj_postings-h_receipts
                                    - titcj_postings-h_payments.
  ENDIF.

ENDFORM.                    " RFCASH20_AFTER_LINE_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  rfcash20_end_of_list
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM rfcash20_end_of_list.

* reserve lines in a field for testing while debugging
DATA: LD_RES_LINES TYPE I.     "reserve lines for end of list   "895137

* reserve 10 lines.                    "Hw 500617               "895137
LD_RES_LINES = 12.                                              "895137
reserve LD_RES_LINES lines.                                     "895137

endcheck = 'X'.                      "Hw 500617

* If Output starts at next page in line 1, the start uline for  "895137
* the block with the only saved amount and the intermediate     "895137
* balance was missing                                           "895137
IF sy-linno eq 1.                                               "895137
  endcheck = ' '.                                               "895137
  ULINE AT /1(ld_linsz).                                        "1369208
ENDIF.                                                          "895137

* Totals saved only
  FORMAT COLOR 7.
  WRITE AT /        sy-vline.
  WRITE AT 5        text-040.                                         "*
  WRITE AT 38(17)   ld_amount_saved_e currency ld_waers. "488401/502865
  WRITE AT ld_linsz sy-vline.                                   "1369208
  WRITE AT /        sy-vline.
  WRITE AT 5        text-041.                                         "*
  WRITE AT 48(20)   ld_amount_saved_r currency ld_waers. "488401/502865
  WRITE AT 80(35)   text-042.
  WRITE AT 110      ld_numb_saved.
  WRITE AT ld_linsz sy-vline.                                   "1369208
  ULINE AT /1(ld_linsz).                                        "1369208

* Running balance
  ULINE AT /1(ld_linsz).                                        "1369208
  FORMAT COLOR 3.
  WRITE AT /        sy-vline.
  WRITE             text-031. " 'Running balance
  WRITE AT ld_line(20) ld_run_balance2 CURRENCY ls_journals-currency.
  WRITE             ls_journals-currency.
  WRITE AT ld_linsz sy-vline.                                   "1369208
  FORMAT COLOR OFF.
  ULINE AT /1(ld_linsz).                                        "1369208


  WRITE: AT / text-014, ICON_GREEN_LIGHT AS ICON, text-015,
                        ICON_YELLOW_LIGHT AS ICON, text-016,
                        ICON_INCOMPLETE AS ICON, text-017.
  WRITE /.

  WRITE: /.
  WRITE AT /28 text-010.
  WRITE /.
  WRITE AT / text-011.
  WRITE AT 32 text-012.
  WRITE AT 60 text-013.


ENDFORM.                    " rfcash20_end_of_list

FORM read_fm USING    P_TNAPR_SFORM
                   CHANGING P_FUNC_MODULE_NAME.

  DATA: gv_w_cx_root        TYPE  REF TO cx_root,
                                                            "#EC NEEDED
        gv_cx_fp_api_repository TYPE REF TO cx_fp_api_repository,
                                                            "#EC NEEDED
        gv_cx_fp_api_usage      TYPE REF TO cx_fp_api_usage,
                                                            "#EC NEEDED
        gv_cx_fp_api_internal   TYPE REF TO cx_fp_api_internal.
                                                            "#EC NEEDED

* determine the name of the generated function module
*
  TRY.
      CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
        EXPORTING
          i_name     = P_TNAPR_SFORM
        IMPORTING
          e_funcname = P_FUNC_MODULE_NAME.
    CATCH cx_fp_api_repository INTO gv_cx_fp_api_repository.
      MESSAGE gv_cx_fp_api_repository TYPE 'E'.
    CATCH cx_fp_api_internal INTO gv_cx_fp_api_internal.
      MESSAGE gv_cx_fp_api_internal TYPE 'E'.
    CATCH cx_fp_api_usage INTO gv_cx_fp_api_usage.
      MESSAGE gv_cx_fp_api_usage TYPE 'E'.
    CATCH cx_root INTO gv_w_cx_root.                     "#EC CATCH_ALL
      MESSAGE gv_w_cx_root TYPE 'E'.
  ENDTRY.

ENDFORM.                    " read_fm

*Text symbol text£º
*001:Document Number
*002:Expenses
*003:Receipts
*004:Business Trans.
*010:Signatures:
*011:Prepared
*012:Checked
*013:Confirmed
*014:Symbols:
*015:Posted
*016:Saved
*017:Reversed/Reversal Document
*020:CASH JOURNAL
*021:Time:
*022:Date:
*023:Page:
*030:Opening Balance:
*031:Closing Balance
*032:Period:
*033:Total Transfer:
*040:* Total Expenses only Saved
*041:* Total Receipts only Saved

*042:Number of Saved Documents:
*Selection text£º
*DATE:        Date Interval
*LD_ZEBRA:        Line Selection
*PAGEY:        Last Page of Year
*SAKNR:D       .
*SD_BUKRS:        Company Code
*SD_CANUM:        Cash Journal
*TITLE:D       .
*WAERS:D       .
