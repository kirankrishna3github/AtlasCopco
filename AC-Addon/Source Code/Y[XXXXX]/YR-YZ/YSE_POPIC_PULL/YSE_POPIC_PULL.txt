*----------------------------------------------------------------------*
* PROGRAM ID           : YSE_POPIC_PULL                                *
* PROGRAM TITLE        : YSE : Material creation and maintenance       *
* AUTHOR               : Marc Jacobs                                   *
* DATE                 : 24/09/2007                                    *
* DEVELOPMENT ID       : I001                                          *
*                                                                      *
* CHANGE REQUEST NUMBER: CD1K921099                                    *
*                                                                      *
* Program Description:  creation and maintenance of materials in SEED  *
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NR| CHANGE REFERENCE #     *
*----------------------------------------------------------------------*
* MOD-001 |02.04.2009| J. Smets |CD1K947420   |CR0393 Show exh. stock  *
* MOD-002 |11.05.2009| G. Rutten|CD1K948182   |CR0723 Clean(Selection  *
*                                              on Materials            *
* MOD-003 |17.11.2009| M.Jacobs |CD1K951927   |CR1108 POPIC for Russia *
*----------------------------------------------------------------------*
* MOD-004 |19.02.2010| M.Jacobs |CD1K954756   |Bugfix                  *
************************************************************************
REPORT yse_popic_pull MESSAGE-ID yse_interfaces.

************************************************************************
*                   T A B L E S                                        *
************************************************************************
TABLES : marc ,
         mara ,
         lfa1,
         yse_popic_werks ,
         yse_popic_vkorg ,
         yse_po_sorg_porg.
************************************************************************
*                   C O N S T A N T S                                  *
************************************************************************
CONSTANTS: con_tab  TYPE c VALUE cl_abap_char_utilities=>horizontal_tab,
           c_filetype(10)   TYPE c VALUE 'ASC',     " FILE TYPE
           c_blank          TYPE c VALUE ' ',       " no separator
           c_mestyp         LIKE edidc-mestyp VALUE 'YSE_POPIC_OUT' ,
           c_idoc_type      LIKE edidc-idoctp VALUE 'YSE_POPIC_OUT' ,
           c_segment(16)    TYPE c VALUE 'YSE_E1_POPIC_OUT',
           c_pull(4)        TYPE c VALUE 'PULL',
           c_x(1)           TYPE c VALUE 'X' ,
           c_1(1)           TYPE c VALUE '1' ,
           c_en             TYPE spras             VALUE 'E',
           c_type_a         TYPE bapiret2-type     VALUE 'A',
           c_type_e         TYPE bapiret2-type     VALUE 'E',
           c_z001           TYPE sugrd             VALUE 'Z001',
           c_z002           TYPE kschl             VALUE 'Z002',
           c_mm02           LIKE sy-tcode          VALUE 'MM02',
           c_mm01           LIKE sy-tcode          VALUE 'MM01',
           c_a1(2)          TYPE c                 VALUE 'A1'         ,
           c_ls(2)          TYPE c VALUE 'LS'.
* begin of insertion MOD-003 CR1108
CONSTANTS: c_ru(2)          TYPE c                 VALUE 'RU'.
* end of insertion MOD-003 CR1108
************************************************************************
*                   V A R I A B L E S                                  *
************************************************************************
DATA : gv_filename   TYPE string.
DATA : gv_super(5)   TYPE c.
DATA : gv_zgsber(3)  TYPE c.
TYPES: BEGIN OF ty_upload,
         v_text(100)   TYPE c,            " FILE UPLOAD TEXT
       END OF ty_upload.

DATA: gt_upload TYPE STANDARD TABLE OF ty_upload
                INITIAL SIZE 0 WITH HEADER LINE.

DATA : wa_string    TYPE string.

DATA: BEGIN OF gt_mat OCCURS 0,
        matnr_popic TYPE zmatnr_popic,
        zdcfam      TYPE zdcfam,
        zccfam      TYPE zccfam,
      END OF gt_mat.

DATA : parms_ok(1) TYPE c.
DATA: i_edidc_control_comm LIKE edidc OCCURS 1 WITH HEADER LINE ,
      i_edidd_data LIKE edidd OCCURS 0 WITH HEADER LINE ,
      wa_edidc LIKE edidc ,
      wa_mat LIKE yse_popic_out.
DATA : gv_nfmat   TYPE nfmat.

DATA: BEGIN OF gt_material OCCURS 50.
        INCLUDE STRUCTURE yse_e1i011.
DATA:     werks TYPE werks_d.
DATA: END OF gt_material.

DATA: BEGIN OF gt_matentered OCCURS 50.
        INCLUDE STRUCTURE yse_e1i011.
DATA:     vkorg TYPE vkorg,
          vtweg TYPE vtweg.
DATA: END OF gt_matentered.

DATA: BEGIN OF gt_follow OCCURS 50.
        INCLUDE STRUCTURE yse_e1i011.
DATA:     werks TYPE werks_d.
DATA: END OF gt_follow.

DATA: BEGIN OF lt_plants OCCURS 0.
        INCLUDE STRUCTURE marc_werk.
DATA: END OF lt_plants.

* General Data for Material
DATA: BEGIN OF gt_mara OCCURS 0.
        INCLUDE STRUCTURE mara_ueb.
DATA: END   OF gt_mara.

* Plant Data for Material
DATA: BEGIN OF gt_marc OCCURS 0.
        INCLUDE STRUCTURE marc_ueb.
DATA: END   OF gt_marc.

* Sales Data for Material
DATA: BEGIN OF gt_mvke OCCURS 0.
        INCLUDE STRUCTURE mvke_ueb.
DATA: END   OF gt_mvke.

* Messages
DATA: BEGIN OF gt_messtab OCCURS 0.
        INCLUDE STRUCTURE merrdat.
DATA: END   OF gt_messtab.

DATA: BEGIN OF lt_ekorg OCCURS 0,
         ekorg TYPE ekorg,
         werks TYPE ewerk,
      END OF lt_ekorg.

DATA: BEGIN OF gt_werks OCCURS 0,
         werks TYPE ewerk,
      END OF gt_werks.

DATA : BEGIN OF i_vkorg OCCURS 0,
         vkorg         TYPE vkorg,
         vtweg         TYPE vtweg,
       END OF i_vkorg.

* begin of insertion MOD-004
DATA : wa_ysepopicvkorg LIKE yse_popic_vkorg.
* end of insertion MOD-004
DATA : p_zgsber   TYPE zgsber.
DATA l_name LIKE dcobjdef-name.
DATA it_dd07v LIKE dd07v OCCURS 0 WITH HEADER LINE.
DATA: it_zgsber LIKE dd07v OCCURS 0 WITH HEADER LINE.
DATA: it_zccfam LIKE dd07v OCCURS 0 WITH HEADER LINE.
DATA: it_zdcfam LIKE dd07v OCCURS 0 WITH HEADER LINE.
DATA : okcode_9000 TYPE sy-ucomm,
       okcode_9001 TYPE sy-ucomm,
       okcode_9002 TYPE sy-ucomm,
       okcode_9003 TYPE sy-ucomm,
       okcode_9004 TYPE sy-ucomm.
DATA: gt_sorg_porg LIKE yse_po_sorg_porg OCCURS 0 WITH HEADER LINE.

DATA : wa_supercession       TYPE yse_e1i011 ,
       wa_idoc_status        TYPE bdidocstat,
       wa_idoc               TYPE yse_popic_super ,
       g_text                LIKE t100-text,
       g_mstring(100)        TYPE c,
       g_cnt_tranc           TYPE i,
       g_recs                TYPE i,
       g_cnt_d_ind           TYPE i,
       gv_ok(1)              TYPE c,
       gv_ctam(1)            TYPE c,
       gv_lifnr              TYPE elifn,
       lv_infnr              TYPE infnr,
       gv_update_matnr       TYPE matnr,
       gv_matasuper(1)       TYPE c,
       gv_vkorg              TYPE vkorg,
       gv_mmsta              LIKE marc-mmsta,
       gv_matnr              LIKE mara-matnr,
       gv_mode(1)            TYPE c VALUE 'N',
       gv_found(1)           TYPE c,
       gv_answer(1)          TYPE c,
       gv_ekorg              LIKE eine-ekorg,
       lv_matnr              TYPE matnr,
       lv_sw_done(1)         TYPE c,
       lv_pstata             TYPE pstat_d,
       lv_pstatc             TYPE pstat_d,
       lv_sw(1)              TYPE c,
       g_errors              TYPE bierrnum,
       wa_follow             LIKE gt_material,
       wa_material           LIKE gt_material,
       wa_maintain           LIKE gt_material,
       p_matnr               TYPE zmatnr_popic,
       p_dcfam               TYPE zdcfam,
       p_ccfam               TYPE zccfam,
       p_datum               TYPE sy-datum,
       p_infile              LIKE /sapdmc/lsoinp-filename,
       sup(1)                TYPE c,
       tbp(1)                TYPE c,
       exhaust(1)            TYPE c,
       gv_mvgr4              LIKE mvke-mvgr4,
       gv_local(1)           TYPE c,
       wa_matentered         LIKE gt_matentered.
* Begin of Insert MOD-002
SELECTION-SCREEN BEGIN OF SCREEN 1004 AS SUBSCREEN.
SELECT-OPTIONS  s_matnr  FOR mara-matnr.
SELECTION-SCREEN END OF SCREEN 1004.
* End of Insert MOD-002
************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************

*&---------------------------------------------------------------------*
*&      Form  Create_IDocs
*&---------------------------------------------------------------------*
*       Create Idoc's
*----------------------------------------------------------------------*
FORM create_idocs .

  DATA: g_created_comm_idocs TYPE sy-tabix .
  CLEAR : i_edidc_control_comm ,
          wa_edidc             ,
          i_edidd_data         .

** Polulate Control Record
  wa_edidc-mestyp =  c_mestyp.
  wa_edidc-idoctp =  c_idoc_type.
  wa_edidc-rcvprt =  c_ls.
* FIND RECEIVING PARTNER
  SELECT SINGLE rcvprn INTO wa_edidc-rcvprn
  FROM edp13
  WHERE mestyp = c_mestyp.

** Create Idoc's for every new materail number
  LOOP AT gt_mat.

    MOVE-CORRESPONDING gt_mat TO wa_mat.
    IF NOT wa_mat-matnr_popic IS INITIAL.
      wa_mat-action = c_pull.
      wa_mat-username = sy-uname.
* CR 188: now for each item (also double items)
*    AT NEW matnr_popic .
      CLEAR i_edidd_data[] .
      i_edidd_data-segnam  = c_segment  .
      i_edidd_data-sdata   = wa_mat.
      APPEND i_edidd_data .
*    ENDAT .

*    AT END OF matnr_popic .
** Generate Idoc's

      CALL FUNCTION 'MASTER_IDOC_DISTRIBUTE'
        EXPORTING
          master_idoc_control            = wa_edidc
        TABLES
          communication_idoc_control     = i_edidc_control_comm
          master_idoc_data               = i_edidd_data
        EXCEPTIONS
          error_in_idoc_control          = 1
          error_writing_idoc_status      = 2
          error_in_idoc_data             = 3
          sending_logical_system_unknown = 4
          OTHERS                         = 5.

      IF sy-subrc <> 0.
        MESSAGE e025 .
      ELSE.
        DESCRIBE TABLE i_edidc_control_comm LINES sy-tfill.
        ADD sy-tfill TO g_created_comm_idocs.

        READ TABLE i_edidc_control_comm INDEX 1.

        REFRESH i_edidc_control_comm.
      ENDIF.

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'.

      CALL FUNCTION 'EDI_DOCUMENT_DEQUEUE_LATER'
        EXPORTING
          docnum                 = i_edidc_control_comm-docnum
        EXCEPTIONS
          idoc_is_not_to_dequeue = 1
          OTHERS                 = 2.

*    ENDAT .
    ENDIF.
  ENDLOOP .

  MESSAGE s001(00) WITH text-i01 g_created_comm_idocs.




ENDFORM.                    " Create_IDocs
*&---------------------------------------------------------------------*
*&      Module  set_status  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE set_status_9000 OUTPUT.

  CLEAR : okcode_9000.
  SET PF-STATUS '9000'.
  SET TITLEBAR '9000'.

ENDMODULE.                 " set_status  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9000 INPUT.

  CASE okcode_9000.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0.
    WHEN 'PULL'.
      SET SCREEN 9001.
      LEAVE SCREEN.
    WHEN 'MASS'.
      CALL TRANSACTION 'YSE_POPIC_MAIN'.
    WHEN 'SUPER'.
      SET SCREEN 9002.
      LEAVE SCREEN.
    WHEN 'CLEAN'.
      SET SCREEN 9004.
      LEAVE SCREEN.
    WHEN OTHERS.
      SET SCREEN 9000.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " USER_COMMAND  INPUT

*&---------------------------------------------------------------------*
*&      Form  fill_table_gt_mat
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_table_gt_mat.

  REFRESH gt_mat.
  IF NOT p_infile IS INITIAL.
    MOVE p_infile TO gv_filename.
    PERFORM get_from_pres IN PROGRAM yam_common_routines
                                    TABLES  gt_upload
                                    USING   gv_filename
                                            c_filetype
                                            c_blank.

    LOOP AT gt_upload INTO wa_string.
      SPLIT wa_string AT con_tab
       INTO gt_mat-matnr_popic
            gt_mat-zdcfam
            gt_mat-zccfam.
      APPEND gt_mat.
      CLEAR gt_mat.
    ENDLOOP.
  ELSE.
* fill gt_mat with screen-parameters
    gt_mat-matnr_popic = p_matnr.
    gt_mat-zdcfam = p_dcfam.
    gt_mat-zccfam = p_ccfam.
    APPEND gt_mat.
    CLEAR gt_mat.
  ENDIF.
ENDFORM.                    "fill_table_gt_mat

*&---------------------------------------------------------------------*
*&      Module  check  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE check INPUT.

  PERFORM check_parms.

ENDMODULE.                 " check  INPUT

*&---------------------------------------------------------------------*
*&      Form  check_parms
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM check_parms.

  parms_ok = 'Y'.
  IF sy-ucomm = 'EXEC'.
    IF p_matnr IS INITIAL AND p_infile IS INITIAL.
      parms_ok = 'N'.
      MESSAGE s001(00) WITH text-e01.
      EXIT.
    ENDIF.

    IF NOT p_matnr IS INITIAL AND NOT p_infile IS INITIAL .
      parms_ok = 'N'.
      MESSAGE s001(00) WITH text-e02.
      EXIT.
    ENDIF.

    IF NOT p_matnr IS INITIAL.
      IF p_dcfam IS INITIAL OR p_ccfam IS INITIAL.
        parms_ok = 'N'.
        MESSAGE s001(00) WITH text-e04.
        EXIT.
      ENDIF.
      IF p_dcfam = p_ccfam.
        parms_ok = 'N'.
        MESSAGE s001(00) WITH text-e05.
        EXIT.
      ENDIF.
    ENDIF.
  ENDIF.
  IF parms_ok = 'Y'.
    SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
  ENDIF.

ENDFORM.                    "check_parms
*&---------------------------------------------------------------------*
*&      Module  get_filename  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE get_filename INPUT.

  CALL FUNCTION 'WS_FILENAME_GET'
    EXPORTING
      def_path = 'C:\SAP\'
      mask     = ',*,*.txt.'
    IMPORTING
      filename = p_infile
    EXCEPTIONS
      OTHERS   = 5.


ENDMODULE.                 " get_filename  INPUT
*&---------------------------------------------------------------------*
*&      Module  EXIT_COMMAND  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_command_9000 INPUT.

  CASE okcode_9000.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0.
  ENDCASE.

ENDMODULE.                 " EXIT_COMMAND  INPUT

*----------------------------------------------------------------------*
*  MODULE user_command_9001 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE user_command_9001 INPUT.

  CASE okcode_9001.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0.
    WHEN 'MAIN'.
      CLEAR gv_super.
      EXPORT gv_super TO MEMORY ID 'SUPER'.
      SUBMIT yse_popic_maintain
      AND RETURN.
    WHEN 'EXEC'.
      PERFORM check_parms.
      IF parms_ok = 'Y'.
        PERFORM fill_table_gt_mat.
        IF gt_mat[] IS INITIAL .
          MESSAGE s001(00) WITH text-i03.
        ELSE.
** Generate Idoc's
          SORT gt_mat BY matnr_popic.
          PERFORM create_idocs.
        ENDIF.
      ENDIF.
    WHEN OTHERS.
      SET SCREEN 9001.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " USER_COMMAND  INPUT

*----------------------------------------------------------------------*
*  MODULE set_status_9001 OUTPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE set_status_9001 OUTPUT.

  CLEAR okcode_9001.
  GET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
  IF p_ccfam = 'CHN'.
    p_ccfam = 'SHT'.
  ENDIF.
  SET PF-STATUS '9001'.
  SET TITLEBAR '9001'.

ENDMODULE.                 " set_status  OUTPUT
*----------------------------------------------------------------------*
*  MODULE exit_command_9001 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE exit_command_9001 INPUT.

  CASE okcode_9001.
    WHEN 'BACK'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0.
  ENDCASE.

ENDMODULE.                 " EXIT_COMMAND  INPUT

*----------------------------------------------------------------------*
*  MODULE user_command_9002 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE user_command_9002 INPUT.

  CASE okcode_9002.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'EXIT'.
      LEAVE TO SCREEN 0.
    WHEN 'CANCEL'.
      LEAVE TO SCREEN 0.
    WHEN 'SUPERMAIN'.
      gv_super = 'SUPER'.
      EXPORT gv_super TO MEMORY ID 'SUPER'.
      gv_zgsber = p_zgsber.
      EXPORT gv_zgsber TO MEMORY ID 'ZGSBER'.
      SUBMIT yse_popic_maintain
      AND RETURN.
      CLEAR gv_zgsber.
      EXPORT gv_zgsber TO MEMORY ID 'ZGSBER'.
    WHEN 'SUPERCREA'.
      SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
      SET SCREEN 9003.
      LEAVE SCREEN.
    WHEN 'LISTALL'.
      SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
      SUBMIT yse_supersession_list WITH p_zccfam = p_ccfam
                                   WITH p_all = c_x
                                   WITH p_uncomp = ' '
                                   WITH p_comp = ' '
        AND RETURN.
    WHEN 'LISTCOMP'.
      SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
      SUBMIT yse_supersession_list WITH p_zccfam = p_ccfam
                                   WITH p_comp = c_x
                                   WITH p_all = ' '
                                   WITH p_uncomp = ' '
        AND RETURN.
    WHEN 'LISTUNCOMP'.
      SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
      SUBMIT yse_supersession_list WITH p_zccfam = p_ccfam
                                   WITH p_uncomp = c_x
                                   WITH p_all = ' '
                                   WITH p_comp = ' '
        AND RETURN.
    WHEN OTHERS.
      SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
      SET SCREEN 9002.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " USER_COMMAND  INPUT

*----------------------------------------------------------------------*
*  MODULE exit_command_9002 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE exit_command_9002 INPUT.

  CASE okcode_9002.
    WHEN 'BACK'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'EXIT'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'CANCEL'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " EXIT_COMMAND  INPUT
*----------------------------------------------------------------------*
*  MODULE set_status_9002 OUTPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE set_status_9002 OUTPUT.

  CLEAR : okcode_9002.
  SET PF-STATUS '9002'.
  SET TITLEBAR '9002'.
  GET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.

ENDMODULE.                 " set_status  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  CHECK_9002  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE check_9002 INPUT.

  IF ( okcode_9002 <> 'BACK' AND okcode_9002 <> 'EXIT' AND
      okcode_9002 <> 'CANCEL' ).
* business area
    gv_found = 'N'.
    LOOP AT it_zgsber.
      IF it_zgsber-domvalue_l = p_zgsber.
        gv_found = 'Y'.
        EXIT.
      ENDIF.
    ENDLOOP.
    IF gv_found = 'N'.
      MESSAGE s001(00) WITH text-e10.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    ENDIF.

* ccfam coe
    gv_found = 'N'.
    LOOP AT it_zccfam.
      IF it_zccfam-domvalue_l = p_ccfam.
        gv_found = 'Y'.
        EXIT.
      ENDIF.
    ENDLOOP.
    IF gv_found = 'N'.
      MESSAGE s001(00) WITH text-e11.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    ENDIF.
  ENDIF.

ENDMODULE.                 " CHECK_9002  INPUT
*&---------------------------------------------------------------------*
*&      Module  SET_STATUS_9003  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE set_status_9003 OUTPUT.

  CLEAR : okcode_9003.
  SET PF-STATUS '9003'.
  SET TITLEBAR '9003'.

ENDMODULE.                 " SET_STATUS_9003  OUTPUT

*----------------------------------------------------------------------*
*  MODULE exit_command_9003 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE exit_command_9003 INPUT.

  CASE okcode_9003.
    WHEN 'BACK'.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    WHEN 'EXIT'.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    WHEN 'CANCEL'.
      SET SCREEN '9002'.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " EXIT_COMMAND  INPUT

*----------------------------------------------------------------------*
*  MODULE user_command_9003 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE user_command_9003 INPUT.

  CASE okcode_9003.
    WHEN 'BACK'.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    WHEN 'EXIT'.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    WHEN 'CANCEL'.
      SET SCREEN '9002'.
      LEAVE SCREEN.
    WHEN 'EXEC'.
      PERFORM supersession.
    WHEN OTHERS.
      SET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.
      SET SCREEN 9003.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " USER_COMMAND  INPUT

*----------------------------------------------------------------------*
*  MODULE check_9003 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE check_9003 INPUT.
  CLEAR gv_nfmat.
  IF marc-matnr IS INITIAL.
    MESSAGE s001(00) WITH text-e08.
  ELSE.
    IF marc-nfmat IS INITIAL.
      MESSAGE s001(00) WITH text-e09.
    ELSE.
      IF marc-matnr = marc-nfmat.
        MESSAGE s001(00) WITH text-e06.
      ELSE.
        SELECT SINGLE nfmat INTO gv_nfmat FROM
          marc WHERE nfmat = marc-matnr.
        IF sy-subrc = 0.
          MESSAGE s001(00) WITH text-e07.
        ELSE.
          PERFORM mat_a_already_super.
          IF gv_matasuper = 'Y'.
            MESSAGE s001(00) WITH text-e18 gv_matnr.
          ELSE.
* check vendor
            IF lfa1-lifnr IS INITIAL.
              MESSAGE s001(00) WITH text-e20.
            ELSE.
              SELECT SINGLE lifnr INTO gv_lifnr FROM lfa1
                WHERE lifnr = lfa1-lifnr.
              IF sy-subrc <> 0.
                MESSAGE s001(00) WITH text-e21 lfa1-lifnr.
              ELSE.
                CLEAR: gv_vkorg, gv_ekorg.
                SELECT SINGLE vkorg INTO gv_vkorg FROM yse_popic_vkorg
                    WHERE zccfam = p_ccfam
                      AND zgsber = p_zgsber
                      AND vtweg = '01'.
                IF sy-subrc <> 0.
                  MESSAGE s001(00) WITH text-e17.
                ELSE.
                  SELECT SINGLE ekorg INTO gv_ekorg FROM yse_po_sorg_porg
                      WHERE vkorg = gv_vkorg.
* check if material a exists in pir
                  SELECT SINGLE a~matnr INTO gv_matnr FROM eina AS a
                     INNER JOIN eine AS b
                             ON a~infnr = b~infnr
                          WHERE a~matnr EQ marc-matnr
                            AND a~lifnr EQ lfa1-lifnr
                            AND a~loekz EQ space
                            AND b~ekorg EQ gv_ekorg.
                  IF sy-subrc <> 0.
                    MESSAGE s001(00) WITH text-e15 gv_ekorg.
                  ELSE.
* check if material b exists in pir
                    SELECT SINGLE a~matnr INTO gv_matnr FROM eina AS a
                  INNER JOIN eine AS b
                          ON a~infnr = b~infnr
                       WHERE a~matnr EQ marc-nfmat
                         AND a~lifnr EQ lfa1-lifnr
                         AND a~loekz EQ space
                         AND b~ekorg EQ gv_ekorg.
                    IF sy-subrc <> 0.
                      MESSAGE s001(00) WITH text-e16 gv_ekorg.
                    ENDIF.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDMODULE.                    "check_9003 INPUT
*&---------------------------------------------------------------------*
*&      Form  supersession
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM supersession.

  REFRESH: gt_material.
  CLEAR: wa_supercession ,
         wa_idoc_status,
         gt_material.

  CLEAR : g_text , g_mstring.

  wa_supercession-matnr = marc-matnr.
  wa_supercession-nfmat = marc-nfmat.
  wa_supercession-ausdt = sy-datum.

  IF NOT wa_supercession IS INITIAL  .
    PERFORM y_create_final_data_pl  TABLES  gt_material
                                  CHANGING  wa_supercession
                                            wa_idoc_status.
  ENDIF.

  IF NOT gt_material[] IS INITIAL .

*.... Check if superceeded material is already a follow-up material
    LOOP AT gt_material.
      wa_material = gt_material.

      CLEAR: gt_follow.
      REFRESH: gt_follow.
      PERFORM check_follow-up TABLES gt_follow
                                     gt_material
                              USING  wa_material.

      IF NOT gt_follow[] IS INITIAL.

*........ Change each of the items already superceeded
        CLEAR: g_cnt_tranc,
               g_cnt_d_ind.
        LOOP AT gt_follow.
          CLEAR wa_maintain.
          MOVE-CORRESPONDING gt_follow TO wa_maintain.
          PERFORM prepare_data_for_fm USING wa_maintain.
        ENDLOOP.

        PERFORM change_material CHANGING wa_idoc_status.

      ENDIF.
*...... Only once
      EXIT.
    ENDLOOP.


******************************************************************
*     Update material (purch.data and MRP4)
******************************************************************

    CLEAR: g_cnt_tranc,
           g_cnt_d_ind.
    LOOP AT gt_material.
      wa_material = gt_material.

*...... Prepare data for FM
      CLEAR wa_maintain.
      MOVE-CORRESPONDING gt_material TO wa_maintain.
      PERFORM prepare_data_for_fm USING wa_maintain.
    ENDLOOP.

    gv_ok = 'N'.
    PERFORM change_material CHANGING wa_idoc_status.

  ENDIF .

******************************************************************
*   Update material determination (VB11)
******************************************************************

  REFRESH gt_matentered.
  PERFORM y_create_final_data_so  TABLES  gt_matentered
                                   USING  wa_supercession
                                CHANGING  wa_idoc_status.

*.. Update Idoc Status in case of any Error
  IF NOT wa_idoc_status IS INITIAL .

  ENDIF .

  IF gt_matentered[] IS NOT INITIAL.
    LOOP AT gt_matentered.
      MOVE gt_matentered TO wa_matentered.

*...... Create substitution only if maintain-dark went ok
      IF gv_ok = 'Y'.

        PERFORM y_update_mat_determ USING     wa_matentered
                                    CHANGING  wa_idoc_status .

*...... Update Idoc Status in case of any Error
        IF NOT wa_idoc_status IS INITIAL .

        ENDIF .

      ENDIF.

      IF NOT gt_follow[] IS INITIAL.

*........ Update substitution
        CLEAR gt_follow.
        LOOP AT gt_follow.
          wa_follow = gt_follow.

          AT NEW matnr.
*............ Check if the MatEntered has already an entry
            CLEAR gv_update_matnr.
            PERFORM check_matentered_exist USING    wa_follow
                                                    wa_matentered
                                           CHANGING gv_update_matnr.

            IF gv_update_matnr IS INITIAL.
              CONTINUE.
            ELSE.
              wa_matentered-matnr = gv_update_matnr.
              PERFORM y_update_mat_determ USING     wa_matentered
                                          CHANGING  wa_idoc_status .
            ENDIF.

*............ Update Idoc Status in case of any Error
            IF NOT wa_idoc_status IS INITIAL .

            ENDIF .
          ENDAT.

        ENDLOOP.

        IF NOT wa_idoc_status IS INITIAL .
          EXIT.
        ENDIF.

      ENDIF.
    ENDLOOP.
  ENDIF .
ENDFORM.                    "supersession
*&---------------------------------------------------------------------*
*&      Form  y_create_final_data_pl
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GT_MATERIAL      text
*      -->P_WA_SUPERCESSION  text
*      -->P_WA_IDOC_STATUS   text
*----------------------------------------------------------------------*
FORM y_create_final_data_pl TABLES  p_gt_material
                                             STRUCTURE gt_material
                           CHANGING p_wa_supercession
                                             STRUCTURE yse_e1i011
                                    p_wa_idoc_status
                                             STRUCTURE bdidocstat.

* Convert to Internal Material Number
  CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
    EXPORTING
      input  = p_wa_supercession-matnr
    IMPORTING
      output = p_wa_supercession-matnr.

* Convert to Internal New Material Number
  CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
    EXPORTING
      input  = p_wa_supercession-nfmat
    IMPORTING
      output = p_wa_supercession-nfmat.

  REFRESH: lt_plants.
  CALL FUNCTION 'MATERIAL_READ_PLANTS'
    EXPORTING
      matnr  = p_wa_supercession-matnr
    TABLES
      plants = lt_plants.

  LOOP AT lt_plants.
    SELECT SINGLE * FROM yse_popic_werks
         WHERE zccfam = p_ccfam
           AND zgsber = p_zgsber
           AND werks = lt_plants-werks.
    IF sy-subrc <> 0.
      DELETE lt_plants.
    ENDIF.
  ENDLOOP.

* Check if superceeded material exist in the system
  SELECT SINGLE matnr INTO lv_matnr
     FROM mara
     WHERE matnr = p_wa_supercession-matnr.

  IF sy-subrc <> 0.
    wa_idoc_status-status = '68'.
    wa_idoc_status-msgty  = 'E' .
    wa_idoc_status-msgid  = 'YSE_INTERFACES'.
    wa_idoc_status-msgno  = '015'.
    wa_idoc_status-msgv1  =  p_wa_supercession-matnr .
    RETURN.
  ENDIF.

* Check if follow-up material exist in the system
  SELECT SINGLE matnr INTO lv_matnr
     FROM mara
     WHERE matnr = p_wa_supercession-nfmat.

  IF sy-subrc <> 0.
    wa_idoc_status-status = '51'.
    wa_idoc_status-msgty  = 'E' .
    wa_idoc_status-msgid  = 'YSE_INTERFACES'.
    wa_idoc_status-msgno  = '016'.
    wa_idoc_status-msgv1  =  p_wa_supercession-nfmat .
    wa_idoc_status-msgv2  =  p_wa_supercession-lif16 .
    RETURN.
  ENDIF.

* Check vendor
  IF wa_supercession-lif16(3) = 'XXX'.
    wa_idoc_status-status = '51'.
    wa_idoc_status-msgty  = 'E' .
    wa_idoc_status-msgid  = 'YSE_INTERFACES'.
    wa_idoc_status-msgno  = '017'.
    wa_idoc_status-msgv1  =  p_wa_supercession-lif16 .
    RETURN.
  ENDIF.

*
  CLEAR lv_sw_done.
  LOOP AT lt_plants.
    PERFORM check_ctam_plant USING    lt_plants-werks
                             CHANGING gv_ctam.
    IF gv_ctam = 'X'.
      IF gv_lifnr = '0102000000'.
        MOVE-CORRESPONDING p_wa_supercession TO p_gt_material.
        p_gt_material-werks = lt_plants-werks.
        APPEND p_gt_material.
        CLEAR p_gt_material.
      ENDIF.
    ELSE.
*.... If no CTAM: Get the plants to be updated (only once)
* begin of deletion MOD-004
*      IF lv_sw_done IS INITIAL.
*        PERFORM get_plants_to_update TABLES p_gt_material
*                                     USING  p_wa_supercession
*                                            gv_lifnr.
*        lv_sw_done = 'X'.
*      ENDIF.
* end of deletion MOD-004
* begin of insertion MOD-004
      MOVE-CORRESPONDING p_wa_supercession TO p_gt_material.
      p_gt_material-werks = lt_plants-werks.
      APPEND p_gt_material.
      CLEAR p_gt_material.
* end of insertion MOD-004
    ENDIF.
  ENDLOOP.

  IF p_gt_material[] IS INITIAL.
    IF gv_lifnr = '0102000000'.
      wa_idoc_status-status = '51'.
      wa_idoc_status-msgty  = 'E' .
      wa_idoc_status-msgid  = 'YSE_INTERFACES'.
      wa_idoc_status-msgno  = '012'.
      wa_idoc_status-msgv1  =  p_wa_supercession-matnr .
      RETURN.
    ELSE.
      wa_idoc_status-status = '68'.
      wa_idoc_status-msgty  = 'E' .
      wa_idoc_status-msgid  = 'YSE_INTERFACES'.
      wa_idoc_status-msgno  = '019'.
      wa_idoc_status-msgv1  =  p_wa_supercession-matnr .
      wa_idoc_status-msgv2  =  p_wa_supercession-lif16 .
      RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    " Y_CREATE_FINAL_DATA_PL

*&---------------------------------------------------------------------*
*&      Form  change_material
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_WA_IDOC_STATUS  text
*----------------------------------------------------------------------*
FORM change_material CHANGING p_wa_idoc_status
                                             STRUCTURE bdidocstat.

  CALL FUNCTION 'MATERIAL_MAINTAIN_DARK'
    EXPORTING
      p_kz_no_warn              = 'N'
      kz_prf                    = 'W'
    IMPORTING
      number_errors_transaction = g_errors
    TABLES
      amara_ueb                 = gt_mara
      amarc_ueb                 = gt_marc
      amvke_ueb                 = gt_mvke
      amerrdat                  = gt_messtab
*     amfieldres                = gt_mfieldres
    EXCEPTIONS
      kstatus_empty             = 1
      tkstatus_empty            = 2
      t130m_error               = 3
      internal_error            = 4
      too_many_errors           = 5
      update_error              = 6
      OTHERS                    = 7.

  IF sy-subrc <> 0.
    ROLLBACK WORK.
*.. write IDoc status-record as error
    CLEAR wa_idoc_status .
    SELECT SINGLE text FROM t100 INTO g_text
                                 WHERE sprsl = c_en
                                   AND arbgb = sy-msgid
                                   AND msgnr = sy-msgno.
    IF sy-subrc = 0.
      g_mstring = g_text.
      IF g_mstring CS '&1'.
        REPLACE '&1' WITH sy-msgv1 INTO g_mstring.
        REPLACE '&2' WITH sy-msgv2 INTO g_mstring.
        REPLACE '&3' WITH sy-msgv3 INTO g_mstring.
        REPLACE '&4' WITH sy-msgv4 INTO g_mstring.
      ELSE.
        REPLACE '&' WITH sy-msgv1 INTO g_mstring.
        REPLACE '&' WITH sy-msgv2 INTO g_mstring.
        REPLACE '&' WITH sy-msgv3 INTO g_mstring.
        REPLACE '&' WITH sy-msgv4 INTO g_mstring.
      ENDIF.
      CONDENSE g_mstring.
    ENDIF.

  ELSE.
*.. Check return parameters, Populate Idoc status in case of error
    IF g_errors NE 0.
      LOOP AT gt_messtab.
        IF gt_messtab-msgty = c_type_a OR
           gt_messtab-msgty = c_type_e .

          SELECT SINGLE text FROM t100 INTO g_text
                                 WHERE sprsl = c_en
                                   AND arbgb = gt_messtab-msgid
                                   AND msgnr = gt_messtab-msgno.
          IF sy-subrc = 0.
            g_mstring = g_text.
            IF g_mstring CS '&1'.
              REPLACE '&1' WITH gt_messtab-msgv1 INTO g_mstring.
              REPLACE '&2' WITH gt_messtab-msgv2 INTO g_mstring.
              REPLACE '&3' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&4' WITH gt_messtab-msgv4 INTO g_mstring.
            ELSE.
              REPLACE '&' WITH gt_messtab-msgv1 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv2 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&' WITH gt_messtab-msgv4 INTO g_mstring.
            ENDIF.
            CONDENSE g_mstring.
          ENDIF.

          EXIT.

        ENDIF .
      ENDLOOP.
*     exit.
    ELSE.
      COMMIT WORK AND WAIT.
      IF gt_material-matnr = wa_maintain-matnr AND
         gt_material-nfmat = wa_maintain-nfmat.
        gv_ok = 'Y'.
        MESSAGE s001(00) WITH text-i02 .
      ENDIF.
    ENDIF .
  ENDIF .


  IF NOT g_mstring IS INITIAL .
    wa_idoc-error = g_mstring.
    MODIFY yse_popic_super FROM wa_idoc.
* begin of insertion MOD-004
    IF wa_idoc-docnum IS INITIAL.
      REPLACE 'distrib. channel' WITH 'distr.ch.' INTO g_mstring.
      MESSAGE e001(00) WITH g_mstring.
    ENDIF.
* end of insertion MOD-004
  ENDIF.

* Refresh interface tables
  CLEAR: gt_mara, gt_marc, gt_messtab, g_errors, gt_mvke.
  REFRESH: gt_mara, gt_marc, gt_messtab, gt_mvke.

ENDFORM.                    "change_material
*&---------------------------------------------------------------------*
*&      Form  check_ctam_plant
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PLANTS_WERKS  text
*      -->P_GV_CTAM       text
*----------------------------------------------------------------------*
FORM check_ctam_plant USING    p_plants_werks
                      CHANGING p_gv_ctam.

  CLEAR p_gv_ctam.
  IF p_plants_werks EQ 'ADEA' OR
     p_plants_werks EQ 'GBAA' OR
     p_plants_werks EQ 'IYAA' OR
     p_plants_werks EQ 'AFRA' OR
     p_plants_werks EQ 'CPRA' OR
     p_plants_werks EQ 'NNAA' OR
     p_plants_werks EQ 'NLAA' OR
     p_plants_werks EQ 'ESAA' OR
     p_plants_werks EQ 'CHAA' OR
     p_plants_werks EQ 'GMIX' OR
     p_plants_werks EQ 'BGAA'.
    p_gv_ctam = 'X'.
  ENDIF.

ENDFORM.                    " check_ctam_plant
*&---------------------------------------------------------------------*
*&      Form  check_follow-up
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GT_FOLLOW    text
*      -->P_GT_MATERIAL  text
*      -->P_WA_MATERIAL  text
*----------------------------------------------------------------------*
FORM check_follow-up TABLES   p_gt_follow   STRUCTURE gt_follow
                              p_gt_material STRUCTURE gt_material
                     USING    p_wa_material STRUCTURE wa_material.

  SELECT matnr werks
      INTO CORRESPONDING FIELDS OF TABLE gt_follow
      FROM marc
      FOR ALL ENTRIES IN p_gt_material
      WHERE nfmat = p_gt_material-matnr
        AND werks = p_gt_material-werks.

* Extend table with extra info
  IF NOT p_gt_follow[] IS INITIAL.
    SORT p_gt_follow BY matnr.
    LOOP AT p_gt_follow.
      p_gt_follow-nfmat = p_wa_material-nfmat.
      p_gt_follow-ausdt = p_wa_material-ausdt.
      p_gt_follow-sugrv = p_wa_material-sugrv.
      MODIFY p_gt_follow.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " check_follow-up

*&---------------------------------------------------------------------*
*&      Form  check_matentered_exist
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_WA_FOLLOW        text
*      -->P_WA_MATENTERED    text
*      -->P_GV_UPDATE_MATNR  text
*----------------------------------------------------------------------*
FORM check_matentered_exist  USING    p_wa_follow
                                            STRUCTURE gt_follow
                                      p_wa_matentered
                                            STRUCTURE gt_matentered
                             CHANGING p_gv_update_matnr.

  DATA: lv_matwa TYPE matwa.

  CLEAR: lv_matwa.

*  loop at p_gt_follow where nfmat = p_wa_matentered-matnr.
*    exit.
*  endloop.

*  if sy-subrc = 0.
  SELECT SINGLE matwa INTO lv_matwa
     FROM kotd002
     WHERE kappl = 'V'
       AND kschl = c_z002
       AND vkorg = p_wa_matentered-vkorg
       AND vtweg = p_wa_matentered-vtweg
       AND matwa = p_wa_follow-matnr.

  IF sy-subrc = 0.
    p_gv_update_matnr = p_wa_follow-matnr.
  ENDIF.
*  endif.

ENDFORM.                    " check_matentered_exist
*&---------------------------------------------------------------------*
*&      Form  get_plants_to_update
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->R_GT_MATERIAL      text
*      -->R_WA_SUPERCESSION  text
*      -->R_LIFNR            text
*----------------------------------------------------------------------*
* begin of deletion MOD-004
*FORM get_plants_to_update TABLES r_gt_material
*                                        STRUCTURE gt_material
*                          USING  r_wa_supercession
*                                        STRUCTURE yse_e1i011
*                                 r_lifnr.
*
** Check for the purch.inforec which exists for this material/vendor
*  SELECT SINGLE infnr lifnr INTO (lv_infnr, gv_lifnr)
*      FROM eina WHERE matnr = r_wa_supercession-matnr
*                  AND lifnr = r_lifnr
*                  AND loekz <> c_x.
*
*  IF sy-subrc = 0.
*    REFRESH lt_ekorg.
*    SELECT ekorg werks
*       INTO CORRESPONDING FIELDS OF TABLE lt_ekorg
*       FROM eine WHERE infnr = lv_infnr.
*
*    LOOP AT lt_ekorg.
*      MOVE-CORRESPONDING r_wa_supercession TO r_gt_material.
*      r_gt_material-werks = lt_ekorg-werks.
*      APPEND r_gt_material.
*      CLEAR r_gt_material.
*    ENDLOOP.
*
*    LOOP AT r_gt_material.
*      SELECT SINGLE * FROM yse_popic_werks
*           WHERE zccfam = p_ccfam
*             AND zgsber = p_zgsber
*             AND werks = r_gt_material-werks.
*      IF sy-subrc <> 0.
*        DELETE r_gt_material.
*      ENDIF.
*    ENDLOOP.
*
*  ENDIF.
*ENDFORM.                    "get_plants_to_update
* end of deletion MOD-004
*&---------------------------------------------------------------------*
*&      Form  prepare_data_for_fm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_WA_MAINTAIN  text
*----------------------------------------------------------------------*
FORM prepare_data_for_fm USING p_wa_maintain STRUCTURE wa_maintain.

*** MOD-001 * begin insert ***
  DATA: lt_dcfvko  TYPE TABLE OF yse_popic_dcfvko,
        lv_vkorg   TYPE vkorg,
        lv_vtweg   TYPE vtweg.
*** MOD-001 * end insert ***


  CLEAR: lv_pstata,
         lv_pstatc,
         lv_sw.

* check again if CTAM plant or not
  PERFORM check_ctam_plant USING    p_wa_maintain-werks
                           CHANGING gv_ctam.

* General Material Data
* Check if purchasing view for this material exists
  SELECT SINGLE pstat
           INTO lv_pstata
           FROM mara WHERE matnr = p_wa_maintain-matnr.

  g_cnt_tranc = g_cnt_tranc + 1.
  g_cnt_d_ind = g_cnt_d_ind + 1.

  gt_mara-mandt = sy-mandt.
  gt_mara-tcode = c_mm02.
  gt_mara-tranc = g_cnt_tranc.
  gt_mara-d_ind = g_cnt_d_ind.

  gt_mara-matnr = p_wa_maintain-matnr.

  IF gv_ctam = 'X'.
    gt_mara-magrv = 'Z001'.
    gt_mara-tragr = 'Z001'.
    IF lv_pstata CS 'E'.
      gt_mara-ekwsl = 'Z001'.
    ELSE.
      lv_sw = 'X'.
    ENDIF.
  ENDIF.

  APPEND gt_mara.
  CLEAR gt_mara.

  CLEAR gv_mvgr4.
  SELECT SINGLE mvgr4 INTO gv_mvgr4 FROM mvke
    WHERE matnr = p_wa_maintain-matnr
      AND vkorg = p_wa_maintain-werks
      AND vtweg = '11'.

* Sales data for Material only for CTAM
  IF gv_ctam = 'X' AND
     p_wa_maintain-werks <> 'GMIX'.
    gt_mvke-mandt = sy-mandt.
    gt_mvke-tranc = g_cnt_tranc.
    gt_mvke-d_ind = g_cnt_d_ind.

    gt_mvke-matnr = p_wa_maintain-matnr.
    gt_mvke-vkorg = p_wa_maintain-werks.
    gt_mvke-vtweg = '11'.

    gt_mvke-dwerk = p_wa_maintain-werks.

*    gt_mvke-mtpos = 'NORM'.                                 "MOD-001

    APPEND gt_mvke.
    CLEAR gt_mvke.
  ENDIF.
*** MOD-001 * begin insert ***
* Sales data for Material not CTAM
  IF gv_ctam = ' ' AND
     p_wa_maintain-werks <> 'GMIX'.
    CLEAR lt_dcfvko[].
    SELECT * FROM yse_popic_dcfvko
             INTO TABLE lt_dcfvko
             WHERE vendor = p_wa_maintain-lif16.
    IF NOT lt_dcfvko[] IS INITIAL.
      SELECT vkorg vtweg INTO (lv_vkorg, lv_vtweg)
             FROM mvke
             FOR ALL ENTRIES IN lt_dcfvko
             WHERE matnr = p_wa_maintain-matnr
               AND vkorg = lt_dcfvko-vkorg.
        gt_mvke-mandt = sy-mandt.
        gt_mvke-tranc = g_cnt_tranc.
        gt_mvke-d_ind = g_cnt_d_ind.

        gt_mvke-matnr = p_wa_maintain-matnr.
        gt_mvke-vkorg = lv_vkorg.
        gt_mvke-vtweg = lv_vtweg.

        gt_mvke-mtpos = 'NORM'.

        APPEND gt_mvke.
        CLEAR gt_mvke.
      ENDSELECT.
    ENDIF.
  ENDIF.
*** MOD-001 * end insert ***

* begin of inserton MOD-004
  SORT gt_mvke.
  DELETE ADJACENT DUPLICATES FROM gt_mvke COMPARING vkorg vtweg.
  LOOP AT gt_mvke.
    SELECT SINGLE * INTO wa_ysepopicvkorg FROM yse_popic_vkorg
      WHERE zccfam EQ p_ccfam
        AND zgsber EQ p_zgsber
        AND vkorg  EQ gt_mvke-vkorg.
    IF sy-subrc <> 0.
      DELETE gt_mvke.
    ENDIF.
  ENDLOOP.
* end of insertion MOD-004

* Plant Data for Material
* Check if purchasing view for this plant exists
  SELECT SINGLE pstat
           INTO lv_pstatc
           FROM marc WHERE matnr = p_wa_maintain-matnr
                       AND werks = p_wa_maintain-werks.

  gt_marc-mandt = sy-mandt.
  gt_marc-tranc = g_cnt_tranc.
  gt_marc-d_ind = g_cnt_d_ind.

  gt_marc-matnr = p_wa_maintain-matnr.
  gt_marc-werks = p_wa_maintain-werks.
  gt_marc-kzaus = c_1.
  gt_marc-ausdt = p_wa_maintain-ausdt.
  gt_marc-nfmat = p_wa_maintain-nfmat.

  IF gv_ctam = 'X'.
    gt_marc-ladgr = 'Z001'.
    IF lv_pstatc CS 'E'.
      gt_marc-mmsta = c_a1.
      gt_marc-mmstd = p_wa_maintain-ausdt.
      gt_marc-ekgrp = '100'.
    ELSE.
      lv_sw = 'X'.
    ENDIF.
  ELSE.
    gt_marc-mmsta = c_a1.
    gt_marc-mmstd = p_wa_maintain-ausdt.
  ENDIF.

* begin of insertion MOD-003 CR1108
* batch management
  IF gt_marc-werks+0(2) = c_ru.
    gt_marc-xchpf = c_x.
  ENDIF.
* end of insertion MOD-003 CR1108

  APPEND gt_marc.
  CLEAR gt_marc.

* Check if purchasing view has to be created for CTAM
  CHECK lv_sw = 'X'.

  g_cnt_tranc = g_cnt_tranc + 1.
  g_cnt_d_ind = g_cnt_d_ind + 1.

* General Material Data - Create
  gt_mara-mandt = sy-mandt.
  gt_mara-tcode = c_mm01.
  gt_mara-tranc = g_cnt_tranc.
  gt_mara-d_ind = g_cnt_d_ind.

  gt_mara-matnr = p_wa_maintain-matnr.
  gt_mara-ekwsl = 'Z001'.

  APPEND gt_mara.
  CLEAR gt_mara.

* Plant Data for Material - Create
  gt_marc-mandt = sy-mandt.
  gt_marc-tranc = g_cnt_tranc.
  gt_marc-d_ind = g_cnt_d_ind.

  gt_marc-matnr = p_wa_maintain-matnr.
  gt_marc-werks = p_wa_maintain-werks.

  gt_marc-mmsta = c_a1.
  gt_marc-mmstd = p_wa_maintain-ausdt.
  gt_marc-ekgrp = '100'.

* begin of insertion MOD-003 CR1108
* batch management
  IF gt_marc-werks+0(2) = c_ru.
    gt_marc-xchpf = c_x.
  ENDIF.
* end of insertion MOD-003 CR1108

  APPEND gt_marc.
  CLEAR gt_marc.

ENDFORM.                    " prepare_data_for_fm
*&---------------------------------------------------------------------*
*&      Form  y_create_final_data_so
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GT_MATENTERED    text
*      -->P_WA_SUPERCESSION  text
*      -->P_WA_IDOC_STATUS   text
*----------------------------------------------------------------------*
FORM y_create_final_data_so TABLES  p_gt_matentered
                                             STRUCTURE gt_matentered
                              USING p_wa_supercession
                                             STRUCTURE yse_e1i011
                           CHANGING p_wa_idoc_status
                                             STRUCTURE bdidocstat.

  DATA: BEGIN OF lt_vkorgs OCCURS 0.
          INCLUDE STRUCTURE mvke_vkorg.
  DATA: END OF lt_vkorgs.

  DATA: lv_sw_done.

* Select sales organis./distr.channels for which the material is
* maintained
  CLEAR lt_vkorgs.
  SELECT * INTO lt_vkorgs FROM mvke_vkorg
         WHERE matnr = p_wa_supercession-matnr.
    APPEND lt_vkorgs.
  ENDSELECT.

* Preselect link purch.org./sales org.
  SELECT * FROM yse_po_sorg_porg
       INTO TABLE gt_sorg_porg.

  CLEAR lv_sw_done.
  LOOP AT lt_vkorgs.
    PERFORM check_ctam_plant USING    lt_vkorgs-vkorg
                             CHANGING gv_ctam.
    IF gv_ctam = 'X'.
*.... do nothing
    ELSE.
*.... If no CTAM: Get the sal.org. to be updated (only once)
      IF lv_sw_done IS INITIAL.
* begin of deletion MOD-004

*        PERFORM get_salorg_to_update TABLES p_gt_matentered
*                                     USING  p_wa_supercession
*                                            gv_lifnr.
* end of deletion MOD-004
* begin of insertion MOD-004
        SELECT SINGLE * FROM yse_popic_vkorg
          WHERE zgsber = p_zgsber
          AND vkorg = lt_vkorgs-vkorg
          AND zccfam = p_ccfam
          AND vtweg = '01'.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING p_wa_supercession TO p_gt_matentered.
          p_gt_matentered-vkorg = lt_vkorgs-vkorg.
          p_gt_matentered-vtweg = '01'.
          APPEND p_gt_matentered.
          CLEAR p_gt_matentered.
          lv_sw_done = 'X'.
        ENDIF.
* end of insertion MOD-004
      ENDIF.
    ENDIF.
  ENDLOOP.

  IF gt_matentered[] IS INITIAL AND
     gv_ctam IS INITIAL.
* 20070816 mj changed idoc status from 51 to 68
*    wa_idoc_status-status = '51'.*
    wa_idoc_status-status = '68'.
    wa_idoc_status-msgty  = 'E' .
    wa_idoc_status-msgid  = 'YSE_INTERFACES'.
    wa_idoc_status-msgno  = '013'.
    wa_idoc_status-msgv1  =  p_wa_supercession-matnr .
    wa_idoc_status-msgv2  =  gv_lifnr.
    RETURN.
  ENDIF.

ENDFORM.                    " Y_CREATE_FINAL_DATA_SO
*&---------------------------------------------------------------------*
*&      Form  get_salorg_to_update
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->R_GT_MATENTERED    text
*      -->R_WA_SUPERCESSION  text
*      -->R_LIFNR            text
*----------------------------------------------------------------------*
* begin of deletion MOD-004
*FORM get_salorg_to_update  TABLES   r_gt_matentered
*                                      STRUCTURE  gt_matentered
*                           USING    r_wa_supercession
*                                      STRUCTURE yse_e1i011
*                                    r_lifnr.
*
*  DATA: lv_infnr TYPE infnr.
*
*  DATA: BEGIN OF lt_ekorg OCCURS 0,
*           ekorg TYPE ekorg,
*        END OF lt_ekorg.
*
** Check for the purch.inforec which exists for this material/vendor
*  SELECT SINGLE infnr INTO lv_infnr
*      FROM eina WHERE matnr = r_wa_supercession-matnr
*                  AND lifnr = r_lifnr
*                  AND loekz <> c_x.
*
*  IF sy-subrc = 0.
*    REFRESH lt_ekorg.
*    SELECT ekorg
*       INTO CORRESPONDING FIELDS OF TABLE lt_ekorg
*       FROM eine WHERE infnr = lv_infnr.
*
*    SORT lt_ekorg BY ekorg.
*    DELETE ADJACENT DUPLICATES FROM lt_ekorg COMPARING ekorg.
*
*    LOOP AT lt_ekorg.
*      CLEAR gv_vkorg.
*      SELECT SINGLE vkorg INTO gv_vkorg
*         FROM yse_po_sorg_porg WHERE ekorg = lt_ekorg-ekorg.
*      IF sy-subrc = 0.
*        SELECT SINGLE * FROM yse_popic_vkorg
*            WHERE zgsber = p_zgsber
*              AND vkorg = gv_vkorg
*              AND zccfam = p_ccfam
*              AND vtweg = '01'.
*        IF NOT sy-subrc = 0.
*          DELETE lt_ekorg.
*        ENDIF.
*      ENDIF.
*    ENDLOOP.
*
*    LOOP AT lt_ekorg.
*
*      LOOP AT gt_sorg_porg WHERE ekorg = lt_ekorg-ekorg.
*        MOVE-CORRESPONDING r_wa_supercession TO r_gt_matentered.
*        r_gt_matentered-vkorg = gt_sorg_porg-vkorg.
*        r_gt_matentered-vtweg = '01'.
*        APPEND r_gt_matentered.
*        CLEAR r_gt_matentered.
*      ENDLOOP.
*
*    ENDLOOP.
*  ENDIF.
*
*ENDFORM.                    " get_salorg_to_update
* end of deletion MOD-004

*&---------------------------------------------------------------------*
*&      Form  y_update_mat_determ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_WA_MATENTERED   text
*      -->P_WA_IDOC_STATUS  text
*----------------------------------------------------------------------*
FORM y_update_mat_determ  USING    p_wa_matentered
                                           STRUCTURE gt_matentered
                          CHANGING p_wa_idoc_status
                                           STRUCTURE bdidocstat.

  DATA: struct_bdcdata  TYPE bdcdata.              "BDCDATA table
  DATA: i_bdcdata  TYPE STANDARD TABLE OF bdcdata. "Table for BDC data
  DATA: l_date TYPE d.                             " Date in User Format

  CLEAR: p_wa_idoc_status,
         gt_messtab.
  REFRESH gt_messtab.
* Initial screen
  IF exhaust = 'X'.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMV13D'  '0100'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'D000-KSCHL'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'D000-KSCHL'  c_z002
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '/00'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

* Select key screen
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPLV14A'  '0100'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'RV130-SELKZ(01)'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '=WEIT'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

* Fast entry screen
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMV13D'  '1002'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'KONDD-SMATN(01)'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KOMGD-VKORG'  p_wa_matentered-vkorg
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KOMGD-VTWEG'  p_wa_matentered-vtweg
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    WRITE sy-datum TO l_date.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'D000-DATAB'  l_date
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'MV13D-SUGRV'  c_z001
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'KOMGD-MATWA(01)'  p_wa_matentered-matnr
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'KONDD-SMATN(01)' p_wa_matentered-matnr
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '/00'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
* now select line 1
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMV13D'  '1002'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'KONDD-SMATN(01)'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'RV130-SELKZ(01)'  c_x
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '=DETA'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.
* add line 2 + save
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMV13D'  '0200'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'KONDDP-SMATN(02)'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'KONDDP-SMATN(02)' p_wa_matentered-nfmat
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '=SICH'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

  ELSE.
* exhaust = ' '
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMV13D'  '0100'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'D000-KSCHL'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'D000-KSCHL'  c_z002
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '/00'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

* Select key screen
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPLV14A'  '0100'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'RV130-SELKZ(01)'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '=WEIT'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

* Fast entry screen
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMV13D'  '1002'  'X'  ''  ''
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_CURSOR'  'KONDD-SMATN(01)'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KOMGD-VKORG'  p_wa_matentered-vkorg
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KOMGD-VTWEG'  p_wa_matentered-vtweg
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    WRITE sy-datum TO l_date.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'D000-DATAB'  l_date
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'MV13D-SUGRV'  c_z002
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'KOMGD-MATWA(01)'  p_wa_matentered-matnr
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*          USING    ''  ''  ''  'KONDD-SMATN(01)'  p_wa_matentered-nfmat
           USING    ''  ''  ''  'KONDD-SMATN(01)' p_wa_matentered-nfmat
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BDC_OKCODE'  '=SICH'
            CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

  ENDIF.

  IF NOT i_bdcdata[] IS INITIAL.

*.. Perform Call Transaction to update the customer
    CALL TRANSACTION 'VB11' USING i_bdcdata
                    MODE gv_mode UPDATE 'S' MESSAGES INTO gt_messtab.

    IF sy-subrc NE 0 .
*.... Process error - Transaction VB11 Failed !!!
*      p_wa_idoc_status-status = '51'.
*      p_wa_idoc_status-MSGTY  = 'E' .
*      p_wa_idoc_status-MSGID  = 'YSE_INTERFACES'.
*      p_wa_idoc_status-MSGNO  = '014'.
      LOOP AT gt_messtab.
        IF gt_messtab-msgty = c_type_a OR
           gt_messtab-msgty = c_type_e .
          CLEAR wa_idoc_status.
          SELECT SINGLE text FROM t100 INTO g_text
                                WHERE sprsl = c_en
                                  AND arbgb = gt_messtab-msgid
                                  AND msgnr = gt_messtab-msgno.
          IF sy-subrc = 0.
            g_mstring = g_text.
            IF g_mstring CS '&1'.
              REPLACE '&1' WITH gt_messtab-msgv1 INTO g_mstring.
              REPLACE '&2' WITH gt_messtab-msgv2 INTO g_mstring.
              REPLACE '&3' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&4' WITH gt_messtab-msgv4 INTO g_mstring.
            ELSE.
              REPLACE '&' WITH gt_messtab-msgv1 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv2 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&' WITH gt_messtab-msgv4 INTO g_mstring.
            ENDIF.
            CONDENSE g_mstring.
          ENDIF.

          EXIT.
        ENDIF .
      ENDLOOP.
    ENDIF .

  ENDIF .

  CLEAR   i_bdcdata.
  REFRESH i_bdcdata.

  IF NOT g_mstring IS INITIAL .
    wa_idoc-error = g_mstring.
    MODIFY yse_popic_super FROM wa_idoc.
  ENDIF.

* also for Distribution channel 11
  CLEAR: p_wa_idoc_status,
           gt_messtab.
  REFRESH gt_messtab.
* Initial screen
  IF p_wa_matentered-vtweg <> '11'.
    IF exhaust = 'X' .

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPMV13D'  '0100'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'D000-KSCHL'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'D000-KSCHL'  c_z002
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '/00'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* Select key screen
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPLV14A'  '0100'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'RV130-SELKZ(01)'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=WEIT'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* Fast entry screen
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPMV13D'  '1002'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'KONDD-SMATN(01)'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'KOMGD-VKORG'  p_wa_matentered-vkorg
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'KOMGD-VTWEG'  '11'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      WRITE sy-datum TO l_date.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'D000-DATAB'  l_date
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'MV13D-SUGRV'  c_z001
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KOMGD-MATWA(01)'  p_wa_matentered-matnr
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'KONDD-SMATN(01)' p_wa_matentered-matnr
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '/00'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
* now select line 1
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPMV13D'  '1002'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'KONDD-SMATN(01)'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'RV130-SELKZ(01)'  c_x
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=DETA'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
* add line 2 + save
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPMV13D'  '0200'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'KONDDP-SMATN(02)'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KONDDP-SMATN(02)' p_wa_matentered-nfmat
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=SICH'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

    ELSE.
* exhaust = ' '
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPMV13D'  '0100'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'D000-KSCHL'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'D000-KSCHL'  c_z002
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '/00'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* Select key screen
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPLV14A'  '0100'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'RV130-SELKZ(01)'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=WEIT'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* Fast entry screen
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPMV13D'  '1002'  'X'  ''  ''
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'KONDD-SMATN(01)'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'KOMGD-VKORG'  p_wa_matentered-vkorg
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'KOMGD-VTWEG'  '11'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      WRITE sy-datum TO l_date.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'D000-DATAB'  l_date
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'MV13D-SUGRV'  c_z002
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'KOMGD-MATWA(01)'  p_wa_matentered-matnr
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*          USING    ''  ''  ''  'KONDD-SMATN(01)'  p_wa_matentered-nfmat
             USING    ''  ''  ''  'KONDD-SMATN(01)' p_wa_matentered-nfmat
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=SICH'
              CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

    ENDIF.
  ENDIF.

  IF NOT i_bdcdata[] IS INITIAL.

*.. Perform Call Transaction to update the customer
    CALL TRANSACTION 'VB11' USING i_bdcdata
                    MODE gv_mode UPDATE 'S' MESSAGES INTO gt_messtab.

    IF sy-subrc NE 0 .
*.... Process error - Transaction VB11 Failed !!!
*      p_wa_idoc_status-status = '51'.
*      p_wa_idoc_status-MSGTY  = 'E' .
*      p_wa_idoc_status-MSGID  = 'YSE_INTERFACES'.
*      p_wa_idoc_status-MSGNO  = '014'.
      LOOP AT gt_messtab.
        IF gt_messtab-msgty = c_type_a OR
           gt_messtab-msgty = c_type_e .
          CLEAR wa_idoc_status.
          SELECT SINGLE text FROM t100 INTO g_text
                                WHERE sprsl = c_en
                                  AND arbgb = gt_messtab-msgid
                                  AND msgnr = gt_messtab-msgno.
          IF sy-subrc = 0.
            g_mstring = g_text.
            IF g_mstring CS '&1'.
              REPLACE '&1' WITH gt_messtab-msgv1 INTO g_mstring.
              REPLACE '&2' WITH gt_messtab-msgv2 INTO g_mstring.
              REPLACE '&3' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&4' WITH gt_messtab-msgv4 INTO g_mstring.
            ELSE.
              REPLACE '&' WITH gt_messtab-msgv1 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv2 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&' WITH gt_messtab-msgv4 INTO g_mstring.
            ENDIF.
            CONDENSE g_mstring.
          ENDIF.

          EXIT.
        ENDIF .
      ENDLOOP.
    ENDIF .

  ENDIF .
  CLEAR   i_bdcdata.
  REFRESH i_bdcdata.

  IF NOT g_mstring IS INITIAL .
    wa_idoc-error = g_mstring.
    MODIFY yse_popic_super FROM wa_idoc.
  ENDIF.

ENDFORM.                    " y_update_mat_dete
*&---------------------------------------------------------------------*
*&      Module  INIT_9002  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE init_9002 OUTPUT.

  REFRESH it_dd07v.
  CLEAR it_dd07v.
* possible customer centre fam code
  l_name = 'ZCCFAM'.
  CALL FUNCTION 'DDIF_DOMA_GET'
    EXPORTING
      name          = l_name
      langu         = sy-langu
    TABLES
      dd07v_tab     = it_dd07v
    EXCEPTIONS
      illegal_input = 1
      OTHERS        = 2.
  REFRESH it_zccfam.
  LOOP AT it_dd07v.
    MOVE-CORRESPONDING it_dd07v TO it_zccfam.
    APPEND it_zccfam.
    CLEAR it_zccfam.
  ENDLOOP.

* possible business areas
  REFRESH it_dd07v.
  CLEAR it_dd07v.
  l_name = 'ZGSBER'.
  CALL FUNCTION 'DDIF_DOMA_GET'
    EXPORTING
      name          = l_name
      langu         = sy-langu
    TABLES
      dd07v_tab     = it_dd07v
    EXCEPTIONS
      illegal_input = 1
      OTHERS        = 2.
  REFRESH it_zgsber.
  LOOP AT it_dd07v.
    MOVE-CORRESPONDING it_dd07v TO it_zgsber.
    APPEND it_zgsber.
    CLEAR it_zgsber.
  ENDLOOP.

ENDMODULE.                 " INIT_9002  OUTPUT

*----------------------------------------------------------------------*
*  MODULE INIT_9001 OUTPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE init_9001 OUTPUT.

  REFRESH it_dd07v.
  CLEAR it_dd07v.
* possible distribution centre fam code
  l_name = 'ZDCFAM'.
  CALL FUNCTION 'DDIF_DOMA_GET'
    EXPORTING
      name          = l_name
      langu         = sy-langu
    TABLES
      dd07v_tab     = it_dd07v
    EXCEPTIONS
      illegal_input = 1
      OTHERS        = 2.
  REFRESH it_zdcfam.
  LOOP AT it_dd07v.
    MOVE-CORRESPONDING it_dd07v TO it_zdcfam.
    APPEND it_zdcfam.
    CLEAR it_zdcfam.
  ENDLOOP.

  REFRESH it_dd07v.
  CLEAR it_dd07v.
* possible customer centre fam code
  l_name = 'ZCCFAM'.
  CALL FUNCTION 'DDIF_DOMA_GET'
    EXPORTING
      name          = l_name
      langu         = sy-langu
    TABLES
      dd07v_tab     = it_dd07v
    EXCEPTIONS
      illegal_input = 1
      OTHERS        = 2.
  REFRESH it_zccfam.
  LOOP AT it_dd07v.
    MOVE-CORRESPONDING it_dd07v TO it_zccfam.
    APPEND it_zccfam.
    CLEAR it_zccfam.
  ENDLOOP.


ENDMODULE.                    "INIT_9001 OUTPUT
*----------------------------------------------------------------------*
*  MODULE CHECK_9001 INPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE check_9001 INPUT.

  IF ( okcode_9001 <> 'BACK' AND okcode_9001 <> 'EXIT' AND
      okcode_9001 <> 'CANCEL' ).

    IF NOT p_dcfam IS INITIAL.
* dcfam code
      gv_found = 'N'.
      LOOP AT it_zdcfam.
        IF it_zdcfam-domvalue_l = p_dcfam.
          gv_found = 'Y'.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF gv_found = 'N'.
        MESSAGE s001(00) WITH text-e12.
      ENDIF.
    ELSE.
      IF NOT p_ccfam IS INITIAL.
* ccfam code
        gv_found = 'N'.
        LOOP AT it_zccfam.
          IF it_zccfam-domvalue_l = p_ccfam.
            gv_found = 'Y'.
            EXIT.
          ENDIF.
        ENDLOOP.
        IF gv_found = 'N'.
          MESSAGE s001(00) WITH text-e11.
        ENDIF.

      ENDIF.
    ENDIF.
  ENDIF.
ENDMODULE.                    "CHECK_9001 INPUT
*&---------------------------------------------------------------------*
*&      Module  SET_STATUS_9004  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE set_status_9004 OUTPUT.

  CLEAR : okcode_9004.
  SET PF-STATUS '9004'.
  SET TITLEBAR '9004'.

ENDMODULE.                 " SET_STATUS_9004  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  EXIT_COMMAND_9004  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_command_9004 INPUT.

  CASE okcode_9004.
    WHEN 'BACK'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'EXIT'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'CANCEL'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " EXIT_COMMAND_9004  INPUT
*&---------------------------------------------------------------------*
*&      Module  CHECK_9004  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE check_9004 INPUT.

  IF ( okcode_9004 <> 'BACK' AND okcode_9004 <> 'EXIT' AND
       okcode_9004 <> 'CANCEL' ).
    IF p_zgsber IS INITIAL.
      MESSAGE s001(00) WITH text-e13.
      SET SCREEN '9004'.
      LEAVE SCREEN.
    ELSE.
* business area
      gv_found = 'N'.
      LOOP AT it_zgsber.
        IF it_zgsber-domvalue_l = p_zgsber.
          gv_found = 'Y'.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF gv_found = 'N'.
        MESSAGE s001(00) WITH text-e10.
        SET SCREEN '9004'.
        LEAVE SCREEN.
      ENDIF.
    ENDIF.
*datum

    IF mara-ersda IS INITIAL.
      MESSAGE s001(00) WITH text-e14.
      SET SCREEN '9004'.
      LEAVE SCREEN.
    ENDIF.
  ENDIF.

ENDMODULE.                 " CHECK_9004  INPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9004  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9004 INPUT.

  CASE okcode_9004.
    WHEN 'BACK'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'EXIT'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'CANCEL'.
      SET SCREEN '9000'.
      LEAVE SCREEN.
    WHEN 'EXEC'.
      PERFORM deletions.
    WHEN OTHERS.
      SET SCREEN 9004.
      LEAVE SCREEN.
  ENDCASE.

ENDMODULE.                 " USER_COMMAND_9004  INPUT
*----------------------------------------------------------------------*
*  MODULE init_9004 OUTPUT
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
MODULE init_9004 OUTPUT.

  GET PARAMETER ID 'YSE_CCFAM' FIELD p_ccfam.

* possible business areas
  REFRESH it_dd07v.
  CLEAR it_dd07v.
  l_name = 'ZGSBER'.
  CALL FUNCTION 'DDIF_DOMA_GET'
    EXPORTING
      name          = l_name
      langu         = sy-langu
    TABLES
      dd07v_tab     = it_dd07v
    EXCEPTIONS
      illegal_input = 1
      OTHERS        = 2.
  REFRESH it_zgsber.
  LOOP AT it_dd07v.
    MOVE-CORRESPONDING it_dd07v TO it_zgsber.
    APPEND it_zgsber.
    CLEAR it_zgsber.
  ENDLOOP.

ENDMODULE.                    "init_9004 OUTPUT
*&---------------------------------------------------------------------*
*&      Form  deletions
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM deletions.
* records in yse_popic_super
  IF sup = c_x.
    CLEAR g_recs.
    SELECT COUNT(*) INTO g_recs
      FROM yse_popic_super WHERE zccfam = p_ccfam
                             AND erdat  < mara-ersda
* Begin of insert MOD-002
                             AND  matnr  IN s_matnr
* End of insert MOD-002
                             AND coflag = c_x.
    IF NOT g_recs IS INITIAL.
      CALL FUNCTION 'POPUP_TO_CONFIRM'
        EXPORTING
          titlebar              = text-p01
          text_question         = text-p02
          icon_button_1         = 'ICON_OKAY'
          icon_button_2         = 'ICON_CANCEL'
          default_button        = '2'
          display_cancel_button = space
        IMPORTING
          answer                = gv_answer
        EXCEPTIONS
          text_not_found        = 1
          OTHERS                = 2.
      IF sy-subrc <> 0.
        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ENDIF.
      IF gv_answer = 1.
        DELETE FROM yse_popic_super WHERE zccfam = p_ccfam
                                      AND erdat  < mara-ersda
* Begin of insert MOD-002
                                      AND  matnr  IN s_matnr
* End of insert MOD-002
                                      AND coflag = c_x.
        COMMIT WORK.
        MESSAGE s001(00) WITH text-i04 g_recs.
      ENDIF.
    ELSE.
      MESSAGE s001(00) WITH text-i06.
    ENDIF.
  ENDIF.
* records in yse_popic_tbp
  IF tbp = c_x.
* Begin of Insert MOD-002
    DATA: spfli_wa TYPE spfli,
        r_matnr TYPE RANGE OF mara-matnr,
        r_matnr_line LIKE LINE OF r_matnr.

    r_matnr_line-sign   = s_matnr-sign.
    r_matnr_line-option = s_matnr-option.

    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
      EXPORTING
        input  = s_matnr-low
      IMPORTING
        output = s_matnr-low.
    r_matnr_line-low    = s_matnr-low.

    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
      EXPORTING
        input  = s_matnr-high
      IMPORTING
        output = s_matnr-high.
    r_matnr_line-high   = s_matnr-high.

    APPEND r_matnr_line TO r_matnr.

* End of Insert MOD-002

    CLEAR g_recs.
    SELECT COUNT(*) INTO g_recs
      FROM yse_popic_tbp WHERE zccfam = p_ccfam
                           AND zgsber = p_zgsber
                           AND erdat  < mara-ersda
* Begin of insert MOD-002
                           AND  matnr_popic  IN r_matnr.
* End of insert MOD-002
    IF NOT g_recs IS INITIAL.
      CALL FUNCTION 'POPUP_TO_CONFIRM'
        EXPORTING
          titlebar              = text-p03
          text_question         = text-p04
          icon_button_1         = 'ICON_OKAY'
          icon_button_2         = 'ICON_CANCEL'
          default_button        = '2'
          display_cancel_button = space
        IMPORTING
          answer                = gv_answer
        EXCEPTIONS
          text_not_found        = 1
          OTHERS                = 2.
      IF sy-subrc <> 0.
        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ENDIF.
      IF gv_answer = 1.
        DELETE FROM yse_popic_tbp WHERE zccfam = p_ccfam
                                    AND zgsber = p_zgsber
                                    AND erdat  < mara-ersda
* Begin of insert MOD-002
                                    AND matnr_popic IN r_matnr.
* End of insert MOD-002
        COMMIT WORK.
        MESSAGE s001(00) WITH text-i05 g_recs.
      ENDIF.
    ELSE.
      MESSAGE s001(00) WITH text-i06.
    ENDIF.
  ENDIF.

ENDFORM.                    "deletions
*&---------------------------------------------------------------------*
*&      Form  MAT_A_ALREADY-SUPER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM mat_a_already_super .

  gv_matasuper = 'N'.
  REFRESH gt_werks.
  CLEAR gt_werks.
  SELECT werks INTO CORRESPONDING FIELDS OF TABLE gt_werks
    FROM yse_popic_werks WHERE zccfam = p_ccfam
                           AND zgsber = p_zgsber.

  LOOP AT gt_werks.
    CLEAR gv_mmsta.
    SELECT SINGLE mmsta nfmat INTO (gv_mmsta, gv_matnr) FROM marc
       WHERE matnr = marc-matnr
         AND werks = gt_werks-werks.
*    IF gv_mmsta = 'A1' AND gv_matnr <> marc-nfmat.
    IF gv_mmsta = 'A1' AND gv_matnr <> ' '.
      gv_matasuper = 'Y'.
      LEAVE.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " MAT_A_ALREADY-SUPER

*Text symbol text
*001:Selection Screen Input
*002:Inputfile
*E01:At least one selection must be filled in.
*E02:Fill in material number or inputfile.
*E03:Open dataset failed for :
*E04:Both famcodes have to be filled in.
*E05:Both famcodes cannot be the same.
*E06:Material cannot be replaced by the same material
*E07:Material A is already a follow-up material.
*E08:Fill in material A
*E09:Fill in material B
*E10:Invalid business area
*E11:Invalid customer center FAM code
*E12:Invalid distribution center FAM code
*E13:Fill in business area please
*E14:Fill in date please
*E15:Create first material A in purchase org :
*E16:Create first material B in purchase org :
*E17:Combination bus. area - CC fam code doesn't exist
*E18:Material A is already superseeded by material :
*E19:No supersession possible for local material
*E20:Fill in vendor number please
*E21:Vendor number doesn't exist
*I01:Number of Idocs created :
*I02:Supersession done
*I03:No Idocs created
*I04:Number of records deleted from YSE_POPIC_SUPER :
*I05:Number of records deleted from YSE_POPIC_TBP :
*I06:No records found.
*P01:Delete records in YSE_POPIC_SUPER.
*P02:You are going to delete records in YSE_POPIC_SUPER. Are you sure?
*P03:Delete records in YSE_POPIC_TBP

*P04:You are going to delete records in YSE_POPIC_TBP. Are you sure?
*Selection text
*S_MATNR:D       .
