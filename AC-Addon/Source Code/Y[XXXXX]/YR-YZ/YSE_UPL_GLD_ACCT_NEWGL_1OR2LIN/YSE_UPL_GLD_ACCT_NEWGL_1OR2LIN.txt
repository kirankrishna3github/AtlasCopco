********************************************************************
* Program ID           : YSE_UPLOAD_GLD_ACCT_NEWGL_1OR2LIN         *
* Program Title        : Upload G/L Accounts - Batch Input         *
* Author               : Marc Jacobs                               *
* Date                 : 05/02/2009                                *
* Change Request Number: CR1155                                    *
* Description          : The purpose of this program is to upload  *
*                        the G/L accounts                          *
*                        + possibility of input in 1 or 2 records  *
*==================================================================*
*==================================================================*
* Change History Log                                               *
*------------------------------------------------------------------*
*Mod. no.|  Date    | Name           | Transport Nr  | Chg Ref. #  *
*------------------------------------------------------------------*

REPORT yse_upl_gld_acct_newgl_1or2lin.

*******************
* data definition *
*******************

TYPE-POOLS: abap.

TABLES : usr01.

CONSTANTS : c_type_a         TYPE bapiret2-type     VALUE 'A',
            c_type_e         TYPE bapiret2-type     VALUE 'E',
            c_en             TYPE spras             VALUE 'E'.

DATA : BEGIN OF i_data OCCURS 0,
          bldat LIKE bkpf-bldat,
          blart LIKE bkpf-blart,
          bukrs LIKE bkpf-bukrs,
          budat LIKE bkpf-budat,
          waers LIKE bkpf-waers,
          xblnr LIKE bkpf-xblnr,
          xref1_hd LIKE bkpf-xref1_hd,
          xref2_hd LIKE bkpf-xref2_hd,
          bktxt LIKE bkpf-bktxt,
          stgrd LIKE bkpf-stgrd,
          stodt LIKE bkpf-stodt,
          ldgrp TYPE fagl_ldgrp,
          newbs LIKE rf05a-newbs,
          newko LIKE rf05a-newko,
          xref1 LIKE bseg-xref1,
          xref2 LIKE bseg-xref2,
          newbw LIKE rf05a-newbw,
          wrbtr(16) TYPE c,
          dmbtr(16) TYPE c,
          mwskz LIKE bseg-mwskz,
          xmwst LIKE rf05a-xmwst,
          wmwst(16) TYPE c,
          zterm LIKE bseg-zterm,
          zfbdt LIKE bseg-zfbdt,
          zlspr LIKE bseg-zlspr,
          menge(7) TYPE c,
          zuonr LIKE bseg-zuonr,
          sgtxt LIKE bseg-sgtxt,
          zeile LIKE bseg-sgtxt,
          kkber LIKE bseg-kkber,
          kostl LIKE cobl-kostl,
          pernr LIKE cobl-pernr,
          prctr LIKE cobl-prctr,
          char1 TYPE char1,
          c_prctr LIKE ce01000-prctr,
          c_ww006 LIKE bbseg-rke_ww006,
          c_ww007 LIKE bbseg-rke_ww007,
          c_ww008 LIKE bbseg-rke_ww008,
          c_kndnr LIKE ce01000-kndnr,
          c_artnr LIKE ce01000-artnr,
          c_equnr LIKE ce01000-equnr,
          c_ww002 LIKE ce01000-ww002,
          c_spart LIKE ce01000-spart,
          c_vtweg LIKE ce01000-vtweg,
          c_ww009 LIKE ce01000-ww009,
          c_ktgrd LIKE ce01000-ktgrd,
 	        c_newum LIKE bbseg-newum,
          c_vbel2 LIKE bbseg-vbel2,
          c_posn2 LIKE bbseg-posn2,
          c_ww003 LIKE ce01000-ww003,
          c_matnr LIKE bbseg-matnr,
          c_werks LIKE bbseg-werks,
          c_kaufn LIKE bbseg-rke_kaufn,
          c_kdpos LIKE bbseg-rke_kdpos,
          segment TYPE fb_segment,
         j_3rf_kpp TYPE j_3rf_kpp,            "subdiv kpp
         j_3rf_104 TYPE j_3rf_104,            "budget code
         j_3rf_105 TYPE j_3rf_105,            "okato code
         j_3rf_106 TYPE j_3rf_106,            "payment reason
         j_3rf_107 TYPE j_3rf_107,            "tax period
         j_3rf_108 TYPE j_3rf_108,            "document no
         j_3rf_109 TYPE j_3rf_109,            "document date
         j_3rfblart_p TYPE j_3rfblart_p,      "payment type
      END OF i_data.

DATA : BEGIN OF i_header OCCURS 0,
          bldat LIKE bkpf-bldat,
          blart LIKE bkpf-blart,
          bukrs LIKE bkpf-bukrs,
          budat LIKE bkpf-budat,
          waers LIKE bkpf-waers,
          xblnr LIKE bkpf-xblnr,
          xref1_hd LIKE bkpf-xref1_hd,
          xref2_hd LIKE bkpf-xref2_hd,
          bktxt LIKE bkpf-bktxt,
          stgrd LIKE bkpf-stgrd,
          stodt LIKE bkpf-stodt,
          ldgrp TYPE fagl_ldgrp,
       END OF i_header.

DATA : BEGIN OF i_errors OCCURS 0,
         bktxt LIKE bkpf-bktxt,
         xblnr LIKE bkpf-xblnr,
         zuonr LIKE bseg-zuonr,
         message(100) TYPE c,
       END OF i_errors.

DATA: BEGIN OF gt_messtab OCCURS 0.
        INCLUDE STRUCTURE merrdat.
DATA: END   OF gt_messtab.

DATA: struct_bdcdata  TYPE bdcdata.
DATA: i_bdcdata  TYPE STANDARD TABLE OF bdcdata.
DATA: l_date TYPE d.

DATA :   g_text                LIKE t100-text,
         g_mstring(100)        TYPE c,
         lv_mode(1)            TYPE c VALUE 'A',
         lv_wrbtr(16)          TYPE c,
         lv_wrbtr_p            TYPE wrbtr,
         lv_wmwst(16)          TYPE c,
         lv_wmwst_p            TYPE wmwst,
         lv_newbs              LIKE rf05a-newbs,
         lv_taxvendor(1)       TYPE c.

DATA : BEGIN OF i_data1 OCCURS 0,
          bldat LIKE bkpf-bldat,
          blart LIKE bkpf-blart,
          bukrs LIKE bkpf-bukrs,
          budat LIKE bkpf-budat,
          waers LIKE bkpf-waers,
          xblnr LIKE bkpf-xblnr,
          xref1_hd LIKE bkpf-xref1_hd,
          xref2_hd LIKE bkpf-xref2_hd,
          bktxt LIKE bkpf-bktxt,
          stgrd LIKE bkpf-stgrd,
          stodt LIKE bkpf-stodt,
          ldgrp TYPE fagl_ldgrp,
          newbs LIKE rf05a-newbs,
          newko LIKE rf05a-newko,
          xref1 LIKE bseg-xref1,
          xref2 LIKE bseg-xref2,
          newbw LIKE rf05a-newbw,
          wrbtr(16) TYPE c,
          dmbtr(16) TYPE c,
          mwskz LIKE bseg-mwskz,
          xmwst LIKE rf05a-xmwst,
          wmwst(16) TYPE c,
          zterm LIKE bseg-zterm,
          zfbdt LIKE bseg-zfbdt,
          zlspr LIKE bseg-zlspr,
          menge(7) TYPE c,
          zuonr LIKE bseg-zuonr,
          sgtxt LIKE bseg-sgtxt,
          zeile LIKE bseg-sgtxt,
          kkber LIKE bseg-kkber,
          kostl LIKE cobl-kostl,
          pernr LIKE cobl-pernr,
          prctr LIKE cobl-prctr,
          char1 TYPE char1,
          c_prctr LIKE ce01000-prctr,
          c_ww006 LIKE bbseg-rke_ww006,
          c_ww007 LIKE bbseg-rke_ww007,
          c_ww008 LIKE bbseg-rke_ww008,
          c_kndnr LIKE ce01000-kndnr,
          c_artnr LIKE ce01000-artnr,
          c_equnr LIKE ce01000-equnr,
          c_ww002 LIKE ce01000-ww002,
          c_spart LIKE ce01000-spart,
          c_vtweg LIKE ce01000-vtweg,
          c_ww009 LIKE ce01000-ww009,
          c_ktgrd LIKE ce01000-ktgrd,
 	        c_newum LIKE bbseg-newum,
          c_vbel2 LIKE bbseg-vbel2,
          c_posn2 LIKE bbseg-posn2,
          c_ww003 LIKE ce01000-ww003,
          c_matnr LIKE bbseg-matnr,
          c_werks LIKE bbseg-werks,
          c_kaufn LIKE bbseg-rke_kaufn,
          c_kdpos LIKE bbseg-rke_kdpos,
          segment TYPE fb_segment,
          j_3rf_kpp TYPE j_3rf_kpp,            "subdiv kpp
          j_3rf_104 TYPE j_3rf_104,            "budget code
          j_3rf_105 TYPE j_3rf_105,            "okato code
          j_3rf_106 TYPE j_3rf_106,            "payment reason
          j_3rf_107 TYPE j_3rf_107,            "tax period
          j_3rf_108 TYPE j_3rf_108,            "document no
          j_3rf_109 TYPE j_3rf_109,            "document date
          j_3rfblart_p TYPE j_3rfblart_p,      "payment type
* part 2
          bldatb LIKE bkpf-bldat,
          blartb LIKE bkpf-blart,
          bukrsb LIKE bkpf-bukrs,
          budatb LIKE bkpf-budat,
          waersb LIKE bkpf-waers,
          xblnrb LIKE bkpf-xblnr,
          xref1_hdb LIKE bkpf-xref1_hd,
          xref2_hdb LIKE bkpf-xref2_hd,
          bktxtb LIKE bkpf-bktxt,
          stgrdb LIKE bkpf-stgrd,
          stodtb LIKE bkpf-stodt,
          ldgrpb TYPE fagl_ldgrp,
          newbsb LIKE rf05a-newbs,
          newkob LIKE rf05a-newko,
          xref1b LIKE bseg-xref1,
          xref2b LIKE bseg-xref2,
          newbwb LIKE rf05a-newbw,
          wrbtrb(16) TYPE c,
          dmbtrb(16) TYPE c,
          mwskzb LIKE bseg-mwskz,
          xmwstb LIKE rf05a-xmwst,
          wmwstb(16) TYPE c,
          ztermb LIKE bseg-zterm,
          zfbdtb LIKE bseg-zfbdt,
          zlsprb LIKE bseg-zlspr,
          mengeb(7) TYPE c,
          zuonrb LIKE bseg-zuonr,
          sgtxtb LIKE bseg-sgtxt,
          zeileb LIKE bseg-sgtxt,
          kkberb LIKE bseg-kkber,
          kostlb LIKE cobl-kostl,
          pernrb LIKE cobl-pernr,
          prctrb LIKE cobl-prctr,
          char1b TYPE char1,
          c_prctrb LIKE ce01000-prctr,
          c_ww006b LIKE bbseg-rke_ww006,
          c_ww007b LIKE bbseg-rke_ww007,
          c_ww008b LIKE bbseg-rke_ww008,
          c_kndnrb LIKE ce01000-kndnr,
          c_artnrb LIKE ce01000-artnr,
          c_equnrb LIKE ce01000-equnr,
          c_ww002b LIKE ce01000-ww002,
          c_spartb LIKE ce01000-spart,
          c_vtwegb LIKE ce01000-vtweg,
          c_ww009b LIKE ce01000-ww009,
          c_ktgrdb LIKE ce01000-ktgrd,
 	        c_newumb LIKE bbseg-newum,
          c_vbel2b LIKE bbseg-vbel2,
          c_posn2b LIKE bbseg-posn2,
          c_ww003b LIKE ce01000-ww003,
          c_matnrb LIKE bbseg-matnr,
          c_werksb LIKE bbseg-werks,
          c_kaufnb LIKE bbseg-rke_kaufn,
          c_kdposb LIKE bbseg-rke_kdpos,
          segmentb TYPE fb_segment,
          j_3rf_kppb TYPE j_3rf_kpp,            "subdiv kpp
          j_3rf_104b TYPE j_3rf_104,            "budget code
          j_3rf_105b TYPE j_3rf_105,            "okato code
          j_3rf_106b TYPE j_3rf_106,            "payment reason
          j_3rf_107b TYPE j_3rf_107,            "tax period
          j_3rf_108b TYPE j_3rf_108,            "document no
          j_3rf_109b TYPE j_3rf_109,            "document date
          j_3rfblart_pb TYPE j_3rfblart_p,      "payment type
      END OF i_data1.

**************
* Parameters *
**************

SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-009.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) text-001.
SELECTION-SCREEN POSITION 35.
PARAMETERS p_fname LIKE cffile-filename OBLIGATORY MEMORY ID gxd.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: p_one RADIOBUTTON GROUP inp.
SELECTION-SCREEN COMMENT 4(20) text-010.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: p_two RADIOBUTTON GROUP inp.
SELECTION-SCREEN COMMENT 4(20) text-011.
SELECTION-SCREEN END OF LINE.


PARAMETER : p_header TYPE c AS CHECKBOX DEFAULT 'X'.


SELECTION-SCREEN END OF BLOCK b2.

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: p_comma  LIKE kcd_doku_struc-decimal_sep
                                            RADIOBUTTON GROUP dec.
SELECTION-SCREEN COMMENT 4(30) text-003.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: p_point  LIKE kcd_doku_struc-decimal_sep
                                            RADIOBUTTON GROUP dec.
SELECTION-SCREEN COMMENT 4(35) text-004.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b1.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_fname.

  CALL FUNCTION 'WS_FILENAME_GET'
    EXPORTING
      def_filename     = p_fname
      def_path         = '\'
      mask             = ',*.*,*.csv;*.txt.'
      mode             = 'O'
      title            = text-005
    IMPORTING
      filename         = p_fname
    EXCEPTIONS
      inv_winsys       = 01
      no_batch         = 02
      selection_cancel = 03
      selection_error  = 04.

START-OF-SELECTION.

  PERFORM read_file.

  PERFORM process_data.

*&---------------------------------------------------------------------*
*&      Form  read_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM read_file.

  DATA : w_filename TYPE string.

  SELECT SINGLE * FROM usr01 WHERE bname = sy-uname.

  w_filename = p_fname.

  IF p_one = 'X'.

    CALL FUNCTION 'GUI_UPLOAD'
      EXPORTING
        filename                = w_filename
        filetype                = 'ASC'
        has_field_separator     = 'X'
      TABLES
        data_tab                = i_data1
      EXCEPTIONS
        file_open_error         = 1
        file_read_error         = 2
        no_batch                = 3
        gui_refuse_filetransfer = 4
        invalid_type            = 5
        no_authority            = 6
        unknown_error           = 7
        bad_data_format         = 8
        header_not_allowed      = 9
        separator_not_allowed   = 10
        header_too_long         = 11
        unknown_dp_error        = 12
        access_denied           = 13
        dp_out_of_memory        = 14
        disk_full               = 15
        dp_timeout              = 16
        OTHERS                  = 17.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

* Delete first row from file if user indicated that a header line is
* included
    IF p_header = 'X'.
      DELETE i_data1 INDEX 1.
    ENDIF.

    PERFORM copy_data.

  ELSE.

    CALL FUNCTION 'GUI_UPLOAD'
      EXPORTING
        filename                = w_filename
        filetype                = 'ASC'
        has_field_separator     = 'X'
      TABLES
        data_tab                = i_data
      EXCEPTIONS
        file_open_error         = 1
        file_read_error         = 2
        no_batch                = 3
        gui_refuse_filetransfer = 4
        invalid_type            = 5
        no_authority            = 6
        unknown_error           = 7
        bad_data_format         = 8
        header_not_allowed      = 9
        separator_not_allowed   = 10
        header_too_long         = 11
        unknown_dp_error        = 12
        access_denied           = 13
        dp_out_of_memory        = 14
        disk_full               = 15
        dp_timeout              = 16
        OTHERS                  = 17.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
* Delete first row from file if user indicated that a header line is
* included
    IF p_header = 'X'.
      DELETE i_data INDEX 1.
    ENDIF.
  ENDIF.

* Convert data if required
  IF p_point = 'X' AND usr01-dcpfm <> 'X'.
    PERFORM convert_into_comma.
  ELSEIF p_comma = 'X' AND usr01-dcpfm = 'X'.
    PERFORM convert_into_point.
  ENDIF.

  PERFORM change_date.

  i_header[] = i_data[].
  SORT i_header.
  DELETE ADJACENT DUPLICATES FROM i_header.

ENDFORM.                    " READ_FILE


*&---------------------------------------------------------------------*
*&      Form  CONVERT_INTO_COMMA
*&---------------------------------------------------------------------*
FORM convert_into_comma.

  LOOP AT i_data.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-wrbtr WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-wrbtr WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-wrbtr WITH ','.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-dmbtr WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-dmbtr WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-dmbtr WITH ','.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-menge WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-menge WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-menge WITH ','.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-wmwst WITH '/'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-wmwst WITH '.'.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-wmwst WITH ','.
    MODIFY i_data INDEX sy-tabix.
  ENDLOOP.

ENDFORM.                    " CONVERT_INTO_COMMA
*&---------------------------------------------------------------------*
*&      FORM  CONVERT_INTO_POINT
*&---------------------------------------------------------------------*
FORM convert_into_point.

  LOOP AT i_data.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-wrbtr WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-wrbtr WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-wrbtr WITH '.'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-dmbtr WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-dmbtr WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-dmbtr WITH '.'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-menge WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-menge WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-menge WITH '.'.
    REPLACE ALL OCCURRENCES OF ',' IN i_data-wmwst WITH '/'.
    REPLACE ALL OCCURRENCES OF '.' IN i_data-wmwst WITH ','.
    REPLACE ALL OCCURRENCES OF '/' IN i_data-wmwst WITH '.'.
    MODIFY i_data INDEX sy-tabix.
  ENDLOOP.

ENDFORM.                    " CONVERT_INTO_POINT

*&---------------------------------------------------------------------*
*&      Form  CHANGE_DATE
*&---------------------------------------------------------------------*
FORM change_date.

  DATA : wl_date(8) TYPE c.

  LOOP AT i_data.

    CASE usr01-datfm.
      WHEN '1'.

        wl_date = i_data-bldat.
        i_data-bldat+0(2) = wl_date+6(2).
        i_data-bldat+2(2) = wl_date+4(2).
        i_data-bldat+4(4) = wl_date+0(4).

        wl_date = i_data-budat.
        i_data-budat+0(2) = wl_date+6(2).
        i_data-budat+2(2) = wl_date+4(2).
        i_data-budat+4(4) = wl_date+0(4).

        wl_date = i_data-stodt.
        i_data-stodt+0(2) = wl_date+6(2).
        i_data-stodt+2(2) = wl_date+4(2).
        i_data-stodt+4(4) = wl_date+0(4).

        wl_date = i_data-zfbdt.
        i_data-zfbdt+0(2) = wl_date+6(2).
        i_data-zfbdt+2(2) = wl_date+4(2).
        i_data-zfbdt+4(4) = wl_date+0(4).

      WHEN '2' OR '3'.
        wl_date = i_data-bldat.
        i_data-bldat+0(2) = wl_date+4(2).
        i_data-bldat+2(2) = wl_date+6(2).
        i_data-bldat+4(4) = wl_date+0(4).

        wl_date = i_data-budat.
        i_data-budat+0(2) = wl_date+4(2).
        i_data-budat+2(2) = wl_date+6(2).
        i_data-budat+4(4) = wl_date+0(4).

        wl_date = i_data-stodt.
        i_data-stodt+0(2) = wl_date+4(2).
        i_data-stodt+2(2) = wl_date+6(2).
        i_data-stodt+4(4) = wl_date+0(4).

        wl_date = i_data-zfbdt.
        i_data-zfbdt+0(2) = wl_date+4(2).
        i_data-zfbdt+2(2) = wl_date+6(2).
        i_data-zfbdt+4(4) = wl_date+0(4).

    ENDCASE.
    MODIFY i_data TRANSPORTING bldat budat stodt zfbdt.
  ENDLOOP.

ENDFORM.                    " CHANGE_DATE


*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM process_data .

  CLEAR:   gt_messtab[], i_bdcdata[].

  LOOP AT i_header.

    CLEAR : lv_taxvendor .

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
       USING    'SAPMF05A'  '0100'  'X'  ''  ''
       CHANGING struct_bdcdata.
    APPEND struct_bdcdata  TO i_bdcdata.
    CLEAR  struct_bdcdata.

    IF NOT i_header-bldat IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-BLDAT'  i_header-bldat
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-blart IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-BLART'  i_header-blart
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-bukrs IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-BUKRS'  i_header-bukrs
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-budat IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-BUDAT'  i_header-budat
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  ''  ''  'BKPF-MONAT'  i_header-budat+2(2)
     CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-waers IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-WAERS'  i_header-waers
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-xblnr IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
     USING    ''  ''  ''  'BKPF-XBLNR'  i_header-xblnr
     CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-bktxt IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-BKTXT'  i_header-bktxt
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-xref1_hd IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-XREF1_HD'  i_header-xref1_hd
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-xref2_hd IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-XREF2_HD'  i_header-xref2_hd
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-stodt IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-STODT'  i_header-stodt
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-stgrd IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-STGRD'  i_header-stgrd
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.

    IF NOT i_header-ldgrp IS INITIAL.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BKPF-LDGRP'  i_header-ldgrp
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
    ENDIF.
* first line
    LOOP AT i_data
         WHERE bldat = i_header-bldat
           AND blart = i_header-blart
           AND bukrs = i_header-bukrs
           AND budat = i_header-budat
           AND waers = i_header-waers
           AND xblnr = i_header-xblnr
           AND xref1_hd = i_header-xref1_hd
           AND xref2_hd = i_header-xref2_hd
           AND bktxt = i_header-bktxt
           AND stgrd = i_header-stgrd
           AND stodt = i_header-stodt
           AND ldgrp = i_header-ldgrp.

      IF NOT i_data-newbs IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RF05A-NEWBS'  i_data-newbs
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-newko IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RF05A-NEWKO'  i_data-newko
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM read_lifnr  USING i_data-bukrs CHANGING i_data-newko lv_taxvendor.

      IF NOT i_data-c_newum IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RF05A-NEWUM'  i_data-c_newum
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-newbw IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RF05A-NEWBW'  i_data-newbw
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '/00'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* extra screen with tax date for MRUA
      IF i_header-bukrs = 'MRUA' AND  i_header-budat gt i_header-bldat.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLSPO4'  '0300'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'SVALD-VALUE(01)'  '!'
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=FURT'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.
* what screen
      CASE i_data-newbs.
        WHEN '19'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0304'  'X'  ''  ''
               CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '29'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0304'  'X'  ''  ''
               CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '31'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0302'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN OTHERS.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMF05A'  '0300'  'X'  ''  ''
            CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
      ENDCASE.

      IF NOT i_data-wrbtr IS INITIAL.
        REPLACE ',' IN i_data-wrbtr WITH '.'.
        MOVE i_data-wrbtr TO lv_wrbtr_p.
        WRITE lv_wrbtr_p TO lv_wrbtr.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-mwskz IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-MWSKZ' i_data-mwskz
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-xmwst IS INITIAL.
        CASE i_data-newbs.
          WHEN '19'.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-XMWST' i_data-xmwst
               CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
          WHEN '29'.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-XMWST' i_data-xmwst
               CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
          WHEN '31'.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BKPF-XMWST' i_data-xmwst
               CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
          WHEN OTHERS.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BKPF-XMWST' i_data-xmwst
              CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
        ENDCASE.

      ENDIF.

      IF NOT i_data-wmwst IS INITIAL.
        MOVE i_data-wmwst TO lv_wmwst.
        REPLACE ',' IN lv_wmwst WITH '.'.
        MOVE i_data-wmwst TO lv_wmwst_p.
        WRITE lv_wmwst_p TO lv_wmwst.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-WMWST'  lv_wmwst
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-zfbdt IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-ZFBDT'  i_data-zfbdt
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-zlspr IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-ZLSPR'  i_data-zlspr
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-prctr IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-PRCTR'  i_data-prctr
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.
      IF NOT i_data-sgtxt IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BSEG-SGTXT'  i_data-sgtxt
              CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* coding block popup
      IF NOT i_data-segment IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLKACB'  '0002'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        IF NOT i_data-segment IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-SEGMENT'  i_data-segment
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '/00'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      CASE i_data-newbs.
        WHEN '19'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0331'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '29'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '31'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN OTHERS.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0330'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
      ENDCASE.

      IF NOT i_data-xref1 IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-XREF1'  i_data-xref1
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-xref2 IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-XREF2'  i_data-xref2
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '/00'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

      CASE i_data-newbs.
        WHEN '19'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0331'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '29'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '31'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN OTHERS.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0330'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
      ENDCASE.

      IF NOT i_data-zeile IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=LTXT'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLFTXT'  '0110'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'EENO_DYNP-ZEILE(01)'  i_data-zeile
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=ACCPT'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ELSE.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '/00'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      lv_newbs = i_data-newbs.
      DELETE i_data.
      EXIT.
    ENDLOOP.

    CASE lv_newbs.
      WHEN '19'.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0331'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      WHEN '29'.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0332'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      WHEN '31'.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0332'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      WHEN OTHERS.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPMF05A'  '0330'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
    ENDCASE.

* second line
    LOOP AT i_data
         WHERE bldat = i_header-bldat
           AND blart = i_header-blart
           AND bukrs = i_header-bukrs
           AND budat = i_header-budat
           AND waers = i_header-waers
           AND xblnr = i_header-xblnr
           AND xref1_hd = i_header-xref1_hd
           AND xref2_hd = i_header-xref2_hd
           AND bktxt = i_header-bktxt
           AND stgrd = i_header-stgrd
           AND stodt = i_header-stodt
           AND ldgrp = i_header-ldgrp.

      IF NOT i_data-newbs IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'RF05A-NEWBS'  i_data-newbs
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-newko IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'RF05A-NEWKO'  i_data-newko
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF lv_taxvendor IS INITIAL.
        PERFORM read_lifnr  USING i_data-bukrs CHANGING i_data-newko lv_taxvendor.
      ENDIF.

      IF NOT i_data-c_newum IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RF05A-NEWUM'  i_data-c_newum
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-newbw IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
          USING    ''  ''  ''  'RF05A-NEWBW'  i_data-newbw
          CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '/00'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.
* what screen
      CASE i_data-newbs.
        WHEN '29'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMF05A'  '0304'  'X'  ''  ''
               CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '31'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0302'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN OTHERS.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    'SAPMF05A'  '0300'  'X'  ''  ''
            CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
      ENDCASE.

      IF NOT i_data-wrbtr IS INITIAL.
        REPLACE ',' IN i_data-wrbtr WITH '.'.
        MOVE i_data-wrbtr TO lv_wrbtr_p.
        WRITE lv_wrbtr_p TO lv_wrbtr.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-WRBTR'  lv_wrbtr
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-mwskz IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
            USING    ''  ''  ''  'BSEG-MWSKZ'  i_data-mwskz
            CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-xmwst IS INITIAL.
        CASE i_data-newbs.
          WHEN '29'.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RF05A-XMWST' i_data-xmwst
               CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
          WHEN '31'.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BKPF-XMWST' i_data-xmwst
               CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
          WHEN OTHERS.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BKPF-XMWST' i_data-xmwst
              CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
        ENDCASE.
      ENDIF.

      IF NOT i_data-sgtxt IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-SGTXT'  i_data-sgtxt
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '=ZK'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* coding block popup
      IF NOT i_data-segment IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLKACB'  '0002'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        IF NOT i_data-segment IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'COBL-SEGMENT'  i_data-segment
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '/00'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      CASE i_data-newbs.
        WHEN '29'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '31'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN OTHERS.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0330'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
      ENDCASE.


      IF NOT i_data-xref1 IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-XREF1'  i_data-xref1
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      IF NOT i_data-xref2 IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BSEG-XREF2'  i_data-xref2
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '/00'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* extra text
      IF NOT i_data-zeile IS INITIAL.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=LTXT'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPLFTXT'  '0110'  'X'  ''  ''
             CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'EENO_DYNP-ZEILE(01)'  i_data-zeile
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=ACCPT'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
      ENDIF.

* save
      CASE i_data-newbs.
        WHEN '29'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN '31'.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0332'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        WHEN OTHERS.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    'SAPMF05A'  '0330'  'X'  ''  ''
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
      ENDCASE.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
         USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
         CHANGING struct_bdcdata.
      APPEND struct_bdcdata  TO i_bdcdata.
      CLEAR  struct_bdcdata.

* tax popup
* tax vendor ?

      IF NOT lv_taxvendor IS INITIAL.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLYSE_J3RF_PDOC'  '0100'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        IF NOT i_data-j_3rf_kpp IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_KPP'  i_data-j_3rf_kpp
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rf_104 IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_104'  i_data-j_3rf_104
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rf_105 IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_105'  i_data-j_3rf_105
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rf_106 IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_106'  i_data-j_3rf_106
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rf_107 IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_107'  i_data-j_3rf_107
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rf_108 IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_108'  i_data-j_3rf_108
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rf_109 IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_109'  i_data-j_3rf_109
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        IF NOT i_data-j_3rfblart_p IS INITIAL.
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
             USING    ''  ''  ''  'J_3RF_PLAT-J_3RF_110'  i_data-j_3rfblart_p
             CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
        ENDIF.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=MSEL'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
* ok
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    'SAPLSPO1'  '0500'  'X'  ''  ''
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
           USING    ''  ''  ''  'BDC_OKCODE'  '=OPT1'
           CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

      ENDIF.

      DELETE i_data.
      EXIT.
    ENDLOOP.

  ENDLOOP.












  IF NOT i_bdcdata[] IS INITIAL.

*.. Perform Call Transaction to update the customer
    CALL TRANSACTION 'FB01' USING i_bdcdata
           MODE  lv_mode UPDATE 'S' MESSAGES INTO gt_messtab.

    IF sy-subrc NE 0 .
      LOOP AT gt_messtab.
        IF gt_messtab-msgty = c_type_a OR
           gt_messtab-msgty = c_type_e .
          SELECT SINGLE text FROM t100 INTO g_text
                                WHERE sprsl = c_en
                                  AND arbgb = gt_messtab-msgid
                                  AND msgnr = gt_messtab-msgno.
          IF sy-subrc = 0.
            g_mstring = g_text.
            IF g_mstring CS '&1'.
              REPLACE '&1' WITH gt_messtab-msgv1 INTO g_mstring.
              REPLACE '&2' WITH gt_messtab-msgv2 INTO g_mstring.
              REPLACE '&3' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&4' WITH gt_messtab-msgv4 INTO g_mstring.
            ELSE.
              REPLACE '&' WITH gt_messtab-msgv1 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv2 INTO g_mstring.
              CONDENSE g_mstring.
              REPLACE '&' WITH gt_messtab-msgv3 INTO g_mstring.
              REPLACE '&' WITH gt_messtab-msgv4 INTO g_mstring.
            ENDIF.
            CONDENSE g_mstring.
          ENDIF.

          EXIT.
        ENDIF .
      ENDLOOP.
    ENDIF .

  ENDIF .
  CLEAR   i_bdcdata.
  REFRESH i_bdcdata.


  LOOP AT i_errors.
    WRITE : /.
    WRITE : i_errors-bktxt , i_errors-xblnr,
            i_errors-zuonr , i_errors-message.
  ENDLOOP.

ENDFORM.                    " PROCESS_DATA

*&---------------------------------------------------------------------*
*&      Form  copy_data
*&---------------------------------------------------------------------*
*      make 2 records
*----------------------------------------------------------------------*
FORM copy_data.

  REFRESH i_data.
  CLEAR i_data.

  LOOP AT i_data1.
    MOVE-CORRESPONDING i_data1 TO i_data.
    APPEND i_data.
    CLEAR i_data.
* part 2
    MOVE i_data1-bldatb TO i_data-bldat.
    MOVE i_data1-blartb TO i_data-blart.
    MOVE i_data1-bukrsb TO i_data-bukrs.
    MOVE i_data1-budatb TO i_data-budat.
    MOVE i_data1-waersb TO i_data-waers.
    MOVE i_data1-xblnrb TO i_data-xblnr.
    MOVE i_data1-xref1_hdb TO i_data-xref1_hd.
    MOVE i_data1-xref2_hdb TO i_data-xref2_hd.
    MOVE i_data1-bktxtb TO i_data-bktxt.
    MOVE i_data1-stgrdb TO i_data-stgrd.
    MOVE i_data1-stodtb TO i_data-stodt.
    MOVE i_data1-ldgrpb TO i_data-ldgrp.
    MOVE i_data1-newbsb TO i_data-newbs.
    MOVE i_data1-newkob TO i_data-newko.
    MOVE i_data1-xref1b TO i_data-xref1.
    MOVE i_data1-xref2b TO i_data-xref2.
    MOVE i_data1-newbwb TO i_data-newbw.
    MOVE i_data1-wrbtrb TO i_data-wrbtr.
    MOVE i_data1-dmbtrb TO i_data-dmbtr.
    MOVE i_data1-mwskzb TO i_data-mwskz.
    MOVE i_data1-xmwstb TO i_data-xmwst.
    MOVE i_data1-wmwstb TO i_data-wmwst.
    MOVE i_data1-ztermb TO i_data-zterm.
    MOVE i_data1-zfbdtb TO i_data-zfbdt.
    MOVE i_data1-zlsprb TO i_data-zlspr.
    MOVE i_data1-mengeb TO i_data-menge.
    MOVE i_data1-zuonrb TO i_data-zuonr.
    MOVE i_data1-sgtxtb TO i_data-sgtxt.
    MOVE i_data1-zeileb TO i_data-zeile.
    MOVE i_data1-kkberb TO i_data-kkber.
    MOVE i_data1-kostlb TO i_data-kostl.
    MOVE i_data1-pernrb TO i_data-pernr.
    MOVE i_data1-prctrb TO i_data-prctr.
    MOVE i_data1-char1b TO i_data-char1.
    MOVE i_data1-c_prctrb TO i_data-c_prctr.
    MOVE i_data1-c_ww006b TO i_data-c_ww006.
    MOVE i_data1-c_ww007b TO i_data-c_ww007.
    MOVE i_data1-c_ww008b TO i_data-c_ww008.
    MOVE i_data1-c_kndnrb TO i_data-c_kndnr.
    MOVE i_data1-c_artnrb TO i_data-c_artnr.
    MOVE i_data1-c_equnrb TO i_data-c_equnr.
    MOVE i_data1-c_ww002b TO i_data-c_ww002.
    MOVE i_data1-c_spartb TO i_data-c_spart.
    MOVE i_data1-c_vtwegb TO i_data-c_vtweg.
    MOVE i_data1-c_ww009b TO i_data-c_ww009.
    MOVE i_data1-c_ktgrdb TO i_data-c_ktgrd.
    MOVE i_data1-c_newumb TO i_data-c_newum.
    MOVE i_data1-c_vbel2b TO i_data-c_vbel2.
    MOVE i_data1-c_posn2b TO i_data-c_posn2.
    MOVE i_data1-c_ww003b  TO i_data-c_ww003.
    MOVE i_data1-c_matnrb  TO i_data-c_matnr.
    MOVE i_data1-c_werksb  TO i_data-c_werks.
    MOVE i_data1-c_kaufnb  TO i_data-c_kaufn.
    MOVE i_data1-c_kdposb  TO i_data-c_kdpos.
    MOVE i_data1-segmentb  TO i_data-segment.
    MOVE i_data1-j_3rf_kppb  TO i_data-j_3rf_kpp.
    MOVE i_data1-j_3rf_104b  TO i_data-j_3rf_104.
    MOVE i_data1-j_3rf_105b  TO i_data-j_3rf_105.
    MOVE i_data1-j_3rf_106b  TO i_data-j_3rf_106.
    MOVE i_data1-j_3rf_107b  TO i_data-j_3rf_107.
    MOVE i_data1-j_3rf_108b  TO i_data-j_3rf_108.
    MOVE i_data1-j_3rf_109b  TO i_data-j_3rf_109.
    MOVE i_data1-j_3rfblart_pb  TO i_data-j_3rfblart_p.
    APPEND i_data.
    CLEAR i_data.
  ENDLOOP.

* delete empty lines
  LOOP AT i_data.
    IF i_data-blart IS INITIAL.
      DELETE i_data.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "copy_data

*&---------------------------------------------------------------------*
*&      Form  read_lifnr
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_BUKRS    text
*      -->P_LIFNR    text
*      -->P_PRZN     text
*----------------------------------------------------------------------*
FORM read_lifnr  USING p_bukrs CHANGING p_lifnr p_przn.

  TABLES : thead.
  DATA: tname LIKE thead-tdname, num_line TYPE i.
  DATA: BEGIN OF line OCCURS 0.  "Text lines
          INCLUDE STRUCTURE tline.
  DATA: END OF line.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = p_lifnr
    IMPORTING
      output = p_lifnr.

  MOVE p_lifnr+7(10) TO tname.
  MOVE p_bukrs TO tname+10.
  CLEAR line.
  CALL FUNCTION 'READ_TEXT'          "read text
    EXPORTING
       id         =  'P101'
*         language   = 'R'
       language   =  sy-langu
       name       =  tname
       object     = 'LFB1'
    IMPORTING
       header     = thead
    TABLES
       lines      = line
    EXCEPTIONS OTHERS = 8.
  DESCRIBE TABLE line LINES num_line.   " line content
  IF num_line > 0.
    READ TABLE line INDEX 1.
    IF line-tdline <> space.
      p_przn = 'X'.
    ENDIF.
  ENDIF.

ENDFORM.                    "read_lifnr

*Text symbol text
*001:Upload File
*002:Decimal notation
*003:1.234.567,89
*004:1,234,567.89
*005:File Selection
*006:Batch input session name
*007: records out of
*008: (total transactions in upload file) unsuccessfully posted:
*009:Inputfile
*010:1 Record

*011:2 Records
*Selection text
*FILENAME:
*P_HEADER:        First line is header line
