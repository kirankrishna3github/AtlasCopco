*---------------------------------------------------------------------*
*              Print of an order confirmation by SAPscript
*---------------------------------------------------------------------*
* SEED project
* Done by Jespers Pieter
* This program is a copy from print program RVADOR01
* and is used for AM quotation (YSE_SDQUOT_01) and
* SD quotation (YSE_SDQUOTATION)
* on April 2008: program is copied to YSE_AM_RVADOR01: only used for
* AM quotation.
*---------------------------------------------------------------------*
*=====================================================================*
* Change History Log                                                  *
*---------------------------------------------------------------------*
* Mod. no.|  Date    | Name           | Correction Number | Change Ref*
*---------------------------------------------------------------------*
* MOD-001 |27/02/2007| Tom Van Oevelen| XXXXxxxxxx        | XXXXxxxxxx*
* Description:                                                        *
* I have used this program to prototype the output of a smartform to  *
* a PDF file                                                          *
*---------------------------------------------------------------------*
* MOD-002 |03/12/2008| Nadejda Narychkina |               | CR0377    *
*  Description:                                                       *
*  Selection and better structuring of extra information from Seo     *
*---------------------------------------------------------------------*
* MOD-003 |15/10/2009| L.Mertens USG Innotiv   |CD1K951069| CR0995    *
*---------------------------------------------------------------------*
* MOD-004 |03/10/2009| Geert Rutten |CD1K951075     | CR0942          *
*  Description:                                                       *
*  Russian Quotation print with VAT MWR1 instead of MWST              *
*---------------------------------------------------------------------*
* MOD-005 |29/10/2009| Geert Rutten |CD1K950964     | CR0942          *
*  Description:                                                       *
*  Russian: Printing Sjot                                             *
*---------------------------------------------------------------------*
* MOD-006 |08/12/2009| Geert Rutten |CD1K950964     | CR0942/CR1060   *
*  Description:                                                       *
*  Russian: Printing Russian documents: operation lines not needed    *
*           Make possible to use Sjot document + ENS number for CMT   *
*           Russia                                                    *
*---------------------------------------------------------------------*
* MOD-007 |08/10/2010| Geert Rutten |CD1K950964     | CR0942/CR1060   *
*  Description:                                                       *
*  Multiple sales order lines are now possible with Fixed price       *
*---------------------------------------------------------------------*
* MOD-008 |31/03/2010| Geert Rutten |CD1K955726     | CR1354          *
*  Description:                                                       *
*  Do not take SDI lines which are rejected (for Russia )             *
*---------------------------------------------------------------------*
*---------------------------------------------------------------------*
*MOD-009 | 10/03/2011| Madhu Sane |CD1K963589     | CR1514            *
*  Description:                                                       *
*  Do not take SDI lines which are rejected (for Russia )             *
*---------------------------------------------------------------------*
*MOD-010 | 16/02/2015| Geert Rutten |CD1K984714     | CR3530          *
*  Description:                                                       *
*  Including ZSC4                                                    *
*---------------------------------------------------------------------*
*MOD-011 | 29/08/2016| Uma M Kanidarapu |CD1K989592     | CR4035      *
*  Description:  Duplicate Entries                                    *
*---------------------------------------------------------------------*
*MOD-012 | 03/07/2017| DASHMANTHA | CD1K992601    | CR4230            *
* Description: Addition of ZSC5 for ZAM6 and ZAM7 output types and    *
* correctly using the pop up values of plan and item instead of date  *
*---------------------------------------------------------------------*
REPORT yse_am_rvador01 LINE-COUNT 100 MESSAGE-ID vn.

TABLES: komk,                          "Communicationarea for conditions
        komp,                          "Communicationarea for conditions
        komvd,                         "Communicationarea for conditions
        vbco3,                         "Communicationarea for view
        vbdka,                         "Headerview
        vbdpa,                         "Itemview
        vbdpau,                        "Subitemnumbers
        conf_out,                      "Configuration data
        sadr,                          "Addresses
        tvag,                          "Reason for rejection
        vedka,                         "Servicecontract head data
        vedpa,                         "Servicecontract position data
        vedkn,                         "Servicecontract head notice data
        vedpn,                         "Servicecontract pos. notice data
        riserls,                       "Serialnumbers
        komser,                        "Serialnumbers for print
        tvbur,                         "Sales office
        tvko,                          "Sales organisation
        adrs,                          "Communicationarea for Address
        fpltdr,                        "billing schedules
        wtad_addis_in_so_print,        "additional
        vbpa,
        wtad_buying_print_extra_text.  "texts belonging to additional
DATA:        yse_sf_output TYPE yse_sf_output.
TYPE-POOLS szadr.

INCLUDE rvadtabl.
INCLUDE rvdirekt.
INCLUDE vedadata.

* data for access to central address maintenance
INCLUDE sdzavdat.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
TYPE-POOLS: addi.

DATA price_print_mode(1) TYPE c.       "Print-mode
DATA: retcode   LIKE sy-subrc.         "Returncode
DATA: repeat(1) TYPE c.
DATA: xscreen(1) TYPE c.               "Output on printer or screen
DATA: BEGIN OF steu,                   "Controldata for output
        vdkex(1) TYPE c,
        vdpex(1) TYPE c,
        kbkex(1) TYPE c,
        kbpex(1) TYPE c,
      END OF steu.


DATA: BEGIN OF tvbdpa OCCURS 0.        "Internal table for items
        INCLUDE STRUCTURE vbdpa.
DATA: END OF tvbdpa.

DATA: BEGIN OF tkomv OCCURS 50.
        INCLUDE STRUCTURE komv.
DATA: END OF tkomv.

DATA: it_yse_ens TYPE TABLE OF yse_ens,
      wa_yse_ens LIKE LINE OF it_yse_ens.

DATA: BEGIN OF tkomvd OCCURS 50.
        INCLUDE STRUCTURE komvd.
DATA: END OF tkomvd.

DATA: BEGIN OF tvbdpau OCCURS 5.
        INCLUDE STRUCTURE vbdpau.
DATA: END   OF tvbdpau.

DATA: BEGIN OF tkomcon OCCURS 50.
        INCLUDE STRUCTURE conf_out.
DATA: END   OF tkomcon.

DATA: BEGIN OF tkomservh OCCURS 1.
        INCLUDE STRUCTURE vedka.
DATA: END   OF tkomservh.

DATA: BEGIN OF tkomservp OCCURS 5.
        INCLUDE STRUCTURE vedpa.
DATA: END   OF tkomservp.

DATA: BEGIN OF tkomservhn OCCURS 5.
        INCLUDE STRUCTURE vedkn.
DATA: END   OF tkomservhn.

DATA: BEGIN OF tkomservpn OCCURS 5.
        INCLUDE STRUCTURE vedpn.
DATA: END   OF tkomservpn.

DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
DATA: END   OF tkomser_print.

DATA: BEGIN OF tfpltdr OCCURS 5.
        INCLUDE STRUCTURE fpltdr.
DATA: END   OF tfpltdr.

DATA: taddi_print TYPE addi_so_print_itab WITH HEADER LINE.
DATA: it_vat TYPE TABLE OF yse_vat.
* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: pr_kappl(01)   TYPE c VALUE 'V'. "Application for pricing

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: nast_anzal LIKE nast-anzal.      "Number of outputs (Orig. + Cop.)
DATA: nast_tdarmod LIKE nast-tdarmod.  "Archiving only one time

* current language for read buffered.
DATA: gf_language LIKE sy-langu.

DATA: it_vbkd TYPE TABLE OF vbkd WITH HEADER LINE.
DATA: lv_netwr TYPE netwr.
DATA: lv_netwr_use TYPE netwr.

* MOD-007 Begin of insert multiple sales order lines
DATA: line TYPE i,
      compline TYPE i,
it_vbap2 TYPE TABLE OF vbap.
* MOD-007 End of insert multiple sales order lines

DATA: wa_knvk_contact TYPE knvk.
DATA: wa_adcp_contact TYPE adcp.
DATA: wa_tpfkt_contact TYPE tpfkt.
DATA: it_ztext TYPE TABLE OF ttext.
DATA: wa_tvbdpa_extra TYPE vbdpa.
DATA: wa_tvbdpa_extra1 TYPE vbdpa.
DATA: wa_tkomv TYPE komv.
DATA: wa_veda TYPE veda.
DATA: wa_vbak TYPE vbak.
DATA: wa_tvgrt TYPE tvgrt.
DATA: it_tvbdpa_extra TYPE TABLE OF vbdpa.
DATA: w_vtext TYPE t685t-vtext.
DATA: wa_vbpa_bill_to TYPE vbpa.
DATA: wa_vbpa_ship_to TYPE vbpa.
DATA: l_faktf TYPE  faktf,
      l_display TYPE  kvgr5.
DATA: it_objk TYPE TABLE OF objk,
      w_vat_total TYPE  kbetr,
      l_aufnr TYPE aufnr.
DATA: et_operations	TYPE TABLE OF	bapi_alm_order_operation_e,
      et_tasklist   TYPE TABLE OF bapi_alm_order_operation_e,
      wa_operations TYPE  bapi_alm_order_operation_e,
      et_components TYPE TABLE OF  bapi_alm_order_component_e,
      wa_components LIKE  bapi_alm_order_component_e.
DATA: l_flow(2).
DATA: lay_am_quotation TYPE TABLE OF yse_lay_am_quotation,
      wa_lay_am_quotation TYPE yse_lay_am_quotation,

* begin of insertion MOD-002
      lay_am_component TYPE TABLE OF yse_lay_am_quotation,
      wa_lay_am_component TYPE yse_lay_am_quotation,
      lay_am_operation TYPE TABLE OF yse_lay_am_quotation,
      wa_lay_am_operation TYPE yse_lay_am_quotation,
      lay_tasklist TYPE TABLE OF yse_lay_am_quotation,
      wa_lay_tasklist TYPE yse_lay_am_quotation,
* end of insertion MOD-002
      wa_lay_am_quotation0 TYPE yse_lay_am_quotation,
      s_kschl_discounts TYPE TABLE OF yse_kschl,
      s_kschl_markups   TYPE TABLE OF yse_kschl,
      w_tot_freight TYPE netwr,
      w_tot_discount TYPE netwr,
      w_tot_netwr TYPE netwr.
* begin of insert MOD-003
DATA:   lv_fpltr_use  TYPE fplt-fpltr,
        lv_fpltr_use1  TYPE fplt-fpltr, "+MOD-012
        lv_fplnr_use  TYPE fplt-fplnr,
        lv_fakwr_use  TYPE fplt-fakwr,
        lv_fproz_use  TYPE fplt-fproz,
        lv_fkdat_use  TYPE fplt-fkdat,
        lv_fkdat_2  TYPE fplt-fkdat,
        lv_nfdat_use  TYPE fplt-nfdat,
        lv_dat_tmp TYPE fplt-nfdat,
        lv_fpltr_use2(6) TYPE c,
        gv_vbtyp      TYPE vbak-vbtyp,
        gv_fplnr_save TYPE fplt-fplnr,
        gv_ref(1)     TYPE c.           " X=reference document
* end of insert MOD-003

DATA: lv_ens_matnr TYPE char40.

DATA: l_land2               TYPE land1_gp.

CONSTANTS:
faktf_costs TYPE  faktf VALUE '02',
faktf_fixedrate TYPE  faktf VALUE '01',
gc_000001 TYPE FPLTR VALUE '000001'. "+MOD-012

*MOD-008  EXTMBS  CD1K963262

TYPES: BEGIN OF ty_resb,                                   " CD1K963262
         rspos TYPE resb-rspos,
         xloek TYPE resb-xloek,
         matnr TYPE resb-matnr,
         aufnr TYPE resb-aufnr,
       END OF ty_resb.

DATA: it_resb TYPE TABLE OF ty_resb WITH HEADER LINE.

*  MOD-008  EXTMBS  CD1K963262

*&---------------------------------------------------------------------*
*&      Form  ENTRY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry USING return_code TYPE i
                 us_screen TYPE c.
  DATA: lf_retcode TYPE sy-subrc.

* begin of insert MOD-003
  DATA: lt_sellist LIKE spopli OCCURS 5 WITH HEADER LINE,
        lt_fplt    LIKE fplt   OCCURS 0 WITH HEADER LINE.

  DATA: lv_fplnr  TYPE fplt-fplnr,
        lv_fpltr  TYPE fplt-fpltr,
        lv_tetxt  TYPE fplt-tetxt,
        lv_vgbel  TYPE vbak-vgbel,
        lv_auart  TYPE vbak-auart,
        lv_rfpln  TYPE fpla-rfpln,
        lv_fkdat  TYPE fplt-fkdat,
        lv_nfdat  TYPE fplt-nfdat,
        lv_fakwr  TYPE fplt-fakwr,
        lv_fakwr_out(13) TYPE c,
        lv_answer(3) TYPE c,
        lv_lines  TYPE f,
        lv_fplnr_out(10) TYPE c,
        lv_fpltr_out(6) TYPE c,
        lv_fkdat_out(8) TYPE c,
        lv_nfdat_out(8) TYPE c.

  DATA: lv_bukrs TYPE bukrs.

  IF nast-kschl = 'ZAM6'.
    CLEAR: lv_fplnr_out,
           gv_ref,
           lv_fakwr_use,
           lv_fproz_use.

    SELECT SINGLE vbtyp vgbel auart
        INTO (gv_vbtyp, lv_vgbel, lv_auart) FROM vbak
        WHERE vbeln = nast-objky.

    IF gv_vbtyp = 'B' OR                         "Quotation
       gv_vbtyp = 'C'.

      SELECT SINGLE bukrs_vf INTO lv_bukrs FROM vbak  WHERE vbeln = nast-objky(10).
      IF sy-subrc EQ 0.
        IF lv_bukrs = 'MRUA'."Order

          IF nast-objky+10(6) IS NOT INITIAL.
            SELECT SINGLE fplnr INTO lv_fplnr
              FROM vbkd WHERE vbeln EQ nast-objky(10)
                          AND posnr EQ nast-objky+10(6)
                          AND fplnr NE space.
          ELSE.
            SELECT SINGLE fplnr INTO lv_fplnr
                FROM vbkd WHERE vbeln EQ nast-objky(10)
                            AND posnr EQ '000010'
                            AND fplnr NE space.
          ENDIF.
        ELSE.
          SELECT SINGLE fplnr INTO lv_fplnr
            FROM vbkd WHERE vbeln EQ nast-objky
                        AND posnr EQ '000000'
                        AND fplnr NE space.

        ENDIF.
      ELSE.
        SELECT SINGLE fplnr INTO lv_fplnr
          FROM vbkd WHERE vbeln EQ nast-objky
                      AND posnr EQ '000000'
                      AND fplnr NE space.
      ENDIF.

      IF sy-subrc = 0 AND ( gv_vbtyp = 'C' AND lv_vgbel NE space ).
        SELECT SINGLE rfpln INTO lv_rfpln
          FROM fpla WHERE fplnr = lv_fplnr.

        IF sy-subrc = 0.
          gv_fplnr_save = lv_fplnr.
          lv_fplnr      = lv_rfpln.
          gv_ref = 'X'.
        ENDIF.
      ENDIF.

      REFRESH lt_sellist.
      SELECT fplnr fpltr tetxt fakwr
          INTO (lv_fplnr, lv_fpltr, lv_tetxt, lv_fakwr)
          FROM fplt
          WHERE fplnr EQ lv_fplnr
            AND tetxt EQ 'Z006'.

        lv_fakwr_out = lv_fakwr.
        CONCATENATE lv_fplnr lv_fpltr lv_tetxt lv_fakwr_out INTO lt_sellist-varoption SEPARATED BY ' - '.
        APPEND lt_sellist.
      ENDSELECT.

*.... Check whether items were added to the SO after reference copy from the Quotation
      IF gv_ref = 'X'.
        REFRESH lt_fplt.
        SELECT * INTO TABLE lt_fplt
          FROM fplt WHERE fplnr = lv_rfpln
                      AND tetxt = 'Z006'.

        SORT lt_fplt BY fplnr fpltr.

        SELECT fplnr fpltr tetxt fakwr
          INTO (lv_fplnr, lv_fpltr, lv_tetxt, lv_fakwr)
          FROM fplt WHERE fplnr = gv_fplnr_save
                      AND tetxt = 'Z006'.

          READ TABLE lt_fplt WITH KEY fplnr = lv_rfpln
                                      fpltr = lv_fpltr  BINARY SEARCH.

          IF sy-subrc <> 0.
            lv_fakwr_out = lv_fakwr.
            CONCATENATE lv_fplnr lv_fpltr lv_tetxt lv_fakwr_out INTO lt_sellist-varoption SEPARATED BY ' - '.
            APPEND lt_sellist.
          ENDIF.
        ENDSELECT.
      ENDIF.

      DESCRIBE TABLE lt_sellist LINES lv_lines.
      IF lv_lines > 1.
        CLEAR: lv_answer.

        CALL FUNCTION 'POPUP_TO_DECIDE_LIST'
          EXPORTING
            start_col                = 30
            start_row                = 15
            textline1                = 'More than 1 payment request found' "#EC NOTEXT

*            textline2                =
            textline3                = 'Please choose one'  "#EC NOTEXT
            titel                    = 'List of payment requests' "#EC NOTEXT
          IMPORTING
            answer                   = lv_answer
          TABLES
            t_spopli                 = lt_sellist
          EXCEPTIONS
            not_enough_answers       = 1
            too_much_answers         = 2
            too_much_marks           = 3
            OTHERS                   = 4.

        IF lv_answer NE 'A'.
          READ TABLE lt_sellist INDEX lv_answer.
          IF sy-subrc = 0.
            MOVE lt_sellist-varoption+00(10) TO lv_fplnr_out.
            MOVE lt_sellist-varoption+13(06) TO lv_fpltr_out.
          ENDIF.
        ELSE.
          MESSAGE e001(00) WITH 'No payment request was selected !'. "#EC NOTEXT
        ENDIF.
      ENDIF. "more than 1 line --> popup

      IF lv_fplnr_out IS NOT INITIAL. " popup was necessary and we need to pick up values
        lv_fpltr_use = lv_fpltr_out.
        lv_fplnr_use = lv_fplnr_out.
        SELECT SINGLE fakwr fproz INTO (lv_fakwr_use, lv_fproz_use) FROM fplt
          WHERE fplnr = lv_fplnr_use AND
                fpltr = lv_fpltr_use.
      ELSE. " NO popup... we can just take the values of the only valid billing plan item
        lv_fpltr_use = lv_fpltr.
        lv_fplnr_use = lv_fplnr.
        SELECT SINGLE fakwr fproz INTO (lv_fakwr_use, lv_fproz_use) FROM fplt
          WHERE fplnr = lv_fplnr_use
            AND fpltr = lv_fpltr_use.
      ENDIF.
    ELSEIF gv_vbtyp = 'G'.                     "Contract


      SELECT SINGLE bukrs_vf INTO lv_bukrs FROM vbak  WHERE vbeln = nast-objky(10).
      IF sy-subrc EQ 0.
        IF lv_bukrs = 'MRUA'."Order
          IF nast-objky+10(6) IS NOT INITIAL.
            SELECT SINGLE fplnr INTO lv_fplnr
                FROM vbkd WHERE vbeln EQ nast-objky(10)
                            AND posnr EQ nast-objky+10(6)
                            AND fplnr NE space.
          ELSE.
            SELECT SINGLE fplnr INTO lv_fplnr
                FROM vbkd WHERE vbeln EQ nast-objky(10)
                            AND posnr EQ '000010'
                            AND fplnr NE space.
          ENDIF.
        ELSE.
          SELECT SINGLE fplnr INTO lv_fplnr
              FROM vbkd WHERE vbeln EQ nast-objky
                          AND posnr EQ '000000'
                          AND fplnr NE space.

        ENDIF.
      ELSE.
        SELECT SINGLE fplnr INTO lv_fplnr
            FROM vbkd WHERE vbeln EQ nast-objky
                        AND posnr EQ '000000'
                        AND fplnr NE space.

      ENDIF.

      REFRESH lt_sellist.
      IF lv_auart = 'ZC01'.                    "Periodic contract
        SELECT fplnr fpltr fkdat nfdat
          INTO (lv_fplnr, lv_fpltr, lv_fkdat, lv_nfdat)
          FROM fplt
          WHERE fplnr EQ lv_fplnr.

          CONCATENATE lv_fplnr lv_fkdat lv_nfdat INTO lt_sellist-varoption SEPARATED BY ' - '.
          APPEND lt_sellist.
        ENDSELECT.
      ELSE.                                    "Milestone contract (ZC02)
        SELECT fplnr fpltr fakwr
          INTO (lv_fplnr, lv_fpltr, lv_fakwr)
          FROM fplt
          WHERE fplnr EQ lv_fplnr.

          lv_fakwr_out = lv_fakwr.
          CONCATENATE lv_fplnr lv_fpltr lv_fakwr_out INTO lt_sellist-varoption SEPARATED BY ' - '.
          APPEND lt_sellist.
        ENDSELECT.
      ENDIF.

      DESCRIBE TABLE lt_sellist LINES lv_lines.
      IF lv_lines > 1.
        CLEAR: lv_answer.

        CALL FUNCTION 'POPUP_TO_DECIDE_LIST'
          EXPORTING
            start_col                = 30
            start_row                = 15
            textline1                = 'Please choose one line' "#EC NOTEXT
*            textline2                =
*           textline3                =
            titel                    = 'Contract Billing plan' "#EC NOTEXT
          IMPORTING
            answer                   = lv_answer
          TABLES
            t_spopli                 = lt_sellist
          EXCEPTIONS
            not_enough_answers       = 1
            too_much_answers         = 2
            too_much_marks           = 3
            OTHERS                   = 4.

        IF lv_answer NE 'A'.
          READ TABLE lt_sellist INDEX lv_answer.
          IF sy-subrc = 0.
            MOVE lt_sellist-varoption+00(10) TO lv_fplnr_out.
*            MOVE lt_sellist-varoption+13(06) TO lv_fpltr_out.
            MOVE lt_sellist-varoption+13(08) TO lv_fkdat_out.
            MOVE lt_sellist-varoption+24(08) TO lv_nfdat_out.

            IF lv_auart NE 'ZC02'. "+MOD-012
            SELECT SINGLE  fpltr INTO lv_fpltr_out FROM fplt
            WHERE  fplnr = lv_fplnr_out
              AND  fkdat = lv_fkdat_out
              AND  nfdat = lv_nfdat_out.
* Begin of insertion by MOD-012
            ELSE.
             lv_fpltr_out = lt_sellist-varoption+13(6).
            ENDIF.
* End of insertion by MOD-012
          ENDIF.
        ELSE.
          MESSAGE e001(00) WITH 'No BP line was selected !'. "#EC NOTEXT
        ENDIF.
      ENDIF. "more than 1 line --> popup

      IF lv_fplnr_out IS NOT INITIAL. " popup was necessary and we need to pick up values
        lv_fpltr_use = lv_fpltr_out.
        lv_fplnr_use = lv_fplnr_out.
        SELECT SINGLE fkdat nfdat fakwr INTO (lv_fkdat_use, lv_nfdat_use, lv_fakwr_use) FROM fplt
          WHERE fplnr = lv_fplnr_use AND
                fpltr = lv_fpltr_use.
* Begin of insertion by MOD-012
          IF sy-subrc EQ 0 AND
             lv_nfdat_use IS INITIAL AND
             lv_auart EQ 'ZC02'.
            IF lv_fpltr_use = gc_000001.
              lv_nfdat_use = lv_fkdat_use.
            ELSE.
              CLEAR lv_fpltr_use1.
              lv_fpltr_use1 = lv_fpltr_use - 1.
              lv_nfdat_use = lv_fkdat_use.
            SELECT SINGLE fkdat INTO lv_fkdat_use
                                FROM fplt
                                WHERE fplnr = lv_fplnr_use
                                AND fpltr = lv_fpltr_use1.
            ENDIF.
          ENDIF.
* End of insertion by MOD-012
      ELSE. " NO popup... we can just take the values of the only valid billing plan item
        lv_fpltr_use = lv_fpltr.
        lv_fplnr_use = lv_fplnr.
        lv_fplnr_use = lv_fplnr_out.
        lv_fpltr_use = lv_fpltr_out.
        SELECT SINGLE fkdat nfdat fakwr INTO (lv_fkdat_use, lv_nfdat_use, lv_fakwr_use) FROM fplt
          WHERE fplnr = lv_fplnr_use
            AND fpltr = lv_fpltr_use.
      ENDIF.
    ENDIF.
  ENDIF.
  lv_fkdat_2 = lv_fkdat_use.
  IF lv_fkdat_use > lv_nfdat_use.
    lv_dat_tmp = lv_fkdat_use.
    lv_fkdat_use = lv_nfdat_use.
    lv_nfdat_use = lv_dat_tmp.
  ENDIF.                                                    " ZAM6
* end of insert MOD-003

*insert for confirmations: get the quotation nr
  DATA: l_vbelv LIKE vbfa-vbelv.
  IF nast-kschl = 'ZOC2' OR nast-kschl = 'ZOC3'.
    SELECT SINGLE vbelv INTO l_vbelv FROM vbfa WHERE vbeln = nast-objky
                                                 AND vbtyp_v = 'B'.
    nast-objky =  l_vbelv.
  ENDIF.


*end insert


  CLEAR retcode.
  xscreen = us_screen.
  PERFORM processing_sf  USING us_screen
                      CHANGING lf_retcode.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY



***********************************************************************
*       S U B R O U T I N E S                                         *
***********************************************************************


*---------------------------------------------------------------------*
*       FORM CHECK_REPEAT                                             *
*---------------------------------------------------------------------*
*       A text is printed, if it is a repeat print for the document.  *
*---------------------------------------------------------------------*

FORM check_repeat.

  CLEAR repeat.
  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'.
    CHECK *nast-vstat = '1'.
    repeat = 'X'.
    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT


**---------------------------------------------------------------------*
**       FORM GET_DATA                                                 *
**---------------------------------------------------------------------*
**       General provision of data for the form                        *
**---------------------------------------------------------------------*
*FORM get_data.
*
*  DATA: us_veda_vbeln     LIKE veda-vbeln.
*  DATA: us_veda_posnr_low LIKE veda-vposn.
*
*  DATA: da_mess LIKE vbfs OCCURS 0 WITH HEADER LINE.
*
*  CALL FUNCTION 'RV_PRICE_PRINT_GET_MODE'
*    IMPORTING
*      e_print_mode = price_print_mode.
*
**all the prices were blance out??!!
*  IF price_print_mode EQ chara.
**    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
**      TABLES
**        tkomv = tkomv.
*    REFRESH tkomv.
*    CLEAR tkomv.
*  ENDIF.
*
*  CLEAR komk.
*  CLEAR komp.
*
*  vbco3-mandt = sy-mandt.
*  vbco3-spras = nast-spras.
*  vbco3-vbeln = nast-objky.
*  vbco3-kunde = nast-parnr.
*  vbco3-parvw = nast-parvw.
*
*  CALL FUNCTION 'RV_DOCUMENT_PRINT_VIEW'
*    EXPORTING
*      comwa                       = vbco3
*    IMPORTING
*      kopf                        = vbdka
*    TABLES
*      pos                         = tvbdpa
*      mess                        = da_mess
*    EXCEPTIONS
*      fehler_bei_datenbeschaffung = 1.
*  IF sy-subrc NE 0.
*    PERFORM protocol_update.
*    retcode = 1.
*    EXIT.
*  ELSE.
*    LOOP AT da_mess.
*      sy-msgid = da_mess-msgid.
*      sy-msgno = da_mess-msgno.
*      sy-msgty = da_mess-msgty.
*      sy-msgv1 = da_mess-msgv1.
*      sy-msgv2 = da_mess-msgv2.
*      sy-msgv3 = da_mess-msgv3.
*      sy-msgv4 = da_mess-msgv4.
*      PERFORM protocol_update.
*    ENDLOOP.
*  ENDIF.
*
** fill address key --> necessary for emails
*  addr_key-addrnumber = vbdka-adrnr.
*  addr_key-persnumber = vbdka-adrnp.
*  addr_key-addr_type  = vbdka-address_type.
*
** Fetch servicecontract-data and notice-data for head and position.
*  us_veda_vbeln     = vbdka-vbeln.
*  us_veda_posnr_low = posnr_low.
*  CALL FUNCTION 'SD_VEDA_GET_PRINT_DATA'
*    EXPORTING
*      i_document_number = us_veda_vbeln
*      i_language        = sy-langu
*      i_posnr_low       = us_veda_posnr_low
*    TABLES
*      print_data_pos    = tkomservp
*      print_data_head   = tkomservh
*      print_notice_pos  = tkomservpn
*      print_notice_head = tkomservhn.
*
*  PERFORM get_controll_data.
*
*  PERFORM sender.
*  PERFORM check_repeat.
*  PERFORM tvbdpau_create.
*
*ENDFORM.                    "GET_DATA

*---------------------------------------------------------------------*
*       FORM GET_ITEM_BILLING_SCHEDULES                               *
*---------------------------------------------------------------------*
*       In this routine the billing schedules are fetched from the    *
*       database.                                                     *
*---------------------------------------------------------------------*
FORM get_item_billing_schedules.

  REFRESH tfpltdr.
  CHECK NOT vbdpa-fplnr IS INITIAL.

  CALL FUNCTION 'BILLING_SCHED_PRINTVIEW_READ'
    EXPORTING
      i_fplnr    = vbdpa-fplnr
      i_language = nast-spras
      i_vbeln    = vbdka-vbeln
    TABLES
      zfpltdr    = tfpltdr.

ENDFORM.                    "GET_ITEM_BILLING_SCHEDULES

*&---------------------------------------------------------------------*
*&      FORM  GET_ITEM_ADDIS
*&---------------------------------------------------------------------*
*       Additionals data are fetched from database
*----------------------------------------------------------------------*
FORM get_item_addis.

  CLEAR: taddi_print.

  CALL FUNCTION 'WTAD_ADDIS_IN_SO_PRINT'
       EXPORTING
            fi_vbeln              = vbdka-vbeln
            fi_posnr              = vbdpa-posnr
*           FI_LANGUAGE           = SY-LANGU
       TABLES
            fet_addis_in_so_print = taddi_print
       EXCEPTIONS
            addis_not_active      = 1
            no_addis_for_so_item  = 2
            OTHERS                = 3.

ENDFORM.                               " GET_ITEM_ADDIS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS                                 *
*---------------------------------------------------------------------*
*       In this routine the configuration data item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*
FORM get_item_characteristics.

  DATA da_t_cabn LIKE cabn OCCURS 10 WITH HEADER LINE.
  DATA: BEGIN OF da_key,
          mandt LIKE cabn-mandt,
          atinn LIKE cabn-atinn,
        END   OF da_key.

  REFRESH tkomcon.
  CHECK NOT vbdpa-cuobj IS INITIAL AND
            vbdpa-attyp NE var_typ.

  CALL FUNCTION 'VC_I_GET_CONFIGURATION'
    EXPORTING
      instance      = vbdpa-cuobj
      language      = nast-spras
      print_sales   = charx
    TABLES
      configuration = tkomcon
    EXCEPTIONS
      OTHERS        = 4.

  RANGES : da_in_cabn FOR da_t_cabn-atinn.
* Beschreibung der Merkmale wegen Objektmerkmalen auf sdcom-vkond holen
  CLEAR da_in_cabn. REFRESH da_in_cabn.
  LOOP AT tkomcon.
    da_in_cabn-option = 'EQ'.
    da_in_cabn-sign   = 'I'.
    da_in_cabn-low    = tkomcon-atinn.
    APPEND da_in_cabn.
  ENDLOOP.

  CLEAR da_t_cabn. REFRESH da_t_cabn.
  CALL FUNCTION 'CLSE_SELECT_CABN'
*    EXPORTING
*         KEY_DATE                     = SY-DATUM
*         BYPASSING_BUFFER             = ' '
*         WITH_PREPARED_PATTERN        = ' '
*         I_AENNR                      = ' '
*    IMPORTING
*         AMBIGUOUS_OBJ_CHARACTERISTIC =
     TABLES
          in_cabn                      = da_in_cabn
          t_cabn                       = da_t_cabn
     EXCEPTIONS
          no_entry_found               = 1
          OTHERS                       = 2.

* Preisfindungsmerkmale / Merkmale auf VCSD_UPDATE herausnehmen
  SORT da_t_cabn.
  LOOP AT tkomcon.
    da_key-mandt = sy-mandt.
    da_key-atinn = tkomcon-atinn.
    READ TABLE da_t_cabn WITH KEY da_key BINARY SEARCH.
    IF sy-subrc <> 0 OR
       ( ( da_t_cabn-attab = 'SDCOM' AND
          da_t_cabn-atfel = 'VKOND'       ) OR
        ( da_t_cabn-attab = 'VCSD_UPDATE' ) ) .
      DELETE tkomcon.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_PRICES                                          *
*---------------------------------------------------------------------*
*       In this routine the price data for the item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*
FORM get_item_prices.

  CLEAR: komp,
         tkomv.

  IF komk-knumv NE vbdka-knumv OR
     komk-knumv IS INITIAL.
    CLEAR komk.
    komk-mandt = sy-mandt.
    komk-kalsm = vbdka-kalsm.
    komk-kappl = pr_kappl.
    komk-waerk = vbdka-waerk.
    komk-knumv = vbdka-knumv.
    komk-knuma = vbdka-knuma.
    komk-vbtyp = vbdka-vbtyp.
    komk-land1 = vbdka-land1.
    komk-vkorg = vbdka-vkorg.
    komk-vtweg = vbdka-vtweg.
    komk-spart = vbdka-spart.
    komk-bukrs = vbdka-bukrs_vf.
    komk-hwaer = vbdka-waers.
    komk-prsdt = vbdka-erdat.
    komk-kurst = vbdka-kurst.
    komk-kurrf = vbdka-kurrf.
    komk-kurrf_dat = vbdka-kurrf_dat.
  ENDIF.
  komp-kposn = vbdpa-posnr.
  komp-kursk = vbdpa-kursk.
  komp-kursk_dat = vbdpa-kursk_dat.
  IF vbdka-vbtyp CA 'HKNOT6'.
    IF vbdpa-shkzg CA ' A'.
      komp-shkzg = 'X'.
    ENDIF.
  ELSE.
    IF vbdpa-shkzg CA 'BX'.
      komp-shkzg = 'X'.
    ENDIF.
  ENDIF.

*>>>air22296

  DATA: komkh LIKE  komkh,
        komph LIKE  komph.

  CLEAR: komkh, komph.
  CALL FUNCTION 'SD_DOCUMENT_GET_KOMKH_KOMPH'
    EXPORTING
      i_vbeln                   = vbdka-vbeln
      i_posnr                   = vbdpa-posnr
      i_komkh                   = komkh
      i_komph                   = komph
*   I_ANREICHERN              = ' '
   IMPORTING
     e_komkh                   = komkh
     e_komph                   = komph
*   E_KNUMH                   =
*   E_CUOBJ_CH                =
*   E_LFDAT                   =
 EXCEPTIONS
   document_not_found        = 1
   item_not_found            = 2
   item_number_missing       = 3
   OTHERS                    = 4
            .
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  MOVE-CORRESPONDING komph TO komp.
  MOVE-CORRESPONDING komkh TO komk.
*<<<<

  IF price_print_mode EQ chara.
    CALL FUNCTION 'RV_PRICE_PRINT_ITEM'
      EXPORTING
        comm_head_i = komk
        comm_item_i = komp
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
        comm_item_e = komp
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ELSE.
    CALL FUNCTION 'RV_PRICE_PRINT_ITEM_BUFFER'
      EXPORTING
        comm_head_i = komk
        comm_item_i = komp
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
        comm_item_e = komp
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ENDIF.

ENDFORM.                    "GET_ITEM_PRICES

*---------------------------------------------------------------------*
*       FORM GET_HEADER_PRICES                                        *
*---------------------------------------------------------------------*
*       In this routine the price data for the header is fetched from *
*       the database.                                                 *
*---------------------------------------------------------------------*
FORM get_header_prices.

  LOOP AT tvbdpa.

    CALL FUNCTION 'SD_TAX_CODE_MAINTAIN'
      EXPORTING
        key_knumv           = vbdka-knumv
        key_kposn           = tvbdpa-posnr
        i_application       = ' '
        i_pricing_procedure = vbdka-kalsm
      TABLES
        xkomv               = tkomv.


  ENDLOOP.

  IF price_print_mode EQ chara.

    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
      TABLES
        tkomv = tkomv.

    CALL FUNCTION 'RV_PRICE_PRINT_HEAD'
      EXPORTING
        comm_head_i = komk
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ELSE.
    CALL FUNCTION 'RV_PRICE_PRINT_HEAD_BUFFER'
      EXPORTING
        comm_head_i = komk
        language    = nast-spras
      IMPORTING
        comm_head_e = komk
      TABLES
        tkomv       = tkomv
        tkomvd      = tkomvd.
  ENDIF.

ENDFORM.                    "GET_HEADER_PRICES


*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*
FORM protocol_update.

  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE
*---------------------------------------------------------------------*
*       FORM SENDER                                                   *
*---------------------------------------------------------------------*
*       This routine determines the address of the sender (Table VKO) *
*---------------------------------------------------------------------*

FORM sender.

  SELECT SINGLE * FROM tvko  WHERE vkorg = vbdka-vkorg.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'TVKO'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
    EXIT.
  ENDIF.

  CLEAR gv_fb_addr_get_selection.
  gv_fb_addr_get_selection-addrnumber = tvko-adrnr.         "SADR40A
  CALL FUNCTION 'ADDR_GET'
    EXPORTING
      address_selection = gv_fb_addr_get_selection
      address_group     = 'CA01'
    IMPORTING
      sadr              = sadr
    EXCEPTIONS
      OTHERS            = 01.
  IF sy-subrc NE 0.
    CLEAR sadr.
  ENDIF.                                                    "SADR40A
  vbdka-sland = sadr-land1.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'E'.
    syst-msgv1 = 'SADR'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SENDER

*---------------------------------------------------------------------*
*       FORM TVBDPAU_CREATE                                           *
*---------------------------------------------------------------------*
*       This routine is creating a table which includes the subitem-  *
*       numbers                                                       *
*---------------------------------------------------------------------*
FORM tvbdpau_create.

  CLEAR tvbdpau.
  REFRESH tvbdpau.
  LOOP AT tvbdpa.
    IF tvbdpa-uepos IS INITIAL OR
       tvbdpa-uepos NE tvbdpau-posnr.
* Append work area to internal table TVBDPAU
      IF tvbdpau-uposv > 0.
        APPEND tvbdpau.
        CLEAR tvbdpau.
      ENDIF.
* Start filling new work area
      tvbdpau-posnr = tvbdpa-posnr.

      IF NOT tvbdpa-uepos IS INITIAL AND
         tvbdpa-uepos NE tvbdpau-posnr.
        tvbdpau-posnr = tvbdpa-uepos.
        tvbdpau-uepvw = tvbdpa-uepvw.
        tvbdpau-uposv = tvbdpa-posnr.
      ENDIF.

    ELSE.
      IF tvbdpau-uposv IS INITIAL OR
         tvbdpau-uposv > tvbdpa-posnr.
        tvbdpau-uposv = tvbdpa-posnr.
      ENDIF.
      IF tvbdpau-uposb < tvbdpa-posnr AND
         tvbdpau-uposv < tvbdpa-posnr.
        tvbdpau-uposb = tvbdpa-posnr.
      ENDIF.
      tvbdpau-uepvw = tvbdpa-uepvw.    "UPOS-Verwendung
    ENDIF.
  ENDLOOP.
  IF tvbdpau-uposv > 0.
    APPEND tvbdpau.
  ENDIF.
  SORT tvbdpau.

ENDFORM.                    "TVBDPAU_CREATE

*&---------------------------------------------------------------------*
*&      Form  GET_ITEM_SERIALS
*&---------------------------------------------------------------------*
*       This routine give back the serialnumbers of salesdocument      *
*       position. The numbers are processed as print-lines in the      *
*       table KOMSER_PRINT.                                            *
*----------------------------------------------------------------------*
*  -->  US_VBELN  Salesdocument
*  -->  US_POSNR  Position of the salesdocument
*----------------------------------------------------------------------*
FORM get_item_serials.

  DATA: key_data LIKE rserob,
        sernos LIKE rserob OCCURS 0 WITH HEADER LINE.

  key_data-taser = 'SER02'.
  key_data-sdaufnr = vbdka-vbeln.
  key_data-posnr = vbdpa-posnr.
  IF key_data-sdaufnr IS INITIAL AND NOT
     key_data-posnr IS INITIAL.
* beim Anlegen ist Belegnummer leer - deshalb Dummy-Belegnummer
    key_data-sdaufnr = char$.
  ENDIF.

* Read the Serialnumbers of a Position.
  REFRESH: tkomser,
           tkomser_print.
  CALL FUNCTION 'GET_SERNOS_OF_DOCUMENT'
    EXPORTING
      key_data            = key_data
    TABLES
      sernos              = sernos
    EXCEPTIONS
      key_parameter_error = 1
      no_supported_access = 2
      no_data_found       = 3
      OTHERS              = 4.
  IF sy-subrc NE 0 AND
     sy-subrc NE 3.
    PERFORM protocol_update.
  ENDIF.

  CHECK sy-subrc EQ 0.
* Serialnummern ¨¹bergeben
  tkomser-vbeln = sernos-sdaufnr.
  tkomser-posnr = sernos-posnr.
  LOOP AT sernos.
    tkomser-sernr = sernos-sernr.
    APPEND tkomser.
  ENDLOOP.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
    EXPORTING
      i_boundary_left             = '(_'
      i_boundary_right            = '_)'
      i_sep_char_strings          = ',_'
      i_sep_char_interval         = '_-_'
      i_use_interval              = 'X'
      i_boundary_method           = 'C'
      i_line_length               = 50
      i_no_zero                   = 'X'
      i_alphabet                  = sy-abcde
      i_digits                    = '0123456789'
      i_special_chars             = '-'
      i_with_second_digit         = ' '
    TABLES
      serials                     = tkomser
      serials_print               = tkomser_print
    EXCEPTIONS
      boundary_missing            = 01
      interval_separation_missing = 02
      length_to_small             = 03
      internal_error              = 04
      wrong_method                = 05
      wrong_serial                = 06
      two_equal_serials           = 07
      serial_with_wrong_char      = 08
      serial_separation_missing   = 09.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.


ENDFORM.                               " GET_ITEM_SERIALS



*&---------------------------------------------------------------------*
*&      Form  GET_CONTROLL_DATA
*&---------------------------------------------------------------------*
*       Checks if servicedata for the header exists.                   *
*       Checks if servicedata for the position exists.                 *
*       Checks if noticedata for the header exists.                    *
*       Checks if noticedata for the position exists.                  *
*----------------------------------------------------------------------*
FORM get_controll_data.

  DATA: lines TYPE i.

* Exists servicedata for the header?
  DESCRIBE TABLE tkomservh LINES lines.
  IF lines GT 0.
    steu-vdkex = 'X'.
  ENDIF.

* Exists servicedata for the position?
  DESCRIBE TABLE tkomservp LINES lines.
  IF lines GT 0.
    steu-vdpex = 'X'.
  ENDIF.

* Exists noticedata for the header?
  DESCRIBE TABLE tkomservhn LINES lines.
  IF lines GT 0.
    steu-kbkex = 'X'.
  ENDIF.

* Exists noticedata for the position?
  DESCRIBE TABLE tkomservpn LINES lines.
  IF lines GT 0.
    steu-kbpex = 'X'.
  ENDIF.

ENDFORM.                               " GET_CONTROLL_DATA
*&---------------------------------------------------------------------*
*&      Form  processing_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM processing_sf USING proc_screen
                   CHANGING cf_retcode.

  DATA: ls_print_data_to_read TYPE lbbil_print_data_to_read.
  DATA: ls_bil_invoice        TYPE lbbil_invoice.
  DATA: lf_fm_name            TYPE rs38l_fnam.
  DATA: ls_control_param      TYPE ssfctrlop.
  DATA: ls_composer_param     TYPE ssfcompop.
  DATA: ls_recipient          TYPE swotobjid.
  DATA: ls_sender             TYPE swotobjid.
  DATA: lf_formname           TYPE tdsfname.
  DATA: ls_addr_key           LIKE addr_key.
  DATA: ls_dlv-land           LIKE vbrk-land1.
  DATA: ls_job_info           TYPE ssfcrescl.
  DATA: l_sform               TYPE tdsfname,
        l_land1               TYPE land1_gp,
        l_bukrs               TYPE bukrs.

* begin of insert MOD-008
  DATA: lv_abgru TYPE abgru,
        lv_tab TYPE sy-tabix.
* begin of insert MOD-008

* SmartForm from customizing table TNAPR
  lf_formname = tnapr-sform.

* determine print data
  PERFORM set_print_data_to_read USING    lf_formname
                                 CHANGING ls_print_data_to_read
                                 cf_retcode.

  IF cf_retcode = 0.
    PERFORM get_data_sf.
    PERFORM header_serv_print_sf.
    PERFORM item_print_sf.
    PERFORM get_extra_data2.
*    PERFORM get_header_prices.  "check other docs!!!!     "air22296
    PERFORM fill_discount_markup_table.
    CLEAR l_land1.
    SELECT SINGLE land1 INTO l_land1 FROM  t001
           WHERE  bukrs  = vbdka-bukrs_vf.
    IF l_land1 NE 'PL'.
      PERFORM refill_tvbdpa.  "only for AM quotation
    ENDIF.
    PERFORM data_to_display.
  ENDIF.

  IF cf_retcode = 0.
    PERFORM set_print_param USING    ls_addr_key
                                     ls_dlv-land
                            CHANGING ls_control_param
                                     ls_composer_param
                                     ls_recipient
                                     ls_sender
                                     cf_retcode.
  ENDIF.

*>>>air22296: for other font countries,we will pick another layout
*  CLEAR l_land1.
*  SELECT SINGLE land1 INTO l_land1 FROM  t001
*         WHERE  bukrs  = vbdka-bukrs_vf.


  CALL FUNCTION 'YSE_LAY_GET_FNAME'
    EXPORTING
      tnapr = tnapr
      land1 = l_land1
    IMPORTING
      sform = l_sform.

  IF NOT l_sform IS INITIAL.
    lf_formname = l_sform.
  ELSE.
    lf_formname = tnapr-sform.
  ENDIF.

*<<<air22296
  IF cf_retcode = 0.
* determine smartform function module for invoice
    CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
         EXPORTING  formname           = lf_formname
*                 variant            = ' '
*                 direct_call        = ' '
         IMPORTING  fm_name            = lf_fm_name
         EXCEPTIONS no_form            = 1
                    no_function_module = 2
                    OTHERS             = 3.
    IF sy-subrc <> 0.
*   error handling
      cf_retcode = sy-subrc.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

  IF cf_retcode = 0.
    PERFORM check_repeat.
    IF ls_composer_param-tdcopies EQ 0.
      nast_anzal = 1.
    ELSE.
      nast_anzal = ls_composer_param-tdcopies.
    ENDIF.
    ls_composer_param-tdcopies = 1.
    DO nast_anzal TIMES.
* In case of repetition only one time archiving
      IF sy-index > 1 AND nast-tdarmod = 3.
        nast_tdarmod = nast-tdarmod.
        nast-tdarmod = 1.
        ls_composer_param-tdarmod = 1.
      ENDIF.
      IF sy-index NE 1 AND repeat IS INITIAL.
        repeat = 'X'.
      ENDIF.

*There are more tables that we give to the function like:
*tkomservp
*tkomservh
*tkomservpn
*tkomservhn
*tkomcon
*taddi_print
* Begin of insert MOD-005 Sjot
      IF lv_fplnr_use IS NOT INITIAL.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = lv_fplnr_use
          IMPORTING
            output = lv_fplnr_use.
      ENDIF.

      IF lv_fpltr_use IS NOT INITIAL.
        lv_fpltr_use2 = lv_fpltr_use.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = lv_fpltr_use2
          IMPORTING
            output = lv_fpltr_use2.
      ENDIF.
* Begin of insert MOD-008++  EXTMBS

*      LOOP AT lay_am_quotation INTO wa_lay_am_quotation.
*        lv_tab = sy-tabix.
*        select single abgru from vbap into lv_abgru
*          where vbeln = nast-objky AND
*                posnr = wa_lay_am_quotation-posnr.
*        if ( sy-subrc = '0' and lv_abgru <> ' ') or sy-subrc <> 0.
*          delete lay_am_quotation index lv_tab.
*        endif.
*      endloop.

*      LOOP AT Lay_am_component INTO wa_lay_am_component.
*        lv_tab = sy-tabix.
*        select single abgru from vbap into lv_abgru
*          where vbeln = nast-objky AND
*                posnr = wa_lay_am_component-posnr.
*        if ( sy-subrc = '0' and lv_abgru <> ' ') or sy-subrc <> 0.
*          delete Lay_am_component index lv_tab.
*        endif.
*      endloop.


      DATA lv_vbeln TYPE vbeln_nach.

*      -----------------

      IF nast-kschl = 'ZAM6' .

*Begin of Insertion MOD-011
        sort lay_am_quotation.
        delete ADJACENT DUPLICATES FROM lay_am_quotation.
*End of Insertion MOD-011

        SELECT SINGLE vbeln FROM vbfa INTO lv_vbeln
           WHERE vbelv = nast-objky
           AND   posnv = '0010'
           AND   vbtyp_n = 'C'.
        IF sy-subrc = 0.
          LOOP AT lay_am_component INTO wa_lay_am_component.
            lv_tab = sy-tabix.
            SELECT SINGLE abgru FROM vbap INTO lv_abgru
               WHERE  vbeln =  lv_vbeln
                AND    matnr = wa_lay_am_component-matnr .
            IF ( sy-subrc = '0' AND lv_abgru <> ' ') .
              DELETE lay_am_component INDEX lv_tab.
            ENDIF.
          ENDLOOP.
        ENDIF.

      ENDIF .

*---------------------------------------

      IF l_land1 EQ 'PL'.

        LOOP AT tvbdpa INTO wa_tvbdpa_extra.
          lv_tab = sy-tabix.
          SELECT SINGLE abgru FROM vbap INTO lv_abgru
            WHERE vbeln = nast-objky AND
                  posnr = wa_tvbdpa_extra-posnr.
          IF ( sy-subrc = '0' AND lv_abgru <> ' ') OR sy-subrc <> 0.
            DELETE tvbdpa INDEX lv_tab.
          ENDIF.
        ENDLOOP.

      ENDIF.

* End of insert MOD-008 EXTMBS

* End of insert MOD-005
      CALL FUNCTION lf_fm_name
           EXPORTING
                      archive_index        = toa_dara
                      archive_parameters   = arc_params
                      control_parameters   = ls_control_param
                      mail_recipient       = ls_recipient
                      mail_sender          = ls_sender
                      output_options       = ls_composer_param
                      user_settings        = space
                      is_nast              = nast
                      is_repeat            = repeat
                      vbdka                = vbdka
                      sadr                 = sadr
                      wa_knvk_contact      = wa_knvk_contact
                      wa_adcp_contact      = wa_adcp_contact
                      wa_tpfkt_contact     = wa_tpfkt_contact
                      wa_veda              = wa_veda
                      wa_vbak              = wa_vbak
                      wa_vbpa_ship_to      = wa_vbpa_ship_to
                      wa_vbpa_bill_to      = wa_vbpa_bill_to
                      is_bil_invoice       = ls_bil_invoice
                      wa_tvgrt             = wa_tvgrt
                      v_fname              = lf_formname
                      w_vat_total          = w_vat_total
                      l_display            = l_display
                      l_faktf              = l_faktf
                      sf_output            = yse_sf_output
                      l_aufnr              = l_aufnr  "is in the
                                          "header of the quotation
                      tot_freight          = w_tot_freight
                      tot_discount         = w_tot_discount
                      tot_netwr            = w_tot_netwr
* begin of insert MOD-003
                      lv_fplnr_use         = lv_fplnr_use
                      lv_fpltr_use         = lv_fpltr_use2
                      lv_fakwr_use         = lv_fakwr_use
                      lv_fproz_use         = lv_fproz_use
                      lv_fkdat_use         = lv_fkdat_use
                      lv_nfdat_use         = lv_nfdat_use
* end of insert MOD-003
           IMPORTING  job_output_info      = ls_job_info
*                     document_output_info =
*                     job_output_options   =
           TABLES     tvbdpa               = tvbdpa
                      tkomser              = tkomser
                      tfpltdr              = tfpltdr
                      tkomv                = tkomv
                      tvbdpa_extra         = it_tvbdpa_extra
                      it_vat               = it_vat
                      it_objk              = it_objk
                      et_operations        = et_tasklist
                      lay_am_quotation     = lay_am_quotation
                      lay_am_operation     = lay_am_operation
                      lay_am_component     = lay_am_component
                      s_kschl_discounts    = s_kschl_discounts
                      s_kschl_markups      = s_kschl_markups
           EXCEPTIONS formatting_error     = 1
                      internal_error       = 2
                      send_error           = 3
                      user_canceled        = 4
                      OTHERS               = 5.

      IF sy-subrc <> 0.
*   error handling
        cf_retcode = sy-subrc.
        PERFORM protocol_update.
* get SmartForm protocoll and store it in the NAST protocoll
        PERFORM add_smfrm_prot.
* begin of change MOD-003
      ELSE.
*...... Update 'print indicator' on billing plan line when payment request is printed
        IF nast-kschl = 'ZAM6' AND proc_screen = ' ' AND ( gv_vbtyp = 'B' OR gv_vbtyp = 'C' ).
          UPDATE fplt SET faksp = 'ZP' WHERE fplnr = lv_fplnr_use
                                          AND fkdat = lv_fkdat_2.
*                                         and fpltr = lv_fpltr_use.

          IF gv_ref = 'X' AND lv_fplnr_use NE gv_fplnr_save.
            UPDATE fplt SET faksp = 'ZP' WHERE fplnr = gv_fplnr_save
                                            AND fkdat = lv_fkdat_2.
*                                           and fpltr = lv_fpltr_use.
          ENDIF.
        ENDIF.
* end of change MOD-003
      ENDIF.
      CLEAR w_vat_total.
    ENDDO.
* get SmartForm spoolid and store it in the NAST protocoll
    DATA ls_spoolid LIKE LINE OF ls_job_info-spoolids.
    LOOP AT ls_job_info-spoolids INTO ls_spoolid.
      IF ls_spoolid NE space.
        PERFORM protocol_update_spool USING '342' ls_spoolid
                                            space space space.

*       MOD-001 - start of modification for PDF output
*        IF nast-kschl = 'ZAM5'.
        IF nast-nacha = '8'.
*         Define variable to build suggested file name
          DATA: lv_fname TYPE string.
*         Build suggested filename
          CONCATENATE wa_vbak-auart
                      '_'
                      wa_vbak-vbeln
                      '.pdf'
                 INTO lv_fname.
*         Call function to convert the spool to a local PDF file
          CALL FUNCTION 'YSE_PRINT_PDF'
            EXPORTING
              ps_spoolid = ls_spoolid
              pv_fname   = lv_fname.
        ENDIF.
*       MOD-001 - end of modif

      ENDIF.
    ENDLOOP.
    ls_composer_param-tdcopies = nast_anzal.
    IF NOT nast_tdarmod IS INITIAL.
      nast-tdarmod = nast_tdarmod.
      CLEAR nast_tdarmod.
    ENDIF.
  ENDIF.


ENDFORM.                    " processing_sf
*&---------------------------------------------------------------------*
*&      Form  set_print_param
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_ADDR_KEY  text
*      -->P_LS_DLV_LAND  text
*      <--P_LS_CONTROL_PARAM  text
*      <--P_LS_COMPOSER_PARAM  text
*      <--P_LS_RECIPIENT  text
*      <--P_LS_SENDER  text
*      <--P_CF_RETCODE  text
*----------------------------------------------------------------------*
FORM set_print_param USING    is_addr_key LIKE addr_key
                              is_dlv-land LIKE vbrk-land1
                     CHANGING cs_control_param TYPE ssfctrlop
                              cs_composer_param TYPE ssfcompop
                              cs_recipient TYPE  swotobjid
                              cs_sender TYPE  swotobjid
                              cf_retcode TYPE sy-subrc.

  DATA: ls_itcpo     TYPE itcpo.
  DATA: lf_repid     TYPE sy-repid.
  DATA: lf_device    TYPE tddevice.
  DATA: ls_recipient TYPE swotobjid.
  DATA: ls_sender    TYPE swotobjid.

  lf_repid = sy-repid.

  CALL FUNCTION 'WFMC_PREPARE_SMART_FORM'
    EXPORTING
      pi_nast       = nast
      pi_country    = is_dlv-land
      pi_addr_key   = is_addr_key
      pi_repid      = lf_repid
      pi_screen     = xscreen
    IMPORTING
      pe_returncode = cf_retcode
      pe_itcpo      = ls_itcpo
      pe_device     = lf_device
      pe_recipient  = cs_recipient
      pe_sender     = cs_sender.

  IF cf_retcode = 0.
    MOVE-CORRESPONDING ls_itcpo TO cs_composer_param.
*   CS_CONTROL_PARAM-NO_OPEN
*   CS_CONTROL_PARAM-NO_CLOSE
    cs_control_param-device      = lf_device.
    cs_control_param-no_dialog   = 'X'.
    cs_control_param-preview     = xscreen.
    cs_control_param-getotf      = ls_itcpo-tdgetotf.
    cs_control_param-langu       = nast-spras.
*   CS_CONTROL_PARAM-REPLANGU1
*   CS_CONTROL_PARAM-REPLANGU2
*   CS_CONTROL_PARAM-REPLANGU3
*   CS_CONTROL_PARAM-STARTPAGE
  ENDIF.

ENDFORM.                    " set_print_param
*&---------------------------------------------------------------------*
*&      Form  add_smfrm_prot
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM add_smfrm_prot .

  DATA: lt_errortab             TYPE tsferror.
* DATA: LF_MSGNR                TYPE SY-MSGNO.
  FIELD-SYMBOLS: <fs_errortab>  TYPE LINE OF tsferror.

* get smart form protocoll
  CALL FUNCTION 'SSF_READ_ERRORS'
    IMPORTING
      errortab = lt_errortab.

* add smartform protocoll to nast protocoll
  LOOP AT lt_errortab ASSIGNING <fs_errortab>.
*   CLEAR LF_MSGNR.
*   LF_MSGNR = <FS_ERRORTAB>-ERRNUMBER.
    CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
         EXPORTING
              msg_arbgb = <fs_errortab>-msgid
*             MSG_NR    = LF_MSGNR
              msg_nr    = <fs_errortab>-msgno
              msg_ty    = <fs_errortab>-msgty
              msg_v1    = <fs_errortab>-msgv1
              msg_v2    = <fs_errortab>-msgv2
              msg_v3    = <fs_errortab>-msgv3
              msg_v4    = <fs_errortab>-msgv4
         EXCEPTIONS
              OTHERS    = 1.
  ENDLOOP.


ENDFORM.                    " add_smfrm_prot
*&---------------------------------------------------------------------*
*&      Form  protocol_update_spool
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_4225   text
*      -->P_LS_SPOOLID  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*      -->P_SPACE  text
*----------------------------------------------------------------------*
FORM protocol_update_spool  USING    syst_msgno
                                     p_ls_spoolid
                                     p_space1
                                     p_space2
                                     p_space3.
  syst-msgid = 'VN'.
  syst-msgno = syst_msgno.
  syst-msgv1 = p_ls_spoolid.
  CONDENSE syst-msgv1.
  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = p_space1
      msg_v3    = p_space2
      msg_v4    = p_space3
    EXCEPTIONS
      OTHERS    = 1.


ENDFORM.                    " protocol_update_spool
*&---------------------------------------------------------------------*
*&      Form  get_data_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_data_sf .

  DATA: us_veda_vbeln     LIKE veda-vbeln.
  DATA: us_veda_posnr_low LIKE veda-vposn.
* Begin of insert MOD-008
  DATA : lv_bukrs TYPE bukrs.
* End of insert MOD-008
  DATA: da_mess LIKE vbfs OCCURS 0 WITH HEADER LINE.

  CALL FUNCTION 'RV_PRICE_PRINT_GET_MODE'
    IMPORTING
      e_print_mode = price_print_mode.

  IF price_print_mode EQ chara.
*in comment AIR22296: 06072007
*    CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
*      TABLES
*        tkomv = tkomv.


    REFRESH tkomv.
    CLEAR tkomv.
  ENDIF.

  CLEAR komk.
  CLEAR komp.

  vbco3-mandt = sy-mandt.
  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DOCUMENT_PRINT_VIEW'
    EXPORTING
      comwa                       = vbco3
    IMPORTING
      kopf                        = vbdka
    TABLES
      pos                         = tvbdpa
      mess                        = da_mess
    EXCEPTIONS
      fehler_bei_datenbeschaffung = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
    retcode = 1.
    EXIT.
  ELSE.
    LOOP AT da_mess.
      sy-msgid = da_mess-msgid.
      sy-msgno = da_mess-msgno.
      sy-msgty = da_mess-msgty.
      sy-msgv1 = da_mess-msgv1.
      sy-msgv2 = da_mess-msgv2.
      sy-msgv3 = da_mess-msgv3.
      sy-msgv4 = da_mess-msgv4.
      PERFORM protocol_update.
    ENDLOOP.
  ENDIF.


* fill address key --> necessary for emails
  addr_key-addrnumber = vbdka-adrnr.
  addr_key-persnumber = vbdka-adrnp.
  addr_key-addr_type  = vbdka-address_type.

* Fetch servicecontract-data and notice-data for head and position.
  us_veda_vbeln     = vbdka-vbeln.
  us_veda_posnr_low = posnr_low.
  CALL FUNCTION 'SD_VEDA_GET_PRINT_DATA'
    EXPORTING
      i_document_number = us_veda_vbeln
      i_language        = sy-langu
      i_posnr_low       = us_veda_posnr_low
    TABLES
      print_data_pos    = tkomservp
      print_data_head   = tkomservh
      print_notice_pos  = tkomservpn
      print_notice_head = tkomservhn.

  PERFORM get_controll_data.

  PERFORM sender.
  PERFORM get_extra_data.
  PERFORM check_repeat.
  PERFORM tvbdpau_create.


ENDFORM.                    " get_data_sf
*&---------------------------------------------------------------------*
*&      Form  header_serv_print_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM header_serv_print_sf .

  CHECK NOT steu-vdkex IS INITIAL.
  READ TABLE tkomservh INDEX 1.
  MOVE tkomservh TO vedka.


ENDFORM.                    " header_serv_print_sf
*&---------------------------------------------------------------------*
*&      Form  item_print_sf
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM item_print_sf .

  DATA: da_subrc LIKE sy-subrc,
        da_dragr LIKE tvag-dragr.
  DATA: da_ganf(1) TYPE c,      "Print flag for billing correction
        da_lanf(1) TYPE c.      "Print flag for billing correction



  LOOP AT tvbdpa.
    vbdpa = tvbdpa.

    IF vbdpa-dragr EQ space.           "Print rejected item?
      IF vbdpa-posnr_neu NE space.     "Item
*        PERFORM get_item_serials.
*        PERFORM get_item_characteristics.
        PERFORM get_item_billing_schedules.
*        PERFORM get_item_prices.
*        PERFORM get_item_addis.
      ENDIF.
    ENDIF.
  ENDLOOP.
  SELECT * FROM konv INTO TABLE tkomv WHERE knumv = vbdka-knumv.
*<<< air22296
ENDFORM.                    " item_print_sf
*&---------------------------------------------------------------------*
*&      Form  get_extra_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_extra_data .
  CLEAR: wa_knvk_contact,
         wa_adcp_contact,
         wa_tpfkt_contact,
         wa_tvbdpa_extra,
         wa_tkomv.

  FREE: it_ztext,
        it_tvbdpa_extra.

  it_tvbdpa_extra[] = tvbdpa[].


  CLEAR vbdka-zterm_tx4.
  SELECT SINGLE text1 FROM t052u INTO vbdka-zterm_tx4
                WHERE zterm EQ vbdka-zterm AND
                      spras EQ nast-spras.
  IF sy-subrc NE 0.
    SELECT SINGLE text1 FROM t052u INTO vbdka-zterm_tx4
                WHERE zterm EQ vbdka-zterm AND
                      spras EQ 'E'.

  ENDIF.


*Get the estimated rental start and end
  SELECT SINGLE * FROM veda INTO wa_veda
            WHERE vbeln EQ vbdka-vbeln AND
                  vposn EQ '000000'.

*Get vbak info
  SELECT SINGLE * FROM vbak INTO wa_vbak
              WHERE vbeln EQ vbdka-vbeln.

*Get the description of the sales group
  SELECT SINGLE * FROM tvgrt INTO wa_tvgrt
             WHERE vkgrp EQ vbdka-vkgrp.

ENDFORM.                    " get_extra_data
*&---------------------------------------------------------------------*
*&      Form  get_data_new
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_PRINT_DATA_TO_READ  text
*      <--P_LS_ADDR_KEY  text
*      <--P_LS_DLV_LAND  text
*      <--P_LS_BIL_INVOICE  text
*      <--P_CF_RETCODE  text
*----------------------------------------------------------------------*
FORM get_data_new
     USING    is_print_data_to_read TYPE lbbil_print_data_to_read
     CHANGING cs_addr_key           LIKE addr_key
              cs_dlv-land           LIKE vbrk-land1
              cs_bil_invoice        TYPE lbbil_invoice
              cf_retcode.


  IF nast-objky+10 NE space.
    nast-objky = nast-objky+16(10).
  ELSE.
    nast-objky = nast-objky.
  ENDIF.


* read print data
  CALL FUNCTION 'LB_BIL_INV_OUTP_READ_PRTDATA'
    EXPORTING
      if_bil_number         = nast-objky
      if_parvw              = nast-parvw
      if_parnr              = nast-parnr
      if_language           = nast-spras
      is_print_data_to_read = is_print_data_to_read
    IMPORTING
      es_bil_invoice        = cs_bil_invoice
    EXCEPTIONS
      records_not_found     = 1
      records_not_requested = 2
      OTHERS                = 3.
  IF sy-subrc <> 0.
*  error handling
    cf_retcode = sy-subrc.
    PERFORM protocol_update.
  ENDIF.

* get nast partner adress for communication strategy
  PERFORM get_addr_key USING    cs_bil_invoice-hd_adr
                       CHANGING cs_addr_key.

* get delivery land
  PERFORM get_dlv-land USING    cs_bil_invoice-hd_gen
                       CHANGING cs_dlv-land.


ENDFORM.                    " get_data_new

*&---------------------------------------------------------------------*
*&      Form  get_addr_key
*&---------------------------------------------------------------------*
FORM get_addr_key USING    it_hd_adr   TYPE lbbil_invoice-hd_adr
                  CHANGING cs_addr_key LIKE addr_key.

  FIELD-SYMBOLS <fs_hd_adr> TYPE LINE OF lbbil_invoice-hd_adr.

  READ TABLE it_hd_adr ASSIGNING <fs_hd_adr>
                       WITH KEY bil_number = nast-objky
                                partn_role = nast-parvw.
  IF sy-subrc = 0.
    cs_addr_key-addrnumber = <fs_hd_adr>-addr_no.
    cs_addr_key-persnumber = <fs_hd_adr>-person_numb.
    cs_addr_key-addr_type  = <fs_hd_adr>-address_type.
  ENDIF.

ENDFORM.                               " get_addr_key

*&---------------------------------------------------------------------*
*&      Form  get_dlv_land
*&---------------------------------------------------------------------*
FORM get_dlv-land USING    it_hd_gen   TYPE lbbil_invoice-hd_gen
                  CHANGING cs_dlv-land LIKE vbrk-land1.

  DATA: ls_address TYPE kna1.

  CALL FUNCTION 'VIEW_KNA1'
    EXPORTING
      kunde     = nast-parnr
    IMPORTING
      anschrift = ls_address
    EXCEPTIONS
      no_kna1   = 1
      OTHERS    = 2.

  IF sy-subrc <> 0.
    PERFORM protocol_update.
  ENDIF.

  cs_dlv-land = ls_address-land1.


ENDFORM.                               " get_dlv_land
*---------------------------------------------------------------------*
*       FORM SET_PRINT_DATA_TO_READ                                   *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*
FORM set_print_data_to_read
         USING    if_formname LIKE tnapr-sform
         CHANGING cs_print_data_to_read TYPE lbbil_print_data_to_read
                  cf_retcode.

  FIELD-SYMBOLS: <fs_print_data_to_read> TYPE xfeld.
  DATA: lt_fieldlist TYPE tsffields.

* set print data requirements
  DO.
    ASSIGN COMPONENT sy-index OF STRUCTURE
                     cs_print_data_to_read TO <fs_print_data_to_read>.
    IF sy-subrc <> 0. EXIT. ENDIF.
    <fs_print_data_to_read> = 'X'.
  ENDDO.

  CALL FUNCTION 'SSF_FIELD_LIST'
    EXPORTING
      formname                = if_formname
*     VARIANT                 = ' '
    IMPORTING
      fieldlist               = lt_fieldlist
   EXCEPTIONS
     no_form                  = 1
     no_function_module       = 2
     OTHERS                   = 3.
  IF sy-subrc <> 0.
*  error handling
    cf_retcode = sy-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SET_PRINT_DATA_TO_READ
*&---------------------------------------------------------------------*
*&      Form  get_extra_data2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_extra_data2 .
*Get the estimated rental start and end
  SELECT SINGLE * FROM veda INTO wa_veda
            WHERE vbeln EQ vbdka-vbeln AND
                  vposn EQ '000000'.

*Get vbak info
  SELECT SINGLE * FROM vbak INTO wa_vbak
              WHERE vbeln EQ vbdka-vbeln.

*Get the description of the sales group
  SELECT SINGLE * FROM tvgrt INTO wa_tvgrt
             WHERE vkgrp EQ vbdka-vkgrp.
ENDFORM.                    " get_extra_data2
*&---------------------------------------------------------------------*
*&      Form  refill_tvbdpa
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM refill_tvbdpa.

  TYPES: BEGIN OF tp_coll_mat,
  matnr TYPE vbrp-matnr,
  netpr TYPE vbrp-netwr,
  netwr TYPE vbrp-netwr,
  kwmeng TYPE vbrp-lmeng,
  END OF tp_coll_mat.
  DATA: wa_coll_mat TYPE tp_coll_mat.
  DATA: it_coll_mat TYPE TABLE OF tp_coll_mat.

  TYPES: BEGIN OF tp_coll,
  netwr TYPE vbrp-netwr,
  END OF tp_coll.

  TYPES: it_coll TYPE TABLE OF tp_coll.

  DATA: it_ser02 TYPE TABLE OF ser02 WITH HEADER LINE.
  DATA: w_kbetr           TYPE kbetr,
         l_mtart TYPE mtart.
  DATA: it_vbdpa TYPE TABLE OF vbdpa,
        wa_tvbdpa_extra0 TYPE vbdpa,
        wa_mara TYPE mara.
  DATA: l_tabix TYPE sy-tabix.

  DATA:
  tvbdpa_extra_sp	TYPE TABLE OF	vbdpa,
  tvbdpa_extra_gr1  TYPE TABLE OF vbdpa,
  tvbdpa_extra_gr2  TYPE TABLE OF vbdpa,
  tvbdpa_extra_gr4  TYPE TABLE OF vbdpa,
  tvbdpa_extra_grmat  TYPE TABLE OF vbdpa,
  tvbdpa_extra_gr3  TYPE TABLE OF vbdpa,
  wa_coll TYPE  tp_coll,
  lv_sp TYPE  char1,
  lv_gr1  TYPE  char1,
  lv_gr2  TYPE  char1,
  lv_gr3  TYPE  char1,
  lv_grmat  TYPE  char1,
  lv_gr4  TYPE  char1,
  wa_tvbdpa_extra_descr TYPE  vbdpa.

  DATA: lay_am_quotation1 TYPE TABLE OF yse_lay_am_quotation.




*determine the flow (fixed rate or costs)
  CLEAR l_faktf.
  SELECT SINGLE faktf INTO l_faktf FROM vbkd
  WHERE vbeln = wa_vbak-vbeln
    AND faktf NE space.
  IF sy-subrc NE 0.                                         "X7 flow
    l_faktf = '01'.
  ENDIF.

  CLEAR l_flow.

  READ TABLE tvbdpa INTO wa_tvbdpa_extra WITH KEY posnr = '0010'.
* Begin of insert MOD-005 Sjot
  IF nast-kschl = 'ZAM6'.


    IF sy-subrc = 0.
      IF wa_tvbdpa_extra-pstyv = 'ZAGE' OR wa_tvbdpa_extra-pstyv = 'ZO05' OR wa_tvbdpa_extra-pstyv = 'ZSC1'
        OR wa_tvbdpa_extra-pstyv = 'ZSC2'
        OR wa_tvbdpa_extra-pstyv = 'ZSC5' "+ MOD-012
* Begin insert MOD-010
        OR wa_tvbdpa_extra-pstyv = 'ZSC4'.
* End of insert MOD-010
        l_flow = 'A'.                                       "'X7'
      ELSEIF wa_tvbdpa_extra-pstyv = 'ZQ01'
      OR wa_tvbdpa_extra-pstyv = 'ZQ02'
        OR wa_tvbdpa_extra-pstyv = 'ZO01' OR wa_tvbdpa_extra-pstyv = 'ZO02'.
        l_flow = 'B'.    "'Xb'
      ENDIF.
    ENDIF.
  ELSE.
* End of insert MOD-005 Sjot
    IF sy-subrc = 0.
      IF wa_tvbdpa_extra-pstyv = 'ZAGE'.
        l_flow = 'A'.                                       "'X7'
      ELSEIF wa_tvbdpa_extra-pstyv = 'ZQ01'
      OR wa_tvbdpa_extra-pstyv = 'ZQ02'.
        l_flow = 'B'.    "'Xb'
      ENDIF.
    ENDIF.
* Begin of insert MOD-005 Sjot
  ENDIF.
* End of insert MOD-005 Sjot


  IF l_faktf = faktf_fixedrate.
    REFRESH lay_am_quotation.
    IF l_flow = 'A'.
* MOD-007 Begin of insert multiple sales order lines
* Check if there is more than 1 line per sales order.
      SELECT * FROM vbap INTO TABLE it_vbap2 WHERE vbeln = vbdka-vbeln.
      DESCRIBE TABLE it_vbap2 LINES line.
      IF line > 1 AND wa_tvbdpa_extra-pstyv <> 'ZSC1' AND wa_tvbdpa_extra-pstyv <> 'ZSC2' AND wa_tvbdpa_extra-pstyv <> 'ZSC4'
        AND wa_tvbdpa_extra-pstyv <> 'ZSC5'. "+ MOD-012
        PERFORM get_data_from_service_order_mu.
      ELSE.
* MOD-007 End of insert multiple sales order lines
*for the X7 flow, the data is coming from the service order:
        PERFORM get_data_from_service_order.
* MOD-007 Begin of insert multiple sales order lines
      ENDIF.
* MOD-007 End of insert multiple sales order lines
    ELSEIF l_flow = 'B'.
*for the Xb flow, the data is coming from the quotation:
      PERFORM get_data_from_quotation.
    ENDIF.


*the zmat materials should be grouped!
    LOOP AT lay_am_quotation INTO wa_lay_am_quotation.
      CLEAR l_mtart.
      SELECT SINGLE mtart INTO l_mtart FROM mara
      WHERE matnr = wa_lay_am_quotation-matnr.

      IF l_mtart = 'ZMAT'.
        READ TABLE lay_am_quotation1 INTO wa_lay_am_quotation0
        WITH KEY matnr = wa_lay_am_quotation-matnr
                 aufnr = wa_lay_am_quotation-aufnr.
        IF sy-subrc = 0.
          wa_lay_am_quotation0-netwr = wa_lay_am_quotation0-netwr +
          wa_lay_am_quotation-netwr.
          wa_lay_am_quotation0-kwmeng = wa_lay_am_quotation0-kwmeng +
          wa_lay_am_quotation-kwmeng.
          MODIFY lay_am_quotation1 INDEX sy-tabix FROM
              wa_lay_am_quotation0
          TRANSPORTING netwr kwmeng.
          CLEAR wa_lay_am_quotation0.
          CLEAR wa_lay_am_quotation.
        ELSE.
          APPEND wa_lay_am_quotation TO lay_am_quotation1.
          CLEAR  wa_lay_am_quotation.
        ENDIF.
      ELSE.
        APPEND wa_lay_am_quotation TO lay_am_quotation1.
        CLEAR  wa_lay_am_quotation.
      ENDIF.
    ENDLOOP.
    lay_am_quotation[] =  lay_am_quotation1[].

  ENDIF. "fixedrate

*get the technical objects:equnr - sernr - location - estimated running
*hours
  SELECT * FROM ser02 INTO TABLE it_ser02
  WHERE sdaufnr EQ wa_vbak-vbeln.
  IF sy-subrc EQ 0.
    SELECT * FROM objk INTO TABLE it_objk
    FOR ALL ENTRIES IN it_ser02
    WHERE obknr EQ it_ser02-obknr.
  ENDIF.


*for ZAM3: we need to group by material number
  IF l_faktf = faktf_costs.
    LOOP AT tvbdpa INTO wa_tvbdpa_extra.
*Grouping necessary, remember ZD02 are the service items (visit)
      CLEAR wa_mara.
      SELECT SINGLE * FROM mara INTO wa_mara
      WHERE matnr EQ wa_tvbdpa_extra-matnr.
      IF wa_mara-mtart EQ 'ZMAT'       "components
      OR wa_mara-matkl = '041010000'   "Labour
      OR wa_mara-matkl = '041020000'   "Mileage
      OR wa_mara-matkl = '041030000'   "Subcontr
      OR wa_mara-matkl = '041040000'.  "Expenses

        wa_coll_mat-matnr = wa_tvbdpa_extra-matnr.
        wa_coll_mat-netpr = wa_tvbdpa_extra-netpr.
        wa_coll_mat-netwr = wa_tvbdpa_extra-netwr.
        wa_coll_mat-kwmeng = wa_tvbdpa_extra-kwmeng.
        COLLECT wa_coll_mat INTO it_coll_mat.
        DELETE TABLE tvbdpa FROM wa_tvbdpa_extra.
        APPEND wa_tvbdpa_extra TO tvbdpa_extra_grmat.
      ENDIF.
      CLEAR wa_coll_mat.
    ENDLOOP.

    IF NOT it_coll_mat[] IS INITIAL.
      CLEAR wa_coll.
      LOOP AT it_coll_mat INTO wa_coll_mat.
        CLEAR: wa_tvbdpa_extra_descr, wa_tvbdpa_extra.
        READ TABLE tvbdpa_extra_grmat INTO wa_tvbdpa_extra_descr
        WITH KEY matnr = wa_coll_mat-matnr.
*we need one posnr to determine the tax rate
        wa_tvbdpa_extra-posnr = wa_tvbdpa_extra_descr-posnr.
        SELECT SINGLE land1 INTO l_land2 FROM  t001
                  WHERE  bukrs  = vbdka-bukrs_vf.

        IF l_land2 = 'RU'.
          SELECT SINGLE maktx INTO wa_tvbdpa_extra-arktx
          FROM makt WHERE matnr = wa_tvbdpa_extra-matnr
                      AND spras = nast-spras.
          IF sy-subrc <> 0 .
            wa_tvbdpa_extra-arktx = wa_tvbdpa_extra_descr-arktx.
          ENDIF.
        ELSE.
          wa_tvbdpa_extra-arktx = wa_tvbdpa_extra_descr-arktx.
        ENDIF.
        CLEAR wa_tvbdpa_extra-netwr.
        wa_tvbdpa_extra-netpr = wa_coll_mat-netpr.
        wa_tvbdpa_extra-netwr = wa_coll_mat-netwr.
        wa_tvbdpa_extra-kwmeng = wa_coll_mat-kwmeng.
        APPEND wa_tvbdpa_extra TO tvbdpa.
      ENDLOOP.
    ENDIF.
  ENDIF.

  PERFORM fill_vat_table.

ENDFORM.                    " refill_tvbdpa
*&---------------------------------------------------------------------*
*&      Form  data_to_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM data_to_display .



  CLEAR yse_sf_output.
  CASE wa_vbak-kvgr1.
    WHEN '006'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
    WHEN '007'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
    WHEN '008'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_kwmeng = 'X'.
      yse_sf_output-v_vrkme = 'X'.
      yse_sf_output-v_netwr = 'X'.
      yse_sf_output-v_netpr = 'X'.
    WHEN '009'.
      yse_sf_output-v_tasklist = 'X'.
    WHEN '010'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_tasklist = 'X'.
    WHEN '011'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_tasklist = 'X'.
    WHEN OTHERS.                                            "'012'.
      yse_sf_output-v_posnr = 'X'.
      yse_sf_output-v_arktx = 'X'.
      yse_sf_output-v_matnr = 'X'.
      yse_sf_output-v_kwmeng = 'X'.
      yse_sf_output-v_vrkme = 'X'.
      yse_sf_output-v_netwr = 'X'.
      yse_sf_output-v_netpr = 'X'.
      yse_sf_output-v_tasklist = 'X'.

  ENDCASE.
ENDFORM.                    " data_to_display
*&---------------------------------------------------------------------*
*&      Form  fill_material_info
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*ONly for fixed price
*for X7 flow: information on spare parts coming from service order
*for Xb flow: information on sparte partes coming from quotation
*----------------------------------------------------------------------*
FORM fill_material_info .




*  IF l_flow = 'X7'.
*    CLEAR tvbdpa. REFRESH tvbdpa.
*    LOOP AT et_components INTO wa_components.
*      wa_tvbdpa_extra-posnr = wa_components-item_number.
*      wa_tvbdpa_extra-matnr = wa_components-material.
*      SELECT SINGLE maktx INTO wa_tvbdpa_extra-arktx
*        FROM makt WHERE matnr = wa_components-material
*                    AND spras = nast-spras.
*      wa_tvbdpa_extra-kwmeng = wa_components-requirement_quantity.
*      wa_tvbdpa_extra-vrkme = wa_components-requirement_quantity_unit.
** not item prices for this flow.
*      APPEND wa_tvbdpa_extra TO tvbdpa.
*      CLEAR wa_tvbdpa_extra.
*    ENDLOOP.
*
*    LOOP AT et_operations INTO wa_operations.
*      wa_tvbdpa_extra-arktx  = wa_operations-description.
*      wa_tvbdpa_extra-kwmeng = wa_operations-quantity.
*      wa_tvbdpa_extra-vrkme  = wa_operations-duration_normal_unit.
*      APPEND wa_tvbdpa_extra TO tvbdpa.
*      CLEAR wa_tvbdpa_extra.
*    ENDLOOP.
*  ENDIF.

ENDFORM.                    " fill_material_info
*&---------------------------------------------------------------------*
*&      Form  get_data_from_service_order
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*first we need the installation and serialnumbers belonging
*to this quotation item
*----------------------------------------------------------------------*
FORM get_data_from_service_order .

  DATA: l_vbeln LIKE vbfa-vbeln,
        l_bstnk TYPE bstnk,
        l_qmnum TYPE qmnum,
        l_sernr TYPE gernr,
        l_equnr TYPE equnr,
        l_eqktx TYPE ktx01,
        teller(6) TYPE n.

  DATA: l_land1               TYPE land1_gp.

  DATA: BEGIN OF it_seo OCCURS 0,
    aufnr TYPE aufnr,
    END OF it_seo.

*Begin of insert ZAM06
  TYPES: BEGIN OF t_vbfa,
           vbelv TYPE vbeln_von,
           vbeln TYPE vbeln_nach,
           posnn TYPE posnr_nach,
         END OF t_vbfa.

  DATA: it_vbfa TYPE TABLE OF t_vbfa WITH HEADER LINE.
  DATA: wa_vbfa TYPE t_vbfa,
        l_vbelv TYPE vbfa-vbelv.
*End of insert ZAM06


  REFRESH it_seo.

  CHECK NOT vbdka-vbeln IS INITIAL.
* Begin of insert ZAM6
  IF nast-kschl = 'ZAM6'.
    IF wa_tvbdpa_extra-pstyv <> 'ZSC1' AND wa_tvbdpa_extra-pstyv <> 'ZSC2'
       AND wa_tvbdpa_extra-pstyv <> 'ZSC5' "+ MOD-012
* Begin of insert MOD-010
      AND wa_tvbdpa_extra-pstyv <> 'ZSC4'
* End of insert MOD-010
      .
      SELECT vbelv vbeln posnn INTO TABLE it_vbfa FROM vbfa
      WHERE vbeln EQ vbdka-vbeln
      AND vbtyp_v IN ('A', 'B', 'C', 'K', 'L').


      LOOP AT it_vbfa.
        CLEAR l_vbelv.
        l_vbelv = it_vbfa-vbelv.
        CLEAR l_qmnum.
        SELECT SINGLE qmnum INTO l_qmnum FROM vbak WHERE vbeln = l_vbelv.
        IF NOT l_qmnum IS INITIAL.
          teller = 10.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF l_qmnum IS INITIAL.
        SELECT SINGLE qmnum INTO l_qmnum FROM vbak
             WHERE vbeln = vbdka-vbeln.
        teller = 10.
      ENDIF.
    ENDIF. " zsc1 ...periodic contracts
  ELSE.
* End of insert ZAM6
*get the notification
    teller = 10.
    CLEAR l_qmnum.
    SELECT SINGLE qmnum INTO l_qmnum FROM vbak
         WHERE vbeln = vbdka-vbeln.
*Begin of insert ZAM6
  ENDIF.
*End of insert ZAM6
*serial number and equipment
  IF ( wa_tvbdpa_extra-pstyv <> 'ZSC1' AND wa_tvbdpa_extra-pstyv <> 'ZSC2'
   AND wa_tvbdpa_extra-pstyv <> 'ZSC5' "+ MOD-012
* Begin of insert MOD-010
      AND wa_tvbdpa_extra-pstyv <> 'ZSC4'
* End of insert MOD-010
      ) OR nast-kschl <> 'ZAM6'.
    CLEAR: l_sernr, l_equnr.
    SELECT SINGLE serialnr equnr INTO (l_sernr, l_equnr)
    FROM viqmel WHERE qmnum = l_qmnum.

    CLEAR l_eqktx.
    SELECT SINGLE eqktx  INTO l_eqktx
    FROM eqkt WHERE equnr = l_equnr
    AND spras = nast-spras.

    IF sy-subrc NE 0.
      SELECT SINGLE eqktx  INTO l_eqktx
      FROM eqkt WHERE equnr = l_equnr.
    ENDIF.

* begin of insertion MOD-002*******************************
    DATA wa_vbap TYPE vbap.
    SELECT SINGLE * FROM vbap INTO wa_vbap
      WHERE vbeln = wa_vbak-vbeln.

    wa_lay_am_quotation-posnr  = wa_vbap-posnr.
    wa_lay_am_quotation-arktx  = wa_vbap-arktx.
    wa_lay_am_quotation-kwmeng  = wa_vbap-kwmeng.
    wa_lay_am_quotation-vrkme  = wa_vbap-vrkme.
    wa_lay_am_quotation-netwr  = wa_vbap-netwr.
*  wa_lay_am_quotation-vbeln  = ls_bil_invoice-hd_gen-bil_number.

*  wa_lay_am_quotation-equnr  = l_qmnum.
    wa_lay_am_quotation-eqktx  = l_eqktx.
    wa_lay_am_quotation-sernr  = l_sernr.

    APPEND wa_lay_am_quotation TO lay_am_quotation.
    CLEAR wa_lay_am_quotation.
** end of insertion MOD-002**********************************

*get the service orders: we can have more than one service order:
    CLEAR l_vbeln.
    SELECT SINGLE vbeln INTO l_vbeln FROM vbfa
                     WHERE vbelv =  vbdka-vbeln
                       AND vbtyp_n = 'C'.
    IF sy-subrc = 0.
      SELECT aufnr FROM aufk APPENDING TABLE it_seo WHERE kdauf = l_vbeln.
    ENDIF.

*service orders with qoutation as sales doc
    SELECT aufnr FROM aufk APPENDING TABLE it_seo
      WHERE kdauf = vbdka-vbeln.
*
*  CLEAR l_aufnr.
*  SELECT SINGLE aufnr INTO l_aufnr FROM viqmel
*  WHERE qmnum = l_qmnum.
    CLEAR: et_tasklist.    REFRESH: et_tasklist.
    CLEAR: et_operations.  REFRESH: et_operations.

    LOOP AT it_seo.
      PERFORM get_seo_get_detail
        USING  it_seo-aufnr.            "using the service order

* begin of insertion MOD-002*******************************
* components
      REFRESH lay_am_component.
      LOOP AT et_components INTO wa_components.
        wa_lay_am_component-posnr = tvbdpa-posnr.
        wa_lay_am_component-matnr = wa_components-material.

        SELECT SINGLE land1 INTO l_land1 FROM  t001
           WHERE  bukrs  = vbdka-bukrs_vf.

        IF l_land1 = 'RU'.
          SELECT SINGLE maktx INTO wa_lay_am_component-arktx
          FROM makt WHERE matnr = wa_components-material
                      AND spras = nast-spras.
          IF sy-subrc <> 0 .
            wa_lay_am_component-arktx = wa_components-matl_desc.
          ENDIF.
        ELSE.
          wa_lay_am_component-arktx = wa_components-matl_desc.
        ENDIF.
        wa_lay_am_component-kwmeng = wa_components-requirement_quantity.
        wa_lay_am_component-vrkme = wa_components-requirement_quantity_unit.
        wa_lay_am_component-netpr = wa_components-price.

* Begin of change MOD-006
        IF nast-kschl = 'ZAM6'.

          SELECT SINGLE * INTO wa_yse_ens FROM yse_ens
          WHERE vkorg = wa_vbak-vkorg
            AND vtweg = wa_vbak-vtweg
            AND kunnr = wa_vbak-kunnr.
          IF sy-subrc = 0.
            CLEAR lv_ens_matnr.
            SELECT SINGLE kdmat INTO lv_ens_matnr FROM knmt
              WHERE vkorg = wa_vbak-vkorg
              AND kunnr = wa_vbak-kunnr
              AND vtweg = wa_vbak-vtweg
              AND matnr = wa_components-material.
          ELSE.
            CLEAR lv_ens_matnr.
          ENDIF.
          IF lv_ens_matnr IS NOT INITIAL.
            wa_lay_am_component-aufnr = lv_ens_matnr.
          ELSE.
            wa_lay_am_component-aufnr = ' '.
          ENDIF.
        ENDIF.

*        START OF MOD-009
        DATA: lv_vbeln TYPE vbeln_nach,
              lv_abgru TYPE abgru,
              c_06(2) TYPE c VALUE '06'.
        IF nast-kschl = 'ZAM6'.
          SELECT SINGLE abgru FROM vbap INTO lv_abgru
          WHERE vbeln = l_vbeln
          AND matnr = wa_components-material
          AND posnr = wa_components-item_number.
          IF NOT  lv_abgru = c_06.
*        END OF MOD-009
            APPEND wa_lay_am_component TO lay_am_component.
*     START OF MOD-009
          ENDIF.
        ELSE.
          APPEND wa_lay_am_component TO lay_am_component.
        ENDIF.
        CLEAR lv_abgru.
*        END OF MOD -009
        CLEAR wa_lay_am_component.
* End of change MOD-006
      ENDLOOP.
* operations
      REFRESH lay_am_operation.
      LOOP AT et_operations INTO wa_operations.
        IF NOT wa_operations-work_activity IS INITIAL.
          wa_lay_am_operation-posnr = tvbdpa-posnr.
          wa_lay_am_operation-arktx = wa_operations-description.
          wa_lay_am_operation-kwmeng = wa_operations-work_activity.
          wa_lay_am_operation-vrkme = wa_operations-duration_normal_unit.
          APPEND wa_lay_am_operation TO lay_am_operation.
          CLEAR wa_lay_am_operation.
        ENDIF.
      ENDLOOP.
* Begin of insert MOD-006
      CLEAR compline.
      DESCRIBE TABLE et_components LINES compline.
      IF compline > 0.
        SELECT SINGLE land1 INTO l_land1 FROM  t001
               WHERE  bukrs  = vbdka-bukrs_vf.

        IF l_land1 = 'RU'.
          CLEAR wa_lay_am_operation.
          CLEAR lay_am_operation.
          wa_lay_am_operation-posnr = tvbdpa-posnr.
          wa_lay_am_operation-arktx = text-i05.
          APPEND wa_lay_am_operation TO lay_am_operation.
          CLEAR wa_lay_am_operation.
          wa_lay_am_operation-posnr = tvbdpa-posnr.
          wa_lay_am_operation-arktx = text-i06.
          APPEND wa_lay_am_operation TO lay_am_operation.
          CLEAR wa_lay_am_operation.
        ENDIF.
      ENDIF.
* End of insert MOD-006

* end of insertion MOD-002*******************************
*    LOOP AT et_components INTO wa_components.
*      wa_lay_am_quotation-vbeln = vbdka-vbeln.
*      wa_lay_am_quotation-posnr = teller.
*      wa_lay_am_quotation-aufnr = it_seo-aufnr.
*      wa_lay_am_quotation-equnr = l_qmnum.
*      wa_lay_am_quotation-eqktx = l_eqktx.
*      wa_lay_am_quotation-sernr = l_sernr.
*      wa_lay_am_quotation-matnr = wa_components-material.
*      SELECT SINGLE maktx INTO wa_lay_am_quotation-arktx
*        FROM makt WHERE matnr = wa_components-material
*                    AND spras = nast-spras.
*      IF sy-subrc NE 0.
*        SELECT SINGLE maktx INTO wa_lay_am_quotation-arktx
*        FROM makt WHERE matnr = wa_components-material
*                  AND spras = 'E'.
*      ENDIF.
*      wa_lay_am_quotation-kwmeng = wa_components-requirement_quantity.
*      wa_lay_am_quotation-vrkme = wa_components-requirement_quantity_unit.
**     APPEND wa_lay_am_quotation TO lay_am_quotation.
*      CLEAR wa_lay_am_quotation.
*    ENDLOOP.

*    LOOP AT et_operations INTO wa_operations
*       WHERE control_key = 'ZCO3'
*         AND duration_normal_unit = 'STD'.
*      wa_lay_am_quotation-vbeln = vbdka-vbeln.
*      wa_lay_am_quotation-posnr = teller.
*      wa_lay_am_quotation-aufnr = it_seo-aufnr.
*      wa_lay_am_quotation-equnr = l_qmnum.
*      wa_lay_am_quotation-eqktx = l_eqktx.
*      wa_lay_am_quotation-sernr = l_sernr.
*      wa_lay_am_quotation-arktx   = wa_operations-description.
*      CLEAR wa_lay_am_quotation-matnr.
*      wa_lay_am_quotation-kwmeng = wa_operations-work_activity.
*      wa_lay_am_quotation-vrkme  = wa_operations-duration_normal_unit.
**      APPEND wa_lay_am_quotation TO lay_am_quotation.
*      CLEAR wa_lay_am_quotation.
*    ENDLOOP.
      ADD 10 TO teller.
    ENDLOOP.
    PERFORM calculate_price_x7.


    READ TABLE it_seo INDEX 1.
    l_aufnr = it_seo-aufnr.

  ELSE. "Periodic Contract /ZC01/ item category ZSC1


    wa_lay_am_quotation-posnr  = 10.
    wa_lay_am_quotation-arktx  = ' '.
    wa_lay_am_quotation-kwmeng  = 0.
    wa_lay_am_quotation-vrkme  =  ' '.

    SELECT * FROM vbkd INTO TABLE it_vbkd
      WHERE vbeln = vbdka-vbeln.

    CLEAR lv_netwr_use.
    CLEAR lv_netwr.
    LOOP AT it_vbkd.
      SELECT SINGLE netwr FROM fplt INTO lv_netwr
        WHERE fplnr = it_vbkd-fplnr AND
*              fpltr = lv_fpltr_use.
              fkdat = lv_fkdat_2.
      IF sy-subrc = 0.
        lv_netwr_use = lv_netwr_use + lv_netwr.
      ENDIF.
    ENDLOOP.

    wa_lay_am_quotation-netwr = lv_netwr_use.
* Begin of insertion by MOD-012
    IF lv_netwr_use IS INITIAL.
*    Do nothing.
      ELSE.
        lv_fakwr_use = lv_netwr_use.
    ENDIF.
* End of insertion by MOD-012
*    lv_fakwr_use = lv_netwr_use. "-MOD-012

    wa_lay_am_quotation-eqktx  = l_eqktx.
    wa_lay_am_quotation-sernr  = l_sernr.

    APPEND wa_lay_am_quotation TO lay_am_quotation.
    CLEAR wa_lay_am_quotation.
  ENDIF.

ENDFORM.                    " get_data_from_service_order
* SUBROUTINE get_data_from_service_order BACKUP ****************************
FORM get_data_from_service_order2  .

  DATA: l_vbeln LIKE vbfa-vbeln,
        l_bstnk TYPE bstnk,
        l_qmnum TYPE qmnum,
        l_sernr TYPE gernr,
        l_equnr TYPE equnr,
        l_eqktx TYPE ktx01,
        teller(6) TYPE n.

  DATA: BEGIN OF it_seo OCCURS 0,
    aufnr TYPE aufnr,
    END OF it_seo.

  DATA:    l_land1               TYPE land1_gp.

  REFRESH it_seo.

  CHECK NOT vbdka-vbeln IS INITIAL.

*get the notification
  teller = 10.
  CLEAR l_qmnum.
  SELECT SINGLE qmnum INTO l_qmnum FROM vbak
       WHERE vbeln = vbdka-vbeln.

*serial number and equipment
  CLEAR: l_sernr, l_equnr.
  SELECT SINGLE serialnr equnr INTO (l_sernr, l_equnr)
  FROM viqmel WHERE qmnum = l_qmnum.

  CLEAR l_eqktx.
  SELECT SINGLE eqktx  INTO l_eqktx
  FROM eqkt WHERE equnr = l_equnr
  AND spras = nast-spras.

  IF sy-subrc NE 0.
    SELECT SINGLE eqktx  INTO l_eqktx
    FROM eqkt WHERE equnr = l_equnr.
  ENDIF.

*get the service orders: we can have more than one service order:
  CLEAR l_vbeln.
  SELECT SINGLE vbeln INTO l_vbeln FROM vbfa
                   WHERE vbelv =  vbdka-vbeln
                     AND vbtyp_n = 'C'.
  IF sy-subrc = 0.
    SELECT aufnr FROM aufk APPENDING TABLE it_seo WHERE kdauf = l_vbeln.
  ENDIF.

*service orders with qoutation as sales doc
  SELECT aufnr FROM aufk APPENDING TABLE it_seo
    WHERE kdauf = vbdka-vbeln.
*
*  CLEAR l_aufnr.
*  SELECT SINGLE aufnr INTO l_aufnr FROM viqmel
*  WHERE qmnum = l_qmnum.
  CLEAR: et_tasklist.    REFRESH: et_tasklist.
  CLEAR: et_operations.  REFRESH: et_operations.

  LOOP AT it_seo.
    PERFORM get_seo_get_detail
      USING  it_seo-aufnr.            "using the service order
    LOOP AT et_components INTO wa_components.
      wa_lay_am_quotation-vbeln = vbdka-vbeln.
      wa_lay_am_quotation-posnr = teller.
      wa_lay_am_quotation-aufnr = it_seo-aufnr.
      wa_lay_am_quotation-equnr = l_qmnum.
      wa_lay_am_quotation-eqktx = l_eqktx.
      wa_lay_am_quotation-sernr = l_sernr.
      wa_lay_am_quotation-matnr = wa_components-material.
      SELECT SINGLE maktx INTO wa_lay_am_quotation-arktx
        FROM makt WHERE matnr = wa_components-material
                    AND spras = nast-spras.
      IF sy-subrc NE 0.
        SELECT SINGLE maktx INTO wa_lay_am_quotation-arktx
        FROM makt WHERE matnr = wa_components-material
                  AND spras = 'E'.
      ENDIF.
      wa_lay_am_quotation-kwmeng = wa_components-requirement_quantity.
      wa_lay_am_quotation-vrkme = wa_components-requirement_quantity_unit.
* not item prices for this flow.
      APPEND wa_lay_am_quotation TO lay_am_quotation.
      CLEAR wa_lay_am_quotation.
    ENDLOOP.
    LOOP AT et_operations INTO wa_operations
       WHERE control_key = 'ZCO3'
         AND duration_normal_unit = 'STD'.
      wa_lay_am_quotation-vbeln = vbdka-vbeln.
      wa_lay_am_quotation-posnr = teller.
      wa_lay_am_quotation-aufnr = it_seo-aufnr.
      wa_lay_am_quotation-equnr = l_qmnum.
      wa_lay_am_quotation-eqktx = l_eqktx.
      wa_lay_am_quotation-sernr = l_sernr.
      wa_lay_am_quotation-arktx   = wa_operations-description.
      CLEAR wa_lay_am_quotation-matnr.
      wa_lay_am_quotation-kwmeng = wa_operations-work_activity.
      wa_lay_am_quotation-vrkme  = wa_operations-duration_normal_unit.
      APPEND wa_lay_am_quotation TO lay_am_quotation.
      CLEAR wa_lay_am_quotation.
    ENDLOOP.
    ADD 10 TO teller.
  ENDLOOP.


* Begin of insert MOD-006

  SELECT SINGLE land1 INTO l_land1 FROM  t001
           WHERE  bukrs  = vbdka-bukrs_vf.

  IF l_land1 = 'RU'.
    CLEAR wa_lay_am_operation.
*    clear lay_am_operation[].
    wa_lay_am_operation-posnr = tvbdpa-posnr.
    wa_lay_am_operation-arktx = text-i05.
    APPEND wa_lay_am_operation TO lay_am_operation.
    CLEAR wa_lay_am_operation.
    wa_lay_am_operation-posnr = tvbdpa-posnr.
    wa_lay_am_operation-arktx = text-i06.
    APPEND wa_lay_am_operation TO lay_am_operation.
    CLEAR wa_lay_am_operation.
  ENDIF.
* End of insert MOD-006

  PERFORM calculate_price_x7.

  READ TABLE it_seo INDEX 1.
  l_aufnr = it_seo-aufnr.

ENDFORM.                    " get_data_from_service_order
*&---------------------------------------------------------------------*
*&      Form  get_seo_get_detail
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ET_OPERATIONS  text
*      -->P_L_AUFNR  text
*----------------------------------------------------------------------*
FORM get_seo_get_detail
                    USING lo_aufnr.
  DATA:
  l_aufnr  TYPE  bapi_alm_order_header_e-orderid,
  et_partner  LIKE  bapi_alm_order_partner OCCURS 0,
  et_relations  LIKE  bapi_alm_order_relation_export OCCURS 0,
  et_texts  LIKE  bapi_alm_text OCCURS 0,
  et_text_lines LIKE  bapi_alm_text_lines OCCURS 0,
  et_prts LIKE  bapi_alm_order_prt_e OCCURS 0,
  et_costs_sum  LIKE  bapi_alm_order_costs_sum_e OCCURS 0,
  et_costs_details  LIKE  bapi_alm_order_costs_detail_e OCCURS 0,
  return  LIKE  bapiret2 OCCURS 0,
  extension_in  LIKE  bapiparex,
  extension_out LIKE  bapiparex.



  CHECK NOT lo_aufnr IS INITIAL.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lo_aufnr
    IMPORTING
      output = lo_aufnr.


  CALL FUNCTION 'BAPI_ALM_ORDER_GET_DETAIL'
    EXPORTING
      number           = lo_aufnr
    TABLES
      et_partner       = et_partner
      et_operations    = et_operations
      et_components    = et_components
      et_relations     = et_relations
      et_texts         = et_texts
      et_text_lines    = et_text_lines
      et_prts          = et_prts
      et_costs_sum     = et_costs_sum
      et_costs_details = et_costs_details
      return           = return.

*  DELETE et_operations WHERE NOT control_key = 'ZCO3'.
*  DELETE et_operations WHERE NOT duration_normal_unit = 'STD'.
  APPEND LINES OF et_operations TO et_tasklist.

*  EXTMBS

*  TYPES: BEGIN OF TY_RESB,                                   " CD1K963262
*          RSPOS TYPE RESB-RSPOS,
*          XLOEK TYPE RESB-XLOEK,
*          MATNR TYPE RESB-MATNR,
*          AUFNR TYPE RESB-AUFNR,
*        END OF TY_RESB.
*
*  DATA: IT_RESB TYPE TABLE OF TY_RESB WITH HEADER LINE.
  SELECT rspos xloek matnr aufnr FROM resb INTO TABLE it_resb WHERE aufnr = lo_aufnr.

  LOOP AT it_resb WHERE xloek = 'X'.
    DELETE et_components WHERE res_item = it_resb-rspos AND material = it_resb-matnr.

  ENDLOOP.

ENDFORM.                    " get_seo_get_detail
*&---------------------------------------------------------------------*
*&      Form  fill_vat_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_vat_table .

  DATA: wa_vat  TYPE  yse_vat,
        l_vat_char  TYPE  char2.

  DATA: l_vat TYPE stceg.
  DATA: num TYPE p DECIMALS 2.

* MOD-004 Begin of insert
  DATA: lv_bukrs TYPE bukrs.

  CLEAR lv_bukrs.

  SELECT SINGLE bukrs INTO lv_bukrs FROM tvko  WHERE vkorg = vbdka-vkorg.
  IF sy-subrc EQ 0.
    IF lv_bukrs = 'MRUA'.

      REFRESH : it_vat.
      CLEAR   : it_vat.
      LOOP AT tkomv WHERE kschl = 'MWR1'.
        num = tkomv-kbetr / 10.
        WRITE num TO wa_vat-vat LEFT-JUSTIFIED.
        IF nast-kschl = 'ZAM4'.
          READ TABLE tvbdpa INTO wa_tvbdpa_extra
          WITH KEY posnr = tkomv-kposn.
          wa_vat-kawrt = wa_tvbdpa_extra-netwr.
          wa_vat-kwert =  wa_tvbdpa_extra-netwr * num / 100.
        ELSE.
          wa_vat-kawrt = tkomv-kawrt.
          wa_vat-kwert = tkomv-kwert.
        ENDIF.
        COLLECT wa_vat INTO it_vat.
      ENDLOOP.

    ELSE.
* MOD-004 end of insert
      REFRESH : it_vat.
      CLEAR   : it_vat.
      LOOP AT tkomv WHERE kschl = 'MWST'.
        num = tkomv-kbetr / 10.
        WRITE num TO wa_vat-vat LEFT-JUSTIFIED.
        IF nast-kschl = 'ZAM4'.
          READ TABLE tvbdpa INTO wa_tvbdpa_extra
          WITH KEY posnr = tkomv-kposn.
          wa_vat-kawrt = wa_tvbdpa_extra-netwr.
          wa_vat-kwert =  wa_tvbdpa_extra-netwr * num / 100.
        ELSE.
          wa_vat-kawrt = tkomv-kawrt.
          wa_vat-kwert = tkomv-kwert.
        ENDIF.
        COLLECT wa_vat INTO it_vat.
      ENDLOOP.
* MOD-004 Begin of insert
    ENDIF.
  ENDIF.
* MOD-004 End of insert


  LOOP AT it_vat INTO wa_vat.

    w_vat_total = w_vat_total + wa_vat-kwert.
    l_vat = wa_vat-vat.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = l_vat
      IMPORTING
        output = l_vat_char.
    SHIFT l_vat_char RIGHT DELETING TRAILING ','.
    SHIFT l_vat_char RIGHT DELETING TRAILING '.'.
    wa_vat-vat = l_vat_char.


    WRITE wa_vat-kawrt TO wa_vat-kawrt_c LEFT-JUSTIFIED CURRENCY vbdka-waers.
    WRITE wa_vat-kwert TO wa_vat-kwert_c LEFT-JUSTIFIED CURRENCY vbdka-waers.


    MODIFY it_vat FROM wa_vat.
  ENDLOOP.

ENDFORM.                    " fill_vat_table
*&---------------------------------------------------------------------*
*&      Form  get_data_from_quotation
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_data_from_quotation.

  DATA: l_vbelv LIKE vbfa-vbelv,
        l_vbeln LIKE vbfa-vbeln,
        l_bstnk TYPE bstnk,
        l_qmnum TYPE qmnum,
        l_sernr TYPE gernr,
        l_equnr TYPE equnr,
        l_eqktx TYPE ktx01,
        teller(6) TYPE n.

  TYPES: BEGIN OF t_vbfa,
    vbelv TYPE vbeln_von,
    vbeln TYPE vbeln_nach,
    posnn TYPE posnr_nach,
         END OF t_vbfa.

  DATA: it_vbfa TYPE TABLE OF t_vbfa.
  DATA: wa_vbfa TYPE t_vbfa.
  DATA: BEGIN OF it_seo OCCURS 0,
    aufnr TYPE aufnr,
    END OF it_seo.

  REFRESH it_seo.
*Begin of change MOD-005 Sjot
* Sjot XB flow VBFA only for inquiry when printing from Sales Document
  IF nast-kschl = 'ZAM6'.
*first we get the preceding Inquiry: only works for XB flow

    CLEAR it_vbfa.  REFRESH it_vbfa.
    SELECT vbelv vbeln posnn INTO TABLE it_vbfa FROM vbfa
    WHERE vbeln EQ vbdka-vbeln
      AND vbtyp_v IN ('A', 'B', 'K', 'L')
      AND NOT ( vbtyp_v = 'B' AND vbtyp_n = 'C' ).
  ELSE.
    CLEAR it_vbfa.  REFRESH it_vbfa.
    SELECT vbelv vbeln posnn INTO TABLE it_vbfa FROM vbfa
    WHERE vbeln EQ vbdka-vbeln
      AND vbtyp_v IN ('A', 'B', 'K', 'L').
  ENDIF.
*End of change MOD-005 Sjot
  IF sy-subrc = 0.
  ELSE.
    wa_vbfa-vbelv = wa_vbak-vbeln.
    wa_vbfa-vbeln = vbdka-vbeln.
    APPEND wa_vbfa TO it_vbfa.
  ENDIF.


  teller = 10.

  SORT it_vbfa.
  LOOP AT it_vbfa INTO wa_vbfa.

    AT NEW vbelv.
*get the notification
      CLEAR l_qmnum.
      SELECT SINGLE qmnum INTO l_qmnum FROM vbak
           WHERE vbeln = wa_vbfa-vbelv.

      CLEAR: l_sernr, l_equnr.
      SELECT SINGLE serialnr equnr INTO (l_sernr, l_equnr)
      FROM viqmel WHERE qmnum = l_qmnum.

      CLEAR l_eqktx.
      SELECT SINGLE eqktx  INTO l_eqktx
      FROM eqkt WHERE equnr = l_equnr
      AND spras = nast-spras.

      IF sy-subrc NE 0.
        SELECT SINGLE eqktx  INTO l_eqktx
        FROM eqkt WHERE equnr = l_equnr.
      ENDIF.

**get the service orders
      CLEAR l_aufnr.
      SELECT aufnr APPENDING TABLE it_seo FROM viqmel
      WHERE qmnum = l_qmnum.

*get the service orders: we can have more than one service order:
      CLEAR l_vbeln.
      SELECT SINGLE vbeln INTO l_vbeln FROM vbfa
                       WHERE vbelv =  vbdka-vbeln
                         AND vbtyp_n = 'C'.
      IF sy-subrc = 0.
        SELECT aufnr FROM aufk APPENDING TABLE it_seo WHERE kdauf = l_vbeln.
      ENDIF.

*service orders with qoutation as sales doc
      SELECT aufnr FROM aufk APPENDING TABLE it_seo
        WHERE kdauf = vbdka-vbeln.

      CLEAR: et_tasklist.    REFRESH: et_tasklist.
      CLEAR: et_operations.  REFRESH: et_operations.

      SORT it_seo.
      DELETE ADJACENT DUPLICATES FROM it_seo.

      LOOP AT it_seo.  "there will always be only one, just to make it
*                       flexible
        PERFORM get_seo_get_detail USING  it_seo-aufnr.
        LOOP AT tvbdpa INTO wa_tvbdpa_extra.
          wa_lay_am_quotation-vbeln = vbdka-vbeln.
          wa_lay_am_quotation-posnr = wa_tvbdpa_extra-posnr.
          wa_lay_am_quotation-equnr = l_equnr.
          wa_lay_am_quotation-aufnr = it_seo-aufnr.
          wa_lay_am_quotation-eqktx = l_eqktx.
          wa_lay_am_quotation-sernr = l_sernr.
          SELECT SINGLE land1 INTO l_land2 FROM  t001
                    WHERE  bukrs  = vbdka-bukrs_vf.

          IF l_land2 = 'RU'.
            SELECT SINGLE maktx INTO wa_tvbdpa_extra-arktx
            FROM makt WHERE matnr = wa_tvbdpa_extra-matnr
                        AND spras = nast-spras.
            IF sy-subrc <> 0 .
              wa_lay_am_quotation-arktx = wa_tvbdpa_extra-arktx.
            ENDIF.
          ELSE.
            wa_lay_am_quotation-arktx = wa_tvbdpa_extra-arktx.
          ENDIF.

          wa_lay_am_quotation-matnr = wa_tvbdpa_extra-matnr.
          wa_lay_am_quotation-kwmeng = wa_tvbdpa_extra-kwmeng.
          wa_lay_am_quotation-vrkme = wa_tvbdpa_extra-vrkme.
          wa_lay_am_quotation-netpr = wa_tvbdpa_extra-netpr.
          wa_lay_am_quotation-netwr = wa_tvbdpa_extra-netwr.
          APPEND wa_lay_am_quotation TO lay_am_quotation.
          CLEAR wa_lay_am_quotation.
        ENDLOOP.
      ENDLOOP.
    ENDAT.
  ENDLOOP.

  PERFORM calculate_price.

ENDFORM.                    " get_data_from_quotation
*&---------------------------------------------------------------------*
*&      Form  calculate_price
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*As well as for calculated, as well as for fixed, we will calculate
*the price
*----------------------------------------------------------------------*
FORM calculate_price .

  DATA: l_vat TYPE  stceg,
        w_discount TYPE yse_dec4,
        wa_komv TYPE konv,
        l_freight TYPE kwert,
        l_kbetr TYPE kbetr,
        w_tot_line_netwr TYPE netwr.

* Begin of insert MOD-004
  DATA: lv_bukrs TYPE bukrs.
* End of insert MOD-004

  CLEAR: w_tot_freight, w_tot_discount, w_tot_netwr,
  l_freight, w_tot_line_netwr.


  LOOP AT lay_am_quotation INTO wa_lay_am_quotation.

* Begin of insert MOD-004
    CLEAR lv_bukrs.
    SELECT SINGLE bukrs INTO lv_bukrs FROM tvko  WHERE vkorg = vbdka-vkorg.
    IF sy-subrc EQ 0.
      IF lv_bukrs = 'MRUA'.
        READ TABLE tkomv WITH KEY kposn = wa_lay_am_quotation-posnr
        kschl = 'MWR1'.
        IF sy-subrc = 0.
          l_vat = tkomv-kbetr / 1000.
        ENDIF.
      ELSE.
* End of insert MOD-004

*First calculate the VAT pct
        READ TABLE tkomv WITH KEY kposn = wa_lay_am_quotation-posnr
        kschl = 'MWST'.
        IF sy-subrc = 0.
          l_vat = tkomv-kbetr / 1000.
        ENDIF.

* Begin of insert MOD-004
      ENDIF.
    ENDIF.
* End of insert MOD-004


*take the netwr and add the vat:
    w_tot_line_netwr = wa_lay_am_quotation-netwr.

*    w_tot_line_netwr =
*    w_tot_line_netwr + w_tot_line_netwr * l_vat.

*extract the freight from every item and sum it together:
    SELECT SINGLE kwert INTO l_freight FROM konv
    WHERE knumv = wa_vbak-knumv
    AND kposn = wa_lay_am_quotation-posnr
    AND kschl = 'ZD00'.

*    l_freight = l_freight + l_freight * l_vat.
    ADD l_freight TO w_tot_freight.
    w_tot_line_netwr = w_tot_line_netwr - l_freight.

*add also the discount (before taxes)
    CLEAR: w_discount.
    LOOP AT tkomv INTO wa_komv
    WHERE kposn EQ wa_lay_am_quotation-posnr
      AND kschl IN s_kschl_discounts.
      IF wa_komv-kwert < 0.
        w_discount = w_discount + wa_komv-kwert.
      ELSE.
        w_discount = w_discount - wa_komv-kwert.
      ENDIF.
    ENDLOOP.

*    w_discount = w_discount + w_discount * l_vat.
*    ADD w_discount TO w_tot_discount.
*    w_tot_line_netwr  = w_tot_line_netwr - w_discount.
    ADD w_tot_line_netwr TO w_tot_netwr.

    wa_lay_am_quotation-netpr = w_tot_line_netwr.
*for the net unit price we devide by the qty: issue 3528
    IF wa_lay_am_quotation-kwmeng IS NOT INITIAL.
      wa_lay_am_quotation-netwr = w_tot_line_netwr /
      wa_lay_am_quotation-kwmeng.
    ENDIF.
    l_kbetr = w_tot_line_netwr.
    MODIFY lay_am_quotation FROM wa_lay_am_quotation.
  ENDLOOP.

ENDFORM.                    " calculate_price
*&---------------------------------------------------------------------*
*&      Form  calculate_price_x7
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*For X7 flow: FP quotation with information on spare parts coming from
*service order
*----------------------------------------------------------------------*
FORM calculate_price_x7 .

  DATA: l_vat TYPE  stceg,
        w_discount TYPE yse_dec4,
        wa_komv TYPE konv,
        l_freight TYPE kwert,
        l_kbetr TYPE kbetr,
        w_tot_line_netwr TYPE netwr,
        it_vbap TYPE TABLE OF vbap,
        wa_vbap TYPE vbap.
* Begin of insert MOD-004
  DATA: lv_bukrs TYPE bukrs.
* End of insert MOD-004

  CLEAR: w_tot_freight, w_tot_discount, w_tot_netwr, l_freight,
w_tot_line_netwr.

  CLEAR it_vbap.  REFRESH it_vbap.
  SELECT * FROM vbap INTO TABLE it_vbap WHERE vbeln = vbdka-vbeln.

  LOOP AT it_vbap INTO wa_vbap.

* Begin of insert MOD-004
    CLEAR lv_bukrs.
    SELECT SINGLE bukrs INTO lv_bukrs FROM tvko  WHERE vkorg = vbdka-vkorg.
    IF sy-subrc EQ 0.
      IF lv_bukrs = 'MRUA'.

*First calculate the VAT pct
        READ TABLE tkomv WITH KEY kposn = wa_vbap-posnr
        kschl = 'MWR1'.
        IF sy-subrc = 0.
          l_vat = tkomv-kbetr / 1000.
        ENDIF.
      ELSE.
* End of insert MOD-004
        READ TABLE tkomv WITH KEY kposn = wa_vbap-posnr
        kschl = 'MWST'.
        IF sy-subrc = 0.
          l_vat = tkomv-kbetr / 1000.
        ENDIF.
* Begin of insert MOD-004
      ENDIF.
    ENDIF.
* End of insert MOD-004

*take the netwr and add the vat:
    w_tot_line_netwr = wa_vbap-netwr.

*    w_tot_line_netwr =
*    w_tot_line_netwr + w_tot_line_netwr * l_vat.

*extract the freight from every item and sum it together:
    SELECT SINGLE kwert INTO l_freight FROM konv
    WHERE knumv = wa_vbak-knumv
    AND kposn = wa_vbap-posnr
    AND kschl = 'ZD00'.

*    l_freight = l_freight + l_freight * l_vat.
    ADD l_freight TO w_tot_freight.
    w_tot_line_netwr = w_tot_line_netwr - l_freight.

*add also the discount (before taxes)
    CLEAR: w_discount.
    LOOP AT tkomv INTO wa_komv
    WHERE kposn EQ wa_vbap-posnr
      AND kschl IN s_kschl_discounts.
      IF wa_komv-kwert < 0.
        w_discount = w_discount + wa_komv-kwert.
      ELSE.
        w_discount = w_discount - wa_komv-kwert.
      ENDIF.
    ENDLOOP.

*    w_discount = w_discount + w_discount * l_vat.
*    ADD w_discount TO w_tot_discount.
*    w_tot_line_netwr  = w_tot_line_netwr - w_discount.
    ADD w_tot_line_netwr TO w_tot_netwr.

*for the net unit price we devide by the qty: issue 3528
    IF wa_vbap-kwmeng IS NOT INITIAL.
      wa_vbap-netwr = w_tot_line_netwr /
      wa_vbap-kwmeng.
    ENDIF.
    l_kbetr = w_tot_line_netwr.
  ENDLOOP.


ENDFORM.                    " calculate_price_x7
*&---------------------------------------------------------------------*
*&      Form  fill_discount_markup_table
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_discount_markup_table .
  DATA: wa_kschl          TYPE          yse_kschl.
*fill discount table
*Fill all the discount conditions
  wa_kschl-sign = 'I'.
  wa_kschl-option = 'EQ'.
*Z098
  wa_kschl-low = 'Z098'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z099
  wa_kschl-low = 'Z099'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z102
  wa_kschl-low = 'Z102'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z103
  wa_kschl-low = 'Z103'.
  APPEND wa_kschl TO s_kschl_discounts.
*Z104
  wa_kschl-low = 'Z104'.
  APPEND wa_kschl TO s_kschl_discounts.
*ZK04
  wa_kschl-low = 'ZK04'.
  APPEND wa_kschl TO s_kschl_discounts.
*R101
  wa_kschl-low = 'RA01'.
  APPEND wa_kschl TO s_kschl_discounts.

*Fill markup table
  wa_kschl-sign = 'I'.
  wa_kschl-option = 'EQ'.

  wa_kschl-low = 'Z100'.
  APPEND wa_kschl TO s_kschl_markups.

  wa_kschl-low = 'Z101'.
  APPEND wa_kschl TO s_kschl_markups.

ENDFORM.                    " fill_discount_markup_table

* MOD-007 Begin of insert multiple sales order lines
FORM get_data_from_service_order_mu.

  DATA: l_vbeln LIKE vbfa-vbeln,
        l_bstnk TYPE bstnk,
        l_qmnum TYPE qmnum,
        l_sernr TYPE gernr,
        l_equnr TYPE equnr,
        l_eqktx TYPE ktx01,
        teller(6) TYPE n.

  DATA wa_vbap TYPE vbap.

  DATA: l_land1               TYPE land1_gp.

  DATA: BEGIN OF it_seo OCCURS 0,
     aufnr TYPE aufnr,
     kdpos TYPE kdpos,
    END OF it_seo.

*Begin of insert ZAM06
  TYPES: BEGIN OF t_vbfa,
           vbelv TYPE vbeln_von,
           vbeln TYPE vbeln_nach,
           posnn TYPE posnr_nach,
         END OF t_vbfa.

  DATA: it_vbfa TYPE TABLE OF t_vbfa WITH HEADER LINE.
  DATA: wa_vbfa TYPE t_vbfa,
        l_vbelv TYPE vbfa-vbelv.
*End of insert ZAM06


  REFRESH it_seo.

  CHECK NOT vbdka-vbeln IS INITIAL.
* Begin of insert ZAM6
  IF nast-kschl = 'ZAM6'.
    SELECT vbelv vbeln posnn INTO TABLE it_vbfa FROM vbfa
    WHERE vbeln EQ vbdka-vbeln
    AND vbtyp_v IN ('A', 'B', 'C', 'K', 'L').


    LOOP AT it_vbfa.
      CLEAR l_vbelv.
      l_vbelv = it_vbfa-vbelv.
      CLEAR l_qmnum.
      SELECT SINGLE qmnum INTO l_qmnum FROM vbak WHERE vbeln = l_vbelv.
      IF NOT l_qmnum IS INITIAL.
        teller = 10.
        EXIT.
      ENDIF.
    ENDLOOP.
    IF l_qmnum IS INITIAL.
      SELECT SINGLE qmnum INTO l_qmnum FROM vbak
           WHERE vbeln = vbdka-vbeln.
*      teller = 10.
    ENDIF.
  ELSE.
* End of insert ZAM6
*get the notification
*    teller = 10.
    CLEAR l_qmnum.
    SELECT SINGLE qmnum INTO l_qmnum FROM vbak
         WHERE vbeln = vbdka-vbeln.
*Begin of insert ZAM6
  ENDIF.
*End of insert ZAM6
*

*get the service orders: we can have more than one service order:
  CLEAR l_vbeln.
  SELECT SINGLE vbeln INTO l_vbeln FROM vbfa
                   WHERE vbelv =  vbdka-vbeln
                     AND vbtyp_n = 'C'.
  IF sy-subrc = 0.
    SELECT aufnr kdpos FROM aufk APPENDING TABLE it_seo WHERE kdauf = l_vbeln.
  ENDIF.

*service orders with qoutation as sales doc
  SELECT aufnr kdpos FROM aufk APPENDING TABLE it_seo
    WHERE kdauf = vbdka-vbeln.
*
*  CLEAR l_aufnr.
*  SELECT SINGLE aufnr INTO l_aufnr FROM viqmel
*  WHERE qmnum = l_qmnum.
  CLEAR: et_tasklist.    REFRESH: et_tasklist.
  CLEAR: et_operations.  REFRESH: et_operations.
  REFRESH lay_am_component.
  REFRESH lay_am_operation.
  LOOP AT it_seo.
    PERFORM get_seo_get_detail
      USING  it_seo-aufnr.            "using the service order


    CLEAR wa_vbap.
    SELECT SINGLE * FROM vbap INTO wa_vbap
      WHERE vbeln = wa_vbak-vbeln
          AND posnr = it_seo-kdpos.

*serial number and equipment by selecting the proper notification
    CLEAR l_qmnum.
    SELECT SINGLE qmnum
    INTO (l_qmnum) FROM afih
    WHERE aufnr = it_seo-aufnr.

    CLEAR: l_sernr, l_equnr.
    SELECT SINGLE serialnr equnr INTO (l_sernr, l_equnr)
    FROM viqmel WHERE qmnum = l_qmnum.

    CLEAR l_eqktx.
    SELECT SINGLE eqktx  INTO l_eqktx
    FROM eqkt WHERE equnr = l_equnr
    AND spras = nast-spras.

    IF sy-subrc NE 0.
      SELECT SINGLE eqktx  INTO l_eqktx
      FROM eqkt WHERE equnr = l_equnr.
    ENDIF.


    wa_lay_am_quotation-posnr  = wa_vbap-posnr.
    wa_lay_am_quotation-arktx  = wa_vbap-arktx.
    wa_lay_am_quotation-kwmeng  = wa_vbap-kwmeng.
    wa_lay_am_quotation-vrkme  = wa_vbap-vrkme.
    wa_lay_am_quotation-netwr  = wa_vbap-netwr.
*  wa_lay_am_quotation-vbeln  = ls_bil_invoice-hd_gen-bil_number.

*  wa_lay_am_quotation-equnr  = l_qmnum.
    wa_lay_am_quotation-eqktx  = l_eqktx.
    wa_lay_am_quotation-sernr  = l_sernr.

    APPEND wa_lay_am_quotation TO lay_am_quotation.
    CLEAR wa_lay_am_quotation.



* components
    LOOP AT et_components INTO wa_components.
      wa_lay_am_component-posnr = wa_vbap-posnr.
      wa_lay_am_component-matnr = wa_components-material.

      SELECT SINGLE land1 INTO l_land1 FROM  t001
           WHERE  bukrs  = vbdka-bukrs_vf.

      IF l_land1 = 'RU'.
        SELECT SINGLE maktx INTO wa_lay_am_component-arktx
        FROM makt WHERE matnr = wa_components-material
                    AND spras = nast-spras.
        IF sy-subrc <> 0 .
          wa_lay_am_component-arktx = wa_components-matl_desc.
        ENDIF.
      ELSE.
        wa_lay_am_component-arktx = wa_components-matl_desc.
      ENDIF.
      wa_lay_am_component-kwmeng = wa_components-requirement_quantity.
      wa_lay_am_component-vrkme = wa_components-requirement_quantity_unit.
      wa_lay_am_component-netpr = wa_components-price.
      APPEND wa_lay_am_component TO lay_am_component.
      CLEAR wa_lay_am_component.
* Begin of change MOD-006
      IF nast-kschl = 'ZAM6'.

*        select single * into wa_yse_ens from yse_ens
*        where VKORG = wa_vbak-VKORG
*          and VTWEG = wa_vbak-VTWEG
*          and KUNNR = wa_vbak-KUNNR.
*        if sy-subrc = 0.
*          clear lv_ENS_matnr.
*          select single KDMAT into lv_ENS_matnr from knmt
*            where VKORG = wa_vbak-VKORG
*            and KUNNR = wa_vbak-kunnr
*            and VTWEG = wa_vbak-VTWEG
*            and MATNR = wa_components-material.
*        else.
*          clear lv_ENS_matnr.
*        endif.
*        if lv_ENS_matnr is not initial.
*          wa_lay_am_component-posnr = wa_vbap-posnr.
*          concatenate text-t04 lv_ENS_matnr into wa_lay_am_component-arktx separated by ' '.
*          APPEND wa_lay_am_component TO lay_am_component.
*          CLEAR wa_lay_am_component.
*        endif.
      ENDIF.

* End of change MOD-006
    ENDLOOP.
* operations

    LOOP AT et_operations INTO wa_operations.
      IF NOT wa_operations-work_activity IS INITIAL.
        wa_lay_am_operation-posnr = wa_vbap-posnr.
        wa_lay_am_operation-arktx = wa_operations-description.
        wa_lay_am_operation-kwmeng = wa_operations-work_activity.
        wa_lay_am_operation-vrkme = wa_operations-duration_normal_unit.
        APPEND wa_lay_am_operation TO lay_am_operation.
        CLEAR wa_lay_am_operation.
      ENDIF.
    ENDLOOP.
* Begin of insert MOD-006
    CLEAR compline.
    DESCRIBE TABLE et_components LINES compline.
    IF compline > 0.
      SELECT SINGLE land1 INTO l_land1 FROM  t001
             WHERE  bukrs  = vbdka-bukrs_vf.

      IF l_land1 = 'RU'.
        CLEAR wa_lay_am_operation.
        CLEAR lay_am_operation.
        wa_lay_am_operation-posnr = wa_vbap-posnr.
        wa_lay_am_operation-arktx = text-i05.
        APPEND wa_lay_am_operation TO lay_am_operation.
        CLEAR wa_lay_am_operation.
        wa_lay_am_operation-posnr = wa_vbap-posnr.
        wa_lay_am_operation-arktx = text-i06.
        APPEND wa_lay_am_operation TO lay_am_operation.
        CLEAR wa_lay_am_operation.
      ENDIF.
    ENDIF.
* End of insert MOD-006

*    ADD 10 TO teller.
  ENDLOOP.
  PERFORM calculate_price_x7.


  READ TABLE it_seo INDEX 1.
  l_aufnr = it_seo-aufnr.


ENDFORM.                    " get_data_from_service_order

* MOD-007 End of insert multiple sales order lines
*Text symbol text£º
*I05:§ª§ã§á§à§Ý§î§Ù§à§Ó§Ñ§ß§ß§í§Ö §Þ§Ñ§ä§Ö§â§Ú§Ñ§Ý§í
*I06:(§Ó§Ü§Ý§ð§é§Ö§ß§í §Ó §ã§ä§à§Ú§Þ§à§ã§ä§î §å§ã§Ý§å§Ô)
*I07:§®§Ö§ã.
*T04:§¬§à§Õ §¦§¯§³:
