*----------------------------------------------------------------------*
*                                                                      *
* PROGRAM ID           : YSE_CRM_SALESF_SEO(copied from YAM_I011)      *
* PROGRAM TITLE        : Stand Alone ServiceOrder Idoc Program for     *
*                        Salesforce                                    *
* AUTHOR               : Geert Rutten                                  *
* DATE                 : 05/01/2011                                    *
* DEVELOPMENT ID       : XXXX                                          *
*                                                                      *
* CHANGE REQUEST NUMBER:                                               *
* PROGRAM DESCRIPTION  : THIS IS A CUSTOM PROGRAM TO GENERATE THE      *
*                        SERVICE ORDER OUTBOUND IDOC FROM SAP TO       *
*                        Salesforce.THIS PROGRAM CHECKS ONLY FOR       *
*                        THE ORDERS                                    *
*                        WHICH HAVE CREATED OR RELEASED STATUS.        *
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 |22/12/2011| Geert Rutten  | CD1K969533      | meas. doc from*
*                                                        order         *
************************************************************************
REPORT  yse_crm_salesf_seo NO STANDARD PAGE HEADING MESSAGE-ID yam_inf.

************************************************************************
*                  D A T A B A S E   T A B L E S                       *
************************************************************************
TABLES:  aufk,               "Order master data
         afko,               "Order master data
         afih,               "Maintenance order header
         caufv,              "View "Order Headers PP/CO"
         resb,               "Reservation/dependent requirements
         qmel,               "Quality Notification
         adrc,               "Addresses (Business Address Services)
         ihpa,               "Plant Maintenance: Partnersa
         kna1,               "Customer Master
         pmsdo,              "PM organizational data for SD documents
         edidc,              "Control record (EDI Intermediate Document)
         edidd,               "Data record (IDoc)
         edids,               "Status Record (IDoc)
         yse_e1_slsf_hdr_seo,   "HEADER SEGMENT FOR SERVICE ORDER IDOC
         yam_io11_status, "table for check status in order to send parts
         iloa,               "functional locations
         iflotx,             "description of functional locations
         yse_slsf_seo.

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************
*     ORDER HEADER DATA TABLE                                          *
************************************************************************

DATA: g_fm_atinn type ausp-atinn,
      g_fm_atinn2 type ausp-atinn,
      lv_equnr TYPE equnr.

* Begin of insert MOD-001

DATA: BEGIN OF ls_msdoc occurs 0,
        readg LIKE imrg-readg,
        readgi LIKE imrg-recdu,
      END OF ls_msdoc.

* End of insert MOD-001
DATA : BEGIN OF i_ord_head OCCURS 0,
       werks LIKE aufk-werks,
       aufnr LIKE aufk-aufnr,
       erdat LIKE aufk-erdat,
       aedat LIKE aufk-aedat,
       objnr LIKE aufk-objnr,
       gstrs LIKE afko-gstrs,
       priok LIKE afko-aprio,
       kunum LIKE qmel-kunum,
       ilart LIKE afih-ilart,
       equi_name1 LIKE adrc-name1,
       equi_street LIKE adrc-street,
       equi_city1  LIKE adrc-city1,
       equi_country LIKE adrc-country,
       equi_post_code1 LIKE adrc-post_code1,
       equi_region LIKE adrc-region,
       equi_matnr LIKE riwol-matnr,
       equi_sernr LIKE riwol-sernr,
       flag(1) TYPE c ,
       zzcon LIKE aufk-zzcon,
       zzsdc LIKE aufk-zzsdc,
       ingpr LIKE afih-ingpr,
       ernam LIKE aufk-ernam,
       bemot LIKE aufk-bemot,
       bstkd type bstkd,
       zzapc LIKE aufk-zzapc,
       zzpsf LIKE aufk-zzpsf,
       zztrc LIKE aufk-zztrc,
       bukrs LIKE aufk-bukrs,
       iwerk LIKE afih-iwerk,
       anlzu LIKE afih-anlzu,
       equnr LIKE viqmel-equnr,
       ktext LIKE caufv-ktext,
       kdauf LIKE viqmel-kdauf,
       qmnum LIKE afih-qmnum,
       runhours TYPE yrunhours,
       loadhours TYPE yloadhours,
       ltxa1     LIKE afvc-ltxa1,
       isdd      LIKE afru-isdd,
END OF i_ord_head.

DATA:  g_pfile         like      /sapdmc/lsoinp-filename,
       g_ofile         like      /sapdmc/lsoinp-filename,
       g_delsetupfile  like rlgrap-filename,
       g_retcd         like sy-subrc,
       g_ersda(12)     type c,                  " YYYYMMDDHHMM
       g_directory(25) type c value '/var/load/xxx/UK/convert/',
       lv_aufnr        type aufk-aufnr,
       lv_aufnr_high   type aufk-aufnr,
       lv_aufnr_low   type aufk-aufnr,
       lv_next        type c.

DATA:  g_objeq        like imptt-mpobj.

DATA: lv_first TYPE C VALUE 'X'.


DATA: it_aufnr TYPE TABLE OF aufk-aufnr.

DATA : BEGIN OF i_prev OCCURS 0.
        include structure YSE_E1_SLSF_HDR_SEO.
DATA : END OF i_prev.

DATA : BEGIN OF it_yse_e1_slsf_hdr_seo OCCURS 0.
        include structure YSE_E1_SLSF_HDR_SEO.
data:  knumv like vbak-knumv,
       objnr like vbak-objnr.
DATA : END OF it_yse_e1_slsf_hdr_seo.

DATA : BEGIN OF i_delfiles OCCURS 0,
         mandt like YSE_SLSF_SEO-mandt,
         werks like YSE_SLSF_SEO-werks,
         ersda like YSE_SLSF_SEO-ersda,
       END OF i_delfiles.

DATA : BEGIN OF it_yse_e1_slsf_hdr_seo_delta OCCURS 0.
        include structure YSE_E1_SLSF_HDR_SEO.
DATA : END OF it_yse_e1_slsf_hdr_seo_delta.
************************************************************************
*    ORDER SYSTEM STATUS TABLE                                         *
************************************************************************

DATA : BEGIN OF i_status OCCURS 0,
       objnr LIKE jest-objnr,
       stat LIKE jstat-stat,
       inact LIKE jstat-inact,
       END OF i_status.

DATA :BEGIN OF i_ihpa OCCURS 0,
       objnr LIKE aufk-objnr,
       parnr LIKE ihpa-parnr,
       parvw LIKE ihpa-parvw,
       sortl LIKE kna1-sortl,
       kunnr LIKE kna1-kunnr,
       name1 LIKE kna1-name1,
       street LIKE kna1-stras,
       city1 LIKE kna1-ort01,
       adrnr like ihpa-adrnr,
       adrnr_kna1 like kna1-adrnr,
       post_code1 LIKE kna1-pstlz,
       country LIKE kna1-land1,
       END OF i_ihpa.

DATA: BEGIN OF  i_iriwol OCCURS 100.
        INCLUDE STRUCTURE  riwol .
DATA: END OF i_iriwol.

DATA : BEGIN OF gt_afko OCCURS 0,
         rsnum like afko-rsnum,
       END OF gt_afko.
DATA : g_tplnr like iloa-tplnr,
       g_iloan like iloa-iloan,
       g_pltxt like iflotx-pltxt.
data : g_bukrs LIKE aufk-bukrs.

DATA : begin of wa_YSE_SLSF_SEO,
         mandt like YSE_SLSF_SEO-mandt,
         werks like YSE_SLSF_SEO-werks,
         ersda like YSE_SLSF_SEO-ersda,
       end of wa_YSE_SLSF_SEO.

************************************************************************
*    Internal Table and Work area                                      *
************************************************************************

TYPES:BEGIN OF ty_afru,
      aufnr TYPE afru-aufnr,
      isdd TYPE afru-isdd,
      END   OF ty_afru.


DATA: i_edidc_control_comm LIKE edidc OCCURS 1 WITH HEADER LINE.
DATA: i_edidd_data LIKE edidd OCCURS 0 WITH HEADER LINE.
DATA: i_edids LIKE edids OCCURS 0 WITH HEADER LINE.
DATA: wa_yse_e1_slsf_hdr_seo LIKE yse_e1_slsf_hdr_seo.
DATA: wa_edidc_control LIKE edidc,
      wa_edidc LIKE edidc                                       ,
      wa_ctr_delta like it_yse_e1_slsf_hdr_seo,
      wa_ctr_hdr LIKE YSE_E1_SLSF_HDR_SEO,
      p_logsys LIKE tbdlst-logsys.
DATA: wa_ord_cls_date TYPE sy-datum ,
      wa_aufk_objnr TYPE aufk-objnr ,
      wa_jest_chgnr TYPE jest-chgnr,
************************************************************************
* for the sortl field when service order is closed *
* 15.12.2004
************************************************************************
      wa_sortl TYPE kna1-sortl.
************************************************************************

DATA lt_ADRC type table of ADRC.
DATA ls_ADRC like line of lt_ADRC.
DATA it_AFRU type table of ty_afru with header line.

**
*CONSTANTS
CONSTANTS :c_ord_header(19) TYPE c VALUE 'YSE_E1_SLSF_HDR_SEO',
           c_idoc_type  LIKE edidc-idoctp VALUE 'YSE_SLSF_SEO',
           c_plant LIKE aufk-werks VALUE 'GBAA',
           c_mestyp LIKE edidc-mestyp VALUE 'YSE_CRM_SALESF_SEO',
           c_yse_salesf_seo(14)     type c     value 'YSE_SALESF_SEO',
           c_sc1(3) VALUE 'SC1',
           c_input VALUE '0',
           c_underscore(1)   type c     value '_',    " Underscore
           c_ls(2) VALUE 'LS',
           c_status(4) VALUE 'XXXX',
           c_ie(2)        type c          value 'IE',
           c_x VALUE 'X',
           c_t VALUE 'T' ,
           c_e          type spras value 'E',
           c_d(1)            type c     value 'D',    " Delete
           c_c(1)            type c     value 'C',    " Change
           c_a(1)            type c     value 'A',    " Add
           c_remark(50) VALUE 'Compressor Spares for the AtlasCopco Service visit',
           c_0000(4)    TYPE c     VALUE '0000',
           c_run_hours    type impt-atnam value 'ZAM_RHRSTOTAL_ACT',
           c_loaded_hours type impt-atnam value 'ZAM_RHRSLOADED',
           c_99991231   like sy-datum value '99991231'.

************************************************************************
*                   V A R I A B L E S / C O N S T A N T S              *
************************************************************************

DATA: l_index LIKE sy-tabix,
      l_index1 LIKE sy-tabix,
      l_index2 LIKE sy-tabix,
      l_flag(1),
      l_flag1(1),
      g_stat(6) TYPE c,
      g_istat type j_status,
      g_flag_reopened(1) type c,
      g_chgd(1),
      g_idoc_sent(1),
      g_date LIKE sy-datum,
     adrnr LIKE adrc-addrnumber,
     aufnr LIKE afko-aufnr,
     l_status(15),
     l_flag2(1),
     l_flag3(1),
     l_vbeln TYPE vbak-vbeln.


************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************

SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
SELECT-OPTIONS: s_aufnr FOR afko-aufnr .
SELECT-OPTIONS: s_erdat FOR aufk-erdat .
SELECT-OPTIONS: s_werks FOR aufk-werks OBLIGATORY  DEFAULT c_plant .
PARAMETER: p_inwer LIKE aufk-werks.
SELECT-OPTIONS: s_auart FOR aufk-auart .
*MESSAGE SYSTEM
PARAMETERS: p_mestyp LIKE edmsg-msgtyp DEFAULT c_mestyp MODIF ID sc1.
*DESTINATION SYSTEM
*PARAMETERS: P_LOGSYS LIKE TBDLST-LOGSYS OBLIGATORY .
SELECTION-SCREEN: END OF BLOCK b1.



************************************************************************
*      INITIALIZE THE CREATION DATE FIELD OF SERVICE ORDER             *
*      S_ERDAT-LOW WILL HOLD THE DATE OF 2 DAYS EARLIER THAN THE       *
*      SYSTEM DATE AND S_ERDAT-HIGH WILL HOLD THE TODAY'S DATE VALUE   *
*      BY DEFAULT.USER CAN CHANGE THIS AS PER CONVINANCE               *
************************************************************************

INITIALIZATION.
  g_date = sy-datum - 1.
  MOVE: 'BT' TO s_erdat-option,
         g_date TO s_erdat-low,
         g_date TO s_erdat-high.
  APPEND s_erdat.


  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = p_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

************************************************************************
*      MODIFY THE SELECTION SCREEN BY MAKING THE INPUT FIELDS AS       *
*      READALE                                                         *
************************************************************************
AT SELECTION-SCREEN OUTPUT.

  LOOP AT SCREEN.
    IF screen-group1 = c_sc1.
      screen-input   = c_input.
      MODIFY SCREEN.
      CONTINUE.
    ENDIF.
  ENDLOOP.

************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.
************************************************************************
*      CLEAR THE WORK AREA AND INTERNAL TABLES                         *
************************************************************************
  CLEAR: wa_yse_e1_slsf_hdr_seo,
         i_edidc_control_comm,
         i_edidd_data.





************************************************************************
*CHECK IF IDOC CONFIGURATION IS READY AND IDOC CAN BE PROCESSED.       *
************************************************************************

  CALL FUNCTION 'ALE_MODEL_DETERMINE_IF_TO_SEND'
    EXPORTING
      message_type           = p_mestyp
    IMPORTING
      idoc_must_be_sent      = g_idoc_sent
    EXCEPTIONS
      own_system_not_defined = 1
      OTHERS                 = 2.

  IF sy-subrc <> 0.
    MESSAGE e029 WITH c_mestyp.
    EXIT.
  ENDIF.

************************************************************************
*          FILL CONTROL RECORDS                                        *
************************************************************************

  wa_edidc_control-mestyp = p_mestyp.
  wa_edidc_control-idoctp = c_idoc_type.
  wa_edidc_control-rcvprt = c_ls.


  LOOP AT s_werks.

    CLEAR it_yse_e1_slsf_hdr_seo[].
    CLEAR i_ord_head[].
    REFRESH i_ord_head.
    REFRESH it_yse_e1_slsf_hdr_seo.
************************************************************************
*  SELECT SERVICE ORDER HEADER DATA                                    *
************************************************************************

    if p_inwer is initial.

      SELECT werks aufnr erdat aedat objnr gstrs zzcon zzsdc ernam
             bemot
             zzapc zzpsf zztrc ktext
           INTO  CORRESPONDING FIELDS OF i_ord_head FROM caufv
           WHERE aufnr IN s_aufnr
           AND   auart IN s_auart
           AND   werks IN s_werks
           and   erdat in s_erdat
           or    aufnr IN s_aufnr
           AND   auart IN s_auart
           and   werks in s_werks
           and   aedat in s_erdat.

************************************************************************
*         VALIDATION FOR SERVICE ORDER                                 *
************************************************************************
        IF sy-subrc NE 0.
          MESSAGE e024 .
        ENDIF.
************************************************************************
*         CHECK FOR THE SERVICE ORDER IN BETWEEN DATE                  *
************************************************************************
        IF sy-subrc EQ 0.
          APPEND i_ord_head.
          CLEAR i_ord_head.
        ENDIF.
      ENDSELECT.

      perform PROCESS_ORDERS.

    else.

      SELECT aufnr from AUFK into table it_aufnr where
         werks = p_inwer and aufnr in s_aufnr order by aufnr descending.

      READ TABLE it_aufnr into lv_aufnr index 1.
      if sy-subrc = 0.

       if s_aufnr-low is initial.
        lv_aufnr_low = '004000000000'.
       else.
        lv_aufnr_low = s_aufnr-low.
       endif.
* intial load needs to be done in more than 1 run because of memory reasons... lv_next = 'X' indicates that this is not the first part so that it has to retrieve
* the previous outputfile to add the records.
       if lv_aufnr_low <> '004000000000'.
         lv_next = 'X'.
       endif.

        WHILE lv_aufnr_low < lv_aufnr.

          clear s_aufnr[].
          s_aufnr-sign = 'I'.
          s_aufnr-option = 'BT'.


          s_aufnr-low  = lv_aufnr_low.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = s_aufnr-low
            IMPORTING
              OUTPUT = s_aufnr-low.

          s_aufnr-high = lv_aufnr_low + 4999.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = s_aufnr-high
            IMPORTING
              OUTPUT = s_aufnr-high.

          APPEND s_aufnr.


          SELECT werks aufnr erdat aedat objnr gstrs zzcon zzsdc ernam
               bemot
               zzapc zzpsf zztrc ktext
             INTO  CORRESPONDING FIELDS OF TABLE i_ord_head FROM caufv
             WHERE aufnr IN s_aufnr
             AND   auart IN s_auart
             AND   werks IN s_werks
             and   erdat in s_erdat
             or    aufnr IN s_aufnr
             AND   auart IN s_auart
             and   werks in s_werks
             and   aedat in s_erdat.


          perform PROCESS_ORDERS.
          REFRESH i_ord_head.
          FREE i_ord_head.
          lv_aufnr_low = s_aufnr-high + 1.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              INPUT  = lv_aufnr_low
            IMPORTING
              OUTPUT = lv_aufnr_low.
***********************
    if not it_yse_e1_slsf_hdr_seo[] is initial.


        loop at it_yse_e1_slsf_hdr_seo.
          move-corresponding it_yse_e1_slsf_hdr_seo to it_yse_e1_slsf_hdr_seo_delta.
          move c_a to it_yse_e1_slsf_hdr_seo_delta-msgfn.
          append it_yse_e1_slsf_hdr_seo_delta.
          clear it_yse_e1_slsf_hdr_seo_delta.
        endloop.

*     write outputfile to application server
* First batch/range of service orders to be processed... than we create the outputfile but only when its the first time we do an initial load...
* otherwise (lv_next = 'X') we retrieve the previous outputfile of the previous initial load.
      if lv_first = 'X'.
        if lv_next = 'X'.
          clear g_ersda.
         select ersda into g_ersda
          from YSE_SLSF_SEO where werks = s_werks-low.
         endselect.

         if g_ersda is not initial.
           CONCATENATE c_yse_salesf_seo s_werks-low g_ersda
                      INTO g_ofile separated by c_underscore.
         endif.
        else.
         CONCATENATE sy-datum sy-uzeit(4) into g_ersda.
         CONCATENATE c_yse_salesf_seo s_werks-low g_ersda
                 INTO g_ofile separated by c_underscore.
        endif.
       REPLACE 'xxx' IN g_directory WITH p_logsys(3).
       CONCATENATE g_directory g_ofile INTO g_ofile.
       lv_first = ' '.
      endif.
      perform write_outputfile_app.
      REFRESH it_yse_e1_slsf_hdr_seo.
      FREE it_yse_e1_slsf_hdr_seo.
    endif.
**************************
        ENDWHILE.

      endif.
    endif.


* * * * * * * * * *
    if not it_yse_e1_slsf_hdr_seo[] is initial or p_inwer is not initial.

      if s_werks-low ne p_inwer.

        sort it_yse_e1_slsf_hdr_seo by werks aufnr.

        clear: g_retcd.
        perform get_previous_file using s_werks-low
                               changing g_retcd.

        if g_retcd = 0.
          PERFORM create_delta.
        else.
          CONTINUE.                      " Pass to next S.O.
        endif.
*      else.
*        loop at it_yse_e1_slsf_hdr_seo.
*          move-corresponding it_yse_e1_slsf_hdr_seo to it_yse_e1_slsf_hdr_seo_delta.
*          move c_a to it_yse_e1_slsf_hdr_seo_delta-msgfn.
*          append it_yse_e1_slsf_hdr_seo_delta.
*          clear it_yse_e1_slsf_hdr_seo_delta.
*        endloop.
      endif.

*     write outputfile to application server

    if p_inwer is initial.
      clear g_retcd.

      CONCATENATE sy-datum sy-uzeit(4) into g_ersda.
      CONCATENATE c_yse_salesf_seo s_werks-low g_ersda
                INTO g_ofile separated by c_underscore.

      REPLACE 'xxx' IN g_directory WITH p_logsys(3).
      CONCATENATE g_directory g_ofile INTO g_ofile.

      perform write_outputfile.
    endif.

*      if g_retcd is initial.
*       update custom table YSE_SLSF_SEO
        perform update_custom_table using s_werks-low.

*       Delete older entries in custom table YSE_SLSF_SEO
        PERFORM delete_old_table_entries using s_werks-low.

*       Delete older files on appl.server
        if NOT i_delfiles[] IS INITIAL.
          PERFORM delete_old_files.
        endif.

*      endif.

    endif.
* * * * * * * * * *
  ENDLOOP.

********
********
********
*    REFRESH i_edidc_control_comm.
*
*    CALL FUNCTION 'MASTER_IDOC_DISTRIBUTE'
*      EXPORTING
*        master_idoc_control            = wa_edidc_control
*      TABLES
*        communication_idoc_control     = i_edidc_control_comm
*        master_idoc_data               = i_edidd_data
*      EXCEPTIONS
*        error_in_idoc_control          = 1
*        error_writing_idoc_status      = 2
*        error_in_idoc_data             = 3
*        sending_logical_system_unknown = 4
*        OTHERS                         = 5.
*    IF sy-subrc NE 0.
*      MESSAGE e025.
*    ELSE.
*************************************************************************
**         UPDATE THE CUSTOM DATA WITH THE IDOC DATA SO THAT NEXT       *
**         TIME THERE IS A CHECK FOR THE ALREADY SENT DATA              *
*************************************************************************
*      CLEAR g_stat.
*      IF i_ord_head-flag = c_x.
*        g_stat = text-002.                 "Closed
*      ENDIF.
*      WRITE: / i_ord_head-aufnr, g_stat.
*
*      LOOP AT i_edidc_control_comm.
*        WRITE: 25 text-t03 , i_edidc_control_comm-docnum.
*      ENDLOOP.
*    ENDIF.
  IF  it_yse_e1_slsf_hdr_seo_delta[] IS INITIAL .
    write: / 'No Idocs created'(i03).
  else.

** Generate Idoc's
    sort  it_yse_e1_slsf_hdr_seo_delta by aufnr.
    PERFORM create_idocs.

  ENDIF.

  write: / 'Job finished'(i02).
********
********
********



TOP-OF-PAGE.
*-----------*
  WRITE:/30 text-t02.
  SKIP 3.


*&---------------------------------------------------------------------*
*&      Form  Create_delta
*&---------------------------------------------------------------------*
*       Create internal table with creates/updates/deletes
*----------------------------------------------------------------------*
FORM create_delta.

* creates/updates
  loop at it_yse_e1_slsf_hdr_seo.

    read table i_prev with key aufnr = it_yse_e1_slsf_hdr_seo-aufnr
                    binary search.

    if sy-subrc = 0.
***** MUST BE UPDATED when change in segments YSE_E1_SLSF_HDR_SEO/YSE_E1_SLSF_DTL_SEO
      if it_yse_e1_slsf_hdr_seo(751) <> i_prev(751).
************************************************************************
        move-corresponding it_yse_e1_slsf_hdr_seo to it_yse_e1_slsf_hdr_seo_delta.
        move c_c to it_yse_e1_slsf_hdr_seo_delta-msgfn.
        append it_yse_e1_slsf_hdr_seo_delta.
        clear it_yse_e1_slsf_hdr_seo_delta.
      endif.
    else.
      move-corresponding it_yse_e1_slsf_hdr_seo to it_yse_e1_slsf_hdr_seo_delta.
      move c_a to it_yse_e1_slsf_hdr_seo_delta-msgfn.
      append it_yse_e1_slsf_hdr_seo_delta.
      clear it_yse_e1_slsf_hdr_seo_delta.
    endif.

  endloop.

* deletes
  clear i_prev.
  loop at i_prev.

    read table it_yse_e1_slsf_hdr_seo with key aufnr = i_prev-aufnr
                    binary search.

    if sy-subrc <> 0.
      move-corresponding i_prev to it_yse_e1_slsf_hdr_seo_delta.
      move c_d to it_yse_e1_slsf_hdr_seo_delta-msgfn.
      append it_yse_e1_slsf_hdr_seo_delta.
      clear it_yse_e1_slsf_hdr_seo_delta.
    endif.

  endloop.

ENDFORM.                    " Create_delta

*&---------------------------------------------------------------------*
*&      Form  Get_previous_file
*&---------------------------------------------------------------------*
*       Get file from previous run
*----------------------------------------------------------------------*
FORM get_previous_file using p_werks
                    changing p_retcd.

* prepare filename of previous run
  clear g_ersda.
  select ersda into g_ersda
      from YSE_SLSF_SEO where werks = p_werks.
  endselect.

  if sy-subrc <> 0.
    write: / text-e02, p_werks.    "No filename of previous run
*                                   available in custom table YSE_SLSF_SEO
    p_retcd = 4.
    exit.
  endif.

  CONCATENATE c_yse_salesf_seo p_werks g_ersda
                      INTO g_pfile separated by c_underscore.
  REPLACE 'xxx' IN g_directory WITH p_logsys(3).
  CONCATENATE g_directory g_pfile into g_pfile.

* FILE READ FROM APPLICATION SERVER
  PERFORM get_from_appl TABLES  i_prev
                        USING   g_pfile
                                p_retcd.

ENDFORM.                    " Get_previous_file
*&---------------------------------------------------------------------*
*&      Form  Get_from_appl
*&---------------------------------------------------------------------*
*       Get the file from application server into internal table
*----------------------------------------------------------------------*
FORM get_from_appl TABLES i_infile STRUCTURE i_prev
                   USING p_infile p_subrc.

  OPEN DATASET p_infile FOR INPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc <> 0.
    write: / text-e03, p_infile.
    p_subrc = 4.
    exit.
  ENDIF.

  refresh i_infile.

  DO.
    READ DATASET p_infile INTO i_infile.
    IF sy-subrc <> 0.
      EXIT.
    ENDIF.
    APPEND i_infile.
  ENDDO.
  CLOSE DATASET p_infile.

ENDFORM.                    " GET_FROM_APPL
*&---------------------------------------------------------------------*
*&      Form  Write_outputfile
*&---------------------------------------------------------------------*
*       Write outputfile
*----------------------------------------------------------------------*
FORM write_outputfile.

  open dataset g_ofile for output in text mode encoding default.
  if sy-subrc <> 0.
    write: / text-e03, g_ofile.
*   message e011(YAM_DC).                      "Open dataset failed
    g_retcd = 4.
    exit.
  endif.

  sort it_yse_e1_slsf_hdr_seo by aufnr.

  loop at it_yse_e1_slsf_hdr_seo.
***** MUST BE UPDATED when change in segments YSE_E1_SLSF_HDR_SERVC/YSE_E1_SLSF_DTL_SERVC
    transfer it_yse_e1_slsf_hdr_seo(751) to g_ofile.
***********************************************************************
  endloop.

ENDFORM.                    " Write_outputfile

FORM write_outputfile_app.

  open dataset g_ofile for appending in text mode encoding default.
  if sy-subrc <> 0.
    write: / text-e03, g_ofile.
*   message e011(YAM_DC).                      "Open dataset failed
    g_retcd = 4.
    exit.
  endif.

  sort it_yse_e1_slsf_hdr_seo by aufnr.

  loop at it_yse_e1_slsf_hdr_seo.
***** MUST BE UPDATED when change in segments YSE_E1_SLSF_HDR_SERVC/YSE_E1_SLSF_DTL_SERVC
    transfer it_yse_e1_slsf_hdr_seo(751) to g_ofile.
***********************************************************************
  endloop.

  close dataset g_ofile.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  Update_custom_table
*&---------------------------------------------------------------------*
*       Update custom table YSE_SLSF_SEO
*----------------------------------------------------------------------*
FORM update_custom_table using p_werks.

  wa_YSE_SLSF_SEO-mandt = sy-mandt.
  wa_YSE_SLSF_SEO-werks = p_werks.
  wa_YSE_SLSF_SEO-ersda = g_ersda.

  insert YSE_SLSF_SEO from wa_YSE_SLSF_SEO.

ENDFORM.                    " Update_custom_table
*&---------------------------------------------------------------------*
*&      Form  Create_IDocs
*&---------------------------------------------------------------------*
*       Create Idoc's
*----------------------------------------------------------------------*
FORM create_idocs .

  DATA: g_created_comm_idocs TYPE sy-tabix .
  CLEAR : i_edidc_control_comm ,
          wa_edidc             ,
          i_edidd_data         .

** Polulate Control Record
  wa_edidc-mestyp =  p_mestyp.
  wa_edidc-idoctp =  c_idoc_type.
  wa_edidc-rcvprt =  c_ls.
* wa_edidc-rcvprn =  p_logsys .

** Create Idoc's for every new order Number
  LOOP AT it_yse_e1_slsf_hdr_seo_delta.

    move-corresponding it_yse_e1_slsf_hdr_seo_delta to wa_ctr_hdr.

    AT NEW aufnr .
      CLEAR i_edidd_data[] .
      i_edidd_data-segnam  = c_ord_header  .
      i_edidd_data-sdata   = wa_ctr_hdr.
      APPEND i_edidd_data .
    ENDAT .

    AT NEW werks.
      clear wa_edidc-rcvprn.
      SELECT SINGLE rcvprn INTO wa_edidc-rcvprn
             FROM edp13
             WHERE mestyp = p_mestyp.
    ENDAT.

    AT END OF aufnr.
** Generate Idoc's

      CALL FUNCTION 'MASTER_IDOC_DISTRIBUTE'
        EXPORTING
          master_idoc_control            = wa_edidc
        TABLES
          communication_idoc_control     = i_edidc_control_comm
          master_idoc_data               = i_edidd_data
        EXCEPTIONS
          error_in_idoc_control          = 1
          error_writing_idoc_status      = 2
          error_in_idoc_data             = 3
          sending_logical_system_unknown = 4
          OTHERS                         = 5.

      IF sy-subrc <> 0.
        MESSAGE e025 with sy-subrc.
      ELSE.
        DESCRIBE TABLE i_edidc_control_comm LINES sy-tfill.
        ADD sy-tfill TO g_created_comm_idocs.

        read table i_edidc_control_comm index 1.

        REFRESH i_edidc_control_comm.
      ENDIF.

      call function 'BAPI_TRANSACTION_COMMIT'.

      call function 'EDI_DOCUMENT_DEQUEUE_LATER'
        EXPORTING
          docnum                 = i_edidc_control_comm-docnum
        EXCEPTIONS
          idoc_is_not_to_dequeue = 1
          others                 = 2.

    ENDAT .

  ENDLOOP .

  write: / text-i01, g_created_comm_idocs .

ENDFORM.                    " Create_IDocs
*&---------------------------------------------------------------------*
*&      Form  Delete_old_files
*&---------------------------------------------------------------------*
*       Delete files from former runs on application server
*----------------------------------------------------------------------*
FORM delete_old_files.

  data: g_dir_name like EPSF-EPSDIRNAM,
        g_dfile    like EPSF-EPSFILNAM.

  loop at i_delfiles.

    CONCATENATE c_yse_salesf_seo i_delfiles-werks i_delfiles-ersda
                         INTO g_dfile separated by c_underscore.

    move g_directory to g_dir_name.
    REPLACE 'xxx' IN g_dir_name WITH p_logsys(3).
    TRANSLATE g_dir_name(10) to lower case.
    TRANSLATE g_dir_name+17(8) to lower case.

* change MJ 20090602
*    CALL FUNCTION 'EPS_DELETE_FILE'
    call function 'YSE_EPS_DELETE_FILE'
      EXPORTING
        FILE_NAME              = g_dfile
        DIR_NAME               = g_dir_name
      EXCEPTIONS
        INVALID_EPS_SUBDIR
        SAPGPARAM_FAILED
        BUILD_DIRECTORY_FAILED
        NO_AUTHORIZATION
        BUILD_PATH_FAILED
        DELETE_FAILED.

    if sy-subrc <> 0.
      write: / text-e05, g_dfile.      "Could not delete file
    endif.

  endloop.

ENDFORM.                    "delete_old_files
*&---------------------------------------------------------------------*
*&      Form  Delete_old_table_entries
*&---------------------------------------------------------------------*
*       Delete entries from former runs in custom table YSE_SLSF_SERVC
*----------------------------------------------------------------------*
FORM delete_old_table_entries using p_werks.

  g_date = sy-datum - 7.
  concatenate g_date c_0000 into g_ersda.

  refresh i_delfiles.

  select * from YSE_SLSF_SEO
      where werks eq p_werks
        and ersda lt g_ersda.
    move YSE_SLSF_SEO to i_delfiles.
    append i_delfiles.
    clear i_delfiles.
  endselect.

  if sy-subrc = 0.
    delete from YSE_SLSF_SEO where werks eq p_werks
                           and ersda lt g_ersda.

    if sy-subrc <> 0.
      write: / text-e06, p_werks.        "Could not delete entrie(s) in
*                                         table YSE_SLSF_SERVC
    endif.

  endif.

ENDFORM.                    "delete_old_table_entries

*&---------------------------------------------------------------------*
*&      Form  get_hours                                     MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_OBJEQ  text
*      <--P_HOURS
*----------------------------------------------------------------------*
FORM get_hours  USING    P_OBJEQ
                         P_ATTIN
                CHANGING P_HOURS.

  data: g_point like imptt-point,
        i_wa_point like impt,
        i_wa_value like imrg.



    clear g_point.
    select point from IMPTT into g_point
       where mpobj eq p_objeq
         and atinn eq P_ATTIN.
    endselect.

    if sy-subrc = 0.
* Begin of delete MOD-001
*     read last counter
*      CALL FUNCTION 'MEASUREM_POINT_LAST_VALUE'
*        EXPORTING
*          I_POINT           = g_point
*        IMPORTING
*          E_WA_POINT        = i_wa_POINT
*          E_WA_VALUE        = i_wa_VALUE
*        EXCEPTIONS
*          POINTER_NOT_FOUND = 01.
* End of delete MOD-001
* Begin of insert MOD-001
*     read last counter of order

       select readg recdu from imrg into table ls_msdoc
       where woobj = i_ord_head-objnr and
             point = g_point.



* End of insert MOD-001*
      if sy-subrc = 0.
* Begin of insert MOD-001
       sort ls_msdoc descending by readg.
       read table ls_msdoc index 1.
       i_wa_point-msehi = ls_msdoc-readgi.
       i_wa_value-readg = ls_msdoc-readg.
* End of insert MOD-001
*       convert value into display format
        PERFORM UNIT_CONV_DISPL USING I_WA_POINT-MSEHI
                                      I_WA_VALUE-READG
                                      p_hours
                                      I_WA_POINT-DECIM
                                      I_WA_POINT-EXPON.
      endif.
    endif.


ENDFORM.                    " get_running_and_loaded_hours
*---------------------------------------------------------------------
*  FORM UNIT_CONV_DISPL
*---------------------------------------------------------------------
FORM UNIT_CONV_DISPL USING P_EINHEIT
                           P_FLTP_WERT
                           P_CHAR_WERT
                           P_DECIMAL
                           P_EXPONENT.

  CLEAR P_CHAR_WERT.
  CHECK NOT ( P_FLTP_WERT IS INITIAL ).

  CALL FUNCTION 'FLTP_CHAR_CONVERSION_FROM_SI'
    EXPORTING
      CHAR_UNIT       = P_EINHEIT
      DECIMALS        = P_DECIMAL
      EXPONENT        = P_EXPONENT
      FLTP_VALUE_SI   = P_FLTP_WERT
      INDICATOR_VALUE = c_x
      MASC_SYMBOL     = ' '
    IMPORTING
      CHAR_VALUE      = P_CHAR_WERT.

ENDFORM.                    "UNIT_CONV_DISPL

*&---------------------------------------------------------------------*
*&      Form  PROCESS_ORDERS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM PROCESS_ORDERS.
************************************************************************

  LOOP AT i_ord_head.
    l_index = sy-tabix.

************************************************************************
* SHIP TO ADDRESS IS NOT AVAILABLE ON THE COMPONENT LEVEL IN SAP       *
* SO TO CLASSIFY THE SERVICE ORDER'S SELECT MAINTENANCE ACTIVITY TYPE  *
* FROM MAINTENANCE ORDER HEADER WHICH WILL BEMAINTAINED AT HEADER LEVEL*
* TO IDENTIFY THE SERVICE ORDER'S                                      *
************************************************************************

    SELECT SINGLE ilart priok ingpr iwerk anlzu qmnum INTO
             (i_ord_head-ilart, i_ord_head-priok, i_ord_head-ingpr, i_ord_head-iwerk, i_ord_head-anlzu, i_ord_head-qmnum)
                           FROM afih
                        WHERE aufnr EQ i_ord_head-aufnr.
*    MODIFY i_ord_head INDEX l_index.

    select single bstkd into i_ord_head-bstkd
       from PMSDO where objnr = i_ord_head-objnr.
*    MODIFY i_ord_head INDEX l_index.


************************************************************************
* CALL FUNCTION MODULE MSM_GRAPH_GET_ADDRESS_NUMBER TO GET THE ADRESS *
* NUMBER FOR THE SERVICE ORDER
************************************************************************
*    CALL FUNCTION 'MSM_GRAPH_GET_ADDRESS_NUMBER'
*      EXPORTING
*        aufnr      = i_ord_head-aufnr
*      IMPORTING
*        addrnumber = adrnr.
*    IF sy-subrc EQ 0.
*      SELECT SINGLE name1 street city1 country post_code1 region INTO
*    (i_ord_head-equi_name1,i_ord_head-equi_street,i_ord_head-equi_city1,
*       i_ord_head-equi_country,i_ord_head-equi_post_code1,
*       i_ord_head-equi_region)
*       FROM adrc WHERE addrnumber = adrnr.
**      MODIFY i_ord_head INDEX l_index.
*    ENDIF.
*    CLEAR adrnr .
*---------------------------------------------------------------------*
* CALL IWOL_GET_OBJECT_LIST_ALL  TO GET THE MATERIAL NUMBER AND SERIAL*
* NUMBER BASED ON ORDER NO                                            *
*---------------------------------------------------------------------*
*    aufnr = i_ord_head-aufnr.
    clear lv_equnr.
    SELECT SINGLE equnr from afih into lv_equnr
      where aufnr = i_ord_head-aufnr.

    SELECT SINGLE matnr sernr from equi into (i_ord_head-equi_matnr, i_ord_head-equi_sernr)
      where equnr = lv_equnr.
    i_ord_head-equnr = lv_equnr.

*    CALL FUNCTION 'IWOL_GET_OBJECT_LIST_ALL'
*      EXPORTING
*        i_aufnr = aufnr
*      TABLES
*        iriwol  = i_iriwol.
    .
*    IF sy-subrc = 0.
*      READ TABLE i_iriwol INDEX 1.
*      MOVE i_iriwol-matnr TO  i_ord_head-equi_matnr.
*      MOVE i_iriwol-equnr TO  i_ord_head-equnr.
*      MOVE i_iriwol-sernr TO  i_ord_head-equi_sernr.
**      MODIFY i_ord_head INDEX l_index.
*    ENDIF.
    CLEAR aufnr.

************************************************************************
* CALL FUNCTION MODULE MSM_GRAPH_GET_ADDRESS_NUMBER TO GET THE ADRESS *
* NUMBER FOR THE SERVICE ORDER
************************************************************************
    SELECT SINGLE adrnr FROM v_equi INTO adrnr
    WHERE equnr = i_ord_head-equnr AND datbi EQ c_99991231.
    IF sy-subrc = 0.
    SELECT SINGLE name1 street city1 country post_code1 region INTO
      (i_ord_head-equi_name1,i_ord_head-equi_street,i_ord_head-equi_city1,
         i_ord_head-equi_country,i_ord_head-equi_post_code1,
         i_ord_head-equi_region)
         FROM adrc WHERE addrnumber = adrnr.
    ENDIF.
  CLEAR adrnr .

  CLEAR: l_vbeln, i_ord_head-flag .

** Validate for Service Order Close status
  SELECT SINGLE objnr stat inact FROM jest
   INTO (i_status-objnr,i_status-stat,i_status-inact)
               WHERE objnr = i_ord_head-objnr
               AND stat EQ 'I0046'
               AND inact NE 'X' .
  IF sy-subrc EQ 0 .
    i_ord_head-flag = c_x .
*     MODIFY i_ord_head INDEX l_index.
  ENDIF.
  MODIFY i_ord_head INDEX l_index.
ENDLOOP.


************************************************************************
*         LOOP THE ORDER HEADER AND OPERATION TABLE                    *
*         READ THE CUSTOM TABLE WITH THE ORDER NO AND                  *
*         IF IT MATCHES THE CRITERIA DELETE IT FROM THE                *
*         HEADER AND OPERATION INTERNAL TABLES                         *
************************************************************************

* convert characteristic into internal value
  clear g_fm_atinn.
  CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
    EXPORTING
      INPUT  = c_run_hours
    IMPORTING
      OUTPUT = g_FM_ATINN.

  clear g_fm_atinn2.
  CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
    EXPORTING
      INPUT  = c_loaded_hours
    IMPORTING
      OUTPUT = g_FM_ATINN2.

  clear it_afru[].
if i_ord_head[] is not initial.
  select aufnr isdd from afru into corresponding fields of table it_afru
      for all entries in i_ord_head
      where aufnr = i_ord_head-aufnr.


  SORT it_afru by aufnr isdd.

 select single parnum into wa_edidc_control-rcvprn
  from yam_sel_partner
       where bukrs  = g_bukrs
         and msgtyp = p_mestyp.

LOOP AT i_ord_head.
  clear  wa_edidc_control-rcvprn.

*     get running hours and loaded hours of equipment
  clear: i_ord_head-runhours,
         i_ord_head-loadhours,
         g_objeq.
  g_objeq(2) = c_ie.
  g_objeq+2(18) = i_ord_head-equnr.


  perform get_hours using g_objeq
                          g_FM_ATINN
                 changing i_ord_head-runhours.


  perform get_hours using g_objeq
                          g_FM_ATINN2
                 changing i_ord_head-loadhours.

  LOOP at it_afru where aufnr = i_ord_head-aufnr.
    MOVE it_afru-isdd TO  i_ord_head-isdd.
    exit.
  endloop.

*  if not i_ord_head-bukrs is initial.
*    g_bukrs = i_ord_head-bukrs.
*  else.
*    select single bukrs into g_bukrs from aufk
*      where aufnr = i_ord_head-aufnr.
*  endif.

*    IF i_ord_head-flag NE c_x .
  l_index1 = sy-tabix.
** Select object number from AUFK
  CLEAR: wa_aufk_objnr, wa_jest_chgnr, wa_ord_cls_date,wa_sortl.
  select single gstrs into i_ord_head-gstrs
       from AFKO where aufnr = i_ord_head-aufnr.

  select single ltxa1 from v_afvc_afko into i_ord_head-ltxa1
       where aufnr = i_ord_head-aufnr and vornr = '0010'.

  select single kdauf into i_ord_head-kdauf
       from VIQMEL where qmnum = i_ord_head-qmnum.

  select single objnr bemot
                zzsdc zzcon zzapc zzpsf zztrc
                bukrs
     into (wa_aufk_objnr, i_ord_head-bemot,
           i_ord_head-zzsdc, i_ord_head-zzcon,
            i_ord_head-zzapc, i_ord_head-zzpsf,
            i_ord_head-zztrc, i_ord_head-bukrs)
     from AUFK
     where aufnr = i_ord_head-aufnr.
  IF sy-subrc = 0 .

    refresh i_ihpa.
    SELECT m~objnr m~parnr m~parvw  n~sortl n~name1 n~stras n~ort01
           m~adrnr n~adrnr
      n~pstlz n~land1 INTO (i_ihpa-objnr,i_ihpa-parnr,i_ihpa-parvw,
      i_ihpa-sortl,i_ihpa-name1,i_ihpa-street,i_ihpa-city1,
      i_ihpa-adrnr,
      i_ihpa-adrnr_kna1,
      i_ihpa-post_code1,i_ihpa-country) FROM ihpa
      AS m JOIN kna1 AS n
      ON m~parnr = n~kunnr
      WHERE m~objnr    =  wa_aufk_objnr
        and m~kzloesch <> 'X'.
      APPEND i_ihpa.
      CLEAR  i_ihpa.
    ENDSELECT.

    SELECT SINGLE chgnr INTO wa_jest_chgnr FROM jest
                          WHERE objnr EQ wa_aufk_objnr
                          AND   stat  EQ 'I0046'
                          AND inact NE 'X' .
************************************************************************
*added the BPCS customer no with Fam code which is stored in field
**sortl
************************************************************************
    IF sy-subrc EQ 0.
      READ TABLE i_ihpa WITH KEY objnr = wa_aufk_objnr.
      wa_sortl = i_ihpa-sortl.
    ENDIF.

    IF sy-subrc = 0 .
      SELECT SINGLE udate INTO wa_ord_cls_date FROM jcds
                            WHERE objnr EQ wa_aufk_objnr
                            AND stat EQ 'I0046'
                            AND chgnr EQ wa_jest_chgnr
                            AND inact NE 'X' .

    ENDIF .
  ENDIF .
  CLEAR wa_yse_e1_slsf_hdr_seo.
  REFRESH i_edidd_data.
  wa_yse_e1_slsf_hdr_seo-werks        =  i_ord_head-werks.
  wa_yse_e1_slsf_hdr_seo-isdd        =  i_ord_head-isdd.
  wa_yse_e1_slsf_hdr_seo-runhours     = i_ord_head-runhours.
  wa_yse_e1_slsf_hdr_seo-loadhours     = i_ord_head-loadhours.
  wa_yse_e1_slsf_hdr_seo-ltxa1     = i_ord_head-ltxa1.
  wa_yse_e1_slsf_hdr_seo-anlzu        =  i_ord_head-anlzu.
  wa_yse_e1_slsf_hdr_seo-kdauf        =  i_ord_head-kdauf.
  wa_yse_e1_slsf_hdr_seo-ktext        =  i_ord_head-ktext.
  wa_yse_e1_slsf_hdr_seo-aufnr        =  i_ord_head-aufnr.
  wa_yse_e1_slsf_hdr_seo-kdauf        =  i_ord_head-kdauf.
  wa_yse_e1_slsf_hdr_seo-ord_cls_date =  wa_ord_cls_date .
  wa_yse_e1_slsf_hdr_seo-sortl        =  wa_sortl.
************************************************************************
  wa_yse_e1_slsf_hdr_seo-gstrs  =  i_ord_head-gstrs.
  wa_yse_e1_slsf_hdr_seo-priok  =  i_ord_head-priok.
  wa_yse_e1_slsf_hdr_seo-ilart  =  i_ord_head-ilart.
  wa_yse_e1_slsf_hdr_seo-equnr           = i_ord_head-equnr.
  wa_yse_e1_slsf_hdr_seo-equi_name1      = i_ord_head-equi_name1.
  wa_yse_e1_slsf_hdr_seo-equi_street     = i_ord_head-equi_street.
  wa_yse_e1_slsf_hdr_seo-equi_city1      = i_ord_head-equi_city1.
  wa_yse_e1_slsf_hdr_seo-equi_country    = i_ord_head-equi_country.
  wa_yse_e1_slsf_hdr_seo-equi_post_code1 = i_ord_head-equi_post_code1.
  wa_yse_e1_slsf_hdr_seo-equi_region     = i_ord_head-equi_region.
  wa_yse_e1_slsf_hdr_seo-equi_matnr      = i_ord_head-equi_matnr.
  wa_yse_e1_slsf_hdr_seo-equi_sernr      = i_ord_head-equi_sernr.
  wa_yse_e1_slsf_hdr_seo-zzsdc  = i_ord_head-zzsdc.
  wa_yse_e1_slsf_hdr_seo-zzcon  = i_ord_head-zzcon.
  wa_yse_e1_slsf_hdr_seo-ingpr  = i_ord_head-ingpr.
  select single ernam from yam_planner_map
  into wa_yse_e1_slsf_hdr_seo-ernam
  where iwerk = i_ord_head-iwerk and ingpr = i_ord_head-ingpr.
  IF sy-subrc NE 0.
    wa_yse_e1_slsf_hdr_seo-ernam      = i_ord_head-ernam.
  ENDIF.

  wa_yse_e1_slsf_hdr_seo-bemot  = i_ord_head-bemot.
  wa_yse_e1_slsf_hdr_seo-bstkd  = i_ord_head-bstkd.
  wa_yse_e1_slsf_hdr_seo-zzapc  = i_ord_head-zzapc.
  wa_yse_e1_slsf_hdr_seo-zzpsf  = i_ord_head-zzpsf.
  wa_yse_e1_slsf_hdr_seo-zztrc  = i_ord_head-zztrc.

  LOOP AT i_ihpa WHERE objnr = wa_aufk_objnr.
    IF i_ihpa-parvw EQ 'AG'.
      wa_yse_e1_slsf_hdr_seo-sortl = i_ihpa-sortl.
    ELSEIF i_ihpa-parvw EQ 'WE'.

      if i_ihpa-ADRNR NE SPACE.
        clear ls_ADRC.

        select single * from ADRC into ls_adrc
                          where ADDRNUMBER = i_ihpa-adrnr.

      ENDIF.

      if i_ihpa-adrnr is initial.
        wa_yse_e1_slsf_hdr_seo-name1        = i_ihpa-name1.
        wa_yse_e1_slsf_hdr_seo-street       = i_ihpa-street.
        wa_yse_e1_slsf_hdr_seo-city1        = i_ihpa-city1.
        wa_yse_e1_slsf_hdr_seo-post_code1   = i_ihpa-post_code1.
        wa_yse_e1_slsf_hdr_seo-country      = i_ihpa-country.
        select name_co str_suppl1
               name2
          into (wa_yse_e1_slsf_hdr_seo-name_co,
                wa_yse_e1_slsf_hdr_seo-str_suppl1,
                wa_yse_e1_slsf_hdr_seo-name2)
            from ADRC where addrnumber = i_ihpa-adrnr_kna1.
        endselect.
        if sy-subrc = 0.
          select remark into wa_yse_e1_slsf_hdr_seo-remark
              from ADRCT where addrnumber = i_ihpa-adrnr_kna1
                          and langu      = c_e.
          endselect.
        endif.
      else.
        select name_co name1 street city1 post_code1 country
               name2
               str_suppl1
            into (wa_yse_e1_slsf_hdr_seo-name_co,
                  wa_yse_e1_slsf_hdr_seo-name1,
                  wa_yse_e1_slsf_hdr_seo-street,
                  wa_yse_e1_slsf_hdr_seo-city1,
                  wa_yse_e1_slsf_hdr_seo-post_code1,
                  wa_yse_e1_slsf_hdr_seo-country,
                  wa_yse_e1_slsf_hdr_seo-name2,
                  wa_yse_e1_slsf_hdr_seo-str_suppl1)
            from ADRC where addrnumber = i_ihpa-adrnr.
        endselect.
        if sy-subrc = 0.
          select remark into wa_yse_e1_slsf_hdr_seo-remark
              from ADRCT where addrnumber = i_ihpa-adrnr
                           and langu      = c_e.
          endselect.
        endif.
      endif.
    ENDIF.
  ENDLOOP.
  clear : g_iloan,
          g_tplnr,
          g_pltxt.
  if wa_yse_e1_slsf_hdr_seo-remark = ' '.
    if i_ord_head-iwerk = c_plant.
      wa_yse_e1_slsf_hdr_seo-remark = c_remark.
    else.
      select single iloan into g_iloan from afih
        where aufnr = i_ord_head-aufnr.
      if sy-subrc is initial.
        select single tplnr into g_tplnr from iloa
         where iloan = g_iloan.
        if sy-subrc is initial.
          g_tplnr = g_tplnr+0(13).
          select single pltxt into g_pltxt from iflotx
            where tplnr = g_tplnr.
          if sy-subrc is initial.
            if g_pltxt(6) co '1234567890'.
              wa_yse_e1_slsf_hdr_seo-remark = G_pltxt+7(33).
            else.
              wa_yse_e1_slsf_hdr_seo-remark = G_pltxt.
            endif.
          endif.
        endif.
      endif.
    endif.
  endif.
  clear sy-subrc.
  APPEND wa_yse_e1_slsf_hdr_seo TO it_yse_e1_slsf_hdr_seo.
*      i_edidd_data-segnam = c_ord_header.
*      i_edidd_data-sdata = wa_yse_e1_slsf_hdr_seo.
*      APPEND i_edidd_data.
*    ENDIF .

ENDLOOP.
endif.

ENDFORM.                    "PROCESS_ORDERS

*Text symbol text£º
*001:SERVICE ORDER IDOC SCREEN
*002:Closed
*003:TECO
*E01:No data available for the Selected Sales Organization :
*E02:No previous run entry found in custom table YSE_SLSF_SEO for plant:
*E03:Open dataset failed for :
*E05:Could not delete file :
*E06:Could not delete entrie(s) in table YSE_SLSF_SEO for :
*I01:Number of Idocs created :
*I02:Job finished
*I03:No Idocs created
*T00:ORDER HAVE BEEN ALREADY SENT PLZ CHECK
*T01:ORDER NO IS EITHER CLOSED/TECHNICALLY COMPLETED/or Status QUCR
*T02:GENERATION REPORT FOR IDOC
*T03:IDOC GENERATED

*T04:GENERATION REPORT FOR IDOC
*Selection text£º
*P_INWER:        Plant  to be initial loaded
*P_MESTYP:D       .
*S_AUART:D       .
*S_AUFNR:D       .
*S_ERDAT:        Created/Changed on
*S_WERKS:D       .
