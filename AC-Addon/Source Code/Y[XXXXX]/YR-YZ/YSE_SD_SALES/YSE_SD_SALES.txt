*********************************************************************
* Report  : YSE_SD_SALES                                            *
*-------------------------------------------------------------------*
* Author  : Kurt Clement                                            *
* Company : Atlas Copco                                             *
* Created : 27.12.2006                                              *
* Dev.nbr : D065 - Sales reporting                                  *
*-------------------------------------------------------------------*
* This program will cover a lot of different sales reports          *
*********************************************************************
*********************************************************************
* Amendment to Report by Dips Naik, 11th December 2007.
* Dev.nbr : D405 - End Customer Report
* This report now allows a user to process in the background whilst
* picking up end customer information. The file will reside on the
* application server then they may retrieve the file and import
* into Microsoft Excel using the deliminator as |
* The standard ALV report now has 3 extra fields
*-------------------------------------------------------------------*
* 2008.03.27 Issue: 4426 PDudas air23037                            *
*     Add new columns sold to, bill to, ship to, endcust name       *
*-------------------------------------------------------------------*
* 2008.04.16 Issue: 4601 PDudas air23037                            *
*     Add new columns: ship to NAICS, mat group, sold to cust grp   *
*-------------------------------------------------------------------*
* 2008.04.22 Issue: 4244 PDudas air23037                            *
*     New stuff: D065 section 3.1.3                                 *
*-------------------------------------------------------------------*
* 2008.04.22 Issue: 4727 PDudas air23037                            *
*     bugfix           still to be done                             *
*-------------------------------------------------------------------*
*-------------------------------------------------------------------*
* 2008.05.30 Issue: CR0128 Addition of 2 new fields                 *
* Uzzawal Vemparala    Transport # CD1K940912
*-------------------------------------------------------------------*
* 2008.06.24 Issue:  PROE-7FQ3FX::Addition of Accounting Document   *
* Uzzawal Vemparala    Transport # CD1K941515                       *
*-------------------------------------------------------------------*
* 2008.06.25 Issue:  CR0273:: Invoice is missing for  Debit Memo Req*
* CVM      Transport #                                              *
*-------------------------------------------------------------------*
* 2008.06.25 Issue:  CR0273:: Accounting Doc is missing             *
* CVM      Transport #                                              *
*-------------------------------------------------------------------*
* 2008.07.17 Issue:  CR0271: Set InvoiceCost field to negative      *
* CVM      Transport #                                              *
*-------------------------------------------------------------------*
* 2008.09.26 Issue:  Limit selection on creation date (s_erdat3)    *
* LME                                                               *
*-------------------------------------------------------------------*
* 2008.10.09 Issue: Limit selection expanded to 3 months (92 days)  *
* MJ                                                                *
*-------------------------------------------------------------------*
* 2008.10.09 Issue: CR0409 select more records of VBFA              *
* MJ                                                                *
*-------------------------------------------------------------------*
* 2008.12.01 Incident 1291: adjust sign to show on screen           *
* LME                                                               *
*-------------------------------------------------------------------*
* 2009.01.20 Issue: CR0465 + CR0393:                                *
*                   Performance improvements + extra fields         *
*            Indication: js-001     Transport: CD1K945778           *
*-------------------------------------------------------------------*
* 2009.04.02 Issue: 3579 JPY Currency Issue                         *
* Uzzawal Vemparala    Transport # CD1K947414                       *
*-------------------------------------------------------------------*
* 2009.04.10 Issue: CR0756: Changes for YSE_SL_REPORTING            *
*                   New table for invoiced orders + extra fields    *
*            Indication: js-002     Transport: CD1K947589           *
*-------------------------------------------------------------------*
* 2009.08.05 CR0905-MATERIAL short text from VA03                   *
* Uzzawal Vemparala    Transport # CD1K949589                       *
*-------------------------------------------------------------------*
* 2009.08.12 Issue: CR0101: Extra fields for AC Connect             *
*            Indication: js-003     Transport: CD1K949744           *
*-------------------------------------------------------------------*
* 2009.11.05 CR0391 EXTN JPY Currency Issue                         *
* Uzzawal Vemparala    Transport # CD1K951626                       *
*-------------------------------------------------------------------*
* 2009.12.18 CR1120 Issue with cost and profit, batch management    *
* Luc Mertens USG Innotiv Transport # CD1K952975      lme001        *
*-------------------------------------------------------------------*
* 2010.02.26 CR1249 Exchange rate of document                       *
* Luc Mertens USG Innotiv Transport # CD1K954976      lme002        *
*-------------------------------------------------------------------*
* 2010.03.04 CR814 Remove Authorisation Check P_ORGIN               *
* Geert Rutten  Transport # CD1K955101             gru001           *
*-------------------------------------------------------------------*
* 2010.04.02 CR1249 Exchange rate of document                       *
* Luc Mertens USG Innotiv Transport # CD1K952975      lme003        *
*-------------------------------------------------------------------*
* 2010.04.07 Performance tuning                                     *
* Luc Mertens USG Innotiv Transport # CD1K955845      lme004        *
*-------------------------------------------------------------------*
* 2010.04.20 CR1181 Load ASSO in Sales report tables (BO reporting) *
* Jules Smets USG Innotiv Transport  #  CD1K956150  #   js-004      *
*                                    #  CD1K956568  #               *
*                                    #  CD1K957301  #               *
*-------------------------------------------------------------------*
* 2010.11.18 CR1349 Request delivery date                           *
* Geert Rutten  #  CD1K960170  #   gru001                           *
*-------------------------------------------------------------------*
* 2010.11.12 CR1515 BUG FIX for incident 9975 THE SO LINE CREATE    *
*                       DATE INCORRECT IN SE_SL_REPORTING           *
* Mod - 00027  Nanda (RSN)         Transport req: CD1K960942        *
*-------------------------------------------------------------------*
* 2011.02.18 Issue: CR1943 : Performance improvements               *
*                            (CPU consumption issue)                *
*            Indication: js-005     Transport: CD1K963106           *
*-------------------------------------------------------------------*
* 2011.03.15 Issue: CR1413 : YSE_SL_Reporting: Mismatch with CO-PA  *
*            Indication: js-006     Transport: CD1K963749           *
*-------------------------------------------------------------------*
*-------------------------------------------------------------------*
* 2014.01.26 Issue: CR3022 : YSE_SL_Reporting: Mismatch with CO-PA  *
*            Indication: MOD-001     Transport: CD1K963749          *
*-------------------------------------------------------------------*
* 2014.01.26 Issue: CR3042 : YSE_SL_Reporting: Partial delivery logic*
*            Indication: MOD-002     Transport: CD1K980787          *
*-------------------------------------------------------------------*
* MOD-003: 11.12.2014||CR3376||CD1K984098 ||                        *
* YSE_SL_REPORTING : 1. Open Inv quantity caluculation              *
* 2. When run in the background the Open Invoice quantity is updated*
* wrongly in the list so corrected the logic                        *
* 3. Line length adjusted to 72chars.                               *
*-------------------------------------------------------------------*
* MOD-004: 2015.08.18 | CR3717 | CD1K986547                         *
*           Format file from SAP as Xml or CSV                      *
*-------------------------------------------------------------------*
* MOD-005: 2016.10.28 | CR3875 | CD1K990002                         *
*          Display List of all Outbound Deliveries                  *
*-------------------------------------------------------------------*



REPORT   yse_sd_sales
            NO STANDARD PAGE HEADING.


*-------------------------------------------------------------------*
* Data declarations                                                 *
*-------------------------------------------------------------------*
*--- Include (ALV output)
*include yse_sd_rep_include.

*--- Dictionary tables
TABLES: mara, adrc, fplt.
TABLES: ce41000.                     " Atlas Copco Operatin
TABLES: ce41000_acct.                " Atlas Copco Operatin
TABLES: ekko.                        " Purchasing Document Header
TABLES: kna1.                        " Customer Master Data
TABLES: knvh.                        " Customer Hierarchies
TABLES: konv.                        " Conditions
TABLES: knvp.                        " Customer Master Partner Funcs
TABLES: likp.                        " SD Doc: Delivery Header Data
TABLES: lips.                        " SD Doc: Delivery Item Data
TABLES: lfa1.                        " Vendor Master
TABLES: makt.                        " Material Descriptions
TABLES: mvke.                        " Sales Data for Material
TABLES: pa0003.                      " HR Master Record: Pers.numbers
TABLES: tvfk.                        " Billing: Document Types
TABLES: tvgrt.                       " Sales Groups: Texts
TABLES: tvkbt.                       " Sales Offices: Texts
TABLES: vbak.                        " Sales Document: Header Data
TABLES: vbap.                        " Sales Document: Item Data
TABLES: vbep.                        " Sales Doc.: Schedule Line Data
TABLES: vbfa.                        " Sales Document Flow
TABLES: vbkd.                        " Sales Document: Business Data
TABLES: vbpa.                        " Sales Document: Partner
TABLES: vbrk.                        " Billing Document: Header Data
TABLES: vbrp.                        " Billing Document: Item Data
TABLES: vbuk.                        " SD Doc: Sales & Admin. Data
TABLES: vbup.                        " Sales Document: Item Status
TABLES: yse_sd_billrelev.            " Billing relevancy sales orders
TABLES: bkpf, bseg, dd03l.

*** js-001 * begin ***
TABLES: marc,
        ekpo,
        yse_sd_sales_opn.
*** js-001 * end ***

*** js-002 * begin ***
TABLES: yse_sd_sales_inv.
*** js-002 * end ***

TYPES: BEGIN OF xtyp_adrnr,
          adrnr LIKE adrc-addrnumber,
       END OF xtyp_adrnr,

       BEGIN OF xtyp_kdgrp,
          kdgrp LIKE knvv-kdgrp,
          spras LIKE t151t-spras,
          ktext LIKE t151t-ktext,
       END OF xtyp_kdgrp,

       BEGIN OF xtyp_kna1,
          kunnr LIKE kna1-kunnr,
          adrnr LIKE kna1-adrnr,
          bran1 LIKE kna1-bran1,
          name1 LIKE kna1-name1,
*          LIKE kna1-,
*          LIKE kna1-,
       END OF xtyp_kna1,

       BEGIN OF xtyp_vbap.
        INCLUDE STRUCTURE vbap.
TYPES: END OF xtyp_vbap,

      BEGIN OF xtyp_vbrp,
        vbeln LIKE vbrp-vbeln,
        posnr LIKE vbrp-posnr,
        netwr LIKE vbrp-netwr,
        vrkme LIKE vbrp-vrkme,
        kzwi3 LIKE vbrp-kzwi3,
        fareg LIKE vbrp-fareg,
        fkimg LIKE vbrp-fkimg,
        fplnr LIKE vbrp-fplnr ,
        aubel LIKE vbrp-aubel,
        aupos LIKE vbrp-aupos,
* LME insert
        pstyv LIKE vbrp-pstyv,
* LME insert
      END OF xtyp_vbrp,

      BEGIN OF xtyp_vbpa_short,
         vbeln   LIKE vbpa-vbeln,
         posnr   LIKE vbpa-posnr,
         parvw   LIKE vbpa-parvw,
         kunnr   LIKE vbpa-kunnr,
         adrnr   LIKE vbpa-adrnr,
      END OF xtyp_vbpa_short,

      BEGIN OF xtyp_dd07,
        domname    LIKE dd07t-domname,
        ddlanguage LIKE dd07t-ddlanguage,
        domvalue_l LIKE dd07l-domvalue_l,
        domvalue_h LIKE dd07l-domvalue_h,
        ddtext     LIKE dd07t-ddtext,
      END OF xtyp_dd07.

TYPES: BEGIN OF xtyp_kunnr,
          kunnr LIKE vbpa-kunnr,
       END OF xtyp_kunnr.
DATA:LV_VKORG TYPE vkorg. "EXTVPA
*** js-005 * begin ***
TYPES: BEGIN OF xtyp_tvap,
          pstyv  LIKE tvap-pstyv,
          shkzg  LIKE tvap-shkzg,
       END OF xtyp_tvap.

TYPES: BEGIN OF xtyp_pa0001,
          pernr  LIKE pa0001-pernr,
          ename  LIKE pa0001-ename,
       END OF xtyp_pa0001.
*** js-005 * end ***

*--- Internal tables
*** js-005 * begin ***
*DATA: xt_adrc      TYPE TABLE OF adrc   WITH HEADER LINE,
DATA: xt_adrci      TYPE TABLE OF adrc   WITH HEADER LINE,
      xt_adrc      TYPE HASHED TABLE OF adrc
                        WITH UNIQUE KEY addrnumber
                        WITH HEADER LINE,
*** js-005 * end ***
      xv_adrc      TYPE adrc,
* begin of change lme004
*      it_ekko      LIKE ekko           OCCURS 0 WITH HEADER LINE,
*** js-005 * begin ***
*      it_ekko TYPE SORTED TABLE OF ekko
*        WITH NON-UNIQUE KEY ebeln
      it_ekkoi TYPE TABLE OF ekko,
      it_ekko TYPE HASHED TABLE OF ekko
                   WITH UNIQUE KEY ebeln
*** js-005 * end ***
                   WITH HEADER LINE,
* end of change lme004
      xt_kna1      TYPE HASHED TABLE OF xtyp_kna1
                        WITH UNIQUE KEY kunnr,
      xv_kna1_ag   TYPE xtyp_kna1 ,
* begin of change lme004
*      it_kna1_hl   TYPE xtyp_kna1 OCCURS 0 WITH HEADER LINE,
*** js-005 * begin ***
*      it_kna1_hl TYPE SORTED TABLE OF xtyp_kna1
*        WITH NON-UNIQUE KEY kunnr
      it_kna1_hli TYPE TABLE OF xtyp_kna1,
      it_kna1_hl TYPE HASHED TABLE OF xtyp_kna1
                      WITH UNIQUE KEY kunnr
*** js-005 * end ***
                      WITH HEADER LINE,
* end of change lme004
      xv_kna1_re   TYPE xtyp_kna1 ,
      xv_kna1_we   TYPE xtyp_kna1 ,
* begin of change lme004
*      it_knvh      LIKE knvh    OCCURS 0 WITH HEADER LINE ,
*      xt_konv     TYPE TABLE OF konv,
*** js-005 * begin ***
*      it_knvh TYPE SORTED TABLE OF knvh
*        WITH NON-UNIQUE KEY hityp kunnr vkorg vtweg spart
      it_knvhi TYPE TABLE OF knvh,
      it_knvh TYPE HASHED TABLE OF knvh
                   WITH UNIQUE KEY hityp kunnr vkorg vtweg spart
*** js-005 * end ***
                   WITH HEADER LINE,
*** js-005 * begin ***
*      xt_konv TYPE SORTED TABLE OF konv
*        WITH NON-UNIQUE KEY knumv kposn kschl
      xt_konvi TYPE TABLE OF konv,
      xt_konv TYPE HASHED TABLE OF konv
                   WITH UNIQUE KEY knumv kposn kschl
*** js-005 * end ***
                   WITH HEADER LINE,
* end of change lme004
      xv_konv1     TYPE konv,
      xv_konv2     TYPE konv,
      xv_konvf     TYPE konv,                               "js-002
* begin of change lme004
*      it_likp      LIKE likp           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*      it_likp TYPE SORTED TABLE OF likp
*        WITH NON-UNIQUE KEY vbeln
      it_likpi TYPE TABLE OF likp,
      it_likp TYPE HASHED TABLE OF likp
              WITH UNIQUE KEY vbeln
*** js-005 * end ***
              WITH HEADER LINE.
* end of change lme004
DATA: it_likp2     LIKE likp           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_lips      LIKE lips           OCCURS 0 WITH HEADER LINE.
DATA: it_lips TYPE SORTED TABLE OF lips
                   WITH NON-UNIQUE KEY vbeln posnr
                   WITH HEADER LINE.
*DATA: it_lips2     LIKE lips           OCCURS 0 WITH HEADER LINE.
DATA: it_lips2 TYPE SORTED TABLE OF lips
                    WITH NON-UNIQUE KEY vgbel vgpos
                    WITH HEADER LINE.
*** js-005 * end ***
* begin of change lme004
*DATA: it_lfa1      LIKE lfa1           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_lfa1 TYPE SORTED TABLE OF lfa1
*        WITH NON-UNIQUE KEY lifnr
DATA: it_lfa1i TYPE TABLE OF lfa1,
      it_lfa1 TYPE HASHED TABLE OF lfa1
                   WITH UNIQUE KEY lifnr
*** js-005 * end ***
                   WITH HEADER LINE.
* end of change lme004
*DATA: it_makt      LIKE makt           OCCURS 0 WITH HEADER LINE.
* begin of change lme004
*DATA: it_mvke      LIKE mvke           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_mvke TYPE SORTED TABLE OF mvke
*        WITH NON-UNIQUE KEY matnr vkorg vtweg
DATA: it_mvkei TYPE TABLE OF mvke.
DATA: it_mvke TYPE HASHED TABLE OF mvke
                   WITH UNIQUE KEY matnr vkorg vtweg
*** js-005 * end ***
                   WITH HEADER LINE.
* end of change lme004
*** js-005 * begin ***
*DATA: it_tvfk      LIKE tvfk           OCCURS 0 WITH HEADER LINE.
DATA: it_tvfk TYPE HASHED TABLE OF tvfk
                   WITH UNIQUE KEY fkart
                   WITH HEADER LINE.
*** js-005 * end ***
* begin of change lme004
*DATA: it_tvgrt     LIKE tvgrt          OCCURS 0 WITH HEADER LINE.
*DATA: it_tvkbt     LIKE tvkbt          OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_tvgrt TYPE SORTED TABLE OF tvgrt
*        WITH NON-UNIQUE KEY vkgrp spras
DATA: it_tvgrti TYPE TABLE OF tvgrt.
DATA: it_tvgrt TYPE HASHED TABLE OF tvgrt
        WITH UNIQUE KEY spras vkgrp
*** js-005 * end ***
        WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_tvkbt TYPE SORTED TABLE OF tvkbt
*        WITH NON-UNIQUE KEY vkbur spras
DATA: it_tvkbti TYPE TABLE OF tvkbt.
DATA: it_tvkbt TYPE HASHED TABLE OF tvkbt
        WITH UNIQUE KEY spras vkbur
*** js-005 * end ***
        WITH HEADER LINE.
* end of change lme004
*DATA: it_vbak      LIKE vbak    OCCURS 0 WITH HEADER LINE.
*>>>>>>>> START OF INSERT EXTUVE
DATA: BEGIN OF  it_makt OCCURS 0,
       matnr     TYPE makt-matnr,
*       maktx     TYPE makt-maktx, "EXTUVE 019
       arktx     TYPE vbap-arktx,                           "EXTUVE 019
       END OF it_makt.
DATA : wa_makt LIKE it_makt.
*>>>>>>>> END OF INSERT EXTUVE
DATA: it_vbak   TYPE HASHED TABLE OF vbak  WITH HEADER LINE
                      WITH UNIQUE KEY vbeln.

*DATA: it_vbap      LIKE vbap           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbap      TYPE TABLE OF xtyp_vbap  WITH HEADER LINE,
DATA: it_vbap      TYPE SORTED TABLE OF xtyp_vbap
                        WITH NON-UNIQUE KEY vbeln posnr
                        WITH HEADER LINE,
*** js-005 * end ***
      xt_kdgrp TYPE HASHED TABLE OF xtyp_kdgrp
                          WITH UNIQUE KEY kdgrp spras
                          WITH HEADER LINE,
*** js-005 * begin ***
*      it_vbep      LIKE vbep           OCCURS 0 WITH HEADER LINE,
      it_vbep  TYPE SORTED TABLE OF vbep
                    WITH NON-UNIQUE KEY vbeln posnr etenr
                    WITH HEADER LINE,
*** js-005 * end ***
*** begin gru001
*** js-005 * begin ***
*      it_vbepr     LIKE vbep           OCCURS 0 WITH HEADER LINE,
      it_vbepr  TYPE SORTED TABLE OF vbep
                     WITH NON-UNIQUE KEY vbeln posnr etenr
                     WITH HEADER LINE,
*** js-005 * end ***
*** end gru001
      xt_dd07      TYPE TABLE OF xtyp_dd07      WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbfa1     LIKE vbfa           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbfa2     LIKE vbfa           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbfa3     LIKE vbfa           OCCURS 0 WITH HEADER LINE.
DATA: it_vbfa1  TYPE SORTED TABLE OF vbfa
                WITH NON-UNIQUE KEY vbelv posnv vbeln posnn
                WITH HEADER LINE.
DATA: it_vbfa2  TYPE SORTED TABLE OF vbfa
                WITH NON-UNIQUE KEY vbelv posnv vbeln posnn
                WITH HEADER LINE.
DATA: it_vbfa3i TYPE TABLE OF vbfa  WITH HEADER LINE.
DATA: it_vbfa3  TYPE HASHED TABLE OF vbfa
                WITH UNIQUE KEY vbelv posnv vbtyp_n vbtyp_v
                WITH HEADER LINE.
*** js-005 * end ***
* begin of change lme004
*DATA: it_vbkd      LIKE vbkd           OCCURS 0 WITH HEADER LINE,
*** js-005 * begin ***
*DATA: it_vbkd TYPE SORTED TABLE OF vbkd
*        WITH NON-UNIQUE KEY vbeln posnr
*        WITH HEADER LINE,
DATA: it_vbkdi  TYPE TABLE OF vbkd.
DATA: it_vbkd  TYPE HASHED TABLE OF vbkd
                    WITH UNIQUE KEY vbeln posnr
                    WITH HEADER LINE,
*** js-005 * end ***
* end of change lme004

     BEGIN OF it_vbpa1 OCCURS 0,
         vbeln   LIKE vbpa-vbeln,
         posnr   LIKE vbpa-posnr,
         parvw   LIKE vbpa-parvw,
         kunnr   LIKE vbpa-kunnr,
         adrnr   LIKE vbpa-adrnr,
         kdgrp   LIKE knvv-kdgrp,        " customer group
      END OF it_vbpa1.

DATA: xt_vbpa2 TYPE HASHED TABLE OF xtyp_vbpa_short
                      WITH UNIQUE KEY vbeln posnr parvw .
DATA: xt_vbpa3 TYPE HASHED TABLE OF xtyp_vbpa_short
                      WITH UNIQUE KEY vbeln posnr parvw .

* DATA: it_vbpa4     LIKE vbpa           OCCURS 0 WITH HEADER LINE.
DATA: it_vbpa4     TYPE HASHED TABLE OF vbpa
                   WITH HEADER LINE
                   WITH UNIQUE KEY vbeln posnr parvw.

*dips Naik below
*DATA: it_vbpa5     LIKE vbpa           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbpa5_temp LIKE vbpa          OCCURS 0 WITH HEADER LINE.
*end dips naik

TYPES: BEGIN OF xtyp_fplt,
        fplnr LIKE fplt-fplnr,
        fpltr LIKE fplt-fpltr,
        fproz LIKE fplt-fproz,
        fakwr LIKE fplt-fakwr,
        faksp LIKE fplt-faksp,
      END OF xtyp_fplt,

      BEGIN OF xtyp_vbrk,
        vbeln LIKE vbrk-vbeln,
        bukrs LIKE vbrk-bukrs,
        fkart LIKE vbrk-fkart,
        waerk LIKE vbrk-waerk,
        fkdat LIKE vbrk-fkdat,
        erdat LIKE vbrk-erdat,
        vbtyp LIKE vbrk-vbtyp,
        fktyp LIKE vbrk-fktyp,
*** lme002 * begin ***
        kurrf LIKE vbrk-kurrf,
*** lme002 * end ***
      END OF xtyp_vbrk.

DATA: it_fplt      TYPE HASHED TABLE OF xtyp_fplt WITH HEADER LINE
                          WITH UNIQUE KEY fplnr fpltr.

* begin of change lme004
*DATA: it_vbrk      TYPE TABLE OF xtyp_vbrk WITH HEADER LINE.
*DATA: it_vbrk2     TYPE TABLE OF xtyp_vbrk WITH HEADER LINE.
DATA: it_vbrk TYPE SORTED TABLE OF xtyp_vbrk
        WITH NON-UNIQUE KEY vbeln
        WITH HEADER LINE.
DATA: it_vbrk2 TYPE SORTED TABLE OF xtyp_vbrk
        WITH NON-UNIQUE KEY vbeln
        WITH HEADER LINE.
* end of change lme004

* actually this should be hashed, but there a loop, why??
* must check first in CQ if dumps with unique key.
*DATA: it_vbrp      TYPE SORTED TABLE OF xtyp_vbrp
*** js-005 * begin ***
*DATA: it_vbrp      TYPE TABLE OF xtyp_vbrp
DATA: it_vbrp      TYPE SORTED TABLE OF xtyp_vbrp
                   WITH NON-UNIQUE KEY vbeln posnr
                   WITH HEADER LINE.
*                    WITH UNIQUE KEY vbeln posnr.
*DATA: it_vbrp2     LIKE vbrp           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbrp2      TYPE TABLE OF xtyp_vbrp
DATA: it_vbrp2 TYPE SORTED TABLE OF xtyp_vbrp
                    WITH NON-UNIQUE KEY aubel aupos
                    WITH HEADER LINE.
*** js-005 * end ***

DATA: BEGIN OF it_vbuk1  OCCURS 0 ,
          vbeln    LIKE vbuk-vbeln,
          gbstk    LIKE vbuk-gbstk,
          fksak    LIKE vbuk-fksak,
          cmgst    LIKE dd07l-domvalue_l,      " vbuk-cmgst,
      END OF it_vbuk1.

* begin of change lme004
*DATA: it_vbuk2     LIKE vbuk           OCCURS 0 WITH HEADER LINE.
*DATA: it_vbup      LIKE vbup           OCCURS 0 WITH HEADER LINE.
*** js-005 * begin ***
*DATA: it_vbuk2 TYPE SORTED TABLE OF vbuk
*        WITH NON-UNIQUE KEY vbeln
DATA: it_vbuk2i TYPE TABLE OF vbuk.
DATA: it_vbuk2 TYPE HASHED TABLE OF vbuk
        WITH UNIQUE KEY vbeln
*** js-005 * end ***
        WITH HEADER LINE.
*** js-005 * begin ***
DATA: it_vbupi TYPE TABLE OF vbup.
DATA: it_vbup TYPE SORTED TABLE OF vbup
        WITH NON-UNIQUE KEY vbeln posnr
*** js-005 * end ***
        WITH HEADER LINE.

* end of change lme004
DATA: it_billrelev LIKE yse_sd_billrelev
                                       OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF it_ce41000 OCCURS 0,
        aktbo      LIKE ce41000-aktbo,
        paobjnr    LIKE ce41000-paobjnr,
        pasubnr    LIKE ce41000-pasubnr,
        prctr      LIKE ce41000-prctr,
        ww002      LIKE ce41000-ww002,
        ww006      LIKE ce41000-ww006,
        ww007      LIKE ce41000-ww007,
*** js-001 * begin ***
        ww009      LIKE ce41000-ww009,
        ktgrd      LIKE ce41000-ktgrd.
*** js-001 * end ***
DATA: END OF it_ce41000.

DATA: BEGIN OF it_acct OCCURS 0,
        aktbo      LIKE ce41000_acct-aktbo,
        paobjnr    LIKE ce41000_acct-paobjnr,
        pasubnr    LIKE ce41000_acct-pasubnr,
        ce4key     LIKE ce41000_acct-ce4key.
DATA: END OF it_acct.

*** js-001 * begin ***
DATA: BEGIN OF it_ekpo  OCCURS 0,
        ebeln      LIKE ekpo-ebeln,
        ebelp      LIKE ekpo-ebelp,
      END OF it_ekpo.

DATA: BEGIN OF it_mara  OCCURS 0,
        matnr      LIKE mara-matnr,
        mstav      LIKE mara-mstav,
      END OF it_mara.

DATA: BEGIN OF it_marc  OCCURS 0,
        matnr      LIKE marc-matnr,
        werks      LIKE marc-werks,
        mmsta      LIKE marc-mmsta,
        kzaus      LIKE marc-kzaus,
      END OF it_marc.

DATA: BEGIN OF it_adr  OCCURS 0,
        kunnr   TYPE kunnr,
        adrnr   TYPE adrnr,
        name1   TYPE name1_gp,
      END OF it_adr.
DATA: BEGIN OF it_kdgrp  OCCURS 0,
        kunnr   TYPE kunnr,
        kdgrp   TYPE kdgrp,
      END OF it_kdgrp.
*** js-001 * end ***

*** js-003 * begin ***
DATA: BEGIN OF it_vbak_acc  OCCURS 0,
        vbeln   TYPE vbeln_va,
        bsark   TYPE bsark,
        ihrez   TYPE ihrez,
*** lme001 * begin ***
        xblnr   TYPE vbak-xblnr,
*** lme001 * end ***
      END OF it_vbak_acc.
*** js-003 * end ***

*** js-005 * begin ***
DATA: it_tvap TYPE HASHED TABLE OF xtyp_tvap
                   WITH UNIQUE KEY pstyv
                   WITH HEADER LINE.

DATA: it_pa0001 TYPE HASHED TABLE OF xtyp_pa0001
                     WITH UNIQUE KEY pernr
                     WITH HEADER LINE.
*** js-005 * end ***

**********************************************************************
*** !!! In case of changes on IT_DATA :                          !!! *
*** If fields are added, removed or changed in the field-sequence,   *
*** please check the field catalogue for the ALV-grid because there  *
*** the column-number is used for every field with their own titles  *
***                                                                  *
*** Also update structure: YSE_SD_SALES_OUT for background export    *
*** (must be equal to IT_DATA)                                       *
***                                                                  *
*** + Update table YSE_SD_SALES_OPN for batch processing (js-001)    *
***   (if needed)                                                    *
***                                                                  *
*** + Update table YSE_SD_SALES_INV for batch processing (js-002)    *
***   (if needed)                                                    *
**********************************************************************
DATA: BEGIN OF it_data OCCURS 0,
        vkorg        LIKE vbak-vkorg,
        vtweg        LIKE vbak-vtweg,
        spart        LIKE vbak-spart,
        spartd       LIKE vbap-spart,
        vkbur        LIKE vbak-vkbur,
        vkbur_txt    LIKE tvkbt-bezei,
        vkgrp        LIKE vbak-vkgrp,
        vkgrp_txt    LIKE tvgrt-bezei,
        prctr        LIKE ce41000-prctr,
        ww002        LIKE ce41000-ww002,
        ww006        LIKE ce41000-ww006,          "PGC
        ww007        LIKE ce41000-ww007,          "pgc
        cmgst        LIKE vbuk-cmgst,        " credit status
        cmgstt       LIKE dd07t-ddtext,      " credit status text
        bstkd        LIKE vbkd-bstkd,
        bzirk        LIKE vbkd-bzirk,
        vdatu        LIKE vbak-vdatu,
        edatu        LIKE vbep-edatu,
        ebeln        LIKE ekko-ebeln,
        ebelp        LIKE ekpo-ebelp,                       "js-001
        erdat_ord    LIKE vbak-erdat,
        ernam        LIKE vbak-ernam,
        auart        LIKE vbak-auart,
        bnddt        LIKE vbak-bnddt,
        werks        LIKE vbap-werks,
        matnr        LIKE vbap-matnr,
        matkl        LIKE mara-matkl,
        maktx        LIKE makt-maktx,
        pstyv        LIKE vbap-pstyv,
        mtpos        LIKE mvke-mtpos,
        kunag        LIKE vbak-kunnr,
        name1_ag     LIKE kna1-name1,    "SOLD TO name'
        kdgrp_ag     LIKE knvv-kdgrp,    "SOLD TO customer group
        kdgrpt_ag    LIKE t151t-ktext,   "SOLD TO customer group text
*       addr_ag(80)  TYPE c,
        region_ag    LIKE adrc-region,
        city1_ag     LIKE adrc-city1,
        post_code1_ag LIKE adrc-post_code1,
        "Begin MOD-001
        street       LIKE adrc-street,         "Sales WE address
        "End MOD-001
        kunwe        LIKE likp-kunnr,          " ship to name 1
        sh_naics     LIKE kna1-bran1,
        name1_we     LIKE kna1-name1,
        shname2      LIKE kna1-name2,          " SHIP TO
        shname3      LIKE adrc-name3,                       "20080327
        shname4      LIKE adrc-name4,                       "20080327
*       addr_we(80)  TYPE c,
        region_we    LIKE adrc-region,  " If region description is
                                        " required, see table T005U
        city1_we     LIKE adrc-city1,
        post_code1_we LIKE adrc-post_code1,
        kunre        LIKE vbpa-kunnr,
        name1_re     LIKE kna1-name1,            " Bill to name 1
        bpname2      LIKE kna1-name2,            " BILL TO
        bpname3      LIKE adrc-name3,                       "20080327
        bpname4      LIKE adrc-name4,                       "20080327
        hkunnr       LIKE knvh-hkunnr,                      "HierLvl1ld
        name1_hl     LIKE kna1-name1,
        name3_hl     LIKE adrc-name3,                       "20080327
        name4_hl     LIKE adrc-name4,                       "20080327
        sort1        LIKE adrc-sort1,            " CR0128  2008052008
        bran1        LIKE kna1-bran1,
        lfsta_txt    LIKE vbmtv-statu,
        fksak_txt    LIKE vbmtv-statu,
        gbstk_txt    LIKE vbmtv-statu,
        gbsta_txt    LIKE vbmtv-statu,
        faksk        LIKE vbak-faksk,
        lifsk        LIKE vbak-lifsk,
        vbeln_ord    LIKE vbak-vbeln,
        posnr_ord    LIKE vbap-posnr,
        erdat        LIKE vbap-erdat,
        parvw_ve     LIKE vbpa-parvw,
        pernr_ve     LIKE pa0003-pernr,
        ename_ve     LIKE pernr_list_structure-ename,
        parvw_zx     LIKE vbpa-parvw,
        pernr_zx     LIKE pa0003-pernr,
        ename_zx     LIKE pernr_list_structure-ename,
        parvw_zy     LIKE vbpa-parvw,
        pernr_zy     LIKE pa0003-pernr,
        ename_zy     LIKE pernr_list_structure-ename,
        kwert_zpro   LIKE komv-kwert,
        waerk_zpro   LIKE vbap-waerk,
        kzwi3_ord    LIKE vbap-kzwi3,
        waerk_ord    LIKE vbap-waerk,
        kzwi3_ord_cc    LIKE vbap-kzwi3, "Order Item Net Value in CC
        zunitpr      LIKE vbap-kzwi3,
        zunitprcurr  LIKE vbap-waerk,
        zunitpr_cc      LIKE vbap-kzwi3, " Order on Hand value in CC
        kwert_zprs   LIKE komv-kwert,
        waerk_zprs   LIKE vbap-waerk,
        zprofit      LIKE vbap-kzwi3,
        zprofcurr    LIKE vbap-waerk,
        zprofperc(16) TYPE p DECIMALS 2, "air22296 runtime error
        kwmeng       LIKE vbap-kwmeng,
        vrkme_ord    LIKE vbap-vrkme,
        lifnr        LIKE ekko-lifnr,
        name1_vend   LIKE lfa1-name1,
        vbeln_del    LIKE likp-vbeln,
        posnr_del    LIKE lips-posnr,
        wbstk_txt    LIKE vbmtv-statu,
        lfimg        LIKE lips-lfimg,
        vrkme_del    LIKE lips-vrkme,
        zquant_del   LIKE lips-lfimg,
        zvrkme_del   LIKE lips-vrkme,
        wadat_ist    LIKE likp-wadat_ist,
        fkart        LIKE vbrk-fkart,
        vbeln_inv    LIKE vbrk-vbeln,
        posnr_inv    LIKE vbrp-posnr,
        fareg        LIKE vbrp-fareg,            "billing rule
        faregt       LIKE dd07t-ddtext,      " billing rule text
        fkimg        LIKE vbrp-fkimg,
        vrkme_inv    LIKE vbrp-vrkme,
        kzwi3_inv    LIKE vbrp-kzwi3,
        waerk_inv    LIKE vbrk-waerk,
*>>>insert fields issue 4108 on 07/2/8 air22296
        kzwi3_inv_cc    LIKE vbrp-kzwi3,  "Inv value in comp.currency
*<<<air22296
        erdat_inv    LIKE vbrk-erdat,
        fkdat        LIKE vbrk-fkdat,
        zquant_inv   LIKE vbrp-fkimg,
        zvrkme_inv   LIKE vbrp-vrkme,
        zamount      LIKE vbrp-fkimg,
        zwaerk_inv   LIKE vbrk-waerk,
        fproz        LIKE fplt-fproz,
        zfplval      LIKE fplt-fakwr,
        faksp        LIKE fplt-faksp,
        kwmeng_oh    LIKE vbap-kwmeng,
        kzwi3_oh     LIKE vbap-kzwi3,
        kzwi3_oh_cc  LIKE vbap-kzwi3,
        kwert_cos_oh LIKE komv-kwert,
        zprofit_oh   LIKE vbap-kzwi3,
        zprofpc_oh(16) TYPE p DECIMALS 2,
        kwert_cos_in LIKE komv-kwert,
        zprofit_in   LIKE vbap-kzwi3,
        zprofpc_in(16) TYPE p DECIMALS 2,
        zuonr        LIKE bseg-zuonr,
        abgru        LIKE vbap-abgru,
        spname2      LIKE kna1-name2,            " SOLD TO
        spname3      LIKE adrc-name3,                       "20080327
        spname4      LIKE adrc-name4,                       "20080327
* The following are for the end customer data requested in D405
        eccustn      LIKE vbpa-kunnr,
        ecpartf      LIKE vbpa-parvw,
        ecname1      LIKE adrc-name1,      " end customer name
        ecname2      LIKE adrc-name2,
        ecname3      LIKE adrc-name3,    "20080327 end customer
        ecname4      LIKE adrc-name4,    "20080327 end customer
        ecdisct      LIKE knvv-bzirk,
        ecregio      LIKE adrc-region,
        eccity       LIKE adrc-city1,
        ecsrep       LIKE knvp-pernr,
        ecnaics      LIKE kna1-bran1,
        echlcus      LIKE knvh-hkunnr,
        echlcus_nam1 LIKE adrc-name1,
*        echlcus_nam3 LIKE adrc-name3,
*        echlcus_nam4 LIKE adrc-name4,
*        kzwi3_ord_cc LIKE vbap-kzwi3,
        zprofit_cc   LIKE vbap-kzwi3,
        waerk_cc     LIKE vbap-waerk,
*** js-001 * begin ***
*        country      LIKE adrc-country,
        country      LIKE ce41000-ww009,
*** js-001 * end ***
        belnr        LIKE bkpf-belnr,         " 20080624  CR####
*** js-001 * begin ***
        mstav        LIKE mara-mstav,
        mmsta        LIKE marc-mmsta,
        kzaus        LIKE marc-kzaus,
        fksak        LIKE vbuk-fksak,
        gbstk        LIKE vbuk-gbstk,
        wbstk        LIKE vbuk-wbstk,
        lfsta        LIKE vbup-lfsta,
        gbsta        LIKE vbup-gbsta,
        zterm        LIKE vbrk-zterm,
        ktgrd        LIKE ce41000-ktgrd,
*** js-001 * end ***
*** js-002 * begin ***
        zfreight_hdr LIKE komv-kwert,
        zfr_hdr_cc   LIKE vbak-waerk,
        zfreight_itm LIKE komv-kwert,
        zfr_itm_cc   LIKE vbap-waerk,
*** js-002 * end ***
*** js-003 * begin ***
        bsark        LIKE vbak-bsark,
        ihrez        LIKE vbak-ihrez,
*** js-003 * end ***
*** lme001 * begin ***
        xblnr        LIKE vbak-xblnr,
*** lme001 * end ***
*** lme002 * begin ***
        kurrf        LIKE vbrk-kurrf,
        kzwi3_inv_loc LIKE vbrp-kzwi3,  "Inv value in local currency
*** lme002 * end ***
*** lme003 * begin ***
        kursk        LIKE vbkd-kursk,
        kzwi3_ord_loc LIKE vbap-kzwi3,  "Ord NetValue in local currency
*** lme003 * end ***
      END OF it_data.


*** js-002 * begin ***
DATA: it_sales_inv   TYPE TABLE OF yse_sd_sales_inv
                           WITH HEADER LINE,
      gv_sales_inv   TYPE yse_sd_sales_inv.
*** js-002 * end ***


*** js-001 * begin ***
DATA: it_sales_open   TYPE TABLE OF yse_sd_sales_opn
                           WITH HEADER LINE,
      gv_sales_open   TYPE yse_sd_sales_opn.


DATA: BEGIN OF it_vbpa_cust OCCURS 0,
        vbeln   LIKE vbpa-vbeln,
        posnr   LIKE vbpa-posnr,
        parvw   LIKE vbpa-parvw,
        kunnr   LIKE vbpa-kunnr,
        adrnr   LIKE vbpa-adrnr,
      END OF it_vbpa_cust.

DATA: BEGIN OF it_end_cust_district OCCURS 0,
        eccustn      LIKE knvv-kunnr,
        vkorg        LIKE knvv-vkorg,
        vtweg        LIKE knvv-vtweg,
        spart        LIKE knvv-spart,
        ecdisct      LIKE knvv-bzirk,
     END OF it_end_cust_district.

DATA: BEGIN OF it_end_cust_rep OCCURS 0,
        eccustn      LIKE knvp-kunnr,
        vkorg        LIKE knvp-vkorg,
        vtweg        LIKE knvp-vtweg,
        spart        LIKE knvp-spart,
        ecsrep       LIKE knvp-pernr,
      END OF it_end_cust_rep.
*** js-001 * end ***

DATA : w_decimal_place LIKE tcurx-currdec.     "20090402 Uzzawal

DATA: BEGIN OF it_dtype OCCURS 0,
        auart        LIKE yse_sd_billrelev-auart,
        zfkrel       LIKE yse_sd_billrelev-zfkrel,
        ddtext       LIKE dd07t-ddtext.                     "js-001
DATA: END OF it_dtype.

DATA: BEGIN OF it_ddshretval OCCURS 0.
        INCLUDE STRUCTURE ddshretval.
DATA: END OF it_ddshretval.

*--- Structures
DATA: BEGIN OF str_data.
        INCLUDE STRUCTURE it_data.
DATA: END OF str_data.

DATA: BEGIN OF str_data_tmp.
        INCLUDE STRUCTURE it_data.
DATA: END OF str_data_tmp.

DATA: BEGIN OF str_status.
        INCLUDE STRUCTURE tvbst.
DATA: END OF str_status.

DATA: BEGIN OF str_addr_in.
        INCLUDE STRUCTURE addr1_sel.
DATA: END OF str_addr_in.

DATA: BEGIN OF str_addr_out.
        INCLUDE STRUCTURE sadr.
DATA: END OF str_addr_out.

DATA:
  BEGIN OF it_tvko OCCURS 0,
    vkorg    LIKE tvko-vkorg,
    waers_cc LIKE t001-waers,
  END OF it_tvko.

*--- Variables
DATA: x_fkimg      LIKE vbrp-fkimg.
DATA: x_found      TYPE c.
DATA: x_lfimg      LIKE lips-lfimg.
DATA: x_posnv      LIKE vbfa-posnv.
DATA: x_repid      LIKE sy-repid.
DATA: x_vbelv      LIKE vbfa-vbelv.
DATA: x_vbtyp      LIKE vbfa-vbtyp_v.
* LME insert
DATA: x_shkzg      LIKE tvap-shkzg.
* LME insert
DATA: x_asso       TYPE xfeld.                              "js-004

DATA: x_parvw_ve   LIKE vbpa-parvw,
      x_pernr_ve   LIKE pa0003-pernr,
      x_ename_ve   LIKE pernr_list_structure-ename,
      x_parvw_zx   LIKE vbpa-parvw,
      x_pernr_zx   LIKE pa0003-pernr,
      x_ename_zx   LIKE pernr_list_structure-ename,
      x_parvw_zy   LIKE vbpa-parvw,
      x_pernr_zy   LIKE pa0003-pernr,
      x_ename_zy   LIKE pernr_list_structure-ename,
      xv_adrc_endcustomer TYPE adrc.

*--- Constants
CONSTANTS: c_fareg_4     LIKE vbrp-fareg   VALUE '4'.
CONSTANTS: c_fareg_5     LIKE vbrp-fareg   VALUE '5'.
CONSTANTS: c_fktyp_d     LIKE tvfk-fktyp   VALUE 'D'.
CONSTANTS: c_fktyp_p     LIKE tvfk-fktyp   VALUE 'P'.
CONSTANTS: c_flag_on     TYPE c            VALUE 'X'.
CONSTANTS: c_hityp_a     LIKE knvh-hityp   VALUE 'A'.
CONSTANTS: c_kschl_zpro  LIKE konv-kschl   VALUE 'ZPRO'.
CONSTANTS: c_kschl_zprs  LIKE konv-kschl   VALUE 'ZPRS'.
CONSTANTS: c_kschl_zd00  LIKE konv-kschl   VALUE 'ZD00'.    "js-002
CONSTANTS: c_kschl_zurs  LIKE konv-kschl   VALUE 'ZURS'.    "lme001
CONSTANTS: c_parvw_ag    LIKE vbpa-parvw   VALUE 'AG'.
CONSTANTS: c_parvw_re    LIKE vbpa-parvw   VALUE 'RE'.
CONSTANTS: c_parvw_ve    LIKE vbpa-parvw   VALUE 'VE'.
CONSTANTS: c_parvw_we    LIKE vbpa-parvw   VALUE 'WE'.
CONSTANTS: c_parvw_ze    LIKE vbpa-parvw   VALUE 'ZE'.      "js-001
CONSTANTS: c_parvw_zx    LIKE vbpa-parvw   VALUE 'ZX'.
CONSTANTS: c_parvw_zy    LIKE vbpa-parvw   VALUE 'ZY'.
CONSTANTS: c_posnr_init  LIKE vbap-posnr   VALUE '000000'.
CONSTANTS: c_status_del  TYPE c            VALUE 'D'.
CONSTANTS: c_status_inv1 TYPE c            VALUE '1'.
CONSTANTS: c_status_inv2 TYPE c            VALUE '2'.
CONSTANTS: c_status_ord  TYPE c            VALUE 'O'.
CONSTANTS: c_vbtyp_c     LIKE vbak-vbtyp   VALUE 'C'. "Order
CONSTANTS: c_vbtyp_h     LIKE vbak-vbtyp   VALUE 'H'. "Returns
CONSTANTS: c_vbtyp_j     LIKE vbak-vbtyp   VALUE 'J'. "Delivery
CONSTANTS: c_vbtyp_k     LIKE vbak-vbtyp   VALUE 'K'. "Credit memo req
CONSTANTS: c_vbtyp_l     LIKE vbak-vbtyp   VALUE 'L'. "Debit memo req
CONSTANTS: c_vbtyp_m     LIKE vbak-vbtyp   VALUE 'M'. "Invoice
CONSTANTS: c_vbtyp_n     LIKE vbak-vbtyp   VALUE 'N'. "Inv cancel
CONSTANTS: c_vbtyp_s     LIKE vbak-vbtyp   VALUE 'S'. "Cancel
CONSTANTS: c_vbtyp_o     LIKE vbak-vbtyp   VALUE 'O'. "Credit memo
CONSTANTS: c_vbtyp_p     LIKE vbak-vbtyp   VALUE 'P'. "Debit Memo
CONSTANTS: c_vbtyp_t     LIKE vbak-vbtyp   VALUE 'T'. "Return del 4 ord
CONSTANTS: c_vbtyp_v     LIKE vbak-vbtyp   VALUE 'V'. "Purchase order
CONSTANTS: c_wbstk_c     LIKE vbuk-wbstk   VALUE 'C'.
CONSTANTS: c_zfkrel_a    TYPE c            VALUE 'A'.
CONSTANTS: c_zfkrel_c    TYPE c            VALUE 'C'.

*--- Ranges
RANGES: r_auart    FOR vbak-auart           OCCURS 0.
*anges: r_date1    for sy-datum             occurs 0.
*anges: r_date2    for sy-datum             occurs 0.
RANGES: r_dtype1   FOR yse_sr_doctype-auart OCCURS 0.
RANGES: r_dtype2   FOR yse_sr_doctype-auart OCCURS 0.
RANGES: r_fareg    FOR vbrp-fareg           OCCURS 0.
RANGES: r_parvw    FOR vbpa-parvw           OCCURS 0.

*--------------------------------------------------------------------*
* Data declarations concerning ALV-output                            *
*--------------------------------------------------------------------*
*--- Type pools
TYPE-POOLS slis.
*--- Type pools for application server transfer
TYPE-POOLS truxs.
DATA : gt_csv TYPE truxs_t_text_data,
       gw_csv LIKE LINE OF gt_csv.
*--- end of application service transfer data.

*--- Internal tables
DATA: it_fieldcat       TYPE slis_t_fieldcat_alv.
DATA: it_sort           TYPE slis_t_sortinfo_alv.
DATA: lt_fieldcat       TYPE slis_t_fieldcat_alv.

*--- Structures
DATA: str_sort          TYPE slis_sortinfo_alv.
DATA: variant           LIKE disvariant.
DATA: gs_sd_alv_variant LIKE disvariant.
DATA: g_variant         LIKE disvariant.
DATA: gx_variant        LIKE disvariant.
DATA: gs_layout         TYPE slis_layout_alv.
DATA: ls_fieldcat       TYPE slis_fieldcat_alv.
DATA: g_variant_flag    TYPE c.

*--- Variables
DATA: h_exit            TYPE c.

* ---- Field structure data
DATA: xt_dd03l         LIKE dd03l OCCURS 0 WITH HEADER LINE,
* begin of change lme004
*      xt_dd04t         LIKE dd04t OCCURS 0 WITH HEADER LINE,
      xt_dd04t TYPE SORTED TABLE OF dd04t
        WITH NON-UNIQUE KEY rollname
        WITH HEADER LINE,
* end of change lme004
      xt_dd03t         LIKE dd03t OCCURS 0 WITH HEADER LINE.

*--- Variables with default value
DATA: g_user_command    TYPE slis_formname  VALUE 'USER_COMMAND'.
DATA: g_variant_save    TYPE c              VALUE 'U'.

*--- Constants
CONSTANTS: c_value(10)  TYPE c              VALUE 'Values'.

*--- File to store Data on Application Server
DATA: logsys TYPE sysid,
      file_name TYPE rlgrap-filename,
      e_message(100)  TYPE c.

DATA: v_dat LIKE sy-datum,
      v_tim LIKE sy-uzeit,
      user_name LIKE sy-uname.

FIELD-SYMBOLS: <x_data>     LIKE LINE OF it_data,
               <sales_open> LIKE LINE OF it_sales_open,     "js-001
               <sales_inv>  LIKE LINE OF it_sales_inv.      "js-002

******MOD-004 Begin of insert
DATA: gs_e_layout   TYPE slis_layout_alv,
      gt_e_fieldcat TYPE slis_t_fieldcat_alv,
      gt_e_sort     TYPE slis_t_sortinfo_alv,
      gt_e_filter   TYPE slis_t_filter_alv,
      gs_e_list_scroll  TYPE slis_list_scroll,
      gs_e_grid_scroll  TYPE lvc_s_scrl,
      gt_e_marked       TYPE slis_t_fieldcat_alv,
      gs_e_variant  TYPE disvariant,
      gt_attach_tab    TYPE soli_tab,
      gt_file_out   TYPE STANDARD TABLE OF char480,
      gt_batch_mail TYPE STANDARD TABLE OF yse_batch_mail.
DATA: gc_lf         TYPE char2 VALUE cl_abap_char_utilities=>cr_lf,
      gc_tab TYPE char2 VALUE cl_abap_char_utilities=>HORIZONTAL_TAb.
******MOD-004 End of insert

*--- end of declerations

*-------------------------------------------------------------------*
* Selection screen                                                  *
*-------------------------------------------------------------------*

**********************************************************************
*** If selection screen changes, please check if you heave to modify *
*** the select in Form SELECT_OPEN_ORDERS_TABLE (js-001)             *
*** and the select in Form SELECT_INV_ORDERS_TABLE (js-002)          *
**********************************************************************
*** js-001 * begin ***
SELECTION-SCREEN BEGIN OF BLOCK b02 WITH FRAME.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) text-s03.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: rb_sel1 RADIOBUTTON GROUP sel DEFAULT 'X'.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS: s_erdat3 FOR vbap-erdat.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) text-s06.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: rb_sel2 RADIOBUTTON GROUP sel.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) text-s04.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: rb_sel3 RADIOBUTTON GROUP sel.
SELECTION-SCREEN END OF LINE.
SELECT-OPTIONS: s_erdat2 FOR vbrk-erdat.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (30) text-s05.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: cb_sel AS CHECKBOX.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b02.
*** js-001 * end ***

SELECTION-SCREEN BEGIN OF BLOCK b01 WITH FRAME.
SELECT-OPTIONS:
  s_erdat1 FOR vbak-erdat,                                  " CR0128
*  s_erdat3 FOR vbap-erdat,  "OBLIGATORY,        "js-001
  s_vbeln  FOR vbak-vbeln,
  s_posnr  FOR vbap-posnr,
  s_auart  FOR vbak-auart,
  s_vbtyp  FOR vbak-vbtyp,
*** js-003 * begin ***
  s_bsark  FOR vbak-bsark,
  s_ihrez  FOR vbak-ihrez,
*** js-003 * end ***
*** lme001 * begin ***
  s_xblnr  FOR vbak-xblnr,
*** lme001 * end ***
  s_ernam  FOR vbak-ernam,
  s_vdatu  FOR vbak-vdatu,
  s_edatu  FOR vbep-edatu,
  s_ebeln  FOR ekko-ebeln,
* PARAMETERS:
*   p_vkorg  LIKE vbak-vkorg OBLIGATORY MEMORY ID vko,
*   p_vtweg  LIKE vbak-vtweg OBLIGATORY MEMORY ID vtw,
*   p_sparth LIKE vbak-spart OBLIGATORY MEMORY ID spa.
* SELECT-OPTIONS:
  s_vkorg  FOR vbak-vkorg MEMORY ID vko NO INTERVALS
                          OBLIGATORY,                       "js-004
  s_vtweg  FOR vbak-vtweg MEMORY ID vtw NO INTERVALS
                          OBLIGATORY,                       "js-004
  s_sparth FOR vbak-spart MEMORY ID spa NO INTERVALS
                          OBLIGATORY,                       "js-004
  s_spartd FOR vbap-spart,
  s_bzirk  FOR vbkd-bzirk,
  s_zfkrel FOR yse_sd_billrelev-zfkrel,
  s_vkbur  FOR vbak-vkbur,
  s_vkgrp  FOR vbak-vkgrp,
  s_prctr  FOR ce41000_acct-prctr,
  s_ww002  FOR ce41000_acct-ww002,
  s_ww006  FOR ce41000_acct-ww006,
  s_ww007  FOR ce41000_acct-ww007,
  s_gbstk  FOR vbuk-gbstk,
  s_werks  FOR vbap-werks,
  s_matnr  FOR vbap-matnr,
  s_abgru  FOR vbap-abgru,
  s_kunag  FOR vbak-kunnr,
  s_kunwe  FOR likp-kunnr,
  s_kunre  FOR vbpa-kunnr,
  s_hkunnr FOR knvh-hkunnr,
  s_pernr  FOR pa0003-pernr MATCHCODE OBJECT prem,
  s_bran1  FOR kna1-bran1,
  s_pstyv  FOR vbap-pstyv,
  s_mtpos  FOR mvke-mtpos,
  s_faksk  FOR vbak-faksk,
  s_lifsk  FOR vbak-lifsk,
  s_fkart  FOR vbrk-fkart,
*  s_erdat2 FOR vbrk-erdat,                      "js-001
  s_fkdat  FOR vbrk-fkdat,
  s_zuonr  FOR bseg-zuonr,
  s_cmgst  FOR vbuk-cmgst,          " credit status
  s_faksp  FOR fplt-faksp,          " Billing block
*** js-001 * begin ***
  s_mstav  FOR mara-mstav,
  s_mmsta  FOR marc-mmsta,
  s_kzaus  FOR marc-kzaus.
*** js-001 * end ***
PARAMETERS:
  p_dat_cc LIKE sy-datum DEFAULT sy-datum,
  p_kurst  LIKE tcurv-kurst DEFAULT 'EURX'.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) text-s12 FOR FIELD cb_edp .
PARAMETER p_no_dp TYPE c AS CHECKBOX .
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) text-s08 FOR FIELD cb_edp.
PARAMETER cb_edp TYPE c AS CHECKBOX.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (32) text-s10 FOR FIELD cb_spprd. "Supp Dup
PARAMETER cb_spprd TYPE c AS CHECKBOX.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b01.

*** js-001 * begin ***
*SELECTION-SCREEN BEGIN OF BLOCK b02 WITH FRAME.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (30) text-s03.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: rb_sel1 RADIOBUTTON GROUP sel DEFAULT 'X'.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (32) text-s06.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: rb_sel2 RADIOBUTTON GROUP sel.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (30) text-s04.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: rb_sel3 RADIOBUTTON GROUP sel.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN SKIP.
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT (30) text-s05.
*SELECTION-SCREEN POSITION POS_LOW.
*PARAMETERS: cb_sel AS CHECKBOX.
*SELECTION-SCREEN END OF LINE.
*SELECTION-SCREEN END OF BLOCK b02.
*** js-001 * end ***

SELECTION-SCREEN BEGIN OF BLOCK b03 WITH FRAME.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (25) text-s07.
SELECTION-SCREEN POSITION POS_LOW.
PARAMETERS: p_var   LIKE disvariant-variant.
SELECTION-SCREEN COMMENT 52(20) text-s09 FOR FIELD cb_lc.
PARAMETER cb_lc TYPE c AS CHECKBOX.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b03.

SELECTION-SCREEN BEGIN OF BLOCK b04 WITH FRAME.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) text-010 FOR FIELD r1.
PARAMETERS: r1 RADIOBUTTON GROUP rad1 DEFAULT 'X'.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) text-011 FOR FIELD r2.
PARAMETERS: r2 RADIOBUTTON GROUP rad1.
SELECTION-SCREEN END OF LINE.
*** js-001 * begin ***
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) text-015 FOR FIELD r3.
PARAMETERS: r3 RADIOBUTTON GROUP rad1.
SELECTION-SCREEN END OF LINE.
*** js-001 * end ***
*** js-002 * begin ***
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 4(75) text-016 FOR FIELD r4.
PARAMETERS: r4 RADIOBUTTON GROUP rad1.
SELECTION-SCREEN END OF LINE.
*** js-002 * end ***
SELECTION-SCREEN END OF BLOCK b04.


*********************************************************************
* Initialization of the selection screen                            *
*********************************************************************
INITIALIZATION.

  user_name = sy-uname.

  PERFORM restrict_so.

  PERFORM select_doctypes_to_display.                       "js-001


*********************************************************************
* Process selection screen                                          *
*********************************************************************
AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_auart-low.
  PERFORM doctypes_to_display CHANGING s_auart-low.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_auart-high.
  PERFORM doctypes_to_display CHANGING s_auart-high.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_var.
  PERFORM variant_inputhelp USING p_var.

AT SELECTION-SCREEN OUTPUT.
  PERFORM variant_init.
*  if p_var is initial and g_variant_flag is initial.
*    perform get_default_variant using p_var.
*    g_variant_flag = 'X'.
*  endif.

AT SELECTION-SCREEN.
  PERFORM check_authorization.
  PERFORM existence_variant USING p_var.
  PERFORM check_values_on_selections.


*********************************************************************
* START MAIN PROGRAM                                                *
*********************************************************************
START-OF-SELECTION.

  IF r1 EQ 'X'.
    PERFORM initialize_data.
    IF rb_sel1 = 'X'.                                       "js-001
*     "Sales orders entered"
      PERFORM select_data.
      PERFORM process_data.
      PERFORM get_end_customer_data.    " this wasn't here
    ENDIF.                                                  "js-001
*** js-001 * begin ***
    IF rb_sel2 = 'X'.
*     For "Sales orders not invoiced"
*     the table YSE_SD_SALES_OPN is used (for performance)
      PERFORM select_open_orders_table.
    ENDIF.
*** js-001 * end ***
*** js-002 * begin ***
    IF rb_sel3 = 'X'.
**     For "Sales orders invoiced"
**     the table YSE_SD_SALES_INV is used (for BO reporting)
*      PERFORM select_inv_orders_table.
      PERFORM select_data.
      PERFORM process_data.
      PERFORM get_end_customer_data.
    ENDIF.
*** js-002 * end ***
    PERFORM display_data.

  ELSEIF r2 EQ 'X' AND sy-batch NE 'X'.
*   kicks off background processing
    PERFORM start_background_processing.

  ELSEIF r2 EQ 'X' AND sy-batch EQ 'X'.
*   background processing is running and we execute.
*   calls misc functions
    PERFORM initialize_data.
    IF rb_sel1 = 'X'.                                       "js-001
*     "Sales orders entered"
      PERFORM select_data.
      PERFORM process_data.
      PERFORM get_end_customer_data.
    ENDIF.                                                  "js-001
*** js-001 * begin ***
    IF rb_sel2 = 'X'.
*     For "Sales orders not invoiced"
*     the table YSE_SD_SALES_OPN is used (for performance)
      PERFORM select_open_orders_table.
    ENDIF.
*** js-001 * end ***
*** js-002 * begin ***
    IF rb_sel3 = 'X'.
***     For "Sales orders invoiced"
***     the table YSE_SD_SALES_INV is used (for performance)
***     --> Table is used for BO reporting !
**      PERFORM select_inv_orders_table.
      PERFORM select_data.
      PERFORM process_data.
      PERFORM get_end_customer_data.
    ENDIF.
*** js-002 * end ***
*   PERFORM WRITE_TO_APP_SERVER.
    PERFORM send2spool.

*** js-001 * begin ***
  ELSEIF r3 EQ 'X' AND sy-batch EQ 'X'.
*   Open orders: background processing
*   (Upload table YSE_SD_SALES_OPN for performance)
    PERFORM initialize_data.
    PERFORM select_data.
    PERFORM process_data.
    PERFORM get_end_customer_data.
    PERFORM build_table_open_orders.
*** js-001 * end ***

*** js-002 * begin ***
  ELSEIF r4 EQ 'X' AND sy-batch EQ 'X'.
*   Invoiced orders: background processing
*   (Upload table YSE_SD_SALES_INV for BO reporting)
    PERFORM initialize_data.
    PERFORM select_data.
    PERFORM process_data.
    PERFORM get_end_customer_data.
    PERFORM build_table_inv_orders.
*** js-002 * end ***

  ENDIF.


*********************************************************************
* SUBROUTINES                                                       *
*********************************************************************

*&------------------------------------------------------------------*
*&      Form  GET_END_CUSTOMER_DATA
*&------------------------------------------------------------------*
FORM get_end_customer_data.

  DATA: BEGIN OF lt_end_cust_addr OCCURS 0,
          addrnumber   LIKE adrc-addrnumber,
          ecname1      LIKE adrc-name1,
          ecname2      LIKE adrc-name2,
          ecname3      LIKE adrc-name2,
          ecname4      LIKE adrc-name2,
          ecregio      LIKE adrc-region,
          eccity       LIKE adrc-city1,
          sort1        LIKE adrc-sort1,    " CR0128 20080530
      END OF lt_end_cust_addr.

  DATA: BEGIN OF lt_end_cust_district OCCURS 0,
          eccustn      LIKE knvv-kunnr,
          ecdisct      LIKE knvv-bzirk,
       END OF lt_end_cust_district.

  DATA: BEGIN OF lt_end_cust_rep OCCURS 0,
          eccustn      LIKE knvp-kunnr,
          ecsrep        LIKE knvp-pernr,
        END OF lt_end_cust_rep.

  DATA: BEGIN OF lt_end_cust_naics OCCURS 0,
          eccustn      LIKE kna1-kunnr,
          ecnaics      LIKE kna1-bran1,
        END OF lt_end_cust_naics.

  DATA: BEGIN OF lt_end_cust_hlcus OCCURS 0,
          eccustn      LIKE knvh-kunnr,
          echlcus      LIKE knvh-hkunnr,
          echlcus_adr  LIKE kna1-adrnr,
          name1      LIKE adrc-name1,
          name2      LIKE adrc-name2,
          name3      LIKE adrc-name3,
          name4      LIKE adrc-name4,
        END OF lt_end_cust_hlcus.

  DATA: BEGIN OF lt_vbpa_cust OCCURS 0,
          vbeln LIKE vbpa-vbeln,
          posnr LIKE vbpa-posnr,
          adrnr LIKE vbpa-adrnr,
          kunnr LIKE vbpa-kunnr,
          parvw LIKE vbpa-parvw,
        END OF lt_vbpa_cust.


* read end customer partner function (when ZE) into internal table

* the following selects relevant information into the table IT_VBPA5
* where certain conditions are met
  IF NOT it_vbap[] IS INITIAL.
*    SELECT * FROM vbpa INTO TABLE it_vbpa5 FOR ALL ENTRIES IN it_vbap
*                           WHERE vbeln = it_vbap-vbeln
*                           AND ( posnr = it_vbap-posnr OR posnr = '')
*                           AND parvw EQ 'ZE'.
    SELECT vbeln posnr adrnr kunnr parvw FROM vbpa
                INTO TABLE lt_vbpa_cust
                FOR ALL ENTRIES IN it_vbap
                     WHERE vbeln = it_vbap-vbeln
                     AND ( posnr = it_vbap-posnr OR posnr = '')
                     AND parvw EQ 'ZE'.

  ENDIF.
* we have declared a temorary internal table to improve performance
*  REFRESH it_vbpa5_temp.
*  it_vbpa5_temp[] = it_vbpa5[].
*  SORT it_vbpa5_temp BY adrnr.
*  DELETE ADJACENT DUPLICATES FROM it_vbpa5_temp COMPARING adrnr.

  SORT lt_vbpa_cust BY adrnr.

* a check is made to sure that the internal tables is not empty
*  IF NOT  it_vbpa5_temp[] IS INITIAL.
  IF NOT  lt_vbpa_cust[] IS INITIAL.
* the following select populates the lt_end_cust_addr table.
* for all entries has been used to improve performance
    IF r3 = ' '  AND                                        "js-001
       r4 = ' '.                                            "js-002
      SELECT addrnumber name1 name2 name3 name4 region city1
                             sort1       " CR0128  20080530
                            FROM adrc
                            INTO TABLE lt_end_cust_addr
                            FOR ALL ENTRIES IN lt_vbpa_cust
                            WHERE addrnumber = lt_vbpa_cust-adrnr.
    ENDIF.                                                  "js-001
* refresh and refil the temporary internal table
*    REFRESH it_vbpa5_temp.
*    it_vbpa5_temp[] = it_vbpa5[].
* we sort the table to improve performance
    SORT lt_vbpa_cust BY kunnr.
* we delete any duplicates from the table
* FOR ALL ENTRIES will do this!
*    DELETE ADJACENT DUPLICATES FROM it_vbpa5_temp COMPARING kunnr.
    IF NOT  lt_vbpa_cust[] IS INITIAL.
* we populate the lt_end_cust_district tables based on several
* conditions this table is to retrieve the end customer district
* as it is in a different table
      IF r3 = ' '  AND                                      "js-001
         r4 = ' '.                                          "js-002
        SELECT kunnr bzirk FROM knvv INTO TABLE lt_end_cust_district
                              FOR ALL ENTRIES IN lt_vbpa_cust
                              WHERE kunnr = lt_vbpa_cust-kunnr
                              AND vkorg = it_vbak-vkorg
                              AND vtweg = it_vbak-vtweg
                              AND spart = it_vbak-spart.
      ENDIF.                                                "js-001
* this is to select the end customer representative
      IF r3 = ' '  AND                                      "js-001
         r4 = ' '.                                          "js-002
        SELECT kunnr pernr FROM knvp INTO TABLE lt_end_cust_rep
                              FOR ALL ENTRIES IN lt_vbpa_cust
                              WHERE kunnr = lt_vbpa_cust-kunnr
                              AND vkorg = it_vbak-vkorg
                              AND vtweg = it_vbak-vtweg
                              AND spart = it_vbak-spart
                              AND pernr NE '00000000'.
      ENDIF.                                                "js-001
* this is to select the end customer NAICS code
      SELECT kunnr bran1 FROM kna1 INTO TABLE lt_end_cust_naics
                            FOR ALL ENTRIES IN lt_vbpa_cust
                            WHERE kunnr = lt_vbpa_cust-kunnr.
* this is to select the high level customer number
      SELECT knvh~kunnr knvh~hkunnr
             kna1~adrnr adrc~name1 adrc~name2 adrc~name3 adrc~name4
                      FROM knvh
                      JOIN kna1 ON kna1~kunnr = knvh~hkunnr
                      LEFT JOIN adrc ON adrc~addrnumber = kna1~adrnr
                      INTO TABLE lt_end_cust_hlcus
                            FOR ALL ENTRIES IN lt_vbpa_cust
                            WHERE knvh~kunnr = lt_vbpa_cust-kunnr.

* add new fields to the final table using a binary search
* and using keys to match them and then modify the relevant
* fields to the main internal table.
      DATA: lv_index TYPE sy-tabix.

      SORT lt_vbpa_cust BY vbeln posnr.
      SORT lt_end_cust_addr  BY addrnumber ASCENDING.
      SORT lt_end_cust_district BY eccustn ASCENDING.
      SORT lt_end_cust_rep  BY eccustn ASCENDING.
      SORT lt_end_cust_naics  BY eccustn ASCENDING.
      SORT lt_end_cust_hlcus  BY eccustn ASCENDING.

*** js-001 * begin ***
      IF r3 = 'X'.
*       Open orders
        LOOP AT it_sales_open ASSIGNING <sales_open>.

          CLEAR: lt_vbpa_cust, lt_end_cust_addr,
                lt_end_cust_district, lt_end_cust_rep,
                lt_end_cust_naics, lt_end_cust_hlcus.

          lv_index = sy-tabix.
          READ TABLE lt_vbpa_cust
               WITH KEY vbeln = <sales_open>-vbeln_ord
                        posnr = <sales_open>-posnr_ord
               BINARY SEARCH.
          <sales_open>-eccustn = lt_vbpa_cust-kunnr.
          <sales_open>-ecpartf = lt_vbpa_cust-parvw.

          IF <sales_open>-eccustn = ''.
            READ TABLE lt_vbpa_cust
                 WITH KEY vbeln = <sales_open>-vbeln_ord
                 BINARY SEARCH.
            <sales_open>-eccustn = lt_vbpa_cust-kunnr.
            <sales_open>-ecpartf = lt_vbpa_cust-parvw.
          ENDIF.

          READ TABLE lt_end_cust_naics
               WITH KEY eccustn = lt_vbpa_cust-kunnr
               BINARY SEARCH.
          <sales_open>-ecnaics = lt_end_cust_naics-ecnaics.

          READ TABLE lt_end_cust_hlcus
               WITH KEY eccustn = lt_vbpa_cust-kunnr
               BINARY SEARCH.
          <sales_open>-echlcus = lt_end_cust_hlcus-echlcus.

        ENDLOOP.
      ELSE.
*** js-001 * end ***
*** js-002 * begin ***
        IF r4 = 'X'.
*       Invoiced orders
          LOOP AT it_sales_inv ASSIGNING <sales_inv>.

            CLEAR: lt_vbpa_cust, lt_end_cust_addr,
                  lt_end_cust_district, lt_end_cust_rep,
                  lt_end_cust_naics, lt_end_cust_hlcus.

            lv_index = sy-tabix.
            READ TABLE lt_vbpa_cust
                 WITH KEY vbeln = <sales_inv>-vbeln_ord
                          posnr = <sales_inv>-posnr_ord
                 BINARY SEARCH.
            <sales_inv>-eccustn = lt_vbpa_cust-kunnr.
            <sales_inv>-ecpartf = lt_vbpa_cust-parvw.

            IF <sales_inv>-eccustn = ''.
              READ TABLE lt_vbpa_cust
                   WITH KEY vbeln = <sales_inv>-vbeln_ord
                   BINARY SEARCH.
              <sales_inv>-eccustn = lt_vbpa_cust-kunnr.
              <sales_inv>-ecpartf = lt_vbpa_cust-parvw.
            ENDIF.

            READ TABLE lt_end_cust_naics
                 WITH KEY eccustn = lt_vbpa_cust-kunnr
                 BINARY SEARCH.
            <sales_inv>-ecnaics = lt_end_cust_naics-ecnaics.

            READ TABLE lt_end_cust_hlcus
                 WITH KEY eccustn = lt_vbpa_cust-kunnr
                 BINARY SEARCH.
            <sales_inv>-echlcus = lt_end_cust_hlcus-echlcus.

          ENDLOOP.
        ELSE.
*** js-002 * end ***
          LOOP AT it_data ASSIGNING <x_data>.

            CLEAR: lt_vbpa_cust, lt_end_cust_addr,
                  lt_end_cust_district, lt_end_cust_rep,
                  lt_end_cust_naics, lt_end_cust_hlcus.

            lv_index = sy-tabix.
            READ TABLE lt_vbpa_cust
                WITH KEY vbeln = <x_data>-vbeln_ord
                         posnr = <x_data>-posnr_ord
                BINARY SEARCH.
            <x_data>-eccustn = lt_vbpa_cust-kunnr.
            <x_data>-ecpartf = lt_vbpa_cust-parvw.

            IF <x_data>-eccustn = ''.
              READ TABLE lt_vbpa_cust
              WITH KEY vbeln = <x_data>-vbeln_ord
*                          "POSNR = <x_data>-POSNR_ord
              BINARY SEARCH.
              <x_data>-eccustn = lt_vbpa_cust-kunnr.
              <x_data>-ecpartf = lt_vbpa_cust-parvw.
            ENDIF.

            READ TABLE lt_end_cust_addr
                    WITH KEY addrnumber = lt_vbpa_cust-adrnr
                    BINARY SEARCH.
            <x_data>-ecname1 = lt_end_cust_addr-ecname1.
            <x_data>-ecname2 = lt_end_cust_addr-ecname2.
            <x_data>-ecname3 = lt_end_cust_addr-ecname3.
            <x_data>-ecname4 = lt_end_cust_addr-ecname4.
            <x_data>-eccity  = lt_end_cust_addr-eccity.
            <x_data>-ecregio = lt_end_cust_addr-ecregio.
            <x_data>-sort1   = lt_end_cust_addr-sort1.

            READ TABLE lt_end_cust_district
                  WITH KEY eccustn = lt_vbpa_cust-kunnr
                  BINARY SEARCH.
            <x_data>-ecdisct = lt_end_cust_district-ecdisct.
            "LIKE KNVV-BZIRK,

            READ TABLE lt_end_cust_rep
                    WITH KEY eccustn = lt_vbpa_cust-kunnr
                    BINARY SEARCH.
            <x_data>-ecsrep =  lt_end_cust_rep-ecsrep.

            READ TABLE lt_end_cust_naics
                    WITH KEY eccustn = lt_vbpa_cust-kunnr
                    BINARY SEARCH.
            <x_data>-ecnaics = lt_end_cust_naics-ecnaics.

            READ TABLE lt_end_cust_hlcus
                    WITH KEY eccustn = lt_vbpa_cust-kunnr
                    BINARY SEARCH.
            <x_data>-echlcus = lt_end_cust_hlcus-echlcus.

            <x_data>-echlcus_nam1 = lt_end_cust_hlcus-name1.
*    <x_data>-echlcus_NAM3 = lt_end_cust_hlcus-name2.
*    <x_data>-echlcus_NAM4 = lt_end_cust_hlcus-name4.

          ENDLOOP.
        ENDIF.                                              "js-001
      ENDIF.                                                "js-002
    ENDIF.
  ENDIF.

ENDFORM.                    "GET_END_CUSTOMER_DATA

*********************************************************************
* SUBROUTINES  LEVEL 01                                             *
*********************************************************************

*&------------------------------------------------------------------*
*&      Form  START_BACKGROUND_PROCESSING
*&------------------------------------------------------------------*
FORM start_background_processing.

* this function is to schedule batch processing. this is needed as the
* report has become very complex and processing will now happen in
* the background
  CALL FUNCTION 'BP_JOBVARIANT_SCHEDULE'
    EXPORTING
      title_name = 'End Customer Report'(001)
      job_name   = 'customer_report'(002)
      prog_name  = 'YSE_SD_SALES'.

ENDFORM.                    "START_BACKGROUND_PROCESSING

*&------------------------------------------------------------------*
*&      Form  GET_FIELDNAME
*&------------------------------------------------------------------*
FORM get_fieldname USING p_roll LIKE dd03l-rollname
                         p_field LIKE dd03l-fieldname
                   CHANGING p_text.

  READ TABLE xt_dd04t WITH KEY rollname = p_roll
                      BINARY SEARCH.
  IF sy-subrc = 0.
    p_text = xt_dd04t-reptext.
  ELSE.
* field description defined in table definition
    READ TABLE xt_dd03t WITH KEY fieldname = p_field.
    IF sy-subrc = 0.
      p_text = xt_dd03t-ddtext.
    ENDIF.
  ENDIF.

ENDFORM.                    "get_fieldname

*&------------------------------------------------------------------*
*&      Form  SEND2SPOOL
*&------------------------------------------------------------------*
FORM send2spool .

  DATA: fnam             LIKE rlgrap-filename,
        it_outxls(4096)  TYPE c OCCURS 0,
        lv_fieldname(20) TYPE c,
        wa_outxls(4096)  TYPE c.

  CONSTANTS:
    c_tab TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.


* Build filename
  v_dat = sy-datum.
  v_tim = sy-uzeit.
  CONCATENATE '/var/load/' sy-sysid '/UK/original/YSE_SALES_'
              user_name '_' v_dat '_' v_tim '.TXT'
         INTO fnam.

* Make the output table ; delimited
  CALL FUNCTION 'SAP_CONVERT_TO_CSV_FORMAT'
    TABLES
      i_tab_sap_data       = it_data
    CHANGING
      i_tab_converted_data = it_outxls
    EXCEPTIONS
      conversion_failed    = 1
      OTHERS               = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* Open file
  OPEN DATASET fnam FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc <> 0.
    WRITE 'Error opening file. Action aborted.'.
    EXIT.
  ENDIF.

* Write header line
  CLEAR wa_outxls.
  SORT xt_dd03l BY position.
  LOOP AT xt_dd03l.
    PERFORM get_fieldname USING xt_dd03l-rollname
                                xt_dd03l-fieldname
                         CHANGING lv_fieldname.

*   field description in data element
    IF wa_outxls IS INITIAL.
      wa_outxls = lv_fieldname.
    ELSE.
      CONCATENATE wa_outxls c_tab lv_fieldname INTO wa_outxls.
    ENDIF.
  ENDLOOP.
  TRANSFER wa_outxls TO fnam.

* Process lines
  LOOP AT it_outxls INTO wa_outxls.
    REPLACE ALL OCCURRENCES OF ';' IN wa_outxls WITH c_tab.
    TRANSFER wa_outxls TO fnam.
  ENDLOOP.

* Close file
  CLOSE DATASET fnam.

  WRITE: 'Report output written to file: ', fnam.

ENDFORM.                    " SEND2SPOOL

*&------------------------------------------------------------------*
*&      Form  WRITE_TO_APP_SERVER
*&------------------------------------------------------------------*
FORM write_to_app_server.

  DATA: descr_ref TYPE REF TO cl_abap_structdescr.

  FIELD-SYMBOLS: <comp_wa> TYPE abap_compdescr.


* this form writes the contents of the internal table to a CSV file.
* in this case the seperator is not a comma but a |
* the user then retrieves the file using a program and can import this
* into excel.
  v_dat = sy-datum.
  v_tim = sy-uzeit.

*this function actually converts the data into a file
  CALL FUNCTION 'SAP_CONVERT_TO_TEX_FORMAT'
    EXPORTING
      i_field_seperator    = '|'
    TABLES
      i_tab_sap_data       = it_data "the internal table that u want
    CHANGING
      i_tab_converted_data = gt_csv
    EXCEPTIONS
      conversion_failed    = 1      "convert to csv format
      OTHERS               = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno WITH
    sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

** as we do not have the fields, we need to append them to line 1 of
** the text file
* CONCATENATE: 'VKORG' 'VTWEG' 'SPART' 'SPARTD' 'VKBUR' 'VKBUR_TXT'
* 'VKGRP' 'VKGRP_TXT' 'PRCTR' 'WW002' 'WW006' 'WW007' 'BSTKD' 'BZIRK'
* 'VDATU' 'EDATU' 'EBELN' 'ERDAT_ORD' 'ERNAM' 'AUART' 'BNDDT' 'WERKS'
* 'MATNR' 'MAKTX' 'PSTYV' 'MTPOS' 'KUNAG' 'NAME1_AG' 'REGION_AG'
* 'CITY1_AG' 'POST_CODE1_AG' 'KUNWE' 'NAME1_WE' 'REGION_WE' 'CITY1_WE'
* 'POST_CODE1_WE' 'KUNRE' 'NAME1_RE' 'HKUNNR' 'NAME1_HL' 'BRAN1'
* 'LFSTA' 'FKSAK' 'GBSTK' 'GBSTA' 'FAKSK' 'LIFSK'
* 'VBELN_ORD' 'POSNR_ORD' 'PARVW_VE' 'PERNR_VE' 'ENAME_VE' 'PARVW_ZX'
* 'PERNR_ZX' 'ENAME_ZX' 'PARVW_ZY' 'PERNR_ZY' 'ENAME_ZY' 'KWERT_ZPRO'
* 'WAERK_ZPRO' 'KZWI3_ORD' 'WAERK_ORD'
* 'KZWI3_CC_ORD'
*
* 'ZUNITPR' 'ZUNITPRCURR' 'ZUNITPR_CC'
* 'KWERT_ZPRS' 'WAERK_ZPRS' 'ZPROFIT' 'ZPROFCURR' 'ZPROFPERC'
* 'KWMENG' 'VRKME_ORD' 'LIFNR' 'NAME1_VEND' 'VBELN_DEL'
* 'POSNR_DEL' 'WBSTK' 'LFIMG' 'VRKME_DEL' 'ZQUANT_DEL' 'ZVRKME_DEL'
* 'WADAT_IST' 'FKART' 'VBELN_INV' 'POSNR_INV' 'FKIMG' 'VRKME_INV'
* 'KZWI3_INV' 'WAERK_INV' 'KZWI3_INV_CC' 'ERDAT_INV'
* 'FKDAT'
* 'ZQUANT_INV' 'ZVRKME_INV' 'ZAMOUNT' 'ZWAERK_INV' 'FPROZ' 'ZFPLVAL'
* 'KWMENG_OH'
* 'KZWI3_OH' 'KZWI3_OH_CC'
* 'KWERT_COS_OH' 'ZPROFIT_OH' 'ZPROFPC_OH' 'KWERT_COS_IN' 'ZPROFIT_IN'
* 'ZPROFPC_IN' 'ZUONR' 'ABGRU' 'SPNAME2' 'SHNAME2' 'BPNAME2'
* 'ECCUSTN' 'ECPARTF' 'ECNAME1' 'ECNAME2' 'ECDISCT' 'ECREGIO' 'ECCITY'
* 'ECSREP' 'ECNAICS' 'ECHLCUS'
* INTO gw_csv SEPARATED BY '|'.

* we have the fields
  CLEAR gw_csv.
  descr_ref ?= cl_abap_typedescr=>describe_by_name( 'IT_DATA' ).
  LOOP AT descr_ref->components ASSIGNING <comp_wa>.
    CONCATENATE gw_csv <comp_wa>-name '|' INTO gw_csv.
  ENDLOOP.

  INSERT gw_csv INTO gt_csv INDEX 1.
* here we set the filename and add in the username, date and time.
  CONCATENATE '/var/load/' sy-sysid '/END_CUST'
              '_' user_name '_' v_dat '_' v_tim '.txt'
         INTO file_name.
* we are preparing to write to file
  CONDENSE file_name.
  DELETE DATASET file_name.
  OPEN DATASET file_name FOR OUTPUT IN TEXT MODE
  ENCODING NON-UNICODE IGNORING CONVERSION ERRORS MESSAGE e_message.

  IF sy-subrc NE 0.
    MESSAGE e_message TYPE 'E'.
    EXIT.
  ELSE.
* we are actually writing to the file. the contents
* of the internal tab are placed in the file
    LOOP AT gt_csv INTO gw_csv.
      TRANSFER gw_csv TO file_name.
    ENDLOOP.
* we close the file
    CLOSE DATASET file_name.
* if there are any errors........
    IF sy-subrc NE 0.
      MESSAGE  'Error closing the File'(003) TYPE 'E'.
      EXIT.
    ELSEIF sy-subrc IS INITIAL.
      CONCATENATE 'File Saved as:'(004) file_name INTO file_name
      SEPARATED BY space.
      MESSAGE  file_name TYPE 'I'.
    ENDIF.
  ENDIF.

ENDFORM.                    "WRITE_TO_APP_SERVER

*&---------------------------------------------------------------------*
*&      Form  SELECT_DOCTYPES_TO_DISPLAY         "js-001
*&---------------------------------------------------------------------*
*       Select relevant document types to display
*----------------------------------------------------------------------*
FORM select_doctypes_to_display .

  DATA: lv_dd07 TYPE xtyp_dd07.


* Select descriptions
  CLEAR: xt_dd07.
  REFRESH: xt_dd07.
  SELECT dd07l~domname dd07t~ddlanguage dd07l~domvalue_l
         dd07l~domvalue_h dd07t~ddtext
        INTO TABLE xt_dd07
        FROM dd07l
        JOIN dd07t ON dd07t~domname = dd07l~domname
                  AND dd07t~as4local = dd07l~as4local
                  AND dd07t~valpos = dd07l~valpos
                  AND dd07t~ddlanguage = 'E'
        WHERE dd07l~domname = 'ZFKREL'
          AND dd07l~as4local = 'A'.

* Select relevant document types to display
  CLEAR: it_dtype.
  REFRESH: it_dtype.
  SELECT * FROM yse_sd_billrelev
           INTO CORRESPONDING FIELDS OF TABLE it_dtype.
* Add descriptions
  LOOP AT it_dtype.
    READ TABLE xt_dd07 INTO lv_dd07
        WITH KEY domname    = 'ZFKREL'
                 ddlanguage = 'E'
                 domvalue_l = it_dtype-zfkrel.
    IF sy-subrc = 0.
      it_dtype-ddtext = lv_dd07-ddtext.
      MODIFY it_dtype.
    ENDIF.
  ENDLOOP.

  CLEAR: xt_dd07.
  REFRESH: xt_dd07.

ENDFORM.                    " SELECT_DOCTYPES_TO_DISPLAY

*------------------------------------------------------------------*
*   Form  DOCTYPES_TO_DISPLAY                                      *
*------------------------------------------------------------------*
FORM doctypes_to_display CHANGING doctype.

*** js-001 * begin ***
** Select relevant document types to display
*  CLEAR: it_dtype.
*  REFRESH: it_dtype.
*  SELECT * FROM yse_sd_billrelev
*           INTO CORRESPONDING FIELDS OF TABLE it_dtype.
*** js-001 * end ***

* Call list with selected plants
  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      value_org       = 'S'
      retfield        = 'AUART'
      window_title    = 'Document types'
    TABLES
      value_tab       = it_dtype
      return_tab      = it_ddshretval
    EXCEPTIONS
      parameter_error = 1
      no_values_found = 2
      OTHERS          = 3.
  IF sy-subrc EQ 0.
    READ TABLE it_ddshretval INDEX 1.
    doctype = it_ddshretval-fieldval.
  ENDIF.

ENDFORM.                    " DOCTYPES_TO_DISPLAY

*------------------------------------------------------------------*
*   Form  VARIANT_INPUTHELP                                        *
*------------------------------------------------------------------*
*   F4 - help for variants                                         *
*------------------------------------------------------------------*
FORM variant_inputhelp USING var.

  CLEAR h_exit.
  CLEAR gx_variant.

  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      is_variant    = g_variant
      i_save        = g_variant_save
    IMPORTING
      e_exit        = h_exit
      es_variant    = gx_variant
    EXCEPTIONS
      not_found     = 1
      program_error = 2
      OTHERS        = 3.

  IF sy-subrc IS INITIAL AND h_exit IS INITIAL.
    g_variant-variant = gx_variant-variant.
    var               = gx_variant-variant.
  ENDIF.

ENDFORM.                    " VARIANT_INPUTHELP

*--------------------------------------------------------------------*
*   Form  VARIANT_INIT                                               *
*--------------------------------------------------------------------*
*   Initialize variant                                               *
*--------------------------------------------------------------------*
FORM variant_init.

  CLEAR g_variant.

  x_repid = sy-repid.
  g_variant-report = x_repid.

ENDFORM.                    " VARIANT_INIT

*--------------------------------------------------------------------*
*   Form  EXISTENCE_VARIANT                                          *
*--------------------------------------------------------------------*
*   Does the variant exist ?                                         *
*--------------------------------------------------------------------*
FORM existence_variant USING var LIKE g_variant-variant.

  IF NOT var IS INITIAL.
    g_variant-variant = var.
    CALL FUNCTION 'REUSE_ALV_VARIANT_EXISTENCE'
      EXPORTING
        i_save     = g_variant_save
      CHANGING
        cs_variant = g_variant.
  ELSE.
    PERFORM variant_init.
  ENDIF.

ENDFORM.                    " EXISTENCE_VARIANT

*-------------------------------------------------------------------*
*   Form  GET_DEFAULT_VARIANT                                       *
*-------------------------------------------------------------------*
*   If there is an existing default variant - get it                *
*-------------------------------------------------------------------*
FORM get_default_variant USING var.

  gx_variant = g_variant.

  CALL FUNCTION 'REUSE_ALV_VARIANT_DEFAULT_GET'
    EXPORTING
      i_save     = g_variant_save
    CHANGING
      cs_variant = gx_variant
    EXCEPTIONS
      not_found  = 2.

  IF sy-subrc IS INITIAL.
    var = gx_variant-variant.
  ENDIF.

ENDFORM.                    " GET_DEFAULT_VARIANT

*--------------------------------------------------------------------*
*   Form  CHECK_VALUES_ON_SELECTIONS                                 *
*--------------------------------------------------------------------*
FORM check_values_on_selections.

*LME
  DATA: lv_erdat LIKE vbap-erdat.


*** js-001 * begin ***
  IF r3 IS INITIAL  AND
     r4 IS INITIAL.                                         "js-002
    IF NOT rb_sel3 IS INITIAL.
      IF NOT s_erdat2 IS INITIAL.
        lv_erdat = s_erdat2-high - s_erdat2-low.
* MJ change
*    if lv_erdat > 30.
        IF lv_erdat > 92.
* MJ change
          MESSAGE e000(yse_sales_log) WITH text-e98.
        ENDIF.
      ELSE.
        MESSAGE e000(yse_sales_log) WITH text-e97.
      ENDIF.
    ELSE.
      IF NOT rb_sel1 IS INITIAL.
*** js-001 * end ***
        IF NOT s_erdat3 IS INITIAL.
          lv_erdat = s_erdat3-high - s_erdat3-low.
* MJ change
*    if lv_erdat > 30.
          IF lv_erdat > 92.
* MJ change
            MESSAGE e000(yse_sales_log) WITH text-e99.
          ENDIF.
*LME
*** js-001 * begin ***
        ELSE.
          MESSAGE e000(yse_sales_log) WITH text-e96.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

* Obligatory fields
  IF r3 IS INITIAL  AND
     r4 IS INITIAL.                                         "js-002
*   Sales Organization
    IF s_vkorg[] IS INITIAL.
      MESSAGE e000(yse_sales_log) WITH text-e94.
    ENDIF.
*   Distribution Channel
    IF s_vtweg[] IS INITIAL.
      MESSAGE e000(yse_sales_log) WITH text-e93.
    ENDIF.
*   Division (header level)
    IF s_sparth[] IS INITIAL.
      MESSAGE e000(yse_sales_log) WITH text-e92.
    ENDIF.
  ENDIF.
*** js-001 * end ***

  IF NOT rb_sel2 IS INITIAL.
    IF NOT s_fkart[] IS INITIAL.
      MESSAGE e025(yse_sales_log) WITH text-e03 text-e01.
    ENDIF.
    IF NOT s_erdat2[] IS INITIAL.
      MESSAGE e025(yse_sales_log) WITH text-e04 text-e01.
    ENDIF.
    IF NOT s_fkdat[] IS INITIAL.
      MESSAGE e025(yse_sales_log) WITH text-e05 text-e01.
    ENDIF.
  ELSEIF NOT rb_sel3 IS INITIAL.
    IF NOT s_fkart[] IS INITIAL.
      LOOP AT s_fkart WHERE low IS INITIAL AND high IS INITIAL.
        MESSAGE e026(yse_sales_log) WITH text-e03 text-e02.
      ENDLOOP.
    ENDIF.
    IF NOT s_erdat2[] IS INITIAL.
      LOOP AT s_erdat2 WHERE low IS INITIAL AND high IS INITIAL.
        MESSAGE e026(yse_sales_log) WITH text-e04 text-e02.
      ENDLOOP.
    ENDIF.
    IF NOT s_fkdat[] IS INITIAL.
      LOOP AT s_fkdat WHERE low IS INITIAL AND high IS INITIAL.
        MESSAGE e026(yse_sales_log) WITH text-e05 text-e02.
      ENDLOOP.
    ENDIF.
  ENDIF.

*** js-001 * begin ***
  IF r3 = 'X' AND rb_sel2 IS INITIAL.
    MESSAGE e000(yse_sales_log) WITH text-e95.
  ENDIF.
*** js-001 * end ***

*** js-002 * begin ***
  IF r4 = 'X' AND rb_sel3 IS INITIAL.
    MESSAGE e000(yse_sales_log) WITH text-e91.
  ENDIF.
*** js-002 * end ***

ENDFORM.                    " CHECK_VALUES_ON_SELECTIONS

*--------------------------------------------------------------------*
*   Form  INITIALIZE_DATA                                            *
*--------------------------------------------------------------------*
FORM initialize_data.

* Clear of internal tables also necessary at routine 'reset_data'
  CLEAR: it_vbak, it_vbap, it_vbep.
  CLEAR: it_likp, it_lips, it_vbrk, it_vbrp.
  CLEAR: it_likp2, it_lips2, it_vbrk2, it_vbrp2.
  CLEAR: it_vbpa1, it_vbpa4.
  CLEAR: it_vbfa1, it_vbfa2, it_vbfa3.
  CLEAR: xv_kna1_ag, xv_kna1_we, xv_kna1_re, it_kna1_hl.
  CLEAR: it_lfa1, xv_adrc, it_knvh.
  CLEAR: it_vbuk1, it_vbuk2, it_vbup, it_tvgrt, it_tvkbt, it_tvfk.
  CLEAR: it_acct, it_ce41000, it_makt, it_mvke, it_ekko.
  CLEAR: it_billrelev, xt_konv, it_vbkd, it_data.
*** js-001 * begin ***
  CLEAR: it_ekpo, it_mara, it_marc.
*** js-001 * end ***
  REFRESH: it_vbak, it_vbap, it_vbep.
  REFRESH: it_likp, it_lips, it_vbrk, it_vbrp.
  REFRESH: it_likp2, it_lips2, it_vbrk2, it_vbrp2.
  REFRESH: it_vbpa1, xt_vbpa3, it_vbpa4.
  REFRESH: it_vbfa1, it_vbfa2, it_vbfa3.
  REFRESH: xt_kna1.
  REFRESH: it_lfa1, xt_adrc, it_knvh.
  REFRESH: it_vbuk1, it_vbuk2, it_vbup, it_tvgrt, it_tvkbt, it_tvfk.
  REFRESH: it_acct, it_ce41000, it_makt, it_mvke, it_ekko.
  REFRESH: it_billrelev, xt_konv, it_vbkd, it_data.
*** js-001 * begin ***
  REFRESH: it_ekpo, it_mara, it_marc.
*** js-001 * end ***

  CLEAR: r_auart.
  REFRESH: r_auart.
  r_auart-sign   = 'I'.
  r_auart-option = 'EQ'.
  SELECT * FROM yse_sd_billrelev WHERE zfkrel IN s_zfkrel.
    r_auart-low = yse_sd_billrelev-auart.
    APPEND r_auart.
  ENDSELECT.

  CLEAR: r_parvw.
  REFRESH: r_parvw.
  r_parvw-sign   = 'I'.
  r_parvw-option = 'EQ'.
  r_parvw-low    = c_parvw_ve.  APPEND r_parvw.
  r_parvw-low    = c_parvw_zx.  APPEND r_parvw.
  r_parvw-low    = c_parvw_zy.  APPEND r_parvw.

  CLEAR: r_fareg.
  REFRESH: r_fareg.
  r_fareg-sign   = 'I'.
  r_fareg-option = 'EQ'.
  r_fareg-low    = c_fareg_4.  APPEND r_fareg.
  r_fareg-low    = c_fareg_5.  APPEND r_fareg.

* Get structure descriptions
* Get fields of structure 'YSE_SD_SALES_OUT'
  SELECT * FROM dd03l
           INTO TABLE xt_dd03l
           WHERE tabname = 'YSE_SD_SALES_OUT'.

* Get the descriptions of the fields in the structure
  SELECT * FROM dd04t
           INTO TABLE xt_dd04t
           FOR ALL ENTRIES IN xt_dd03l
           WHERE rollname EQ xt_dd03l-rollname
             AND ddlanguage EQ 'EN'.
* begin of delete lme004
*  SORT xt_dd04t BY rollname.
* end of delete lme004

* Get description defined for table:
* Get fields of structure 'YSE_SD_SALES_OUT'
  SELECT * FROM dd03t
           INTO TABLE xt_dd03t
           WHERE tabname = 'YSE_SD_SALES_OUT'.

*** js-001 * begin ***
* Background processing: select all not-invoiced sales orders
  IF r3 = 'X'.
    CLEAR cb_sel.
  ENDIF.
*** js-001 * end ***

*** js-002 * begin ***
* Background processing: select all invoiced sales orders
  IF r4 = 'X'.
    CLEAR cb_sel.
  ENDIF.
*** js-002 * end ***

*** js-004 * begin ***
* ASSO ?  --> Take delivered orders (not invoiced)
  CLEAR x_asso.
  IF NOT r4 IS INITIAL.
    LOOP AT s_auart WHERE low = 'ZO03'.
    ENDLOOP.
    IF sy-subrc = 0.
      x_asso = 'X'.
    ENDIF.
  ENDIF.
*** js-004 * end ***

ENDFORM.                    " INITIALIZE_DATA

*-------------------------------------------------------------------*
*   Form  SELECT_DATA                                               *
*-------------------------------------------------------------------*
FORM select_data.

  DATA: lt_adrnr TYPE TABLE OF xtyp_adrnr,
        lt_kdgrp TYPE TABLE OF xtyp_kdgrp,
        lv_adrnr TYPE xtyp_adrnr,
        lv_kdgrp TYPE xtyp_kdgrp,
        lv_tabix LIKE sy-tabix,
        lv_addrnumber LIKE adrc-addrnumber,
        lt_kunnr TYPE TABLE OF xtyp_kunnr,
        lv_vbpa LIKE LINE OF xt_vbpa3,
        lv_kunnr TYPE xtyp_adrnr.

  FIELD-SYMBOLS: <l_vbap> TYPE vbap.


* Get currency of company code related to provided sales org
  SELECT vkorg t001~waers
         INTO TABLE it_tvko
         FROM tvko
         JOIN t001 ON tvko~bukrs EQ t001~bukrs
         WHERE vkorg IN s_vkorg.
  SORT it_tvko BY vkorg.

*** js-005 * begin ***
  SELECT * INTO TABLE it_tvfk
         FROM tvfk.

  SELECT pstyv shkzg INTO TABLE it_tvap
         FROM tvap.
*** js-005 * end ***

*** js-001 * begin ***
  IF NOT rb_sel3 IS INITIAL  AND
     x_asso IS INITIAL.                                     "js-004
    SELECT vbeln bukrs fkart waerk fkdat erdat vbtyp fktyp
*** lme001 * begin ***
           kurrf
*** lme002 * end ***
            FROM vbrk INTO TABLE it_vbrk
            WHERE erdat IN s_erdat2
              AND vkorg IN s_vkorg
              AND vtweg IN s_vtweg                          "js-004
              AND spart IN s_sparth                         "js-004
              AND fkart IN s_fkart
              AND fkdat IN s_fkdat.
* begin of delete lme004
*    SORT it_vbrk BY vbeln.
* end of delete lme004
    DELETE ADJACENT DUPLICATES FROM it_vbrk.

    IF NOT it_vbrk[] IS INITIAL.
*     Read billing related orders into IT_VBFA2
      SELECT * FROM vbfa INTO TABLE it_vbfa2
               FOR ALL ENTRIES IN it_vbrk
               WHERE ( vbeln   EQ it_vbrk-vbeln )
                 AND ( vbtyp_n EQ c_vbtyp_m       " M - invoice
                    OR vbtyp_n EQ c_vbtyp_n       " N - Invoice canc.
                    OR vbtyp_n EQ c_vbtyp_s       " S - Canc.
                    OR vbtyp_n EQ c_vbtyp_o       " O - Credit memo
                    OR vbtyp_n EQ c_vbtyp_p )     " P - Debit Memo
*** lme001 * begin ***
                 AND rfmng > 0
*** lme001 * end ***
                 AND stufe EQ space.

      IF NOT it_vbfa2[] IS INITIAL.
*        SORT it_vbfa2 BY vbelv.                            "js-005
        it_vbfa1[] = it_vbfa2[].
*       Read deliveries and return deliveries into IT_VBFA2
        SELECT * FROM vbfa APPENDING TABLE it_vbfa2
                 FOR ALL ENTRIES IN it_vbfa1
                 WHERE vbeln   EQ it_vbfa1-vbelv
                   AND (   vbtyp_n EQ c_vbtyp_j   " J- delivery
                        OR vbtyp_n EQ c_vbtyp_t ) " T - return of del
*** lme001 * begin ***
                   AND rfmng > 0
*** lme001 * end ***
                   AND stufe EQ space.

*        SORT it_vbfa2 BY vbelv.                            "js-005
        SELECT * FROM vbap INTO TABLE it_vbap
                 FOR ALL ENTRIES IN it_vbfa2
                 WHERE vbeln EQ it_vbfa2-vbelv
                   AND vbeln IN s_vbeln
                   AND posnr IN s_posnr
                   AND erdat IN s_erdat3
                   AND matnr IN s_matnr
                   AND pstyv IN s_pstyv
                   AND spart IN s_spartd
                   AND werks IN s_werks
                   AND abgru IN s_abgru.
      ENDIF.
      REFRESH: it_vbfa1, it_vbfa2.
    ENDIF.
  ELSE.
*** js-001 * end ***
*   SELECT vbap moved UP!
*   We shall start with selection based on date FIRST
*            - the mandatory field

*        Begin of Insert Mod-0027 RSN.
*    SELECT * FROM vbap AS i
**            JOIN mara ON vbap~matnr = mara~matnr
**** js-004 * begin ***
**             INTO TABLE it_vbap
*             INNER JOIN vbak AS h
*                   ON i~vbeln = h~vbeln

    SELECT * FROM vbak AS h
*            JOIN mara ON vbap~matnr = mara~matnr
*** js-004 * begin ***
*             INTO TABLE it_vbap
             INNER JOIN vbap AS i
                   ON i~vbeln = h~vbeln
*        End of Insert Mod-0027 RSN.
             INTO CORRESPONDING FIELDS OF TABLE it_vbap
*** js-004 * end ***
             WHERE i~erdat IN s_erdat3
               AND i~vbeln IN s_vbeln                       " air23037
               AND i~posnr IN s_posnr
               AND i~matnr IN s_matnr
               AND i~pstyv IN s_pstyv
               AND i~spart IN s_spartd
               AND i~werks IN s_werks
               AND i~abgru IN s_abgru
*** js-004 * begin ***
               AND h~vkorg IN s_vkorg
               AND h~vtweg IN s_vtweg
               AND h~spart IN s_sparth.
*** js-004 * end ***
  ENDIF.                                                    "js-001

  IF NOT it_vbap[] IS INITIAL.
*    SORT it_vbap BY vbeln.                                 "js-005
    SELECT * FROM vbak INTO TABLE it_vbak
             FOR ALL ENTRIES IN it_vbap                     " air23037
             WHERE vbeln EQ it_vbap-vbeln                   " air23037
*               and erdat in r_date1
               AND erdat IN s_erdat1                        " CR0128
               AND ernam IN s_ernam
               AND vbtyp IN s_vbtyp
               AND auart IN s_auart
               AND auart IN r_auart
               AND lifsk IN s_lifsk
               AND faksk IN s_faksk
               AND vkorg IN s_vkorg
               AND vtweg IN s_vtweg
               AND spart IN s_sparth
*               AND vkorg = p_vkorg
*               AND vtweg = p_vtweg
*               AND spart = p_sparth
               AND vkgrp IN s_vkgrp
               AND vkbur IN s_vkbur
*** js-003 * begin ***
               AND bsark IN s_bsark
               AND ihrez IN s_ihrez
*** js-003 * end ***
*** lme001 * begin ***
               AND xblnr IN s_xblnr
*** lme001 * end ***
               AND vdatu IN s_vdatu
               AND kunnr IN s_kunag.

*   Delete unnecessary lines from it_vbap
    LOOP AT it_vbap ASSIGNING <l_vbap>.
      lv_tabix = sy-tabix.
      READ TABLE it_vbak WITH KEY vbeln = <l_vbap>-vbeln.
      IF sy-subrc <> 0.
        DELETE it_vbap INDEX lv_tabix.
      ENDIF.
    ENDLOOP.

    SORT it_vbak BY vbeln.
    CHECK NOT it_vbak[] IS INITIAL.

    SELECT * FROM yse_sd_billrelev INTO TABLE it_billrelev
             FOR ALL ENTRIES IN it_vbak
             WHERE auart  EQ it_vbak-auart
               AND zfkrel IN s_zfkrel.

    SELECT vbeln gbstk fksak cmgst FROM vbuk INTO TABLE it_vbuk1
           FOR ALL ENTRIES IN it_vbak
           WHERE vbeln EQ it_vbak-vbeln
             AND gbstk IN s_gbstk
             AND cmgst IN s_cmgst.                          "4244
    .
    SORT it_vbuk1 BY vbeln.

    SELECT dd07l~domname dd07t~ddlanguage dd07l~domvalue_l  " 4244
           dd07l~domvalue_h dd07t~ddtext
           INTO TABLE xt_dd07
           FROM dd07l
           JOIN dd07t ON dd07t~domname = dd07l~domname
                     AND dd07t~as4local = dd07l~as4local
                     AND dd07t~valpos = dd07l~valpos
                     AND dd07t~ddlanguage = 'E'
*           FOR ALL ENTRIES IN it_vbuk1
           WHERE dd07l~domname = 'CMGST' OR dd07l~domname = 'FAREG'
             AND dd07l~as4local = 'A'.
*             AND dd07l~DOMVALUE_L  = it_vbuk1-cmgst.

*    SELECT * FROM tvkbt INTO TABLE it_tvkbt                "js-005
    SELECT * FROM tvkbt INTO TABLE it_tvkbti                "js-005
             FOR ALL ENTRIES IN it_vbak
             WHERE spras EQ sy-langu
               AND vkbur EQ it_vbak-vkbur.
* begin of delete lme004
*    SORT it_tvkbt BY vkbur spras.
* end of delete lme004
*** js-005 * begin ***
*    DELETE ADJACENT DUPLICATES FROM it_tvkbt.
    SORT it_tvkbti BY spras vkbur.
    DELETE ADJACENT DUPLICATES FROM it_tvkbti
           COMPARING spras vkbur.
    it_tvkbt[] = it_tvkbti[].
*** js-005 * begin ***

*    SELECT * FROM tvgrt INTO TABLE it_tvgrt                "js-005
    SELECT * FROM tvgrt INTO TABLE it_tvgrti                "js-005
             FOR ALL ENTRIES IN it_vbak
             WHERE spras EQ sy-langu
               AND vkgrp EQ it_vbak-vkgrp.
* begin of delete lme004
*    SORT it_tvgrt BY vkgrp spras.
* end of delete lme004
*** js-005 * begin ***
*    DELETE ADJACENT DUPLICATES FROM it_tvgrt.
    SORT it_tvgrti BY spras vkgrp.
    DELETE ADJACENT DUPLICATES FROM it_tvgrti
           COMPARING spras vkgrp.
    it_tvgrt[] = it_tvgrti[].
*** js-005 * end ***

*    SELECT * FROM vbkd INTO TABLE it_vbkd                  "js-005
    SELECT * FROM vbkd INTO TABLE it_vbkdi                  "js-005
             FOR ALL ENTRIES IN it_vbak
             WHERE vbeln EQ it_vbak-vbeln
               AND bzirk IN s_bzirk.
*** js-005 * begin ***
    SORT it_vbkdi BY vbeln posnr.
    DELETE ADJACENT DUPLICATES FROM it_vbkdi
           COMPARING vbeln posnr.
    it_vbkd[] = it_vbkdi[].
*** js-005 * end ***

*   We shall start with selection based on date FIRST
*                 - that's the mandatory field
*    SELECT * FROM vbap INTO TABLE it_vbap
*                       FOR ALL ENTRIES IN it_vbak
*                       WHERE vbeln EQ it_vbak-vbeln
*                         AND posnr IN s_posnr
*                         AND matnr IN s_matnr
*                         AND pstyv IN s_pstyv
*                         AND spart IN s_spartd
*                         AND werks IN s_werks
*                         AND abgru IN s_abgru
*                         AND ERDAT IN S_ERDAT3.

    IF NOT it_vbap[] IS INITIAL.

*      SELECT * FROM vbup INTO TABLE it_vbup                "js-005
      SELECT * FROM vbup INTO TABLE it_vbupi                "js-005
               FOR ALL ENTRIES IN it_vbap
               WHERE vbeln EQ it_vbap-vbeln
                 AND posnr EQ it_vbap-posnr.
*** js-005 * begin ***
      SORT it_vbupi BY vbeln posnr.
      DELETE ADJACENT DUPLICATES FROM it_vbupi
             COMPARING vbeln posnr.
      it_vbup[] = it_vbupi[].
*** js-005 * end ***

*>>>>> BEGIN OF INSERT EXTUVE 20090805
*      SELECT * FROM makt INTO TABLE it_makt
*                         FOR ALL ENTRIES IN it_vbap
*                         WHERE matnr EQ it_vbap-matnr
*                           AND spras EQ sy-langu.
      CHECK NOT it_vbap[] IS INITIAL.                       " MOD-019
      SELECT matnr arktx FROM vbap
                            INTO CORRESPONDING FIELDS OF TABLE it_makt
                            FOR ALL ENTRIES IN it_vbap
                            WHERE vbeln = it_vbap-vbeln
                              AND posnr = it_vbap-posnr.
*>>>>> END OF INSERT EXTUVE 20090805
      SORT it_makt BY matnr arktx.
      DELETE ADJACENT DUPLICATES FROM it_makt.

*      SELECT * FROM mvke INTO TABLE it_mvke                "js-005
      SELECT * FROM mvke INTO TABLE it_mvkei                "js-005
               FOR ALL ENTRIES IN it_vbap
               WHERE matnr EQ it_vbap-matnr
                 AND vkorg IN s_vkorg
                 AND vtweg IN s_vtweg
*                 AND vkorg = p_vkorg
*                 AND vtweg = p_vtweg
                 AND mtpos IN s_mtpos.

*** js-001 * begin ***
* begin of delete lme004
*      SORT it_mvke BY matnr vkorg vtweg.
* end of delete lme004
*** js-005 * begin ***
*      DELETE ADJACENT DUPLICATES FROM it_mvke.
      SORT it_mvkei BY matnr vkorg vtweg.
      DELETE ADJACENT DUPLICATES FROM it_mvkei
             COMPARING matnr vkorg vtweg.
      it_mvke[] = it_mvkei[].
*** js-005 * end ***

      SELECT matnr mstav FROM mara INTO TABLE it_mara
                         FOR ALL ENTRIES IN it_mvke
                         WHERE matnr EQ it_mvke-matnr
                           AND mstav IN s_mstav.
      SORT it_mara BY matnr.
      DELETE ADJACENT DUPLICATES FROM it_mara.

      SELECT matnr werks mmsta kzaus
             FROM marc INTO TABLE it_marc
             FOR ALL ENTRIES IN it_mara
             WHERE matnr EQ it_mara-matnr
               AND werks IN s_werks
               AND mmsta IN s_mmsta
               AND kzaus IN s_kzaus.
      SORT it_marc BY matnr werks.
      DELETE ADJACENT DUPLICATES FROM it_marc.
*** js-001 * end ***

      SELECT aktbo paobjnr pasubnr ce4key
             FROM ce41000_acct
             INTO TABLE it_acct
             FOR ALL ENTRIES IN it_vbap
             WHERE aktbo   EQ 'X'
               AND paobjnr EQ it_vbap-paobjnr.
      IF NOT it_acct[] IS INITIAL.
        SORT it_acct BY paobjnr.
        DELETE ADJACENT DUPLICATES FROM it_acct.

        SELECT aktbo paobjnr pasubnr prctr ww002 ww006 ww007
               ww009 ktgrd
               FROM ce41000
               INTO TABLE it_ce41000
               FOR ALL ENTRIES IN it_acct
               WHERE aktbo EQ 'X'
                 AND paobjnr EQ it_acct-ce4key
                 AND prctr   IN s_prctr
                 AND ww002   IN s_ww002
                 AND ww006   IN s_ww006
                 AND ww007   IN s_ww007.
        DELETE ADJACENT DUPLICATES FROM it_ce41000.
      ENDIF.
    ENDIF.

*    SELECT * FROM konv INTO TABLE xt_konv                  "js-005
    SELECT * FROM konv INTO TABLE xt_konvi                  "js-005
             FOR ALL ENTRIES IN it_vbak
             WHERE knumv EQ it_vbak-knumv
               AND (   kschl EQ c_kschl_zpro
                    OR kschl EQ c_kschl_zprs
*** lme001 * begin ***
                    OR kschl EQ c_kschl_zurs
*** lme001 * end ***
                    OR kschl EQ c_kschl_zd00 ).             "js-002
*** js-005 * begin ***
    SORT xt_konvi BY knumv kposn kschl.
    DELETE ADJACENT DUPLICATES FROM xt_konvi
           COMPARING knumv kposn kschl.
    xt_konv[] = xt_konvi[].
*** js-005 * end ***

    SELECT DISTINCT vbpa~vbeln vbpa~posnr vbpa~parvw vbpa~kunnr
                    vbpa~adrnr
           knvv~kdgrp
           FROM vbpa
           LEFT JOIN knvv ON knvv~kunnr = vbpa~kunnr
                        AND knvv~vkorg = it_vbak-vkorg
                        AND knvv~vtweg = it_vbak-vtweg
                        AND knvv~spart = it_vbak-spart
           INTO TABLE it_vbpa1
           FOR ALL ENTRIES IN it_vbak
           WHERE vbeln EQ it_vbak-vbeln
                         AND parvw EQ c_parvw_ag.  " Soldto
*    DELETE ADJACENT DUPLICATES FROM it_vbpa1.

    IF NOT it_vbpa1[] IS INITIAL.
      LOOP AT it_vbpa1.
        lv_kunnr = it_vbpa1-kunnr.  APPEND lv_kunnr TO lt_kunnr.
        lv_adrnr = it_vbpa1-adrnr.  APPEND lv_adrnr TO lt_adrnr.
        lv_kdgrp = it_vbpa1-kdgrp.  APPEND lv_kdgrp TO lt_kdgrp.
      ENDLOOP.

      SORT lt_kdgrp.
      IF NOT lt_kdgrp[] IS INITIAL.
        SELECT kdgrp spras ktext FROM t151t
            INTO TABLE xt_kdgrp
            FOR ALL ENTRIES IN lt_kdgrp
            WHERE ( spras = 'E'      AND kdgrp = lt_kdgrp-kdgrp )
               OR ( spras = sy-langu AND kdgrp = lt_kdgrp-kdgrp ).
      ENDIF.
    ENDIF.

    SELECT DISTINCT vbpa~vbeln vbpa~posnr vbpa~parvw vbpa~kunnr
                    vbpa~adrnr
           FROM vbpa
           INTO TABLE xt_vbpa2
           FOR ALL ENTRIES IN it_vbak
           WHERE vbeln EQ it_vbak-vbeln
             AND parvw EQ c_parvw_we
             AND vbpa~kunnr IN s_kunwe.

    IF NOT xt_vbpa2[] IS INITIAL.
*      SORT it_vbpa2.        " BY vbeln posnr parvw.
*      DELETE ADJACENT DUPLICATES FROM it_vbpa2.
      LOOP AT xt_vbpa2 INTO lv_vbpa.
        lv_kunnr = lv_vbpa-kunnr.    APPEND lv_kunnr TO lt_kunnr.
        lv_adrnr = lv_vbpa-adrnr.    APPEND lv_adrnr TO lt_adrnr.
      ENDLOOP.
    ENDIF.

    SELECT DISTINCT vbeln posnr parvw kunnr adrnr
           FROM vbpa INTO TABLE xt_vbpa3
           FOR ALL ENTRIES IN it_vbak
           WHERE vbeln EQ it_vbak-vbeln
             AND parvw EQ c_parvw_re
             AND kunnr IN s_kunre.

    IF NOT xt_vbpa3[] IS INITIAL.
*      SORT xt_vbpa3 BY vbeln posnr parvw.
*      DELETE ADJACENT DUPLICATES FROM xt_vbpa3.
*>>>AIR22296 13/2/8: we need the info from document, not from master
*   data
      LOOP AT xt_vbpa3 INTO lv_vbpa.
        lv_kunnr = lv_vbpa-kunnr.    APPEND lv_kunnr TO lt_kunnr.
        lv_adrnr = lv_vbpa-adrnr.    APPEND lv_adrnr TO lt_adrnr.
      ENDLOOP.
*<<<AIR22296
    ENDIF.

    SELECT * FROM vbpa INTO TABLE it_vbpa4
             FOR ALL ENTRIES IN it_vbak
             WHERE vbeln EQ it_vbak-vbeln
               AND parvw IN r_parvw.
*               and pernr in s_pernr.
    DELETE ADJACENT DUPLICATES FROM it_vbpa4.

*    SELECT * FROM knvh INTO TABLE it_knvh                  "js-005
    SELECT * FROM knvh INTO TABLE it_knvhi                  "js-005
             FOR ALL ENTRIES IN it_vbak
             WHERE hityp  EQ c_hityp_a
               AND kunnr  EQ it_vbak-kunnr
               AND vkorg  EQ it_vbak-vkorg
               AND vtweg  EQ it_vbak-vtweg
               AND spart  EQ it_vbak-spart
               AND datab  LE it_vbak-erdat
               AND datbi  GE it_vbak-erdat
               AND hkunnr IN s_hkunnr.

* begin of delete lme004
*    SORT it_knvh BY hityp kunnr vkorg vtweg spart.
* end of delete lme004
*** js-005 * begin ***
*    DELETE ADJACENT DUPLICATES FROM it_knvh.
    SORT it_knvhi BY hityp kunnr vkorg vtweg spart.
    DELETE ADJACENT DUPLICATES FROM it_knvhi
           COMPARING hityp kunnr vkorg vtweg spart.
    it_knvh[] = it_knvhi[].

    IF NOT it_knvh[] IS INITIAL.
      SELECT kunnr adrnr bran1 name1 FROM kna1
*             INTO TABLE it_kna1_hl                         "js-005
             INTO TABLE it_kna1_hli                         "js-005
             FOR ALL ENTRIES IN it_knvh
             WHERE kunnr EQ it_knvh-hkunnr.
      IF sy-subrc = 0.
* begin of delete lme004
*        SORT it_kna1_hl BY kunnr.
* end of delete lme004
*** js-005 * begin ***
*        DELETE ADJACENT DUPLICATES FROM it_kna1_hl.
        SORT it_kna1_hli BY kunnr.
        DELETE ADJACENT DUPLICATES FROM it_kna1_hli
               COMPARING kunnr.
        it_kna1_hl[] = it_kna1_hli[].
*** js-005 * end ***
*       get address data for High Level Customer
        LOOP AT it_kna1_hl.
          lv_adrnr = it_kna1_hl-adrnr.  APPEND lv_adrnr TO lt_adrnr.
        ENDLOOP.
      ENDIF.
    ENDIF.

    SELECT * FROM vbep INTO TABLE it_vbep
             FOR ALL ENTRIES IN it_vbak
             WHERE vbeln EQ it_vbak-vbeln
               AND edatu IN s_edatu.

* begin gru001
    SELECT * FROM vbep INTO TABLE it_vbepr
             FOR ALL ENTRIES IN it_vbak
             WHERE vbeln EQ it_vbak-vbeln
               AND edatu IN s_vdatu
               AND etenr = '0001'.
* end gru001

*   Read deliveries and return deliveries into IT_VBFA1
    SELECT * FROM vbfa INTO TABLE it_vbfa1
             FOR ALL ENTRIES IN it_vbak
             WHERE vbelv   EQ it_vbak-vbeln
               AND (    vbtyp_n EQ c_vbtyp_j   " J - delivery
                     OR vbtyp_n EQ c_vbtyp_t ) " T - return of del
               AND vbtyp_v EQ it_vbak-vbtyp
*Begin of changes by EXTSPA on 8th April 2014 for CR3042   MOD-002
**** lme001 * begin ***
*               AND RFMNG > 0
**** lme001 * end ***
*End of changes by EXTSPA on 8th April 2014 for CR3042   MOD-002
               AND stufe EQ space.

    IF NOT it_vbfa1[] IS INITIAL.

*      SELECT * FROM likp INTO TABLE it_likp                "js-005
      SELECT * FROM likp INTO TABLE it_likpi                "js-005
                         FOR ALL ENTRIES IN it_vbfa1
                         WHERE vbeln EQ it_vbfa1-vbeln.
* begin of delete lme004
*      SORT it_likp BY vbeln.
* end of delete lme004
*** js-005 * begin ***
*      DELETE ADJACENT DUPLICATES FROM it_likp.
      SORT it_likpi BY vbeln.
      DELETE ADJACENT DUPLICATES FROM it_likpi
             COMPARING vbeln.
      it_likp[] = it_likpi[].
*** js-005 * end ***
      it_likp2[] = it_likp[].

      IF NOT it_likp[] IS INITIAL.

*        SELECT * FROM vbuk INTO TABLE it_vbuk2             "js-005
        SELECT * FROM vbuk INTO TABLE it_vbuk2i             "js-005
                           FOR ALL ENTRIES IN it_likp
                           WHERE vbeln EQ it_likp-vbeln
                               AND cmgst IN s_cmgst.        "4244
*** js-005 * begin ***
        SORT it_vbuk2i BY vbeln.
        DELETE ADJACENT DUPLICATES FROM it_vbuk2i
               COMPARING vbeln.
        it_vbuk2[] = it_vbuk2i[].
*** js-005 * end ***

        SELECT * FROM lips INTO TABLE it_lips
                           FOR ALL ENTRIES IN it_likp
                           WHERE vbeln EQ it_likp-vbeln.
        it_lips2[] = it_lips[].

*       Read delivery based billing docs into IT_VBFA2
        SELECT * FROM vbfa INTO TABLE it_vbfa2
                 FOR ALL ENTRIES IN it_likp
                 WHERE ( vbelv   EQ it_likp-vbeln )
                   AND ( vbtyp_n EQ c_vbtyp_m      " M - invoice
                      OR vbtyp_n EQ c_vbtyp_n      " N - Invoice canc.
*** js-006 * begin ***
                      OR vbtyp_n EQ c_vbtyp_p      " P - Debit Memo
                      OR vbtyp_n EQ c_vbtyp_s      " S - Canc.
*** js-006 * end ***
                      OR vbtyp_n EQ c_vbtyp_o )    " O - Credit memo
                   AND ( vbtyp_v EQ it_likp-vbtyp )
*** lme001 * begin ***
                   AND rfmng > 0
*** lme001 * end ***
                   AND stufe EQ space.

      ENDIF.

    ENDIF.

*   Read order related billing docs into IT_VBFA2
    SELECT * FROM vbfa APPENDING TABLE it_vbfa2
             FOR ALL ENTRIES IN it_vbak
             WHERE ( vbelv   EQ it_vbak-vbeln )
               AND ( vbtyp_n EQ c_vbtyp_m      " M - invoice
                  OR vbtyp_n EQ c_vbtyp_n      " N - Invoice canc.
* LME insert
                  OR vbtyp_n EQ c_vbtyp_s      " S - Canc.
* LME insert
                  OR vbtyp_n EQ c_vbtyp_o      " O - Credit memo
                  OR vbtyp_n EQ c_vbtyp_p )    " P - Debit Memo
* MJ deletion
*               AND ( vbtyp_v EQ it_vbak-vbtyp )
* MJ deletion
*** lme001 * begin ***
               AND rfmng > 0
*** lme001 * end ***
               AND stufe EQ space.

    IF NOT it_vbfa2[] IS INITIAL.

*     Get billing plan details
      SELECT fplnr fpltr fproz fakwr faksp FROM fplt INTO TABLE it_fplt
             FOR ALL ENTRIES IN it_vbfa2
             WHERE fplnr EQ it_vbfa2-fplnr
               AND fpltr EQ it_vbfa2-fpltr
               AND faksp IN s_faksp.

      SELECT vbeln bukrs fkart waerk fkdat erdat vbtyp fktyp
*** lme001 * begin ***
             kurrf
*** lme002 * end ***
             FROM vbrk INTO TABLE it_vbrk
             FOR ALL ENTRIES IN it_vbfa2
             WHERE vbeln EQ it_vbfa2-vbeln
               AND fkart IN s_fkart
               AND fkdat IN s_fkdat
*               and erdat in r_date2.
               AND erdat IN s_erdat2.
* begin of delete lme004
*      SORT it_vbrk BY vbeln.
* end of delete lme004
      DELETE ADJACENT DUPLICATES FROM it_vbrk.

      IF NOT it_vbrk[] IS INITIAL.

*** js-005 * begin ***
*        SELECT * FROM tvfk INTO TABLE it_tvfk
*                 FOR ALL ENTRIES IN it_vbrk
*                 WHERE fkart EQ it_vbrk-fkart.
*        DELETE ADJACENT DUPLICATES FROM it_tvfk.
*** js-005 * end ***

*       Depending on checkbox, restrict billing items at FAREG
        IF NOT cb_edp IS INITIAL.
          SELECT vbeln posnr netwr vrkme kzwi3 fareg fkimg fplnr
                 aubel aupos
* LME insert
                 pstyv
* LME insert
                 FROM vbrp INTO TABLE it_vbrp
                 FOR ALL ENTRIES IN it_vbrk
                 WHERE vbeln EQ it_vbrk-vbeln
                   AND fareg NE '4'
                   AND fareg NE '5'.
        ELSE.
          SELECT vbeln posnr netwr vrkme kzwi3 fareg fkimg fplnr
                 aubel aupos
* LME insert
                 pstyv
* LME insert
                 FROM vbrp INTO TABLE it_vbrp
                 FOR ALL ENTRIES IN it_vbrk
                 WHERE vbeln EQ it_vbrk-vbeln.  " TVO

* issue 4244, Spec 3.1.3  - zero downpayment lines.
          IF p_no_dp = 'X'.
            LOOP AT it_vbrp WHERE fareg = '4' OR fareg = '5'.
              it_vbrp-netwr = 0.
              it_vbrp-kzwi3 = 0.    " KZWI3_INV - InvNetValue
              it_vbrp-fkimg = 0.
              MODIFY it_vbrp.
            ENDLOOP.
          ENDIF.
        ENDIF.
      ENDIF.

*** js-005 * begin ***
*      SORT it_vbrp BY vbeln posnr.
      DELETE ADJACENT DUPLICATES FROM it_vbrp COMPARING vbeln posnr.
*** js-005 * begin ***

      SELECT vbeln bukrs fkart waerk fkdat erdat vbtyp fktyp
             FROM vbrk INTO TABLE it_vbrk2
             FOR ALL ENTRIES IN it_vbfa2
             WHERE vbeln EQ it_vbfa2-vbeln.
* begin of delete lme004
*      SORT it_vbrk2 BY vbeln.
* end of delete lme004
      DELETE ADJACENT DUPLICATES FROM it_vbrk2.

      IF NOT it_vbrk2[] IS INITIAL.
        SELECT vbeln posnr netwr vrkme kzwi3 fareg fkimg fplnr
               aubel aupos
* LME insert
               pstyv
* LME insert
               FROM vbrp INTO TABLE it_vbrp2
               FOR ALL ENTRIES IN it_vbrk2
               WHERE vbeln EQ it_vbrk2-vbeln.
* issue 4244, Spec 3.1.3  - zero downpayment lines.
        IF p_no_dp = 'X'.
          LOOP AT it_vbrp2 WHERE fareg = '4' OR fareg = '5'.
            it_vbrp2-netwr = 0.
            it_vbrp2-kzwi3 = 0.    " KZWI3_INV - InvNetValue
            it_vbrp2-fkimg = 0.
            MODIFY it_vbrp2.
          ENDLOOP.
        ENDIF.
      ENDIF.

    ENDIF.

*   Read purchase orders into IT_VBFA3
*    SELECT * FROM vbfa INTO TABLE it_vbfa3                 "js-005
    SELECT * FROM vbfa INTO TABLE it_vbfa3i                 "js-005
             FOR ALL ENTRIES IN it_vbak
             WHERE vbelv   EQ it_vbak-vbeln
               AND vbtyp_n EQ c_vbtyp_v       " V - Purchase Order
               AND vbtyp_v EQ it_vbak-vbtyp
               AND rfmng > 0            " Issue: 4727
               AND stufe EQ space.
*** js-005 * begin ***
    SORT it_vbfa3i BY vbelv posnv vbtyp_n vbtyp_v.
    DELETE ADJACENT DUPLICATES FROM it_vbfa3i
           COMPARING vbelv posnv vbtyp_n vbtyp_v.
    it_vbfa3[] = it_vbfa3i[].
*** js-005 * end ***

    IF NOT it_vbfa3[] IS INITIAL.

*      SELECT * FROM ekko INTO TABLE it_ekko                "js-005
      SELECT * FROM ekko INTO TABLE it_ekkoi                "js-005
               FOR ALL ENTRIES IN it_vbfa3
               WHERE ebeln EQ it_vbfa3-vbeln
                 AND ebeln IN s_ebeln.
*** js-005 * begin ***
      SORT it_ekkoi BY ebeln.
      DELETE ADJACENT DUPLICATES FROM it_ekkoi
             COMPARING ebeln.
      it_ekko[] = it_ekkoi[].
*** js-005 * end ***

      IF NOT it_ekko[] IS INITIAL.

*        SELECT * FROM lfa1 INTO TABLE it_lfa1              "js-005
        SELECT * FROM lfa1 INTO TABLE it_lfa1i              "js-005
                 FOR ALL ENTRIES IN it_ekko
                WHERE lifnr EQ it_ekko-lifnr.
*** js-005 * begin ***
*        DELETE ADJACENT DUPLICATES FROM it_lfa1 COMPARING lifnr.
        SORT it_lfa1i BY lifnr.
        DELETE ADJACENT DUPLICATES FROM it_lfa1i
               COMPARING lifnr.
        it_lfa1[] = it_lfa1i[].
*** js-005 * end ***

*** js-001 * begin ***
        SELECT ebeln ebelp FROM ekpo INTO TABLE it_ekpo
               FOR ALL ENTRIES IN it_ekko
               WHERE ebeln EQ it_ekko-ebeln.
*** js-001 * end ***
      ENDIF.

    ENDIF.

  ENDIF.

  SORT lt_adrnr.
  DELETE ADJACENT DUPLICATES FROM lt_adrnr.

  IF NOT lt_adrnr[] IS INITIAL.
*    SELECT * FROM adrc INTO TABLE xt_adrc                  "js-005
    SELECT * FROM adrc INTO TABLE xt_adrci                  "js-005
             FOR ALL ENTRIES IN lt_adrnr
             WHERE addrnumber EQ lt_adrnr-adrnr
               AND date_from  LE sy-datum.
*   keep only the latest
*    SORT xt_adrc BY addrnumber date_from DESCENDING.       "js-005
    SORT xt_adrci BY addrnumber date_from DESCENDING.       "js-005
    CLEAR xv_adrc_endcustomer.
*** js-005 * begin ***
*    LOOP AT xt_adrc INTO xv_adrc_endcustomer.
*      lv_tabix = sy-tabix.
*      IF lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*        DELETE xt_adrc INDEX lv_tabix.
*      ENDIF.
*      lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*    ENDLOOP.
    DELETE ADJACENT DUPLICATES FROM xt_adrci
           COMPARING addrnumber.
    xt_adrc[] = xt_adrci[].
*** js-005 * end ***
  ENDIF.

  SORT lt_kunnr.
  DELETE ADJACENT DUPLICATES FROM lt_kunnr.
  IF NOT lt_kunnr[] IS INITIAL.
    SELECT kunnr adrnr bran1 name1 FROM kna1 INTO TABLE xt_kna1
           FOR ALL ENTRIES IN lt_kunnr
           WHERE kunnr EQ lt_kunnr-kunnr.
  ENDIF.

ENDFORM.                    " SELECT_DATA

*--------------------------------------------------------------------*
*   Form  PROCESS_DATA                                               *
*--------------------------------------------------------------------*
FORM process_data.

  DATA: lv_vbeln_ord LIKE it_data-vbeln_ord,
        lv_posnr_ord LIKE it_data-posnr_ord,
        lv_ebelp     LIKE it_data-ebelp,                    "js-001
        lv_vbpa2 LIKE LINE OF xt_vbpa2,
        lv_vbpa3 LIKE LINE OF xt_vbpa3.

  FIELD-SYMBOLS: <l_data> LIKE LINE OF it_data.


* do sorts                                    "20080327
  SORT it_vbuk1 BY vbeln.
* begin of delete lme004
*  SORT it_vbuk2 BY vbeln.
*  SORT xt_konv BY knumv kposn kschl.
* end of delete lme004
*  SORT it_vbep BY vbeln posnr etenr.  " for loop!          "js-005
*** begin gru001
*  SORT it_vbepr BY vbeln posnr.  " for loop!               "js-005
*** end gru001

* begin of delete lme004
*  SORT it_vbup BY vbeln posnr.
*  SORT it_vbkd BY vbeln posnr.
*  SORT it_mvke BY matnr vkorg vtweg.
* end of delete lme004
  SORT it_ce41000 BY paobjnr.
  SORT it_vbpa1 BY vbeln posnr parvw.

*** js-001 * begin ***
* begin of change lme004
*  SORT: it_ekko BY ebeln,
*        it_lfa1 BY lifnr,
  SORT:
* end of change lme004
        it_ekpo,
        it_mara,
        it_marc.
*** js-001 * end ***

  CLEAR str_data.
  LOOP AT it_vbak.
    CLEAR: it_tvkbt, it_tvgrt, it_knvh, it_kna1_hl.
    CLEAR xv_adrc_endcustomer.                              "js-002

    READ TABLE it_billrelev WITH KEY auart = it_vbak-auart.
    IF sy-subrc NE 0.
      CONTINUE.
    ENDIF.

    READ TABLE it_vbuk1 WITH KEY vbeln = it_vbak-vbeln
                          BINARY SEARCH.

    IF ( sy-subrc NE 0 ) OR
       ( sy-subrc EQ 0 AND NOT it_vbuk1-gbstk IN s_gbstk ).
      CLEAR it_vbuk1.
      CONTINUE.
    ENDIF.

    READ TABLE it_tvkbt
*               WITH KEY vkbur = it_vbak-vkbur              "js-005
               WITH TABLE KEY spras = sy-langu              "js-005
                              vkbur = it_vbak-vkbur.        "js-005
*               BINARY SEARCH.                              "js-005

    READ TABLE it_tvgrt
*               WITH KEY vkgrp = it_vbak-vkgrp              "js-005
               WITH TABLE KEY spras = sy-langu              "js-005
                              vkgrp = it_vbak-vkgrp.        "js-005
*               BINARY SEARCH.                              "js-005

    CLEAR it_kna1_hl.
    READ TABLE it_knvh
*               WITH KEY hityp = c_hityp_a                  "js-005
               WITH TABLE KEY hityp = c_hityp_a             "js-005
                              kunnr = it_vbak-kunnr
                              vkorg = it_vbak-vkorg
                              vtweg = it_vbak-vtweg
                              spart = it_vbak-spart.
*              BINARY SEARCH.                               "js-005

    IF sy-subrc NE 0.
      CLEAR: it_knvh.
      CLEAR: it_kna1_hl.
      CLEAR xv_adrc_endcustomer.                            "js-002
    ENDIF.
    IF it_knvh-hkunnr IN s_hkunnr.
      READ TABLE it_kna1_hl
                 WITH TABLE KEY kunnr = it_knvh-hkunnr.     "js-005
*                 WITH KEY kunnr = it_knvh-hkunnr           "js-005
*                 BINARY SEARCH.                            "js-005
      IF sy-subrc = 0.
*       get adrc for kna1
        READ TABLE xt_adrc INTO xv_adrc_endcustomer
*              WITH KEY addrnumber = it_kna1_hl-adrnr       "js-005
              WITH TABLE KEY addrnumber = it_kna1_hl-adrnr. "js-005
*              BINARY SEARCH.                               "js-005
*** js-002 * begin ***
        IF sy-subrc NE 0.
          CLEAR xv_adrc_endcustomer.
        ENDIF.
*** js-002 * end ***
      ENDIF.
    ELSE.
      CONTINUE.
    ENDIF.

*   Loop through positions
    LOOP AT it_vbap WHERE vbeln EQ it_vbak-vbeln.
      CLEAR it_vbup.

*      READ TABLE it_mvke WITH KEY matnr = it_vbap-matnr    "js-005
      READ TABLE it_mvke
                 WITH TABLE KEY matnr = it_vbap-matnr       "js-005
                                vkorg = it_vbak-vkorg
                                vtweg = it_vbak-vtweg.
*                          BINARY SEARCH.                   "js-005

      IF sy-subrc NE 0.
        CONTINUE.
      ENDIF.

*** js-001 * begin ***
      READ TABLE it_mara WITH KEY matnr = it_vbap-matnr
                         BINARY SEARCH.
      IF sy-subrc NE 0.
        CONTINUE.
      ENDIF.
      READ TABLE it_marc WITH KEY matnr = it_vbap-matnr
                                  werks = it_vbap-werks
                         BINARY SEARCH.
      IF sy-subrc NE 0.
        CONTINUE.
      ENDIF.
*** js-001 * end ***

      READ TABLE it_vbkd
*                 WITH KEY vbeln = it_vbap-vbeln            "js-005
                 WITH TABLE KEY vbeln = it_vbap-vbeln       "js-005
                                posnr = it_vbap-posnr.
*                 BINARY SEARCH.                            "js-005

      IF sy-subrc NE 0.
        READ TABLE it_vbkd
*                   WITH KEY vbeln = it_vbap-vbeln          "js-005
                   WITH TABLE KEY vbeln = it_vbap-vbeln     "js-005
                                  posnr = c_posnr_init.
*                           BINARY SEARCH.                  "js-005
        IF sy-subrc NE 0.
          CLEAR it_vbkd.
          CONTINUE.
        ENDIF.
      ENDIF.

      LOOP AT it_vbep WHERE vbeln     EQ it_vbap-vbeln
                        AND posnr     EQ it_vbap-posnr
                        AND NOT bmeng IS INITIAL.
        EXIT.                                               "js-001
      ENDLOOP.

      IF sy-subrc NE 0.
        CLEAR it_vbep.
        IF NOT s_edatu IS INITIAL.
          CONTINUE.
        ENDIF.
      ENDIF.
*** begin gru001
      LOOP AT it_vbepr WHERE vbeln     EQ it_vbap-vbeln
                         AND posnr     EQ it_vbap-posnr.
        EXIT.
      ENDLOOP.

      IF sy-subrc NE 0.
        CLEAR it_vbepr.
        IF NOT s_vdatu IS INITIAL.
          CONTINUE.
        ENDIF.
      ENDIF.
*** end gru001

      READ TABLE it_vbup
*                 WITH KEY vbeln = it_vbap-vbeln            "jus-005
                 WITH TABLE KEY vbeln = it_vbap-vbeln       "jus-005
                                posnr = it_vbap-posnr.
*                 BINARY SEARCH.                            "jus-005

      READ TABLE it_makt INTO wa_makt WITH KEY matnr = it_vbap-matnr
                                                  BINARY SEARCH.
      IF sy-subrc NE 0.
        CLEAR it_makt.
      ENDIF.

      READ TABLE it_acct WITH KEY paobjnr = it_vbap-paobjnr
                          BINARY SEARCH.
      IF sy-subrc NE 0.
        CLEAR it_acct.
        CLEAR it_ce41000.                                   "jus-001
*      CONTINUE.    " Quotations don't have profitability segments,
*                     so don't make a problem of it. Also for other
*                     documents, don't consider this a reason not to
*                     show the item
      ELSE.
        READ TABLE it_ce41000
                   WITH KEY paobjnr = it_acct-ce4key
                   BINARY SEARCH.
        IF sy-subrc NE 0.
          CLEAR it_ce41000.                                 "jus-001
          CONTINUE.
        ENDIF.
      ENDIF.

      READ TABLE xt_konv INTO xv_konv1
*                 WITH KEY knumv = it_vbak-knumv            "jus-005
                 WITH TABLE KEY knumv = it_vbak-knumv       "jus-005
                                kposn = it_vbap-posnr
                                kschl = c_kschl_zpro.
*                 BINARY SEARCH .                           "jus-005
      IF sy-subrc NE 0.
        CLEAR xv_konv1.
      ENDIF.

      READ TABLE xt_konv INTO xv_konv2
*                 WITH KEY knumv = it_vbak-knumv            "jus-005
                 WITH TABLE KEY knumv = it_vbak-knumv       "jus-005
                                kposn = it_vbap-posnr
                                kschl = c_kschl_zprs.
*                 BINARY SEARCH .                           "jus-005
      IF sy-subrc NE 0.
        CLEAR xv_konv2.
*** lme001 * begin ***
        READ TABLE xt_konv INTO xv_konv2
*                   WITH KEY knumv = it_vbak-knumv          "jus-005
                   WITH TABLE KEY knumv = it_vbak-knumv     "jus-005
                                  kposn = it_vbap-posnr
                                  kschl = c_kschl_zurs.
*                   BINARY SEARCH .                         "jus-005
        IF sy-subrc NE 0.
          CLEAR xv_konv2.
        ENDIF.
*** lme001 * end ***
      ENDIF.

*** js-002 * begin ***
*     Freight charge
      READ TABLE xt_konv INTO xv_konvf
*                 WITH KEY knumv = it_vbak-knumv            "jus-005
                 WITH TABLE KEY knumv = it_vbak-knumv       "jus-005
                                   kposn = it_vbap-posnr
                                   kschl = c_kschl_zd00.
*                 BINARY SEARCH .                           "jus-005
      IF sy-subrc NE 0.
        CLEAR xv_konvf.
      ENDIF.
*** js-002 * end ***

      READ TABLE it_vbpa1 WITH KEY vbeln = it_vbap-vbeln
                                   posnr = c_posnr_init
                                   parvw = c_parvw_ag
                           BINARY SEARCH.
      IF sy-subrc NE 0.
        CLEAR: it_vbpa1.
        CLEAR: xv_kna1_ag.
        CONTINUE.
      ELSE.
        READ TABLE xt_kna1 INTO xv_kna1_ag
                            WITH KEY kunnr = it_vbpa1-kunnr.
        IF sy-subrc NE 0.
          CLEAR xv_kna1_ag.
          CONTINUE.
        ELSEIF NOT xv_kna1_ag-bran1 IN s_bran1.
          CLEAR xv_kna1_ag.
          CONTINUE.
        ENDIF.
      ENDIF.

      READ TABLE xt_vbpa2 INTO lv_vbpa2
                          WITH KEY vbeln = it_vbap-vbeln
                                   posnr = it_vbap-posnr
                                   parvw = c_parvw_we
                              .
      IF sy-subrc NE 0.
        READ TABLE xt_vbpa2 INTO lv_vbpa2
                            WITH KEY vbeln = it_vbap-vbeln
                                     posnr = c_posnr_init
                                     parvw = c_parvw_we.
        IF sy-subrc NE 0.
          CLEAR: lv_vbpa2.
          CONTINUE.
        ENDIF.
      ENDIF.
      READ TABLE xt_kna1 INTO xv_kna1_we
                         WITH KEY kunnr = lv_vbpa2-kunnr.
      IF sy-subrc NE 0.
        CLEAR: xv_kna1_we.
        CLEAR: xv_adrc.
      ELSE.
        READ TABLE xt_adrc INTO xv_adrc
*             WITH KEY addrnumber = xv_kna1_we-adrnr        "js-005
             WITH KEY addrnumber = xv_kna1_we-adrnr.        "js-005
*             BINARY SEARCH.                                "js-005
        IF sy-subrc NE 0.
          CLEAR: xv_adrc.
        ENDIF.
      ENDIF.

      READ TABLE xt_vbpa3 INTO lv_vbpa3
                          WITH KEY vbeln = it_vbap-vbeln
                                   posnr = it_vbap-posnr
                                   parvw = c_parvw_re
                                   .
      IF sy-subrc NE 0.
        READ TABLE xt_vbpa3 INTO lv_vbpa3
                  WITH KEY vbeln = it_vbap-vbeln
                           posnr = c_posnr_init
                           parvw = c_parvw_re
                                     .
        IF sy-subrc NE 0.
          CLEAR: lv_vbpa3 .
          CONTINUE.
        ENDIF.
      ENDIF.
      READ TABLE xt_kna1 INTO xv_kna1_re
                  WITH KEY kunnr = lv_vbpa3-kunnr.
      IF sy-subrc NE 0.
        CLEAR: xv_kna1_re.
      ENDIF.

      PERFORM get_salesrep USING c_parvw_ve
                           CHANGING x_parvw_ve
                                    x_pernr_ve
                                    x_ename_ve.
      PERFORM get_salesrep USING c_parvw_zx
                           CHANGING x_parvw_zx
                                    x_pernr_zx
                                    x_ename_zx.
      PERFORM get_salesrep USING c_parvw_zy
                           CHANGING x_parvw_zy
                                    x_pernr_zy
                                    x_ename_zy.
      IF NOT x_pernr_ve IN s_pernr AND
         NOT x_pernr_zx IN s_pernr AND
         NOT x_pernr_zy IN s_pernr.
        CONTINUE.
      ENDIF.

      READ TABLE it_vbfa3
*                 WITH KEY vbelv   = it_vbak-vbeln          "js-005
                 WITH TABLE KEY vbelv   = it_vbak-vbeln     "js-005
                                posnv   = it_vbap-posnr
                                vbtyp_n = c_vbtyp_v
                                vbtyp_v = it_vbak-vbtyp.
      IF sy-subrc NE 0.
        CLEAR it_vbfa3.
        CLEAR it_ekko.
        CLEAR it_lfa1.
        CLEAR it_ekpo.                                      "js-001
        IF NOT s_ebeln[]      IS INITIAL  AND
           NOT it_vbfa3-vbeln IN s_ebeln.
          CONTINUE.
        ENDIF.
      ELSE.
*** js-005 * begin ***
*        READ TABLE it_ekko WITH KEY ebeln = it_vbfa3-vbeln
*                           BINARY SEARCH.
        READ TABLE it_ekko WITH TABLE KEY ebeln = it_vbfa3-vbeln.
*** js-005 * end ***
        IF sy-subrc EQ 0.
*** js-005 * begin ***
*          READ TABLE it_lfa1 WITH KEY lifnr = it_ekko-lifnr
*                             BINARY SEARCH.
          READ TABLE it_lfa1 WITH TABLE KEY lifnr = it_ekko-lifnr.
*** js-005 * end ***
          IF sy-subrc NE 0.
            CLEAR it_lfa1.
          ENDIF.
*** js-001 * begin ***
          lv_ebelp = it_vbfa3-posnn.
          READ TABLE it_ekpo WITH KEY ebeln = it_vbfa3-vbeln
                                      ebelp = lv_ebelp
                             BINARY SEARCH.
          IF sy-subrc NE 0.
            CLEAR it_ekpo.
          ENDIF.
*** js-001 * end ***
        ELSE.
          CLEAR it_ekko.
          CLEAR it_lfa1.
          CLEAR it_ekpo.                                    "js-001
          CONTINUE.
        ENDIF.
      ENDIF.

      LOOP AT it_vbfa1 WHERE vbelv   EQ it_vbap-vbeln
                         AND posnv   EQ it_vbap-posnr
                         AND (    vbtyp_n EQ c_vbtyp_j
                               OR vbtyp_n EQ c_vbtyp_t )
                         AND vbtyp_v EQ it_vbak-vbtyp.

        READ TABLE it_likp
*                   WITH KEY vbeln = it_vbfa1-vbeln         "js-005
                   WITH TABLE KEY vbeln = it_vbfa1-vbeln.   "js-005
*                   BINARY SEARCH.                          "js-005
        IF sy-subrc NE 0.
          CLEAR it_likp.
        ENDIF.

        READ TABLE it_vbuk2
*             WITH KEY vbeln = it_likp-vbeln                "js-005
             WITH TABLE KEY vbeln = it_likp-vbeln.          "js-005
*             BINARY SEARCH.                                "js-005
        IF sy-subrc NE 0.
          CLEAR it_vbuk2.
        ENDIF.
*        IF NOT CB_SEL IS INITIAL.
*          CHECK IT_VBUK2-WBSTK EQ C_WBSTK_C.
*        ENDIF.

        LOOP AT it_lips WHERE vbeln EQ it_likp-vbeln
                          AND posnr EQ it_vbfa1-posnn.

*         Invoices can be delivery-related or order-related
          IF it_billrelev-zfkrel EQ c_zfkrel_c.
            x_vbelv = it_lips-vbeln.
            x_posnv = it_lips-posnr.
            x_vbtyp = it_likp-vbtyp.
          ELSEIF it_billrelev-zfkrel EQ c_zfkrel_a.
            x_vbelv = it_vbap-vbeln.
            x_posnv = it_vbap-posnr.
            x_vbtyp = it_vbak-vbtyp.
          ELSE.
            x_vbelv = it_vbap-vbeln.
            x_posnv = it_vbap-posnr.
            x_vbtyp = it_vbak-vbtyp.
          ENDIF.

          CLEAR it_vbfa2.
          LOOP AT it_vbfa2 WHERE ( vbelv   EQ x_vbelv )
                             AND ( posnv   EQ x_posnv )
                             AND ( vbtyp_n EQ c_vbtyp_m
                                OR vbtyp_n EQ c_vbtyp_n
*** js-006 * begin ***
                                OR vbtyp_n EQ c_vbtyp_p
                                OR vbtyp_n EQ c_vbtyp_s
*** js-006 * end ***
                                OR vbtyp_n EQ c_vbtyp_o )
                             AND ( vbtyp_v EQ x_vbtyp ).

            IF NOT rb_sel2 IS INITIAL.
              CONTINUE.
            ENDIF.

            READ TABLE it_vbrk WITH KEY vbeln = it_vbfa2-vbeln
                               BINARY SEARCH.
            IF sy-subrc NE 0.
              CLEAR it_vbrk.
              CONTINUE.
            ENDIF.

            LOOP AT it_vbrp WHERE vbeln EQ it_vbrk-vbeln
                              AND posnr EQ it_vbfa2-posnn.

              PERFORM get_orderstatus_data.
              PERFORM get_order_data.
              PERFORM get_order_business_data.
              PERFORM get_material_data.
              PERFORM get_atlascopco_data.
              PERFORM get_conditions_data.
              PERFORM get_soldto_data.
              PERFORM get_shipto_data USING lv_vbpa2.
              PERFORM get_billto_data USING lv_vbpa3.
              PERFORM get_hlevel_cust_data.
              PERFORM get_purchase_data.
              PERFORM get_deliverystatus_data.
              PERFORM get_delivery_data.
              PERFORM get_invoice_data.
*             Get golden tax reference
              PERFORM get_gts_invoice.
              PERFORM get_sales_rep_data.
              PERFORM get_billing_plan_data .
              PERFORM calculate_data USING c_status_inv1.
              PERFORM save_all_data.
              PERFORM reset_data.
            ENDLOOP.

          ENDLOOP.

          IF sy-subrc    NE 0       AND
             ( NOT rb_sel1 IS INITIAL OR
               NOT rb_sel2 IS INITIAL ).
            PERFORM get_orderstatus_data.
            PERFORM get_order_data.
            PERFORM get_order_business_data.
            PERFORM get_material_data.
            PERFORM get_atlascopco_data.
            PERFORM get_conditions_data.
            PERFORM get_soldto_data.
            PERFORM get_shipto_data USING lv_vbpa2.
            PERFORM get_billto_data USING lv_vbpa3.
            PERFORM get_hlevel_cust_data.
            PERFORM get_purchase_data.
            PERFORM get_deliverystatus_data.
            PERFORM get_delivery_data.
            PERFORM get_sales_rep_data.
            PERFORM get_billing_plan_data .
            PERFORM calculate_data USING c_status_del.
            PERFORM save_all_data.
            PERFORM reset_data.
          ENDIF.
        ENDLOOP.

      ENDLOOP.

*** js-004 * begin ***
*     Process invoiced ASSO
      IF sy-subrc = 0            AND
         NOT x_asso IS INITIAL   AND
         NOT r4 IS INITIAL.
        PERFORM get_orderstatus_data.
        PERFORM get_order_data.
        PERFORM get_order_business_data.
        PERFORM get_material_data.
        PERFORM get_atlascopco_data.
        PERFORM get_conditions_data.
        PERFORM get_soldto_data.
        PERFORM get_shipto_data USING lv_vbpa2.
        PERFORM get_billto_data USING lv_vbpa3.
        PERFORM get_hlevel_cust_data.
        PERFORM get_purchase_data.
        PERFORM get_deliverystatus_data.
        PERFORM get_delivery_data.
        PERFORM get_sales_rep_data.
        PERFORM get_billing_plan_data .
        PERFORM calculate_data USING c_status_del.
        PERFORM save_all_data.
        PERFORM reset_data.
      ENDIF.
*** js-004 * end ***

      IF sy-subrc NE 0.
        IF ( NOT rb_sel1 IS INITIAL AND cb_sel IS INITIAL ) OR
           ( NOT rb_sel2 IS INITIAL AND cb_sel IS INITIAL ) OR
           ( NOT rb_sel3 IS INITIAL ).
          IF it_billrelev-zfkrel EQ c_zfkrel_c.
* At this point, there are no deliveries and the document is
* delivery-related, so no invoices will be found. The orders are
* not invoiced and all relevant data must be displayed !
            IF rb_sel3 IS INITIAL.
              PERFORM get_orderstatus_data.
              PERFORM get_order_data.
              PERFORM get_order_business_data.
              PERFORM get_material_data.
              PERFORM get_atlascopco_data.
              PERFORM get_conditions_data.
              PERFORM get_soldto_data.
              PERFORM get_shipto_data USING lv_vbpa2.
              PERFORM get_billto_data USING lv_vbpa3.
              PERFORM get_hlevel_cust_data.
              PERFORM get_purchase_data.
              PERFORM get_sales_rep_data.
              PERFORM calculate_data USING c_status_ord.
              PERFORM save_all_data.
              PERFORM reset_data.
            ENDIF.
          ELSE.
* Order-related invoices can be found anyway, because deliveries are
* not necessary at this point.
            CLEAR it_vbfa2.
            LOOP AT it_vbfa2 WHERE ( vbelv   EQ it_vbap-vbeln )
                               AND ( posnv   EQ it_vbap-posnr )
                               AND ( vbtyp_n EQ c_vbtyp_m
                                  OR vbtyp_n EQ c_vbtyp_n
* LME insert
                                  OR vbtyp_n EQ c_vbtyp_s
* LME insert
                                  OR vbtyp_n EQ c_vbtyp_o
                                  OR vbtyp_n EQ c_vbtyp_p ).
* MJ deletion
*                               AND ( vbtyp_v EQ it_vbak-vbtyp ).
* MJ deletion
              IF NOT rb_sel2 IS INITIAL.
                CONTINUE.
              ENDIF.

              READ TABLE it_vbrk WITH KEY vbeln = it_vbfa2-vbeln
                                 BINARY SEARCH.
              IF sy-subrc NE 0.
                CLEAR it_vbrk.
                CONTINUE.
              ENDIF.
              LOOP AT it_vbrp WHERE vbeln EQ it_vbrk-vbeln
                                AND posnr EQ it_vbfa2-posnn.

                PERFORM get_orderstatus_data.
                PERFORM get_order_data.
                PERFORM get_order_business_data.
                PERFORM get_material_data.
                PERFORM get_atlascopco_data.
                PERFORM get_conditions_data.
                PERFORM get_soldto_data.
                PERFORM get_shipto_data USING lv_vbpa2.
                PERFORM get_billto_data USING lv_vbpa3.
                PERFORM get_hlevel_cust_data.
                PERFORM get_purchase_data.
                PERFORM get_invoice_data.
                PERFORM get_gts_invoice.
                PERFORM get_sales_rep_data.
                PERFORM get_billing_plan_data.
                PERFORM calculate_data USING c_status_inv2.
                PERFORM save_all_data.
                PERFORM reset_data.
              ENDLOOP.

            ENDLOOP.

            IF sy-subrc   NE 0       AND
               rb_sel3    IS INITIAL.
* Orders are not invoices and relevant data must be displayed anyway
              PERFORM get_orderstatus_data.
              PERFORM get_order_data.
              PERFORM get_order_business_data.
              PERFORM get_material_data.
              PERFORM get_atlascopco_data.
              PERFORM get_conditions_data.
              PERFORM get_soldto_data.
              PERFORM get_shipto_data USING lv_vbpa2.
              PERFORM get_billto_data USING lv_vbpa3.
              PERFORM get_hlevel_cust_data.
              PERFORM get_purchase_data.
              PERFORM get_sales_rep_data.
              PERFORM calculate_data USING c_status_ord.
              PERFORM save_all_data.
              PERFORM reset_data.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.

* Start change TVO for 3368: order without items should not be shown
** It seems that orders without items are possible. To be sure that
** we are dealing with such orders, all selections concerning items
** must be initial
*    IF SY-SUBRC   NE 0       AND
*       RB_SEL3    IS INITIAL AND
*       S_POSNR[]  IS INITIAL AND
*       S_PRCTR[]  IS INITIAL AND
*       S_WW002[]  IS INITIAL AND
*       S_WW006[]  IS INITIAL AND
*       S_WW007[]  IS INITIAL AND
*       S_WERKS[]  IS INITIAL AND
*       S_MATNR[]  IS INITIAL AND
**      s_kunwe[]  is initial and
*       S_PERNR[]  IS INITIAL AND
*       S_BRAN1[]  IS INITIAL AND
*       S_PSTYV[]  IS INITIAL AND
*       S_MTPOS[]  IS INITIAL.
*
** Some data must be selected without item and therefore selections
** must be done again on header level at this point
*      READ TABLE IT_VBKD WITH KEY VBELN = IT_VBAK-VBELN
*                                  POSNR = C_POSNR_INIT.
*      IF SY-SUBRC NE 0.
*        CLEAR IT_VBKD.
*        CONTINUE.
*      ENDIF.
*
*      READ TABLE IT_VBPA1 WITH KEY VBELN = IT_VBAK-VBELN
*                                   POSNR = C_POSNR_INIT
*                                   PARVW = C_PARVW_AG.
*      IF SY-SUBRC NE 0.
*        CLEAR: IT_VBPA1.
*        CLEAR: IT_KNA1_AG.
*      ELSE.
*        READ TABLE IT_KNA1_AG WITH KEY KUNNR = IT_VBPA1-KUNNR.
*        IF SY-SUBRC NE 0.
*          CLEAR: IT_KNA1_AG.
*          CONTINUE.
*        ENDIF.
*      ENDIF.
*
*      READ TABLE IT_VBPA2 WITH KEY VBELN = IT_VBAK-VBELN
*                                   POSNR = C_POSNR_INIT
*                                   PARVW = C_PARVW_WE.
*      IF SY-SUBRC NE 0.
*        CLEAR: IT_VBPA2.
*        CLEAR: IT_KNA1_WE.
*        CLEAR: IT_ADRC.
*        CONTINUE.
*      ELSE.
*        READ TABLE IT_KNA1_WE WITH KEY KUNNR = IT_VBPA2-KUNNR.
*        IF SY-SUBRC NE 0.
*          CLEAR: IT_KNA1_WE.
*          CLEAR: IT_ADRC.
*        ELSE.
*          READ TABLE IT_ADRC WITH KEY ADDRNUMBER = IT_KNA1_WE-ADRNR.
*          IF SY-SUBRC NE 0.
*            CLEAR IT_ADRC.
*          ENDIF.
*        ENDIF.
*      ENDIF.
*
*      READ TABLE IT_VBPA3 WITH KEY VBELN = IT_VBAK-VBELN
*                                   POSNR = C_POSNR_INIT
*                                   PARVW = C_PARVW_RE.
*      IF SY-SUBRC NE 0.
*        CLEAR: IT_VBPA3.
*        CLEAR: IT_KNA1_RE.
*        CONTINUE.
*      ELSE.
*        READ TABLE IT_KNA1_RE WITH KEY KUNNR = IT_VBPA3-KUNNR.
*        IF SY-SUBRC NE 0.
*          CLEAR: IT_KNA1_RE.
*        ENDIF.
*      ENDIF.
*
*      PERFORM GET_ORDERSTATUS_DATA.
*      PERFORM GET_ORDER_DATA.
*      PERFORM GET_ORDER_BUSINESS_DATA.
*      PERFORM GET_SOLDTO_DATA.
*      PERFORM GET_SHIPTO_DATA.
*      PERFORM GET_BILLTO_DATA.
*      PERFORM GET_HLEVEL_CUST_DATA.
*      PERFORM SAVE_ALL_DATA.
*      PERFORM RESET_DATA.
*    ENDIF.
*   End change TVO for 3368

  ENDLOOP.

*** js-001 * begin ***
* Eliminate lines which don't fit the GTS invoice ref criterium
  DELETE it_data WHERE zuonr NOT IN s_zuonr.
*** js-001 * end ***

* If suppress duplicate order lines is checked
  IF cb_spprd NE space
     AND r3 = ' '                                           "js-001
     AND r4 = ' '.                                          "js-002

*   Sort table and start looping
    SORT it_data BY vbeln_ord posnr_ord.
    LOOP AT it_data.
*     If new line is covering the same order item
      IF    it_data-vbeln_ord EQ lv_vbeln_ord AND
            it_data-posnr_ord EQ lv_posnr_ord.
*       Clear the order quantity and order value
        CLEAR:
          it_data-kzwi3_ord,
          it_data-kwmeng,
          it_data-kwert_zprs,
          it_data-zprofit,
          it_data-zprofperc.
      ELSE.
        lv_vbeln_ord = it_data-vbeln_ord.
        lv_posnr_ord = it_data-posnr_ord.
      ENDIF.
*     Calculate order on hand (order quant - invoice quant)
      it_data-kwmeng_oh = it_data-kwmeng    - it_data-fkimg.
      it_data-kzwi3_oh  = it_data-kzwi3_ord - it_data-kzwi3_inv.
*     Calculate OH cost, profit, profit perc.
      IF NOT it_data-kwmeng IS INITIAL.
        it_data-kwert_cos_oh = it_data-kwert_zprs * it_data-kwmeng_oh /
                                it_data-kwmeng.
        it_data-zprofit_oh   = it_data-zprofit *   it_data-kwmeng_oh /
                                it_data-kwmeng.
      ELSE.
        it_data-kwert_cos_oh = 0.
        it_data-zprofit_oh   = 0.
      ENDIF.
      IF NOT it_data-kzwi3_oh IS INITIAL.
        it_data-zprofpc_oh  = it_data-zprofit_oh * 100 /
                               it_data-kzwi3_oh.

      ELSE.
        it_data-zprofpc_oh  = 0.
      ENDIF.
      MODIFY it_data.
    ENDLOOP.

  ENDIF.

* Eliminate lines which don't fit the GTS invoice ref criterium
*** js-001 * begin ***
*  LOOP AT it_data WHERE zuonr NOT IN s_zuonr.
*    DELETE it_data.
*  ENDLOOP.
*** js-001 * end ***

* DO after processing
*** js-001 * begin ***
  IF r3 = 'X'.
*   Open orders
    LOOP AT it_sales_open ASSIGNING <sales_open>.
*     Profit
      PERFORM convert_currency
              USING    <sales_open>-waerk_ord
                       <sales_open>-waerk_cc
                       <sales_open>-zprofit
              CHANGING <sales_open>-zprofit_cc.
*     Invoice
      PERFORM convert_currency
              USING    <sales_open>-waerk_inv
                       <sales_open>-waerk_cc
                       <sales_open>-kzwi3_inv
              CHANGING <sales_open>-kzwi3_inv_cc.

*     ORDER ITEM NET VALUE in CC
      PERFORM convert_currency
              USING    <sales_open>-waerk_ord
                       <sales_open>-waerk_cc
                       <sales_open>-kzwi3_ord
              CHANGING <sales_open>-kzwi3_ord_cc.
*** lme003 * begin ***
      <sales_open>-kzwi3_ord_loc =
            <sales_open>-kzwi3_ord * <sales_open>-kursk.
*** lme003 * end ***
*     Unit price
      PERFORM convert_currency
              USING    <sales_open>-zunitprcurr
                       <sales_open>-waerk_cc
                       <sales_open>-zunitpr
              CHANGING <sales_open>-zunitpr_cc.
*     ORDER ON HAND VALUE
      PERFORM convert_currency
              USING    <sales_open>-waerk_ord
                       <sales_open>-waerk_cc
                       <sales_open>-kzwi3_oh
              CHANGING <sales_open>-kzwi3_oh_cc.
    ENDLOOP.
  ELSE.
*** js-001 * end ***
*** js-002 * begin ***
    IF r4 = 'X'.
*   Invoiced orders
      LOOP AT it_sales_inv ASSIGNING <sales_inv>.
*       Profit
        PERFORM convert_currency
                USING    <sales_inv>-waerk_ord
                         <sales_inv>-waerk_cc
                         <sales_inv>-zprofit
                CHANGING <sales_inv>-zprofit_cc.
*       Invoice
        PERFORM convert_currency
                USING    <sales_inv>-waerk_inv
                         <sales_inv>-waerk_cc
                         <sales_inv>-kzwi3_inv
                CHANGING <sales_inv>-kzwi3_inv_cc.

*       ORDER ITEM NET VALUE in CC
        PERFORM convert_currency
                USING    <sales_inv>-waerk_ord
                         <sales_inv>-waerk_cc
                         <sales_inv>-kzwi3_ord
                CHANGING <sales_inv>-kzwi3_ord_cc.
*** lme003 * begin ***
        <sales_inv>-kzwi3_ord_loc =
              <sales_inv>-kzwi3_ord * <sales_inv>-kursk.
*** lme003 * end ***
*       Unit price
        PERFORM convert_currency
                USING    <sales_inv>-zunitprcurr
                         <sales_inv>-waerk_cc
                         <sales_inv>-zunitpr
                CHANGING <sales_inv>-zunitpr_cc.
*       ORDER ON HAND VALUE
        PERFORM convert_currency
                USING    <sales_inv>-waerk_ord
                         <sales_inv>-waerk_cc
                         <sales_inv>-kzwi3_oh
                CHANGING <sales_inv>-kzwi3_oh_cc.
      ENDLOOP.
    ELSE.
*** js-002 * end ***
      LOOP AT it_data ASSIGNING <l_data>.
*       Profit
        PERFORM convert_currency
                USING    <l_data>-waerk_ord
                         <l_data>-waerk_cc
                         <l_data>-zprofit
                CHANGING <l_data>-zprofit_cc.
*       Invoice
        PERFORM convert_currency
                USING    <l_data>-waerk_inv
                         <l_data>-waerk_cc
                         <l_data>-kzwi3_inv
                CHANGING <l_data>-kzwi3_inv_cc.
*** lme002 * begin ***
        <l_data>-kzwi3_inv_loc = <l_data>-kzwi3_inv * <l_data>-kurrf.
*** lme002 * end ***
*       ORDER ITEM NET VALUE in CC
        PERFORM convert_currency
                USING    <l_data>-waerk_ord
                         <l_data>-waerk_cc
                         <l_data>-kzwi3_ord
                CHANGING <l_data>-kzwi3_ord_cc.
*** lme003 * begin ***
        <l_data>-kzwi3_ord_loc =
              <l_data>-kzwi3_ord * <l_data>-kursk.
*** lme003 * end ***
*       Unit price
        PERFORM convert_currency
                USING    <l_data>-zunitprcurr
                         <l_data>-waerk_cc
                         <l_data>-zunitpr
                CHANGING <l_data>-zunitpr_cc.
*       ORDER ON HAND VALUE
        PERFORM convert_currency
                USING    <l_data>-waerk_ord
                         <l_data>-waerk_cc
                         <l_data>-kzwi3_oh
                CHANGING <l_data>-kzwi3_oh_cc.
      ENDLOOP.
    ENDIF.                                                  "js-001
  ENDIF.                                                    "js-002

ENDFORM.                    " PROCESS_DATA

*--------------------------------------------------------------------*
*   Form  CONVERT_CURRENCY                                           *
*--------------------------------------------------------------------*
FORM convert_currency USING pi_curr_from
                              pi_curr_to
                              pi_ammount
                        CHANGING pe_ammount.

  IF pi_curr_from = pi_curr_to
        OR pi_ammount = 0
        OR pi_ammount IS INITIAL.
    pe_ammount = pi_ammount.
  ELSE.
    CALL FUNCTION 'CONVERT_TO_LOCAL_CURRENCY'
      EXPORTING
        date             = p_dat_cc
        foreign_amount   = pi_ammount
        foreign_currency = pi_curr_from
        local_currency   = pi_curr_to
        type_of_rate     = p_kurst
      IMPORTING
        local_amount     = pe_ammount.

*      CALL FUNCTION 'READ_EXCHANGE_RATE'
*        EXPORTING
*          date             = p_dat_cc
*          foreign_currency = str_data-waerk_ord
*          local_currency   = str_data-waerk_cc
*          type_of_rate     = p_kurst
*        IMPORTING
*          exchange_rate    = lv_ukurs
*        EXCEPTIONS
*          no_rate_found    = 1
*          no_factors_found = 2
*          no_spread_found  = 3
*          derived_2_times  = 4
*          overflow         = 5
*          zero_rate        = 6
*          OTHERS           = 7.
*      IF sy-subrc = 0.
*        str_data-kzwi3_ord_cc = str_data-kzwi3_ord * lv_ukurs.

  ENDIF.

ENDFORM.                    "convert_currency

*--------------------------------------------------------------------*
*   Form  DISPLAY_DATA                                               *
*--------------------------------------------------------------------*
FORM display_data.

  PERFORM fill_field_catalog.
  PERFORM prepare_sort.
  PERFORM change_catalog.
  PERFORM alv_output.

ENDFORM.                    " DISPLAY_DATA

**********************************************************************
* SUBROUTINES  LEVEL 02                                              *
**********************************************************************

*--------------------------------------------------------------------*
*   Form  GET_SALESREP                                               *
*--------------------------------------------------------------------*
FORM get_salesrep USING partnerfunction
                  CHANGING pfunction pnumber pname.

  CLEAR: pfunction.
  CLEAR: pnumber.
  CLEAR: pname.

  CLEAR: it_vbpa4.
  " hashed table!
  READ TABLE it_vbpa4 WITH KEY vbeln = it_vbap-vbeln
                               posnr = it_vbap-posnr
                               parvw = partnerfunction.
  IF sy-subrc NE 0.
    " hashed table!
    READ TABLE it_vbpa4 WITH KEY vbeln = it_vbap-vbeln
                                 posnr = c_posnr_init
                                 parvw = partnerfunction.
    IF sy-subrc NE 0.
      CLEAR it_vbpa4.
    ENDIF.
  ENDIF.
  pfunction = partnerfunction.
  pnumber   = it_vbpa4-pernr.

* Begin of change gru001

*  CALL FUNCTION 'CATS_GET_EMPLOYEE_NAME'
*    EXPORTING
*      pernr           = pnumber
**     date            = sy-datum
*    IMPORTING
*      name            = pname
*    EXCEPTIONS
*      pernr_not_found = 1
*      OTHERS          = 2.
*  IF sy-subrc <> 0.
*    CLEAR pname.
*  ENDIF.

  SELECT SINGLE ename INTO pname FROM pa0001
         WHERE pernr = pnumber
         AND endda = '99991231'.

  IF sy-subrc <> 0.
    CLEAR pname.
  ENDIF.


* End of change gru001

ENDFORM.                    " GET_SALESREP

*--------------------------------------------------------------------*
*   Form  GET_ORDER_DATA                                             *
*--------------------------------------------------------------------*
FORM get_order_data.

  DATA lv_dd07 TYPE xtyp_dd07.


  str_data-vkorg       = it_vbak-vkorg.
  str_data-vtweg       = it_vbak-vtweg.
  str_data-spart       = it_vbak-spart.
  str_data-vkbur       = it_vbak-vkbur.
  str_data-vkbur_txt   = it_tvkbt-bezei.
  str_data-vkgrp       = it_vbak-vkgrp.
  str_data-vkgrp_txt   = it_tvgrt-bezei.
*** change gru001
*  str_data-vdatu       = it_vbak-vdatu.
  str_data-vdatu       = it_vbepr-edatu.
*** end gru001
  str_data-edatu       = it_vbep-edatu.
  str_data-erdat_ord   = it_vbak-erdat.
  str_data-ernam       = it_vbak-ernam.
  str_data-auart       = it_vbak-auart.
  str_data-bnddt       = it_vbak-bnddt.
  str_data-erdat       = it_vbap-erdat.
  str_data-werks       = it_vbap-werks.
  str_data-matnr       = it_vbap-matnr.
  str_data-matkl       = it_vbap-matkl.                     "20080414
  str_data-pstyv       = it_vbap-pstyv.
  str_data-abgru       = it_vbap-abgru.
  str_data-faksk       = it_vbak-faksk.
  str_data-lifsk       = it_vbak-lifsk.
  str_data-vbeln_ord   = it_vbak-vbeln.
  str_data-posnr_ord   = it_vbap-posnr.
  str_data-spartd      = it_vbap-spart.
*  str_data-kzwi3_ord   = it_vbap-kzwi3.              "20090402 Uzzawal
  str_data-waerk_ord   = it_vbap-waerk.
  str_data-zunitprcurr = it_vbap-waerk.
  str_data-cmgst = it_vbuk1-cmgst.                  " credit check.

* Begin of Change EXTUVE   2009/04/02
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      currency       = str_data-waerk_ord
    IMPORTING
      decimal_places = w_decimal_place.

  CASE w_decimal_place.
    WHEN 2.
      str_data-kzwi3_ord   = it_vbap-kzwi3.
    WHEN 0.
      str_data-kzwi3_ord   = it_vbap-kzwi3 * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE     2009/04/02


  READ TABLE xt_dd07 INTO lv_dd07
        WITH KEY domname    = 'CMGST'
                 ddlanguage = 'E'
                 domvalue_l = it_vbuk1-cmgst.
  IF sy-subrc = 0.
    str_data-cmgstt = lv_dd07-ddtext.                  " credit check.
  ENDIF.

* Modification part 1 for issue 1952 point 8
  IF it_vbak-vbtyp = c_vbtyp_k OR it_vbak-vbtyp = c_vbtyp_l.
    str_data-kwmeng      = it_vbap-zmeng.
  ELSE.
    str_data-kwmeng      = it_vbap-kwmeng.
  ENDIF.
* End Mod part 1 for issue 1952 point 8
  str_data-vrkme_ord   = it_vbap-vrkme.

*** js-003 * begin ***
  str_data-bsark       = it_vbak-bsark.
  str_data-ihrez       = it_vbak-ihrez.
*** js-003 * end ***
*** lme001 * begin ***
  str_data-xblnr       = it_vbak-xblnr.
*** lme001 * end ***

ENDFORM.                    " GET_ORDER_DATA

*--------------------------------------------------------------------*
*   Form  GET_ORDERSTATUS_DATA                                       *
*--------------------------------------------------------------------*
FORM get_orderstatus_data.

* Get status text of LFSTA
  str_data-lfsta = it_vbup-lfsta.                           "js-001
  PERFORM get_status USING 'VBUP' 'LFSTA' it_vbup-lfsta
                     CHANGING str_data-lfsta_txt.

* Get status text of FKSAK
  str_data-fksak = it_vbuk1-fksak.                          "js-001
  PERFORM get_status USING 'VBUK' 'FKSAK' it_vbuk1-fksak
                     CHANGING str_data-fksak_txt.

* Get status text of GBSTK
  str_data-gbstk = it_vbuk1-gbstk.                          "js-001
  PERFORM get_status USING 'VBUK' 'GBSTK' it_vbuk1-gbstk
                     CHANGING str_data-gbstk_txt.

* Get status text of GBSTA
  str_data-gbsta = it_vbup-gbsta.                           "js-001
  PERFORM get_status USING 'VBUP' 'GBSTA' it_vbup-gbsta
                     CHANGING str_data-gbsta_txt.

ENDFORM.                    " GET_ORDERSTATUS_DATA

*--------------------------------------------------------------------*
*   Form  GET_ORDER_BUSINESS_DATA                                    *
*--------------------------------------------------------------------*
FORM get_order_business_data.

  str_data-bstkd = it_vbkd-bstkd.  " TVO insert
  str_data-bzirk = it_vbkd-bzirk.
  str_data-zterm = it_vbkd-zterm.                           "jus-001
  str_data-kursk = it_vbkd-kursk.                           "lme003

ENDFORM.                    "get_order_business_data

*--------------------------------------------------------------------*
*   Form  GET_MATERIAL_DATA                                          *
*--------------------------------------------------------------------*
FORM get_material_data.

*  str_data-maktx = it_makt-maktx.  "extuve
*   Material description
  READ TABLE it_makt WITH KEY matnr = str_data-matnr.
  IF sy-subrc = 0.
    str_data-maktx = it_makt-arktx.
  ENDIF.
  str_data-mtpos = it_mvke-mtpos.
*** js-001 * begin ***
  str_data-mstav = it_mara-mstav.
  str_data-mmsta = it_marc-mmsta.
  str_data-kzaus = it_marc-kzaus.
*** js-001 * end ***

ENDFORM.                    " GET_MATERIAL_DATA

*--------------------------------------------------------------------*
*   Form  GET_ATLASCOPCO_DATA                                        *
*--------------------------------------------------------------------*
FORM get_atlascopco_data.

* str_data-prctr = it_acct-prctr.
  str_data-prctr = it_ce41000-prctr.
* str_data-ww002 = it_acct-ww002.
  str_data-ww002 = it_ce41000-ww002.
* str_data-ww006 = it_acct-ww006.
  str_data-ww006 = it_ce41000-ww006.
* str_data-ww007 = it_acct-ww007.
  str_data-ww007 = it_ce41000-ww007.
*** js-001 * begin ***
  str_data-country = it_ce41000-ww009.
  str_data-ktgrd   = it_ce41000-ktgrd.
*** js-001 * end ***

ENDFORM.                    " GET_ATLASCOPCO_DATA

*--------------------------------------------------------------------*
*   Form  GET_CONDITIONS_DATA                                        *
*--------------------------------------------------------------------*
FORM get_conditions_data.

*  str_data-kwert_zpro = xv_konv1-kwert.
  str_data-waerk_zpro = it_vbap-waerk.
*  str_data-kwert_zprs = xv_konv2-kwert.
  str_data-waerk_zprs = it_vbap-waerk.
* Begin of Change EXTUVE   2010/04/20
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      currency       = str_data-waerk_zpro
    IMPORTING
      decimal_places = w_decimal_place.

  CASE w_decimal_place.
    WHEN 2.
      str_data-kwert_zpro = xv_konv1-kwert.
    WHEN 0.
      str_data-kwert_zpro = xv_konv1-kwert * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE  2010/04/20
* Begin of Change EXTUVE   2010/04/20
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      currency       = str_data-waerk_zprs
    IMPORTING
      decimal_places = w_decimal_place.

  CASE w_decimal_place.
    WHEN 2.
      str_data-kwert_zprs  = xv_konv2-kwert.
    WHEN 0.
      str_data-kwert_zprs  = xv_konv2-kwert * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE  2010/04/20

*** js-002 * begin ***
  str_data-zfreight_hdr = xv_konvf-kbetr.
  str_data-zfr_hdr_cc   = it_vbak-waerk.
  str_data-zfreight_itm = xv_konvf-kwert.
  str_data-zfr_itm_cc   = it_vbap-waerk.
*** js-002 * end ***

ENDFORM.                    " GET_CONDITIONS_DATA

*--------------------------------------------------------------------*
*   Form  GET_SOLDTO_DATA                                            *
*--------------------------------------------------------------------*
FORM get_soldto_data.

  DATA: lv_adrc TYPE adrc,
        lv_kdgrp TYPE xtyp_kdgrp.


  str_data-kunag    = it_vbpa1-kunnr.
  str_data-kdgrp_ag = it_vbpa1-kdgrp.

* get customer group
  IF NOT str_data-kunag IS INITIAL.
    READ TABLE xt_kdgrp INTO lv_kdgrp
            WITH KEY kdgrp = it_vbpa1-kdgrp
                     spras = sy-langu.
    IF sy-subrc <> 0 AND sy-langu <> 'E'.
      READ TABLE xt_kdgrp INTO lv_kdgrp
              WITH KEY kdgrp = it_vbpa1-kdgrp
                       spras = 'E'.
    ENDIF.
    str_data-kdgrpt_ag    = lv_kdgrp-ktext.
  ENDIF.

*  str_data-name1_ag = it_kna1_ag-name1. "in comment air22296 13/3
  str_data-bran1    = xv_kna1_ag-bran1.
*DIPS NAIK
*  str_data-spname2  = it_kna1_ag-name2."in comment air22296 13/3
*END OF DIPS NAIK

  IF NOT it_vbpa1-adrnr IS INITIAL.
    IF xv_adrc-addrnumber NE it_vbpa1-adrnr.
      READ TABLE xt_adrc INTO lv_adrc
*           WITH KEY addrnumber = it_vbpa1-adrnr            "js-005
           WITH TABLE KEY addrnumber = it_vbpa1-adrnr.      "js-005
*           BINARY SEARCH.                                  "js-005
    ELSE.
      lv_adrc = xv_adrc.
    ENDIF.

    IF lv_adrc-addrnumber EQ it_vbpa1-adrnr.
*      CONCATENATE it_adrc-street
*                  it_adrc-house_num1
*                  it_adrc-post_code1
*                  it_adrc-city1
*                  INTO str_data-addr_ag SEPARATED BY space.
      str_data-name1_ag = lv_adrc-name1.        "air22296 13/3
      str_data-spname2  = lv_adrc-name2.        "air22296 13/3
      str_data-spname3  = lv_adrc-name3.                    "20880327
      str_data-spname4  = lv_adrc-name4.                    "20880327

      str_data-region_ag = lv_adrc-region.
      str_data-city1_ag  = lv_adrc-city1.
      str_data-post_code1_ag = lv_adrc-post_code1.
    ENDIF.
  ENDIF.

ENDFORM.                    " GET_SOLDTO_DATA

*-------------------------------------------------------------------*
*   Form  GET_SHIPTO_DATA                                           *
*-------------------------------------------------------------------*
FORM get_shipto_data USING p_vbpa LIKE LINE OF xt_vbpa2.

  DATA: lv_adrc TYPE adrc,
        lv_kna1 TYPE xtyp_kna1.


* GET NAICS code for shipment
  IF NOT p_vbpa-kunnr IS INITIAL.
    str_data-kunwe    = p_vbpa-kunnr.
    READ TABLE xt_kna1 INTO lv_kna1
          WITH KEY kunnr = str_data-kunwe.
    IF sy-subrc = 0.
      str_data-sh_naics = lv_kna1-bran1.
    ENDIF.
  ENDIF.

*  str_data-name1_we = it_kna1_we-name1. "comment air22296
*DIPS NAIK
*  str_data-shname2  = it_kna1_we-name2. "comment air22296
*END OF DIPS NAIK

  IF NOT p_vbpa-adrnr IS INITIAL.
    IF xv_adrc-addrnumber NE p_vbpa-adrnr.
      READ TABLE xt_adrc INTO lv_adrc
*           WITH KEY addrnumber = p_vbpa-adrnr              "js-005
           WITH TABLE KEY addrnumber = p_vbpa-adrnr.        "js-005
*           BINARY SEARCH.                                  "js-005
    ELSE.
      lv_adrc = xv_adrc.
    ENDIF.

    IF lv_adrc-addrnumber EQ p_vbpa-adrnr.
*      CONCATENATE it_adrc-street
*                  it_adrc-house_num1
*                  it_adrc-post_code1
*                  it_adrc-city1
*                  INTO str_data-addr_we SEPARATED BY space.
      str_data-name1_we = lv_adrc-name1. "air22296 13/3
      str_data-shname2 = lv_adrc-name2. "air22296 13/3
      str_data-shname3 = lv_adrc-name3.                     "20080327
      str_data-shname4 = lv_adrc-name4.                     "20080327
      str_data-street  = lv_adrc-street.      "MOD-001
      str_data-region_we = lv_adrc-region.
      str_data-city1_we  = lv_adrc-city1.
      str_data-post_code1_we = lv_adrc-post_code1.
      IF str_data-country IS INITIAL.                       "js-001
        str_data-country   = lv_adrc-country.
      ENDIF.                                                "js-001
    ENDIF.

  ENDIF.

ENDFORM.                    " GET_SHIPTO_DATA

*--------------------------------------------------------------------*
*   Form  GET_BILLTO_DATA                                            *
*--------------------------------------------------------------------*
FORM get_billto_data USING p_vbpa3 LIKE LINE OF xt_vbpa3.

  str_data-kunre    = p_vbpa3-kunnr.
*  str_data-name1_re = it_kna1_re-name1. "comment air22296
*DIPS NAIK
*  str_data-bpname2  = it_kna1_re-name2."comment air22296
*DIPS NAIK
  IF NOT p_vbpa3-adrnr IS INITIAL.
    IF xv_adrc-addrnumber NE p_vbpa3-adrnr.
      READ TABLE xt_adrc INTO xv_adrc
*           WITH KEY addrnumber = p_vbpa3-adrnr             "js-005
           WITH TABLE KEY addrnumber = p_vbpa3-adrnr.       "js-005
*           BINARY SEARCH.                                  "js-005
      IF sy-subrc NE 0.
        CLEAR xv_adrc.
      ENDIF.
    ENDIF.
    str_data-name1_re = xv_adrc-name1.         "air22296 13/3
    str_data-bpname2  = xv_adrc-name2.         "air22296 13/3
    str_data-bpname3  = xv_adrc-name3.                      "20080327
    str_data-bpname4  = xv_adrc-name4.                      "20080327
  ENDIF.

ENDFORM.                    " GET_BILLTO_DATA

*--------------------------------------------------------------------*
*   Form  GET_HLEVEL_CUST_DATA                                       *
*--------------------------------------------------------------------*
FORM get_hlevel_cust_data.

  str_data-hkunnr   = it_knvh-hkunnr.
  str_data-name1_hl = it_kna1_hl-name1.
  str_data-name3_hl = xv_adrc_endcustomer-name3.            "20080327
  str_data-name4_hl = xv_adrc_endcustomer-name4.            "20080327

ENDFORM.                    " GET_HLEVEL_CUST_DATA

*--------------------------------------------------------------------*
*   Form  GET_PURCHASE_DATA                                          *
*--------------------------------------------------------------------*
FORM get_purchase_data.

  str_data-ebeln      = it_ekko-ebeln.
  str_data-ebelp      = it_ekpo-ebelp.                      "js-001
  str_data-lifnr      = it_ekko-lifnr.
  str_data-name1_vend = it_lfa1-name1.

ENDFORM.                    " GET_PURCHASE_DATA

*--------------------------------------------------------------------*
*   Form  GET_DELIVERY_DATA                                          *
*--------------------------------------------------------------------*
FORM get_delivery_data.

  str_data-vbeln_del  = it_likp-vbeln.
  str_data-posnr_del  = it_lips-posnr.
  IF     it_vbak-vbtyp EQ c_vbtyp_k
      OR it_vbak-vbtyp EQ c_vbtyp_l.
    str_data-lfimg      = 0.
  ELSE.
    str_data-lfimg      = it_lips-lfimg.
  ENDIF.
  str_data-vrkme_del  = it_lips-vrkme.
  str_data-zvrkme_del = it_lips-vrkme.
  str_data-wadat_ist  = it_likp-wadat_ist.

ENDFORM.                    " GET_DELIVERY_DATA

*--------------------------------------------------------------------*
*   Form  GET_DELIVERYSTATUS_DATA                                    *
*--------------------------------------------------------------------*
FORM get_deliverystatus_data.

* Get status text of WBSTK
  str_data-wbstk = it_vbuk2-wbstk.                          "js-001
  PERFORM get_status USING 'VBUK' 'WBSTK' it_vbuk2-wbstk
                     CHANGING str_data-wbstk_txt.

ENDFORM.                    " GET_DELIVERYSTATUS_DATA

*--------------------------------------------------------------------*
*   Form  GET_INVOICE_DATA                                           *
*--------------------------------------------------------------------*
FORM get_invoice_data.

  DATA: lv_dd07 LIKE LINE OF xt_dd07.


  str_data-fkart      = it_vbrk-fkart.
  str_data-vbeln_inv  = it_vbrk-vbeln.
  str_data-posnr_inv  = it_vbrp-posnr.
  IF     it_vbak-vbtyp EQ c_vbtyp_k
      OR it_vbak-vbtyp EQ c_vbtyp_l.
    str_data-fkimg      = 0.
  ELSE.
    str_data-fkimg      = it_vbrp-fkimg.
  ENDIF.
  str_data-vrkme_inv  = it_vbrp-vrkme.
*  str_data-kzwi3_inv  = it_vbrp-kzwi3.  " EXTUVE 2009/11/05
  str_data-waerk_inv  = it_vbrk-waerk.
  str_data-fkdat      = it_vbrk-fkdat.
  str_data-erdat_inv  = it_vbrk-erdat.
  str_data-zvrkme_inv = it_vbrp-vrkme.
  str_data-zwaerk_inv = it_vbrk-waerk.
  str_data-fareg      = it_vbrp-fareg.

* Begin of Change EXTUVE   2009/11/05
  CALL FUNCTION 'G_DECIMAL_PLACES_GET'
    EXPORTING
      currency       = str_data-waerk_inv
    IMPORTING
      decimal_places = w_decimal_place.

  CASE w_decimal_place.
    WHEN 2.
      str_data-kzwi3_inv   = it_vbrp-kzwi3.
    WHEN 0.
      str_data-kzwi3_inv   = it_vbrp-kzwi3 * 100.
    WHEN 5.
*  do nothing.
  ENDCASE.
* End of Change EXTUVE     2009/11/05

  READ TABLE xt_dd07 INTO lv_dd07
        WITH KEY domname    = 'FAREG'
                 ddlanguage = 'E'
                 domvalue_l = str_data-fareg.
  IF sy-subrc = 0.
    str_data-faregt = lv_dd07-ddtext.                  " credit check.
  ENDIF.

*** lme002 * begin ***
  str_data-kurrf = it_vbrk-kurrf.
*** lme002 * end ***

ENDFORM.                    " GET_INVOICE_DATA

*--------------------------------------------------------------------*
*   Form  GET_SALES_REP_DATA                                         *
*--------------------------------------------------------------------*
FORM get_sales_rep_data.

  str_data-parvw_ve = x_parvw_ve.
  str_data-pernr_ve = x_pernr_ve.
  str_data-ename_ve = x_ename_ve.
  str_data-parvw_zx = x_parvw_zx.
  str_data-pernr_zx = x_pernr_zx.
  str_data-ename_zx = x_ename_zx.
  str_data-parvw_zy = x_parvw_zy.
  str_data-pernr_zy = x_pernr_zy.
  str_data-ename_zy = x_ename_zy.

ENDFORM.                    " GET_SALES_REP_DATA

*--------------------------------------------------------------------*
*   Form  CALCULATE_DATA                                             *
*--------------------------------------------------------------------*
FORM calculate_data USING status.

  DATA: BEGIN OF lt_fpla OCCURS 0,
          fplnr LIKE fplt-fplnr,
*          FPLTR LIKE FPLT-FPLTR,
        END OF lt_fpla.

  DATA: lv_ukurs LIKE tcurr-ukurs.


* Calculate unit price: net val / quant
  IF NOT str_data-kwmeng IS INITIAL.
    str_data-zunitpr = str_data-kzwi3_ord / str_data-kwmeng.
  ELSE.
    str_data-zunitpr = 0.
  ENDIF.
* Calculate profit
  str_data-zprofit   = str_data-kzwi3_ord - str_data-kwert_zprs.
  str_data-zprofcurr = str_data-waerk_ord.
* Calculate profic percentage
  IF NOT str_data-kzwi3_ord IS INITIAL.
    str_data-zprofperc = str_data-zprofit / str_data-kzwi3_ord * 100.
  ELSE.
    CLEAR str_data-zprofperc.
  ENDIF.

* Calculate open delivery quantity
* if sales order doc category is L or K, don't show quantity
  IF it_vbak-vbtyp EQ c_vbtyp_k OR it_vbak-vbtyp EQ c_vbtyp_l.
    str_data-zvrkme_del = 0.
  ELSE.
    IF status EQ c_status_del OR status EQ c_status_inv1.
      CLEAR: x_lfimg.
      LOOP AT it_lips2 WHERE vgbel EQ str_data-vbeln_ord
                         AND vgpos EQ str_data-posnr_ord.
        x_lfimg = x_lfimg + it_lips2-lfimg.
      ENDLOOP.
      str_data-zquant_del = str_data-kwmeng - x_lfimg.
    ELSE.
      IF it_vbak-vbtyp NE c_vbtyp_k AND it_vbak-vbtyp NE c_vbtyp_l.
        str_data-zquant_del = str_data-kwmeng.
      ENDIF.
    ENDIF.
    IF NOT str_data-zquant_del IS INITIAL AND
       str_data-zvrkme_del     IS INITIAL.
      str_data-zvrkme_del = str_data-vrkme_ord.
    ENDIF.
  ENDIF.

* Calculate open invoice quantity
* if sales order doc category is L or K, don't show quantity
  IF it_vbak-vbtyp EQ c_vbtyp_k OR it_vbak-vbtyp EQ c_vbtyp_l.
    str_data-zvrkme_del = 0.
  ELSE.
    IF status EQ c_status_inv1 OR status EQ c_status_inv2
                               OR status EQ c_status_del.   "+MOD-003
*     Clear the total invoiced quantity
      CLEAR: x_fkimg.
*     Clear the list of processed billing plan numbers
      CLEAR: lt_fpla[], lt_fpla.
*     Loop over linked billing documents which are not ... ?
      LOOP AT it_vbrp2 WHERE aubel EQ str_data-vbeln_ord
                         AND aupos EQ str_data-posnr_ord
                         AND NOT fareg IN r_fareg.
*       Find billing document header's "billing category" (TVFK-FKTYP)
        IF it_vbrk2-vbeln NE it_vbrp2-vbeln.
          READ TABLE it_vbrk2 WITH KEY vbeln = it_vbrp2-vbeln
                              BINARY SEARCH.
          IF sy-subrc NE 0.
            CLEAR it_vbrk2.
          ENDIF.
        ENDIF.
        READ TABLE it_tvfk WITH KEY fkart = it_vbrk2-fkart.
        IF sy-subrc NE 0.
          CLEAR it_tvfk.
        ENDIF.
*       If billing category not P ~ downpayment request
        IF it_tvfk-fktyp NE c_fktyp_p.
*         Check if billing item's quantity is already counted as result
*         of other billing item coming from the same billing plannumber
*        Begin of deletion MOD-003
*          READ TABLE lt_fpla WITH KEY fplnr = it_vbrp2-fplnr.
*          IF sy-subrc EQ 0.
*            CONTINUE.
*          ELSE.
*            lt_fpla-fplnr = it_vbrp2-fplnr.
*            APPEND lt_fpla.
*          ENDIF.
*        End of Deletion MOD-003
*         Take opposite of quantity in case of ...
*         inv cancell. or cr memo
          IF (    it_vbrk2-vbtyp EQ c_vbtyp_n
               OR it_vbrk2-vbtyp EQ c_vbtyp_o )
              AND it_vbak-vbtyp NE c_vbtyp_k   "not cr/db memo req
              AND it_vbak-vbtyp NE c_vbtyp_l
              AND it_vbak-vbtyp NE c_vbtyp_h.  "and not returns
            it_vbrp2-fkimg = it_vbrp2-fkimg * -1.
          ENDIF.
*         Add billing quantity to total billed quantity
          x_fkimg = x_fkimg + it_vbrp2-fkimg.
        ENDIF.
      ENDLOOP.
*     Open invoice quantity is order quantity - billed quantity
      str_data-zquant_inv = str_data-kwmeng - x_fkimg.
    ELSE.
      str_data-zquant_inv = str_data-kwmeng.
    ENDIF.
  ENDIF.

* Fill invoice quantity unit if initial
  IF NOT str_data-zquant_inv IS INITIAL AND
     str_data-zvrkme_inv     IS INITIAL.
    str_data-zvrkme_inv = str_data-vrkme_ord.
  ENDIF.

* Calculate open invoice amount
  CATCH SYSTEM-EXCEPTIONS arithmetic_errors = 5.
    str_data-zamount = str_data-zquant_inv * str_data-kzwi3_ord.
  ENDCATCH.
  IF sy-subrc EQ 5.
    str_data-zamount = 0.
  ENDIF.
* Fill open inv amnt curr if initial
  IF NOT str_data-zamount IS INITIAL AND
     str_data-zwaerk_inv IS INITIAL.
    str_data-zwaerk_inv = str_data-waerk_ord.
  ENDIF.

* Calculate profit / cost for inv
  IF NOT str_data-kwmeng IS INITIAL.
    str_data-kwert_cos_in = str_data-kwert_zprs * str_data-fkimg
                       / str_data-kwmeng .
    str_data-zprofit_in   = str_data-zprofit * str_data-fkimg /
                            str_data-kwmeng.
  ELSE.
    str_data-kwert_cos_in = 0.
    str_data-zprofit_in   = 0.
  ENDIF.
  IF NOT str_data-kzwi3_inv IS INITIAL.
    str_data-zprofpc_in  = str_data-zprofit_in * 100 /
                           str_data-kzwi3_inv.
  ELSE.
    str_data-zprofpc_in  = 0.
  ENDIF.

* Change the sign to show on screen
  IF it_vbak-vbtyp EQ c_vbtyp_h OR it_vbak-vbtyp EQ c_vbtyp_k.
    str_data-kzwi3_ord  = str_data-kzwi3_ord  * -1.
    str_data-kwmeng     = str_data-kwmeng     * -1.
    str_data-zprofit    = str_data-zprofit    * -1.
    str_data-zprofperc  = str_data-zprofperc  * -1.
    str_data-kwert_zprs = str_data-kwert_zprs * -1.
    IF str_data-kwert_cos_in GT 0.
      str_data-kwert_cos_in =  str_data-kwert_cos_in  * -1.
    ENDIF.
  ENDIF.
  IF it_likp-vbtyp EQ c_vbtyp_t.
    str_data-lfimg      = str_data-lfimg      * -1.
  ENDIF.
  IF it_vbrk-vbtyp EQ c_vbtyp_n OR it_vbrk-vbtyp EQ c_vbtyp_o.
    str_data-fkimg      = str_data-fkimg      * -1.
    str_data-kzwi3_inv  = str_data-kzwi3_inv  * -1.
    IF str_data-kwert_cos_in GT 0.
      str_data-kwert_cos_in =  str_data-kwert_cos_in  * -1.
    ENDIF.
  ENDIF.

  IF it_vbrk-fktyp EQ c_fktyp_d AND it_vbrp-fareg EQ c_fareg_4.
    str_data-fkimg      = str_data-fkimg      * -1.
    str_data-kzwi3_inv  = str_data-kzwi3_inv  * -1.
  ENDIF.

* LME insert
*** js-005 * begin ***
*  SELECT SINGLE shkzg INTO x_shkzg
*    FROM tvap WHERE pstyv = it_vbap-pstyv.
  CLEAR it_tvap.
  READ TABLE it_tvap WITH KEY pstyv = it_vbap-pstyv.
  x_shkzg = it_tvap-shkzg.
*** js-005 * end ***
  IF it_vbak-auart = 'ZRK' AND x_shkzg = ' '.
    str_data-kwmeng     = str_data-kwmeng     * -1.
  ENDIF.

*** js-005 * begin ***
*  SELECT SINGLE shkzg INTO x_shkzg
*    FROM tvap WHERE pstyv = it_vbrp-pstyv.
  CLEAR it_tvap.
  READ TABLE it_tvap WITH KEY pstyv = it_vbrp-pstyv.
  x_shkzg = it_tvap-shkzg.
*** js-005 * end ***
  IF it_vbrk-fkart = 'ZG2' AND x_shkzg = ' '.
    str_data-fkimg      = str_data-fkimg      * -1.
  ENDIF.
* LME insert

* MJ insert correction of sign of profit percentage
  IF ( str_data-zprofit > 0 AND str_data-zprofperc < 0 ) OR
    ( str_data-zprofit < 0 AND str_data-zprofperc > 0 ).
    str_data-zprofperc = str_data-zprofperc * -1.
  ENDIF.
* MJ insert

* Calculate to Company Currency
  READ TABLE it_tvko WITH KEY str_data-vkorg BINARY SEARCH.
  IF sy-subrc EQ 0.
    str_data-waerk_cc = it_tvko-waers_cc.

*    PERFORM CONVERT_CURRENCY
*                USING
*                   str_data-waerk_ord  " PI_CURR_FROM =
*                   str_data-waerk_cc  " PI_CURR_TO =
*                   str_data-kzwi3_ord " PI_AMMOUNT =
*                CHANGING
*                   str_data-kzwi3_ord_cc.   " PE_AMMOUNT =  .
*
*    PERFORM CONVERT_CURRENCY
*                USING
*                   str_data-waerk_ord    " PI_CURR_FROM =
*                   str_data-waerk_cc     " PI_CURR_TO =
*                   str_data-zprofit      " PI_AMMOUNT =
*                CHANGING
*                   str_data-zprofit_cc.   " PE_AMMOUNT = .
*
**>>>air22296 insert 7/2
*    PERFORM CONVERT_CURRENCY
*                USING
*                   str_data-waerk_inv    " PI_CURR_FROM =
*                   str_data-waerk_cc     " PI_CURR_TO =
*                   str_data-kzwi3_inv      " PI_AMMOUNT =
*                CHANGING
*                   str_data-kzwi3_inv_cc.   " PE_AMMOUNT = .
**<<<air22296.
  ENDIF.

ENDFORM.                    " CALCULATE_DATA

*------------------------------------------------------------------*
*   Form  SAVE_ALL_DATA                                            *
*------------------------------------------------------------------*
FORM save_all_data.

** js-001 * begin ***
  IF r3 = 'X'.
*   Open orders
*** js-004 * begin ***
*   ASSO
    IF str_data-auart = 'ZO03'.
      CHECK str_data-lfsta NE 'C'.
    ENDIF.
*** js-004 * end ***
    MOVE-CORRESPONDING str_data TO it_sales_open.
    APPEND it_sales_open.
  ELSE.
** js-001 * end ***
** js-002 * begin ***
    IF r4 = 'X'.
*     Invoiced orders
*** js-004 * begin ***
*     ASSO
      IF str_data-auart = 'ZO03'.
        CHECK str_data-lfsta = 'C'.
      ENDIF.
*** js-004 * end ***
      MOVE-CORRESPONDING str_data TO it_sales_inv.
      APPEND it_sales_inv.
    ELSE.
** js-002 * end ***
      MOVE str_data TO it_data.
      APPEND it_data.
    ENDIF.                                                  "js-001
  ENDIF.                                                    "js-002

ENDFORM.                    " SAVE_ALL_DATA

*------------------------------------------------------------------*
*   Form  RESET_DATA                                               *
*------------------------------------------------------------------*
FORM reset_data.

  CLEAR: str_data.
*** js-001 * begin ***
  IF r3 = 'X'.
*   Open orders
    CLEAR: it_sales_open.
  ELSE.
*** js-001 * end ***
*** js-002 * begin ***
    IF r4 = 'X'.
*     Invoiced orders
      CLEAR: it_sales_inv.
    ELSE.
*** js-002 * end ***
      CLEAR: it_data.
    ENDIF.                                                  "js-001
  ENDIF.                                                    "js-002

ENDFORM.                    " RESET_DATA

*-------------------------------------------------------------------*
*       Form  FILL_FIELD_CATALOG                                    *
*-------------------------------------------------------------------*
FORM fill_field_catalog.

* Find used dictionary structure in INITIALIZATION!
* YSE_SD_SALES_OUT

  x_repid = sy-repid.
  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
       EXPORTING
            i_program_name         = x_repid
            i_internal_tabname     = 'IT_DATA'
*           i_structure_name       =
*           i_client_never_display = 'X'
            i_inclname             = x_repid
*           i_bypassing_buffer     =
*           i_buffer_active        =
       CHANGING
            ct_fieldcat            = it_fieldcat
       EXCEPTIONS
            inconsistent_interface = 1
            program_error          = 2
            OTHERS                 = 3.
  IF sy-subrc <> 0.
*   message id sy-msgid type sy-msgty number sy-msgno
*           with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " FILL_FIELD_CATALOG

*-------------------------------------------------------------------*
*       Form  PREPARE_SORT                                          *
*-------------------------------------------------------------------*
FORM prepare_sort.

  CLEAR str_sort.
* str_sort-spos      = '1'.
* str_sort-fieldname = 'PRCTR'.
* str_sort-up        = 'X'.
* append str_sort to it_sort.

ENDFORM.                    " PREPARE_SORT

*-------------------------------------------------------------------*
*       Form  CHANGE_CATALOG                                        *
*-------------------------------------------------------------------*
FORM change_catalog.

  DATA: lv_str TYPE string.


  CLEAR: ls_fieldcat.
  CLEAR: lt_fieldcat.
  REFRESH: lt_fieldcat.

  SORT xt_dd03l BY fieldname.
  LOOP AT it_fieldcat INTO ls_fieldcat.

    READ TABLE xt_dd03l WITH KEY fieldname = ls_fieldcat-fieldname
                        BINARY SEARCH.
*    IF xt_dd03l-rollname IS INITIAL.
    PERFORM get_fieldname USING xt_dd03l-rollname
                                xt_dd03l-fieldname
                         CHANGING lv_str.
    PERFORM change_fieldcatalogue USING lv_str.
    MODIFY it_fieldcat FROM ls_fieldcat.
*    ENDIF.

*    CASE ls_fieldcat-fieldname.
*      WHEN 'ERDAT'.
*        PERFORM change_fieldcatalogue USING TEXT-G17.
*      WHEN 'VKBUR_TXT'.
*        PERFORM change_fieldcatalogue USING text-F05.
*      WHEN 'VKGRP_TXT'.
*        PERFORM change_fieldcatalogue USING text-f07.
*        ls_fieldcat-col_pos = 07.
*      WHEN 'EDATU'.
*        PERFORM change_fieldcatalogue USING text-f14.
*        ls_fieldcat-col_pos = 14.
*      WHEN 'ERDAT_ORD'.
*        PERFORM change_fieldcatalogue USING text-f16.
*        ls_fieldcat-col_pos = 16.
*      WHEN 'NAME1_AG'.
*        PERFORM change_fieldcatalogue USING text-f26.
*        ls_fieldcat-col_pos = 26.
*      WHEN 'ADDR_AG'.
*        PERFORM change_fieldcatalogue USING text-f88.
*        ls_fieldcat-col_pos = 27.
*      WHEN 'NAME1_WE'.
*        PERFORM change_fieldcatalogue USING text-f28.
*        ls_fieldcat-col_pos = 28.
*      WHEN 'ADDR_WE'.
*        PERFORM change_fieldcatalogue USING text-f29.
*        ls_fieldcat-col_pos = 29.
*      WHEN 'KUNRE'.
*        PERFORM change_fieldcatalogue USING text-f30.
*        ls_fieldcat-col_pos = 30.
*      WHEN 'NAME1_RE'.
*        PERFORM change_fieldcatalogue USING text-f31.
*        ls_fieldcat-col_pos = 31.
*      WHEN 'HKUNNR'.
*        PERFORM change_fieldcatalogue USING text-f32.
*        ls_fieldcat-col_pos = 32.
*      WHEN 'NAME1_HL'.
*        concatenate text-f33 ' 1.' INTO lv_str.
*        PERFORM change_fieldcatalogue USING lv_str.
*        ls_fieldcat-col_pos = 33.
*      WHEN 'NAME3_HL'.
*        concatenate text-f33 ' 3.' INTO lv_str.
*        PERFORM change_fieldcatalogue USING lv_str.
*        ls_fieldcat-col_pos = 34.
*      WHEN 'NAME4_HL'.
*        concatenate text-f33 ' 4.' INTO lv_str.
*        PERFORM change_fieldcatalogue USING lv_str.
*        ls_fieldcat-col_pos = 35.
*      WHEN 'BRAN1'.
*        PERFORM change_fieldcatalogue USING text-f34.
*        ls_fieldcat-col_pos = 37.
*      WHEN 'LFSTA_TXT'.
*        PERFORM change_fieldcatalogue USING text-f35.
*        ls_fieldcat-col_pos = 38.
*      WHEN 'FKSAK_TXT'.
*        PERFORM change_fieldcatalogue USING text-f36.
*        ls_fieldcat-col_pos = 39.
*      WHEN 'GBSTK_TXT'.
*        PERFORM change_fieldcatalogue USING text-f37.
*        ls_fieldcat-col_pos = 40.
*      WHEN 'GBSTA_TXT'.
*        PERFORM change_fieldcatalogue USING text-f38.
*        ls_fieldcat-col_pos = 41.
*      WHEN 'VBELN_ORD'.
*        ls_fieldcat-col_pos = 44.
*        ls_fieldcat-hotspot = c_flag_on.
*      WHEN 'ENAME_VE'.
*        PERFORM change_fieldcatalogue USING text-f45.
*        ls_fieldcat-col_pos = 45.
*      WHEN 'ENAME_ZX'.
*        PERFORM change_fieldcatalogue USING text-f48.
*        ls_fieldcat-col_pos = 48.
*      WHEN 'ENAME_ZY'.
*        PERFORM change_fieldcatalogue USING text-f51.
*        ls_fieldcat-col_pos = 51.
*      WHEN 'KWERT_ZPRO'.
*        PERFORM change_fieldcatalogue USING text-f52.
*        ls_fieldcat-col_pos = 52.
*      WHEN 'WAERK_ZPRO'.
*        PERFORM change_fieldcatalogue USING text-f53.
*        ls_fieldcat-col_pos = 53.
*      WHEN 'KZWI3_ORD'.
*        PERFORM change_fieldcatalogue USING text-f54.
*        ls_fieldcat-col_pos = 54.
*      WHEN 'KZWI3_CC_ORD'.
*        PERFORM change_fieldcatalogue
*            USING text-f75.
*        ls_fieldcat-col_pos = 60.
*      WHEN 'ZUNITPR'.
*        PERFORM change_fieldcatalogue USING text-f56.
*        ls_fieldcat-col_pos = 61.
*      WHEN 'ZUNITPR_CC'.
*        PERFORM change_fieldcatalogue
*            USING text-f76.
*        ls_fieldcat-col_pos = 62.
*      WHEN 'ZUNITPRCURR'.
*        PERFORM change_fieldcatalogue USING text-f57.
*        ls_fieldcat-col_pos = 63.
*      WHEN 'KWERT_ZPRS'.
*        PERFORM change_fieldcatalogue USING text-f58.
*        ls_fieldcat-col_pos = 64.
*      WHEN 'WAERK_ZPRS'.
*        PERFORM change_fieldcatalogue USING text-f59.
*        ls_fieldcat-col_pos = 65.
*      WHEN 'ZPROFIT'.
*        PERFORM change_fieldcatalogue USING text-f60.
*        ls_fieldcat-col_pos = 70.
*      WHEN 'ZPROFCURR'.
*        PERFORM change_fieldcatalogue USING text-f61.
*        ls_fieldcat-col_pos = 71.
*      WHEN 'ZPROFPERC'.
*        PERFORM change_fieldcatalogue USING text-f62.
*        ls_fieldcat-col_pos = 72.
*      WHEN 'NAME1_VEND'.
*        PERFORM change_fieldcatalogue USING text-f66.
*        ls_fieldcat-col_pos = 76.
*      WHEN 'VBELN_DEL'.
*        ls_fieldcat-col_pos = 77.
*        ls_fieldcat-hotspot = c_flag_on.
*      WHEN 'WBSTK_TXT'.
*        PERFORM change_fieldcatalogue USING text-f69.
*        ls_fieldcat-col_pos = 79.
*      WHEN 'ZQUANT_DEL'.
*        PERFORM change_fieldcatalogue USING text-f72.
*        ls_fieldcat-col_pos = 82.
*      WHEN 'ZWAERK_DEL'.
*        PERFORM change_fieldcatalogue USING text-f73.
*        ls_fieldcat-col_pos = 83.
*      WHEN 'VBELN_INV'.
*        ls_fieldcat-col_pos = 86.
*        ls_fieldcat-hotspot = c_flag_on.
*      WHEN 'KZWI3_INV'.
*        PERFORM change_fieldcatalogue USING text-f80.
*        ls_fieldcat-col_pos = 90.
**>>>insert air22296 on 7/2/8 issue 4108
*      WHEN 'KZWI3_INV_CC'.
*        PERFORM change_fieldcatalogue USING text-f81.
*        ls_fieldcat-col_pos = 91.
**>>> end insert
*      WHEN 'ERDAT_INV'.
*        PERFORM change_fieldcatalogue USING text-f82.
*        ls_fieldcat-col_pos = 92.
*      WHEN 'ZQUANT_INV'.
*        PERFORM change_fieldcatalogue USING text-f84.
*        ls_fieldcat-col_pos = 94.
*      WHEN 'ZVRKME_INV'.
*        PERFORM change_fieldcatalogue USING text-f85.
*        ls_fieldcat-col_pos = 95.
*      WHEN 'ZAMOUNT'.
*        PERFORM change_fieldcatalogue USING text-f86.
*        ls_fieldcat-col_pos = 96.
*      WHEN 'ZWAERK_INV'.
*        PERFORM change_fieldcatalogue USING text-f87.
*        ls_fieldcat-col_pos = 97.
*      WHEN 'SPARTD'.
*        PERFORM change_fieldcatalogue USING text-f89.
*      WHEN 'REGION_WE'.
*        PERFORM change_fieldcatalogue USING text-f90.
*        ls_fieldcat-col_pos = 150.
*      WHEN 'CITY1_WE'.
*        PERFORM change_fieldcatalogue USING text-f91.
*        ls_fieldcat-col_pos = 151.
*      WHEN 'POST_CODE1_WE'.
*        PERFORM change_fieldcatalogue USING text-f92.
*        ls_fieldcat-col_pos = 152.
*      WHEN 'REGION_AG'.
*        PERFORM change_fieldcatalogue USING text-f93.
*        ls_fieldcat-col_pos = 153.
*      WHEN 'CITY1_AG'.
*        PERFORM change_fieldcatalogue USING text-f94.
*        ls_fieldcat-col_pos = 154.
*      WHEN 'POST_CODE1_AG'.
*        PERFORM change_fieldcatalogue USING text-f95.
*        ls_fieldcat-col_pos = 155.
*      WHEN 'ZFPLVAL'.
*        PERFORM change_fieldcatalogue USING text-f96.
*        ls_fieldcat-col_pos = 155.
*      WHEN 'FPROZ'.
*        PERFORM change_fieldcatalogue USING text-f97.
*        ls_fieldcat-col_pos = 155.
*      WHEN 'SPNAME2'.
*        PERFORM change_fieldcatalogue USING text-g11.
*        ls_fieldcat-col_pos = 157.
*      WHEN 'SPNAME3'.
*        PERFORM change_fieldcatalogue USING text-g19.
*        ls_fieldcat-col_pos = 158.
*      WHEN 'SPNAME4'.
*        PERFORM change_fieldcatalogue USING text-g20.
*        ls_fieldcat-col_pos = 159.
*      WHEN 'SHNAME2'.
*        PERFORM change_fieldcatalogue USING text-g12.
*        ls_fieldcat-col_pos = 160.
*      WHEN 'SHNAME3'.
*        PERFORM change_fieldcatalogue USING text-g21.
*        ls_fieldcat-col_pos = 161.
*      WHEN 'SHNAME4'.
*        PERFORM change_fieldcatalogue USING text-g22.
*        ls_fieldcat-col_pos = 162.
*      WHEN 'BPNAME2'.
*        PERFORM change_fieldcatalogue USING text-g13.
*        ls_fieldcat-col_pos = 165.
*      WHEN 'BPNAME3'.
*        PERFORM change_fieldcatalogue USING text-g23.
*        ls_fieldcat-col_pos = 166.
*      WHEN 'BPNAME4'.
*        PERFORM change_fieldcatalogue USING text-g24.
*        ls_fieldcat-col_pos = 167.
*      WHEN 'POSNR_ORD'.
*        PERFORM change_fieldcatalogue USING text-f98.
*      WHEN 'POSNR_DEL'.
*        PERFORM change_fieldcatalogue USING text-f99.
*      WHEN 'POSNR_INV'.
*        PERFORM change_fieldcatalogue USING text-g01.
*      WHEN 'KWMENG_OH'.
*        PERFORM change_fieldcatalogue USING text-g02.
*      WHEN 'KZWI3_OH'.
*        PERFORM change_fieldcatalogue USING text-g03.
*      WHEN 'KZWI3_OH_CC'.
*        PERFORM change_fieldcatalogue USING text-g18.
*      WHEN 'KWERT_COS_OH'.
*        PERFORM change_fieldcatalogue USING text-g04.
*      WHEN 'ZPROFIT_OH'.
*        PERFORM change_fieldcatalogue USING text-g05.
*      WHEN 'ZPROFPC_OH'.
*        PERFORM change_fieldcatalogue USING text-g06.
*      WHEN 'KWERT_COS_IN'.
*        PERFORM change_fieldcatalogue USING text-g07.
*      WHEN 'ZPROFIT_IN'.
*        PERFORM change_fieldcatalogue USING text-g08.
*      WHEN 'ZPROFPC_IN'.
*        PERFORM change_fieldcatalogue USING text-g09.
*      WHEN 'ZUONR'.
*        PERFORM change_fieldcatalogue USING text-g10.
*      WHEN 'KZWI3_ORD_CC'.
*        PERFORM change_fieldcatalogue USING text-g14.
*      WHEN 'ZPROFIT_CC'.
*        PERFORM change_fieldcatalogue USING text-g15.
*      WHEN 'WAERK_CC'.
*        PERFORM change_fieldcatalogue USING text-g16.
*      WHEN 'VKORG'.
*      WHEN 'VTWEG'.
*      WHEN 'SPART'.
*      WHEN 'VKBUR'.
*      WHEN 'VKGRP'.
*      WHEN 'PRCTR'.
*      WHEN 'WW002'.
*      WHEN 'WW006'.
*      WHEN 'WW007'.
*      WHEN 'BSTKD'.
*      WHEN 'BZIRK'.
*      WHEN 'VDATU'.
*      WHEN 'EBELN'.
*      WHEN 'ERNAM'.
*      WHEN 'AUART'.
*      WHEN 'BNDDT'.
*      WHEN 'WERKS'.
*      WHEN 'MATNR'.
*      WHEN 'MAKTX'.
*      WHEN 'PSTYV'.
*      WHEN 'MTPOS'.
*      WHEN 'KUNAG'.
*      WHEN 'KUNWE'.
*      WHEN 'FAKSK'.
*      WHEN 'LIFSK'.
*      WHEN 'PARVW_VE'.
*      WHEN 'PERNR_VE'.
*      WHEN 'PARVW_ZX'.
*      WHEN 'ECNAME1'.
*        PERFORM change_fieldcatalogue USING text-g25.
*      WHEN 'ECNAME2'.
*        PERFORM change_fieldcatalogue USING text-g26.
*      WHEN 'ECNAME3'.
*        PERFORM change_fieldcatalogue USING text-g27.
*      WHEN 'ECNAME4'.
*        PERFORM change_fieldcatalogue USING text-g28.
**      WHEN OTHERS.
**        MESSAGE I000(yse_sales_log)
**            WITH 'BAD FIELDNAME ' ls_fieldcat-fieldname.
**
*    ENDCASE.
*    MODIFY it_fieldcat FROM ls_fieldcat.
  ENDLOOP.

  gs_layout-colwidth_optimize   = 'X'.
  gs_layout-confirmation_prompt = 'X'.
*  gs_layout-key_hotspot         = 'X'.
  gs_layout-detail_titlebar     = 'SALES REPORTING'.
*  GS_LAYOUT-COLTAB_FIELDNAME    = 'CELL'.

ENDFORM.                    " CHANGE_CATALOG

*--------------------------------------------------------------------*
*       Form  ALV_OUTPUT                                             *
*--------------------------------------------------------------------*
FORM alv_output.
  SORT it_data BY vbeln_ord posnr_ord ASCENDING wadat_ist DESCENDING.
* Begin of Insertion MOD-005
    select SINGLE vkorg
           into lv_vkorg
            FROM yse_sd_vkorg3
            WHERE vkorg IN S_VKORG.
      if sy-subrc IS NOT INITIAL.
*  End of Insertion MOD-005
  DELETE ADJACENT DUPLICATES FROM it_data COMPARING vbeln_ord
  posnr_ord.
  endif.  "+MOD-005

*  variant-report    = 'YSE_SD_SALES'.
*  variant-variant   = variant.
  gs_sd_alv_variant = g_variant.

  IF NOT cb_lc IS INITIAL.
    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
      EXPORTING
        i_callback_program      = 'YSE_SD_SALES'
        i_callback_user_command = g_user_command
        i_callback_top_of_page  = 'ALV_TOP'
        i_grid_title            = 'Sales reporting'
        is_layout               = gs_layout
        it_fieldcat             = it_fieldcat
        it_sort                 = it_sort
        i_default               = 'X'
        i_save                  = 'A'
        is_variant              = gs_sd_alv_variant
        i_screen_start_column   = 0
        i_screen_start_line     = 0
        i_screen_end_column     = 0
        i_screen_end_line       = 0
      TABLES
        t_outtab                = it_data
      EXCEPTIONS
        program_error           = 1
        OTHERS                  = 2.
    IF sy-subrc NE 0.
*      message id sy-msgid type sy-msgty number sy-msgno
*              with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ELSE.
    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
      EXPORTING
        i_callback_program      = 'YSE_SD_SALES'
        i_callback_user_command = g_user_command
        i_grid_title            = 'Sales reporting'
        is_layout               = gs_layout
        it_fieldcat             = it_fieldcat
        it_sort                 = it_sort
        i_default               = 'X'
        i_save                  = 'A'
        is_variant              = gs_sd_alv_variant
        i_screen_start_column   = 0
        i_screen_start_line     = 0
        i_screen_end_column     = 0
        i_screen_end_line       = 0
      TABLES
        t_outtab                = it_data
      EXCEPTIONS
        program_error           = 1
        OTHERS                  = 2.
    IF sy-subrc NE 0.
*      message id sy-msgid type sy-msgty number sy-msgno
*              with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
  ENDIF.

******MOD-004 Being of insert
  DATA: lv_method TYPE char10.
  lv_method = 'SPOOL'.

*   USE THE CONCATENATE METHOD TO GENERATE FILE
  IF lv_method = 'CONC'.

    DATA: ls_sort TYPE slis_sortinfo_alv,
          ls_attach TYPE  soli,
          lt_sd_sales_lay TYPE STANDARD TABLE OF yse_sd_sales_lay,
          ls_sd_sales_lay TYPE yse_sd_sales_lay,
          ls_fieldcat TYPE slis_fieldcat_alv,
          ls_filter TYPE slis_filter_alv,
          lr_matnr  TYPE RANGE OF matnr,
          lv_string   TYPE string,
          lt_data   LIKE it_data OCCURS 0 WITH HEADER LINE,
          lv_len    TYPE sy-tabix,
          lv_txt_ind   TYPE char1.
    FIELD-SYMBOLS: <lfs_field> TYPE ANY.
    DATA: ls_matnr LIKE LINE OF lr_matnr.

    CALL FUNCTION 'REUSE_ALV_GRID_LAYOUT_INFO_GET'
         IMPORTING
           es_layout                 = gs_e_layout
           et_fieldcat               = gt_e_fieldcat[]
           et_sort                   = gt_e_sort[]
           et_filter                 = gt_e_filter[]
           es_grid_scroll            = gs_e_grid_scroll
           es_variant                = gs_e_variant
           et_marked_columns         = gt_e_marked
*        ET_FILTERED_ENTRIES       =
*        ET_FIELDCAT_BACKEND       =
*        ES_PRINT                  =
         EXCEPTIONS
           no_infos                  = 1
           program_error             = 2
           OTHERS                    = 3
                 .
    IF sy-subrc <> 0.
      SELECT *
        FROM yse_sd_sales_lay
        INTO TABLE lt_sd_sales_lay.
      IF sy-subrc = 0.
        LOOP AT lt_sd_sales_lay INTO ls_sd_sales_lay
          WHERE export = 'X'.
          READ TABLE it_fieldcat INTO ls_fieldcat
            WITH KEY fieldname = ls_sd_sales_lay-fname.
          IF sy-subrc = 0.
            ls_fieldcat-col_pos = ls_sd_sales_lay-seqno.
            APPEND ls_fieldcat TO gt_e_marked.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDIF.

    SORT gt_e_marked BY col_pos.
    lv_txt_ind = 'M'.
    IF gt_e_sort[] IS NOT INITIAL.
      LOOP AT gt_e_sort INTO ls_sort.

      ENDLOOP.
*    SORT it_data by
    ENDIF.
    ls_matnr-sign = 'E'.
    ls_matnr-option = 'EQ'.
    ls_matnr-low = 'GMACH'.
    APPEND ls_matnr TO lr_matnr.

*  append LINES OF  it_data to lt_data.
    LOOP AT it_data.
      IF it_data-matnr IN lr_matnr.
        APPEND it_data TO lt_data[].
      ENDIF.
    ENDLOOP.

*BSTKD      CustomerPO
*POSNR_ORD    OrdItm
*MATNR      Material
*LFIMG      DelivQty
*VBELN_DEL    Delivery
*WADAT_IST    ActualGIDate
*NAME1_AG   SoldToName1

    LOOP AT lt_data.
      CLEAR: lv_len,ls_attach.
      LOOP AT gt_e_marked INTO ls_fieldcat.
        CLEAR lv_string.
        ASSIGN COMPONENT ls_fieldcat-fieldname OF STRUCTURE lt_data
          TO <lfs_field>.
        lv_string = <lfs_field>.
        CONCATENATE ls_attach-line  gc_tab lv_string
          INTO ls_attach-line.
      ENDLOOP.
      DESCRIBE FIELD ls_attach-line LENGTH lv_len IN CHARACTER MODE.
      lv_len = lv_len - 1.
      IF lv_len > 0.
        ls_attach-line = ls_attach-line+1(lv_len).
        CONCATENATE ls_attach-line gc_lf INTO ls_attach-line.
      ENDIF.
      IF ls_attach IS NOT INITIAL.
        APPEND ls_attach TO gt_attach_tab.
      ENDIF.
    ENDLOOP.
    IF gt_attach_tab IS NOT INITIAL.
      CLEAR ls_attach.
      LOOP AT gt_e_marked INTO ls_fieldcat.
        CASE lv_txt_ind.
          WHEN 'S'.
            CONCATENATE ls_attach-line  gc_tab ls_fieldcat-seltext_s
              INTO ls_attach-line.
          WHEN 'M'.
            CONCATENATE ls_attach-line  gc_tab ls_fieldcat-seltext_m
              INTO ls_attach-line.
          WHEN 'L'.
            CONCATENATE ls_attach-line  gc_tab ls_fieldcat-seltext_l
              INTO ls_attach-line.
          WHEN OTHERS.
        ENDCASE.
      ENDLOOP.
      CLEAR lv_len.
      DESCRIBE FIELD ls_attach-line LENGTH lv_len IN CHARACTER MODE.
      lv_len = lv_len - 1.
      IF  lv_len > 0..
        ls_attach-line = ls_attach-line+1(lv_len).
        CONCATENATE ls_attach-line gc_lf INTO ls_attach-line.
      ENDIF.

      IF ls_attach IS NOT INITIAL.
        INSERT ls_attach INTO gt_attach_tab INDEX 1.
      ENDIF.
    ENDIF.
  ELSEIF lv_method = 'SPOOL'.
    DATA: lt_buffer TYPE STANDARD TABLE OF char255,
          lv_rqident TYPE TSP01-RQIDENT,
          lv_delime  TYPE string
            VALUE '---------------------------------------------',
          lv_index   TYPE sy-tabix,
          lv_buffer TYPE char255.
    CLEAR: lv_index.
    lv_rqident = sy-spono.
    CHECK lv_rqident IS NOT INITIAL.
    CALL FUNCTION 'RSPO_RETURN_ABAP_SPOOLJOB'
      EXPORTING
        rqident                    = lv_rqident
*     FIRST_LINE                 = 1
*     LAST_LINE                  =
*     PAGES                      =
      TABLES
        buffer                     =  lt_buffer
*   EXCEPTIONS
*     NO_SUCH_JOB                = 1
*     NOT_ABAP_LIST              = 2
*     JOB_CONTAINS_NO_DATA       = 3
*     SELECTION_EMPTY            = 4
*     NO_PERMISSION              = 5
*     CAN_NOT_ACCESS             = 6
*     READ_ERROR                 = 7
*     OTHERS                     = 8
              .
    IF sy-subrc <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
    LOOP AT lt_buffer INTO lv_buffer.
      CLEAR: ls_attach.
      REPLACE ALL OCCURRENCES OF gc_tab in lv_buffer WITH space.
      IF lv_buffer cs lv_delime.
        lv_index = lv_index + 1.
        delete lt_buffer INDEX sy-tabix.
        CONTINUE.
      ENDIF.
      ls_attach-line = lv_buffer.
      CONDENSE ls_attach-line.
      IF ls_attach-line+0(1) = '|'.
        ls_attach-line = ls_attach-line+1.
      ENDIF.
      IF sy-tabix <> 1.
        CONCATENATE gc_lf ls_attach-line INTO ls_attach-line.
      ENDIF.
      IF lv_index >= 1.
        REPLACE all OCCURRENCES OF '|' in ls_attach-line WITH gc_tab.
      ENDIF.
      APPEND  ls_attach to gt_attach_tab.
    ENDLOOP.
  ENDIF.
  CHECK gt_attach_tab IS NOT INITIAL.
  SELECT *
    FROM yse_batch_mail
    INTO TABLE gt_batch_mail
    WHERE cprog = sy-cprog
      AND uname = sy-uname
      AND send = 'X'.
  IF sy-subrc = 0.
    IF sy-batch IS NOT INITIAL.
      PERFORM send_mail.
    ENDIF.
  ENDIF.

******End of MOD-004 insert**

ENDFORM.                    " ALV_OUTPUT

**********************************************************************
* SUBROUTINES  LEVEL 03                                              *
**********************************************************************

*--------------------------------------------------------------------*
*   Form  GET_STATUS                                                 *
*--------------------------------------------------------------------*
FORM get_status USING table field status
                CHANGING text.

  CLEAR: str_status,
         text.

  str_status-spras = sy-langu.
  str_status-tbnam = table.
  str_status-fdnam = field.
  str_status-statu = status.

  CALL FUNCTION 'RV_DOCUMENT_STATUS_TEXTS'
    EXPORTING
      tvbst_wa      = str_status
    IMPORTING
*     returncode    =
      text          = text.

ENDFORM.                    " GET_STATUS

*-------------------------------------------------------------------*
*   Form  CHANGE_FIELDCATALOGUE                                     *
*-------------------------------------------------------------------*
FORM change_fieldcatalogue USING title.

  ls_fieldcat-seltext_s    = title.
  ls_fieldcat-seltext_m    = title.
  ls_fieldcat-seltext_l    = title.
  ls_fieldcat-reptext_ddic = title.

ENDFORM.                    " CHANGE_FIELDCATALOGUE

*------------------------------------------------------------------*
*   Form  USER_COMMAND                                             *
*------------------------------------------------------------------*
*   --> R_UCOMM                                                    *
*   --> RS_SELFIELD                                                *
*------------------------------------------------------------------*
FORM user_command USING ucomm    LIKE sy-ucomm
                        selfield TYPE slis_selfield.

* Check function code & selection field
* (show corresponding document)
  CASE ucomm.
    WHEN '&IC1'.
      CASE selfield-fieldname.
        WHEN 'VBELN_ORD'.
          SET PARAMETER ID 'AUN' FIELD selfield-value.
          CALL TRANSACTION 'VA03' AND SKIP FIRST SCREEN.
        WHEN 'VBELN_DEL'.
          SET PARAMETER ID 'VL' FIELD selfield-value.
          CALL TRANSACTION 'VL03N' AND SKIP FIRST SCREEN.
        WHEN 'VBELN_INV'.
          SET PARAMETER ID 'VF' FIELD selfield-value.
          CALL TRANSACTION 'VF03' AND SKIP FIRST SCREEN.
      ENDCASE.
  ENDCASE.

***mod-004 begin insert
  PERFORM get_alv_info.
****mod-004 end insert
ENDFORM.                    " USER_COMMAND

*&------------------------------------------------------------------*
*&      Form  Check_Authorization
*&------------------------------------------------------------------*
FORM check_authorization .

  LOOP AT s_vkorg.
    LOOP AT s_vtweg.
      LOOP AT s_sparth.
        AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
                        ID     'VKORG' FIELD s_vkorg-low
                        ID     'VTWEG' FIELD s_vtweg-low
                        ID     'SPART' FIELD s_sparth-low
                        ID     'ACTVT' DUMMY.

        IF sy-subrc = 4.
*         No authorisation to display data from Sales Organisation
          MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '005'
                                   WITH s_vkorg-low s_vtweg-low
                                   s_sparth-low.
        ELSEIF sy-subrc <> 0.
*         Error checking authorization.
          MESSAGE ID 'YSE_GENERAL' TYPE 'E' NUMBER '004'.
        ENDIF.

      ENDLOOP.
    ENDLOOP.
  ENDLOOP.

ENDFORM.                    " Check_Authorization

*&-------------------------------------------------------------------*
*&      Form  RESTRICT_SO
*&-------------------------------------------------------------------*
FORM restrict_so .

* Include type pool SSCR (selection screen restriction)
  TYPE-POOLS: sscr.

  DATA: ls_restrict TYPE sscr_restrict,
*                      " to define the select options' restrictions
        ls_optlist  TYPE sscr_opt_list," to define type of restrictions
        ls_ass      TYPE sscr_ass.     " to assign select option(s) to

* Local constants
  CONSTANTS: lc_objk1 TYPE string VALUE 'OBJK1'.


* Restrict Select options
  ls_optlist-name = lc_objk1.
  ls_optlist-options-eq = 'X'.
  APPEND ls_optlist TO ls_restrict-opt_list_tab.

  ls_ass-op_main = lc_objk1.
  ls_ass-kind = 'S'.
  ls_ass-name = 'S_VKORG'.
  ls_ass-sg_main = 'I'.
  ls_ass-sg_addy = space.
  APPEND ls_ass TO ls_restrict-ass_tab.
  ls_ass-name = 'S_VTWEG'.
  APPEND ls_ass TO ls_restrict-ass_tab.
  ls_ass-name = 'S_SPARTH'.
  APPEND ls_ass TO ls_restrict-ass_tab.

  CALL FUNCTION 'SELECT_OPTIONS_RESTRICT'
    EXPORTING
*      PROGRAM                      =
      restriction                  = ls_restrict
*      DB                           = ' '
    EXCEPTIONS
      too_late                     = 1
      repeated                     = 2
      selopt_without_options       = 3
      selopt_without_signs         = 4
      invalid_sign                 = 5
      empty_option_list            = 6
      invalid_kind                 = 7
      repeated_kind_a              = 8
      OTHERS                       = 9.

  IF sy-subrc <> 0.
  ENDIF.

ENDFORM.                    " RESTRICT_SO

*&-------------------------------------------------------------------*
*&      Form  ALV_TOP
*&-------------------------------------------------------------------*
FORM alv_top.

* ALV header declarations
  DATA: t_header      TYPE slis_t_listheader,
        wa_header     TYPE slis_listheader,
*       T_LINE        LIKE WA_HEADER-INFO,
        ld_lines      TYPE i,
        ld_linesc(10) TYPE c.


* Nr of records
  DESCRIBE TABLE it_data LINES ld_lines.
  ld_linesc = ld_lines.

  wa_header-typ  = 'S'.
  wa_header-key  = 'Nr of lines:'(101).
  wa_header-info = ld_linesc.
  APPEND wa_header TO t_header.
  CLEAR: wa_header. ", T_LINE.

  CALL FUNCTION 'REUSE_ALV_COMMENTARY_WRITE'
    EXPORTING
      it_list_commentary = t_header
      i_logo             = 'GANESH_LOGO'.

ENDFORM.                    "ALV_TOP

*&-------------------------------------------------------------------*
*&      Form  get_billing_plan_data
*&-------------------------------------------------------------------*
FORM get_billing_plan_data .

  IF     NOT it_vbfa2-fplnr IS INITIAL
     AND NOT it_vbfa2-fpltr IS INITIAL.

    IF    it_vbfa2-fplnr NE it_fplt-fplnr
       OR it_vbfa2-fpltr NE it_fplt-fpltr.
      READ TABLE it_fplt WITH KEY fplnr = it_vbfa2-fplnr
                                  fpltr = it_vbfa2-fpltr.
    ELSE.
      sy-subrc = 0.
    ENDIF.
    IF sy-subrc EQ 0.
      str_data-fproz   = it_fplt-fproz.
      str_data-zfplval = it_fplt-fakwr.
      str_data-faksp = it_fplt-faksp.
      IF str_data-fproz IS INITIAL.
        IF NOT str_data-kzwi3_ord IS INITIAL.
          str_data-fproz = str_data-zfplval /
                           str_data-kzwi3_ord * 100.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " get_billing_plan_data

*&-------------------------------------------------------------------*
*&      Form  get_GTS_invoice
*&-------------------------------------------------------------------*
FORM get_gts_invoice.

  DATA: lv_zuonr(10) TYPE c.


  IF NOT str_data-vbeln_inv IS INITIAL AND
    NOT str_data-fkdat IS INITIAL.
    CLEAR bkpf.

*   No join possible for BSEG (pooled tables, bla bla...)
    SELECT SINGLE * FROM bkpf INTO bkpf
           WHERE awkey EQ str_data-vbeln_inv
             AND bukrs EQ it_vbrk-bukrs
             AND gjahr EQ str_data-fkdat(4).
    IF sy-subrc EQ 0.
      str_data-belnr = bkpf-belnr.             "20080624 CR####
      SELECT SINGLE zuonr FROM bseg INTO str_data-zuonr
             WHERE belnr EQ bkpf-belnr
               AND bukrs EQ bkpf-bukrs
               AND gjahr EQ bkpf-gjahr
               AND koart EQ 'D'.
*      IF SY-SUBRC EQ 0.
*        SHIFT STR_DATA-ZUONR LEFT DELETING LEADING ''.
*        WRITE STR_DATA-ZUONR TO LV_ZUONR.
*        CLEAR STR_DATA-ZUONR.
*        SHIFT LV_ZUONR RIGHT DELETING TRAILING ''.
*        OVERLAY LV_ZUONR WITH '0000000000'.
*        MOVE LV_ZUONR TO STR_DATA-ZUONR.
*      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " get_GTS_invoice

*&---------------------------------------------------------------------*
*&      Form  BUILD_TABLE_OPEN_ORDERS            "js-001
*&---------------------------------------------------------------------*
*       Build table with open orders for performance
*----------------------------------------------------------------------*
FORM build_table_open_orders .

  DATA: lv_count(5)    TYPE n.


* Build table
  SORT it_sales_open BY vbeln_ord posnr_ord vbeln_del posnr_del.

  LOOP AT it_sales_open INTO gv_sales_open.
    MODIFY yse_sd_sales_opn FROM gv_sales_open.

    lv_count = lv_count + 1.
    IF lv_count > 99.
      COMMIT WORK.
      CLEAR lv_count.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " BUILD_TABLE_OPEN_ORDERS

*&---------------------------------------------------------------------*
*&      Form  SELECT_OPEN_ORDERS_TABLE           "js-001
*&---------------------------------------------------------------------*
*       Select open orders from table (for performance)
*----------------------------------------------------------------------*
FORM select_open_orders_table .

  REFRESH it_data.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE it_data
           FROM yse_sd_sales_opn
           WHERE vbeln_ord IN s_vbeln
             AND posnr_ord IN s_posnr
             AND vkorg     IN s_vkorg
             AND vtweg     IN s_vtweg
             AND spart     IN s_sparth
             AND spartd    IN s_spartd
             AND vkbur     IN s_vkbur
             AND vkgrp     IN s_vkgrp
             AND prctr     IN s_prctr
             AND ww002     IN s_ww002
             AND ww006     IN s_ww006
             AND ww007     IN s_ww007
             AND cmgst     IN s_cmgst
             AND bzirk     IN s_bzirk
             AND vdatu     IN s_vdatu
             AND edatu     IN s_edatu
             AND ebeln     IN s_ebeln
             AND erdat_ord IN s_erdat1
             AND ernam     IN s_ernam
             AND auart     IN s_auart
             AND werks     IN s_werks
             AND matnr     IN s_matnr
             AND pstyv     IN s_pstyv
             AND mtpos     IN s_mtpos
             AND kunag     IN s_kunag
             AND kunwe     IN s_kunwe
             AND kunre     IN s_kunre
             AND hkunnr    IN s_hkunnr
             AND bran1     IN s_bran1
             AND faksk     IN s_faksk
             AND lifsk     IN s_lifsk
             AND erdat     IN s_erdat3
             AND pernr_ve  IN s_pernr
             AND pernr_zx  IN s_pernr
             AND pernr_zy  IN s_pernr
             AND fkart     IN s_fkart
             AND erdat_inv IN s_erdat2
             AND fkdat     IN s_fkdat
             AND faksp     IN s_faksp
             AND zuonr     IN s_zuonr
             AND abgru     IN s_abgru
             AND mstav     IN s_mstav
             AND mmsta     IN s_mmsta
             AND kzaus     IN s_kzaus.

  SORT it_data BY vbeln_ord posnr_ord
                  vbeln_del posnr_del.

* Only sales orders delivered ?
  IF NOT cb_sel IS INITIAL.
    DELETE it_data WHERE vbeln_del IS INITIAL.
  ENDIF.

* Fill fields (descriptions, names, ...)
  IF NOT it_data[] IS INITIAL.
    PERFORM fill_fields.
  ENDIF.

*** js-003 * begin ***
* Selection on PO type / Reference (NOT in table yet)
* PO type
  IF NOT s_bsark[] IS INITIAL.
    DELETE it_data
           WHERE bsark NOT IN s_bsark.
  ENDIF.
* Reference
  IF NOT s_ihrez[] IS INITIAL.
    DELETE it_data
           WHERE ihrez NOT IN s_ihrez.
  ENDIF.
*** js-003 * end ***

*** lme001 * begin ***
* Selection on CTP quotation number(NOT in table yet)
  IF NOT s_xblnr[] IS INITIAL.
    DELETE it_data
           WHERE xblnr NOT IN s_xblnr.
  ENDIF.
*** lme001 * end ***

ENDFORM.                    " SELECT_OPEN_ORDERS_TABLE

*&---------------------------------------------------------------------*
*&      Form  FILL_FIELDS                        "js-001
*&---------------------------------------------------------------------*
*       Fill fields (descriptions, names, ...)
*----------------------------------------------------------------------*
FORM fill_fields .

* Get additional data
  PERFORM get_additional_data.

* Fill data
  LOOP AT it_data.

*   Sales office
    READ TABLE it_tvkbt
*               WITH KEY vkbur = it_data-vkbur              "js-005
               WITH TABLE KEY spras = sy-langu              "js-005
                              vkbur = it_data-vkbur.        "js-005
*               BINARY SEARCH.                              "js-005
    IF sy-subrc = 0.
      it_data-vkbur_txt   = it_tvkbt-bezei.
    ENDIF.
*   Sales group
    READ TABLE it_tvgrt
*               WITH KEY vkgrp = it_data-vkgrp              "js-005
               WITH TABLE KEY spras = sy-langu              "js-005
                              vkgrp = it_data-vkgrp.        "js-005
*               BINARY SEARCH.                              "js-005
    it_data-vkgrp_txt   = it_tvgrt-bezei.
*   Credit check
    READ TABLE xt_dd07
         WITH KEY domname    = 'CMGST'
                  ddlanguage = 'E'
                  domvalue_l = it_data-cmgst
       BINARY SEARCH.
    IF sy-subrc = 0.
      it_data-cmgstt = xt_dd07-ddtext.
    ENDIF.
*   Rule in billing plan
    READ TABLE xt_dd07
          WITH KEY domname    = 'FAREG'
                   ddlanguage = 'E'
                   domvalue_l = it_data-fareg
          BINARY SEARCH.
    IF sy-subrc = 0.
      it_data-faregt = xt_dd07-ddtext.
    ENDIF.
*   Material description
    READ TABLE it_makt WITH KEY matnr = it_data-matnr.
    IF sy-subrc = 0.
      it_data-maktx = it_makt-arktx.
    ENDIF.
*   Status text of LFSTA (Delivery status)
    PERFORM get_status USING 'VBUP' 'LFSTA' it_data-lfsta
                       CHANGING it_data-lfsta_txt.

*   Status text of FKSAK (Billing status)
    PERFORM get_status USING 'VBUK' 'FKSAK' it_data-fksak
                       CHANGING it_data-fksak_txt.

*   Status text of GBSTK (Overall processing status - document)
    PERFORM get_status USING 'VBUK' 'GBSTK' it_data-gbstk
                       CHANGING it_data-gbstk_txt.

*   Status text of GBSTA (Overall processing status - item)
    PERFORM get_status USING 'VBUP' 'GBSTA' it_data-gbsta
                       CHANGING it_data-gbsta_txt.

*   Status text of WBSTK (Total goods movement status)
    PERFORM get_status USING 'VBUK' 'WBSTK' it_data-wbstk
                       CHANGING it_data-wbstk_txt.
*   Customer group
    CLEAR: it_kdgrp,
           xt_kdgrp.
    IF NOT it_data-kunag IS INITIAL.
      READ TABLE it_kdgrp WITH KEY kunnr = it_data-kunag
                          BINARY SEARCH.
      it_data-kdgrp_ag = it_kdgrp-kdgrp.
      READ TABLE xt_kdgrp
           WITH KEY kdgrp = it_data-kdgrp_ag
                    spras = sy-langu.
      IF sy-subrc <> 0 AND sy-langu <> 'E'.
        READ TABLE xt_kdgrp
             WITH KEY kdgrp = it_data-kdgrp_ag
                      spras = 'E'.
      ENDIF.
      IF sy-subrc = 0.
        it_data-kdgrpt_ag    = xt_kdgrp-ktext.
      ENDIF.
    ENDIF.
*   Sold-to
    PERFORM get_customer USING it_data-kunag 'AG'.
    it_data-name1_ag = xt_adrc-name1.
    it_data-spname2  = xt_adrc-name2.
    it_data-spname3  = xt_adrc-name3.
    it_data-spname4  = xt_adrc-name4.
    it_data-region_ag = xt_adrc-region.
    it_data-city1_ag  = xt_adrc-city1.
    it_data-post_code1_ag = xt_adrc-post_code1.
*   Ship-to
    PERFORM get_customer USING it_data-kunwe 'WE'.
    it_data-name1_we = xt_adrc-name1.
    it_data-shname2 = xt_adrc-name2.
    it_data-shname3 = xt_adrc-name3.
    it_data-shname4 = xt_adrc-name4.
    it_data-street  = xt_adrc-street.  "MOD-001
    it_data-region_we = xt_adrc-region.
    it_data-city1_we  = xt_adrc-city1.
    it_data-post_code1_we = xt_adrc-post_code1.
*    it_data-country   = xt_adrc-country.
*   Bill-to
    PERFORM get_customer USING it_data-kunre 'RE'.
    it_data-name1_re = xt_adrc-name1.
    it_data-bpname2  = xt_adrc-name2.
    it_data-bpname3  = xt_adrc-name3.
    it_data-bpname4  = xt_adrc-name4.
*   HLEVEL customer
    IF NOT it_data-hkunnr IS INITIAL.
      PERFORM get_customer USING it_data-hkunnr '  '.
      it_data-name1_hl = it_adr-name1.
      it_data-name3_hl = xt_adrc-name3.
      it_data-name4_hl = xt_adrc-name4.
    ENDIF.
*   End customer
    IF NOT it_data-eccustn IS INITIAL.
      PERFORM get_customer USING it_data-eccustn 'ZE'.
      it_data-ecname1 = xt_adrc-name1.
      it_data-ecname2 = xt_adrc-name2.
      it_data-ecname3 = xt_adrc-name3.
      it_data-ecname4 = xt_adrc-name4.
      it_data-eccity  = xt_adrc-city1.
      it_data-ecregio = xt_adrc-region.
      it_data-sort1   = xt_adrc-sort1.
*     Additional EC data
      CLEAR: it_vbpa_cust,
             it_end_cust_district,
             it_end_cust_rep.
      READ TABLE it_vbpa_cust
           WITH KEY vbeln = it_data-vbeln_ord
                    posnr = it_data-posnr_ord
           BINARY SEARCH.
      IF sy-subrc NE 0.
        READ TABLE it_vbpa_cust
             WITH KEY vbeln = it_data-vbeln_ord
             BINARY SEARCH.
      ENDIF.
*     End customer district
      READ TABLE it_end_cust_district
           WITH KEY eccustn = it_vbpa_cust-kunnr
                    vkorg   = it_data-vkorg
                    vtweg   = it_data-vtweg
                    spart   = it_data-spart
           BINARY SEARCH.
      it_data-ecdisct = it_end_cust_district-ecdisct.
*     End customer representative
      READ TABLE it_end_cust_rep
           WITH KEY eccustn = it_vbpa_cust-kunnr
                    vkorg   = it_data-vkorg
                    vtweg   = it_data-vtweg
                    spart   = it_data-spart
           BINARY SEARCH.
      it_data-ecsrep =  it_end_cust_rep-ecsrep.
    ENDIF.
    IF NOT it_data-echlcus IS INITIAL.
      PERFORM get_customer USING it_data-echlcus '  '.
      it_data-echlcus_nam1 = xt_adrc-name1.
    ENDIF.
*   Vendor
    CLEAR: it_lfa1.
    IF NOT it_data-lifnr IS INITIAL.
*** js-005 * begin ***
*      READ TABLE it_lfa1 WITH KEY lifnr = it_data-lifnr
*                         BINARY SEARCH.
      READ TABLE it_lfa1 WITH TABLE KEY lifnr = it_data-lifnr.
*** js-005 * end ***
      IF sy-subrc = 0.
        it_data-name1_vend = it_lfa1-name1.
      ENDIF.
    ENDIF.
*   Sales rep. (names)
    IF NOT it_data-pernr_ve IS INITIAL.
      PERFORM get_sales_rep_name USING it_data-pernr_ve
                                 CHANGING it_data-ename_ve.
    ENDIF.
    IF NOT it_data-pernr_zx IS INITIAL.
      PERFORM get_sales_rep_name USING it_data-pernr_zx
                                 CHANGING it_data-ename_zx.
    ENDIF.
    IF NOT it_data-pernr_zy IS INITIAL.
      PERFORM get_sales_rep_name USING it_data-pernr_zy
                                 CHANGING it_data-ename_zy.
    ENDIF.

*** js-003 * begin ***
*   PO type / Reference
    READ TABLE it_vbak_acc WITH KEY vbeln = it_data-vbeln_ord
                           BINARY SEARCH.
    IF sy-subrc = 0.
      it_data-bsark = it_vbak_acc-bsark.
      it_data-ihrez = it_vbak_acc-ihrez.
*** lme001 * begin ***
      it_data-xblnr = it_vbak_acc-xblnr.
*** lme001 * end ***
    ENDIF.
*** js-003 * end ***

    MODIFY it_data.

  ENDLOOP.

ENDFORM.                    " FILL_FIELDS

*&---------------------------------------------------------------------*
*&      Form  GET_ADDITIONAL_DATA                "js-001
*&---------------------------------------------------------------------*
*       Get additional data
*----------------------------------------------------------------------*
FORM get_additional_data .

  DATA: lv_tabix       LIKE sy-tabix,
        lv_addrnumber  LIKE adrc-addrnumber.

  DATA: lt_pa0001   TYPE TABLE OF xtyp_pa0001.              "js-005


* Sales office
*  SELECT * FROM tvkbt INTO TABLE it_tvkbt                  "js-005
  SELECT * FROM tvkbt INTO TABLE it_tvkbti                  "js-005
           FOR ALL ENTRIES IN it_data
           WHERE spras EQ sy-langu
             AND vkbur EQ it_data-vkbur.
* begin of delete lme004
*  SORT it_tvkbt BY vkbur spras.
* end of delete lme004
*** js-005 * begin ***
*  DELETE ADJACENT DUPLICATES FROM it_tvkbt.
  SORT it_tvkbti BY spras vkbur.
  DELETE ADJACENT DUPLICATES FROM it_tvkbti
         COMPARING spras vkbur.
  it_tvkbt[] = it_tvkbti[].
*** js-005 * begin ***

* Sales group
*  SELECT * FROM tvgrt INTO TABLE it_tvgrt                  "js-005
  SELECT * FROM tvgrt INTO TABLE it_tvgrti                  "js-005
           FOR ALL ENTRIES IN it_data
           WHERE spras EQ sy-langu
             AND vkgrp EQ it_data-vkgrp.
* begin of delete lme004
*  SORT it_tvgrt BY vkgrp spras.
* end of delete lme004
*** js-005 * begin ***
*  DELETE ADJACENT DUPLICATES FROM it_tvgrt.
  SORT it_tvgrti BY spras vkgrp.
  DELETE ADJACENT DUPLICATES FROM it_tvgrti
         COMPARING spras vkgrp.
  it_tvgrt[] = it_tvgrti[].
*** js-005 * end ***

* Status
  SELECT dd07l~domname dd07t~ddlanguage dd07l~domvalue_l
         dd07l~domvalue_h dd07t~ddtext
         INTO TABLE xt_dd07
         FROM dd07l
         JOIN dd07t ON dd07t~domname = dd07l~domname
                   AND dd07t~as4local = dd07l~as4local
                   AND dd07t~valpos = dd07l~valpos
                   AND dd07t~ddlanguage = 'E'
         WHERE dd07l~domname = 'CMGST' OR dd07l~domname = 'FAREG'
           AND dd07l~as4local = 'A'.
  SORT xt_dd07.

** Material description
*  SELECT * FROM makt INTO TABLE it_makt
*           FOR ALL ENTRIES IN it_data
*           WHERE matnr EQ it_data-matnr
*             AND spras EQ sy-langu.
*  SORT it_makt BY matnr spras.
*  DELETE ADJACENT DUPLICATES FROM it_makt.

* Customer group
  SELECT kunnr kdgrp INTO TABLE it_kdgrp
         FROM knvv
         FOR ALL ENTRIES IN it_data
         WHERE kunnr = it_data-kunag
           AND vkorg = it_data-vkorg
           AND vtweg = it_data-vtweg
           AND spart = it_data-spart.
  SORT it_kdgrp.
  DELETE ADJACENT DUPLICATES FROM it_kdgrp.
  SELECT kdgrp spras ktext FROM t151t
         INTO TABLE xt_kdgrp
         FOR ALL ENTRIES IN it_kdgrp
         WHERE kdgrp = it_kdgrp-kdgrp
           AND (   spras = 'E'
                OR spras = sy-langu ).
  SORT xt_kdgrp.
  DELETE ADJACENT DUPLICATES FROM xt_kdgrp.

* Customer data
  REFRESH xt_adrc.
  SELECT kunnr adrnr name1 FROM kna1
         INTO TABLE it_adr
         FOR ALL ENTRIES IN it_data
         WHERE kunnr = it_data-hkunnr
            OR kunnr = it_data-echlcus.
  SORT it_adr.
  DELETE ADJACENT DUPLICATES FROM it_adr.
  IF NOT it_adr[] IS INITIAL.
*    SELECT * FROM adrc INTO TABLE xt_adrc                  "js-005
    SELECT * FROM adrc INTO TABLE xt_adrci                  "js-005
             FOR ALL ENTRIES IN it_adr
             WHERE addrnumber EQ it_adr-adrnr
               AND date_from  LE sy-datum.
  ENDIF.
* Customer data via order (partners)
  CLEAR: r_parvw.
  REFRESH: r_parvw.
  r_parvw-sign   = 'I'.
  r_parvw-option = 'EQ'.
  r_parvw-low    = c_parvw_ag.  APPEND r_parvw.
  r_parvw-low    = c_parvw_re.  APPEND r_parvw.
  r_parvw-low    = c_parvw_we.  APPEND r_parvw.
  r_parvw-low    = c_parvw_ze.  APPEND r_parvw.
  SELECT DISTINCT vbpa~vbeln vbpa~posnr vbpa~parvw vbpa~kunnr
                  vbpa~adrnr
         FROM vbpa
         INTO TABLE xt_vbpa2
         FOR ALL ENTRIES IN it_data
         WHERE vbeln EQ it_data-vbeln_ord
           AND parvw IN r_parvw.
*  SELECT * FROM adrc APPENDING TABLE xt_adrc               "js-005
  SELECT * FROM adrc APPENDING TABLE xt_adrci               "js-005
           FOR ALL ENTRIES IN xt_vbpa2
           WHERE addrnumber EQ xt_vbpa2-adrnr
             AND date_from  LE sy-datum.
* Keep only the latest
*  SORT xt_adrc BY addrnumber date_from DESCENDING.         "js-005
  SORT xt_adrci BY addrnumber date_from DESCENDING.         "js-005
  CLEAR xv_adrc_endcustomer.
*** js-005 * end ***
*  LOOP AT xt_adrc INTO xv_adrc_endcustomer.
*    lv_tabix = sy-tabix.
*    IF lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*      DELETE xt_adrc INDEX lv_tabix.
*    ENDIF.
*    lv_addrnumber = xv_adrc_endcustomer-addrnumber.
*  ENDLOOP.
  DELETE ADJACENT DUPLICATES FROM xt_adrci
         COMPARING addrnumber.
  xt_adrc[] = xt_adrci[].
*** js-005 * end ***

* Customer end data
  REFRESH: it_vbpa_cust,
           it_end_cust_district,
           it_end_cust_rep.
  it_vbpa_cust[] = xt_vbpa2[].
  DELETE it_vbpa_cust[] WHERE parvw NE 'ZE'.
  SORT it_vbpa_cust.
  IF NOT  it_vbpa_cust[] IS INITIAL.
*   End customer district
    SELECT kunnr vkorg vtweg spart bzirk FROM knvv
           INTO TABLE it_end_cust_district
           FOR ALL ENTRIES IN it_vbpa_cust
           WHERE kunnr = it_vbpa_cust-kunnr.
    SORT it_end_cust_district.
*   End customer representative
    SELECT kunnr vkorg vtweg spart pernr FROM knvp
           INTO TABLE it_end_cust_rep
           FOR ALL ENTRIES IN it_vbpa_cust
           WHERE kunnr = it_vbpa_cust-kunnr
             AND pernr NE '00000000'.
    SORT it_end_cust_rep.
  ENDIF.

* Vendor data
*  SELECT * FROM lfa1 INTO TABLE it_lfa1                    "js-005
  SELECT * FROM lfa1 INTO TABLE it_lfa1i                    "js-005
           FOR ALL ENTRIES IN it_data
           WHERE lifnr EQ it_data-lifnr.
* begin of delete lme004
*  SORT it_lfa1 BY lifnr.
* end of delete lme004
*** js-005 * begin ***
*  DELETE ADJACENT DUPLICATES FROM it_lfa1 COMPARING lifnr.
  SORT it_lfa1i BY lifnr.
  DELETE ADJACENT DUPLICATES FROM it_lfa1i
         COMPARING lifnr.
  it_lfa1[] = it_lfa1i[].
*** js-005 * end ***

*** js-003 * begin ***
* PO type / Reference
*** lme001 * begin ***
* CTP quotation number
* SELECT vbeln bsark ihrez FROM vbak
  SELECT vbeln bsark ihrez xblnr FROM vbak
*** lme001 * end ***
         INTO TABLE it_vbak_acc
         FOR ALL ENTRIES IN it_data
         WHERE vbeln = it_data-vbeln_ord.
  SORT it_vbak_acc BY vbeln.
  DELETE ADJACENT DUPLICATES FROM it_vbak_acc COMPARING vbeln.
*** js-003 * end ***

*** js-005 * begin ***
* Get sales rep. names
  SELECT pernr ename INTO TABLE lt_pa0001
         FROM pa0001
         FOR ALL ENTRIES IN it_data
         WHERE pernr = it_data-pernr_ve
           AND endda = '99991231'.
  SELECT pernr ename APPENDING TABLE lt_pa0001
         FROM pa0001
         FOR ALL ENTRIES IN it_data
         WHERE pernr = it_data-pernr_zx
           AND endda = '99991231'.
  SELECT pernr ename APPENDING TABLE lt_pa0001
         FROM pa0001
         FOR ALL ENTRIES IN it_data
         WHERE pernr = it_data-pernr_zy
           AND endda = '99991231'.

  SORT lt_pa0001.
  DELETE ADJACENT DUPLICATES FROM lt_pa0001
                             COMPARING pernr.
  it_pa0001[] = lt_pa0001[].
*** js-005 * end ***

ENDFORM.                    " GET_ADDITIONAL_DATA

*&---------------------------------------------------------------------*
*&      Form  GET_CUSTOMER                       "js-001
*&---------------------------------------------------------------------*
*       Get customer data
*----------------------------------------------------------------------*
*      -->P_KUNNR : customernumber
*      -->P_PARVW : partnerfunction
*----------------------------------------------------------------------*
FORM get_customer  USING    p_kunnr  TYPE kunnr
                            p_parvw  TYPE parvw.

  DATA: lv_vbpa2  LIKE LINE OF xt_vbpa2,
        lv_adrnr  TYPE adrnr.


  CLEAR: it_adr,
         xt_adrc.

  IF p_parvw IS INITIAL.
*   Customer data
    READ TABLE it_adr WITH KEY kunnr = p_kunnr
                      BINARY SEARCH.
    IF sy-subrc = 0.
      lv_adrnr = it_adr-adrnr.
    ENDIF.
  ELSE.
*   Customer data via order (partners)
    READ TABLE xt_vbpa2 INTO lv_vbpa2
                        WITH KEY vbeln = it_data-vbeln_ord
                                 posnr = it_data-posnr_ord
                                 parvw = p_parvw
                                 kunnr = p_kunnr.
    IF sy-subrc NE 0.
      READ TABLE xt_vbpa2 INTO lv_vbpa2
                          WITH KEY vbeln = it_data-vbeln_ord
                                   posnr = c_posnr_init
                                   parvw = p_parvw
                                   kunnr = p_kunnr.
    ENDIF.
    IF sy-subrc = 0.
      lv_adrnr = lv_vbpa2-adrnr.
    ENDIF.
  ENDIF.

* Address data
  IF NOT lv_adrnr IS INITIAL.
    READ TABLE xt_adrc
*         WITH KEY addrnumber = lv_adrnr                    "js-005
         WITH TABLE KEY addrnumber = lv_adrnr.              "js-005
*         BINARY SEARCH.                                    "js-005
  ENDIF.

ENDFORM.                    " GET_CUSTOMER

*&---------------------------------------------------------------------*
*&      Form  GET_SALES_REP_NAME                 "js-001
*&---------------------------------------------------------------------*
*       Get sales rep. (name)
*----------------------------------------------------------------------*
*      -->P_PERNR : sales rep. number
*      <--P_ENAME : name
*----------------------------------------------------------------------*
FORM get_sales_rep_name  USING    p_pernr
                         CHANGING p_ename.

* Begin of change gru001
*
*  CALL FUNCTION 'CATS_GET_EMPLOYEE_NAME'
*    EXPORTING
*      pernr           = p_pernr
**     date            = sy-datum
*    IMPORTING
*      name            = p_ename
*    EXCEPTIONS
*      pernr_not_found = 1
*      OTHERS          = 2.
*
*  IF sy-subrc <> 0.
*    CLEAR p_ename.
*  ENDIF.

*** js-005 * begin ***
*  SELECT SINGLE ename INTO p_ename FROM pa0001
*    WHERE pernr = p_pernr
*      AND endda = '99991231'.
*  IF sy-subrc <> 0.
*    CLEAR p_ename.
*  ENDIF.

  CLEAR it_pa0001.
  READ TABLE it_pa0001 WITH KEY pernr = p_pernr.
  p_ename = it_pa0001-ename.
*** js-005 * end ***

* End of change gru001

ENDFORM.                    " GET_SALES_REP_NAME

*&---------------------------------------------------------------------*
*&      Form  BUILD_TABLE_INV_ORDERS             "js-002
*&---------------------------------------------------------------------*
*       Build table with invoiced orders for BO reporting
*----------------------------------------------------------------------*
FORM build_table_inv_orders .

  DATA: lv_count(5)    TYPE n.


* Build table
  SORT it_sales_inv BY vbeln_ord posnr_ord
                       vbeln_del posnr_del
                       vbeln_inv posnr_inv.

  LOOP AT it_sales_inv INTO gv_sales_inv.
    MODIFY yse_sd_sales_inv FROM gv_sales_inv.

    lv_count = lv_count + 1.
    IF lv_count > 99.
      COMMIT WORK.
      CLEAR lv_count.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " BUILD_TABLE_INV_ORDERS

*&---------------------------------------------------------------------*
*&      Form  SELECT_INV_ORDERS_TABLE            "js-002
*&---------------------------------------------------------------------*
*       Select invoiced orders from table (for performance)
*       --> Table is used for BO reporting !
*----------------------------------------------------------------------*
FORM select_inv_orders_table .

  REFRESH it_data.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE it_data
           FROM yse_sd_sales_inv
           WHERE vbeln_ord IN s_vbeln
             AND posnr_ord IN s_posnr
             AND vkorg     IN s_vkorg
             AND vtweg     IN s_vtweg
             AND spart     IN s_sparth
             AND spartd    IN s_spartd
             AND vkbur     IN s_vkbur
             AND vkgrp     IN s_vkgrp
             AND prctr     IN s_prctr
             AND ww002     IN s_ww002
             AND ww006     IN s_ww006
             AND ww007     IN s_ww007
             AND cmgst     IN s_cmgst
             AND bzirk     IN s_bzirk
             AND vdatu     IN s_vdatu
             AND edatu     IN s_edatu
             AND ebeln     IN s_ebeln
             AND erdat_ord IN s_erdat1
             AND ernam     IN s_ernam
             AND auart     IN s_auart
             AND werks     IN s_werks
             AND matnr     IN s_matnr
             AND pstyv     IN s_pstyv
             AND mtpos     IN s_mtpos
             AND kunag     IN s_kunag
             AND kunwe     IN s_kunwe
             AND kunre     IN s_kunre
             AND hkunnr    IN s_hkunnr
             AND bran1     IN s_bran1
             AND faksk     IN s_faksk
             AND lifsk     IN s_lifsk
             AND erdat     IN s_erdat3
             AND pernr_ve  IN s_pernr
             AND pernr_zx  IN s_pernr
             AND pernr_zy  IN s_pernr
             AND fkart     IN s_fkart
             AND erdat_inv IN s_erdat2
             AND fkdat     IN s_fkdat
             AND faksp     IN s_faksp
             AND zuonr     IN s_zuonr
             AND abgru     IN s_abgru
             AND mstav     IN s_mstav
             AND mmsta     IN s_mmsta
             AND kzaus     IN s_kzaus.

  SORT it_data BY vbeln_ord posnr_ord
                  vbeln_del posnr_del
                  vbeln_inv posnr_inv.

* Only sales orders delivered ?
  IF NOT cb_sel IS INITIAL.
    DELETE it_data WHERE vbeln_del IS INITIAL.
  ENDIF.

* Fill fields (descriptions, names, ...)
  IF NOT it_data[] IS INITIAL.
    PERFORM fill_fields.
  ENDIF.

ENDFORM.                    " SELECT_INV_ORDERS_TABLE
******MOD-004 Being of insert
*&---------------------------------------------------------------------*
*&      Form  SEND_MAIL
*&---------------------------------------------------------------------*
*       Send mail
*----------------------------------------------------------------------*
FORM send_mail .
  DATA: send_request   TYPE REF TO cl_bcs,
          document       TYPE REF TO cl_document_bcs,
          recipient      TYPE REF TO if_recipient_bcs,
          bcs_exception  TYPE REF TO cx_bcs,
          ls_SOLI        TYPE SOLI,
          lv_string      TYPE string,
          main_text      TYPE bcsy_text,
          mailto         TYPE ad_smtpadr,
          size           TYPE so_obj_len,
          sent_to_all    TYPE os_boolean,
          lv_docnr       TYPE so_obj_des,
          lv_subject  TYPE so_obj_des,
          ls_batch_mail TYPE yse_batch_mail,
          it_documents TYPE TABLE OF acc_doc WITH HEADER LINE,
          lt_data TYPE solix_tab,
*       Internal table to hold the data from the FM CONVERT_OTF
          binary_content  TYPE solix_tab,
          w_bin_filesize TYPE i, " Binary File Size
          lt_pdf TYPE TABLE OF tline,
          ls_pdf TYPE tline,
          lv_kunnr_st TYPE vbpa-kunnr,
          lv_content  TYPE xstring.
  DATA: lt_compressed LIKE solisti1 OCCURS 10 WITH HEADER LINE,
        lt_decompressed LIKE solisti1 OCCURS 10 WITH HEADER LINE.

*  CONCATENATE sy-cprog '_' sy-datum '.csv' INTO lv_docnr.
  CONCATENATE sy-cprog '_' INTO lv_docnr.

  LOOP AT gt_attach_tab INTO ls_SOLI.
    CONCATENATE lv_string ls_SOLI-line INTO lv_string.
  ENDLOOP.

  TRY.
      cl_bcs_convert=>string_to_solix(
        EXPORTING
          iv_string   = lv_string
          iv_codepage = '4103'  "suitable for MS Excel, leave empty
          iv_add_bom  = 'X'     "for other doc types
        IMPORTING
          et_solix  = binary_content
          ev_size   = size ).
    CATCH cx_bcs.
      MESSAGE e445(so).
  ENDTRY.

  CALL FUNCTION 'TABLE_COMPRESS'
    TABLES
      in  = gt_attach_tab
      out = lt_compressed.

  CALL FUNCTION 'TABLE_DECOMPRESS'
    TABLES
      in  = lt_compressed
      out = lt_decompressed.

  TRY.
*     -------- create persistent send request ------------------------
      send_request = cl_bcs=>create_persistent( ).

*     -------- create and set document with attachment ---------------

*     create document object from internal table with text
      APPEND text-t71
        TO main_text.                                       "#EC NOTEXT
      APPEND INITIAL LINE TO  main_text.

      CONCATENATE 'Background Processing Spool'(t15) '-' sy-cprog
        INTO lv_subject SEPARATED BY space.
      document = cl_document_bcs=>create_document(
        i_type    = 'RAW'
        i_text    = main_text
        i_subject = lv_subject ).                           "#EC NOTEXT

*     add the spread sheet as attachment to document object
      document->add_attachment(
        i_attachment_type    = 'CSV'                        "#EC NOTEXT
        i_attachment_subject = lv_docnr                     "#EC NOTEXT
        i_attachment_size    = size
        i_att_content_hex =  binary_content[] ).
*        i_att_content_text   = lt_decompressed[] ).

*     add document object to send request
      send_request->set_document( document ).

*    --------- add recipient (e-mail address) -----------------------
      LOOP AT gt_batch_mail INTO ls_batch_mail.
        mailto  = ls_batch_mail-mail.
*    create recipient object
        recipient =
                cl_cam_address_bcs=>create_internet_address( mailto ).

*     add recipient object to send request
        send_request->add_recipient( recipient ).
        CLEAR: mailto.
      ENDLOOP.

*      TRY.
      CALL METHOD send_request->set_status_attributes
        EXPORTING
          i_requested_status = 'E'.

*     ---------- send document ---------------------------------------
      sent_to_all = send_request->send( i_with_error_screen = 'X' ).
*      COMMIT WORK.

      IF sent_to_all IS INITIAL.
        MESSAGE i500(sbcoms) WITH mailto.
      ELSE.
        MESSAGE s022(so).
        COMMIT  WORK.
      ENDIF.

*     ------------ exception handling ---------------------------------
*     replace this rudimentary exception handling with your own one !!
    CATCH cx_bcs INTO bcs_exception.
      MESSAGE i865(so) WITH bcs_exception->error_type.
  ENDTRY.
ENDFORM.                    " SEND_MAIL

*&---------------------------------------------------------------------*
*&      Form  GET_ALV_INFO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_alv_info .

  DATA:  ls_e_layout        TYPE slis_layout_alv,
         lt_e_fieldcat      TYPE slis_t_fieldcat_alv,
         lt_e_sort          TYPE slis_t_sortinfo_alv,
         lt_e_filter        TYPE slis_t_filter_alv,
         ls_e_list_scroll   TYPE slis_list_scroll,
         ls_e_grid_scroll   TYPE lvc_s_scrl,
         lt_e_marked        TYPE slis_t_fieldcat_alv,
         ls_e_variant       TYPE disvariant,
         lt_attach_tab      TYPE soli_tab,
         lt_file_out        TYPE STANDARD TABLE OF char480,
         lt_batch_mail      TYPE STANDARD TABLE OF yse_batch_mail.

  CALL FUNCTION 'REUSE_ALV_GRID_LAYOUT_INFO_GET'
      IMPORTING
        es_layout                 = ls_e_layout
        et_fieldcat               = lt_e_fieldcat[]
        et_sort                   = lt_e_sort[]
        et_filter                 = lt_e_filter[]
        es_grid_scroll            = ls_e_grid_scroll
        es_variant                = ls_e_variant
        et_marked_columns         = lt_e_marked
*       ET_FILTERED_ENTRIES       =
*       ET_FIELDCAT_BACKEND       =
*       ES_PRINT                  =
      EXCEPTIONS
        no_infos                  = 1
        program_error             = 2
        OTHERS                    = 3
              .
ENDFORM.                    " GET_ALV_INFO


******MOD-004 End of insert
*Text symbol text
*001:End Customer Report
*002:customer_report
*003:Error closing the File
*004:File Saved as:
*010:Standard Report
*011:Background Processing for End Customer Details
*012:Please enter custom Filename or leave blank for default
*015:Background Processing : create table with open orders (for performance)
*016:Background Processing : create table with invoiced orders (for BO reporting)
*101:Nr of lines:
*E01:Sales orders not invoiced
*E02:Sales orders invoiced
*E03:Billing type
*E04:Creation date invoice
*E05:Billing date
*E91:Please select sales order invoiced (for table creation)
*E92:Please enter Division (header level)
*E93:Please enter Distribution Channel
*E94:Please enter Sales Organization
*E95:Please select sales order not invoiced (for table creation)
*E96:Please enter a selection for Creation date SO line
*E97:Please enter a selection for Creation date invoice
*E98:Period Creation date invoice can not be > 3 months
*E99:Period Creation date SO line can not be > 3 months
*F05:Sales office description
*F07:Sales group description
*F14:SO: Conf.del.date
*F16:SO: creation date
*F26:Sold-To name
*F28:Ship-To name
*F29:Ship-To address
*F30:Bill-To party
*F31:Bill-To name
*F32:Higher level cust
*F33:Higher level cust. name
*F34:NAICS/SIC Code
*F35:SO: Delivery status
*F36:SO: Ord.rel.billing status
*F37:SO: Overall status (header)
*F38:SO: Overall status (item)
*F39:Sales order
*F45:Sales employee VE
*F48:Sales employee ZX
*F51:Sales employee ZY
*F52:Material list price
*F53:Mat.pr.curr.
*F54:Ord. item net value
*F56:Ord. item unit price
*F57:Unit pr. curr.
*F58:Order Cost
*F59:Cost curr.
*F60:Order Profit Value
*F61:Profit curr.
*F62:Order Profit %
*F66:Vendor name
*F69:Del. goods mov. status
*F72:Open del.qty
*F73:Open del.qty unit
*F74:Invoice
*F75:Ord. net value in CC
*F76:Ord. unit pr. CC
*F80:Inv.item net value
*F81:Invoice value in CC Currency
*F82:Inv.creation date
*F83:CC Currency
*F84:Open inv.qty
*F85:Quantity unit
*F86:Open inv. amount
*F87:Amount unit
*F88:Sold-To address
*F89:Dv (Item)
*F90:Ship-To region
*F91:Ship-To city
*F92:Ship-To ZIP code
*F93:Sold-To region
*F94:Sold-To city
*F95:Sold-To ZIP code
*F96:Billing plan line value
*F97:Billing plan line %
*F98:Order item
*F99:Deliv. item
*G01:Inv. item
*G02:Order on hand
*G03:Order on hand value
*G04:OH Cost
*G05:OH Profit Value
*G06:OH Profit %
*G07:Inv Cost
*G08:Inv Profit Value
*G09:Inv Profit %
*G10:GTS invoice
*G11:Sold-to Name 2
*G12:Ship-to Name 2
*G13:Bill-to Name 2
*G14:Ord. item net value CC
*G15:Order Profit Value CC
*G16:Comp.Curr.
*G17:SOLineCreaDate
*G18:Order On Hand Value CC
*G19:Sold-to Name 3
*G20:Sold-to Name 4
*G21:Ship-to Name 3
*G22:Ship-to Name 4
*G23:Bill-to Name 3
*G24:Bill-to Name 4
*G25:End cust. name 1
*G26:End cust. name 2
*G27:End cust. name 3
*G28:End cust. name 4
*S03:Select sales orders entered
*S04:Select sales orders invoiced
*S05:Only sales orders delivered
*S06:Select sales orders not invoiced
*S07:Variant to use ALV-output
*S08:Excl. DP lines of final invoice
*S09:Show linecount
*S10:Suppress Duplicated Order Lines
*S11:Check to view End Customer Information (Background Processing)
*S12:Clear DP invoice values
*T15:Background Processing Spool

*T71:Please find the attachment for the Spool Data, Thanks!
*Selection text
*CB_EDP:
*CB_LC:
*CB_SEL:
*CB_SPPRD:
*P_DAT_CC:        Date for curr. exchange
*P_KURST:D       .
*P_NO_DP:        Clear DP invoice values
*P_VAR:
*R1:
*R2:
*R3:
*R4:
*RB_SEL1:
*RB_SEL2:
*RB_SEL3:
*S_ABGRU:D       .
*S_AUART:        Sales order type
*S_BRAN1:        NAICS+
*S_BSARK:D       .
*S_BZIRK:D       .
*S_CMGST:        Overall Credit status of order
*S_EBELN:D       .
*S_EDATU:        Confirmed delivery date
*S_ERDAT1:        Order Creation Date
*S_ERDAT2:        Creation date invoice
*S_ERDAT3:        Creation date SO line
*S_ERNAM:D       .
*S_FAKSK:D       .
*S_FAKSP:        Billing Block on Billing Plan
*S_FKART:D       .
*S_FKDAT:D       .
*S_GBSTK:        Overall status (header)
*S_HKUNNR:D       .
*S_IHREZ:D       .
*S_KUNAG:D       .
*S_KUNRE:        Bill-to party
*S_KUNWE:        Ship-to Party
*S_KZAUS:D       .
*S_LIFSK:D       .
*S_MATNR:D       .
*S_MMSTA:D       .
*S_MSTAV:D       .
*S_MTPOS:D       .
*S_PERNR:        Sales representative
*S_POSNR:D       .
*S_PRCTR:D       .
*S_PSTYV:D       .
*S_SPARTD:        Division (item-level)
*S_SPARTH:        Division (header-level)
*S_VBELN:D       .
*S_VBTYP:        Sales document type
*S_VDATU:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
*S_VKORG:        Sales organization
*S_VTWEG:        Distribution Channel
*S_WERKS:D       .
*S_WW002:D       .
*S_WW006:D       .
*S_WW007:D       .
*S_XBLNR:        CTP quotation number
*S_ZFKREL:D       .
*S_ZUONR:        GTS Invoice reference
