*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_DOWNLOAD_NOTIFICATIONS                    *
* PROGRAM TITLE        : Download Notifications                        *
* AUTHOR               : Geert Rutten                                  *
* DATE                 : 03/10/2012                                    *
* DEVELOPMENT ID       :                                               *
*                                                                      *
* CHANGE REQUEST NUMBER:  CD1K973434                                   *
*                                                                      *
* Program Description:  Download of Measuring Docs for cutover         *
*                       Act! program                                   *
************************************************************************
*&---------------------------------------------------------------------*
*& Change Log                                                          *
*&---------------------------------------------------------------------*
*&MOD No.|Date        | TR number    | Changed By     | CR Number      *
*MOD-001 |12.05.2017  | CD1K991960   | ACTEXTAJSI     | PBCS-1245      *
*Description : Incorrect Equipment and Serial Number derivation.       *
*              Clear Issue and adding a double check on EQUNR and SERNR*
*&---------------------------------------------------------------------*
REPORT yam_download_notif MESSAGE-ID yam_inf.

************************************************************************
*                   T A B L E S                                        *
************************************************************************
TABLES: vbak,
        mpla,
        mpos,
        knvv.

************************************************************************
*                   T Y P E - P O O L S                                *
************************************************************************
TYPE-POOLS: ibco2.

************************************************************************
*                   C O N S T A N T S                                  *
************************************************************************
CONSTANTS: gc_stat_dl    TYPE j_status  VALUE 'I0076',
           c_rec_h(12)   TYPE c         VALUE 'Notif_header',
           c_rec_i(11)   TYPE c         VALUE 'Notif_items',
           c_rec_l1(20)  TYPE c         VALUE 'Notif_header_longtxt',
           c_rec_l2(18)  TYPE c         VALUE 'Notif_item_longtxt',
           gc_charx(1)   TYPE c         VALUE 'X',
           gc_vw(2)      TYPE c         VALUE 'VW'.

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************
DATA: BEGIN OF gt_equi OCCURS 0,
        equnr     LIKE equi-equnr,
        objnr     LIKE equi-objnr,
        eqktx     LIKE eqkt-eqktx,
      END OF gt_equi.

DATA: BEGIN OF gt_notif OCCURS 0,
       qmnum LIKE qmel-qmnum,
       objnr LIKE qmel-objnr,
      END OF gt_notif.

DATA: BEGIN OF gt_notif_d_c OCCURS 0,
        qmnum      LIKE dd03l-fieldname,
        deli1      TYPE c,
        fenum      LIKE dd03l-fieldname,
        deli2      TYPE c,
        otgrp      LIKE dd03l-fieldname,
        deli3      TYPE c,
        oteil      LIKE dd03l-fieldname,
        deli4      TYPE c,
        fegrp      LIKE dd03l-fieldname,
        deli5      TYPE c,
        fecod      LIKE dd03l-fieldname,
        deli6      TYPE c,
        fetxt      LIKE dd03l-fieldname,
        deli7      TYPE c,
        urgrp      LIKE dd03l-fieldname,
        deli8      TYPE c,
        urcod      LIKE dd03l-fieldname,
        deli9      TYPE c,
        urtxt      LIKE dd03l-fieldname,
      END OF gt_notif_d_c.

DATA: BEGIN OF gt_notif_d OCCURS 0,
        qmnum      LIKE qmfe-qmnum,
        deli1      TYPE c,
        fenum      LIKE qmfe-fenum,
        deli2      TYPE c,
        otgrp      LIKE qmfe-otgrp,
        deli3      TYPE c,
        oteil      LIKE qmfe-oteil,
        deli4      TYPE c,
        fegrp      LIKE qmfe-fegrp,
        deli5      TYPE c,
        fecod      LIKE qmfe-fecod,
        deli6      TYPE c,
        fetxt      LIKE qmfe-fetxt,
        deli7      TYPE c,
        urgrp      LIKE qmur-urgrp,
        deli8      TYPE c,
        urcod      LIKE qmur-urcod,
        deli9      TYPE c,
        urtxt      LIKE qmur-urtxt,
      END OF gt_notif_d.

DATA: BEGIN OF gt_notif_h_c OCCURS 0,
        qmnum      LIKE dd03l-fieldname,
        deli1      TYPE c,
        qmart      LIKE dd03l-fieldname,
        deli2      TYPE c,
        qmtxt      LIKE dd03l-fieldname,
        deli3      TYPE c,
        sttxt      LIKE dd03l-fieldname,
        deli4      TYPE c,
        sttxt2      LIKE dd03l-fieldname,
        deli5      TYPE c,
        aufnr      LIKE dd03l-fieldname,
        deli6      TYPE c,
        vbeln      LIKE dd03l-fieldname,
        deli7      TYPE c,
        tplnr      LIKE dd03l-fieldname,
        deli8      TYPE c,
        equnr      LIKE dd03l-fieldname,
        deli9      TYPE c,
        kunum      LIKE dd03l-fieldname,
        deli10      TYPE c,
        qmnam      LIKE dd03l-fieldname,
        deli11     TYPE c,
        bstnk      LIKE dd03l-fieldname,
        deli12     TYPE c,
        bstdk      LIKE dd03l-fieldname,
        deli13     TYPE c,
        qmdat      LIKE dd03l-fieldname,
        deli14     TYPE c,
        mzeit      LIKE dd03l-fieldname,
        deli15     TYPE c,
        kdauf      LIKE dd03l-fieldname,
        deli16     TYPE c,
        kdpos      LIKE dd03l-fieldname,
        deli17     TYPE c,
        priok      LIKE dd03l-fieldname,
        deli18     TYPE c,
        msaus      LIKE dd03l-fieldname,
        deli19     TYPE c,
        auszt      LIKE dd03l-fieldname,
        deli20     TYPE c,
        maueh     LIKE dd03l-fieldname,
        deli21     TYPE c,
        strmn      LIKE dd03l-fieldname,
        deli22     TYPE c,
        strur      LIKE dd03l-fieldname,
        deli23     TYPE c,
        ausvn      LIKE dd03l-fieldname,
        deli24     TYPE c,
        auztv      LIKE dd03l-fieldname,
        deli25     TYPE c,
        ltrmn      LIKE dd03l-fieldname,
        deli26     TYPE c,
        ltrur      LIKE dd03l-fieldname,
        deli27     TYPE c,
        ausbs      LIKE dd03l-fieldname,
        deli28     TYPE c,
        auztb      LIKE dd03l-fieldname,
        deli29     TYPE c,
        swerk      LIKE dd03l-fieldname,
        deli30     TYPE c,
        ingrp      LIKE dd03l-fieldname,
        deli31     TYPE c,
        iwerk      LIKE dd03l-fieldname,
        deli32     TYPE c,
        i_parnr    LIKE dd03l-fieldname,
        deli33     TYPE c,
        vkorg      LIKE dd03l-fieldname,
        deli34     TYPE c,
        vtweg      LIKE dd03l-fieldname,
        deli35     TYPE c,
        spart      LIKE dd03l-fieldname,
        deli36     TYPE c,
        vkbur      LIKE dd03l-fieldname,
        deli37     TYPE c,
        vkgrp      LIKE dd03l-fieldname,
        deli38     TYPE c,
        qmgrp      LIKE dd03l-fieldname,
        deli39     TYPE c,
        qmcod      LIKE dd03l-fieldname,
        deli40     TYPE c,
        bukrs      LIKE dd03l-fieldname,
        deli41     TYPE c,
        warpl      LIKE dd03l-fieldname,
        deli42     TYPE c,
        abnum      LIKE dd03l-fieldname,
        deli43     TYPE c,
        wapos      LIKE dd03l-fieldname,
        deli44     TYPE c,
        plnty      LIKE dd03l-fieldname,
        deli45     TYPE c,
        plnnr      LIKE dd03l-fieldname,
        deli46     TYPE c,
        plnal      LIKE dd03l-fieldname,
        deli47     TYPE c,
        plantext   LIKE dd03l-fieldname,
        deli48     TYPE c,
        stort      LIKE dd03l-fieldname,
        deli49     TYPE c,
        msgrp      LIKE dd03l-fieldname,
        deli50     TYPE c,
        abckz      LIKE dd03l-fieldname,
        deli51     TYPE c,
        eqfnr      LIKE dd03l-fieldname,
        deli52     TYPE c,
        inspk      LIKE dd03l-fieldname,
        deli53     TYPE c,
        datan      LIKE dd03l-fieldname,
        deli54     TYPE c,
        kostl      LIKE dd03l-fieldname,
        deli55     TYPE c,
        arbpl2     LIKE dd03l-fieldname,
        deli56     TYPE c,
        matnr      LIKE dd03l-fieldname,
        deli57     TYPE c,
        sernr      LIKE dd03l-fieldname,
        deli58  TYPE  c,
        bismt  TYPE  dd03l-fieldname,
      END OF gt_notif_h_c.

DATA: BEGIN OF gt_notif_h OCCURS 0,
        qmnum      LIKE qmel-qmnum,
        deli1      TYPE c,
        qmart      LIKE qmel-qmart,
        deli2      TYPE c,
        qmtxt      LIKE qmel-qmtxt,
        deli3      TYPE c,
        sttxt      LIKE qmel-qmtxt,
        deli4      TYPE c,
        sttxt2     LIKE dd03l-fieldname,
        deli5      TYPE c,
        aufnr      LIKE qmel-aufnr,
        deli6      TYPE c,
        vbeln      LIKE qmel-vbeln,
        deli7      TYPE c,
        tplnr      LIKE viqmel-tplnr,
        deli8      TYPE c,
        equnr      LIKE viqmel-equnr,
        deli9      TYPE c,
        kunum      LIKE qmel-kunum,
        deli10      TYPE c,
        qmnam      LIKE qmel-qmnam,
        deli11     TYPE c,
        bstnk      LIKE qmel-bstnk,
        deli12     TYPE c,
        bstdk      LIKE qmel-bstdk,
        deli13     TYPE c,
        qmdat      LIKE qmel-qmdat,
        deli14     TYPE c,
        mzeit      LIKE qmel-mzeit,
        deli15     TYPE c,
        kdauf      LIKE dd03l-fieldname,
        deli16     TYPE c,
        kdpos      LIKE dd03l-fieldname,
        deli17     TYPE c,
        priok      LIKE qmel-priok,
        deli18     TYPE c,
        msaus      LIKE viqmel-msaus,
        deli19     TYPE c,
        auszt(16)  TYPE c,
        deli20     TYPE c,
        maueh      LIKE viqmel-maueh,
        deli21     TYPE c,
        strmn      LIKE qmel-strmn,
        deli22     TYPE c,
        strur      LIKE qmel-strur,
        deli23     TYPE c,
        ausvn      LIKE qmih-ausvn,
        deli24     TYPE c,
        auztv      LIKE qmih-auztv,
        deli25     TYPE c,
        ltrmn      LIKE qmel-ltrmn,
        deli26     TYPE c,
        ltrur      LIKE qmel-ltrur,
        deli27     TYPE c,
        ausbs      LIKE qmih-ausbs,
        deli28     TYPE c,
        auztb      LIKE qmih-auztb,
        deli29     TYPE c,
        swerk      LIKE viqmel-swerk,
        deli30     TYPE c,
        ingrp      LIKE qmih-ingrp,
        deli31     TYPE c,
        iwerk      LIKE qmih-iwerk,
        deli32     TYPE c,
        i_parnr    LIKE dd03l-fieldname,
        deli33     TYPE c,
        vkorg      LIKE qmel-vkorg,
        deli34     TYPE c,
        vtweg      LIKE qmel-vtweg,
        deli35     TYPE c,
        spart      LIKE qmel-spart,
        deli36     TYPE c,
        vkbur      LIKE qmel-vkbur,
        deli37     TYPE c,
        vkgrp      LIKE qmel-vkgrp,
        deli38     TYPE c,
        qmgrp      LIKE qmel-qmgrp,
        deli39     TYPE c,
        qmcod      LIKE qmel-qmcod,
        deli40     TYPE c,
        bukrs      LIKE iloa-bukrs,
        deli41     TYPE c,
        warpl      LIKE qmih-warpl,
        deli42     TYPE c,
        abnum(10)  TYPE c,
        deli43     TYPE c,
        wapos      LIKE qmih-wapos,
        deli44     TYPE c,
        plnty      LIKE qmih-plnty,
        deli45     TYPE c,
        plnnr      LIKE qmih-plnnr,
        deli46     TYPE c,
        plnal      LIKE qmih-plnal,
        deli47     TYPE c,
        plantext   LIKE mpos-pstxt,
        deli48     TYPE c,
        stort      LIKE viqmel-stort,
        deli49     TYPE c,
        msgrp      LIKE viqmel-msgrp,
        deli50     TYPE c,
        abckz      LIKE viqmel-abckz,
        deli51     TYPE c,
        eqfnr      LIKE viqmel-eqfnr,
        deli52     TYPE c,
        inspk      LIKE viqmel-inspk,
        deli53     TYPE c,
        datan      LIKE viqmel-datan,
        deli54     TYPE c,
        kostl      LIKE viqmel-kostl,
        deli55     TYPE c,
*        arbpl      LIKE viqmel-arbpl,
        arbpl2     LIKE crhd-arbpl,
        deli56     TYPE c,
        matnr      LIKE equi-matnr,
        deli57     TYPE c,
        sernr      LIKE equi-sernr,
        deli58     TYPE c,
        bismt      TYPE mara-bismt,
     END OF gt_notif_h.

DATA: BEGIN OF gt_notif_h2 OCCURS 0,
        qmnum      LIKE qmel-qmnum,
        deli1      TYPE c,
        qmart      LIKE qmel-qmart,
        deli2      TYPE c,
        qmtxt      LIKE qmel-qmtxt,
        deli3      TYPE c,
        sttxt      LIKE dd03l-fieldname,
        deli4      TYPE c,
        sttxt2      LIKE dd03l-fieldname,
        deli5      TYPE c,
        aufnr      LIKE qmel-aufnr,
        deli6      TYPE c,
        vbeln      LIKE qmel-vbeln,
        deli7      TYPE c,
        tplnr      LIKE viqmel-tplnr,
        deli8      TYPE c,
        equnr      LIKE viqmel-equnr,
        deli9      TYPE c,
        kunum      LIKE qmel-kunum,
        deli10     TYPE c,
        qmnam      LIKE qmel-qmnam,
        deli11     TYPE c,
        bstnk      LIKE qmel-bstnk,
        deli12     TYPE c,
        bstdk      LIKE qmel-bstdk,
        deli13     TYPE c,
        qmdat      LIKE qmel-qmdat,
        deli14     TYPE c,
        mzeit      LIKE qmel-mzeit,
        deli15     TYPE c,
        kdauf      LIKE dd03l-fieldname,
        deli16     TYPE c,
        kdpos      LIKE dd03l-fieldname,
        deli17     TYPE c,
        priok      LIKE qmel-priok,
        deli18     TYPE c,
        msaus      LIKE viqmel-msaus,
        deli19     TYPE c,
        auszt     LIKE  viqmel-auszt,
        deli20     TYPE c,
        maueh      LIKE viqmel-maueh,
        deli21     TYPE c,
        strmn      LIKE qmel-strmn,
        deli22     TYPE c,
        strur      LIKE qmel-strur,
        deli23     TYPE c,
        ausvn      LIKE qmih-ausvn,
        deli24     TYPE c,
        auztv      LIKE qmih-auztv,
        deli25     TYPE c,
        ltrmn      LIKE qmel-ltrmn,
        deli26     TYPE c,
        ltrur      LIKE qmel-ltrur,
        deli27     TYPE c,
        ausbs      LIKE qmih-ausbs,
        deli28     TYPE c,
        auztb      LIKE qmih-auztb,
        deli29     TYPE c,
        swerk      LIKE viqmel-swerk,
        deli30     TYPE c,
        ingrp      LIKE qmih-ingrp,
        deli31     TYPE c,
        iwerk      LIKE qmih-iwerk,
        deli32     TYPE c,
        i_parnr    LIKE dd03l-fieldname,
        deli33     TYPE c,
        vkorg      LIKE qmel-vkorg,
        deli34     TYPE c,
        vtweg      LIKE qmel-vtweg,
        deli35     TYPE c,
        spart      LIKE qmel-spart,
        deli36     TYPE c,
        vkbur      LIKE qmel-vkbur,
        deli37     TYPE c,
        vkgrp      LIKE qmel-vkgrp,
        deli38     TYPE c,
        qmgrp      LIKE qmel-qmgrp,
        deli39     TYPE c,
        qmcod      LIKE qmel-qmcod,
        deli40     TYPE c,
        bukrs      LIKE iloa-bukrs,
        deli41     TYPE c,
        warpl      LIKE qmih-warpl,
        deli42     TYPE c,
        abnum      TYPE qmih-abnum,
        deli43     TYPE c,
        wapos      LIKE qmih-wapos,
        deli44     TYPE c,
        plnty      LIKE qmih-plnty,
        deli45     TYPE c,
        plnnr      LIKE qmih-plnnr,
        deli46     TYPE c,
        plnal      LIKE qmih-plnal,
        deli47     TYPE c,
        plantext   LIKE mpos-pstxt,
        deli48     TYPE c,
        stort      LIKE viqmel-stort,
        deli49     TYPE c,
        msgrp      LIKE viqmel-msgrp,
        deli50     TYPE c,
        abckz      LIKE viqmel-abckz,
        deli51     TYPE c,
        eqfnr      LIKE viqmel-eqfnr,
        deli52     TYPE c,
        inspk      LIKE viqmel-inspk,
        deli53     TYPE c,
        datan      LIKE viqmel-datan,
        deli54     TYPE c,
        kostl      LIKE viqmel-kostl,
        deli55     TYPE c,
*        arbpl      LIKE viqmel-arbpl,
        arbpl2     LIKE crhd-arbpl,
        deli56     TYPE c,
        matnr      LIKE equi-matnr,
        deli57     TYPE c,
        sernr      LIKE equi-sernr,
        deli58     TYPE c,
        bismt      LIKE mara-bismt,
     END OF gt_notif_h2.

DATA: BEGIN OF gt_notif_l1_c OCCURS 0,
        qmnum       LIKE dd03l-fieldname,
        deli1       TYPE c,
        objtype     TYPE dd03l-fieldname,
        deli2       TYPE c,
        objkey      TYPE dd03l-fieldname,
        deli3       TYPE c,
        line_number TYPE dd03l-fieldname,
        deli4       TYPE c,
        format_col  TYPE dd03l-fieldname,
        deli5       TYPE c,
        longtext    TYPE dd03l-fieldname,
      END OF gt_notif_l1_c.

DATA: BEGIN OF gt_notif_l1 OCCURS 0,
        qmnum       LIKE qmel-qmnum,
        deli1       TYPE c,
        objtype     TYPE swo_objtyp,
        deli2       TYPE c,
        objkey      TYPE qobjkey,
        deli3       TYPE c,
        line_number TYPE tdlineno,
        deli4       TYPE c,
        format_col  TYPE tdformat,
        deli5       TYPE c,
        longtext(132)  TYPE c,
      END OF gt_notif_l1.

DATA: BEGIN OF gt_notif_l2_c OCCURS 0,
        qmnum       LIKE dd03l-fieldname,
        deli1       TYPE c,
        objtype     TYPE dd03l-fieldname,
        deli2       TYPE c,
        objkey      TYPE dd03l-fieldname,
        deli3       TYPE c,
        line_number TYPE dd03l-fieldname,
        deli4       TYPE c,
        format_col  TYPE dd03l-fieldname,
        deli5       TYPE c,
        longtext    TYPE dd03l-fieldname,
      END OF gt_notif_l2_c.

DATA: BEGIN OF gt_notif_l2 OCCURS 0,
        qmnum       LIKE qmel-qmnum,
        deli1       TYPE c,
        objtype     TYPE swo_objtyp,
        deli2       TYPE c,
        objkey      TYPE qobjkey,
        deli3       TYPE c,
        line_number TYPE tdlineno,
        deli4       TYPE c,
        format_col  TYPE tdformat,
        deli5       TYPE c,
        longtext(132)  TYPE c,
      END OF gt_notif_l2.

DATA: lv_atinn  TYPE atinn,
      lv_mpobj  LIKE imptt-mpobj,
      lv1_point LIKE imptt-point,
      lv_index  TYPE sy-tabix.

*------------------------------------------------------------------
* Variables
DATA: lt_viqmfe TYPE TABLE OF wqmfe,
      ls_viqmfe TYPE wqmfe,
      lt_viqmur TYPE TABLE OF wqmur,
      ls_viqmur TYPE wqmur,
      es_viqmel TYPE viqmel,
      lt_longtxt TYPE TABLE OF alm_me_longtext,
      ls_longtxt TYPE alm_me_longtext,
      lt_longtxt_item TYPE TABLE OF alm_me_longtext.

DATA  gv_werks TYPE werks.

DATA: BEGIN OF h_status_tab OCCURS 30.
        INCLUDE STRUCTURE jstat.
DATA: END OF h_status_tab.

DATA: g_directory(25) TYPE c VALUE '/var/load/xxx/UK/read/',
      g_ofile         LIKE /sapdmc/lsoinp-filename,
      p_logsys        LIKE tbdlst-logsys.

FIELD-SYMBOLS: <gs_value>  TYPE ibco2_value_rec.

TABLES: qmel.

DATA:  lv_kdauf TYPE kdauf,
       lv_kdpos TYPE kdpos,
       lv_plnnr TYPE mpos-plnnr,
       lv_plnal TYPE mpos-plnal,
       lv_plnty TYPE mpos-plnty,
       lv_pstxt TYPE mpos-pstxt.
DATA:  lv_sttxt TYPE co_sttxt.

DATA : lv_equnr TYPE qmih-equnr. "MOD-001 Data Declaration.

************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************
SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
PARAMETERS:     p_iwerk  LIKE mpos-iwerk MEMORY ID wrk.
SELECT-OPTIONS: s_qmnum  FOR  qmel-qmnum.
SELECT-OPTIONS: s_qmart  FOR  qmel-qmart.
SELECT-OPTIONS: s_vtweg  FOR  knvv-vtweg.
SELECT-OPTIONS: s_strmn  FOR  qmel-strmn.
PARAMETERS:     p_bukrs  TYPE aufk-bukrs OBLIGATORY MEMORY ID buk,
                p_vkorg  TYPE knvv-vkorg MEMORY ID vko.
PARAMETERS:     h_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Notif_Header'.
PARAMETERS:     i_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Notif_Items'.
PARAMETERS:     l1_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Notif_header_longtext'.
PARAMETERS:     l2_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Notif_item_longtext'.
SELECTION-SCREEN: END OF BLOCK b1.

* Comment
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c01.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c02.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c03.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b2.

*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_iwerk.

  IF p_iwerk IS NOT INITIAL.
* Check planning plant
    SELECT SINGLE werks
         INTO gv_werks
         FROM t001w
         WHERE werks = p_iwerk.

    IF sy-subrc <> 0.
*.. Planning plant does not exist
      MESSAGE e001(00) WITH text-e02.
    ENDIF.

    AUTHORITY-CHECK OBJECT 'I_IWERK'
             ID 'TCD'   FIELD sy-tcode
             ID 'IWERK' FIELD p_iwerk.

    IF sy-subrc NE 0.
*.. No authorization for plant: &1
      MESSAGE e001(00) WITH text-e03 p_iwerk.
    ENDIF.
  ENDIF.


*- Initialization -----------------------------------------------------*
INITIALIZATION.

  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = p_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.


************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.

* Select all notifications
*  SELECT qmnum objnr
*    INTO CORRESPONDING FIELDS OF TABLE gt_notif
*    FROM viqmel
*    WHERE qmnum IN s_qmnum
*      AND qmart IN s_qmart
*      AND iwerk EQ p_iwerk
*      AND vtweg IN s_vtweg.
  DATA: lv_where TYPE string.
  lv_where = 'qmnum IN s_qmnum AND qmart IN s_qmart AND bukrs EQ p_bukrs'.
  IF p_iwerk IS NOT INITIAL.
    CONCATENATE lv_where 'AND iwerk EQ p_iwerk' INTO lv_where SEPARATED BY space.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_where 'AND vkorg EQ p_vkorg' INTO lv_where SEPARATED BY space.
  ENDIF.
  CONCATENATE lv_where 'AND vtweg IN s_vtweg' INTO lv_where SEPARATED BY space.
  CONCATENATE lv_where 'AND strmn IN s_strmn' INTO lv_where SEPARATED BY space.
  SELECT qmnum objnr
    INTO CORRESPONDING FIELDS OF TABLE gt_notif
     FROM viqmel
     WHERE (lv_where).

  LOOP AT gt_notif.

    lv_index = sy-tabix.
*.. Check if related notification is already completed (NOCO)
*.. then skip
    CALL FUNCTION 'STATUS_CHECK'
      EXPORTING
*       BYPASS_BUFFER           = ' '
*       CLIENT                  = SY-MANDT
        objnr                   = gt_notif-objnr
        status                  = 'I0072'
      EXCEPTIONS
        object_not_found        = 1
        status_not_active       = 2
        OTHERS                  = 3.

    IF sy-subrc EQ 0.
      DELETE gt_notif INDEX lv_index.
      CONTINUE.
    ENDIF.

*.. Check if related notification has a deletion flag (DLFL)
*.. then skip
    CALL FUNCTION 'STATUS_CHECK'
      EXPORTING
*       BYPASS_BUFFER           = ' '
*       CLIENT                  = SY-MANDT
        objnr                   = gt_notif-objnr
        status                  = 'I0076'
      EXCEPTIONS
        object_not_found        = 1
        status_not_active       = 2
        OTHERS                  = 3.

    IF sy-subrc EQ 0.
      DELETE gt_notif INDEX lv_index.
    ENDIF.

  ENDLOOP.

  PERFORM get_data.

  IF NOT gt_notif_h2[] IS INITIAL.
    PERFORM download_files.
  ENDIF.

*&---------------------------------------------------------------------*
*&      Form  get_details
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_data.

  DATA: ls_ctam TYPE yam_ctam_ccodes.
  DATA: ls_vbap TYPE vbap,
        ls_vbak TYPE vbak.
* MOD-001 Data Declaration
  DATA : lv_sernr TYPE equi-sernr,
         lv_matnr TYPE equi-matnr.

  LOOP AT gt_notif.
*    Begin of MOD-001
*    Adding clear statement to all the import,export and tables parameters
*    of FM as the records were getting appended on next call
*    End of MOD-001.
    CLEAR :es_viqmel,lt_viqmfe,lt_viqmur.

    CALL FUNCTION 'IQS4_GET_NOTIFICATION'
      EXPORTING
        i_qmnum     = gt_notif-qmnum
      IMPORTING
        e_viqmel    = es_viqmel
      TABLES
        e_iviqmfe_t = lt_viqmfe
        e_iviqmur_t = lt_viqmur.

*   Notification Header
    CLEAR gt_notif_h.
    MOVE-CORRESPONDING es_viqmel TO gt_notif_h2.

*   Work center
    SELECT SINGLE arbpl FROM crhd
      INTO gt_notif_h2-arbpl2
      WHERE objty EQ 'A'
        AND objid EQ es_viqmel-arbpl.

    CLEAR: lv_kdauf, lv_kdpos,lv_equnr. "MOD-001 Adding Clear statement
    SELECT SINGLE kdauf kdpos equnr   "MOD-001 Fetching EQUNR from QMIH
      FROM qmih INTO (lv_kdauf, lv_kdpos,lv_equnr)
      WHERE qmnum = es_viqmel-qmnum.
    IF  sy-subrc = 0.
      gt_notif_h2-kdauf = lv_kdauf.
      gt_notif_h2-kdpos = lv_kdpos.
*      Begin of MOD-001
*      Adding a double check if the equipment found from the FM
*      and from QMIH is different we override the details of equipment found from QMIH
*      EQUNR,SERNR,MATNR are overriden.
      IF lv_equnr NE gt_notif_h2-equnr.
        CLEAR : lv_sernr,lv_matnr.
        SELECT SINGLE equnr sernr matnr FROM equi INTO (lv_equnr ,lv_sernr,lv_matnr)
          WHERE equnr = lv_equnr.
        IF sy-subrc EQ 0.
          gt_notif_h2-equnr = lv_equnr.
          gt_notif_h2-sernr = lv_sernr.
          gt_notif_h2-matnr = lv_matnr.
        ENDIF.
      ENDIF.
*      End of MOD-001.
    ENDIF.

    CLEAR: lv_plnty, lv_plnnr, lv_plnal, lv_pstxt.
    SELECT SINGLE plnty plnnr plnal pstxt FROM mpos INTO (lv_plnty, lv_plnnr,
       lv_plnal, lv_pstxt)
      WHERE qmnum = es_viqmel-qmnum.
    IF sy-subrc = 0.
      gt_notif_h2-plnty = lv_plnty.
      gt_notif_h2-plnnr = lv_plnnr.
      gt_notif_h2-plnal = lv_plnal.
      gt_notif_h2-plantext = lv_pstxt.
    ENDIF.
    CLEAR h_status_tab[].

    CALL FUNCTION 'STATUS_READ'
      EXPORTING
        objnr            = gt_notif-objnr
        only_active      = 'X'
      TABLES
        status           = h_status_tab
      EXCEPTIONS
        object_not_found = 01.

    LOOP AT h_status_tab.
      CONCATENATE gt_notif_h2-sttxt h_status_tab-stat  INTO gt_notif_h2-sttxt SEPARATED BY ' '.
    ENDLOOP.

    CLEAR lv_sttxt.
    CALL FUNCTION 'STATUS_TEXT_EDIT'
            EXPORTING
                 objnr           = gt_notif-objnr
                 spras           = sy-langu
*                flg_user_stat   = 'X'
                 only_active     = 'X'
            IMPORTING
                 line            =  lv_sttxt.

    gt_notif_h2-sttxt2 = lv_sttxt.

    SELECT SINGLE parnr
    INTO gt_notif_h2-i_parnr
    FROM ihpa
    WHERE objnr = gt_notif-objnr
      AND parvw = gc_vw
      AND kzloesch <> gc_charx.

    SELECT SINGLE matnr sernr FROM equi
      INTO (gt_notif_h2-matnr,gt_notif_h2-sernr)
      WHERE equnr EQ gt_notif_h2-equnr.
    SHIFT gt_notif_h2-matnr LEFT DELETING LEADING '0'.

    "Check if it's a contract
    SELECT SINGLE * FROM vbak
      INTO ls_vbak
      WHERE vbeln EQ gt_notif_h2-kdauf
        AND vbtyp EQ 'G'.
    IF sy-subrc NE 0.
      SELECT SINGLE * FROM yam_ctam_ccodes
        INTO ls_ctam
        WHERE bukrs EQ gt_notif_h2-bukrs.
      IF sy-subrc NE 0.
        "SEED code clearing KDAUF & KDPOS
        SELECT SINGLE vbeln posnr vgbel vgpos
          FROM vbap
          INTO CORRESPONDING FIELDS OF ls_vbap
          WHERE vbeln EQ gt_notif_h2-kdauf
            AND posnr EQ gt_notif_h2-kdpos.
        IF sy-subrc EQ 0.
          SELECT SINGLE * FROM vbak
            INTO ls_vbak
            WHERE vbeln EQ ls_vbap-vgbel
              AND vbtyp EQ 'G'.
          IF sy-subrc NE 0.
            CLEAR: gt_notif_h2-kdauf, gt_notif_h2-kdpos.
          ELSE.
            gt_notif_h2-kdauf = ls_vbap-vgbel.
            gt_notif_h2-kdpos = ls_vbap-vgpos.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    MOVE '|' TO: gt_notif_h2-deli1, gt_notif_h2-deli2, gt_notif_h2-deli3,
                 gt_notif_h2-deli4, gt_notif_h2-deli5, gt_notif_h2-deli6,
                 gt_notif_h2-deli7, gt_notif_h2-deli8, gt_notif_h2-deli9,
                 gt_notif_h2-deli10, gt_notif_h2-deli11, gt_notif_h2-deli12,
                 gt_notif_h2-deli13, gt_notif_h2-deli14, gt_notif_h2-deli15,
                 gt_notif_h2-deli16, gt_notif_h2-deli17, gt_notif_h2-deli18,
                 gt_notif_h2-deli19, gt_notif_h2-deli20, gt_notif_h2-deli21,
                 gt_notif_h2-deli22, gt_notif_h2-deli23, gt_notif_h2-deli24,
                 gt_notif_h2-deli23, gt_notif_h2-deli24, gt_notif_h2-deli25,
                 gt_notif_h2-deli26, gt_notif_h2-deli27, gt_notif_h2-deli28,
                 gt_notif_h2-deli29, gt_notif_h2-deli30, gt_notif_h2-deli31,
                 gt_notif_h2-deli32, gt_notif_h2-deli33, gt_notif_h2-deli34,
                 gt_notif_h2-deli35, gt_notif_h2-deli36, gt_notif_h2-deli37,
                 gt_notif_h2-deli38, gt_notif_h2-deli39, gt_notif_h2-deli40,
                 gt_notif_h2-deli41, gt_notif_h2-deli42, gt_notif_h2-deli43,
                 gt_notif_h2-deli44, gt_notif_h2-deli45, gt_notif_h2-deli46,
                 gt_notif_h2-deli47, gt_notif_h2-deli48, gt_notif_h2-deli49,
                 gt_notif_h2-deli50, gt_notif_h2-deli51, gt_notif_h2-deli52,
                 gt_notif_h2-deli53, gt_notif_h2-deli54, gt_notif_h2-deli55,
                 gt_notif_h2-deli56, gt_notif_h2-deli57,
                 gt_notif_h2-deli58.
    APPEND gt_notif_h2.

*   Notification Items
    CLEAR gt_notif_d.
    LOOP AT lt_viqmfe INTO ls_viqmfe WHERE kzloesch <> 'X'.
      MOVE-CORRESPONDING ls_viqmfe TO gt_notif_d.
      READ TABLE lt_viqmur WITH KEY fenum = ls_viqmfe-fenum INTO ls_viqmur.
      IF sy-subrc = 0.
        MOVE-CORRESPONDING ls_viqmur TO gt_notif_d.
      ENDIF.
      MOVE '|' TO: gt_notif_d-deli1, gt_notif_d-deli2, gt_notif_d-deli3,
                   gt_notif_d-deli4, gt_notif_d-deli5, gt_notif_d-deli6,
                   gt_notif_d-deli7, gt_notif_d-deli8, gt_notif_d-deli9.

      APPEND gt_notif_d.
    ENDLOOP.

*   Notification Header longtext and Item longtext
    CLEAR lt_longtxt[].
    CALL FUNCTION 'ALM_ME_NOTIFICATION_GETDETAIL'
      EXPORTING
        notif_no              = gt_notif-qmnum
      TABLES
        notification_longtext = lt_longtxt.

    LOOP AT lt_longtxt INTO ls_longtxt.
      IF ls_longtxt-objtype = 'QMEL'.
        IF ls_longtxt-text_line(1) = '*' OR ls_longtxt-text_line(1) = '=' OR ls_longtxt-text_line(1) = 'C' OR ls_longtxt-text_line(1) = '/'.
          ls_longtxt-text_line = ls_longtxt-text_line+2(130).
        ENDIF.
        gt_notif_l1-qmnum = gt_notif-qmnum.
        MOVE '|' TO: gt_notif_l1-deli1, gt_notif_l1-deli2, gt_notif_l1-deli3 ,gt_notif_l1-deli4, gt_notif_l1-deli5.
        MOVE-CORRESPONDING ls_longtxt TO gt_notif_l1.
        MOVE ls_longtxt-text_line TO gt_notif_l1-longtext.
        APPEND gt_notif_l1.
      ELSEIF ( ls_longtxt-objtype = 'QMUR' ) OR ( ls_longtxt-objtype = 'QMFE' ).
        IF ls_longtxt-text_line(1) = '*' OR ls_longtxt-text_line(1) = '='.
          ls_longtxt-text_line = ls_longtxt-text_line+2(130).
        ENDIF.
        gt_notif_l2-qmnum = gt_notif-qmnum.
        MOVE '|' TO: gt_notif_l2-deli1, gt_notif_l2-deli2, gt_notif_l2-deli3 ,gt_notif_l2-deli4, gt_notif_l2-deli5.
        MOVE-CORRESPONDING ls_longtxt TO gt_notif_l2.
        MOVE ls_longtxt-text_line TO gt_notif_l2-longtext.
        APPEND gt_notif_l2.
      ENDIF.

    ENDLOOP.

  ENDLOOP.

ENDFORM.                    "get_data

*&---------------------------------------------------------------------*
*&      Form  download_files
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_files.

  DATA: file TYPE string.
  DATA: lv_selections TYPE string.

  lv_selections = p_bukrs.
  IF p_iwerk IS NOT INITIAL.
    CONCATENATE lv_selections p_iwerk INTO lv_selections SEPARATED BY '_'.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_selections p_vkorg INTO lv_selections SEPARATED BY '_'.
  ENDIF.


  LOOP AT gt_notif_h2.

    MOVE-CORRESPONDING gt_notif_h2 TO gt_notif_h.
    gt_notif_h-abnum =  gt_notif_h2-abnum.
    gt_notif_h-auszt =  gt_notif_h2-auszt.

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = gt_notif_h2-matnr
      IMPORTING
        output = gt_notif_h2-matnr.

    SELECT SINGLE bismt FROM mara INTO gt_notif_h-bismt
      WHERE matnr = gt_notif_h2-matnr.

    APPEND gt_notif_h.
  ENDLOOP.

  PERFORM header_fill.

  IF sy-batch = 'X'.
    REPLACE 'xxx' IN g_directory WITH p_logsys(3).

*   Notification Header
*    CONCATENATE g_directory c_rec_h '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_h '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_notif_h_c.
      TRANSFER gt_notif_h_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_notif_h.
      TRANSFER gt_notif_h TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Notification Items
*    CONCATENATE g_directory c_rec_i '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_i '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_notif_d_c.
      TRANSFER gt_notif_d_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_notif_d.
      TRANSFER gt_notif_d TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Notification header longtext
*    CONCATENATE g_directory c_rec_l1 '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_l1 '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_notif_l1_c.
      TRANSFER gt_notif_l1_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_notif_l1.
      TRANSFER gt_notif_l1 TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Notification item longtext
*    CONCATENATE g_directory c_rec_l2 '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_l2 '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_notif_l2_c.
      TRANSFER gt_notif_l2_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_notif_l2.
      TRANSFER gt_notif_l2 TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

  ELSE.
    file = h_filet.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_h_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_h
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = i_filet.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_d_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_d
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = l1_filet.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_l1_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_l1
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = l2_filet.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_l2_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_notif_l2
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

  ENDIF.

ENDFORM.                    "download_file

*&---------------------------------------------------------------------*
*&      Form  header_fill
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM header_fill.

  MOVE '|' TO: gt_notif_h_c-deli1, gt_notif_h_c-deli2, gt_notif_h_c-deli3,
               gt_notif_h_c-deli4, gt_notif_h_c-deli5, gt_notif_h_c-deli6,
               gt_notif_h_c-deli7, gt_notif_h_c-deli8, gt_notif_h_c-deli9,
               gt_notif_h_c-deli10, gt_notif_h_c-deli11, gt_notif_h_c-deli12,
               gt_notif_h_c-deli13, gt_notif_h_c-deli14, gt_notif_h_c-deli15,
               gt_notif_h_c-deli16, gt_notif_h_c-deli17, gt_notif_h_c-deli18,
               gt_notif_h_c-deli19, gt_notif_h_c-deli20, gt_notif_h_c-deli21,
               gt_notif_h_c-deli22, gt_notif_h_c-deli23, gt_notif_h_c-deli24,
               gt_notif_h_c-deli23, gt_notif_h_c-deli24, gt_notif_h_c-deli25,
               gt_notif_h_c-deli26, gt_notif_h_c-deli27, gt_notif_h_c-deli28,
               gt_notif_h_c-deli29, gt_notif_h_c-deli30, gt_notif_h_c-deli31,
               gt_notif_h_c-deli32, gt_notif_h_c-deli33, gt_notif_h_c-deli34,
               gt_notif_h_c-deli35, gt_notif_h_c-deli36, gt_notif_h_c-deli37,
               gt_notif_h_c-deli38, gt_notif_h_c-deli39, gt_notif_h_c-deli40,
               gt_notif_h_c-deli41, gt_notif_h_c-deli42, gt_notif_h_c-deli43,
               gt_notif_h_c-deli44, gt_notif_h_c-deli45, gt_notif_h_c-deli46,
               gt_notif_h_c-deli47, gt_notif_h_c-deli48, gt_notif_h_c-deli49,
               gt_notif_h_c-deli50, gt_notif_h_c-deli51, gt_notif_h_c-deli52,
               gt_notif_h_c-deli53, gt_notif_h_c-deli54, gt_notif_h_c-deli55,
               gt_notif_h_c-deli56, gt_notif_h_c-deli57,
               gt_notif_h_c-deli58.

  gt_notif_h_c-qmnum = 'QMNUM'.
  gt_notif_h_c-qmart = 'QMART'.
  gt_notif_h_c-qmtxt = 'QMTXT'.
  gt_notif_h_c-sttxt = 'STTXT'.
  gt_notif_h_c-sttxt2 = 'STTXT2'.
  gt_notif_h_c-aufnr = 'AUFNR'.
  gt_notif_h_c-vbeln = 'VBELN'.
  gt_notif_h_c-tplnr = 'TPLNR'.
  gt_notif_h_c-equnr = 'EQUNR'.
  gt_notif_h_c-kunum = 'KUNUM'.
  gt_notif_h_c-qmnam = 'QMNAM'.
  gt_notif_h_c-bstnk = 'BSTNK'.
  gt_notif_h_c-bstdk = 'BSTDK'.
  gt_notif_h_c-qmdat = 'QMDAT'.
  gt_notif_h_c-mzeit = 'MZEIT'.
  gt_notif_h_c-kdauf = 'KDAUF'.
  gt_notif_h_c-kdpos = 'KDPOS'.
  gt_notif_h_c-priok = 'PRIOK'.
  gt_notif_h_c-msaus = 'MSAUS'.
  gt_notif_h_c-auszt = 'AUSZT'.
  gt_notif_h_c-maueh = 'MAUEH'.
  gt_notif_h_c-strmn = 'STRMN'.
  gt_notif_h_c-strur = 'STRUR'.
  gt_notif_h_c-ausvn = 'AUSVN'.
  gt_notif_h_c-auztv = 'AUZTV'.
  gt_notif_h_c-ltrmn = 'LTRMN'.
  gt_notif_h_c-ltrur = 'LTRUR'.
  gt_notif_h_c-ausbs = 'AUSBS'.
  gt_notif_h_c-auztb = 'AUZTB'.
  gt_notif_h_c-swerk = 'SWERK'.
  gt_notif_h_c-ingrp = 'INGRP'.
  gt_notif_h_c-iwerk = 'IWERK'.
  gt_notif_h_c-i_parnr = 'I_PARNR'.
  gt_notif_h_c-vkorg  = 'VKORG'.
  gt_notif_h_c-vtweg = 'VTWEG'.
  gt_notif_h_c-spart = 'SPART'.
  gt_notif_h_c-vkbur = 'VKBUR'.
  gt_notif_h_c-vkgrp = 'VKGRP'.
  gt_notif_h_c-qmgrp = 'QMGRP'.
  gt_notif_h_c-qmcod = 'QMCOD'.
  gt_notif_h_c-bukrs = 'BUKRS'.
  gt_notif_h_c-warpl = 'WARPL'.
  gt_notif_h_c-abnum = 'ABNUM'.
  gt_notif_h_c-wapos = 'WAPOS'.
  gt_notif_h_c-plnty = 'PLNTY'.
  gt_notif_h_c-plnnr = 'PLNNR'.
  gt_notif_h_c-plnal = 'PLNAL'.
  gt_notif_h_c-plantext = 'PLANTEXT'.
  gt_notif_h_c-stort = 'STORT'.
  gt_notif_h_c-msgrp = 'MSGRP'.
  gt_notif_h_c-abckz = 'ABCKZ'.
  gt_notif_h_c-eqfnr = 'EQFNR'.
  gt_notif_h_c-inspk = 'INSPK'.
  gt_notif_h_c-datan = 'DATAN'.
  gt_notif_h_c-kostl = 'KOSTL'.
  gt_notif_h_c-arbpl2 = 'ARBPL'.
  gt_notif_h_c-matnr = 'MATNR'.
  gt_notif_h_c-sernr = 'SERNR'.
  gt_notif_h_c-bismt = 'BISMT'.
  APPEND gt_notif_h_c.

  gt_notif_h_c-qmnum = 'Notification'.
  gt_notif_h_c-qmart = 'Type'.
  gt_notif_h_c-qmtxt = 'Short Text'.
  gt_notif_h_c-sttxt = 'User Status'.
  gt_notif_h_c-sttxt2 = 'System Status'.
  gt_notif_h_c-aufnr = 'Serv.Order'.
  gt_notif_h_c-vbeln = 'Sales Order'.
  gt_notif_h_c-tplnr = 'Funct. Location'.
  gt_notif_h_c-equnr = 'Equipment'.
  gt_notif_h_c-kunum = 'Customer'.
  gt_notif_h_c-qmnam = 'Rep. Person'.
  gt_notif_h_c-bstnk = 'Cust. PO No.'.
  gt_notif_h_c-bstdk = 'PO Date'.
  gt_notif_h_c-qmdat = 'Notif. Date'.
  gt_notif_h_c-mzeit = 'Time'.
  gt_notif_h_c-kdauf = 'Sales Order'.
  gt_notif_h_c-kdpos = 'SO Item'.
  gt_notif_h_c-priok = 'Priority'.
  gt_notif_h_c-msaus = 'Breakdown'.
  gt_notif_h_c-auszt = 'Breakd. Duration'.
  gt_notif_h_c-maueh = 'UoM'.
  gt_notif_h_c-strmn = 'Req. Start D'.
  gt_notif_h_c-strur = 'Time'.
  gt_notif_h_c-ausvn = 'Malfunct. Start'.
  gt_notif_h_c-auztv = 'Time'.
  gt_notif_h_c-ltrmn = 'Req. End Date'.
  gt_notif_h_c-ltrur = 'Time'.
  gt_notif_h_c-ausbs = 'Malfunct. End'.
  gt_notif_h_c-auztb = 'Time'.
  gt_notif_h_c-swerk = 'Maint. Plant'.
  gt_notif_h_c-ingrp = 'Planner Grp'.
  gt_notif_h_c-iwerk = 'Plann. Plant'.
  gt_notif_h_c-i_parnr = 'Respons.'.
  gt_notif_h_c-vkorg  = 'Sales Org.'.
  gt_notif_h_c-vtweg = 'Distr.Ch.'.
  gt_notif_h_c-spart = 'Div.'.
  gt_notif_h_c-vkbur = 'Sales Off.'.
  gt_notif_h_c-vkgrp = 'Sales Grp'.
  gt_notif_h_c-qmgrp = 'Group-cod.'.
  gt_notif_h_c-qmcod = 'Coding'.
  gt_notif_h_c-bukrs = 'Comp.'.
  gt_notif_h_c-warpl = 'Maint. Plan'.
  gt_notif_h_c-abnum = 'MP Call No.'.
  gt_notif_h_c-wapos = 'Maint. Item'.
  gt_notif_h_c-plnty = 'TL Type'.
  gt_notif_h_c-plnnr = 'Task List'.
  gt_notif_h_c-plnal = 'Counter'.
  gt_notif_h_c-plantext = 'Short Text'.
  gt_notif_h_c-stort = 'Location'.
  gt_notif_h_c-msgrp = 'Room'.
  gt_notif_h_c-abckz = 'ABC'.
  gt_notif_h_c-eqfnr = 'Sort Field'.
  gt_notif_h_c-inspk = 'Techn. Inspect.'.
  gt_notif_h_c-datan = 'Date TI'.
  gt_notif_h_c-kostl = 'Cost Ctr'.
  gt_notif_h_c-arbpl2 = 'Work Ctr'.
  gt_notif_h_c-matnr = 'Material Nr'.
  gt_notif_h_c-sernr = 'Serial nr'.
  gt_notif_h_c-bismt  = 'Old Material Number'.
  APPEND gt_notif_h_c.

  MOVE '|' TO: gt_notif_d_c-deli1, gt_notif_d_c-deli2, gt_notif_d_c-deli3,
               gt_notif_d_c-deli4, gt_notif_d_c-deli5, gt_notif_d_c-deli6,
               gt_notif_d_c-deli7, gt_notif_d_c-deli8, gt_notif_d_c-deli9.

  gt_notif_d_c-qmnum = 'QMNUM'.
  gt_notif_d_c-fenum = 'FENUM'.
  gt_notif_d_c-otgrp = 'OTGRP'.
  gt_notif_d_c-oteil = 'OTEIL'.
  gt_notif_d_c-fegrp = 'FEGRP'.
  gt_notif_d_c-fecod = 'FECOD'.
  gt_notif_d_c-fetxt = 'FETXT'.
  gt_notif_d_c-urgrp = 'URGRP'.
  gt_notif_d_c-urcod = 'URCOD'.
  gt_notif_d_c-urtxt = 'URTXT'.
  APPEND gt_notif_d_c.

  gt_notif_d_c-qmnum = 'Notification'.
  gt_notif_d_c-fenum = 'Item'.
  gt_notif_d_c-otgrp = 'Obj. Parts Grp'.
  gt_notif_d_c-oteil = 'Obj. Part'.
  gt_notif_d_c-fegrp = 'Problem Grp'.
  gt_notif_d_c-fecod = 'Problem'.
  gt_notif_d_c-fetxt = 'Problem Text'.
  gt_notif_d_c-urgrp = 'Causes Grp'.
  gt_notif_d_c-urcod = 'Cause'.
  gt_notif_d_c-urtxt = 'Cause Text'.
  APPEND gt_notif_d_c.

  MOVE '|' TO: gt_notif_l1_c-deli1, gt_notif_l1_c-deli2, gt_notif_l1_c-deli3, gt_notif_l1_c-deli4, gt_notif_l1_c-deli5.

  gt_notif_l1_c-qmnum = 'QMNUM'.
  gt_notif_l1_c-objtype = 'OBJTYP'.
  gt_notif_l1_c-objkey = 'OBJKEY'.
  gt_notif_l1_c-line_number = 'LINE_NUMBER'.
  gt_notif_l1_c-format_col = 'FORMAT_COL'.
  gt_notif_l1_c-longtext = 'LONGTEXT'.
  APPEND gt_notif_l1_c.

  gt_notif_l1_c-qmnum = 'Notification'.
  gt_notif_l1_c-objtype = 'Obj. Type'.
  gt_notif_l1_c-objkey = 'Obj. Key'.
  gt_notif_l1_c-line_number = 'Line No.'.
  gt_notif_l1_c-format_col = 'Format'.
  gt_notif_l1_c-longtext = 'Text Line'.
  APPEND gt_notif_l1_c.

  MOVE '|' TO: gt_notif_l2_c-deli1, gt_notif_l2_c-deli2, gt_notif_l2_c-deli3, gt_notif_l2_c-deli4, gt_notif_l2_c-deli5.

  gt_notif_l2_c-qmnum = 'QMNUM'.
  gt_notif_l2_c-objtype = 'OBJTYP'.
  gt_notif_l2_c-objkey = 'OBJKEY'.
  gt_notif_l2_c-line_number = 'LINE_NUMBER'.
  gt_notif_l2_c-format_col = 'FORMAT_COL'.
  gt_notif_l2_c-longtext = 'LONGTEXT'.
  APPEND gt_notif_l2_c.

  gt_notif_l2_c-qmnum = 'Notification'.
  gt_notif_l2_c-objtype = 'Obj. Type'.
  gt_notif_l2_c-objkey = 'Obj. Key'.
  gt_notif_l2_c-line_number = 'Line No.'.
  gt_notif_l2_c-format_col = 'Format'.
  gt_notif_l2_c-longtext = 'Text Line'.
  APPEND gt_notif_l2_c.

ENDFORM.                    "header_fill

*Text symbol text
*001:Selection Screen Input
*002:Remarks
*C01:* If started in background, files are stored on the application server
*C02:* /var/load/xxx/UK/read/
*C03:* xxx = logical system
*E02:Planning plant does not exist
*E03:No authorization for plant :
*E04:Open dataset failed for :
*E05:Close dataset failed for :
*I01:No maintenance plans selected !
*I02:No variant table for Central Task Lists found (CU60)

*I03:Could not find caracteristic :
*Selection text
*H_FILET:        Filename Notification Header
*I_FILET:        Filename Notification Item
*L1_FILET:        Filename Notif.Longtext Heade
*L2_FILET:        Filename Cust.Longtext
*P_BUKRS:D       .
*P_IWERK:        Plant
*P_VKORG:D       .
*S_QMART:        Notification Type
*S_QMNUM:        Notification Number
*S_STRMN:        Required Start Date
*S_VTWEG:D       .
