*----------------------------------------------------------------------
* PROGRAM ID           : YAM_D016_SERVICE_CONTRACT                     *
* PROGRAM TITLE        : DATA UPLOAD PROGRAM FOR EQUIPMENT TO SERVICE  *
*                        CONTRACTS                                     *
* AUTHOR               : MIRA SAIKRISHNA                               *
* DATE                 : 03/09/2004                                    *
* DEVELOPMENT ID       : DDD:D016 UK                                   *
* CHANGE REQUEST NUMBER: CD1K900544                                    *
* PROGRAM DESCRIPTION  : THIS IS A DATA CONVERSION PROGRAM TO UPLOAD   *
*                        SERVICE CONTRACTS FOR THE CUT-OVER.           *
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG
*
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE #
*
* MOD-001 |2004.12.17|Marc Jacobs | CD1K901026 | Group transactions
*
* MOD-002 |2004.12.21|Marc Jacobs | CD1K901237 | Link equipment to
*                     correct material on contract
*
*----------------------------------------------------------------------*
************************************************************************

REPORT yam_d016_equip_contract NO STANDARD PAGE HEADING
       LINE-SIZE 270
       MESSAGE-ID yam_dc.


*---------------------------------------------------------------------*
* TABLE DECLARATION
*---------------------------------------------------------------------*

TABLES: rlgrap,               " PROGRAM FIELDS/SCREEN FIELDS FOR
                              " SAPLGRAP
        vbak,                 " SALES DOCUMENT: HEADER DATA
        vbap,                 " SALES DOCUMENT: ITEM DATA
        vbkd,                 " SALES DOCUMENT: BUSINESS DATA
        fpla,                 " BILLING PLAN
        veda,                 " CONTRACT DATA
        ypcccc_datab,         " SERVICE CONTRACT STRUCTURE TRANSACTION
                              " DATA FOR DIRECT INPUT
        apqi,                 " QUEUE INFO DEFINITION
        /sapdmc/lsmemory.     " DEFAULT VALUES FOR PROJECT, SUBPROJECT,
" OBJECT

*---------------------------------------------------------------------*
* TYPE DEFINITIONS
*---------------------------------------------------------------------*
* - DECLARATION FOR STRUCTURE TO READ THE FLAT FILE STRING PER STRING
TYPES: BEGIN OF ty_upload,
         v_text(500)   TYPE c,            " FILE UPLOAD TEXT
       END OF ty_upload.

* - DECLARATION FOR THE CORRESPONDING TARGET FIELDS
TYPES : BEGIN OF ty_final_record,
            reclink_c(020),             " IDENTIFIER
            vkgrp      TYPE vkgrp,      " SALES GROUP
            vkbur      TYPE vkbur,      " SALES OFFICE
            cccntp     TYPE auart,      " SALES DOCUMENT TYPE
            cccust     TYPE kunnr,      " SOLD-TO PARTY
            ccoref     TYPE bstkd,      " CUSTOMER PURCHASE ORDER
            ccsdat     TYPE vbdat_veda, " CONTRACT START DATE
            ccedat     TYPE vndat_veda, " CONTRACT END DATE
            ccscon     TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
            ccdurnd    TYPE vadat_veda, " AGREEMENT ACCEPTANCE DATE
            ccsdat1    TYPE vudat_veda, " DATE ON WHICH CONTRACT IS
                                        " SIGNED
            ccperiocat TYPE vlauk_veda, " VALIDITY PERIOD CATEGORY OF
                                        " CONTRACT
            ccdurn     TYPE vlauf_veda, " VALIDITY PERIOD OF CONTRACT
            ccniwk     TYPE bedat,      " START DATE OF BILL
            ccedatc    TYPE endat,      " END DATE
            ccifrq     TYPE zchar_1,    " RULE TO DETERMINE NEXT
                                        " BILLING
            cccsts     TYPE  autte,     " BILLING/INVOICE CREATION IN
                                        " ADVANCE
            mssprd     TYPE matnr,      " MATERIAL NUMBER
            msppyr     TYPE zchar15,    " AMOUNT
            msmsno     TYPE sernr,      " SERIAL NUMBER
            msmpno     TYPE matnr,      " MATERIAL NUMBER
            equnr      TYPE equnr,      " EQUIPMENT NUMBER
            text       TYPE tdline,     " TEXT DETAIL
        END OF ty_final_record.


* - DECLARATION FOR THE HEADER DATA
TYPES : BEGIN OF ty_header,
            reclink_c(020),             " IDENTIFIER
            vkgrp      TYPE vkgrp,      " SALES GROUP
            vkbur      TYPE vkbur,      " SALES OFFICE
            cccntp     TYPE auart,      " SALES DOCUMENT TYPE
            cccust     TYPE kunnr,      " SOLD-TO PARTY
            ccoref     TYPE bstkd,      " CUSTOMER PURCHASE ORDER
            ccsdat     TYPE vbdat_veda, " CONTRACT START DATE
            ccedat     TYPE vndat_veda, " CONTRACT END DATE
            ccscon     TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
            ccdurnd    TYPE vadat_veda, " AGREEMENT ACCEPTANCE DATE
            ccsdat1    TYPE vudat_veda, " DATE ON WHICH CONTRACT IS
                                        " SIGNED
            ccperiocat TYPE vlauk_veda, " VALIDITY PERIOD CATEGORY OF
                                        " CONTRACT
            ccdurn     TYPE vlauf_veda, " VALIDITY PERIOD OF CONTRACT
            ccniwk     TYPE bedat,      " START DATE OF BILL
            ccedatc    TYPE endat,      " END DATE
            ccifrq     TYPE zchar_1,    " 3 CHARACTER FIELD
            cccsts     TYPE autte,      " BILLING/INVOICE CREATION IN
                                        " ADVANCE
            text       TYPE tdline,     " TEXT DETAIL
            no         TYPE i,          " NO OF LOOP PASSES
        END OF ty_header.


* - DECLARATION FOR THE ITEM DATA
TYPES : BEGIN OF ty_detail,
            reclink_c(020),             " IDENTIFIER
            mssprd     TYPE matnr,      " MATERIAL NUMBER
            msppyr     TYPE zchar15,    " AMOUNT
            msmsno     TYPE gernr,      " SERIAL NUMBER
            msmpno     TYPE matnr,      " MATERIAL NUMBER
            equnr      TYPE equnr,      " EQUIPMENT NUMBER
            text       TYPE tdline,     " TEXT DETAIL
        END OF ty_detail.


* - DECLARATION FOR THE SALES DOCUMENT
TYPES : BEGIN OF ty_sales,
            vbeln      TYPE vbeln_va,   " SALES DOCUMENT NUMBER
            vsnmr_v    TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
        END OF ty_sales.


*---------------------------------------------------------------------*
* WORK AREA DECLARATIONS                                              *
*---------------------------------------------------------------------*
DATA : wa_sales           TYPE  ty_sales.  " WORK AREA FOR SALES DOC
DATA : wa_contractheader  TYPE  bapisdhd1. " WORK AREA CONTRACT HEADER
DATA : wa_contractheaderx TYPE  bapisdhd1x." WORK AREA CONTRACT FILL
DATA : wa_contractheaderc TYPE  bapisdh1.  " WORK AREA CHANGE CONTRACT
DATA : wa_contractheaderu TYPE  bapisdh1x. " WORK AREA CONTRACT UPDATE
DATA : wa_contractitems   TYPE  bapisditm. " WORK AREA CONTRACT ITEMS
DATA : wa_contractitemsx  TYPE  bapisditmx." WORK AREA ITEMS FILL
DATA : wa_contractitemsu  TYPE  bapisditmx." WORK AREA ITEMS UPDATE
DATA : wa_contract        TYPE  bapictr.   " WORK AREA CONTRACT DATES
DATA : wa_contractx       TYPE  bapictrx.  " WORK AREA DATES FILL
DATA : wa_contractu       TYPE  bapictrx.  " WORK AREA DATES UPDATE
DATA : wa_partner         TYPE  bapiparnr. " WORK AREA PARTNER
DATA : wa_condition       TYPE  bapicond.  " WORK ARE CONDITION
DATA : wa_bapiret2        TYPE  bapiret2.  " WORK AREA CREATE RETURN
DATA : wa_bapiret         TYPE  bapiret2.  " WORK AREA CHANGE RETURN
DATA : wa_contracttext    TYPE  bapisdtext." WORK AREA CONTRACT TEXT
DATA : wa_conditionx      TYPE  bapicondx. " WORK AREA CONDITION FILL
DATA : wa_conditionu      TYPE  bapicondx. " WORK AREA CONDITION UPDATE

*---------------------------------------------------------------------*
* INTERNAL TABLE DECLARATIONS                                         *
*---------------------------------------------------------------------*
* - INTERNAL TABLE FOR THE FILE OF LEGACY DATA UPLOAD FOR CONTRACTS
DATA : i_upload TYPE STANDARD TABLE OF ty_upload
                       INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE LEGACY DATA
DATA : i_final_record TYPE STANDARD TABLE OF ty_final_record
                       INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE HEADER DATA
DATA : i_header TYPE STANDARD TABLE OF ty_header
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE DETAIL DATA
DATA : i_detail TYPE STANDARD TABLE OF ty_detail
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CONTRACT HEADER DATA
DATA : i_contractheader TYPE STANDARD TABLE OF bapisdhd1
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CONTRACT HEADER UPDATE
DATA : i_contractheaderx TYPE STANDARD TABLE OF bapisdhd1x
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CHANGE CONTRACT HEADER
DATA : i_contractheaderc TYPE STANDARD TABLE OF bapisdh1
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CHANGE CONTRACT HEADER
* - UPDATE DATA
DATA : i_contractheaderu TYPE STANDARD TABLE OF bapisdh1x
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT ITEM DATA
DATA : i_contract_items TYPE STANDARD TABLE OF bapisditm
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT ITEM UPDATE
* - DATA
DATA : i_contract_itemsx TYPE STANDARD TABLE OF bapisditmx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CHANGE CONTRACT ITEM
* - UPDATE DATA
DATA : i_contract_itemsu TYPE STANDARD TABLE OF bapisditmx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT DATES
DATA : i_contract TYPE STANDARD TABLE OF bapictr
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT DATES UPDATE
DATA : i_contractx TYPE STANDARD TABLE OF bapictrx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CHANGE CONTRACT DATES
* - UPDATE
DATA : i_contractu TYPE STANDARD TABLE OF bapictrx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE PARTNER DETAILS
DATA : i_partner TYPE STANDARD TABLE OF bapiparnr
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONDITION RECORD
DATA : i_condition TYPE STANDARD TABLE OF bapicond
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONDITION RECORD
* - UPDATE
DATA : i_conditionx TYPE STANDARD TABLE OF bapicondx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CHANGE
* - CONDITION RECORD UPDATE
DATA : i_conditionu TYPE STANDARD TABLE OF bapicondx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTUE OF THE RETURN DATA
DATA : i_bapiret2 TYPE STANDARD TABLE OF bapiret2
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTUE OF THE RETURN DATA
DATA : i_bapiret TYPE STANDARD TABLE OF bapiret2
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE TEXT DETAILS.
DATA : i_contract_text TYPE STANDARD TABLE OF bapisdtext
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE FOR THE SALES DOCUMNET NUMBER
DATA : i_vbak TYPE STANDARD TABLE OF vbak
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE FOR THE SALES DOCUMNET NUMBER
DATA : i_salesdoc_in TYPE STANDARD TABLE OF ty_sales
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE FOR PARTNER CHANGES
DATA : i_partnerc TYPE STANDARD TABLE OF bapiparnrc
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE MANIPULATING THE HEADER AND DETAIL AND PASSING TO
* - BAPI.
DATA : i_contract_items1 LIKE i_contract_items
                            OCCURS 0 WITH HEADER LINE.

* - INTERNAL TABLE MANIPULATING DETAIL FOR EQUIPMENT.
DATA : i_detail_equip LIKE i_detail
                            OCCURS 0 WITH HEADER LINE.


*-ADDED BY MIRA_RECENT TO IDENTIFY TEXTS FOR EACH CONTRACT.
DATA: BEGIN OF i_contract_text_all OCCURS 0,
           reclink_c(020).    " IDENTIFIER
        INCLUDE STRUCTURE bapisdtext.
DATA: END OF i_contract_text_all.

*-WORK AREA FOR TEXTS FOR EACH CONTRACT.
DATA: BEGIN OF wa_contract_text,
           reclink_c(020).    " IDENTIFIER
        INCLUDE STRUCTURE bapisdtext.
DATA: END OF wa_contract_text.

DATA: BEGIN OF wa_contract_header_inu.
        INCLUDE STRUCTURE bapisdhd1x.
DATA: END   OF wa_contract_header_inu.

DATA : i_contractupdate LIKE wa_contract_header_inu
                               OCCURS 0 WITH HEADER LINE.

************************************************************************
*    INTERNAL TABLE FOR BDC AND CONTRACT DETAILS
*
************************************************************************
DATA : i_bdcdata LIKE bdcdata OCCURS 0 WITH HEADER LINE,
       struct_bdcdata TYPE bdcdata,
       i_bdcmsgcoll  TYPE TABLE OF bdcmsgcoll.

DATA : BEGIN OF i_contractvbeln OCCURS 0,
         vbeln   LIKE vbak-vbeln,
         vsnmr_v LIKE vbak-vsnmr_v,
       END OF i_contractvbeln.

DATA : BEGIN OF i_contractitem OCCURS 0,
         vbeln   LIKE vbap-vbeln,
         posnr   LIKE vbap-posnr,
         matnr   LIKE vbap-matnr,
       END OF i_contractitem.



*---------------------------------------------------------------------*
* VARIABLE DECLARATIONS                                               *
*---------------------------------------------------------------------*
DATA :  g_counter TYPE sy-tabix,                " FOR STORING LINE ITEM
                                                " INCREMENTS
        g_count   TYPE sy-tabix,                " COUNT
        g_vbeln   TYPE vbeln_va,                " SALES DOCUMENT NUMBER
        p_infile  LIKE /sapdmc/lsoinp-filename, " FILE
        g_vsnmr_v LIKE vbak-vsnmr_v,            " SALES DOCUMENT
                                                " VERSION
        g_lin     TYPE i,                       " TOTAL LINES
                                                " CONTRACT INTERNAL
        g_lin1    TYPE i,                       " Total lines for equip

* Begin of changes :- Mira_equipment

        v_indx(2) TYPE n,
        v_indx_equip(2) type n,
        v_mod LIKE sy-tabix.
* End of changes:- Mira_equipment

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS                                               *
*---------------------------------------------------------------------*
CONSTANTS : c_rb_pre         TYPE c VALUE  ' ',      " SPACE
            c_filetype(10)   TYPE c VALUE 'ASC',     " FILE TYPE
            c_x              TYPE c VALUE 'X',       " CHECKED
            c_vkorg(4)       TYPE c VALUE 'GBAA',    " SALES
                                                     " ORGANIZATION
            c_vtweg(2)       TYPE c VALUE '11',      " SALES DIVISION
            c_spart(2)       TYPE c VALUE '01',      " SALES
                                                     " DISTRIBUTION
            c_partn1(2)      TYPE c VALUE 'AG',      " SOLD-TO PARTY
            c_partn2(2)      TYPE c VALUE 'WE',      " SHIP-TO PARTY
            c_cnd(4)         TYPE c VALUE 'ZPN0',    " DEFAULT
                                                     " CONDITION
                                                     " TYPE
            c_can(4)         TYPE c VALUE '0001',    " DEFAULT VALUE
                                                     " FOR
                                                     " CANCELLATION
            c_year(1)        TYPE c VALUE '4',       " DEFUALT UNIT VAL
                                                     " PERIOD
            c_curr(3)        TYPE c VALUE 'GBP',     " DEFAULT CURRENCY
            c_qnt(1)         TYPE c VALUE '1',       " DEFAULT VALUE
                                                     " FOR
                                                     " TARGET QTY
            c_ffprf(8)       TYPE c VALUE 'ZAM00001'," DYNAMIC ITEM
                                                     " PROCESSOR
            c_vakt(4)        TYPE c VALUE '0001',    " ACTION RULE
            c_rule(2)        TYPE c VALUE '3M',      " DATE RULE
            c_spras(2)       TYPE c VALUE 'EN',      " LANGUAGE
            c_tdid(4)        TYPE c VALUE '0002',    " TEXT ID
            c_tobj(4)        TYPE c VALUE 'VBBP',    " TEXT OBJECT
            c_tpar(2)        TYPE c VALUE ' ',       " TAG COLUMN
            c_itm(6)         TYPE c VALUE '000010',  " FIRST ITEM COUNT
            c_u(1)           TYPE c VALUE 'U',       " BAPI UPDATE FLAG
            c_fix(2)         TYPE c VALUE 'IN',      " CUSTOMER
                                                     " CONDITION GROUP
            c_fix1(2)        TYPE c VALUE 'NI',      " CUSTOMER
                                                     " CONDITION GROUP
            c_form(2)        TYPE c VALUE '/('.      " SPACE FOR
" NEWLINE

* Begin of changes :- Mira_equipment
CONSTANTS: c_incr TYPE sy-tabix VALUE 1.
* End of changes :- Mira_equipment


*-----------------------------------------------------------------------
*        P R I N T   V A R I A B L E    D E C L A R A T I O N
*-----------------------------------------------------------------------
DATA: g_valid          TYPE c,
      g_destination    LIKE pri_params-pdest.
DATA: wa_params        LIKE pri_params.

*-----------------------------------------------------------------------
*        P R I N T   C O N S T A N T S    D E C L A R A T I O N
*-----------------------------------------------------------------------
CONSTANTS: c_error      LIKE bapiret2-type    VALUE 'E',
           c_succ       LIKE bapiret2-type    VALUE 'S',
           c_list_name  LIKE pri_params-plist VALUE 'CONTRACREATE',
           c_list_text  LIKE pri_params-prtxt
                                           VALUE 'CONTARCT CREATE-LOG',
                                                            "#EC NOTEXT
           c_list_name1 LIKE pri_params-plist VALUE 'CONTRACHANGE',
           c_list_text1 LIKE pri_params-prtxt
                                           VALUE 'CONTARCT CHANGE-LOG',
                                                            "#EC NOTEXT

           c_size      TYPE i                 VALUE 255.

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS FOR BDC
*
*---------------------------------------------------------------------*
* begin of modification MOD-001
* CONSTANTS : c_group     LIKE apqi-groupid VALUE 'Y_VA42',
CONSTANTS : c_group     LIKE apqi-groupid VALUE 'Y_EQUIP_VA42',
* end of modification MOD-001
            c_trans     LIKE tstc-tcode   VALUE 'VA42'.


****--------------------------------------------------------------------
*
**
**** SELECT-OPTIONS AND PARAMETERS
**
****--------------------------------------------------------------------
*
*
*SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
*
*PARAMETERS: P_INFILE LIKE RLGRAP-FILENAME OBLIGATORY.
*
*SELECTION-SCREEN END OF BLOCK B1.
*
****--------------------------------------------------------------------
*
**
**** AT SELECTOIN-SCREEN EVENTS   - VALIDATE USER INPUT
**
****--------------------------------------------------------------------
*
*
*AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_INFILE.
*
** - GET THE FILENAME ON THE PRESENTATION SERVER
*  PERFORM GET_FILENAME USING P_INFILE.
*
**--------- S T A R T   O F   M A I N   P R O C E S S I N G -----------*
*
*---------------------------------------------------------------------*
* START-OF-SELECTION             - START OF DATABASE ACCESS           *
*---------------------------------------------------------------------*
START-OF-SELECTION.

* - GET THE FILENAME OF THE CONVERT FILE AND
* - IMPORT /SAPDMC/LSMEMORY FROM MEMORY ID '/SAPDMC/LSMW'.

  IMPORT /sapdmc/lsmemory FROM MEMORY ID '/SAPDMC/LSMW'.

  PERFORM get_lsmw IN PROGRAM yam_common_routines
                    USING  /sapdmc/lsmemory-project
                           /sapdmc/lsmemory-subproj
                           /sapdmc/lsmemory-object
                           c_x
                   CHANGING p_infile.

  IF sy-subrc <> 0.
    MESSAGE e007.
  ENDIF.


* - READ INPUT FILE FROM PRES/APPL SERVER INTO INTERNAL TABLE
  PERFORM get_input_file.

* - SPILT INTERNAL TABLE RECORDS INTO HEADER AND DETAIL RECORDS
  PERFORM split_file.


*&---------------------------------------------------------------------*
*&      Form  get_input_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_input_file .

  IF c_rb_pre = c_x.
* - FILE READ FROM PRESENTATION SERVER
    PERFORM get_from_pres IN PROGRAM yam_common_routines
                                     TABLES  i_upload
                                     USING   p_infile
                                             c_filetype
                                             c_x.

  ELSE.
* - FILE READ FROM APPLICATION SERVER
    PERFORM get_from_appl IN PROGRAM yam_common_routines
                                     TABLES i_upload
                                     USING  p_infile.

  ENDIF.

ENDFORM.                    " get_input_file
*&---------------------------------------------------------------------*
*&      Form  split_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM split_file .

* - PASS THE RECORDS FROM FILE TO A COMMON INTERNAL TABLE
  LOOP AT i_upload.

    MOVE i_upload-v_text+54(20)    TO i_final_record-reclink_c.
* -  SKIP SPACE FOR SALES ORG(4),SALES DISTRIBUTION(2) AND DIVISION(2)
    MOVE i_upload-v_text+82(3)     TO i_final_record-vkgrp.
    MOVE i_upload-v_text+85(4)     TO i_final_record-vkbur.
    MOVE i_upload-v_text+89(4)     TO i_final_record-cccntp.
    MOVE i_upload-v_text+93(10)    TO i_final_record-cccust.
    MOVE i_upload-v_text+103(35)   TO i_final_record-ccoref.
    MOVE i_upload-v_text+138(8)     TO i_final_record-ccsdat.
    MOVE i_upload-v_text+146(8)    TO i_final_record-ccedat.
    MOVE i_upload-v_text+158(12)   TO i_final_record-ccscon.
    MOVE i_upload-v_text+170(8)    TO i_final_record-ccdurnd.
    MOVE i_upload-v_text+178(8)    TO i_final_record-ccsdat1.
    MOVE i_upload-v_text+186(2)    TO i_final_record-ccperiocat.
    MOVE i_upload-v_text+188(3)    TO i_final_record-ccdurn.
* - SKIP SPACE FOR UNIT OF VALIDITY PERIOD OF CONTRACT(1)
    MOVE i_upload-v_text+192(8)    TO i_final_record-ccniwk.
    MOVE i_upload-v_text+200(8)    TO i_final_record-ccedatc.
    MOVE i_upload-v_text+208(2)    TO i_final_record-ccifrq.
* - SKIP SPACE PERIOD AND BILLING PLAN(4)
    MOVE i_upload-v_text+212(1)    TO i_final_record-cccsts.
* - SKIP SPACE FOR CUSTOMER CONDITION GROUP AND PERIOD(3)
    MOVE i_upload-v_text+215(18)   TO i_final_record-mssprd.
* - SKIP SPACE FOR OTHER CONSTANT FIELDS (28)
    MOVE i_upload-v_text+261(15)   TO i_final_record-msppyr.
    MOVE i_upload-v_text+276(18)   TO i_final_record-msmpno.
    MOVE i_upload-v_text+294(18)   TO i_final_record-msmsno.
* - Skip space for Text Constants(18)
    MOVE i_upload-v_text+330(132)  TO i_final_record-text.
    MOVE i_upload-v_text+462(18)   TO i_final_record-equnr.

    APPEND i_final_record.
*    CLEAR I_FINAL_RECORD.

* - PASS THE HEADER DETAILS TO THE HEADER INTERNAL TABLE
    MOVE-CORRESPONDING i_final_record TO i_header.
    APPEND i_header.
    CLEAR  i_header.

* - PASS THE ITEM DETAILS TO THE DETAIL INTERNAL TABLE
    MOVE-CORRESPONDING i_final_record TO i_detail.
    APPEND i_detail.
    CLEAR  i_detail.

  ENDLOOP.


  LOOP AT i_header WHERE reclink_c NE space.

    PERFORM header_text.

  ENDLOOP.

* - SORT THE HEADER INTERNAL TABLE AND DELETE THE DUPLICATES
  SORT i_header BY reclink_c.
  DELETE ADJACENT DUPLICATES FROM i_header COMPARING reclink_c.

* BEGIN OF CHANGES BY MIRA_RECENT
*- SORT THE CONTRACT TEXTS INTERNAL TABLE
  SORT i_contract_text_all BY reclink_c.
*-SORT THE CONTRACT DETAIL TABLE

* begin of deletion MOD-002
*  SORT i_detail.
* end of deletion MOD-002

* END OF CHANGES BY MIRA_RECENT

* - CHECK IF HEADER IS NOT BLANK
  IF NOT i_header[] IS INITIAL.
* begin of insertions MOD-001
  perform open_group.
* end of insertion MOD-001

    LOOP AT i_header WHERE reclink_c NE space.

*BEGIN OF CHANGES BY MIRA_RECENT
      LOOP AT i_contract_text_all WHERE reclink_c EQ
                                       i_header-reclink_c.
        MOVE-CORRESPONDING i_contract_text_all TO wa_contracttext.
        APPEND wa_contracttext TO i_contract_text.
        CLEAR wa_contracttext.
      ENDLOOP.
*END OF CHANGES BY MIRA_RECENT


* - CHECK FOR THE EXISTING SERVICE CONTRACTS EXISTING.
      PERFORM sales_contract_doc.

    ENDLOOP.

* begin of insertions MOD-001
  perform close_group.
* end of insertion MOD-001

  ENDIF.

ENDFORM.                    " split_file
*&---------------------------------------------------------------------*
*&      Form  header_text
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM header_text .

  MOVE i_header-reclink_c        TO   wa_contract_text-reclink_c.
  MOVE  c_spras                 TO   wa_contract_text-langu_iso.
  MOVE  c_tdid                  TO   wa_contract_text-text_id.
  MOVE  c_form                  TO   wa_contract_text-format_col.
  MOVE i_header-text            TO   wa_contract_text-text_line.

  APPEND wa_contract_text    TO i_contract_text_all.
  CLEAR wa_contract_text.

ENDFORM.                    " header_text
*&---------------------------------------------------------------------*
*&      Form  sales_contract_doc
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM sales_contract_doc .

  REFRESH i_salesdoc_in.
  CLEAR: g_count,
         g_vsnmr_v.

* - CHECK FOR THE MULTIPLE SALES DOCUMENT VERSION
  SELECT vsnmr_v  COUNT( * ) FROM vbak
          INTO (g_vsnmr_v, g_count) WHERE
                         vsnmr_v EQ i_header-ccscon
                           GROUP BY vsnmr_v .

  ENDSELECT.
* - CHECK IF 1 ENTRY EXISTS FOR THE VERSION THEN OVERWRITE THE EXISTING
* - ONE
  IF g_count = 1.

    SELECT vbeln
           vsnmr_v INTO i_salesdoc_in
           FROM vbak
           WHERE vsnmr_v EQ i_header-ccscon.

    ENDSELECT.
    APPEND i_salesdoc_in.

    IF sy-subrc EQ 0.

      PERFORM fill_data_to_change.
* - GET EQUIPMENT NUMER USING SESSION METHOD
      PERFORM get_equipment_contracts.

    ENDIF.

* - CHECK IF NO ENTRY EXIST THEN CREATE SERVICE CONTRACTS
  ELSEIF g_count < 1.

    WRITE : / text-004.
* IF MULTIPLE ENTRIES FOUND THEN DO NOT PROCESS
  ELSEIF g_count > 1.

    WRITE : / text-005.

  ENDIF.


ENDFORM.                    " sales_contract_doc
*&---------------------------------------------------------------------*
*&      Form  get_equipment_contracts
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_equipment_contracts .

  REFRESH:  i_contractvbeln,
            i_contractitem.

  SELECT vbeln
             FROM vbak
             INTO i_contractvbeln
             FOR ALL ENTRIES IN i_salesdoc_in
             WHERE vsnmr_v EQ i_salesdoc_in-vsnmr_v.

  ENDSELECT.
  APPEND i_contractvbeln.
  CLEAR i_contractvbeln.

  IF sy-subrc EQ 0.
    SELECT vbeln posnr matnr FROM vbap
                  INTO TABLE i_contractitem
                  FOR ALL ENTRIES IN i_contractvbeln
                     WHERE vbeln EQ i_contractvbeln-vbeln.

    IF sy-subrc EQ 0.
      DESCRIBE TABLE i_contractitem LINES g_lin.
    ENDIF.
  ENDIF.

*begin of deletion MOD-002
*  SORT i_detail_equip BY mssprd.
* end of deletion MOD-002

* begin of deletion MOD-001
*  PERFORM open_group.
* end of deletion MOD-001

  LOOP AT i_contractvbeln WHERE vbeln NE space.

    PERFORM bdc_filldata.

  ENDLOOP.

* begin of deletion MOD-001
*  PERFORM close_group.
* end of deletion MOD-001

ENDFORM.                    " get_equipment_contracts
*&---------------------------------------------------------------------*
*&      Form  open_group
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM open_group .

  CALL FUNCTION 'BDC_OPEN_GROUP'
    EXPORTING
      client = sy-mandt
      group  = c_group
      user   = sy-uname
      keep   = ' '.
  .
  IF sy-subrc <> 0.
    MESSAGE e036. " SERVICE CONTRACT NUMBER IS EMPTY
  ENDIF.

ENDFORM.                    " open_group
*&---------------------------------------------------------------------*
*&      Form  bdc_filldata
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM bdc_filldata .

 PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '0102' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'VBAK-VBELN' i_contractvbeln-vbeln
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


*Begin of changes by Mira_equipment.
  DATA: scr_fld(30) TYPE c.

  CLEAR: v_indx.
  CLEAR: scr_fld.


  DO g_lin TIMES.

    v_indx = v_indx + c_incr.
* - To here

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.


*End of changes by Mira_equipment.

*Begin of changes:- Mira
    CLEAR: scr_fld.
    CONCATENATE 'VBAP-POSNR(' v_indx ')' INTO scr_fld.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: '' '' '' 'BDC_CURSOR' scr_fld
                     CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.


    CLEAR: scr_fld.
    CONCATENATE 'RV45A-VBAP_SELKZ(' v_indx ')' INTO scr_fld.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: '' '' '' scr_fld 'X'
                    CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

*End of changes:- Mira

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=POTO'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.


    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: 'SAPLIWOL' '0220' 'X' ' ' ' '
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.


* Read Equipment Number for every Item.
    READ TABLE i_contractitem INDEX sy-index.

    IF sy-subrc EQ 0.
*Begin of changes for multiple equipment number:- Mira.
*     READ TABLE i_detail_equip WITH KEY mssprd = i_contractitem-matnr.
      clear v_indx_equip.
* begin of deletion MOD-002
*     LOOP AT I_DETAIL_EQUIP where mssprd = i_contractitem-matnr.
* end of deletion MOD-002
* begin of insertion MOD-002
      READ TABLE i_detail_equip index sy-index.
* end of insertion MOD-002

      v_indx_equip = v_indx_equip + c_incr.

      CLEAR: scr_fld.
      CONCATENATE 'RIWOL-EQUNR(' v_indx_equip ')' INTO scr_fld.
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_CURSOR' scr_fld
                      CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.


      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                                 USING: '' '' '' scr_fld
                                 i_detail_equip-equnr
                                 CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.

      v_mod = v_indx_equip mod 13.

      if v_mod eq 0.
       PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=P+'
                       CHANGING struct_bdcdata.

       APPEND struct_bdcdata TO i_bdcdata.
       CLEAR  struct_bdcdata.
       clear v_indx_equip.
      endif.
* begin of deletion MOD-002.
*    ENDLOOP.
* end of deletion MOD-002
   ENDIF.
*End of changes for multiple equipment number:- Mira.


    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPLIWOL' '0220' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_CURSOR' 'RIWOL0-NRPOS'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.


    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=BACK'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.



    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

* Added now by Mira
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

* Begin of changes:- Mira_equipment

    v_mod = sy-index MOD 2.

    IF v_mod EQ 0.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=P+'
                       CHANGING struct_bdcdata.

      APPEND struct_bdcdata TO i_bdcdata.
      CLEAR  struct_bdcdata.
      CLEAR v_indx.

    ENDIF.

  ENDDO.

* End of changes:- Mira_equipment


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: '' '' '' 'BDC_OKCODE' '=SICH'
                    CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: 'SAPLSPO2' '0101' 'X' ' ' ' '
                    CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: '' '' '' 'BDC_OKCODE' '=OPT1'
                    CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

*  CALL TRANSACTION 'VA42'  USING i_bdcdata  MODE 'N'
*                           MESSAGES INTO i_bdcmsgcoll.


PERFORM BDC_TRANSACTION USING C_TRANS.

  REFRESH i_bdcdata.


ENDFORM.                    " bdc_filldata
*&---------------------------------------------------------------------*
*&      Form  close_group
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM close_group .

  CALL FUNCTION 'BDC_CLOSE_GROUP'.


ENDFORM.                    " close_group
*&---------------------------------------------------------------------*
*&      Form  BDC_TRANSACTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_C_TRANS  text
*----------------------------------------------------------------------*
FORM bdc_transaction  USING    p_c_trans.

  CALL FUNCTION 'BDC_INSERT'
    EXPORTING
      tcode            = p_c_trans
    TABLES
      dynprotab        = i_bdcdata
    EXCEPTIONS
      internal_error   = 1
      not_open         = 2
      queue_error      = 3
      tcode_invalid    = 4
      printing_invalid = 5
      posting_invalid  = 6
      OTHERS           = 7.
  .
  IF sy-subrc <> 0.
    MESSAGE e014.
  ENDIF.

ENDFORM.                    " BDC_TRANSACTION
*&---------------------------------------------------------------------*
*&      Form  fill_data_to_change
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_data_to_change .
* begin of insertion MOD-002
    refresh i_detail_equip.
* end of insertion MOD-002

  LOOP AT i_detail WHERE
          reclink_c EQ i_header-reclink_c.

    MOVE i_detail-mssprd    TO   i_detail_equip-mssprd.
    MOVE i_detail-msmpno    TO   i_detail_equip-msmpno.
    MOVE i_detail-msmsno    TO   i_detail_equip-msmsno.
    MOVE i_detail-equnr     TO   i_detail_equip-equnr.

    APPEND i_detail_equip.
    CLEAR i_detail_equip.

  ENDLOOP.

  DELETE ADJACENT DUPLICATES FROM I_DETAIL_EQUIP COMPARING EQUNR.
* begin of deletion MOD-002
* SORT I_DETAIL_EQUIP by MSSPRD.
* end of deletion MOD-002


ENDFORM.                    " fill_data_to_change
*&---------------------------------------------------------------------*
*&      Form  GET_FILENAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_FILE  text
*----------------------------------------------------------------------*
FORM get_filename  USING    l_file.

  CALL FUNCTION 'WS_FILENAME_GET'
    EXPORTING
      def_path         = 'C:\'
      mask             = ',*.TXT.'
    IMPORTING
      filename         = l_file
    EXCEPTIONS
      inv_winsys       = 1
      no_batch         = 2
      selection_cancel = 3
      selection_error  = 4
      OTHERS           = 5.
  IF sy-subrc <> 0.
*    PERFORM CALLERR USING TEXT-003.
  ENDIF.


ENDFORM.                    " GET_FILENAME

*Text symbol text£º
*004:No Service Contract exists !!!!!
*005:Error !!! Multiple Service Contracts found for this entry
