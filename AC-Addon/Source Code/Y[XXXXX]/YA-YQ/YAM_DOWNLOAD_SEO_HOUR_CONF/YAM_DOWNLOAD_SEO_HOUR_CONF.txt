*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_DOWNLOAD_SEO_HOUR_CONF                    *
* PROGRAM TITLE        : Download Service Order Hour Confirmations     *
* AUTHOR               : Geert Rutten                                  *
* DATE                 : 05/10/2012                                    *
* DEVELOPMENT ID       :                                               *
*                                                                      *
* CHANGE REQUEST NUMBER:  CD1K973418                                   *
*                                                                      *
* Program Description:  Download of service orders hour confirmations  *
*                       for cutover Act! program                       *
************************************************************************
*&---------------------------------------------------------------------*
*& Change Log                                                          *
*&---------------------------------------------------------------------*
*&MOD No.|Date        | TR number    | Changed By     | CR Number      *
*MOD-001 |03.05.2017  | CD1K991793   |                | PBCS-1226      *
*Description : Addition of new fields to GTY_AFRU ie.,RUECK ,RMZHL     *
*               and change in read statment to include these 2 fields  *
*&---------------------------------------------------------------------*
REPORT yam_download_seo_hour_conf MESSAGE-ID yam_inf.

************************************************************************
*                   T A B L E S                                        *
************************************************************************
TABLES: vbak,
        viaufkst,
        aufk,
        afru,
        afvv,
        tj02t,
        mpos,
        qmel,
        knvv.

************************************************************************
*                   T Y P E - P O O L S                                *
************************************************************************
TYPE-POOLS: ibco2.

TYPES: BEGIN OF gty_afru,
         aufnr TYPE aufnr,
         budat TYPE buchdatum,
         arbid TYPE objektid,
         werks TYPE werks_d,
         ismnw TYPE ismnw,
         ismne TYPE arbeite,
         learr TYPE learr,
         grund TYPE co_agrnd,
         stzhl TYPE co_stzhl,
         rueck TYPE co_rueck, " Addition of field MOD-001
         rmzhl TYPE co_rmzhl, " Addition of field MOD-001
     END OF gty_afru.

TYPES: BEGIN OF gty_crco,
         objid TYPE cr_objid,
         endda TYPE enddatum,
         begda TYPE begdatum,
         kokrs TYPE kokrs,
         kostl TYPE kostl,
         lstar TYPE lstar,
       END OF gty_crco.

************************************************************************
*                   C O N S T A N T S                                  *
************************************************************************
CONSTANTS: gc_stat_dl  TYPE j_status  VALUE 'I0076',
           c_rec_o(14) TYPE c         VALUE 'seo_hour_conf',
           gc_charx(1) TYPE c  VALUE 'X',
           gc_vw(2)    TYPE c  VALUE 'VW'.

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************

DATA: BEGIN OF gt_seo OCCURS 0,
        aufnr    LIKE aufk-aufnr,
        aufpl    LIKE afko-aufpl,
      END OF gt_seo.

DATA: gv_hours  TYPE cms_dte_dec_13_3_crm.

DATA: BEGIN OF gt_seo_hc_c OCCURS 0,
        aufnr      LIKE dd03l-fieldname,
        deli1      TYPE c,
        vornr      LIKE dd03l-fieldname,
        deli2      TYPE c,
        rueck      LIKE dd03l-fieldname,
        deli3      TYPE c,
        rmzhl      LIKE dd03l-fieldname,
        deli4      TYPE c,
        ersda      LIKE dd03l-fieldname,
        deli5      TYPE c,
        arbpl      LIKE dd03l-fieldname,
        deli6      TYPE c,
        werks      LIKE dd03l-fieldname,
        deli7      TYPE c,
        ismnw      LIKE dd03l-fieldname,
        deli8      TYPE c,
        ismne      LIKE dd03l-fieldname,
        deli9      TYPE c,
        learr      LIKE dd03l-fieldname,
        deli10     TYPE c,
        budat      LIKE dd03l-fieldname,
        deli11     TYPE c,
        aueru      LIKE dd03l-fieldname,
        deli12     TYPE c,
        lek01      LIKE dd03l-fieldname,
        deli13     TYPE c,
        ofmnw      LIKE dd03l-fieldname,
        deli14     TYPE c,
        ofmne      LIKE dd03l-fieldname,
        deli15     TYPE c,
        ausor      LIKE dd03l-fieldname,
        deli16     TYPE c,
        stndr      LIKE dd03l-fieldname,
        deli17     TYPE c,
        arbid      LIKE dd03l-fieldname,
        deli18     TYPE c,
        ltxa1      LIKE dd03l-fieldname,
        deli19     TYPE c,
        txtsp      LIKE dd03l-fieldname,
        deli20     TYPE c,
        iserh      LIKE dd03l-fieldname,
        deli21     TYPE c,
        zeier      LIKE dd03l-fieldname,
        deli22     TYPE c,
        ile01      LIKE dd03l-fieldname,
        deli23     TYPE c,
        ism01      LIKE dd03l-fieldname,
        deli24     TYPE c,
        ile02      LIKE dd03l-fieldname,
        deli25     TYPE c,
        ism02      LIKE dd03l-fieldname,
        deli26     TYPE c,
        ile03      LIKE dd03l-fieldname,
        deli27     TYPE c,
        ism03      LIKE dd03l-fieldname,
        deli28     TYPE c,
        ile04      LIKE dd03l-fieldname,
        deli29     TYPE c,
        ism04      LIKE dd03l-fieldname,
        deli30     TYPE c,
        ile05      LIKE dd03l-fieldname,
        deli31     TYPE c,
        ism05      LIKE dd03l-fieldname,
        deli32     TYPE c,
        ile06      LIKE dd03l-fieldname,
        deli33     TYPE c,
        ism06      LIKE dd03l-fieldname,
        deli34     TYPE c,
        abarb      LIKE dd03l-fieldname,
        deli35     TYPE c,
        idaur      LIKE dd03l-fieldname,
        deli36     TYPE c,
        idaue      LIKE dd03l-fieldname,
        deli37     TYPE c,
        logrp      LIKE dd03l-fieldname,
        deli38     TYPE c,
        belnr_ist  LIKE dd03l-fieldname,
        deli39     TYPE c,
        belnr_umb  LIKE dd03l-fieldname,
        deli40     TYPE c,
        rmnga      LIKE dd03l-fieldname,
        deli41     TYPE c,
        catsbelnr  LIKE dd03l-fieldname,
        deli42     TYPE c,
*        erzet      LIKE dd03l-fieldname,
*        deli43     TYPE c,
        catsprice  LIKE dd03l-fieldname,
        deli44     TYPE c,
        catstcurr   LIKE dd03l-fieldname,
        deli45     TYPE c,
        catspeinh  LIKE dd03l-fieldname,
        deli46     TYPE c,
        bemot      LIKE dd03l-fieldname,
        deli47     TYPE c,
        iprz1      LIKE dd03l-fieldname,
        deli48     TYPE c,
        ipre1      LIKE dd03l-fieldname,
        deli49      TYPE c,
        iprk1      LIKE dd03l-fieldname,
        deli50     TYPE c,
        stokz      LIKE dd03l-fieldname,
        deli51     TYPE c,
        stzhl      LIKE dd03l-fieldname,
        deli52     TYPE c,
        grund      LIKE dd03l-fieldname,
        deli53     TYPE c,
        isdd       LIKE dd03l-fieldname,
        deli54     TYPE c,
        isdz       LIKE dd03l-fieldname,
        deli55     TYPE c,
        iedd       LIKE dd03l-fieldname,
        deli56     TYPE c,
        iedz       LIKE dd03l-fieldname,
        deli57     TYPE c,
        tkf        LIKE dd03l-fieldname,
        deli58     TYPE c,
        waers      LIKE dd03l-fieldname,
        deli59     TYPE c,
      END OF gt_seo_hc_c.

DATA: BEGIN OF gt_seo_hc OCCURS 0,
        aufnr      LIKE afih-aufnr,
        deli1      TYPE c,
        vornr      LIKE afru-vornr,
        deli2      TYPE c,
        rueck      LIKE afru-rueck,
        deli3      TYPE c,
        rmzhl      LIKE afru-rmzhl,
        deli4      TYPE c,
        ersda      LIKE afru-ersda,
        deli5      TYPE c,
        arbpl      LIKE crhd-arbpl,
        deli6      TYPE c,
        werks      LIKE afru-werks,
        deli7      TYPE c,
        ismnw(10)  TYPE c,
        deli8      TYPE c,
        ismne(3)   TYPE c,
        deli9      TYPE c,
        learr      LIKE afru-learr,
        deli10     TYPE c,
        budat      LIKE afru-budat,
        deli11     TYPE c,
        aueru      LIKE afru-aueru,
        deli12     TYPE c,
        lek01      LIKE afru-lek01,
        deli13     TYPE c,
        ofmnw(9)   TYPE c,
        deli14     TYPE c,
        ofmne(3)   TYPE c,
        deli15     TYPE c,
        ausor      LIKE afru-ausor,
        deli16     TYPE c,
        stndr      LIKE afru-stndr,
        deli17     TYPE c,
        arbid      LIKE afru-arbid,
        deli18     TYPE c,
        ltxa1      LIKE afru-ltxa1,
        deli19     TYPE c,
        txtsp      LIKE afru-txtsp,
        deli20     TYPE c,
        iserh(11)  TYPE c,
        deli21     TYPE c,
        zeier(3)   TYPE c,
        deli22     TYPE c,
        ile01(3)   TYPE c,
        deli23     TYPE c,
        ism01(18)  TYPE c,
        deli24     TYPE c,
        ile02(3)   TYPE c,
        deli25     TYPE c,
        ism02(18)  TYPE c,
        deli26     TYPE c,
        ile03(3)   TYPE c,
        deli27     TYPE c,
        ism03(18)  TYPE c,
        deli28     TYPE c,
        ile04(3)   TYPE c,
        deli29     TYPE c,
        ism04(18)  TYPE c,
        deli30     TYPE c,
        ile05(3)   TYPE c,
        deli31     TYPE c,
        ism05(18)  TYPE c,
        deli32     TYPE c,
        ile06(3)   TYPE c,
        deli33     TYPE c,
        ism06(18)  TYPE c,
        deli34     TYPE c,
        abarb      LIKE afru-abarb,
        deli35     TYPE c,
        idaur(7)   TYPE c,
        deli36     TYPE c,
        idaue(3)   TYPE c,
        deli37     TYPE c,
        logrp      LIKE afru-logrp,
        deli38     TYPE c,
        belnr_ist  LIKE afru-belnr_ist,
        deli39     TYPE c,
        belnr_umb  LIKE afru-belnr_umb,
        deli40     TYPE c,
        rmnga(18)  TYPE c,
        deli41     TYPE c,
        catsbelnr LIKE afru-catsbelnr,
        deli42     TYPE c,
        erzet      LIKE afru-erzet,
        deli43     TYPE c,
        catsprice(16) TYPE c,
        deli44     TYPE c,
        catstcurr(5) TYPE c,
        deli45     TYPE c,
        catspeinh(6) TYPE c,
        deli46     TYPE c,
        bemot      LIKE afru-bemot,
        deli47     TYPE c,
        iprz1(18)  TYPE c,
        deli48     TYPE c,
        ipre1(3)   TYPE c,
        deli49     TYPE c,
        iprk1      LIKE afru-iprk1,
        deli50     TYPE c,
        stokz      LIKE afru-stokz,
        deli51     TYPE c,
        stzhl      LIKE afru-stzhl,
        deli52     TYPE c,
        grund      LIKE afru-grund,
        deli53     TYPE c,
        isdd       LIKE afru-isdd,
        deli54     TYPE c,
        isdz       LIKE afru-isdz,
        deli55     TYPE c,
        iedd       LIKE afru-iedd,
        deli56     TYPE c,
        iedz       LIKE afru-iedz,
        deli57     TYPE c,
        tkf(14),"        LIKE rkpln-tkf,
        deli58     TYPE c,
        waers      TYPE waers,
        deli59     TYPE c,
      END OF gt_seo_hc.

DATA: BEGIN OF gt_seo_hc2 OCCURS 0,
        aufnr      LIKE afih-aufnr,
        deli1      TYPE c,
        vornr      LIKE afru-vornr,
        deli2      TYPE c,
        rueck      LIKE afru-rueck,
        deli3      TYPE c,
        rmzhl      LIKE afru-rmzhl,
        deli4      TYPE c,
        ersda      LIKE afru-ersda,
        deli5      TYPE c,
        arbpl      LIKE crhd-arbpl,
        deli6      TYPE c,
        werks      LIKE afru-werks,
        deli7      TYPE c,
        ismnw      TYPE afru-ismnw,
        deli8      TYPE c,
        ismne      LIKE afru-ismne,
        deli9      TYPE c,
        learr      LIKE afru-learr,
        deli10     TYPE c,
        budat      LIKE afru-budat,
        deli11     TYPE c,
        aueru      LIKE afru-aueru,
        deli12     TYPE c,
        lek01      LIKE afru-lek01,
        deli13     TYPE c,
        ofmnw      LIKE afru-ofmnw,
        deli14     TYPE c,
        ofmne      LIKE afru-ofmne,
        deli15     TYPE c,
        ausor      LIKE afru-ausor,
        deli16     TYPE c,
        stndr      LIKE afru-stndr,
        deli17     TYPE c,
        arbid      LIKE afru-arbid,
        deli18     TYPE c,
        ltxa1      LIKE afru-ltxa1,
        deli19     TYPE c,
        txtsp      LIKE afru-txtsp,
        deli20     TYPE c,
        iserh      LIKE afru-iserh,
        deli21     TYPE c,
        zeier      LIKE afru-zeier,
        deli22     TYPE c,
        ile01      LIKE afru-ile01,
        deli23     TYPE c,
        ism01      LIKE afru-ism01,
        deli24     TYPE c,
        ile02      LIKE afru-ile02,
        deli25     TYPE c,
        ism02      LIKE afru-ism02,
        deli26     TYPE c,
        ile03      LIKE afru-ile03,
        deli27     TYPE c,
        ism03      LIKE afru-ism03,
        deli28     TYPE c,
        ile04      LIKE afru-ile04,
        deli29     TYPE c,
        ism04      LIKE afru-ism04,
        deli30     TYPE c,
        ile05      LIKE afru-ile05,
        deli31     TYPE c,
        ism05      LIKE afru-ism05,
        deli32     TYPE c,
        ile06      LIKE afru-ile06,
        deli33     TYPE c,
        ism06      LIKE afru-ism06,
        deli34     TYPE c,
        abarb      LIKE afru-abarb,
        deli35     TYPE c,
        idaur      LIKE afru-idaur,
        deli36     TYPE c,
        idaue      LIKE afru-idaue,
        deli37     TYPE c,
        logrp      LIKE afru-logrp,
        deli38     TYPE c,
        belnr_ist  LIKE afru-belnr_ist,
        deli39     TYPE c,
        belnr_umb  LIKE afru-belnr_umb,
        deli40     TYPE c,
        rmnga      LIKE afru-rmnga,
        deli41     TYPE c,
        catsbelnr LIKE afru-catsbelnr,
        deli42     TYPE c,
*        erzet      LIKE afru-erzet,
*        deli43     TYPE c,
        catsprice  LIKE afru-catsprice,
        deli44     TYPE c,
        catstcurr   LIKE afru-catstcurr,
        deli45     TYPE c,
        catspeinh  LIKE afru-catspeinh,
        deli46     TYPE c,
        bemot      LIKE afru-bemot,
        deli47     TYPE c,
        iprz1      LIKE afru-iprz1,
        deli48     TYPE c,
        ipre1      LIKE afru-ipre1,
        deli49     TYPE c,
        iprk1      LIKE afru-iprk1,
        deli50     TYPE c,
        stokz      LIKE afru-stokz,
        deli51     TYPE c,
        stzhl      LIKE afru-stzhl,
        deli52     TYPE c,
        grund      LIKE afru-grund,
        deli53     TYPE c,
        isdd       LIKE afru-isdd,
        deli54     TYPE c,
        isdz       LIKE afru-isdz,
        deli55     TYPE c,
        iedd       LIKE afru-iedd,
        deli56     TYPE c,
        iedz       LIKE afru-iedz,
        deli57     TYPE c,
        ismnu      LIKE afru-ismnu,
        ismnw_2    TYPE ismnw_2,
        aufpl      TYPE co_aufpl,
        aplzl      TYPE co_aplzl,
        tkf        LIKE rkpln-tkf,
        deli58     TYPE c,
        waers      TYPE waers,
        deli59     TYPE c,
      END OF gt_seo_hc2.

DATA: BEGIN OF gt_seo_l1_c OCCURS 0,
        qmnum      LIKE dd03l-fieldname,
        deli1      TYPE c,
        objtype     TYPE dd03l-fieldname,
        deli2      TYPE c,
        objkey      TYPE dd03l-fieldname,
        deli3      TYPE c,
        line_number TYPE dd03l-fieldname,
        deli4      TYPE c,
        format_col  TYPE dd03l-fieldname,
        deli5      TYPE c,
        longtext   TYPE dd03l-fieldname,
      END OF gt_seo_l1_c.

DATA: BEGIN OF gt_seo_l1 OCCURS 0,
        qmnum      LIKE qmel-qmnum,
        deli1      TYPE c,
        objtype     TYPE swo_objtyp,
        deli2      TYPE c,
        objkey      TYPE qobjkey,
        deli3      TYPE c,
        line_number TYPE tdlineno,
        deli4      TYPE c,
        format_col  TYPE tdformat,
        deli5      TYPE c,
        longtext(132)   TYPE c,
      END OF gt_seo_l1.

DATA: BEGIN OF gt_seo_l2_c OCCURS 0,
        qmnum      LIKE dd03l-fieldname,
        deli1      TYPE c,
        objtype     TYPE dd03l-fieldname,
        deli2      TYPE c,
        objkey      TYPE dd03l-fieldname,
        deli3      TYPE c,
        line_number TYPE dd03l-fieldname,
        deli4      TYPE c,
        format_col  TYPE dd03l-fieldname,
        deli5      TYPE c,
        longtext   TYPE dd03l-fieldname,
      END OF gt_seo_l2_c.

DATA: BEGIN OF gt_seo_l2 OCCURS 0,
        qmnum       LIKE qmel-qmnum,
        deli1      TYPE c,
        objtype     TYPE swo_objtyp,
        deli2      TYPE c,
        objkey      TYPE qobjkey,
        deli3      TYPE c,
        line_number TYPE tdlineno,
        deli4      TYPE c,
        format_col  TYPE tdformat,
        deli5       TYPE c,
        longtext(132)   TYPE c,
      END OF gt_seo_l2.

TYPES: BEGIN OF ty_afvv,
         aufpl     TYPE co_aufpl,
         aplzl     TYPE co_aplzl,
         isdd      TYPE isdd,
         isdz      TYPE isdz,
         iedd      TYPE iedd,
         iedz      TYPE iedz,
       END OF ty_afvv.

DATA: gt_afvv   TYPE HASHED TABLE OF ty_afvv
                     WITH UNIQUE KEY aufpl aplzl
                     WITH HEADER LINE,
      gt_afvvi  TYPE TABLE OF ty_afvv.

DATA: lv_atinn  TYPE atinn,
      lv_mpobj  LIKE imptt-mpobj,
      lv1_point LIKE imptt-point,
      lv_index TYPE sy-tabix.

DATA: h_stat_flag,
      lv_objnr_ord LIKE aufk-objnr.
DATA: lv_sttxtu(40)  TYPE c.

*------------------------------------------------------------------
* Variables
DATA: lt_viqmfe TYPE TABLE OF wqmfe,
      ls_viqmfe TYPE wqmfe,
      lt_viqmur TYPE TABLE OF wqmur,
      ls_viqmur TYPE wqmur,
      es_viqmel TYPE viqmel,
      lt_longtxt TYPE TABLE OF alm_me_longtext,
      ls_longtxt TYPE alm_me_longtext,
      lt_longtxt_item TYPE TABLE OF alm_me_longtext.

DATA  gv_werks TYPE werks.

DATA: BEGIN OF h_status_tab OCCURS 30.
        INCLUDE STRUCTURE jstat.
DATA: END OF h_status_tab.

DATA: g_directory(25) TYPE c VALUE '/var/load/xxx/UK/read/',
      g_ofile         LIKE /sapdmc/lsoinp-filename,
      p_logsys        LIKE tbdlst-logsys.


FIELD-SYMBOLS: <gs_value>  TYPE ibco2_value_rec.

DATA:  lv_kdauf TYPE kdauf,
       lv_kdpos TYPE kdpos,
       lv_plnnr TYPE mpos-plnnr,
       lv_plnal TYPE mpos-plnal,
       lv_plnty TYPE mpos-plnty,
       lv_pstxt TYPE mpos-pstxt.
DATA:  lv_sttxt TYPE co_sttxt.

************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************
SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
PARAMETERS:     p_werks  TYPE aufk-werks MEMORY ID wrk.
SELECT-OPTIONS: s_aufnr  FOR  aufk-aufnr.
SELECT-OPTIONS: s_auart  FOR  aufk-auart.
SELECT-OPTIONS: s_erdat  FOR  aufk-erdat.
SELECT-OPTIONS: s_aedat  FOR  aufk-aedat.
SELECT-OPTIONS: s_isdd   FOR  afru-isdd.
SELECT-OPTIONS: s_vtweg  FOR  knvv-vtweg.
PARAMETERS:     p_bukrs  TYPE aufk-bukrs OBLIGATORY MEMORY ID buk,
                p_vkorg  TYPE knvv-vkorg MEMORY ID vko.

*PARAMETERS:     h_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\Seo_Header'.
PARAMETERS:     o_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\seo_hour_conf'.
*PARAMETERS:     p_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\seo_Parts_Ordered'.
*PARAMETERS:     l1_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\seo_header_longtext'.
*PARAMETERS:     l2_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\seo_item_longtext'.
SELECTION-SCREEN: END OF BLOCK b1.

* Comment
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c01.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c02.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c03.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b2.

*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_werks.

  IF p_werks IS NOT INITIAL.
* Check planning plant
    SELECT SINGLE werks
         INTO gv_werks
         FROM t001w
         WHERE werks = p_werks.

    IF sy-subrc <> 0.
*.. Planning plant does not exist
      MESSAGE e001(00) WITH text-e02.
    ENDIF.
  ENDIF.


*- Initialization -----------------------------------------------------*
INITIALIZATION.

  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = p_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.

* Select all seoications
*  SELECT qmnum objnr
*    INTO CORRESPONDING FIELDS OF TABLE gt_seo
*    FROM viqmel
*    WHERE qmnum IN s_qmnum
*      AND qmart IN s_qmart
*      AND iwerk EQ p_iwerk .

* Service Orders
*  SELECT aufnr aufpl
*    INTO TABLE gt_seo
*     FROM viaufkst
*     WHERE aufnr IN s_aufnr
*       AND auart IN s_auart
*       AND erdat IN s_erdat
*       AND aedat IN s_aedat
*       AND werks EQ p_werks
**       AND loekz NE 'X'
*       AND iphas NE '6'
*       AND vtweg IN s_vtweg.
  DATA: lv_where TYPE string.
  lv_where = 'aufnr IN s_aufnr AND auart IN s_auart AND erdat IN s_erdat AND aedat IN s_aedat AND bukrs EQ p_bukrs'.
  IF p_werks IS NOT INITIAL.
    CONCATENATE lv_where 'AND werks EQ p_werks' INTO lv_where SEPARATED BY space.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_where 'AND vkorg EQ p_vkorg' INTO lv_where SEPARATED BY space.
  ENDIF.
  CONCATENATE lv_where 'AND iphas NE ''6'' AND vtweg IN s_vtweg' INTO lv_where SEPARATED BY space.
  SELECT aufnr aufpl
    INTO TABLE gt_seo
    FROM viaufkst
    WHERE (lv_where).

  CHECK gt_seo[] IS NOT INITIAL.

*  LOOP AT gt_seo.
*
*    SELECT *
*    APPENDING CORRESPONDING FIELDS OF TABLE gt_seo_hc2
*     FROM afru
*     WHERE aufnr = gt_seo-aufnr.
*
*  ENDLOOP.

* Confirmations
  SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_seo_hc2
           FROM afru
           FOR ALL ENTRIES IN gt_seo
           WHERE aufnr =  gt_seo-aufnr
             AND isdd  IN s_isdd.

* Operation Dates
*  SELECT * INTO CORRESPONDING FIELDS OF TABLE gt_afvvi
*           FROM afvv
*           FOR ALL ENTRIES IN gt_seo_hc2
*           WHERE aufpl = gt_seo_hc2-aufpl
*             AND aplzl = gt_seo_hc2-aplzl.
*  SORT gt_afvvi BY aufpl aplzl.
*  DELETE ADJACENT DUPLICATES FROM gt_afvvi
*                             COMPARING aufpl aplzl.
*  gt_afvv[] = gt_afvvi[].
*  FREE gt_afvvi.

  PERFORM get_data.

  IF NOT gt_seo_hc2[] IS INITIAL.
    PERFORM download_files.
  ENDIF.

*&---------------------------------------------------------------------*
*&      Form  get_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_data.

  LOOP AT gt_seo_hc2.

    CONCATENATE 'OR' gt_seo_hc2-aufnr INTO lv_objnr_ord.
    CLEAR: lv_sttxt, lv_sttxtu.
    CALL FUNCTION 'STATUS_TEXT_EDIT'
      EXPORTING
        objnr         = lv_objnr_ord
        spras         = sy-langu
        flg_user_stat = 'X'
        only_active   = 'X'
      IMPORTING
        line          = lv_sttxt
        user_line     = lv_sttxtu.

    IF lv_sttxt CS 'CLSD'.
      CONTINUE.
    ENDIF.

    MOVE '|' TO: gt_seo_hc2-deli1, gt_seo_hc2-deli2, gt_seo_hc2-deli3,
                 gt_seo_hc2-deli4, gt_seo_hc2-deli5, gt_seo_hc2-deli6,
                 gt_seo_hc2-deli7, gt_seo_hc2-deli8, gt_seo_hc2-deli9,
                 gt_seo_hc2-deli10, gt_seo_hc2-deli11, gt_seo_hc2-deli12,
                 gt_seo_hc2-deli13, gt_seo_hc2-deli14, gt_seo_hc2-deli15,
                 gt_seo_hc2-deli16, gt_seo_hc2-deli17, gt_seo_hc2-deli18,
                 gt_seo_hc2-deli19, gt_seo_hc2-deli20, gt_seo_hc2-deli21,
                 gt_seo_hc2-deli22, gt_seo_hc2-deli23, gt_seo_hc2-deli24,
                 gt_seo_hc2-deli23, gt_seo_hc2-deli24, gt_seo_hc2-deli25,
                 gt_seo_hc2-deli26, gt_seo_hc2-deli27, gt_seo_hc2-deli28,
                 gt_seo_hc2-deli29, gt_seo_hc2-deli30, gt_seo_hc2-deli31,
                 gt_seo_hc2-deli32, gt_seo_hc2-deli33, gt_seo_hc2-deli34,
                 gt_seo_hc2-deli35, gt_seo_hc2-deli36, gt_seo_hc2-deli37,
                 gt_seo_hc2-deli38, gt_seo_hc2-deli39, gt_seo_hc2-deli40,
                 gt_seo_hc2-deli41, gt_seo_hc2-deli42,   "gt_seo_hc2-deli43,
                 gt_seo_hc2-deli44, gt_seo_hc2-deli45, gt_seo_hc2-deli46,
                 gt_seo_hc2-deli47, gt_seo_hc2-deli48, gt_seo_hc2-deli49,
                 gt_seo_hc2-deli50, gt_seo_hc2-deli51, gt_seo_hc2-deli52,
                 gt_seo_hc2-deli53, gt_seo_hc2-deli54, gt_seo_hc2-deli55,
                 gt_seo_hc2-deli56, gt_seo_hc2-deli57, gt_seo_hc2-deli58,
                 gt_seo_hc2-deli59.

    MOVE-CORRESPONDING gt_seo_hc2 TO gt_seo_hc.
    gt_seo_hc-ile01 = gt_seo_hc2-ile01.
    gt_seo_hc-ism01 = gt_seo_hc2-ism01.
    gt_seo_hc-ile01 = gt_seo_hc2-ile02.
    gt_seo_hc-ism01 = gt_seo_hc2-ism02.
    gt_seo_hc-ile01 = gt_seo_hc2-ile03.
    gt_seo_hc-ism01 = gt_seo_hc2-ism03.
    gt_seo_hc-ile01 = gt_seo_hc2-ile04.
    gt_seo_hc-ism01 = gt_seo_hc2-ism04.
    gt_seo_hc-ile01 = gt_seo_hc2-ile05.
    gt_seo_hc-ism01 = gt_seo_hc2-ism05.
    gt_seo_hc-ile01 = gt_seo_hc2-ile06.
    gt_seo_hc-ism01 = gt_seo_hc2-ism06.
    gt_seo_hc-ofmne = gt_seo_hc2-ofmne.
    gt_seo_hc-ofmnw = gt_seo_hc2-ofmnw.
    gt_seo_hc-iprz1 = gt_seo_hc2-iprz1.
    gt_seo_hc-ipre1 = gt_seo_hc2-ipre1.
    gt_seo_hc-rmnga = gt_seo_hc2-rmnga.
    gt_seo_hc-idaur = gt_seo_hc2-idaur.
    gt_seo_hc-idaue = gt_seo_hc2-idaue.
    gt_seo_hc-iserh = gt_seo_hc2-iserh.
    gt_seo_hc-zeier = gt_seo_hc2-zeier.

***
    CLEAR gt_seo_hc2-ismnw_2.
    IF NOT gt_seo_hc2-ismnu IS INITIAL   AND
      gt_seo_hc2-ismne NE gt_seo_hc2-ismnu.
      CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
        EXPORTING
          input    = gt_seo_hc2-ismnw
          unit_in  = gt_seo_hc2-ismne
          unit_out = gt_seo_hc2-ismnu
        IMPORTING
          output   = gt_seo_hc2-ismnw_2.
      gt_seo_hc-ismne = gt_seo_hc2-ismnu.
    ELSE.
      gt_seo_hc-ismne = gt_seo_hc2-ismne.
    ENDIF.

***
    IF gt_seo_hc2-ismnw_2 IS INITIAL.
      gt_seo_hc-ismnw = gt_seo_hc2-ismnw.
    ELSE.
      gt_seo_hc-ismnw = gt_seo_hc2-ismnw_2.
    ENDIF.
    gt_seo_hc-catsprice = gt_seo_hc2-catsprice.
    gt_seo_hc-catstcurr = gt_seo_hc2-catstcurr.
    gt_seo_hc-catspeinh = gt_seo_hc2-catspeinh.

    SELECT SINGLE arbpl FROM crhd INTO gt_seo_hc-arbpl
      WHERE objty = 'A'
        AND objid = gt_seo_hc2-arbid.

*    READ TABLE gt_afvv WITH TABLE KEY aufpl = gt_seo_hc2-aufpl
*                                      aplzl = gt_seo_hc2-aplzl.
*    IF sy-subrc = 0.
*      gt_seo_hc-isdd = gt_afvv-isdd.
*      gt_seo_hc-isdz = gt_afvv-isdz.
*      gt_seo_hc-iedd = gt_afvv-iedd.
*      gt_seo_hc-iedz = gt_afvv-iedz.
*    ELSE.
*      CLEAR: gt_seo_hc-isdd,
*             gt_seo_hc-isdz,
*             gt_seo_hc-iedd,
*             gt_seo_hc-iedz.
*    ENDIF.

    APPEND gt_seo_hc.

  ENDLOOP.

* Legacy Cost
  PERFORM add_legacy_cost.

ENDFORM.                    "get_data

*&---------------------------------------------------------------------*
*&      Form  download_files
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_files.

  DATA: file TYPE string.
  DATA: lv_selections TYPE string.

  lv_selections = p_bukrs.
  IF p_werks IS NOT INITIAL.
    CONCATENATE lv_selections p_werks INTO lv_selections SEPARATED BY '_'.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_selections p_vkorg INTO lv_selections SEPARATED BY '_'.
  ENDIF.


  PERFORM header_fill.

  IF sy-batch = 'X'.
    REPLACE 'xxx' IN g_directory WITH p_logsys(3).

* Header
*    CONCATENATE g_directory c_rec_o '_' p_werks '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_o '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

*   Header
    LOOP AT gt_seo_hc_c.
      TRANSFER gt_seo_hc_c TO g_ofile.
    ENDLOOP.

*   Data
    LOOP AT gt_seo_hc.
      TRANSFER gt_seo_hc TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***

  ELSE.
    file = o_filet.
*    CONCATENATE file '_' p_werks '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_seo_hc_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_seo_hc
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

  ENDIF.

ENDFORM.                    "download_file

*&---------------------------------------------------------------------*
*&      Form  header_fill
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM header_fill.

  MOVE '|' TO: gt_seo_hc_c-deli1, gt_seo_hc_c-deli2, gt_seo_hc_c-deli3,
               gt_seo_hc_c-deli4, gt_seo_hc_c-deli5, gt_seo_hc_c-deli6,
               gt_seo_hc_c-deli7, gt_seo_hc_c-deli8, gt_seo_hc_c-deli9,
               gt_seo_hc_c-deli10, gt_seo_hc_c-deli11, gt_seo_hc_c-deli12,
               gt_seo_hc_c-deli13, gt_seo_hc_c-deli14, gt_seo_hc_c-deli15,
               gt_seo_hc_c-deli16, gt_seo_hc_c-deli17, gt_seo_hc_c-deli18,
               gt_seo_hc_c-deli19, gt_seo_hc_c-deli20, gt_seo_hc_c-deli21,
               gt_seo_hc_c-deli22, gt_seo_hc_c-deli23, gt_seo_hc_c-deli24,
               gt_seo_hc_c-deli23, gt_seo_hc_c-deli24, gt_seo_hc_c-deli25,
               gt_seo_hc_c-deli26, gt_seo_hc_c-deli27, gt_seo_hc_c-deli28,
               gt_seo_hc_c-deli29, gt_seo_hc_c-deli30, gt_seo_hc_c-deli31,
               gt_seo_hc_c-deli32, gt_seo_hc_c-deli33, gt_seo_hc_c-deli34,
               gt_seo_hc_c-deli35, gt_seo_hc_c-deli36, gt_seo_hc_c-deli37,
               gt_seo_hc_c-deli38, gt_seo_hc_c-deli39, gt_seo_hc_c-deli40,
               gt_seo_hc_c-deli41, gt_seo_hc_c-deli42,   "gt_seo_hc_c-deli43,
               gt_seo_hc_c-deli44, gt_seo_hc_c-deli45, gt_seo_hc_c-deli46,
               gt_seo_hc_c-deli47, gt_seo_hc_c-deli48, gt_seo_hc_c-deli49,
               gt_seo_hc_c-deli50, gt_seo_hc_c-deli51, gt_seo_hc_c-deli52,
               gt_seo_hc_c-deli53, gt_seo_hc_c-deli54, gt_seo_hc_c-deli55,
               gt_seo_hc_c-deli56, gt_seo_hc_c-deli57, gt_seo_hc_c-deli58,
               gt_seo_hc_c-deli59.

  gt_seo_hc_c-aufnr = 'AUFNR'.
  gt_seo_hc_c-vornr = 'VORNR'.
  gt_seo_hc_c-rueck = 'RUECK'.
  gt_seo_hc_c-rmzhl = 'RMZHL'.
  gt_seo_hc_c-ersda = 'ERSDA'.
  gt_seo_hc_c-arbpl = 'ARBPL'.
  gt_seo_hc_c-werks = 'WERKS'.
  gt_seo_hc_c-ismnw = 'ISMNW'.
  gt_seo_hc_c-ismne = 'ISMNE'.
  gt_seo_hc_c-learr = 'LEARR'.
  gt_seo_hc_c-budat = 'BUDAT'.
  gt_seo_hc_c-aueru = 'AUERU'.
  gt_seo_hc_c-lek01 = 'LEK01'.
  gt_seo_hc_c-ofmnw = 'OFMNW'.
  gt_seo_hc_c-ofmne = 'OFMNE'.
  gt_seo_hc_c-ausor = 'AUSOR'.
  gt_seo_hc_c-stndr = 'STNDR'.
  gt_seo_hc_c-arbid = 'ARBID'.
  gt_seo_hc_c-ltxa1 = 'LTXA1'.
  gt_seo_hc_c-txtsp = 'TXTSP'.
  gt_seo_hc_c-iserh = 'ISERH'.
  gt_seo_hc_c-zeier = 'ZEIER'.
  gt_seo_hc_c-ile01 = 'ILE01'.
  gt_seo_hc_c-ism01 = 'ISM01'.
  gt_seo_hc_c-ile02 = 'ILE02'.
  gt_seo_hc_c-ism02 = 'ISM02'.
  gt_seo_hc_c-ile03 = 'ILE03'.
  gt_seo_hc_c-ism03 = 'ISM03'.
  gt_seo_hc_c-ile04 = 'ILE04'.
  gt_seo_hc_c-ism04 = 'ISM04'.
  gt_seo_hc_c-ile05 = 'ILE05'.
  gt_seo_hc_c-ism05 = 'ISM05'.
  gt_seo_hc_c-ile06 = 'ILE06'.
  gt_seo_hc_c-ism06 = 'ISM06'.
  gt_seo_hc_c-abarb = 'ABARB'.
  gt_seo_hc_c-idaur = 'IDAUR'.
  gt_seo_hc_c-idaue = 'IDAUE'.
  gt_seo_hc_c-logrp = 'LOGRP'.
  gt_seo_hc_c-belnr_ist = 'BELNR_IST'.
  gt_seo_hc_c-belnr_umb = 'BELNR_UMB'.
  gt_seo_hc_c-rmnga = 'RMNGA'.
  gt_seo_hc_c-catsbelnr = 'CATSBELNR'.
*  gt_seo_hc_c-erzet = 'ERZET'.
  gt_seo_hc_c-catsprice = 'CATSPRICE'.
  gt_seo_hc_c-catstcurr = 'CATSTCURR'.
  gt_seo_hc_c-catspeinh = 'CATSPEINH'.
  gt_seo_hc_c-bemot = 'BEMOT'.
  gt_seo_hc_c-iprz1 = 'IPRZ1'.
  gt_seo_hc_c-ipre1 = 'IPRE1'.
  gt_seo_hc_c-iprk1 = 'IPRK1'.
  gt_seo_hc_c-stokz = 'STOKZ'.
  gt_seo_hc_c-stzhl = 'STZHL'.
  gt_seo_hc_c-grund = 'GRUND'.
  gt_seo_hc_c-isdd  = 'ISDD'.
  gt_seo_hc_c-isdz  = 'ISDZ'.
  gt_seo_hc_c-iedd  = 'IEDD'.
  gt_seo_hc_c-iedz  = 'IEDZ'.
  gt_seo_hc_c-tkf  = 'LEGACY_COST'.
  gt_seo_hc_c-waers  = 'WAERS'.
  APPEND gt_seo_hc_c.

  gt_seo_hc_c-aufnr = 'Serv. Orders'.
  gt_seo_hc_c-vornr = 'Operation'.
  gt_seo_hc_c-rueck = 'Confirm.'.
  gt_seo_hc_c-rmzhl = 'Counter'.
  gt_seo_hc_c-ersda = 'Date'.
  gt_seo_hc_c-arbpl = 'Work Ctr'.
  gt_seo_hc_c-werks = 'Plant'.
  gt_seo_hc_c-ismnw = 'Actual Work'.
  gt_seo_hc_c-ismne = 'UoM'.
  gt_seo_hc_c-learr = 'Act. Type'.
  gt_seo_hc_c-budat = 'Post. Date'.
  gt_seo_hc_c-aueru = 'Final'.
  gt_seo_hc_c-lek01 = 'Remain.'.
  gt_seo_hc_c-ofmnw = 'Remain. Work'.
  gt_seo_hc_c-ofmne = 'UoM'.
  gt_seo_hc_c-ausor = 'Clear O.R.'.
  gt_seo_hc_c-stndr = 'Stand.'.
  gt_seo_hc_c-arbid = 'Object ID'.
  gt_seo_hc_c-ltxa1 = 'Confirmation Text'.
  gt_seo_hc_c-txtsp = 'Lang.'.
  gt_seo_hc_c-iserh = 'Break Time'.
  gt_seo_hc_c-zeier = 'UoM'.
  gt_seo_hc_c-ile01 = 'UoM1'.
  gt_seo_hc_c-ism01 = 'Activity1'.
  gt_seo_hc_c-ile02 = 'UoM2'.
  gt_seo_hc_c-ism02 = 'Activity2'.
  gt_seo_hc_c-ile03 = 'UoM3'.
  gt_seo_hc_c-ism03 = 'Activity3'.
  gt_seo_hc_c-ile04 = 'UoM4'.
  gt_seo_hc_c-ism04 = 'Activity4'.
  gt_seo_hc_c-ile05 = 'UoM5'.
  gt_seo_hc_c-ism05 = 'Activity5'.
  gt_seo_hc_c-ile06 = 'UoM6'.
  gt_seo_hc_c-ism06 = 'Activity6'.
  gt_seo_hc_c-abarb = 'Degree'.
  gt_seo_hc_c-idaur = 'Duration'.
  gt_seo_hc_c-idaue = 'UoM'.
  gt_seo_hc_c-logrp = 'Wage Grp'.
  gt_seo_hc_c-belnr_ist = 'Document'.
  gt_seo_hc_c-belnr_umb = 'Document'.
  gt_seo_hc_c-rmnga = 'Rework qty'.
  gt_seo_hc_c-catsbelnr = 'Document'.
*  gt_seo_hc_c-erzet = 'Entry time'.
  gt_seo_hc_c-catsprice = 'Price'.
  gt_seo_hc_c-catstcurr = 'Curr.'.
  gt_seo_hc_c-catspeinh = 'Unit'.
  gt_seo_hc_c-bemot = 'Acc. Ind.'.
  gt_seo_hc_c-iprz1 = 'Current qty'.
  gt_seo_hc_c-ipre1 = 'UoM'.
  gt_seo_hc_c-iprk1 = 'No remain. qty'.
  gt_seo_hc_c-stokz = 'Reversed'.
  gt_seo_hc_c-stzhl = 'Cancell.'.
  gt_seo_hc_c-grund = 'Reason for Var.'.
  gt_seo_hc_c-isdd  = 'Act. Start Date'.
  gt_seo_hc_c-isdz  = 'Act. Start Time'.
  gt_seo_hc_c-iedd  = 'Act. Fin. Date'.
  gt_seo_hc_c-iedz  = 'Act. Fin. Time'.
  gt_seo_hc_c-tkf  = 'Legacy Cost'.
  gt_seo_hc_c-waers  = 'Currency'.
  APPEND gt_seo_hc_c.

ENDFORM.                    "header_fill

*&---------------------------------------------------------------------*
*&      Form  ADD_LEGACY_COST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM add_legacy_cost .

  DATA: lt_afru TYPE SORTED TABLE OF gty_afru
                WITH NON-UNIQUE KEY aufnr ismnw learr,
        lt_crco TYPE SORTED TABLE OF gty_crco
                WITH NON-UNIQUE KEY objid lstar endda begda,
        lt_csla TYPE SORTED TABLE OF csla
                WITH UNIQUE KEY kokrs lstar datbi,
        lt_cssl TYPE TABLE OF cssl,
        lt_cost TYPE TABLE OF cost,
        lt_tka01 TYPE TABLE OF tka01.
  DATA: lv_gjahr TYPE gjahr.

  FIELD-SYMBOLS: <ls_afru> TYPE gty_afru,
                 <ls_crco> TYPE gty_crco,
                 <ls_csla> TYPE csla,
                 <ls_cssl> TYPE cssl,
                 <ls_cost> TYPE cost,
                 <ls_tka01> TYPE tka01.
  FIELD-SYMBOLS: <ls_seo_hc> LIKE LINE OF gt_seo_hc.

* Select all necessary data
  CHECK gt_seo_hc[] IS NOT INITIAL.

  SELECT aufnr budat arbid werks ismnw ismne learr grund stzhl
         rueck rmzhl   " MOD-001 Selecting these fields also from AFRU
    FROM afru
    INTO TABLE lt_afru
    FOR ALL ENTRIES IN gt_seo_hc
    WHERE aufnr EQ gt_seo_hc-aufnr.

  CHECK lt_afru[] IS NOT INITIAL.

  SELECT objid endda begda kokrs kostl lstar
    FROM crco
    INTO TABLE lt_crco
    FOR ALL ENTRIES IN lt_afru
    WHERE objty EQ 'A'
      AND objid EQ lt_afru-arbid
*      AND lstar EQ lt_afru-learr
      AND begda LE lt_afru-budat
      AND endda GE lt_afru-budat.

  CHECK lt_crco[] IS NOT INITIAL.

  SELECT * FROM csla
    INTO TABLE lt_csla
    FOR ALL ENTRIES IN lt_crco
    WHERE kokrs EQ lt_crco-kokrs.
*      AND lstar EQ lt_crco-lstar.

  SELECT * FROM cssl
    INTO TABLE lt_cssl
    FOR ALL ENTRIES IN lt_crco
    WHERE kokrs EQ lt_crco-kokrs
      AND kostl EQ lt_crco-kostl.
*      AND lstar EQ lt_crco-lstar.
  SORT lt_cssl ASCENDING BY kokrs kostl lstar gjahr.

  IF lt_cssl[] IS NOT INITIAL.
    SELECT * FROM cost
      INTO TABLE lt_cost
      FOR ALL ENTRIES IN lt_cssl
      WHERE objnr EQ lt_cssl-objnr.
    SORT lt_cost ASCENDING BY objnr gjahr.
  ENDIF.

  SELECT * FROM tka01 INTO TABLE lt_tka01 ORDER BY kokrs ASCENDING.

* Calculate Legacy Cost and currency
  LOOP AT gt_seo_hc ASSIGNING <ls_seo_hc>.
    lv_gjahr = <ls_seo_hc>-budat(4).

    READ TABLE lt_afru ASSIGNING <ls_afru>
      WITH KEY aufnr = <ls_seo_hc>-aufnr
*               ismnw = <ls_seo_hc>-ismnw " MOD-001 Commenting this
*               learr = <ls_seo_hc>-learr " MOD-001 Commenting this
                rueck = <ls_seo_hc>-rueck " MOD-001 Now a check on RUECK and
                rmzhl = <ls_seo_hc>-rmzhl." and RMZHL is done as we are facing some inconsistency using ISMNW.
*      BINARY SEARCH. "MOD-001 As the key fields are no longer used as LT_AFRU is sorted table we cant do binary search.
    CHECK sy-subrc EQ 0.

    LOOP AT lt_crco ASSIGNING <ls_crco>
      WHERE objid EQ <ls_afru>-arbid
        AND lstar EQ <ls_afru>-learr
        AND endda GE <ls_seo_hc>-budat
        AND begda LE <ls_seo_hc>-budat.
      EXIT.
    ENDLOOP.
    IF sy-subrc NE 0.
      LOOP AT lt_crco ASSIGNING <ls_crco>
        WHERE objid EQ <ls_afru>-arbid
          AND lstar EQ ''
          AND endda GE <ls_seo_hc>-budat
          AND begda LE <ls_seo_hc>-budat.
        EXIT.
      ENDLOOP.
    ENDIF.
    CHECK sy-subrc EQ 0.

    "Determine currency
    LOOP AT lt_csla ASSIGNING <ls_csla>
      WHERE kokrs EQ <ls_crco>-kokrs
        AND lstar EQ <ls_afru>-learr
        AND datbi GE <ls_afru>-budat
        AND datab LE <ls_afru>-budat.
      EXIT.
    ENDLOOP.
*    IF sy-subrc NE 0.
*      LOOP AT lt_csla ASSIGNING <ls_csla>
*        WHERE kokrs EQ <ls_crco>-kokrs
*          AND lstar EQ ''
*          AND datbi GE <ls_afru>-budat
*          AND datab LE <ls_afru>-budat.
*        EXIT.
*      ENDLOOP.
*    ENDIF.
    IF sy-subrc EQ 0.
      READ TABLE lt_tka01 ASSIGNING <ls_tka01>
        WITH KEY kokrs = <ls_crco>-kokrs
        BINARY SEARCH.
      IF sy-subrc EQ 0.
        <ls_seo_hc>-waers = <ls_tka01>-waers.
      ENDIF.
    ENDIF.

    "Determine legacy cost
    READ TABLE lt_cssl ASSIGNING <ls_cssl>
      WITH KEY kokrs = <ls_crco>-kokrs
               kostl = <ls_crco>-kostl
               lstar = <ls_afru>-learr
               gjahr = lv_gjahr
      BINARY SEARCH.
*    IF sy-subrc NE 0.
*      READ TABLE lt_cssl ASSIGNING <ls_cssl>
*        WITH KEY kokrs = <ls_crco>-kokrs
*                 kostl = <ls_crco>-kostl
*                 lstar = ''
*        BINARY SEARCH.
*    ENDIF.
    CHECK sy-subrc EQ 0.

    READ TABLE lt_cost ASSIGNING <ls_cost>
      WITH KEY objnr = <ls_cssl>-objnr
               gjahr = lv_gjahr
      BINARY SEARCH.
    CHECK sy-subrc EQ 0.

    PERFORM get_price USING <ls_cost> <ls_afru> <ls_csla>
                      CHANGING <ls_seo_hc>.

  ENDLOOP. "gt_seo_hc ASSIGNING <ls_seo_hc>

ENDFORM.                    " ADD_LEGACY_COST

*&---------------------------------------------------------------------*
*&      Form  GET_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_<LS_COST>  text
*      -->P_<LS_AFRU>  text
*      -->P_<LS_CSLA>  text
*      <--P_<LS_SEO_HC>_TKF  text
*----------------------------------------------------------------------*
FORM get_price  USING    us_cost TYPE cost
                         us_afru TYPE gty_afru
                         us_csla TYPE csla
                CHANGING cs_seo_hc LIKE LINE OF gt_seo_hc.

  DATA: lv_counter TYPE n LENGTH 3,
        lv_tkfnnn TYPE string,
        lv_tkennn TYPE string.
  DATA: lv_tkf TYPE tkfxxx,
        lv_tke TYPE tkexxx VALUE 1,
        lv_add TYPE tkfxxx,
        lv_amount TYPE i.
  DATA: ls_t006_ismne TYPE t006,
        ls_t006_leinh TYPE t006.

  FIELD-SYMBOLS: <lv_tkfnnn> TYPE tkfxxx,
                 <lv_tkennn> TYPE tkexxx.
  FIELD-SYMBOLS: <ls_t006> TYPE t006.

* Calculate cost
  DO 16 TIMES.
    ADD 1 TO lv_counter.
    CONCATENATE 'US_COST-TKF' lv_counter INTO lv_tkfnnn.
    ASSIGN (lv_tkfnnn) TO <lv_tkfnnn>.
    CHECK sy-subrc EQ 0.

    CONCATENATE 'US_COST-TKE' lv_counter INTO lv_tkennn.
    ASSIGN (lv_tkennn) TO <lv_tkennn>.
    CHECK sy-subrc EQ 0.

    CHECK <lv_tkfnnn> IS NOT INITIAL.
    ADD 1 TO lv_amount.
    lv_add = lv_tke * <lv_tkfnnn>.  "amount to add
    IF <lv_tkennn> GT lv_tke.
      lv_tkf = lv_add + ( <lv_tkennn> * lv_tkf / lv_tke ). "modify total
      lv_tke = <lv_tkennn>. "adjust price unit
    ELSE.
      lv_tkf = lv_tkf + lv_add. "modify total
    ENDIF.
  ENDDO.

  lv_tkf = lv_tkf / lv_amount.

* Calculate legacy cost
  cs_seo_hc-tkf = us_afru-ismnw * lv_tkf / lv_tke.

** Add '-' when necessary
  IF cs_seo_hc-stzhl CN '0 '.
    CONCATENATE '-' cs_seo_hc-tkf INTO cs_seo_hc-tkf.
    CONCATENATE '-' cs_seo_hc-ismnw INTO cs_seo_hc-ismnw.
    CONDENSE: cs_seo_hc-tkf NO-GAPS, cs_seo_hc-ismnw NO-GAPS.
  ENDIF.

* Convert to proper unit
  IF us_afru-ismne NE us_csla-leinh.
    DO 1 TIMES.
      SELECT SINGLE * FROM t006
        INTO ls_t006_ismne
        WHERE msehi EQ us_afru-ismne.
      CHECK sy-subrc EQ 0.
      SELECT SINGLE * FROM t006
        INTO ls_t006_leinh
        WHERE msehi EQ us_csla-leinh.
      CHECK sy-subrc EQ 0.
      cs_seo_hc-tkf = cs_seo_hc-tkf * ( ls_t006_ismne-zaehl * ls_t006_leinh-nennr ) / ( ls_t006_ismne-nennr * ls_t006_leinh-zaehl ).
    ENDDO.
  ENDIF.

ENDFORM.                    " GET_PRICE

*Text symbol text£º
*001:Selection Screen Input
*002:Remarks
*C01:* If started in background, files are stored on the application server
*C02:* /var/load/xxx/UK/read/
*C03:* xxx = logical system
*E02:Planning plant does not exist
*E03:No authorization for plant :
*E04:Open dataset failed for :
*E05:Close dataset failed for :
*I01:No maintenance plans selected !
*I02:No variant table for Central Task Lists found (CU60)

*I03:Could not find caracteristic :
*Selection text£º
*O_FILET:        Filename Order Operations
*P_BUKRS:D       .
*P_VKORG:D       .
*P_WERKS:        Plant
*S_AEDAT:        Date of last change
*S_AUART:        Order Type
*S_AUFNR:        Order Number
*S_ERDAT:        Creation Date
*S_ISDD:        Actual Start Date (Conf.)
*S_VTWEG:D       .
