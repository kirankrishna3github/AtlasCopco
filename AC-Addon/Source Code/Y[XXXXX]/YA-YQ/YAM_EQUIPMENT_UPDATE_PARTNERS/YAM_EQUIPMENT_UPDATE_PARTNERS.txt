*----------------------------------------------------------------------
* PROGRAM ID           : YAM_EQUIPMENT_UPDATE_PARTNERS                 *
* PROGRAM TITLE        : Program to update partners in equipments      *
* AUTHOR               : Uzzawal                                       *
* DATE                 : 25/01/2010                                    *
* DEVELOPMENT ID       : CR0493                                        *
* CHANGE REQUEST NUMBER: CD1K958524,CD1K958612                         *
* PROGRAM DESCRIPTION  :                                               *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD. 001 08/09/2011  Anson     Add func for user to maintain tab
*----------------------------------------------------------------------*
REPORT  yam_equipment_update_partners NO STANDARD PAGE HEADING
                             LINE-SIZE 200.

TABLES : likp , vbfa , vbap , ser01 , vbpa , objk , ihpa ,
                iloa , equz ,YSE_CM_SHTA_HKGA.
TABLES : sscrfields.                   "as080911

*- SELECTION SCREEN---------------------------------------------------
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
SELECT-OPTIONS s_wadat    FOR  likp-wadat_ist.
SELECT-OPTIONS s_vkorg    FOR  likp-vkorg OBLIGATORY.
SELECT-OPTIONS s_tplnr    FOR  iloa-tplnr .
SELECT-OPTIONS s_vbeln    FOR  likp-vbeln.
SELECTION-SCREEN END OF BLOCK b1 .

SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME .
PARAMETERS:    p_test     AS CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN END OF BLOCK b2.

SELECTION-SCREEN FUNCTION KEY 1.       "as080911
*&---------------------------------------------------------------------*
*&      Internal tables
*&---------------------------------------------------------------------*
DATA : BEGIN OF it_likp OCCURS 0,
       vbeln LIKE likp-vbeln,
       vkorg LIKE likp-vkorg,
       wadat LIKE likp-wadat_ist,
       END OF it_likp.

DATA : BEGIN OF it_vbfa OCCURS 0,
       vbelv LIKE vbfa-vbelv,
       posnv LIKE vbfa-posnv,
       vbeln LIKE vbfa-vbeln,
       posnn LIKE vbfa-posnn,
       vbtyp_v LIKE vbfa-vbtyp_v,
       END OF it_vbfa.

DATA : BEGIN OF it_vbap OCCURS 0,
       vbeln LIKE vbap-vbeln,
       posnr LIKE vbap-posnr,
       werks LIKE vbap-werks,
       END OF it_vbap.

DATA : BEGIN OF it_vbap_h OCCURS 0,
       vbeln LIKE vbap-vbeln,
       posnr LIKE vbap-posnr,
       werks LIKE vbap-werks,
       END OF it_vbap_h.

DATA : BEGIN OF it_ser01 OCCURS 0,
       obknr   LIKE ser01-obknr,
       lief_nr LIKE ser01-lief_nr,
       posnr   LIKE ser01-posnr,
       vbtyp   LIKE ser01-vbtyp,
       END OF it_ser01.

DATA : BEGIN OF it_objk OCCURS 0,
       obknr   LIKE objk-obknr,
       equnr   LIKE objk-equnr,
       END OF it_objk.

DATA : BEGIN OF it_objk1 OCCURS 0,
       objnr   LIKE ihpa-objnr,
       END OF it_objk1.

DATA : BEGIN OF it_vbpa OCCURS 0,
       vbeln LIKE vbpa-vbeln,
       posnr LIKE vbpa-posnr,
       parvw LIKE vbpa-parvw,
       kunnr LIKE vbpa-kunnr,
       END OF it_vbpa.

DATA : BEGIN OF it_vbpa_h OCCURS 0,
       vbeln LIKE vbpa-vbeln,
       posnr LIKE vbpa-posnr,
       parvw LIKE vbpa-parvw,
       kunnr LIKE vbpa-kunnr,
       END OF it_vbpa_h.

DATA : BEGIN OF it_ihpa OCCURS 0,
       objnr LIKE ihpa-objnr,
       parvw LIKE ihpa-parvw,
       parnr LIKE ihpa-parnr,
       kzloesch like ihpa-KZLOESCH,
       END OF it_ihpa.

DATA : BEGIN OF it_ihpa_h OCCURS 0,
       objnr LIKE ihpa-objnr,
       parvw LIKE ihpa-parvw,
       parnr LIKE ihpa-parnr,
       kzloesch like ihpa-KZLOESCH,
       END OF it_ihpa_h.

DATA : BEGIN OF it_new_table OCCURS 0,
*       parvw LIKE yse_cm_shta_hkga-parvw,
       kunnr_hkga LIKE yse_cm_shta_hkga-kunnr_hkga,
       kunnr_shta LIKE yse_cm_shta_hkga-kunnr_shta,
       END OF it_new_table.

DATA : BEGIN OF it_output OCCURS 0,
       vbeln LIKE vbfa-vbeln,
       posnn LIKE vbfa-posnn,
       vbelv LIKE vbfa-vbelv,
       posnv LIKE vbfa-posnv,
       werks LIKE vbap-werks,
       equnr LIKE objk-equnr,
       parvw LIKE vbpa-parvw,
       kunnr LIKE vbpa-kunnr,
       parvw1 LIKE ihpa-parvw,
       parnr1 LIKE ihpa-parnr,
       parvw2 LIKE ihpa-parvw,
       parnr2 LIKE ihpa-parnr,
*       parvw3 LIKE ihpa-parvw, "* code added by kiran
*       kunnr3 LIKE vbpa-kunnr, "* code added by kiran
       objnr  LIKE ihpa-objnr,
       flag   LIKE bseg-shkzg,
       flag2  TYPE loekz,
       END OF it_output.

DATA : BEGIN OF it_equz OCCURS 0,
       equnr LIKE equz-equnr,
       iloan LIKE equz-iloan,
       END OF it_equz.

DATA : BEGIN OF it_iloa OCCURS 0,
       iloan LIKE iloa-iloan,
       tplnr LIKE iloa-tplnr,
       END OF it_iloa.

DATA : BEGIN OF it_check OCCURS 0,
       kunnr LIKE vbpa-kunnr,
       END OF it_check.

DATA: BEGIN OF gt_messtab OCCURS 0.
        INCLUDE STRUCTURE merrdat.
DATA: END   OF gt_messtab.

*&---------------------------------------------------------------------*
*&      Data Declaration
*&---------------------------------------------------------------------*
DATA : wa_likp LIKE it_likp,
       wa_check LIKE it_check,
       wa_vbfa LIKE it_vbfa,
       wa_vbap LIKE it_vbap,
       wa_vbap_h LIKE it_vbap_h,
       wa_vbpa LIKE it_vbpa,
       wa_objk LIKE it_objk,
       wa_objk1 LIKE it_objk1,
       wa_ihpa LIKE it_ihpa,
       wa_ihpa_h LIKE it_ihpa_h,
       wa_vbpa_h LIKE it_vbpa_h,
       wa_ser01 LIKE it_ser01,
       wa_new_table LIKE it_new_table,
       wa_output LIKE it_output,
       wa_equz LIKE it_equz,
       wa_iloa LIKE it_iloa.

DATA : c_h  LIKE vbap-werks VALUE 'HK90',
       c_ze LIKE vbpa-parvw VALUE 'ZE',
       c_ag LIKE vbpa-parvw VALUE 'AG',
       v_objnr LIKE ihpa-objnr,
       lv_objnr LIKE ihpa-objnr,
       g_text LIKE t100-text,
       g_mstring(100) TYPE c,
       c_type_a   TYPE bapiret2-type     VALUE 'A',
       c_type_e   TYPE bapiret2-type     VALUE 'E',
       c_en       TYPE spras             VALUE 'E',
       c_01(3)    TYPE c                 VALUE '001',
       c_x(1)     type c                 value 'X'.


DATA: struct_bdcdata  TYPE bdcdata.
DATA: i_bdcdata  TYPE STANDARD TABLE OF bdcdata.

FIELD-SYMBOLS : <fs_output> LIKE it_output.
*&---------------------------------------------------------------------*
*--- Type pools
*&---------------------------------------------------------------------*
TYPE-POOLS:
  slis.
*&---------------------------------------------------------------------*
*--- Internal tables
*&---------------------------------------------------------------------*
DATA:
  it_fieldcat       TYPE slis_t_fieldcat_alv,
  it_sort           TYPE slis_t_sortinfo_alv,
  x_repid      LIKE sy-repid.
*&---------------------------------------------------------------------*
*--- Structures
*&---------------------------------------------------------------------*
DATA:
  gv_variant        LIKE disvariant,
  gs_layout         TYPE slis_layout_alv,
  ls_fieldcat       TYPE slis_fieldcat_alv.
*&---------------------------------------------------------------------*
*--- Variables
*&---------------------------------------------------------------------*
DATA:
  h_exit            TYPE c,
  lv_mode(1)            TYPE c VALUE 'N'.
*&---------------------------------------------------------------------*
*--- Variables with default value
*&---------------------------------------------------------------------*
DATA:
  g_user_command    TYPE slis_formname  VALUE 'USER_COMMAND',
  g_variant_save    TYPE c              VALUE 'U'.
*&---------------------------------------------------------------------*
*--- Constants
*&---------------------------------------------------------------------*
CONSTANTS:
  c_value(10)  TYPE c              VALUE 'Values'.
********** MOD.001 Begin at 08/09/2011 **********
*----------------------------------------------------------------------*
*       INITIALIZATION
*----------------------------------------------------------------------*
INITIALIZATION.

  MOVE 'Customer Mapping' TO sscrfields-functxt_01.
*----------------------------------------------------------------------*
*       AT SELECTION-SCREEN
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.

  CASE sscrfields-ucomm.
    WHEN 'FC01'.
      PERFORM customer_mapping.
    WHEN OTHERS.
  ENDCASE.
********** MOD.001 End   at 08/09/2011 **********
*&---------------------------------------------------------------------*
*&      START-OF-SELECTION
*&---------------------------------------------------------------------*
START-OF-SELECTION.
  PERFORM: initialize_data,
           select_data.
  IF NOT it_vbap_h[] IS INITIAL.
    PERFORM select_data_h.
    PERFORM process_data_h.
  ELSE.
    PERFORM process_data.
  ENDIF.
  PERFORM check_func_loc.
  PERFORM : display_data.
*&---------------------------------------------------------------------*
*&      Form  INITIALIZE_DATA
*&---------------------------------------------------------------------*
FORM initialize_data .
  CLEAR : wa_likp , wa_vbfa , wa_vbap , wa_vbpa ,wa_ser01,
          wa_objk , wa_objk1 , wa_ihpa , wa_output, wa_vbap_h,
          wa_new_table, wa_ihpa_h,wa_vbpa_h.

ENDFORM.                    " INITIALIZE_DATA
*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
FORM select_data .
  SELECT vbeln vkorg wadat_ist
           INTO TABLE it_likp
             FROM likp
              WHERE vkorg IN s_vkorg
                AND wadat_ist IN s_wadat
                AND vbeln IN s_vbeln.
  IF sy-subrc = 0.
    SORT it_likp BY vbeln.
  ENDIF.
*
  IF NOT it_likp[] IS INITIAL.
    SELECT  vbelv
            posnv
            vbeln
            posnn
            vbtyp_v FROM vbfa
              INTO TABLE it_vbfa
              FOR ALL ENTRIES IN it_likp
              WHERE vbeln = it_likp-vbeln
                AND vbtyp_v = 'C'.
    IF sy-subrc = 0.
      SORT it_vbfa BY vbelv posnv.
    ENDIF.
  ENDIF.
*
  IF NOT it_vbfa[] IS INITIAL.
    SELECT  vbeln
            posnr
            werks FROM vbap
              INTO TABLE it_vbap_h
              FOR ALL ENTRIES IN it_vbfa
              WHERE vbeln = it_vbfa-vbelv
                AND posnr = it_vbfa-posnv
                AND werks = c_h.
    IF sy-subrc = 0.
      SORT it_vbap_h BY vbeln posnr.
    ENDIF.
  ENDIF.
*
  IF NOT it_vbfa[] IS INITIAL.
    SELECT  vbeln
            posnr
            werks FROM vbap
              INTO TABLE it_vbap
              FOR ALL ENTRIES IN it_vbfa
              WHERE vbeln = it_vbfa-vbelv
                AND posnr = it_vbfa-posnv
                AND werks NE c_h.
    IF sy-subrc = 0.
      SORT it_vbap BY vbeln posnr.
    ENDIF.
  ENDIF.
*
  IF NOT it_vbfa[] IS INITIAL.
    SELECT  obknr
            lief_nr
            posnr
            vbtyp
            FROM ser01
              INTO TABLE it_ser01
              FOR ALL ENTRIES IN it_vbfa
              WHERE lief_nr = it_vbfa-vbeln
                AND posnr = it_vbfa-posnn
                AND vbtyp EQ 'J'.
    IF sy-subrc = 0.
      SORT it_ser01 BY obknr.
    ENDIF.
  ENDIF.
*
  IF NOT it_ser01[] IS INITIAL.
    SELECT obknr
           equnr
           INTO TABLE it_objk
           FROM objk
           FOR ALL ENTRIES IN it_ser01
           WHERE obknr = it_ser01-obknr.
    IF sy-subrc = 0.
      SORT it_objk BY equnr.
    ENDIF.
  ENDIF.
*
  IF NOT it_vbap[] IS INITIAL.
    SELECT  vbeln
            posnr
            parvw
            kunnr

           INTO TABLE it_vbpa
           FROM vbpa
           FOR ALL ENTRIES IN it_vbap
           WHERE vbeln = it_vbap-vbeln.
    IF sy-subrc = 0.
      SORT it_vbpa BY vbeln posnr.
    ENDIF.
  ENDIF.
ENDFORM.                    " SELECT_DATA
*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
FORM process_data .
  LOOP AT it_objk INTO wa_objk.
    CONCATENATE 'IE' wa_objk-equnr INTO wa_objk1-objnr.
    APPEND wa_objk1 TO it_objk1.
    CLEAR wa_objk1.
  ENDLOOP.
*
  IF NOT it_objk1[] IS INITIAL.
    SELECT objnr parvw parnr KZLOESCH
               INTO TABLE it_ihpa
                 FROM ihpa
                  FOR ALL ENTRIES IN it_objk1
                   WHERE objnr = it_objk1-objnr
                     AND ( parvw = 'WE'
                      OR   parvw = 'AG'
                      OR   parvw = 'RE'
                      OR   parvw = 'RG'
                      OR   parvw = 'ZE'
                      OR   parvw = 'ZD') .
    IF sy-subrc = 0.
      SORT it_ihpa BY objnr .
    ENDIF.
  ENDIF.
*
  LOOP AT it_likp INTO wa_likp.
    CLEAR wa_vbfa.
    READ TABLE it_vbfa INTO wa_vbfa WITH KEY vbeln = wa_likp-vbeln.
    IF sy-subrc = 0.
      CLEAR wa_vbap.
      READ TABLE it_vbap INTO wa_vbap WITH KEY vbeln = wa_vbfa-vbelv
                                               posnr = wa_vbfa-posnv.
      IF sy-subrc = 0.
        CLEAR wa_ser01.
        LOOP AT it_ser01 INTO wa_ser01 WHERE
               lief_nr =  wa_vbfa-vbeln.
*               AND posnr = wa_vbfa-posnn.
          IF sy-subrc = 0.
            CLEAR wa_objk.
            LOOP AT it_objk INTO wa_objk WHERE obknr =
             wa_ser01-obknr.
              IF sy-subrc = 0.
                wa_output-vbeln = wa_vbfa-vbeln.
                wa_output-posnn = wa_vbfa-posnn.
                wa_output-vbelv = wa_vbap-vbeln.
                wa_output-posnv = wa_vbap-posnr.
                wa_output-werks = wa_vbap-werks.
                wa_output-flag  = 'S'.
                wa_output-equnr = wa_objk-equnr.
*
                CLEAR wa_vbpa.
         READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_vbap-vbeln
                                                  posnr = wa_vbap-posnr
                                                  parvw = c_ze.
                IF sy-subrc = 0.
                  wa_output-parvw = wa_vbpa-parvw.
                  wa_output-kunnr = wa_vbpa-kunnr.
                ELSE.
                  CLEAR wa_vbpa.
         READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_vbap-vbeln
                                                  posnr = '000000'
                                                  parvw = c_ze.
                  IF sy-subrc = 0.
                    wa_output-parvw = wa_vbpa-parvw.
                    wa_output-kunnr = wa_vbpa-kunnr.
                  ENDIF.
                ENDIF.
                APPEND wa_output TO it_output.
                CLEAR : wa_output , sy-subrc.
** code added by kiran  - start
*        READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_vbap-vbeln
*                                                  posnr = wa_vbap-posnr
*                                                  parvw = c_ag.
*                IF sy-subrc = 0.
*                  wa_output-parvw3 = wa_vbpa-parvw.
*                  wa_output-kunnr3 = wa_vbpa-kunnr.
*                ELSE.
*                  CLEAR wa_vbpa.
*         READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_vbap-vbeln
*                                                  posnr = '000000'
*                                                  parvw = c_ag.
*                  IF sy-subrc = 0.
*                    wa_output-parvw3 = wa_vbpa-parvw.
*                    wa_output-kunnr3 = wa_vbpa-kunnr.
*                  ENDIF.
*                ENDIF.
*                APPEND wa_output TO it_output.
*                CLEAR wa_output.
** code added by kiran - end
              ENDIF.
            ENDLOOP.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDIF.
  ENDLOOP.
*
  LOOP AT it_output ASSIGNING <fs_output>.
    CLEAR : wa_ihpa , v_objnr.
    CONCATENATE 'IE' <fs_output>-equnr INTO v_objnr.
    READ TABLE it_ihpa INTO wa_ihpa WITH KEY objnr = v_objnr
                                             parvw = 'WE'
                                             KZLOESCH =  ' '.
    IF sy-subrc = 0.
      <fs_output>-parvw1 = wa_ihpa-parvw.
      <fs_output>-parnr1  = wa_ihpa-parnr.
      <fs_output>-objnr   = v_objnr.
    ENDIF.
*
    READ TABLE it_ihpa INTO wa_ihpa WITH KEY objnr = v_objnr
                                             parvw = 'AG'
                                             KZLOESCH =  ' '.
    IF sy-subrc = 0.
      <fs_output>-parvw2 = wa_ihpa-parvw.
      <fs_output>-parnr2  = wa_ihpa-parnr.
    ENDIF.

  ENDLOOP.
*
  DELETE it_output WHERE equnr = ' '.
  LOOP AT it_output INTO wa_output.
    IF wa_output-kunnr = wa_output-parnr2.
      DELETE it_output.
    ENDIF.
  ENDLOOP.
** code added by kiran
*  LOOP AT it_output INTO wa_output.
*    IF wa_output-kunnr = wa_output-kunnr3.
*      DELETE it_output.
*    ENDIF.
*  ENDLOOP.

ENDFORM.                    " PROCESS_DATA
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_DATA
*&---------------------------------------------------------------------*
FORM display_data .
  PERFORM fill_field_catalog.
  PERFORM change_catalog.
  PERFORM alv_output.
ENDFORM.                    " DISPLAY_DATA

*&---------------------------------------------------------------------*
*&      Form  FILL_FIELD_CATALOG
*&---------------------------------------------------------------------*
FORM fill_field_catalog .
  x_repid = sy-repid.
  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
    EXPORTING
      i_program_name         = x_repid
      i_internal_tabname     = 'IT_OUTPUT'
      i_inclname             = x_repid
    CHANGING
      ct_fieldcat            = it_fieldcat
    EXCEPTIONS
      inconsistent_interface = 1
      program_error          = 2
      OTHERS                 = 3.


ENDFORM.                    " FILL_FIELD_CATALOG
*&---------------------------------------------------------------------*
*&      Form  CHANGE_CATALOG
*&---------------------------------------------------------------------*
FORM change_catalog .
  LOOP AT it_fieldcat INTO ls_fieldcat.
    CASE ls_fieldcat-fieldname.
      WHEN 'VBELN'.
        PERFORM change_fieldcatalogue USING text-f01.
      WHEN 'POSNN'.
        PERFORM change_fieldcatalogue USING text-f02.
      WHEN 'VBELV'.
        PERFORM change_fieldcatalogue USING text-f03.
      WHEN 'POSNV'.
        PERFORM change_fieldcatalogue USING text-f04.
      WHEN 'WERKS'.
        PERFORM change_fieldcatalogue USING text-f05.
      WHEN 'EQUNR'.
        PERFORM change_fieldcatalogue USING text-f06.
      WHEN 'PARVW'.
        PERFORM change_fieldcatalogue USING text-f07.
      WHEN 'KUNNR'.
        PERFORM change_fieldcatalogue USING text-f08.
      WHEN 'PARVW1'.
        PERFORM change_fieldcatalogue USING text-f09.
      WHEN 'PARNR1'.
        PERFORM change_fieldcatalogue USING text-f10.
      WHEN 'PARVW2'.
        PERFORM change_fieldcatalogue USING text-f11.
      WHEN 'PARNR2'.
        PERFORM change_fieldcatalogue USING text-f12.
      WHEN 'FLAG'.
        PERFORM change_fieldcatalogue USING text-f13.
    ENDCASE.
    MODIFY it_fieldcat FROM ls_fieldcat.
  ENDLOOP.

ENDFORM.                    " CHANGE_CATALOG
*&---------------------------------------------------------------------*
*&      Form  ALV_OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_output .
  SORT it_output BY vbeln posnn.
  IF p_test = 'X'.
    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
      EXPORTING
        i_callback_program      = 'YAM_EQUIPMENT_UPDATE_PARTNERS'
        i_callback_user_command = g_user_command
        is_layout               = gs_layout
        it_fieldcat             = it_fieldcat
        it_sort                 = it_sort
        i_default               = 'X'
        i_save                  = 'A'
        is_variant              = gv_variant
        i_screen_start_column   = 0
        i_screen_start_line     = 0
        i_screen_end_column     = 0
        i_screen_end_line       = 0
      TABLES
        t_outtab                = it_output
      EXCEPTIONS
        program_error           = 1
        OTHERS                  = 2.

    IF sy-subrc NE 0.
    ENDIF.

  ELSE.
* Update the IHPA Table
    LOOP AT it_output INTO wa_output.
      IF wa_output-flag = 'S'.
* Commented by kiran
        IF wa_output-kunnr <> wa_output-parnr2
                 AND NOT wa_output-kunnr IS INITIAL.
          UPDATE ihpa SET parnr = wa_output-kunnr
                         WHERE objnr = wa_output-objnr
                           AND parvw = 'WE'.
        ENDIF.
*
        IF wa_output-kunnr <> wa_output-parnr2
                     AND NOT wa_output-kunnr IS INITIAL.

          UPDATE ihpa SET parnr = wa_output-kunnr
                         WHERE objnr = wa_output-objnr
                           AND parvw = 'AG'.
        ENDIF.
*ZD
        IF wa_output-kunnr <> wa_output-parnr2
                  AND NOT wa_output-kunnr IS INITIAL.

          UPDATE ihpa SET parnr = wa_output-parnr2
                         WHERE objnr = wa_output-objnr
                           AND parvw = 'ZD'.
        ENDIF.
*BP
        IF wa_output-kunnr <> wa_output-parnr2
                 AND NOT wa_output-kunnr IS INITIAL.
          UPDATE ihpa SET parnr = wa_output-kunnr
                         WHERE objnr = wa_output-objnr
                           AND parvw = 'RE'.
        ENDIF.
*PY
        IF wa_output-kunnr <> wa_output-parnr2
                 AND NOT wa_output-kunnr IS INITIAL.
          UPDATE ihpa SET parnr = wa_output-kunnr
                         WHERE objnr = wa_output-objnr
                           AND parvw = 'RG'.
        ENDIF.
* Commented by kiran
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMIEQ0'  '0100'  'X'  ''  ''
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_CURSOR' 'RM63E-EQUNR'
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'RM63E-EQUNR' wa_output-equnr
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    ''  ''  ''  'BDC_OKCODE'  '/00'
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMIEQ0'  '0101'  'X'  ''  ''
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=PART'
              CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR' 'ITOB-SHTXT'
              CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLIPAR'  '0200'  'X'  ''  ''
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.
*ZD
        READ TABLE it_ihpa INTO wa_ihpa
                                   WITH KEY objnr = wa_output-objnr
                                            parvw = 'ZD'.
        IF sy-subrc NE 0 or wa_ihpa-KZLOESCH = c_x.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(13)'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'IHPA-PARVW(13)'  'ZD'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          CLEAR wa_vbpa.
       READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_output-vbelv
                                                posnr = wa_output-posnv
                                                parvw = 'AG'.
          IF sy-subrc = 0.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'IHPA-PARNR(13)'  wa_vbpa-kunnr
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
          ELSE.
            CLEAR wa_vbpa.
            READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln =
            wa_output-vbelv
                                                     posnr = '000000'
                                                     parvw = 'AG'.
            IF sy-subrc = 0.

              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'IHPA-PARNR(13)'  wa_vbpa-kunnr
                     CHANGING struct_bdcdata.
              APPEND struct_bdcdata  TO i_bdcdata.
              CLEAR  struct_bdcdata.
            ENDIF.
          ENDIF.
        ENDIF.

*BP
        clear wa_ihpa.
        READ TABLE it_ihpa INTO wa_ihpa
                                   WITH KEY objnr = wa_output-objnr
                                            parvw = 'RE'.
        IF sy-subrc NE 0 or wa_ihpa-KZLOESCH = c_x.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(12)'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'IHPA-PARVW(12)'  'BP'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

        IF wa_output-kunnr <> wa_output-parnr2
                 AND NOT wa_output-kunnr IS INITIAL.
           if wa_output-parvw2 = 'AG'.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'IHPA-PARNR(12)'  wa_output-kunnr
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
           endif.
        endif.
*          CLEAR wa_vbpa.
*       READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_output-vbelv
*                                                posnr = wa_output-posnv
*                                                parvw = 'AG'.
*          IF sy-subrc = 0.
*
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'IHPA-PARNR(12)'  wa_vbpa-kunnr
*                   CHANGING struct_bdcdata.
*            APPEND struct_bdcdata  TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*          ELSE.
*            CLEAR wa_vbpa.
*            READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln =
*            wa_output-vbelv
*                                                     posnr = '000000'
*                                                      parvw = 'AG'.
*            IF sy-subrc = 0.
*
*              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'IHPA-PARNR(12)'  wa_vbpa-kunnr
*                     CHANGING struct_bdcdata.
*              APPEND struct_bdcdata  TO i_bdcdata.
*              CLEAR  struct_bdcdata.
*            ENDIF.
*          ENDIF.
        ENDIF.
*PY
        READ TABLE it_ihpa INTO wa_ihpa
                                   WITH KEY objnr = wa_output-objnr
                                            parvw = 'RG'.
        IF sy-subrc NE 0 or wa_ihpa-KZLOESCH = c_x.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(11)'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'IHPA-PARVW(11)'  'PY'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

*          CLEAR wa_vbpa.
*       READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_output-vbelv
*                                                posnr = wa_output-posnv
*                                                parvw = 'AG'.
*          IF sy-subrc = 0.
*
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'IHPA-PARNR(11)'  wa_vbpa-kunnr
*                   CHANGING struct_bdcdata.
*            APPEND struct_bdcdata  TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*          ELSE.
*            CLEAR wa_vbpa.
*            READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln =
*            wa_output-vbelv
*                                                     posnr = '000000'
*                                                     parvw = 'AG'.
*            IF sy-subrc = 0.
*
*              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'IHPA-PARNR(11)'  wa_vbpa-kunnr
*                     CHANGING struct_bdcdata.
*              APPEND struct_bdcdata  TO i_bdcdata.
*              CLEAR  struct_bdcdata.
*            ENDIF.
*          ENDIF.
        IF wa_output-kunnr <> wa_output-parnr2
                 AND NOT wa_output-kunnr IS INITIAL.
           if wa_output-parvw2 = 'AG'.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'IHPA-PARNR(11)'  wa_output-kunnr
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.
           endif.
        endif.

        ENDIF.
*ZE
**commented by kiran -start
*        READ TABLE it_ihpa INTO wa_ihpa
*                                   WITH KEY objnr = wa_output-objnr
*                                            parvw = 'ZE'.
*        IF sy-subrc NE 0.
*
*          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(10)'
*                CHANGING struct_bdcdata.
*          APPEND struct_bdcdata  TO i_bdcdata.
*          CLEAR  struct_bdcdata.
*
*          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
*                 CHANGING struct_bdcdata.
*          APPEND struct_bdcdata  TO i_bdcdata.
*          CLEAR  struct_bdcdata.
*
*          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                 USING    ''  ''  ''  'IHPA-PARVW(10)'  'ZE'
*                 CHANGING struct_bdcdata.
*          APPEND struct_bdcdata  TO i_bdcdata.
*          CLEAR  struct_bdcdata.
*
*          CLEAR wa_vbpa.
*       READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln = wa_output-vbelv
*                                                posnr = wa_output-posnv
*                                                parvw = 'AG'.
*          IF sy-subrc = 0.
*
*            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'IHPA-PARNR(10)'  wa_vbpa-kunnr
*                   CHANGING struct_bdcdata.
*            APPEND struct_bdcdata  TO i_bdcdata.
*            CLEAR  struct_bdcdata.
*          ELSE.
*            CLEAR wa_vbpa.
*            READ TABLE it_vbpa INTO wa_vbpa WITH KEY vbeln =
*            wa_output-vbelv
*                                                     posnr = '000000'
*                                                     parvw = 'AG'.
*            IF sy-subrc = 0.
*
*              PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                   USING    ''  ''  ''  'IHPA-PARNR(10)'  wa_vbpa-kunnr
*                     CHANGING struct_bdcdata.
*              APPEND struct_bdcdata  TO i_bdcdata.
*              CLEAR  struct_bdcdata.
*            ENDIF.
*          ENDIF.
*        ENDIF.
*commented by kiran
*
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPLIPAR'  '0200'  'X'  ''  ''
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=BACK'
              CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
               USING    'SAPMIEQ0' '0101'  'X'  ''  ''
               CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
              CHANGING struct_bdcdata.
        APPEND struct_bdcdata  TO i_bdcdata.
        CLEAR  struct_bdcdata.

*.. Perform Call Transaction to update the EQUIPMENT
        CALL TRANSACTION 'IE02' USING i_bdcdata
             MODE  lv_mode UPDATE 'S' MESSAGES INTO gt_messtab.
        IF NOT gt_messtab[] IS INITIAL.
*
          LOOP AT gt_messtab.
            IF gt_messtab-msgty = c_type_a OR
               gt_messtab-msgty = c_type_e .
              SELECT SINGLE text FROM t100 INTO g_text
                                    WHERE sprsl = c_en
                                      AND arbgb = gt_messtab-msgid
                                      AND msgnr = gt_messtab-msgno.
              IF sy-subrc = 0.
                g_mstring = g_text.
                IF g_mstring CS '&1'.
                  REPLACE '&1' WITH gt_messtab-msgv1 INTO g_mstring.
                  REPLACE '&2' WITH gt_messtab-msgv2 INTO g_mstring.
                  REPLACE '&3' WITH gt_messtab-msgv3 INTO g_mstring.
                  REPLACE '&4' WITH gt_messtab-msgv4 INTO g_mstring.
                ELSE.
                  REPLACE '&' WITH gt_messtab-msgv1 INTO g_mstring.
                  CONDENSE g_mstring.
                  REPLACE '&' WITH gt_messtab-msgv2 INTO g_mstring.
                  CONDENSE g_mstring.
                  REPLACE '&' WITH gt_messtab-msgv3 INTO g_mstring.
                  REPLACE '&' WITH gt_messtab-msgv4 INTO g_mstring.
                ENDIF.
                CONDENSE g_mstring.
                WRITE : /5 g_mstring.
              ENDIF.

              EXIT.
            ENDIF .
          ENDLOOP.
*commented by kiran - end
        ENDIF.
        CLEAR   i_bdcdata.
        REFRESH i_bdcdata.

      ELSEIF wa_output-flag = 'H'.
        IF NOT wa_output-flag2 IS INITIAL.
          IF NOT wa_output-kunnr IS INITIAL.
            UPDATE ihpa SET parnr = wa_output-kunnr
                           WHERE objnr = wa_output-objnr
                             AND parvw = 'WE'.
          ENDIF.
*
          IF NOT wa_output-kunnr IS INITIAL .
            UPDATE ihpa SET parnr = wa_output-kunnr
                           WHERE objnr = wa_output-objnr
                             AND parvw = 'AG'.
          ENDIF.

*
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMIEQ0'  '0100'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_CURSOR' 'RM63E-EQUNR'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'RM63E-EQUNR' wa_output-equnr
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMIEQ0'  '0101'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_OKCODE'  '=PART'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR' 'ITOB-SHTXT'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.
*ZD
          READ TABLE it_ihpa_h INTO wa_ihpa_h
                                     WITH KEY objnr = wa_output-objnr
                                              parvw = 'ZD'.
          IF sy-subrc NE 0 or wa_ihpa-KZLOESCH = c_x.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(13)'
                  CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'IHPA-PARVW(13)'  'ZD'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.


            CLEAR wa_vbpa.
            READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
            wa_output-vbelv
                                                        posnr =
                                                        wa_output-posnv
                                                        parvw = 'AG'.
            IF sy-subrc = 0.

              CLEAR wa_new_table.
              READ TABLE it_new_table INTO wa_new_table WITH KEY
                                       kunnr_hkga =
                                                wa_vbpa_h-kunnr.
              IF sy-subrc = 0.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'IHPA-PARNR(13)'
                  wa_new_table-kunnr_shta
                       CHANGING struct_bdcdata.
                APPEND struct_bdcdata  TO i_bdcdata.
                CLEAR  struct_bdcdata.
              ELSE.
                wa_check-kunnr = wa_vbpa_h-kunnr.
                APPEND wa_check TO it_check.
              ENDIF.

            ELSE.
              CLEAR wa_vbpa.
              READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
              wa_output-vbelv
                                                            posnr =
                                                            '000000'
                                                           parvw = 'AG'.
              IF sy-subrc = 0.
                CLEAR wa_new_table.
                READ TABLE it_new_table INTO wa_new_table WITH KEY
                                          kunnr_hkga =
                                                  wa_vbpa_h-kunnr.
                IF sy-subrc = 0.
                  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'IHPA-PARNR(13)'
                    wa_new_table-kunnr_shta
                         CHANGING struct_bdcdata.
                  APPEND struct_bdcdata  TO i_bdcdata.
                  CLEAR  struct_bdcdata.
                ELSE.
                  wa_check-kunnr = wa_vbpa_h-kunnr.
                  APPEND wa_check TO it_check.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.

*BP
          READ TABLE it_ihpa_h INTO wa_ihpa_h
                                     WITH KEY objnr = wa_output-objnr
                                              parvw = 'RE'.
          IF sy-subrc NE 0 or wa_ihpa_h-KZLOESCH = c_x.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(12)'
                  CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'IHPA-PARVW(12)'  'BP'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.


          IF NOT wa_output-kunnr IS INITIAL.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'IHPA-PARNR(12)'
                  wa_output-kunnr
                       CHANGING struct_bdcdata.
                APPEND struct_bdcdata  TO i_bdcdata.
                CLEAR  struct_bdcdata.
          endif.
*            CLEAR wa_vbpa.
*            READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
*            wa_output-vbelv
*                                                        posnr =
*                                                        wa_output-posnv
*                                                        parvw = 'AG'.
*            IF sy-subrc = 0.
*
*              CLEAR wa_new_table.
*              READ TABLE it_new_table INTO wa_new_table WITH KEY
*                                       kunnr_hkga =
*                                                wa_vbpa_h-kunnr.
*              IF sy-subrc = 0.
*                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                  USING    ''  ''  ''  'IHPA-PARNR(12)'
*                  wa_new_table-kunnr_shta
*                       CHANGING struct_bdcdata.
*                APPEND struct_bdcdata  TO i_bdcdata.
*                CLEAR  struct_bdcdata.
*              ELSE.
*                wa_check-kunnr = wa_vbpa_h-kunnr.
*                APPEND wa_check TO it_check.
*              ENDIF.
*
*            ELSE.
*              CLEAR wa_vbpa.
*              READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
*              wa_output-vbelv
*                                                            posnr =
*                                                            '000000'
*                                                           parvw = 'AG'
*.
*              IF sy-subrc = 0.
*                CLEAR wa_new_table.
*                READ TABLE it_new_table INTO wa_new_table WITH KEY
*                                          kunnr_hkga =
*                                                  wa_vbpa_h-kunnr.
*                IF sy-subrc = 0.
*                  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                    USING    ''  ''  ''  'IHPA-PARNR(12)'
*                    wa_new_table-kunnr_shta
*                         CHANGING struct_bdcdata.
*                  APPEND struct_bdcdata  TO i_bdcdata.
*                  CLEAR  struct_bdcdata.
*                ELSE.
*                  wa_check-kunnr = wa_vbpa_h-kunnr.
*                  APPEND wa_check TO it_check.
*                ENDIF.
*              ENDIF.
*            ENDIF.
          ENDIF.

*PY
          READ TABLE it_ihpa_h INTO wa_ihpa_h
                                     WITH KEY objnr = wa_output-objnr
                                              parvw = 'RG'.
          IF sy-subrc NE 0 or wa_ihpa_h-KZLOESCH = c_x.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(11)'
                  CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'IHPA-PARVW(11)'  'PY'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

          IF NOT wa_output-kunnr IS INITIAL.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'IHPA-PARNR(11)'
                  wa_output-kunnr
                       CHANGING struct_bdcdata.
                APPEND struct_bdcdata  TO i_bdcdata.
                CLEAR  struct_bdcdata.
          endif.
*            CLEAR wa_vbpa.
*            READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
*            wa_output-vbelv
*                                                        posnr =
*                                                        wa_output-posnv
*                                                        parvw = 'AG'.
*            IF sy-subrc = 0.
*
*              CLEAR wa_new_table.
*              READ TABLE it_new_table INTO wa_new_table WITH KEY
*                                       kunnr_hkga =
*                                                wa_vbpa_h-kunnr.
*              IF sy-subrc = 0.
*                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                  USING    ''  ''  ''  'IHPA-PARNR(11)'
*                  wa_new_table-kunnr_shta
*                       CHANGING struct_bdcdata.
*                APPEND struct_bdcdata  TO i_bdcdata.
*                CLEAR  struct_bdcdata.
*              ELSE.
*                wa_check-kunnr = wa_vbpa_h-kunnr.
*                APPEND wa_check TO it_check.
*              ENDIF.
*
*            ELSE.
*              CLEAR wa_vbpa.
*              READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
*              wa_output-vbelv
*                                                            posnr =
*                                                            '000000'
*                                                           parvw = 'AG'
*.
*
*              IF sy-subrc = 0.
*                CLEAR wa_new_table.
*                READ TABLE it_new_table INTO wa_new_table WITH KEY
*                                          kunnr_hkga =
*                                                  wa_vbpa_h-kunnr.
*                IF sy-subrc = 0.
*                  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                    USING    ''  ''  ''  'IHPA-PARNR(11)'
*                    wa_new_table-kunnr_shta
*                         CHANGING struct_bdcdata.
*                  APPEND struct_bdcdata  TO i_bdcdata.
*                  CLEAR  struct_bdcdata.
*                ELSE.
*                  wa_check-kunnr = wa_vbpa_h-kunnr.
*                  APPEND wa_check TO it_check.
*                ENDIF.
*              ENDIF.
*            ENDIF.
          ENDIF.
*ZE
* Commented by kiran - start
          READ TABLE it_ihpa_h INTO wa_ihpa_h
                                     WITH KEY objnr = wa_output-objnr
                                              parvw = 'ZE'.
          IF sy-subrc NE 0 or wa_ihpa_h-KZLOESCH = c_x.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IHPA-PARNR(10)'
                  CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    ''  ''  ''  'IHPA-PARVW(10)'  'ZE'
                   CHANGING struct_bdcdata.
            APPEND struct_bdcdata  TO i_bdcdata.
            CLEAR  struct_bdcdata.

          IF NOT wa_output-kunnr IS INITIAL.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'IHPA-PARNR(10)'
                  wa_output-kunnr
                       CHANGING struct_bdcdata.
                APPEND struct_bdcdata  TO i_bdcdata.
                CLEAR  struct_bdcdata.
          endif.

*            CLEAR wa_vbpa.
*            READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
*            wa_output-vbelv
*                                                        posnr =
*                                                        wa_output-posnv
*                                                        parvw = 'AG'.
*            IF sy-subrc = 0.
*
*              CLEAR wa_new_table.
*              READ TABLE it_new_table INTO wa_new_table WITH KEY
*                                       kunnr_hkga =
*                                                wa_vbpa_h-kunnr.
*              IF sy-subrc = 0.
*                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                  USING    ''  ''  ''  'IHPA-PARNR(10)'
*                  wa_new_table-kunnr_shta
*                       CHANGING struct_bdcdata.
*                APPEND struct_bdcdata  TO i_bdcdata.
*                CLEAR  struct_bdcdata.
*              ELSE.
*                wa_check-kunnr = wa_vbpa_h-kunnr.
*                APPEND wa_check TO it_check.
*              ENDIF.
*
*            ELSE.
*              CLEAR wa_vbpa.
*              READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
*              wa_output-vbelv
*                                                            posnr =
*                                                            '000000'
*                                                           parvw = 'AG'
*.
*              IF sy-subrc = 0.
*                CLEAR wa_new_table.
*                READ TABLE it_new_table INTO wa_new_table WITH KEY
*                                          kunnr_hkga =
*                                                  wa_vbpa_h-kunnr.
*                IF sy-subrc = 0.
*                  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
*                    USING    ''  ''  ''  'IHPA-PARNR(10)'
*                    wa_new_table-kunnr_shta
*                         CHANGING struct_bdcdata.
*                  APPEND struct_bdcdata  TO i_bdcdata.
*                  CLEAR  struct_bdcdata.
*                ELSE.
*                  wa_check-kunnr = wa_vbpa_h-kunnr.
*                  APPEND wa_check TO it_check.
*                ENDIF.
*              ENDIF.
*            ENDIF.
          ENDIF.
* commented by kiran -  end
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_OKCODE'  '=BACK'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMIEQ0' '0101'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_OKCODE'  '=T\06'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    'SAPMIEQ0' '0101'  'X'  ''  ''
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
                CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'ITOB-VKORG' '  '
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'ITOB-VTWEG' ' '
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                 USING    ''  ''  ''  'ITOB-SPART' ' '
                 CHANGING struct_bdcdata.
          APPEND struct_bdcdata  TO i_bdcdata.
          CLEAR  struct_bdcdata.

*.. Perform Call Transaction to update the EQUIPMENT
          CALL TRANSACTION 'IE02' USING i_bdcdata
               MODE  lv_mode UPDATE 'S' MESSAGES INTO gt_messtab.
          IF NOT gt_messtab[] IS INITIAL.
*
            LOOP AT gt_messtab.
              IF gt_messtab-msgty = c_type_a OR
                 gt_messtab-msgty = c_type_e .
                SELECT SINGLE text FROM t100 INTO g_text
                                      WHERE sprsl = c_en
                                        AND arbgb = gt_messtab-msgid
                                        AND msgnr = gt_messtab-msgno.
                IF sy-subrc = 0.
                  g_mstring = g_text.
                  IF g_mstring CS '&1'.
                    REPLACE '&1' WITH gt_messtab-msgv1 INTO g_mstring.
                    REPLACE '&2' WITH gt_messtab-msgv2 INTO g_mstring.
                    REPLACE '&3' WITH gt_messtab-msgv3 INTO g_mstring.
                    REPLACE '&4' WITH gt_messtab-msgv4 INTO g_mstring.
                  ELSE.
                    REPLACE '&' WITH gt_messtab-msgv1 INTO g_mstring.
                    CONDENSE g_mstring.
                    REPLACE '&' WITH gt_messtab-msgv2 INTO g_mstring.
                    CONDENSE g_mstring.
                    REPLACE '&' WITH gt_messtab-msgv3 INTO g_mstring.
                    REPLACE '&' WITH gt_messtab-msgv4 INTO g_mstring.
                  ENDIF.
                  CONDENSE g_mstring.
                  WRITE : /5 g_mstring.
                ENDIF.

                EXIT.
              ENDIF .
            ENDLOOP.
*
          ELSE.
          ENDIF.
          CLEAR   i_bdcdata.
          REFRESH i_bdcdata.
        ELSE.
          IF NOT wa_output-parnr1 IS INITIAL.
            UPDATE ihpa SET parnr = wa_output-parnr1
                           WHERE objnr = wa_output-objnr
                             AND parvw = 'WE'.
          ENDIF.
*
          IF NOT wa_output-parnr2 IS INITIAL .
            UPDATE ihpa SET parnr = wa_output-parnr2
                           WHERE objnr = wa_output-objnr
                             AND parvw = 'AG'.
          ENDIF.
*
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.
*
  IF NOT it_check[] IS INITIAL.
    DELETE ADJACENT DUPLICATES FROM it_check COMPARING kunnr.
    LOOP AT it_check INTO wa_check.
      WRITE :/5 wa_check-kunnr ,
      18 text-u01.
    ENDLOOP.
  ENDIF.


ENDFORM.                    " ALV_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  CHANGE_FIELDCATALOGUE
*&---------------------------------------------------------------------*
FORM change_fieldcatalogue  USING  title.
  ls_fieldcat-seltext_s    = title.
  ls_fieldcat-seltext_m    = title.
  ls_fieldcat-seltext_l    = title.
  ls_fieldcat-reptext_ddic = title.
ENDFORM.                    " CHANGE_FIELDCATALOGUE
*&--------------------------------------------------------------------*
*&      Form  fill_bdcdata
*&--------------------------------------------------------------------*
*  This routine can be called when programming batch input programs   *
*---------------------------------------------------------------------*
*      -->PROGRAM    text
*      -->DYNPRO     text
*      -->DYNBEGIN   text
*      -->FNAM       text
*      -->FVAL       text
*      -->STRUCT_BDCDtext
*---------------------------------------------------------------------*
FORM fill_bdcdata
                USING g_program g_dynpro g_dynbegin g_fnam g_fval
                CHANGING struct_bdcdata.

  struct_bdcdata(40)      = g_program.
  struct_bdcdata+40(4)    = g_dynpro.
  struct_bdcdata+44(1)    = g_dynbegin.
  struct_bdcdata+45(132)  = g_fnam.
  struct_bdcdata+177(132) = g_fval.

ENDFORM.                    "fill_bdcdata
*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA_H
*&---------------------------------------------------------------------*
FORM select_data_h .
  IF NOT it_vbap_h[] IS INITIAL.
    SELECT  vbeln
            posnr
            parvw
            kunnr
           INTO TABLE it_vbpa_h
           FROM vbpa
           FOR ALL ENTRIES IN it_vbap_h
           WHERE vbeln = it_vbap_h-vbeln.
    IF sy-subrc = 0.
      SORT it_vbpa_h BY vbeln posnr.
    ENDIF.
  ENDIF.
*
  SELECT kunnr_hkga kunnr_shta FROM yse_cm_shta_hkga
              INTO TABLE it_new_table.
  IF sy-subrc = 0.
    SORT it_new_table BY kunnr_hkga.
  ENDIF.
ENDFORM.                    " SELECT_DATA_H
*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA_H
*&---------------------------------------------------------------------*
FORM process_data_h .
  LOOP AT it_objk INTO wa_objk.
    CONCATENATE 'IE' wa_objk-equnr INTO wa_objk1-objnr.
    APPEND wa_objk1 TO it_objk1.
    CLEAR wa_objk1.
  ENDLOOP.
*
  IF NOT it_objk1[] IS INITIAL.
    SELECT objnr parvw parnr KZLOESCH
               INTO TABLE it_ihpa_h
                 FROM ihpa
                  FOR ALL ENTRIES IN it_objk1
                   WHERE objnr = it_objk1-objnr
                     AND ( parvw = 'WE'
                      OR   parvw = 'AG'
                      OR   parvw = 'RE'
                      OR   parvw = 'RG'
                      OR   parvw = 'ZE' ) .
    IF sy-subrc = 0.
      SORT it_ihpa_h BY objnr .
    ENDIF.
  ENDIF.
*
  LOOP AT it_likp INTO wa_likp.
    CLEAR wa_vbfa.
    READ TABLE it_vbfa INTO wa_vbfa WITH KEY vbeln = wa_likp-vbeln.
    IF sy-subrc = 0.
      CLEAR wa_vbap_h.
     READ TABLE it_vbap_h INTO wa_vbap_h WITH KEY vbeln = wa_vbfa-vbelv
                                                 posnr = wa_vbfa-posnv.
      IF sy-subrc = 0.
        CLEAR wa_ser01.
        LOOP AT it_ser01 INTO wa_ser01 WHERE lief_nr =
        wa_vbfa-vbeln
*                                       AND posnr = wa_vbfa-posnn
                                                   .
          IF sy-subrc = 0.
            CLEAR wa_objk.
            LOOP AT it_objk INTO wa_objk WHERE obknr =
            wa_ser01-obknr.
              IF sy-subrc = 0.
                wa_output-vbeln = wa_vbfa-vbeln.
                wa_output-posnn = wa_vbfa-posnn.
                wa_output-vbelv = wa_vbap_h-vbeln.
                wa_output-posnv = wa_vbap_h-posnr.
                wa_output-werks = wa_vbap_h-werks.
                wa_output-flag  = 'H'.
                wa_output-equnr = wa_objk-equnr.

                CLEAR wa_vbpa_h.
*        IF NOT wa_vbap_h-posnr IS INITIAL.
                READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
                wa_vbap_h-vbeln
                                                            posnr =
                                                        wa_vbap_h-posnr
                                                           parvw = c_ze.
                IF sy-subrc = 0.
                  CLEAR wa_new_table.
                  READ TABLE it_new_table INTO wa_new_table WITH KEY
                                           kunnr_hkga = wa_vbpa_h-kunnr
                                                    .
                  IF sy-subrc = 0.
                    wa_output-kunnr = wa_new_table-kunnr_shta.
                    wa_output-flag2 = 'X'.
                  ELSE.
*
                    CLEAR wa_new_table.
                    READ TABLE it_new_table INTO wa_new_table WITH KEY
                                                  kunnr_hkga =
                                                      wa_vbpa_h-kunnr.
                    IF sy-subrc = 0.
                      wa_output-parnr1 = wa_new_table-kunnr_shta.
                    ELSE.
                      wa_check-kunnr = wa_vbpa_h-kunnr.
                      APPEND wa_check TO it_check.
                    ENDIF.
*
                    CLEAR wa_new_table.
                    READ TABLE it_new_table INTO wa_new_table WITH KEY
                                                  kunnr_hkga =
                                                      wa_vbpa_h-kunnr.
                    IF sy-subrc = 0.
                      wa_output-parnr2 = wa_new_table-kunnr_shta.
                    ELSE.
                      wa_check-kunnr = wa_vbpa_h-kunnr.
                      APPEND wa_check TO it_check.

                    ENDIF.
*
                  ENDIF.
                ELSE.

*        ELSEIF wa_vbap_h-posnr IS INITIAL.
                  CLEAR wa_vbpa_h.
                  READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
                  wa_vbap_h-vbeln
                                                       posnr = '000000'
                                                           parvw = c_ze.
                  IF sy-subrc = 0.
                    CLEAR wa_new_table.
                    READ TABLE it_new_table INTO wa_new_table WITH KEY
                                                   kunnr_hkga =
                                                      wa_vbpa_h-kunnr.
                    IF sy-subrc = 0.
                      wa_output-parvw = 'ZE'.
                      wa_output-kunnr = wa_new_table-kunnr_shta.
                      wa_output-flag2 = 'X'.
                    ELSE.
                      wa_check-kunnr = wa_vbpa_h-kunnr.
                      APPEND wa_check TO it_check.
                    ENDIF.
                  ENDIF.
*
                  CLEAR wa_vbpa_h.
                  READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
                  wa_vbap_h-vbeln
                                                       posnr = '000000'
                                                           parvw = 'WE'.
                  IF sy-subrc = 0.

                    CLEAR wa_new_table.
                    READ TABLE it_new_table INTO wa_new_table WITH KEY
                                                 kunnr_hkga =
                                                      wa_vbpa_h-kunnr.
                    IF sy-subrc = 0.
                      wa_output-parvw1 = 'WE'.
                      wa_output-parnr1 = wa_new_table-kunnr_shta.
                    ELSE.
                      wa_check-kunnr = wa_vbpa_h-kunnr.
                      APPEND wa_check TO it_check.
                    ENDIF.
                  ENDIF.
*
                  CLEAR wa_vbpa_h.
                  READ TABLE it_vbpa_h INTO wa_vbpa_h WITH KEY vbeln =
                  wa_vbap_h-vbeln
                                                       posnr = '000000'
                                                           parvw = 'AG'.
                  IF sy-subrc = 0.

                    CLEAR wa_new_table.
                    READ TABLE it_new_table INTO wa_new_table WITH KEY
                                                    kunnr_hkga =
                                                       wa_vbpa_h-kunnr.
                    IF sy-subrc = 0.
                      wa_output-parvw2 = 'AG'.
                      wa_output-parnr2 = wa_new_table-kunnr_shta.
                    ELSE.
                      wa_check-kunnr = wa_vbpa_h-kunnr.
                      APPEND wa_check TO it_check.

                    ENDIF.
                  ENDIF.
*
                ENDIF.
              ENDIF.
              APPEND wa_output TO it_output.
              CLEAR : wa_output,sy-subrc.
            ENDLOOP.
          ENDIF.
        ENDLOOP.
      ENDIF.

    ENDIF.
  ENDLOOP.
*
  LOOP AT it_output ASSIGNING <fs_output>.
    CLEAR : wa_ihpa , v_objnr.
    CONCATENATE 'IE' <fs_output>-equnr INTO v_objnr.
    READ TABLE it_ihpa_h INTO wa_ihpa_h WITH KEY objnr = v_objnr
                                             parvw = 'WE'.
    IF sy-subrc = 0.
      <fs_output>-objnr   = v_objnr.
    ENDIF.
*
    READ TABLE it_ihpa_h INTO wa_ihpa_h WITH KEY objnr = v_objnr
                                             parvw = 'AG'.
    IF sy-subrc = 0 .
      <fs_output>-objnr   = v_objnr.
    ENDIF.
  ENDLOOP.
*
  DELETE it_output WHERE equnr = ' '.
*

ENDFORM.                    " PROCESS_DATA_H
*&---------------------------------------------------------------------*
*&      Form  CHECK_FUNC_LOC
*
*&---------------------------------------------------------------------*
FORM check_func_loc .
  CHECK NOT it_output[] IS INITIAL.
  SELECT equnr iloan FROM equz
             INTO TABLE it_equz
             FOR ALL ENTRIES IN it_output
              WHERE equnr = it_output-equnr
                AND datbi > sy-datum.
  IF sy-subrc = 0.
    SORT it_equz BY equnr.
  ENDIF.
*
  CHECK NOT it_equz[] IS INITIAL.
  SELECT iloan tplnr FROM iloa
             INTO TABLE it_iloa
             FOR ALL ENTRIES IN it_equz
              WHERE iloan = it_equz-iloan
                AND tplnr IN s_tplnr.
  IF sy-subrc = 0.
    SORT it_iloa BY iloan.
  ENDIF.
*
  CLEAR wa_output.
  LOOP AT it_output INTO wa_output.
    CLEAR wa_equz.
    READ TABLE it_equz INTO wa_equz WITH KEY equnr = wa_output-equnr.
    IF sy-subrc = 0.
      CLEAR wa_iloa.
      READ TABLE it_iloa INTO wa_iloa WITH KEY iloan = wa_equz-iloan.
      IF sy-subrc NE 0.
        DELETE it_output.
      ENDIF.
    ENDIF.
  ENDLOOP.
ENDFORM.                    " CHECK_FUNC_LOC
*&---------------------------------------------------------------------*
*&      Form  CUSTOMER_MAPPING
*&---------------------------------------------------------------------*
*       Customer Mapping
*----------------------------------------------------------------------*
form CUSTOMER_MAPPING .

  DATA: l_view TYPE DD02V-TABNAME.
  l_view = 'YSE_CM_SHTA_HKGA'.
  CALL FUNCTION 'VIEW_MAINTENANCE_CALL'
    EXPORTING
      action                               = 'U'
      view_name                            = l_view
*   TABLES
*     DBA_SELLIST                          =
*     EXCL_CUA_FUNCT                       =
    EXCEPTIONS
      client_reference                     = 1
      foreign_lock                         = 2
      invalid_action                       = 3
      no_clientindependent_auth            = 4
      no_database_function                 = 5
      no_editor_function                   = 6
      no_show_auth                         = 7
      no_tvdir_entry                       = 8
      no_upd_auth                          = 9
      only_show_allowed                    = 10
      system_failure                       = 11
      unknown_field_in_dba_sellist         = 12
      view_not_found                       = 13
      maintenance_prohibited               = 14
      OTHERS                               = 15.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'E' NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
endform.                    " CUSTOMER_MAPPING

*Text symbol text
*F01:Delivery No.
*F02:Del.Item
*F03:Sales ord.
*F04:Sales Item
*F05:Plant
*F06:Equipment
*F07:Partner type
*F08:Partner  #
*F09:Equip. Partner type( SH )
*F10:Equip. Partner # (SH )
*F11:Equip. Partner type( SP )
*F12:Equip. Partner # (SP )
*F13:Flag

*U01:Maintenance for Customer  NOT available in table YSE_CM_SHTA_HKGA
*Selection text
*P_TEST:        Test Mode ( No Update )
*S_TPLNR:        Functional Loc of Equipment
*S_VBELN:        Delivery Number
*S_VKORG:        Sales Org.
*S_WADAT:        Actual Goods Movement Date
