*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_CLOSE_QUOT                                *
* PROGRAM TITLE        : Automatic closing of not accepted quotations  *
* AUTHOR               : Geert Rutten                                  *
* DATE                 : 22/04/2009                                    *
* DEVELOPMENT ID       : AIR21243                                      *
* CHANGE REQUEST NUMBER: CD1K947764                                    *
* PROGRAM DESCRIPTION  : Automatic closing of not accepted quotations  *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME            |CORRECTION NR| CHANGE REF#     *
*----------------------------------------------------------------------*
*         |          |                 |             |                 *
*----------------------------------------------------------------------*
REPORT yam_close_quot MESSAGE-ID yam_re  NO STANDARD PAGE HEADING
                                    LINE-SIZE 400.

TYPE-POOLS: slis.

TABLES: vbak.

*-------------------------CONSTANTS-------------------------*
CONSTANTS : g_x VALUE 'X',
            g_s  VALUE 'S',
            c_color_green(4)    TYPE c VALUE 'C500', "Green intense/inverse off
            c_color_red(4)  TYPE c VALUE 'C600', "Lt blue intens/inverse off
            c_title(72) TYPE c VALUE 'Please give a reason to close quotation(s)',
            c_iw32          LIKE tstc-tcode   VALUE 'IW32',
            c_iw52          LIKE tstc-tcode   VALUE 'IW52',
            c_va22          LIKE tstc-tcode   VALUE 'VA22'.
*- VARIABLES----------------------------------------------------------

DATA : l_s_msg TYPE bal_s_msg,
       l_log_handle TYPE balloghndl,
       l_s_log      TYPE bal_s_log ,
       lt_logh      TYPE bal_t_logh,
       lv_mode(1)   TYPE c VALUE 'N'.

DATA : i_bdcdata LIKE bdcdata OCCURS 0 WITH HEADER LINE,
       struct_bdcdata TYPE bdcdata.

DATA : BEGIN OF i_messtab OCCURS 0.
        INCLUDE STRUCTURE bdcmsgcoll.
DATA : END OF i_messtab.

DATA: gt_fieldcat         TYPE slis_t_fieldcat_alv,
      g_events_tab        TYPE slis_t_event,
      h_event             TYPE slis_alv_event,
      g_form_user_command TYPE slis_formname VALUE 'USER_COMMAND_L',
      g_form_set_pf_stat  TYPE slis_formname VALUE 'SET_PF_STAT_L',
      g_layout            TYPE slis_layout_alv,
      gt_sort             TYPE slis_t_sortinfo_alv,
      g_repid             LIKE ceddb-program,
      gv_bukrs2           LIKE vbak-vkorg,
      ctamflag(1)         TYPE c,
      fields              LIKE sval OCCURS 0 WITH HEADER LINE,
      g_index LIKE sy-tabix,
      lv_answer,
      gv_index LIKE sy-tabix.

DATA: BEGIN OF gt_vbak_vbap OCCURS 0,
        vtweg LIKE vbak-vtweg,
        vkorg LIKE vbak-vkorg,
        spart LIKE vbak-spart,
        vkbur LIKE vbak-vkbur,
        vkgrp LIKE vbak-vkgrp,
        auart LIKE vbak-auart,
        kunnr LIKE vbak-kunnr,
        bnddt LIKE vbak-bnddt,
        ernam LIKE vbak-ernam,
        vbeln LIKE vbak-vbeln,
        erdat LIKE vbak-erdat,
        posnr LIKE vbap-posnr,
        matnr LIKE vbap-matnr,
        maktx LIKE makt-maktx,
        netpr LIKE vbap-netpr,
        kpein LIKE vbap-kpein,
        meins LIKE vbap-meins,
        netwr LIKE vbap-netwr,
        qmnum LIKE vbak-qmnum,
        aufnr LIKE vbak-aufnr,
        angdt LIKE vbak-angdt,
        vgbel LIKE vbak-vgbel,
        abgru LIKE vbap-abgru,
        abgru_text LIKE tvagt-bezei,
        selected,
*        pm_selected TYPE pm_selected,
        flag,
        color(4) TYPE c,
      END OF gt_vbak_vbap.

DATA: BEGIN OF h_status_tab OCCURS 30.
        INCLUDE STRUCTURE jstat.
DATA: END OF h_status_tab.

DATA: h_stat_flag,
      h_stat_flag2,
      lv_objnr_ord LIKE aufk-objnr,
      lv_objnr_qmnum LIKE viqmel-objnr.

* Output list
DATA: BEGIN OF gt_outputlist OCCURS 0,
      qmnum LIKE vbak-qmnum,
      nstat(8) TYPE c,
      aufnr LIKE vbak-aufnr,
      ostat(8) TYPE c,
      vbeln LIKE vbak-vbeln,
      posnr LIKE vbap-posnr,
      matnr LIKE mara-matnr,
      maktx LIKE makt-maktx,
      abgru(20) TYPE c,
      col   TYPE c,
      END OF gt_outputlist.

*- SELECTION SCREEN---------------------------------------------------
SELECTION-SCREEN: BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
PARAMETERS:     p_vkorg  TYPE vbak-vkorg OBLIGATORY MEMORY ID vko,
                p_vtweg  TYPE vbak-vtweg OBLIGATORY MEMORY ID vtw ,
                p_spart  TYPE vbak-spart OBLIGATORY MEMORY ID spa.
SELECT-OPTIONS: s_vkbur  FOR vbak-vkbur,
                s_vkgrp  FOR vbak-vkgrp.
SELECTION-SCREEN: END OF BLOCK b1.

SELECTION-SCREEN: BEGIN OF BLOCK b2 WITH FRAME TITLE text-002.
SELECT-OPTIONS: s_kunnr FOR vbak-kunnr,
                s_bnddt FOR vbak-bnddt,
                s_aufnr FOR vbak-aufnr MATCHCODE OBJECT ordp,
                s_ernam FOR vbak-ernam MATCHCODE OBJECT USER_COMP,
                s_erdat FOR vbak-erdat.
SELECTION-SCREEN: END OF BLOCK b2.


*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_vkorg.

  AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
           ID 'VKORG' FIELD p_vkorg
           ID 'VTWEG' FIELD p_vtweg
           ID 'SPART' FIELD p_spart
           ID 'ACTVT' FIELD '03'.
  IF sy-subrc <> 0.
    MESSAGE e001(00) WITH text-e01 p_vkorg.
  ENDIF.

*-INITIALIZATION--------------------------------------------------------
INITIALIZATION.
  PERFORM log_create.


*-START OF SELECTION----------------------------------------------------
START-OF-SELECTION.

  EXPORT lv_cod FROM sy-tcode TO MEMORY ID 'TCOD'.

  SELECT SINGLE bukrs INTO gv_bukrs2 FROM yam_ctam_ccodes
        WHERE bukrs = p_vkorg.
  IF NOT sy-subrc = 0.
    ctamflag = 'N'.
  ELSE.
    ctamflag = 'Y'.
  ENDIF.

* first select quotations
  IF ctamflag = 'Y'.
    SELECT a~vbeln b~posnr a~auart a~qmnum a~aufnr a~kunnr a~erdat
           a~angdt a~bnddt a~vkorg a~vtweg a~spart a~vkbur a~vkgrp b~matnr b~netpr b~kpein b~meins b~netwr a~ernam a~vgbel
      INTO CORRESPONDING FIELDS OF TABLE gt_vbak_vbap
      FROM vbak AS a
      INNER JOIN vbap AS b ON
       a~vbeln = b~vbeln
        WHERE  a~vtweg EQ p_vtweg
           AND a~vkorg EQ p_vkorg
           AND a~spart EQ p_spart
           AND a~vkbur IN s_vkbur
           AND a~vkgrp IN s_vkgrp
           AND a~kunnr IN s_kunnr
           AND a~bnddt IN s_bnddt
           AND a~ernam IN s_ernam
           AND a~aufnr IN s_aufnr
           AND a~erdat IN s_erdat
           AND a~auart IN ('ZQ01','ZAE')
           AND b~pstyv IN ('ZAGE','ZAEN','ZQ03','ZQ01')
           AND b~posnr = '10'.
  ELSE.
    SELECT a~vbeln b~posnr a~auart a~qmnum a~aufnr a~kunnr a~erdat
       a~angdt a~bnddt a~vkorg a~vtweg a~spart a~vkbur a~vkgrp b~matnr b~netpr b~kpein b~meins b~netwr a~ernam a~vgbel
  INTO CORRESPONDING FIELDS OF TABLE gt_vbak_vbap
  FROM vbak AS a
  INNER JOIN vbap AS b ON
   a~vbeln = b~vbeln
    WHERE  a~vtweg EQ p_vtweg
       AND a~vkorg EQ p_vkorg
       AND a~spart EQ p_spart
       AND a~vkbur IN s_vkbur
       AND a~vkgrp IN s_vkgrp
       AND a~kunnr IN s_kunnr
       AND a~bnddt IN s_bnddt
       AND a~ernam IN s_ernam
       AND a~erdat IN s_erdat
       AND a~auart IN ('ZQ01','ZAE')
       AND b~pstyv IN ('ZAGE','ZAEN','ZQ03','ZQ01')
       AND b~posnr = '10'.
  ENDIF.

  SORT gt_vbak_vbap BY vbeln.

  LOOP AT gt_vbak_vbap.
*
    IF NOT gt_vbak_vbap IS INITIAL.

      SELECT SINGLE maktx INTO gt_vbak_vbap-maktx FROM makt WHERE
        matnr = gt_vbak_vbap-matnr.

      CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
        EXPORTING
          input  = gt_vbak_vbap-matnr
        IMPORTING
          output = gt_vbak_vbap-matnr.

      IF ctamflag = 'Y'.
        SELECT SINGLE qmnum INTO gt_vbak_vbap-qmnum FROM afih WHERE aufnr = gt_vbak_vbap-aufnr.
      ELSE.
        IF gt_vbak_vbap-qmnum = ' '.
          SELECT SINGLE qmnum INTO gt_vbak_vbap-qmnum FROM vbak WHERE vbeln = gt_vbak_vbap-vgbel.
        ENDIF.
        SELECT SINGLE aufnr INTO gt_vbak_vbap-aufnr FROM vbep WHERE vbeln = gt_vbak_vbap-vbeln.
      ENDIF.

      MODIFY gt_vbak_vbap TRANSPORTING matnr maktx qmnum aufnr.

      IF NOT s_aufnr[] IS INITIAL.
        IF NOT gt_vbak_vbap-aufnr IN s_aufnr.
          DELETE gt_vbak_vbap.
        ENDIF.
      ENDIF.

    ENDIF.
  ENDLOOP.

  LOOP AT gt_vbak_vbap.

    IF NOT gt_vbak_vbap IS INITIAL.

*.... Select QUCR without QUAC
      REFRESH: h_status_tab.
      CONCATENATE 'OR' gt_vbak_vbap-aufnr INTO lv_objnr_ord.

      CALL FUNCTION 'STATUS_READ'
        EXPORTING
          objnr            = lv_objnr_ord
          only_active      = 'X'
        TABLES
          status           = h_status_tab
        EXCEPTIONS
          object_not_found = 01.

*.... check status QUCR
      h_stat_flag = ' '.
      h_stat_flag2 = ' '.

      LOOP AT h_status_tab.
        IF h_status_tab-stat EQ 'I0395'.
          h_stat_flag = 'X'.
          EXIT.
        ENDIF.
        IF h_status_tab-stat EQ 'I0046'.
          h_stat_flag2 = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.

      IF h_stat_flag <> 'X'.       "When not status QUCR -> delete from internal table
        DELETE gt_vbak_vbap.
        CONTINUE.
      ENDIF.
      IF h_stat_flag2 = 'X'.       "When status CLSD -> also delete from internal table
        DELETE gt_vbak_vbap.
        CONTINUE.
      ENDIF.


      MODIFY gt_vbak_vbap.
    ENDIF.
  ENDLOOP.

* create ALV-GRID
  PERFORM build_field_catlog CHANGING gt_fieldcat.
  PERFORM fill_events_f14.
*  PERFORM fill_event_exit_tab_f14.
  PERFORM fill_layout_f14.

  PERFORM alv_display.

*- SUBROUTINES---------------------------------------------------------
*&---------------------------------------------------------------------*
*&      Form  build_field_catlog
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FIELDCAT  text
*----------------------------------------------------------------------*
FORM build_field_catlog  CHANGING pt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA : ls_fcat TYPE slis_fieldcat_alv.
  DATA : ls_sort TYPE slis_sortinfo_alv.

*-----------------------Sales Document------------------*
  ls_fcat-fieldname = 'VBELN'.
  ls_fcat-no_zero = 'X'.
  ls_fcat-seltext_l = 'Quotation'.
  ls_sort-spos = 1.
  ls_sort-fieldname = ls_fcat-fieldname.
  ls_sort-up = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  APPEND ls_sort TO gt_sort.
  CLEAR: ls_fcat, ls_sort.
*-----------------------Sales Document Item---------------------*
  ls_fcat-fieldname = 'POSNR'.
  ls_fcat-seltext_l = 'Item'.
  ls_fcat-outputlen = '4'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales Document Type----------------*
  ls_fcat-fieldname = 'AUART'.
  ls_fcat-seltext_l = 'Type'.
  ls_fcat-outputlen = '4'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Created By----------------*
  ls_fcat-fieldname = 'ERNAM'.
  ls_fcat-rollname = 'ERNAM'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Notification-----------*
  ls_fcat-fieldname = 'QMNUM'.
  ls_fcat-rollname = 'QMNUM'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Service Order----------------------------*
  ls_fcat-fieldname = 'AUFNR'.
  ls_fcat-rollname = 'AUFNR'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sold-to Partner----------------------*
  ls_fcat-fieldname = 'KUNNR'.
  ls_fcat-rollname = 'KUNNR'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Quotation Creation Date--------------------*
  ls_fcat-fieldname = 'ERDAT'.
  ls_fcat-rollname = 'ERDAT'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Valid From--------------*
  ls_fcat-fieldname = 'ANGDT'.
  ls_fcat-rollname = 'ANGDT'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Valid To----------------------*
  ls_fcat-fieldname = 'BNDDT'.
  ls_fcat-rollname = 'BNDDT'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Material Number--------------*
  ls_fcat-fieldname = 'MATNR'.
  ls_fcat-rollname = 'MATNR'.
  ls_fcat-no_zero = 'X'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Material Description---------------------*
  ls_fcat-fieldname = 'MAKTX'.
  ls_fcat-rollname = 'MAKTX'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Net Price--------------*
  ls_fcat-fieldname = 'NETPR'.
  ls_fcat-rollname = 'NETPR'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Pricing Unit-------------------*
  ls_fcat-fieldname = 'KPEIN'.
  ls_fcat-rollname = 'KPEIN'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Unit Of Measure--------*
  ls_fcat-fieldname = 'MEINS'.
  ls_fcat-rollname = 'MEINS'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Net Value------*
  ls_fcat-fieldname = 'NETWR'.
  ls_fcat-rollname = 'NETWR'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales Organisation------------------*
  ls_fcat-fieldname = 'VKORG'.
  ls_fcat-rollname = 'VKORG'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Distribution Channel-----------*
  ls_fcat-fieldname = 'VTWEG'.
  ls_fcat-rollname = 'VTWEG'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Division------------------------*
  ls_fcat-fieldname = 'SPART'.
  ls_fcat-rollname = 'SPART'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales Office-----------------*
  ls_fcat-fieldname = 'VKBUR'.
  ls_fcat-rollname = 'VKBUR'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*-----------------------Sales Group--------------------*
  ls_fcat-fieldname = 'VKGRP'.
  ls_fcat-rollname = 'VKGRP'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

ENDFORM.                    " build_field_catlog

*&---------------------------------------------------------------------*
*&      Form  fill_events_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_events_f14.

  DATA lv_event       TYPE slis_alv_event.

  CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
    EXPORTING
      i_list_type = 0
    IMPORTING
      et_events   = g_events_tab.

*--- allocate form for user-command ---------------------------------*
  READ TABLE g_events_tab WITH KEY name = slis_ev_user_command
                        INTO lv_event.
  IF sy-subrc = 0.
    MOVE g_form_user_command TO lv_event-form.
    MODIFY g_events_tab FROM lv_event INDEX sy-tabix.
  ENDIF.

*--- allocate form for set-pf-status---------------------------------*
  READ TABLE g_events_tab WITH KEY name = slis_ev_pf_status_set
                          INTO h_event.
  IF sy-subrc = 0.
    MOVE g_form_set_pf_stat TO h_event-form.
    MODIFY g_events_tab FROM h_event INDEX sy-tabix.
  ENDIF.

ENDFORM.                    " fill_events_f14

*&---------------------------------------------------------------------*
*&      Form  alv_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_display .

  g_repid = sy-repid.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
     EXPORTING
       i_buffer_active                   = 'X'
       i_callback_program                =  g_repid
       i_save                            = 'A'
       it_events                         =  g_events_tab[]
*      I_GRID_TITLE                      =
*      I_GRID_SETTINGS                   =
       is_layout                         =  g_layout
       it_fieldcat                       =  gt_fieldcat[]
       it_sort                            = gt_sort
     TABLES
        t_outtab                         =  gt_vbak_vbap[].

ENDFORM.                    " alv_display

*&---------------------------------------------------------------------*
*&      Form  user_command_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
FORM user_command_l USING p_ucomm LIKE sy-ucomm
                          p_selfield TYPE slis_selfield.
*.. Local variables
  DATA: ld_subrc TYPE sy-subrc.
  DATA: ld_subrc2 TYPE sy-subrc.
  DATA: ld_subrc3 TYPE sy-subrc.
  DATA: ld_subrc4 TYPE sy-subrc.

  PERFORM set_p_selfield_general_f16 USING p_selfield.

  p_selfield-refresh = g_s.
  g_index = p_selfield-tabindex.
  CASE p_ucomm.
    WHEN '&CLOQUOT'.
*...... Generate popup to confirm indexation step
      PERFORM confirm_step_popup CHANGING ld_subrc.
      CHECK ld_subrc EQ 0.
*      PERFORM check_object_tab_marked_f14 USING p_ucomm
*                                               p_selfield.
      LOOP AT gt_vbak_vbap WHERE selected = g_x. "AND flag EQ space.
        ld_subrc2 = 0.
        ld_subrc3 = 0.
        ld_subrc4 = 0.
* fill in the reason for rejection
        READ TABLE fields INDEX 1.
        IF sy-subrc EQ 0.
          SELECT SINGLE bezei INTO gt_vbak_vbap-abgru_text FROM tvagt
          WHERE abgru  = fields-value AND spras = sy-langu.
          IF sy-subrc EQ 0.
            gt_vbak_vbap-abgru = fields-value.
            MODIFY gt_vbak_vbap.
          ENDIF.
        ENDIF.
*   Process quoation/notification and order
        REFRESH i_bdcdata.
        PERFORM close_quotation.
        CALL TRANSACTION c_va22 USING i_bdcdata MODE lv_mode
               UPDATE 'S' MESSAGES INTO i_messtab.
        ld_subrc2 =  sy-subrc.
        IF sy-subrc = 0.
          REFRESH i_bdcdata.
          PERFORM close_order.
          CALL TRANSACTION c_iw32 USING i_bdcdata MODE lv_mode
                 UPDATE 'S' MESSAGES INTO i_messtab.
          ld_subrc3 =  sy-subrc.
          IF sy-subrc = 0.
            REFRESH i_bdcdata.
            PERFORM close_notification.
            CALL TRANSACTION c_iw52 USING i_bdcdata MODE lv_mode
                   UPDATE 'S' MESSAGES INTO i_messtab.
            ld_subrc4 =  sy-subrc.
          ENDIF.
        ENDIF.

        IF ld_subrc2 = 0  AND ld_subrc3 = 0 AND ld_subrc4 = 0.
          gt_vbak_vbap-color = c_color_green.
          PERFORM output_list_ok.
        ELSE.
          gt_vbak_vbap-color = c_color_red.
          PERFORM output_list_not_ok.
        ENDIF.
        gt_vbak_vbap-selected = ' '.
        MODIFY gt_vbak_vbap.
      ENDLOOP.
      PERFORM create_log.

* Show Order
    WHEN '&ORD'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
* Show Notification
    WHEN '&NOTI'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
    WHEN 'ERRORLOG'.
      PERFORM log_show.
* Show Outputlist
    WHEN 'OUTPUTLIST'.
      PERFORM output_list.
  ENDCASE.
ENDFORM.                    "user_command_l

*&---------------------------------------------------------------------*
*&      Form  set_p_selfield_general_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->F_SELFIELD text
*----------------------------------------------------------------------*
FORM set_p_selfield_general_f16 USING f_selfield TYPE slis_selfield.
  f_selfield-col_stable = g_x.
  f_selfield-row_stable = g_x.
ENDFORM.                    "set_p_selfield_general_f16


*&---------------------------------------------------------------------*
*&      Form  confirm_step_popup
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->LD_SUBRC   text
*----------------------------------------------------------------------*
FORM confirm_step_popup CHANGING ld_subrc TYPE sy-subrc.

  REFRESH fields.
  CLEAR fields.
  fields-tabname = 'VBAP'.
  fields-fieldname = 'ABGRU'.
  fields-field_obl = g_x.
  fields-value = '06'.
  APPEND fields.

  CALL FUNCTION 'POPUP_GET_VALUES'
          EXPORTING
*           NO_VALUE_CHECK        = ' '
             popup_title           = c_title
             start_column          = '90'
             start_row             = '15'
          IMPORTING
              returncode             = lv_answer
          TABLES
              fields                = fields
          EXCEPTIONS
              error_in_fields       = 1
          OTHERS                = 2.

  IF sy-subrc = 0 AND lv_answer = ' '.
    ld_subrc = 0.
  ELSE.
    ld_subrc = 4.
  ENDIF.

ENDFORM.                    "confirm_step_popup

*&---------------------------------------------------------------------*
*&      Form  fill_event_tab_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_event_tab_l .
  DATA h_event       TYPE slis_alv_event.
*--- allocate form for set-pf-status---------------------------------*
*--- within this list local form is taken !!! -----------------------*
  READ TABLE g_events_tab WITH KEY name = slis_ev_pf_status_set
                        INTO h_event.
  IF sy-subrc = 0.
    MOVE 'SET_PF_STAT_L' TO h_event-form.
    MODIFY g_events_tab FROM h_event INDEX sy-tabix.
  ENDIF.
ENDFORM.                    "fill_event_tab_l

*&---------------------------------------------------------------------*
*&      Form  set_pf_stat_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RT_EXTAG   text
*----------------------------------------------------------------------*
FORM set_pf_stat_l USING rt_extag TYPE slis_t_extab.
  SET PF-STATUS 'YAM_QUOT'.
ENDFORM.                    "set_pf_stat_l

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_l  USING   p_ucomm LIKE sy-ucomm
                              p_selfield TYPE slis_selfield.

  CASE p_ucomm.
*   Display order
    WHEN '&ORD'.
      SET PARAMETER ID 'ANR' FIELD gt_vbak_vbap-aufnr.
      CALL TRANSACTION 'IW33' AND SKIP FIRST SCREEN.
*   Display notification
    WHEN '&NOTI'.
      SET PARAMETER ID 'IQM' FIELD gt_vbak_vbap-qmnum.
      CALL TRANSACTION 'IW53' AND SKIP FIRST SCREEN.
  ENDCASE.

ENDFORM.                    "fcodes_with_mark_l

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_f16
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_f16  USING p_ucomm LIKE sy-ucomm
                                p_selfield TYPE slis_selfield.

  PERFORM check_object_tab_marked_f14 USING p_ucomm p_selfield.

  LOOP AT gt_vbak_vbap WHERE selected = g_x .
    gv_index = sy-tabix.
    PERFORM fcodes_with_mark_l USING p_ucomm p_selfield.
    gt_vbak_vbap-selected = ' '.
    MODIFY gt_vbak_vbap INDEX gv_index.
  ENDLOOP.

  CLEAR p_ucomm.

ENDFORM.                    "fcodes_with_mark_f16

*&---------------------------------------------------------------------*
*&      Form  check_object_tab_marked_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM    text
*      -->P_SELFIELD text
*----------------------------------------------------------------------*
FORM check_object_tab_marked_f14  USING    p_ucomm LIKE sy-ucomm
                                        p_selfield TYPE slis_selfield.

  READ TABLE gt_vbak_vbap WITH KEY selected = g_x.

  IF NOT sy-subrc IS INITIAL.
    IF NOT p_selfield-tabindex IS INITIAL.
      READ TABLE gt_vbak_vbap INDEX p_selfield-tabindex.
      gt_vbak_vbap-selected = g_x.
      MODIFY gt_vbak_vbap INDEX p_selfield-tabindex.
    ENDIF.
  ELSE.
*--- Checkbox markiert -----------------------------------------------*
    p_selfield-sel_tab_field = 'G_MARK'.
  ENDIF.

ENDFORM.                    "check_object_tab_marked_f14

*&---------------------------------------------------------------------*
*&      Form  fill_layout_f14
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM fill_layout_f14 .
  g_layout-box_fieldname        = 'SELECTED'.  "field for checkbox
  g_layout-get_selinfos         = g_x. "show selection screen
  g_layout-detail_popup         = g_x. "show detail via popup
  g_layout-detail_initial_lines = g_x. "all fields in detail
  g_layout-zebra                = g_x. "striped pattern
  g_layout-info_fieldname       = 'COLOR'.
ENDFORM.                    " fill_layout_f14


*&---------------------------------------------------------------------*
*&      Form  close_quotation
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM close_quotation.
* First Screen
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '0102' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_CURSOR' 'VBAK-VBELN'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'VBAK-VBELN' gt_vbak_vbap-vbeln
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Main Screen Quotation

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4001' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_CURSOR' 'VBAP-POSNR(01)'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=ITEM'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

* Item
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPMV45A' '4003' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=SICH'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'VBAP-ABGRU' gt_vbak_vbap-abgru
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


ENDFORM.                    "close_quotation

*&---------------------------------------------------------------------*
*&      Form  close_order
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM close_order.
* First Screen
  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLCOIH' '0101' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'CAUFVD-AUFNR' gt_vbak_vbap-aufnr
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  IF ctamflag = 'N'.
    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: 'SAPLCOIH' '3000' 'X' ' ' ' '
                       CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.

    PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING: '' '' '' 'BDC_OKCODE' '=ESPE'
                        CHANGING struct_bdcdata.

    APPEND struct_bdcdata TO i_bdcdata.
    CLEAR  struct_bdcdata.
  ENDIF.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLCOIH' '3000' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=BABL'
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: 'SAPLSPO1' '0100' 'X' ' ' ' '
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=YES'
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING: 'SAPLCOIH' '3000' 'X' ' ' ' '
                    CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING: '' '' '' 'BDC_OKCODE' '=BU'
                       CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

ENDFORM.                    "close_order

*&---------------------------------------------------------------------*
*&      Form  close_notification
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM close_notification.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLIQS0' '0100' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '/00'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_CURSOR' 'RIWO00-QMNUM'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.


  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                     USING: 'SAPLIQS0' '7200' 'X' ' ' ' '
                     CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=ARCH'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: 'SAPLIWO1' '0200' 'X' ' ' ' '
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

  PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                      USING: '' '' '' 'BDC_OKCODE' '=WTER'
                      CHANGING struct_bdcdata.

  APPEND struct_bdcdata TO i_bdcdata.
  CLEAR  struct_bdcdata.

ENDFORM.                    "close_notification

*&---------------------------------------------------------------------*
*&      Form  log_create
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM log_create.

* create an initial log file
  l_s_log-extnumber  = 'Application Log'.
  l_s_log-object = 'YAM_CLOS_QUOT'.
  l_s_log-aldate = sy-datlo.
  l_s_log-aluser = sy-uname.
  l_s_log-altime = sy-uzeit.

  CALL FUNCTION 'BAL_LOG_CREATE'
    EXPORTING
      i_s_log      = l_s_log
    IMPORTING
      e_log_handle = l_log_handle
    EXCEPTIONS
      OTHERS       = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
ENDFORM.                    "log_create

*&---------------------------------------------------------------------*
*&      Form  log_show
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM log_show .
  DATA:
    l_s_display_profile TYPE bal_s_prof.
  CLEAR  l_s_display_profile.

* get a prepared profile
  CALL FUNCTION 'BAL_DSP_PROFILE_POPUP_GET'
    IMPORTING
      e_s_display_profile = l_s_display_profile
    EXCEPTIONS
      OTHERS              = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* set report to allow saving of variants
  l_s_display_profile-disvariant-report = sy-repid.
  CALL FUNCTION 'BAL_DSP_LOG_DISPLAY'
    EXPORTING
      i_s_display_profile = l_s_display_profile
    EXCEPTIONS
      OTHERS              = 1.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
             WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    "log_show

*&---------------------------------------------------------------------*
*&      Form  create_log
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM create_log .
* LOOP THE BDC MESSAGE TABLE
  LOOP AT i_messtab.
    l_s_msg-msgty = i_messtab-msgtyp.
    l_s_msg-msgid = i_messtab-msgid.
    l_s_msg-msgno = i_messtab-msgnr.
    l_s_msg-msgv1 = i_messtab-msgv1.
    l_s_msg-msgv2 = i_messtab-msgv2.
    l_s_msg-msgv3 = i_messtab-msgv3.
    l_s_msg-msgv4 = i_messtab-msgv4.
    CALL FUNCTION 'BAL_LOG_MSG_ADD'
      EXPORTING
        i_log_handle = l_log_handle
        i_s_msg      = l_s_msg
      EXCEPTIONS
        OTHERS       = 1.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

  ENDLOOP.
  REFRESH i_messtab.
  APPEND l_log_handle TO lt_logh.


ENDFORM.                    "create_log


*&---------------------------------------------------------------------*
*&      Form  OUTPUT_LIST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM output_list.
  SET PF-STATUS 'YAM_BASIC'.



  LEAVE TO LIST-PROCESSING.

  WRITE: sy-title, 85 sy-datum, 100 sy-uzeit, 115 sy-pagno.
  ULINE.

  WRITE: 001 'Notif Nbr',
         013 'Notif.',
         022 'Serv.Order',
         035 'SEO',
         046 'Quotation',
         058 'Quot Item',
         071 'Material',
         085 'Material Descr.',
         127 'Reason for'.

  WRITE: /013 'Status',
          022 'Number',
          035 'Status',
          127 'Rejection'.

  ULINE.
  SKIP.

  LOOP AT gt_outputlist.
    IF gt_outputlist-col = 'R'.
      FORMAT COLOR COL_NEGATIVE.
    ELSE.
      FORMAT COLOR COL_POSITIVE.
    ENDIF.
    WRITE: /001 gt_outputlist-qmnum,
               013 gt_outputlist-nstat,
               022 gt_outputlist-aufnr,
               035 gt_outputlist-ostat,
               046 gt_outputlist-vbeln,
               058 gt_outputlist-posnr,
               071 gt_outputlist-matnr,
               085 gt_outputlist-maktx,
               127 gt_outputlist-abgru.
    FORMAT RESET.
  ENDLOOP.

ENDFORM.                    "OUTPUT_LIST

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_LIST_OK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM output_list_ok.

  DATA:  lv_stat(5) TYPE c,
         lv_abgru LIKE vbap-abgru.

  CLEAR gt_outputlist.


  gt_outputlist-qmnum = gt_vbak_vbap-qmnum.
  gt_outputlist-aufnr = gt_vbak_vbap-aufnr.
  gt_outputlist-vbeln = gt_vbak_vbap-vbeln.
  gt_outputlist-posnr = gt_vbak_vbap-posnr.
  gt_outputlist-matnr = gt_vbak_vbap-matnr.
  gt_outputlist-maktx = gt_vbak_vbap-maktx.
  SELECT SINGLE abgru INTO lv_abgru FROM vbap
    WHERE vbeln = gt_vbak_vbap-vbeln AND posnr = gt_vbak_vbap-posnr.
  IF sy-subrc = 0.
    SELECT SINGLE bezei INTO gt_outputlist-abgru FROM tvagt
      WHERE abgru = lv_abgru AND spras = sy-langu.
  ENDIF.
  gt_outputlist-col = 'G'.

* get status order

  CONCATENATE 'OR' gt_vbak_vbap-aufnr INTO lv_objnr_ord.


  SELECT SINGLE stat INTO lv_stat FROM jest
     WHERE objnr = lv_objnr_ord
      AND stat  IN ('I0046')
      AND inact = ' '.

  IF sy-subrc EQ 0.
    gt_outputlist-ostat = 'CLSD'.
  ELSE.
    gt_outputlist-ostat = 'NOT CLSD'.
  ENDIF.

* get status notification

  CONCATENATE 'QM' gt_vbak_vbap-qmnum INTO lv_objnr_qmnum.

  SELECT SINGLE stat INTO lv_stat FROM jest
  WHERE objnr = lv_objnr_qmnum
   AND stat  IN ('I0072')
   AND inact = ' '.

  IF sy-subrc EQ 0.
    gt_outputlist-nstat = 'NOCO'.
  ELSE.
    gt_outputlist-nstat = 'NOT NOCO'.
  ENDIF.

  APPEND gt_outputlist.

ENDFORM.                    "OUTPUT_LIST_OK

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_LIST_NOT_OK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM  output_list_not_ok.

  DATA: lv_stat(5) TYPE c,
        lv_abgru LIKE vbap-abgru.

  CLEAR gt_outputlist.

  gt_outputlist-qmnum = gt_vbak_vbap-qmnum.
  gt_outputlist-aufnr = gt_vbak_vbap-aufnr.
  gt_outputlist-vbeln = gt_vbak_vbap-vbeln.
  gt_outputlist-posnr = gt_vbak_vbap-posnr.
  gt_outputlist-matnr = gt_vbak_vbap-matnr.
  gt_outputlist-maktx = gt_vbak_vbap-maktx.
  SELECT SINGLE abgru INTO lv_abgru FROM vbap
    WHERE vbeln = gt_vbak_vbap-vbeln AND posnr = gt_vbak_vbap-posnr.
  IF sy-subrc = 0.
    SELECT SINGLE bezei INTO gt_outputlist-abgru FROM tvagt
      WHERE abgru = lv_abgru AND spras = sy-langu.
  ENDIF.
  gt_outputlist-col = 'R'.

* get status order

  CONCATENATE 'OR' gt_vbak_vbap-aufnr INTO lv_objnr_ord.

  SELECT SINGLE stat INTO lv_stat FROM jest
    WHERE objnr = lv_objnr_ord
     AND stat  IN ('I0046')
     AND inact = ' '.

  IF sy-subrc EQ 0.
    gt_outputlist-ostat = 'CLSD'.
  ELSE.
    gt_outputlist-ostat = 'NOT CLSD'.
  ENDIF.

* get status notification

  CONCATENATE 'QM' gt_vbak_vbap-qmnum INTO lv_objnr_qmnum.

  SELECT SINGLE stat INTO lv_stat FROM jest
      WHERE objnr = lv_objnr_qmnum
       AND stat  IN ('I0072')
       AND inact = ' '.

  IF sy-subrc EQ 0.
    gt_outputlist-nstat = 'NOCO'.
  ELSE.
    gt_outputlist-nstat = 'NOT NOCO'.
  ENDIF.

  APPEND gt_outputlist.

ENDFORM.                    "OUTPUT_LIST_NOT_OK

*Text symbol text£º
*001:Organizational data
*002:Transactional Data
*E01:You have no authorisation for sales organisation :
*E03:No authorization for sales organisation: &1
*I01:No contracts selected !
*I10:Act_rev
*I11:Profit Center (Text)
*I12:Sales Org.(Text)
*I13:Region (Text)
*I14:Sales district(Text)
*I15:Sales office(Text)
*I16:Customer Industrial Code
*I17:Customer Ind.Code(Text)
*I18:Customer group(Text)
*I19:Customer Name
*I20:PLC(Text)
*I21:GAC(Text)
*I22:PGC(Text)
*I23:Plant(Text)
*I24:Equipment description
*I25:Contract
*I26:Contract item invoiced
*I27:Contract item invoice outstanding
*I28:Contract item value total
*I29:Product
*I30:Product description
*I31:Revenues Actual
*I32:Cash discount Actual
*I33:Net invoiced sales Actual
*I34:Unadjusted COS Actual
*I35:Parts Actual
*I36:Labour Actual
*I37:Mileage Actual
*I38:Ad Hoc Expenses Actual
*I39:Subcontracting Actual
*I40:COGS-Contract provis Actual
*I41:Fix price accruals Actual
*I42:Unadjusted COGS Actual
*I43:Unadjusted Gross Profit Actual
*I44:% UGP Actual
*I45:Tot.Revenues Planned
*I46:Tot.Costs Planned
*I47:Tot.Planned GP value
*I48:Tot.Planned GP value %
*I49:Total Acutal Costs
*I50:Balance Receivables not invoiced
*I51:Balance Accrued Revenue

*I55:Sales group(Text)
*Selection text£º
*P_SPART:D       .
*P_VKORG:D       .
*P_VTWEG:D       .
*S_AUFNR:        Service Order
*S_BNDDT:D       .
*S_ERDAT:D       .
*S_ERNAM:D       .
*S_KUNNR:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
