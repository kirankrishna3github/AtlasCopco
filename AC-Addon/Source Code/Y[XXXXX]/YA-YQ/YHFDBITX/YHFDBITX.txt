************************************************************************
*          Copyright(c) 2003 Deutsche Bank AG
* All rights reserved. This Software is proprietary to Deutsche Bank AG
* and is protected by copyright law and international treaties. Under no
* circumstances are you permitted to make any attempt to alter, decrypt
* or reverse engineer this software, and any unauthorised reproduction
* of this software or any portion thereof may result in severe civil and
* criminal penalties, and will be prosecuted to the maximum extent
* possible under the law.
***********************************************************************
REPORT YHFDBITX LINE-SIZE 160
                LINE-COUNT 65
                NO STANDARD PAGE HEADING
                MESSAGE-ID FR.
**********************************************************************
*  Author       :  Deutsche Bank AG
*  Date          :  Apr/2003
*  Description  :  This program extracts withholding tax.
*                  For Auto and Outgoing payment.
*  Assumption   :  Withholding tax either at invoice or payment level
*                  but not both.
*  Ajay         :  17/06/2004 Performance Tuneing and major logic
*                  changes has done
*  Ajay         :  23/08/2004 Receipt Type changes
* Ajay          :  18/08/2005 Income Type logic incorporation
************************************************************************
CONSTANTS: C_MAX TYPE I VALUE 800.
* DDIC-Objects ********************************************************
TABLES: BSIK, BSAK, BSEC, LFA1, KNA1, TBSL, T001, T059Q, BSEG,
        WITH_ITEM, T059Z, T059ZT, BKPF, ADRC, BSAD, BSID, T059G.
TABLES: T042A, T042I, T012K, T059P.
TABLES: REGUH.
TABLES: T001Z, TCURX, LFBW.
* Thai-specific table
* TABLES: J_1HWTAX.
* variable declaration
************************* Data Declaration *****************************
* Global fields *******************************************************
DATA: FILENAME(120), REPFILE(120).
DATA: WS_WARN_FN_ERR(1), DBD_PAY1(270).
DATA: PC_FILE LIKE RLGRAP-FILENAME.
*PARAMETERS:
*   DBD_PAY LIKE rlgrap-filename default
*'/usr/sap/transfer/th/bk/idms/out/'.
**Field symbols declaration*******************************************
FIELD-SYMBOLS: <FIELDX>.
** Global arrays and internal tables ***********************************
DATA: BEGIN OF I_REPORT OCCURS 0,
        BUKRS LIKE BSIK-BUKRS,
        NAME1 LIKE LFA1-NAME1,
        ADDR1 LIKE LFA1-STRAS,
        ADDR2 LIKE LFA1-STRAS,
        ADDR3 LIKE LFA1-STRAS,
        BELNR LIKE BSIK-BELNR,
        AUGDT LIKE BSIK-AUGDT,
        WT_WITHCD(5) TYPE C,
        WT_QSSHB LIKE WITH_ITEM-WT_QSSHB,
        WT_QBSHB LIKE WITH_ITEM-WT_QBSHB,
        QSATZ(10),
      END OF I_REPORT.

DATA: BEGIN OF SELTAB OCCURS 0.
        INCLUDE STRUCTURE RSPARAMS.
DATA: END OF SELTAB.

DATA : ITAB_BSIK LIKE BSIK OCCURS 1000 WITH HEADER LINE.
DATA : V_WTX_FORMAT_NO LIKE YHFFMTDT-FORMAT_NO.
DATA : V_REPORT(1000), YHLIVE(1) TYPE C VALUE 'X', CONVERT_TYPE(1).

DATA : ITAB_BSAD LIKE BSAD OCCURS 0 WITH HEADER LINE.
DATA : ITAB_BSID LIKE BSID OCCURS 0 WITH HEADER LINE.
DATA : ITAB_BSAKP LIKE BSAK OCCURS 0 WITH HEADER LINE.
DATA : ITAB_BSADP LIKE BSAD OCCURS 0 WITH HEADER LINE.


************************* User Selection *******************************
* Selection parameters ************************************************
SELECT-OPTIONS: W_LAUFI FOR REGUH-LAUFI NO INTERVALS.

SELECTION-SCREEN SKIP 1.
SELECTION-SCREEN BEGIN OF BLOCK CRITERIA WITH FRAME TITLE TEXT-001.
PARAMETERS:  CO_CODE LIKE WITH_ITEM-BUKRS.
SELECT-OPTIONS: S_LIFNR  FOR BSIK-LIFNR.
PARAMETERS: W_FYR LIKE WITH_ITEM-GJAHR.
SELECT-OPTIONS: W_DOCNO  FOR WITH_ITEM-BELNR,
*                S_BLART  FOR BSIK-BLART,
                S_AUGDT  FOR BSIK-AUGDT,
                S_BUDAT  FOR BSIK-BUDAT,
                S_CPUDT  FOR BKPF-CPUDT.
SELECT-OPTIONS: S_ZLSCH FOR BSEG-ZLSCH.
SELECTION-SCREEN END OF BLOCK CRITERIA.
SELECTION-SCREEN SKIP 1.
SELECT-OPTIONS: S_WITHT FOR WITH_ITEM-WITHT NO INTERVALS.
PARAMETERS:  DBD_PAY LIKE YHFHELP-YHPATH1,
             FNAME LIKE YHFHELP-YHFILE1 DEFAULT 'WTX',
             PCDWLOAD LIKE RFPDO1-F170XCRE,
             WTXPROG(50) NO-DISPLAY.
PARAMETERS: KATAKANA LIKE RFPDO1-F170XCRE NO-DISPLAY.

FIELD-GROUPS: HEADER, DETAIL.
INSERT: WITH_ITEM-BUKRS WITH_ITEM-BELNR WITH_ITEM-GJAHR
        WITH_ITEM-WITHT WITH_ITEM-WT_WITHCD INTO HEADER.
INSERT: WITH_ITEM-BUZEI WITH_ITEM-WT_QSSHB WITH_ITEM-WT_QBSHB
        WITH_ITEM-QSATZ WITH_ITEM-CTNUMBER WITH_ITEM-WT_ACCO
        WITH_ITEM-TEXT15 WITH_ITEM-WT_QSZRT WITH_ITEM-QSREC
        BSIK-BUDAT BSIK-ZLSCH BSIK-LIFNR BSIK-XREF3 INTO DETAIL.

* Header page**********************************************************
TOP-OF-PAGE.
  WRITE: /1 'REF:', 6 SY-REPID,
         60 ' DEUTSCHE BANK AG',
         127 SY-DATUM, 140 SY-UZEIT.
  WRITE: /1 SY-UNAME,
         60 'WITHHOLDING REPORT',
        136 'Page:', 143 SY-PAGNO.
  ULINE.
  PERFORM WRITE_PARM.
  ULINE.
  WRITE: /1   'Company'.
  WRITE:  15  'Payment Doc'.
  WRITE:  30  'ClrDate'.
  WRITE:  45  'Vendor Name1/Addr1 to 3'.
  WRITE:  95  'Tax Code'.
  WRITE:  113  'Base Amt'.
  WRITE:  130 'Tax Amt'.
  ULINE.

  INCLUDE YHFDBI86.

END-OF-SELECTION.
  DATA: IREGUH LIKE REGUH OCCURS 0 WITH HEADER LINE.
  IF ZW_LAUFI NE SPACE.
* For extracting WTX from auto payment.
    IF W_LAUFI EQ SPACE.
      SELECT * FROM REGUH INTO TABLE IREGUH
                          WHERE LAUFD = ZW_LAUFD
                          AND LAUFI   = ZW_LAUFI
                          AND XVORL   = ' '.
      LOOP AT IREGUH.
        PERFORM GET_BSIK USING 'AUTO'.
      ENDLOOP.

    ELSE.
      SELECT * FROM REGUH INTO TABLE IREGUH
                          WHERE LAUFD = ZW_LAUFD
                          AND ( LAUFI = ZW_LAUFI OR LAUFI IN W_LAUFI )
                          AND XVORL   = ' '.
      LOOP AT IREGUH.
        PERFORM GET_BSIK USING 'AUTO'.
      ENDLOOP.
    ENDIF.

  ELSE.
* For extracting WTX from outgoing payment.
    PERFORM GET_BSIK USING 'OUTGOING'.
  ENDIF.

  SORT ITAB_BSIK BY BUKRS AUGBL BELNR.
  DELETE ADJACENT DUPLICATES FROM ITAB_BSIK
         COMPARING BUKRS AUGBL BELNR.

  LOOP AT ITAB_BSIK.

    IF NOT ITAB_BSIK-BUDAT IN S_BUDAT.
*      OR NOT ITAB_BSIK-BLART IN S_BLART.
      CONTINUE.
    ENDIF.

    SELECT SINGLE GJAHR CPUDT STBLG INTO
                           (BKPF-GJAHR, BKPF-CPUDT, BKPF-STBLG)
                            FROM BKPF
                            WHERE BUKRS = ITAB_BSIK-BUKRS
                            AND        BELNR = ITAB_BSIK-BELNR
                            AND         GJAHR = ITAB_BSIK-GJAHR.

    IF BKPF-STBLG NE SPACE.
      CONTINUE.
    ENDIF.
    IF NOT BKPF-CPUDT IN S_CPUDT.
      CONTINUE.
    ENDIF.
*   IF S_AUGDT(1) NE SPACE.
*     IF ITAB_BSIK-AUGDT NE 0.
*       IF NOT ITAB_BSIK-AUGDT IN S_AUGDT.
*         CONTINUE.
*       ENDIF.
*     ELSE.
*       IF NOT ITAB_BSIK-BUDAT IN S_AUGDT.
*         CONTINUE.
*       ENDIF.
*     ENDIF.
*   ENDIF.
    PERFORM GET_PAYMETH.
    IF NOT ITAB_BSIK-ZLSCH IN S_ZLSCH.
      CONTINUE.
    ENDIF.

    CHECK ITAB_BSIK-BSTAT NE 'S'
      OR  ITAB_BSIK-UMSKZ EQ 'F'.

    CLEAR: WITH_ITEM.
    SELECT SINGLE * FROM BKPF WHERE BUKRS = WITH_ITEM-BUKRS
                           AND BELNR   = WITH_ITEM-AUGBL
                           AND GJAHR   = WITH_ITEM-GJAHR.
    IF BKPF-STBLG NE SPACE.
      CONTINUE.
    ENDIF.

* get WTX generated at payment or invoice
    IF ITAB_BSIK-AUGBL EQ ITAB_BSIK-BELNR.   "explore paydoc
      SELECT * FROM WITH_ITEM WHERE BUKRS EQ ITAB_BSIK-BUKRS
                              AND GJAHR   EQ ITAB_BSIK-GJAHR
                              AND BELNR   EQ ITAB_BSIK-BELNR
                              AND WITHT   IN S_WITHT.
        IF NOT ( WITH_ITEM-WT_WITHCD EQ SPACE
              OR WITH_ITEM-WT_WITHCD EQ '00'
              OR WITH_ITEM-WT_QBSHB  EQ 0 ).
          PERFORM GET_WTX_POSTM.
          IF T059P-WT_POSTM EQ '2'.   "wtx at payment
            MOVE-CORRESPONDING ITAB_BSIK TO BSIK.
            EXTRACT DETAIL.
          ENDIF.
        ENDIF.
      ENDSELECT.
* get normal wtx
      IF WITH_ITEM IS INITIAL.
        SELECT * FROM BSEG WHERE BUKRS EQ ITAB_BSIK-BUKRS
                     AND GJAHR   EQ ITAB_BSIK-GJAHR
                     AND BELNR   EQ ITAB_BSIK-BELNR
                     AND QBSHB   NE 0.
          WITH_ITEM-BUKRS     = ITAB_BSIK-BUKRS.
          WITH_ITEM-BELNR     = ITAB_BSIK-AUGBL.
          WITH_ITEM-GJAHR     = ITAB_BSIK-GJAHR.
          WITH_ITEM-WT_QSSHB  = BSEG-QSSHB.
          WITH_ITEM-WT_QBSHB  = BSEG-QBSHB.
          WITH_ITEM-WT_WITHCD = BSEG-QSSKZ.
          MOVE-CORRESPONDING ITAB_BSIK TO BSIK.
          EXTRACT DETAIL.
        ENDSELECT.
      ENDIF.
    ELSE.                   "explore invoice
      SELECT * FROM WITH_ITEM WHERE BUKRS EQ ITAB_BSIK-BUKRS
                              AND   GJAHR EQ ITAB_BSIK-GJAHR
                              AND   BELNR EQ ITAB_BSIK-BELNR
                              AND   WITHT IN S_WITHT.
        IF NOT ( WITH_ITEM-WT_WITHCD EQ SPACE
           OR WITH_ITEM-WT_WITHCD    EQ '00'
           OR WITH_ITEM-WT_QBSHB     EQ 0 ).
          PERFORM GET_WTX_POSTM.
          IF T059P-WT_POSTM EQ '1'.   "wtx at invoice
*          IF T059P-WT_POSTM >= '1'.   "wtx at invoice
            MOVE-CORRESPONDING ITAB_BSIK TO BSIK.
            WITH_ITEM-BELNR = ITAB_BSIK-AUGBL.
            EXTRACT DETAIL.
          ENDIF.
        ENDIF.
      ENDSELECT.
    ENDIF.
* get normal wtx
*    if with_item is initial and itab_bsik-qbshb ne 0.
*      WITH_ITEM-BUKRS = ITAB_BSIK-BUKRS.
*      WITH_ITEM-BELNR = ITAB_BSIK-AUGBL.
*      WITH_ITEM-GJAHR = ITAB_BSIK-GJAHR.
*      WITH_ITEM-WT_QSSHB = ITAB_BSIK-QSSHB.
*      WITH_ITEM-WT_QBSHB = ITAB_BSIK-QBSHB.
*      WITH_ITEM-WT_WITHCD = ITAB_BSIK-QSSKZ.
*      MOVE-CORRESPONDING ITAB_BSIK TO BSIK.
*      EXTRACT DETAIL.
*    endif.
  ENDLOOP.
  PERFORM PROCESS_TAX.
*---------------------------------------------------------------------*
*       FORM GET_WTX_POSTM                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM GET_WTX_POSTM.
  CLEAR: T001, T059P.
  SELECT SINGLE * FROM T001
                                     WHERE BUKRS EQ WITH_ITEM-BUKRS.
  SELECT SINGLE * FROM T059P WHERE LAND1 = T001-LAND1
                                     AND WITHT = WITH_ITEM-WITHT.
  IF SY-SUBRC EQ 0.
    IF T059P-WT_POSTM EQ '1' AND WITH_ITEM-WT_QBSHB < 0.
*    IF T059P-WT_POSTM >= '1' AND WITH_ITEM-WT_QBSHB < 0.
      WITH_ITEM-WT_QSSHB = WITH_ITEM-WT_QSSHB * -1.
      WITH_ITEM-WT_QBSHB = WITH_ITEM-WT_QBSHB * -1.
    ENDIF.
  ENDIF.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_BSIK                                                 *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  X_MODE                                                        *
*---------------------------------------------------------------------*
FORM GET_BSIK USING X_MODE.
  IF X_MODE EQ 'AUTO'.
*    SELECT * FROM BKPF WHERE BUKRS = IREGUH-ZBUKR
*                       AND   BELNR = IREGUH-VBLNR.
    SELECT GJAHR BUDAT INTO (BKPF-GJAHR, BKPF-BUDAT)
                       FROM BKPF
                       WHERE BUKRS = IREGUH-ZBUKR
                       AND        BELNR = IREGUH-VBLNR.
      IF BKPF-BUDAT EQ IREGUH-ZALDT.
        EXIT.
      ENDIF.
    ENDSELECT.
* get all invoices assuming no partial for auto payment
*   IF IREGUH-LIFNR NE SPACE.
*      SELECT * FROM BSAK APPENDING TABLE ITAB_BSIK
*                         WHERE BUKRS EQ IREGUH-ZBUKR
*                         AND          LIFNR EQ IREGUH-LIFNR
*                         AND        GJAHR EQ BKPF-GJAHR
*                         AND        AUGBL EQ IREGUH-VBLNR.
*      LOOP AT ITAB_BSIK.
*        ITAB_BSIK-ZLSCH = IREGUH-RZAWE.
*        MODIFY ITAB_BSIK TRANSPORTING ZLSCH.
*      ENDLOOP.
*    ELSE.
*      SELECT * FROM BSAD APPENDING TABLE ITAB_BSIK
*                         WHERE BUKRS EQ IREGUH-ZBUKR
*                         AND      KUNNR EQ IREGUH-KUNNR
*                         AND       GJAHR EQ BKPF-GJAHR
*                         AND       AUGBL EQ IREGUH-VBLNR.
*      LOOP AT ITAB_BSIK.
*        ITAB_BSIK-ZLSCH = IREGUH-RZAWE.
*        MODIFY ITAB_BSIK TRANSPORTING ZLSCH.
*      ENDLOOP.
*    ENDIF.



    IF IREGUH-LIFNR NE SPACE.
      SELECT * FROM BSAK
               WHERE BUKRS EQ IREGUH-ZBUKR
              AND   LIFNR EQ IREGUH-LIFNR
             AND     GJAHR EQ BKPF-GJAHR
             AND     AUGBL EQ IREGUH-VBLNR.
        MOVE-CORRESPONDING BSAK TO ITAB_BSIK.
        ITAB_BSIK-ZLSCH = IREGUH-RZAWE.
        APPEND ITAB_BSIK.
     ENDSELECT.
    ELSE.
      SELECT * FROM BSAD
          WHERE BUKRS EQ IREGUH-ZBUKR
             AND KUNNR EQ IREGUH-KUNNR
             AND GJAHR EQ BKPF-GJAHR
             AND AUGBL EQ IREGUH-VBLNR.
        MOVE-CORRESPONDING BSAD TO ITAB_BSIK.
        ITAB_BSIK-LIFNR = BSAD-KUNNR.
        ITAB_BSIK-ZLSCH = IREGUH-RZAWE.
        APPEND ITAB_BSIK.
      ENDSELECT.
    ENDIF.


  ELSE.
* get invoices
    SELECT * FROM BSAK APPENDING TABLE ITAB_BSIK
                       WHERE ( BUKRS = CO_CODE
                       AND          AUGBL IN W_DOCNO
                       AND          LIFNR   IN S_LIFNR
                       AND          GJAHR =  W_FYR
                       AND          AUGDT IN S_AUGDT ).

* get partial invoices
    CLEAR: ITAB_BSIK.
    SELECT * FROM BSIK APPENDING TABLE ITAB_BSIK
                       WHERE ( BUKRS = CO_CODE
                       AND         BELNR IN W_DOCNO
                       AND         GJAHR  = W_FYR
                       AND         LIFNR IN S_LIFNR
*                       AND         AUGBL  = SPACE
                      AND         AUGBL  NE SPACE
* avoid clearing date criteria if partial payment exist.
                       AND         AUGDT IN S_AUGDT ).
    LOOP AT ITAB_BSIK WHERE AUGBL EQ SPACE.
      ITAB_BSIK-AUGBL = ITAB_BSIK-BELNR.
      MODIFY ITAB_BSIK TRANSPORTING AUGBL.
    ENDLOOP.

* ditto for AR
    SELECT * FROM BSAD INTO TABLE ITAB_BSAD
                       WHERE ( BUKRS = CO_CODE
                       AND   AUGBL IN W_DOCNO
                      AND   KUNNR IN S_LIFNR
                      AND   GJAHR  = W_FYR
                      AND   AUGDT IN S_AUGDT ).
    LOOP AT ITAB_BSAD.
      IF ITAB_BSAD-AUGBL NE ITAB_BSAD-BELNR.
        MOVE-CORRESPONDING ITAB_BSAD TO ITAB_BSIK.
        ITAB_BSIK-XREF3 = ITAB_BSAD-KUNNR.
        APPEND ITAB_BSIK.
      ENDIF.
    ENDLOOP.

* ditto for AR
    SELECT * FROM BSID INTO TABLE ITAB_BSID
                       WHERE BUKRS EQ CO_CODE
                       AND BELNR IN W_DOCNO
                       AND KUNNR IN S_LIFNR
                       AND GJAHR EQ W_FYR
                       AND AUGBL EQ SPACE
* avoid clearing date criteria if partial payment exist.
                       AND AUGDT IN S_AUGDT.
    CLEAR: ITAB_BSIK.
    LOOP AT ITAB_BSID.
      MOVE-CORRESPONDING ITAB_BSID TO ITAB_BSIK.
      ITAB_BSIK-XREF3 = ITAB_BSID-KUNNR.
      APPEND ITAB_BSIK.
    ENDLOOP.
  ENDIF.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_PAYMETH                                              *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM GET_PAYMETH.
  DATA: INV_NO LIKE BSEG-BELNR.

  IF ITAB_BSIK-ZLSCH EQ SPACE.
* check at partial invoice
    IF ITAB_BSIK-REBZG NE SPACE.
      INV_NO = ITAB_BSIK-REBZG.
    ELSE.
      SELECT * FROM BSAK INTO TABLE ITAB_BSAKP
                         WHERE BUKRS = ITAB_BSIK-BUKRS
                         AND          LIFNR = ITAB_BSIK-LIFNR
                         AND         AUGBL = ITAB_BSIK-BELNR
                         AND         GJAHR = ITAB_BSIK-GJAHR.
      LOOP AT ITAB_BSAKP.
        IF ITAB_BSAKP-BELNR NE ITAB_BSAKP-AUGBL.
          INV_NO = ITAB_BSAKP-BELNR.
        ENDIF.
      ENDLOOP.
      IF INV_NO EQ SPACE.
        SELECT * FROM BSAD INTO TABLE ITAB_BSADP
                           WHERE BUKRS = ITAB_BSIK-BUKRS
                           AND     KUNNR   = ITAB_BSIK-LIFNR
                           AND      AUGBL   = ITAB_BSIK-BELNR
                           AND      GJAHR   = ITAB_BSIK-GJAHR.
        LOOP AT ITAB_BSADP.
          IF ITAB_BSADP-BELNR NE ITAB_BSADP-AUGBL.
            INV_NO = ITAB_BSADP-BELNR.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDIF.

    CLEAR BSEG.
    SELECT SINGLE ZLSCH INTO ITAB_BSIK-ZLSCH  FROM BSEG
                        WHERE BUKRS = ITAB_BSIK-BUKRS
                        AND      BELNR   = ITAB_BSIK-BELNR
                        AND      GJAHR   = ITAB_BSIK-GJAHR
                        AND       ZLSCH  NE SPACE.
  ENDIF.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM PROCESS_TAX                                              *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM PROCESS_TAX.
  DATA: HDR_TXT(30) TYPE C.
  DATA: REC_CNT TYPE I.
  DATA: TOT_CNT TYPE I.
  DATA: SUM_QSSHB LIKE WITH_ITEM-WT_QSSHB,
        SUM_QBSHB LIKE WITH_ITEM-WT_QBSHB.
  DATA: TOT_QSSHB LIKE WITH_ITEM-WT_QSSHB,
        TOT_QBSHB LIKE WITH_ITEM-WT_QBSHB.

  DATA: BEGIN OF lt_itable OCCURS 10,
           line(800),
  END OF lt_itable.

  IMPORT  DBD_PAY1 FROM  MEMORY ID 'DBD_PAY1'.
  IF DBD_PAY1 NE SPACE.
    CONCATENATE DBD_PAY1 FNAME SY-DATUM INTO FILENAME.
    CONCATENATE DBD_PAY1 FNAME SY-DATUM 'REP' INTO REPFILE.
  ELSE.
    CONCATENATE DBD_PAY FNAME SY-DATUM INTO FILENAME.
    CONCATENATE DBD_PAY FNAME SY-DATUM 'REP' INTO REPFILE.
  ENDIF.
  IF PCDWLOAD NE 'X'.

*FOR 4.6
*    OPEN DATASET FILENAME FOR OUTPUT IN TEXT MODE.
*END 4.6

*FOR 4.7
OPEN DATASET FILENAME FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
*END 4.7

    IF SY-SUBRC <> 0.
      MESSAGE E135 WITH FILENAME.      "could not open file
      EXIT.
    ENDIF.
  ENDIF.
  IF WTXPROG NE SPACE.

*FOR 4.6
*    OPEN DATASET REPFILE FOR OUTPUT IN TEXT MODE.
*END 4.6

*FOR 4.7
OPEN DATASET REPFILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
*END 4.7

  ENDIF.
  SORT.
  LOOP.

    AT NEW WITH_ITEM-BELNR.
      IF PCDWLOAD EQ SPACE.
        HDR_TXT = '>>PAYMENT  '.
        HDR_TXT+12(10) = WITH_ITEM-BELNR.
        IF PCDWLOAD NE 'X'.
          TRANSFER HDR_TXT TO FILENAME.
        ELSE.
          I_TABLE-LINE = HDR_TXT.
          APPEND I_TABLE.
        ENDIF.
      ENDIF.
    ENDAT.

    PERFORM GET_ADD_INFO.

    SUM_QSSHB = SUM_QSSHB + WITH_ITEM-WT_QSSHB.
    SUM_QBSHB = SUM_QBSHB + WITH_ITEM-WT_QBSHB.
    TOT_QSSHB = TOT_QSSHB + WITH_ITEM-WT_QSSHB.
    TOT_QBSHB = TOT_QBSHB + WITH_ITEM-WT_QBSHB.

    AT END OF WITH_ITEM-WT_WITHCD.
      REC_CNT = REC_CNT + 1.
      TOT_CNT = TOT_CNT + 1.
      WITH_ITEM-WT_QSSHB = SUM_QSSHB.
      WITH_ITEM-WT_QBSHB = SUM_QBSHB.

      SELECT SINGLE PARM_VAL INTO V_WTX_FORMAT_NO
                             FROM YHFPARMI
                             WHERE BUKRS = WITH_ITEM-BUKRS
                             AND   PARM1 = 'WTX'
                             AND   PARM2 = 'FNO'.

      IF V_WTX_FORMAT_NO EQ SPACE.
        V_WTX_FORMAT_NO = 99.
      ENDIF.
      PERFORM GET_CONVERT_TYPE.
      PERFORM WRITE_PAYMENT USING
                           V_WTX_FORMAT_NO
                           ' '
                           FILENAME
                           IREGUH-RZAWE
                           WITH_ITEM-BUKRS
                           ' '
                           PCDWLOAD
                           CONVERT_TYPE
                           ' '
                           ' '
                           ' '.
      IF WTXPROG NE SPACE.
        DATA: V_QSSHB(20), V_QBSHB(20), V_QSATZ(10).
        V_QSSHB = I_REPORT-WT_QSSHB.
        V_QBSHB = I_REPORT-WT_QBSHB.
        CONCATENATE I_REPORT-BUKRS ';' I_REPORT-NAME1 ';'
           I_REPORT-ADDR1 ';' I_REPORT-ADDR2 ';' I_REPORT-ADDR3
           ';' I_REPORT-BELNR ';' I_REPORT-AUGDT ';' I_REPORT-WT_WITHCD
           ';' V_QSSHB ';' V_QBSHB ';' I_REPORT-QSATZ
           INTO V_REPORT.
        TRANSFER V_REPORT TO REPFILE.
      ENDIF.
      APPEND I_REPORT.
      CLEAR V_REPORT.
      CLEAR: SUM_QSSHB, SUM_QBSHB.
    ENDAT.

    AT END OF WITH_ITEM-BELNR.
      IF PCDWLOAD EQ SPACE.
        HDR_TXT = '>>NO OF REC'.
        HDR_TXT+12(10) = REC_CNT.
        IF PCDWLOAD NE 'X'.
          TRANSFER HDR_TXT TO FILENAME.
        ELSE.
          I_TABLE-LINE = HDR_TXT.
          APPEND I_TABLE.
        ENDIF.
        CLEAR REC_CNT.
      ENDIF.
    ENDAT.
  ENDLOOP.
  PERFORM PRINT_REPORT.
  SKIP 1.
  WRITE: /1 'No of records = '.
  WRITE AT 17 TOT_CNT.
  WRITE AT 60 'Total Amount >>'.
  WRITE AT 85 TOT_QSSHB.
  WRITE AT 105 TOT_QBSHB.

  IF PCDWLOAD NE 'X'.
    CLOSE DATASET FILENAME.
  ELSE.
*** FIX FOR PC DOWNLOAD ENCODING START ***********************
   IF LO_DATA_CONV IS INITIAL.
    SELECT PARM_VAL INTO LO_DATA_CONV FROM YHFPARMI
                  WHERE BUKRS = CO_CODE
                  AND   PARM1 = 'LDC'
                  AND   PARM2 = SPACE.
    ENDSELECT.
    IF NOT LO_DATA_CONV IS INITIAL.
    SELECT SINGLE PARM_VAL INTO codepage FROM YHFPARMI
                            WHERE BUKRS = CO_CODE
                            AND   PARM1 = REGUH-UBNKS
                            AND   PARM2 = SPACE.
*ORGNL COMMENT** Find out what codepage this source runs in right now
    CALL FUNCTION 'SCP_GET_CODEPAGE_NUMBER'
      EXPORTING
        database_also = ' '
     IMPORTING
        appl_codepage = in_codepage.
      out_codepage = codepage.
    ENDIF.
  ENDIF.
*
    LOOP AT I_TABLE.
        CALL FUNCTION 'SCP_TRANSLATE_CHARS_46'
          EXPORTING
            INBUFF    = I_TABLE-LINE
            INCODE    = in_codepage
            OUTBUFFLG = 9999
            OUTCODE   = out_codepage
            CTRLCODE  = ctrlcode
          IMPORTING
            OUTBUFF   = OUTFIELD.
          outlen = strlen( outfield ).

         MOVE OUTFIELD TO LT_ITABLE-LINE.
         APPEND LT_ITABLE.CLEAR LT_ITABLE.
    ENDLOOP.

    PC_FILE = FILENAME.
    CALL FUNCTION 'WS_DOWNLOAD'
         EXPORTING
              FILENAME                = PC_FILE
              FILETYPE                = 'BIN'
         TABLES
              DATA_TAB                = LT_ITABLE
         EXCEPTIONS
              FILE_OPEN_ERROR         = 1
              FILE_WRITE_ERROR        = 2
              INVALID_TABLE_WIDTH     = 4
              NO_BATCH                = 6
              UNKNOWN_ERROR           = 7
              GUI_REFUSE_FILETRANSFER = 8
              OTHERS                  = 9.
    IF SY-SUBRC <> 0.
      MESSAGE E135 WITH FILENAME.      "could not open file
    ENDIF.
  ENDIF.
*** FIX FOR PC DOWNLOAD ENCODING END ***********************
ENDFORM.
*---------------------------------------------------------------------*
*       FORM GET_ADD_INFO                                             *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM GET_ADD_INFO.
  SELECT SINGLE * FROM T001
         WHERE BUKRS EQ WITH_ITEM-BUKRS.

* Thai-specific table
* CLEAR: J_1HWTAX.
* SELECT * FROM J_1HWTAX
*        WHERE BUKRS EQ WITH_ITEM-BUKRS
*          AND BELNR EQ WITH_ITEM-BELNR
*          AND GJAHR EQ WITH_ITEM-GJAHR
*          AND WITHT EQ WITH_ITEM-WITHT.
*   IF J_1HWTAX-VOIDR EQ SPACE
*      AND J_1HWTAX-WTCNF NE SPACE.
*     EXIT.    "exit select statement
*   ENDIF.
* ENDSELECT.

  CLEAR: BSEG.

*  To populate correct decimal value for with_tax amount.
  SELECT SINGLE * FROM BSEG WHERE BUKRS = WITH_ITEM-BUKRS
                                     AND   BELNR = WITH_ITEM-BELNR
                                     AND   GJAHR = WITH_ITEM-GJAHR
                                     AND   BUZEI   = 2.
  PERFORM CONVERSE_CURR USING WITH_ITEM-WT_QBSHB BSEG-PSWSL.
*  end

  SELECT SINGLE * FROM BSEG WHERE BUKRS EQ WITH_ITEM-BUKRS
                                    AND BELNR EQ WITH_ITEM-BELNR
                                   AND GJAHR EQ WITH_ITEM-GJAHR
                                   AND BUZEI EQ WITH_ITEM-BUZEI.
  IF BSEG-AUGDT EQ 0.
    BSEG-AUGDT = BSIK-BUDAT.
  ENDIF.
  CLEAR: LFA1, KNA1, ADRC, BSEC, T001Z, LFBW.

  IF BSIK-LIFNR NE SPACE.
    SELECT SINGLE * FROM LFA1 WHERE LIFNR EQ BSIK-LIFNR.
  ELSE.
    SELECT SINGLE * FROM KNA1 WHERE KUNNR EQ BSIK-XREF3.
    MOVE-CORRESPONDING KNA1 TO LFA1.
    LFA1-LIFNR = KNA1-KUNNR.
  ENDIF.


*for Diethelm BKK
*requirement to extract alternate payee (instead of original vendor)
*details in wtx details
*16.11.2006 by Yupinto
data: alt_payee.
data: alt_details like lfa1.
data: perm_payee like bsak-empfb.
data: alt_flag.


select single parm_val into alt_payee from yhfparmi
                                where bukrs eq co_code
                                and parm1 eq 'WTX'
                                and parm2 eq 'ALT'.
if alt_payee eq 'Y'.

clear: bsec, alt_details, perm_payee, alt_flag.

**first scenario: individual payee field is filled
  if lfa1-xzemp ne space.
    select single * from bsec where bukrs eq co_code
                        and belnr eq with_item-belnr
                        and gjahr eq with_item-gjahr.

  endif.

**second scenario: permitted payee field is filled
** and alternate payee also filled.
** in this case adrc should be set to permitted payee
** if perm_payee is not empty.
** else if it's empty adrc set to alt payee.


  if lfa1-xlfza ne space and lfa1-lnrza ne space.
   select single empfb into perm_payee from bsak where bukrs eq co_code
                                           and gjahr eq with_item-gjahr
                                           and augbl eq with_item-belnr
                                           and belnr ne with_item-belnr.

   if sy-subrc eq '0' and perm_payee ne space.
     alt_flag = 'X'.
     select single * into alt_details from lfa1
                         where lifnr eq perm_payee.
   else.
     alt_flag = 'X'.
     select single * into alt_details from lfa1
                       where lifnr eq lfa1-lnrza.

   endif.
  endif.

**third scenario: permitted payee field is filled
** and alternate payee not filled.
** in this case adrc should be set to permitted payee
** if perm_payee is not empty.

  if lfa1-xlfza ne space and lfa1-lnrza eq space.
   select single empfb into perm_payee from bsak where bukrs eq co_code
                                           and gjahr eq with_item-gjahr
                                           and augbl eq with_item-belnr
                                           and belnr ne with_item-belnr.

   if sy-subrc eq '0' and perm_payee ne space.
     alt_flag = 'X'.
     select single * into alt_details from lfa1
                         where lifnr eq perm_payee.
   endif.
  endif.

**fourth scenario: alternate payee field is filled and permitte payee
**not filled.
** in this case adrc should be set to alternate payee

  if lfa1-lnrza ne space and lfa1-xlfza eq space.
   select single * into alt_details from lfa1 where lifnr eq lfa1-lnrza.
   alt_flag = 'X'.

  endif.
endif.


if alt_payee eq 'Y' and alt_flag ne space.

  SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = IREGUH-ZBUKR
                                    AND PARM1 = 'IAD'
                                    AND PARM2 = 'WHT'.


  IF SY-SUBRC EQ 0 AND YHFPARMI-PARM_VAL NE SPACE.
    SELECT SINGLE * FROM ADRC WHERE ADDRNUMBER = ALT_DETAILS-ADRNR
                                      AND NATION = YHFPARMI-PARM_VAL.
  ELSE.
    SELECT SINGLE * FROM ADRC WHERE ADDRNUMBER = ALT_DETAILS-ADRNR
                                      AND   NATION     = SPACE.
  ENDIF.


else.
  SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = IREGUH-ZBUKR
                                    AND PARM1 = 'IAD'
                                    AND PARM2 = 'WHT'.


  IF SY-SUBRC EQ 0 AND YHFPARMI-PARM_VAL NE SPACE.
    SELECT SINGLE * FROM ADRC WHERE ADDRNUMBER = LFA1-ADRNR
                                      AND NATION = YHFPARMI-PARM_VAL.
  ELSE.
    SELECT SINGLE * FROM ADRC WHERE ADDRNUMBER = LFA1-ADRNR
                                      AND   NATION     = SPACE.
  ENDIF.

endif.
*end 16.11.2006 by Yupinto



* for ais
  SELECT SINGLE * FROM LFBW WHERE LIFNR = LFA1-LIFNR
                            AND   BUKRS = WITH_ITEM-BUKRS
                            AND   WITHT = WITH_ITEM-WITHT.

  SELECT SINGLE * FROM T001Z WHERE BUKRS EQ WITH_ITEM-BUKRS
                                     AND PARTY EQ 'J_1HP0'.
* --
  IF LFA1-XCPDK EQ 'X'              "one-time vendor/customer exists
     OR T001Z-PAVAL EQ LFA1-KTOKK.  "specific for AIS
    SELECT SINGLE * FROM BSEC WHERE BUKRS EQ WITH_ITEM-BUKRS
                                      AND BELNR EQ WITH_ITEM-BELNR
                                      AND GJAHR EQ WITH_ITEM-GJAHR
                                     AND BUZEI EQ WITH_ITEM-BUZEI.
  ENDIF.





  CLEAR: T059Q, T059Z, T059ZT, T059G.
  SELECT SINGLE * FROM T059Q WHERE QSSKZ EQ WITH_ITEM-WT_WITHCD
                                    AND LAND1 EQ T001-LAND1.
  IF SY-SUBRC EQ 0.
    WITH_ITEM-QSATZ = T059Q-QSATZ * 100.
  ENDIF.
  SELECT SINGLE * FROM T059Z WHERE LAND1 EQ T001-LAND1
                             AND   WITHT EQ WITH_ITEM-WITHT
                             AND WT_WITHCD EQ WITH_ITEM-WT_WITHCD.
  IF SY-SUBRC EQ 0.
    WITH_ITEM-QSATZ = T059Z-QSATZ.
  ENDIF.
* Enhancement done on 18/08/2005
  SELECT SINGLE * FROM T059G WHERE SPRAS = SY-LANGU
                                      AND  LAND1 = T001-LAND1
                                     AND QEKAR  = T059Z-QEKAR.

  SELECT SINGLE * FROM T059ZT WHERE SPRAS EQ SY-LANGU
                             AND LAND1 EQ T001-LAND1
                             AND WITHT EQ WITH_ITEM-WITHT
                             AND WT_WITHCD EQ WITH_ITEM-WT_WITHCD.
  PERFORM GET_HOUSEBANK.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_HOUSEBANK                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM GET_HOUSEBANK.
  CLEAR: T042A, T042I, T012K.

* get housebank id
  SELECT SINGLE * FROM T042A WHERE ZBUKR = WITH_ITEM-BUKRS
                                    AND WAERS = BSEG-PSWSL
*******
                                   AND HBKID = BSEG-HBKID
                                   AND ZLSCH = BSIK-ZLSCH.
  IF SY-SUBRC NE 0.
    SELECT SINGLE * FROM T042A WHERE ZBUKR = WITH_ITEM-BUKRS
*******
                                      AND HBKID = BSEG-HBKID
                                      AND ZLSCH = BSIK-ZLSCH.
  ENDIF.
* get acct id
  SELECT SINGLE * FROM T042I WHERE ZBUKR = WITH_ITEM-BUKRS
                                     AND ZLSCH = BSIK-ZLSCH
                                     AND WAERS = BSEG-PSWSL
                                     AND HBKID = T042A-HBKID.
  IF SY-SUBRC NE 0.
    SELECT SINGLE * FROM T042I WHERE ZBUKR = WITH_ITEM-BUKRS
                                       AND ZLSCH = BSIK-ZLSCH
                                       AND HBKID = T042A-HBKID.
  ENDIF.
* get housebank account no
  SELECT SINGLE * FROM T012K WHERE BUKRS = WITH_ITEM-BUKRS
                                     AND HBKID = T042A-HBKID
                                     AND HKTID = T042I-HKTID.

*   SELECT SINGLE * FROM T012K WHERE BUKRS = T042I-ZBUKR
*                              AND   HBKID = T042I-HBKID
*                              AND   HKTID = T042I-HKTID.
*    IF SY-SUBRC NE 0.
*      SELECT SINGLE * FROM T012K WHERE BUKRS = T042A-ZBUKR
*                                 AND   HBKID = T042A-HBKID
*                                 AND   HKTID = T042I-HKTID.
*    ENDIF.
ENDFORM.
*---------------------------------------------------------------------*
*       FORM WRITE_PARM                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM WRITE_PARM.
  DATA: PROG_NAME LIKE SY-REPID.

  MOVE SY-REPID TO PROG_NAME.

  CALL FUNCTION 'RS_REFRESH_FROM_SELECTOPTIONS'
       EXPORTING
            CURR_REPORT     = PROG_NAME
       TABLES
            SELECTION_TABLE = SELTAB
       EXCEPTIONS
            NOT_FOUND       = 1
            NO_REPORT       = 2
            OTHERS          = 3.

  IF ZW_LAUFI NE SPACE.
    WRITE: /1 'PayRun Date',  23 ZW_LAUFD.
    WRITE: /1 'PayRun Id',  23 ZW_LAUFI.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'W_LAUFI' 'Addl PayRun Id'.
  ELSE.
    WRITE: /1 'Company Code',  23 CO_CODE.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'S_LIFNR' 'Vendor'.
    WRITE: /1 'Fiscal Year',  23 W_FYR.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'W_DOCNO' 'Document No'.
*    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
*                            USING 'S_BLART' 'Document Type'.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'S_AUGDT' 'Clearing Date'.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'S_BUDAT' 'Posting Date'.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'S_CPUDT' 'Entry Date'.
    PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                            USING 'S_ZLSCH' 'Payment Method'.
  ENDIF.
  PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                          USING 'S_WITHT' 'WTX Type'.
  WRITE: /1 'Output File', 23 FILENAME.
  WRITE: /1 'PC Download', 23 PCDWLOAD.

ENDFORM.
*---------------------------------------------------------------------*
*       FORM CALL_FUNC                                                *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM CALL_FUNC.
  DATA: P_OUT TYPE C.
  IF ITAB_FMT_DET-SOURCE_VAL = 'FN_WTXRT'.
    PERFORM FN_WTXRT(YHFDBIFN)
      USING
        WITH_ITEM-QSATZ
      CHANGING
        V_COLUMN_VALUE.
  ELSEIF ITAB_FMT_DET-SOURCE_VAL = 'FN_WHT_Q1'.
    DATA: PAY_AMT_Q1 LIKE WITH_ITEM-WT_QSSHB.
    DATA: PAY_AMT_FIELD1 LIKE YHFFMTDT-SOURCE_VAL.
    CLEAR : PAY_AMT_FIELD1.
    SELECT SINGLE * FROM YHFFMTDT
                                      WHERE ( FORMAT_NO = '98'
                                     OR    FORMAT_NO = '99' )
                                     AND   COLUMN_NO = '200'.
    IF SY-SUBRC = 0.
      MOVE YHFFMTDT-SOURCE_VAL TO PAY_AMT_FIELD1.
    ELSE.
      SELECT SINGLE * FROM YHFFMTOW
                                         WHERE ( FORMAT_NO = '98'
                                         OR    FORMAT_NO = '99' )
                                         AND   COLUMN_NO = '200'.
      IF SY-SUBRC = 0.
        MOVE YHFFMTOW-SOURCE_VAL TO PAY_AMT_FIELD1.
      ENDIF.
    ENDIF.
    ASSIGN (PAY_AMT_FIELD1) TO <FIELDX>.
    PAY_AMT_Q1 = <FIELDX> .

    PERFORM FN_WHT_Q1(YHFDBIFN) USING BSEG-AUGDT
                                PAY_AMT_Q1
                                CHANGING
                                V_COLUMN_VALUE .

  ELSEIF ITAB_FMT_DET-SOURCE_VAL = 'FN_WHT_Q2'.
    DATA: PAY_AMT_Q2 LIKE WITH_ITEM-WT_QSSHB.
    DATA: PAY_AMT_FIELD2 LIKE YHFFMTDT-SOURCE_VAL.
    CLEAR : PAY_AMT_FIELD2.

    SELECT SINGLE * FROM YHFFMTDT
                                       WHERE ( FORMAT_NO = '98'
                                      OR    FORMAT_NO = '99' )
                                       AND   COLUMN_NO = '200'.
    IF SY-SUBRC = 0.
      MOVE YHFFMTDT-SOURCE_VAL TO PAY_AMT_FIELD2.
    ELSE.
      SELECT SINGLE * FROM YHFFMTOW
                                         WHERE ( FORMAT_NO = '98'
                                        OR    FORMAT_NO = '99' )
                                        AND   COLUMN_NO = '200'.
      IF SY-SUBRC = 0.
        MOVE YHFFMTOW-SOURCE_VAL TO PAY_AMT_FIELD2.
      ENDIF.
    ENDIF.
    ASSIGN (PAY_AMT_FIELD2) TO <FIELDX>.
    PAY_AMT_Q2 = <FIELDX> .

    PERFORM FN_WHT_Q2(YHFDBIFN) USING BSEG-AUGDT
                                PAY_AMT_Q2
                                CHANGING
                                V_COLUMN_VALUE .
  ELSEIF ITAB_FMT_DET-SOURCE_VAL = 'FN_WHT_Q3'.
    DATA: PAY_AMT_Q3 LIKE WITH_ITEM-WT_QSSHB.
    DATA: PAY_AMT_FIELD3 LIKE YHFFMTDT-SOURCE_VAL.
    CLEAR : PAY_AMT_FIELD3.

    SELECT SINGLE * FROM YHFFMTDT
                                       WHERE ( FORMAT_NO = '98'
                                       OR    FORMAT_NO = '99' )
                                       AND   COLUMN_NO = '200'.
    IF SY-SUBRC = 0.
      MOVE YHFFMTDT-SOURCE_VAL TO PAY_AMT_FIELD3.
    ELSE.
      SELECT SINGLE * FROM YHFFMTOW
                                         WHERE ( FORMAT_NO = '98'
                                        OR    FORMAT_NO = '99' )
                                        AND   COLUMN_NO = '200'.
      IF SY-SUBRC = 0.
        MOVE YHFFMTOW-SOURCE_VAL TO PAY_AMT_FIELD3.
      ENDIF.
    ENDIF.
    ASSIGN (PAY_AMT_FIELD3) TO <FIELDX>.
    PAY_AMT_Q3 = <FIELDX> .

    PERFORM FN_WHT_Q3(YHFDBIFN) USING BSEG-AUGDT
                                PAY_AMT_Q3
                                CHANGING
                                V_COLUMN_VALUE .

  ELSEIF ITAB_FMT_DET-DEFAULT_V = 'FN_BLANK_ERR'.
    PERFORM BLANK_ERR USING
             LFA1-LIFNR
           CHANGING
             V_COLUMN_VALUE.
    IF  V_COLUMN_VALUE  EQ 'Y'.
      PERFORM FN_BLANK_ERROR.
    ENDIF.
  ENDIF.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM POPULATE_REPORT_FIELDS                                   *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  V_EXCEED                                                      *
*---------------------------------------------------------------------*
FORM POPULATE_REPORT_FIELDS USING V_EXCEED.
  CASE ITAB_FMT_DET-COLUMN_NME.
    WHEN 'COMPANY CODE'.
      I_REPORT-BUKRS = V_COLUMN_VALUE.
    WHEN 'VENDOR NAME1'.
      I_REPORT-NAME1 = V_COLUMN_VALUE.
    WHEN 'VENDOR ADDRESS LINE1'.
      I_REPORT-ADDR1 = V_COLUMN_VALUE.
    WHEN 'VENDOR ADDRESS LINE2'.
      I_REPORT-ADDR2 = V_COLUMN_VALUE.
    WHEN 'VENDOR ADDRESS LINE3'.
      I_REPORT-ADDR3 = V_COLUMN_VALUE.
    WHEN 'DOCUMENT NUMBER'.
      I_REPORT-BELNR = V_COLUMN_VALUE.
    WHEN 'CLEARING DATE'.
      I_REPORT-AUGDT = V_COLUMN_VALUE.
    WHEN 'WITHHOLDING TAX CODE'.
      I_REPORT-WT_WITHCD = V_COLUMN_VALUE.
    WHEN 'WITHHOLDING TAX BASE AMOUNT'.
      I_REPORT-WT_QSSHB = V_COLUMN_VALUE.
    WHEN 'WITHHOLDING TAX AMOUNT'.
      I_REPORT-WT_QBSHB = V_COLUMN_VALUE.
    WHEN 'WITHHOLDING TAX RATE'.
      I_REPORT-QSATZ = V_COLUMN_VALUE.
  ENDCASE.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM PRINT_REPORT                                             *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM PRINT_REPORT.
  DATA: WS_DATE(10) TYPE C.

  LOOP AT I_REPORT.
    CONCATENATE I_REPORT-AUGDT+0(2)
                '.' I_REPORT-AUGDT+2(2)
                '.' I_REPORT-AUGDT+4(4) INTO WS_DATE.
    WRITE:/ I_REPORT-BUKRS,
            15 I_REPORT-BELNR,
            30 WS_DATE,
            45 I_REPORT-NAME1,
            95 I_REPORT-WT_WITHCD,
            100 I_REPORT-WT_QSSHB,
            120 I_REPORT-WT_QBSHB.
    WRITE: /45 I_REPORT-ADDR1.
    WRITE: /45 I_REPORT-ADDR2.
    WRITE: /45 I_REPORT-ADDR3.
    SKIP 1.

  ENDLOOP.

*Additional logic for Warning
  IF WS_WARN_FN_ERR = 'Y'.
    WRITE: /10   '###############  WARNING  ##################'.
    WRITE: /10   '#    Please check the DBERROR.TXT file     #'.
    WRITE: /10   '############################################'.

    IF WS_WARN_FN_ERR = 'Y'.
      WRITE: /10 '# BENE TAX PAYER ID is Blank             #'.
    ENDIF.
    MESSAGE I999 WITH
                '##         WARNING              ##'
                'Please check the DBERROR.TXT file '.
  ENDIF.

ENDFORM.

*---------------------------------------------------------------------*
*       FORM GET_CONVERT_TYPE                                         *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM GET_CONVERT_TYPE.
  DATA: V_CONVERT_LIST LIKE YHFPARMI-PARM_VAL.
  CLEAR CONVERT_TYPE.
  SELECT SINGLE PARM_VAL INTO V_CONVERT_LIST
  FROM YHFPARMI
  WHERE BUKRS = CO_CODE
  AND PARM1 = 'INV'
  AND PARM2 = 'CHR'.
  IF SY-SUBRC EQ 0.
    IF V_CONVERT_LIST EQ SPACE OR V_CONVERT_LIST CS IREGUH-RZAWE.
      CONVERT_TYPE = 'E'.
    ENDIF.
  ELSEIF KATAKANA NE SPACE.
    CONVERT_TYPE = 'K'.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BLANK_ERR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LFA1_LIFNR  text
*      -->P_LFA1_STCD1  text
*      <--P_V_COLUMN_VALUE  text
*----------------------------------------------------------------------*
FORM BLANK_ERR USING
                VALUE(L_LIFNR) LIKE LFA1-LIFNR
              CHANGING VALUE(P_OUT) TYPE C.
  MOVE 'Y' TO P_OUT.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FN_BLANK_ERROR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FN_BLANK_ERROR.
  DATA: ERRSTR(100) TYPE C.
  CONCATENATE DBD_PAY 'DBERROR.TXT' INTO V_ERRFILE.
  MOVE 'Y' TO WS_WARN_FN_ERR.
  CLEAR ERRSTR.
  CONCATENATE IREGUH-VBLNR ':' ITAB_FMT_DET-COLUMN_NME 'IS BLANK'
              INTO ERRSTR SEPARATED BY SPACE.

*FOR 4.6
*  OPEN DATASET V_ERRFILE FOR APPENDING IN TEXT MODE.
*END 4.6

*FOR 4.7
OPEN DATASET V_ERRFILE FOR APPENDING IN TEXT MODE encoding DEFAULT.
*END 4.7
  IF SY-SUBRC EQ 0.
    TRANSFER ERRSTR TO V_ERRFILE.
  ELSE.
    EXIT.
  ENDIF.
  CLOSE DATASET V_ERRFILE.
ENDFORM.                    " FN_BLANK_ERROR


*---------------------------------------------------------------------*
*       FORM CONVERSE_CURR                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  AMOUNT                                                        *
*  -->  CURR                                                          *
*---------------------------------------------------------------------*
FORM CONVERSE_CURR USING AMOUNT CURR.
  DATA: F_AMOUNT(16) TYPE P DECIMALS 2.

  F_AMOUNT = AMOUNT.
  SELECT SINGLE * FROM TCURX WHERE CURRKEY = CURR.
  IF SY-SUBRC <> 0.
    EXIT.
  ELSE.
    CASE TCURX-CURRDEC.
      WHEN '0'.
        F_AMOUNT = F_AMOUNT * 100.
      WHEN '1'.
        F_AMOUNT = F_AMOUNT * 10.
      WHEN '3'.
        F_AMOUNT = F_AMOUNT / 10.
      WHEN '4'.
        F_AMOUNT = F_AMOUNT / 100.
      WHEN '5'.
        F_AMOUNT =  F_AMOUNT / 1000.
    ENDCASE.
  ENDIF.
  AMOUNT = F_AMOUNT.
ENDFORM.

*Text symbol text£º
*106:Withholding tax code
*300:Male                ,,
*301:Female              ,,
*400:Log: Withhold.tax report for $
*409:Thailand
*600:Vendor Address
*601:Date
*602:Doc Typ/Fiscal Yr
*603:Base Amt
*604:Tax Amt
*605:Desc
*606:Company
*610:Vendor account
*611:Document type
*612:Document number
*613:Clearing date
*614:Posting date
*615:Pay method
*620:Withholding Tax Information Extract

*FIL:Output file
*Selection text£º
*CO_CODE:        Company
*DBD_PAY:        Output file path
*FNAME:        Filename prefix
*PCDWLOAD:        PC Download
*S_AUGDT:        Clearing Date
*S_BUDAT:        Posting Date
*S_CPUDT:        Entry Date
*S_LIFNR:        Vendor Code
*S_WITHT:        Withholding Tax Type
*S_ZLSCH:        Payment Method
*W_DOCNO:        Document Number
*W_FYR:        Fiscal Year
*W_LAUFI:        Additiional Identification
