*&---------------------------------------------------------------------*
*& Modulpool         RSEIDOCZ                                          *
*&                                                                     *
*&---------------------------------------------------------------------*
*&                                                                     *
*&                                                                     *
*&---------------------------------------------------------------------*

TOP-OF-PAGE.
  WRITE   / sy-uline(78).
  WRITE : / sy-vline,
         02 text-021, sy-sysid INTENSIFIED OFF,
         35 text-022, sy-datum INTENSIFIED OFF,
         55 text-023, sy-uzeit INTENSIFIED OFF,
         78 sy-vline.
  WRITE   / sy-uline(78).
  IF sy-pagno = 1.
    WRITE : / sy-vline,
           02 text-024, anz_int_edidc INTENSIFIED OFF,
           78 sy-vline, sy-uline(78),
           / sy-vline, 02 text-025,
           anz_int_select_edidc COLOR COL_KEY, 78 sy-vline,
           sy-uline(78).
    SKIP.
  ELSE.
    WRITE : / sy-vline,
            02 text-026,
           anz_int_select_edidc INTENSIFIED OFF, 78 sy-vline,
           sy-uline(78).
  ENDIF.
  SKIP.

  IF sy-pagno <> 1.
    WRITE: sy-uline(78), / sy-vline.
    FORMAT COLOR COL_HEADING.
    WRITE :   3 text-040 COLOR COL_HEADING,
             22 text-041 COLOR COL_HEADING,
             29 text-042 COLOR COL_HEADING,
             47 text-043 COLOR COL_HEADING,
             65 text-044 COLOR COL_HEADING.
    WRITE :   78 sy-vline.
    WRITE :  / sy-uline(78).
    FORMAT COLOR COL_NORMAL.
  ENDIF.


*&---------------------------------------------------------------------*
*&      Form  OWN_F4_HELP
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_TAB_FIELDS  text
*      -->P_TAB_VALUETAB  text
*      -->P_HELP_FLAG  text
*----------------------------------------------------------------------*
FORM own_f4_help_popup   TABLES   tab_tabfields
                                  tab_valuetab
                    USING    p_titel
                             p_selectfield
                 CHANGING    p_index_tab.

  CALL FUNCTION 'HELP_VALUES_GET_NO_DD_NAME'
       EXPORTING
*         CUCOL                         = 0
*         CUROW                         = 0
*         DISPLAY                       = ' '
            selectfield                   = p_selectfield
            titel                         = p_titel
*         NO_PERS_HELP_SELECT           = ' '
*         TITLE_IN_VALUES_LIST          = ' '
*         SHOW_ALL_VALUES_AT_FIRST_TIME = ' '
*         USE_USER_SELECTIONS           = ' '
*         WRITE_SELECTFIELD_IN_COLOURS  = 'X'
*         NO_SCROLL                     = ' '
*         NO_CONVERSION                 = ' '
*         REDUCED_STATUS_ONLY           = ' '
*         NO_MARKING_OF_CHECKVALUE      = ' '
*         NO_DISPLAY_OF_PERS_VALUES     = ' '
*         FILTER_FULL_TABLE             = ' '
     IMPORTING
           ind                           = p_index_tab
*         SELECT_VALUE                  =
       TABLES
            fields                        = tab_tabfields
            full_table                    = tab_valuetab
*         USER_SEL_FIELDS               =
*         HEADING_TABLE                 =
       EXCEPTIONS
            full_table_empty              = 1
            no_tablestructure_given       = 2
            no_tablefields_in_dictionary  = 3
            more_then_one_selectfield     = 4
            no_selectfield                = 5
            OTHERS                        = 6.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.                               " OWN_F4_HELP
*&---------------------------------------------------------------------*
*&      Form  READ_CONTROLRECORD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM read_controlrecord.

  IF a_search = ' '.
    SELECT * FROM edidc INTO TABLE int_edidc
       WHERE   upddat >= credat-low    "because of index on EDIDC
       AND     cretim IN cretim
       AND     credat IN credat
       AND     updtim IN updtim
       AND     upddat IN upddat
       AND     docnum IN docnum
       AND     status IN status
       ORDER BY PRIMARY KEY.           " already sorted
  ELSE.
    DATA: wa_selections TYPE rsds_frange.
    DATA: tab_selections TYPE rsds_frange_t.
    DATA: selection_range TYPE rsdsselopt.
    PERFORM  append_tab_selections TABLES tab_selections cretim
                                   USING 'CRETIM'.
    PERFORM  append_tab_selections TABLES tab_selections credat
                                   USING 'CREDAT'.
    PERFORM  append_tab_selections TABLES tab_selections upddat
                                   USING 'UPDDAT'.
    PERFORM  append_tab_selections TABLES tab_selections updtim
                                   USING 'UPDTIM'.
    PERFORM  append_tab_selections TABLES tab_selections docnum
                                   USING 'DOCNUM'.
    PERFORM  append_tab_selections TABLES tab_selections status
                                   USING 'STATUS'.

    CALL FUNCTION 'AS_API_READ'
         EXPORTING
              i_fieldcat          = 'SAP_IDOC_001'
              i_selections        = tab_selections
*         I_OBLIGATORY_FIELDS =
         IMPORTING
              e_result            = int_as_result[]
         EXCEPTIONS
              parameters_invalid  = 1
              no_infostruc_found  = 2
              OTHERS              = 3
              .
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.

    LOOP AT int_as_result.
      MOVE-CORRESPONDING int_as_result TO int_edidc.
      APPEND int_edidc.
    ENDLOOP.
  ENDIF.

ENDFORM.                               " READ_CONTROLRECORD
*&---------------------------------------------------------------------*
*&      Form  reconstruct_selections
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  READ_DATARECORD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM read_datarecord.

  IF a_search = ' '.
    CALL FUNCTION 'IDOC_READ_COMPLETELY'
         EXPORTING
              document_number          = int_edidc-docnum
*    IMPORTING
*         IDOC_CONTROL             =
*         NUMBER_OF_DATA_RECORDS   =
*         NUMBER_OF_STATUS_RECORDS =
        TABLES
*          int_edids                =
             int_edidd                = int_edidd
         EXCEPTIONS
              document_not_exist       = 1
              document_number_invalid  = 2
              OTHERS                   = 3.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

    ENDIF.
  ELSE.
    CALL FUNCTION 'EDI_IDOC_GET_FROM_ARCHIVE'
         EXPORTING
              docnum                       = int_edidc-docnum
*    IMPORTING
*         INT_EDIDC                    =
         TABLES
              int_edidd                    = int_edidd
              int_edids                    = int_edids
         EXCEPTIONS
              OTHERS                       = 4.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
  ENDIF.

ENDFORM.                               " READ_DATARECORD
*&---------------------------------------------------------------------*
*&      Form  DYNP_VALUE_READ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0201   text
*      <--P_IDOCTP  text
*----------------------------------------------------------------------*
FORM dynp_value_read USING    p_fieldname
                     CHANGING p_fieldvalue.

  DATA: BEGIN OF dynpfield OCCURS 3.
          INCLUDE STRUCTURE dynpread.
  DATA: END OF dynpfield.

  CLEAR dynpfield.
  REFRESH dynpfield.
  MOVE p_fieldname TO dynpfield-fieldname.
  APPEND dynpfield.

  CALL FUNCTION 'DYNP_VALUES_READ'
       EXPORTING
            dyname                   = main_prog
            dynumb                   = '1000'
*         TRANSLATE_TO_UPPER       = ' '
*         REQUEST                  = ' '
*         PERFORM_CONVERSION_EXITS = ' '
*         PERFORM_INPUT_CONVERSION = ' '
       TABLES
            dynpfields               = dynpfield
       EXCEPTIONS
            invalid_abapworkarea     = 1
            invalid_dynprofield      = 2
            invalid_dynproname       = 3
            invalid_dynpronummer     = 4
            invalid_request          = 5
            no_fielddescription      = 6
            invalid_parameter        = 7
            undefind_error           = 8
            double_conversion        = 9
            OTHERS                   = 10.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  LOOP AT dynpfield.
    IF dynpfield-fieldname = p_fieldname.
      p_fieldvalue = dynpfield-fieldvalue.
    ENDIF.
  ENDLOOP.

ENDFORM.                               " DYNP_VALUE_READ
*&---------------------------------------------------------------------*

*&      Form  DYNP_VALUES_UPDATE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0207   text
*      <--P_SEGMENT1  text
FORM dynp_values_update USING    p_fieldname
                                 p_fieldvalue.

  DATA: BEGIN OF dynpfield OCCURS 3.
          INCLUDE STRUCTURE dynpread.
  DATA: END OF dynpfield.

  CLEAR dynpfield.
  REFRESH dynpfield.
  MOVE p_fieldname TO dynpfield-fieldname.
  MOVE p_fieldvalue TO dynpfield-fieldvalue.
  APPEND dynpfield.

  CALL FUNCTION 'DYNP_VALUES_UPDATE'
    EXPORTING
      dyname               = 'RSEJOE01'
      dynumb               = '1000'
    TABLES
      dynpfields           = dynpfield
    EXCEPTIONS
      invalid_abapworkarea = 1
      invalid_dynprofield  = 2
      invalid_dynproname   = 3
      invalid_dynpronummer = 4
      invalid_request      = 5
      no_fielddescription  = 6
      undefind_error       = 7
      OTHERS               = 8.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.



ENDFORM.                               " DYNP_VALUES_UPDATE
*&---------------------------------------------------------------------*
*&      Form  F4_HELP_SEGMENT1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM f4_help_segment1.

  DATA : BEGIN OF own_f4_help_struc,
         segtyp LIKE idocsyn-segtyp,
         descrp LIKE teds2-descrp,
         END OF own_f4_help_struc.

  DATA: tab_fields LIKE help_value OCCURS 2 WITH HEADER LINE.
  DATA: tab_valuetab LIKE own_f4_help_struc OCCURS 100 WITH HEADER LINE.


  CLEAR tab_fields.
  REFRESH tab_fields.
  tab_fields-tabname = 'EDISYN'.
  tab_fields-fieldname = 'SEGTYP'.
  tab_fields-selectflag = 'X'.
  APPEND tab_fields.
  tab_fields-tabname = 'EDISEGMHD'.
  tab_fields-fieldname = 'DESCRP'.
  tab_fields-selectflag = ' '.
  APPEND tab_fields.
  DATA segmentheader TYPE edisegmhd.
  REFRESH tab_valuetab.

  SELECT * FROM  idocsyn  INTO  TABLE int_idocsyn
                                WHERE idoctyp = idoctp-low.
  IF cimtyp IS INITIAL.
    CONCATENATE text-010 idoctp-low INTO f4_title SEPARATED BY space.
*    f4_title = concacenate text-010 + idoctp.
  ELSE.
    CONCATENATE text-010 idoctp-low ',' text-011 cimtyp-low INTO
                                      f4_title SEPARATED BY space.
*    f4_title = text-010 + idoctp + text-010 + cmtyp.
    SELECT * FROM  idocsyn  INTO  TABLE int_idocsyn
                                 WHERE idoctyp = idoctp-low.
  ENDIF.

  CALL FUNCTION 'EXTTYPE_READ'
       EXPORTING
            pi_cimtyp          = cimtyp-low
*         PI_CHECK_AUTHORITY = 'X'
*         PI_READ_DEVC       = 'X'
*    IMPORTING
*         PE_ATTRIBUTES      =
      TABLES
         pt_syntax          = tab_cimtyp
*           pt_pre_syntax      = tab_cimtyp
*         PT_INT_SYNTAX      =
       EXCEPTIONS
            object_not_found   = 1
            db_error           = 2
            no_authority       = 3
            OTHERS             = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  LOOP AT tab_cimtyp.
    MOVE tab_cimtyp-segtyp TO int_idocsyn-segtyp.
    APPEND int_idocsyn.
  ENDLOOP.

  LOOP AT int_idocsyn.
    CALL FUNCTION 'SEGMENT_READ'
         EXPORTING
              segmenttyp           = int_idocsyn-segtyp
       IMPORTING
*           RESULT               =
*           DEVCLASS             =
             segmentheader        = segmentheader
*      TABLES
*           SEGMENTDEFINITION    =
*           SEGMENTSTRUCTURE     =
         EXCEPTIONS
              no_authority         = 1
              segment_not_existing = 2
              OTHERS               = 3.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    tab_valuetab-segtyp = int_idocsyn-segtyp.
    tab_valuetab-descrp = segmentheader-descrp.
    APPEND tab_valuetab.
  ENDLOOP.

*select * from edsappl into table int_edsappl.
  PERFORM own_f4_help_popup      TABLES     tab_fields
                                           tab_valuetab
                           USING f4_title
*                                  'EDISEG'
                                   'SEGTYP'
                           CHANGING      index_tab.
  READ TABLE tab_valuetab INDEX index_tab.
  segment1 = tab_valuetab-segtyp.

*perform dynp_values_update using 'SEGMENT1'
*                                 segment1.


ENDFORM.                               " F4_HELP_SEGMENT1
*&---------------------------------------------------------------------*
*&      Form  F4_HELP_FIELD1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
FORM f4_help_field1 USING p_field.

  DATA : BEGIN OF own_f4_help_struc,
         fieldname LIKE edsappl-fieldname,
         descrp LIKE teds2-descrp,
         END OF own_f4_help_struc.

  DATA: tab_fields LIKE help_value OCCURS 2 WITH HEADER LINE.
  DATA: tab_valuetab LIKE own_f4_help_struc OCCURS 100 WITH HEADER LINE.




  PERFORM dynp_value_read USING 'SEGMENT1'
                          CHANGING segment1.

  CONCATENATE text-012 segment1 INTO f4_title SEPARATED BY space.

  CLEAR int_edsappl.
  REFRESH int_edsappl.
  CLEAR tab_fields.
  REFRESH tab_fields.
  tab_fields-tabname = 'EDSAPPL'.
  tab_fields-fieldname = 'FIELDNAME'.
  tab_fields-selectflag = 'X'.
  APPEND tab_fields.
  tab_fields-tabname = 'EDISEGMHD'.
  tab_fields-fieldname = 'DESCRP'.
  tab_fields-selectflag = ' '.
  APPEND tab_fields.

  CLEAR tab_valuetab.
  REFRESH tab_valuetab.

  SELECT * FROM  edsappl  INTO  TABLE int_edsappl
                                       WHERE segtyp = segment1.

  LOOP AT int_edsappl.
    tab_valuetab-fieldname = int_edsappl-fieldname.
    CALL FUNCTION 'DDIF_DTEL_GET'
         EXPORTING
              name          = int_edsappl-rollname
*         STATE         = 'A'
             langu         = sy-langu
        IMPORTING
*         GOTSTATE      =
             dd04v_wa      = dd04v
*         TPARA_WA      =
         EXCEPTIONS
              illegal_input = 1
              OTHERS        = 2.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    tab_valuetab-descrp = dd04v-ddtext.
    APPEND tab_valuetab.
  ENDLOOP.

  PERFORM own_f4_help_popup      TABLES     tab_fields
                                           tab_valuetab
                           USING    f4_title
                                   'FIELDNAME'
                           CHANGING      index_tab.

*perform dynp_values_update using 'SEGMENT1'
*                                 segment1.

  READ TABLE tab_valuetab INDEX index_tab.
  IF p_field = '1'.
    field1 = tab_valuetab-fieldname.
  ENDIF.

ENDFORM.                               " F4_HELP_FIELD1
*&---------------------------------------------------------------------*
*&      Form  SEARCH_DATARECORD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM search_datarecord.

  DATA: found1 TYPE c, found_1 TYPE c.

  found1 = ' '.
  found_1 = ' '.

** ignore initial value
*  IF value1 IS INITIAL.
*    found1 = 'X'.
*  ENDIF.

** if segment is not specified search in total data record and ignore
** search fields
*  IF NOT segment1 IS INITIAL.
*.. search in specified segments of data record
  LOOP AT int_edidd WHERE segnam = segment1.
*.... we need initialisation for search in all relevant datarecords
*      IF f_search = ' '.
    found1 = ' '.
    IF value1 IS INITIAL.
      found1 = 'X'.
    ENDIF.
*      ENDIF.
    SEARCH int_edidd-sdata FOR value1 STARTING AT offset1
                           ENDING AT end1.
    IF sy-subrc = 0.
      found1 = 'X'.
      MOVE-CORRESPONDING int_edidc TO prot_list.
      prot_list-segnum = int_edidd-segnum.
      APPEND prot_list.
      CLEAR int_edidd-sdata.       " this is due to security
      APPEND int_edidd TO int_select_edidd.
      found_1 = 'X'.
    ENDIF.
  ENDLOOP.
*  ELSE.
** since no segment is specified search in total data record
** independent of field1_1
*    LOOP AT int_edidd.
**.... we need initialisation for search in all relevant datarecords
**     IF f_search = ' '.
*      found1 = ' '.
*      IF value1 IS INITIAL.
*        found1 = 'X'.
*      ENDIF.
**     ENDIF.
*
*      SEARCH int_edidd-sdata FOR value1.
*      IF sy-subrc = 0.
*        found1 = 'X'.
*        MOVE-CORRESPONDING int_edidc TO prot_list.
*        prot_list-segnum = int_edidd-segnum.
*        APPEND prot_list.
*        CLEAR int_edidd-sdata.       " this is due to security
*        APPEND int_edidd TO int_select_edidd.
*        found_1 = 'X'.
*      ENDIF.
*    ENDLOOP.
*  ENDIF.

  IF found_1 = 'X'.
    ADD 1 TO anz_int_select_edidc.
  ENDIF.

ENDFORM.                               " SEARCH_DATARECORD
*&---------------------------------------------------------------------*
*&      Form  F4_HELP_EXTENSION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM f4_help_extension.

  DATA: descrp_ext TYPE edi_iapi01.

  DATA : BEGIN OF own_f4_help_struc,
         cimtyp LIKE edcim-cimtyp,
         descrp LIKE descrp_ext-descrp,
         END OF own_f4_help_struc.

  DATA: tab_fields LIKE help_value OCCURS 2 WITH HEADER LINE.
  DATA: tab_valuetab LIKE own_f4_help_struc OCCURS 100 WITH HEADER LINE.


  PERFORM dynp_value_read USING 'IDOCTYP-LOW'
                          CHANGING idoctp-low.

  CONCATENATE text-013 idoctp INTO f4_title SEPARATED BY space.


  CLEAR tab_fields.
  REFRESH tab_fields.



  tab_fields-tabname = 'CIMSYN'.
  tab_fields-fieldname = 'CIMTYP'.
  tab_fields-selectflag = 'X'.
  APPEND tab_fields.
  tab_fields-tabname = 'EDISEGMHD'.
  tab_fields-fieldname = 'DESCRP'.
  tab_fields-selectflag = ' '.
  APPEND tab_fields.
  DATA segmentheader TYPE edisegmhd.
  DATA: l_idoctp LIKE  edi_iapi00-idoctyp.
  l_idoctp = idoctp.

  CALL FUNCTION 'IDOCTYPE_READ'
       EXPORTING
            pi_idoctyp         = l_idoctp
*         PI_CHECK_AUTHORITY = 'X'
*         PI_READ_DEVC       = 'X'
*    IMPORTING
*         PE_ATTRIBUTES      =
      TABLES
*         PT_SYNTAX          =
*         PT_PRE_SYNTAX      =
           pt_extensions      = tab_exttyp
       EXCEPTIONS
            object_not_found   = 1
            db_error           = 2
            no_authority       = 3
            OTHERS             = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CLEAR tab_valuetab.
  REFRESH tab_valuetab.

  LOOP AT tab_exttyp.
    tab_valuetab-cimtyp = tab_exttyp-objname.

    CALL FUNCTION 'EXTTYPE_READ'
         EXPORTING
              pi_cimtyp          = tab_valuetab-cimtyp
*         PI_CHECK_AUTHORITY = 'X'
*         PI_READ_DEVC       = 'X'
        IMPORTING
             pe_attributes      = descrp_ext
*    TABLES
*         PT_SYNTAX          =
*         PT_PRE_SYNTAX      =
*         PT_INT_SYNTAX      =
         EXCEPTIONS
              object_not_found   = 1
              db_error           = 2
              no_authority       = 3
              OTHERS             = 4.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    tab_valuetab-descrp = descrp_ext-descrp.
    APPEND tab_valuetab.
  ENDLOOP.

  PERFORM own_f4_help_popup      TABLES     tab_fields
                                           tab_valuetab
                           USING f4_title
                                   'CIMTYP'
                           CHANGING      index_tab.
  READ TABLE tab_valuetab INDEX index_tab.
  cimtyp = tab_valuetab-cimtyp.


ENDFORM.                               " F4_HELP_EXTENSION
*&---------------------------------------------------------------------*
*&      Form  PREPARE_DATARECORD_SEARCH
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM prepare_datarecord_search.

  offset1 = 0.

  CLEAR int_edisegstru.
  REFRESH int_edisegstru.

** only necessary if search is specified in this way:
**   ! see perform SEARCH_DATARECORD !
** if no values are specified no datarecord search is necessary
*  IF NOT value1 IS INITIAL
** if segment is not specified search in total data record and ignore
** search fields
* AND NOT segment1 IS INITIAL
** if the search field is not initial read position in segment
* AND NOT field1 IS INITIAL.

  CALL FUNCTION 'SEGMENT_READ'
       EXPORTING
            segmenttyp           = segment1
*    IMPORTING
*         RESULT               =
*         DEVCLASS             =
*         SEGMENTHEADER        =
    TABLES
*         SEGMENTDEFINITION    =
           segmentstructure     = int_edisegstru
       EXCEPTIONS
            no_authority         = 1
            segment_not_existing = 2
            OTHERS               = 3.

  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  IF NOT field1 IS INITIAL.
    LOOP AT int_edisegstru.
      IF int_edisegstru-fieldname = field1.
        expleng1 = int_edisegstru-expleng.
        EXIT.
      ENDIF.
      offset1 = offset1 + int_edisegstru-expleng.
    ENDLOOP.
    offset1 = offset1 + 1.
    end1 = offset1 + expleng1 - 1.
  ELSE.
    offset1 = 1.
    end1 = 1000.
  ENDIF.

*  ELSE.
**.. this is for searching for value in hole segment
*    offset1 = 1.
*    end1 = 1000.
*  ENDIF.

ENDFORM.                               " PREPARE_DATARECORD_SEARCH
*&---------------------------------------------------------------------*
*&      Form  PRINT_LIST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM print_list.

  IF sy-batch = 'X'.
* print values of selection table.
    DATA sel_tab LIKE rsparams OCCURS 20 WITH HEADER LINE.

    CALL FUNCTION 'RS_REFRESH_FROM_SELECTOPTIONS'
      EXPORTING
        curr_report     = main_prog
      TABLES
        selection_table = sel_tab
      EXCEPTIONS
        not_found       = 1
        no_report       = 2
        OTHERS          = 3.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.


    CALL FUNCTION 'RS_LIST_SELECTION_TABLE'
        EXPORTING
             report        = main_prog
             seltext       = 'X'
*         DYN_RANGE     =
             newpage       = 'X'
             screennr      = '1000'
         TABLES
              sel_tab       = sel_tab
         EXCEPTIONS
              sel_tab_empty = 1
              OTHERS        = 2.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
    NEW-PAGE.
  ENDIF.
  PERFORM display_result.

ENDFORM.                               " PRINT_LIST
*&---------------------------------------------------------------------*
*&      Form  AUTHORITY_CHECK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_AUTHORITY_OK  text
*----------------------------------------------------------------------*
FORM authority_check  USING p_object LIKE edi_authmo-object
                            p_editcd LIKE edi_authct-editcd
                            p_ediact LIKE edi_authct-ediact
                      CHANGING p_authority_ok.

  AUTHORITY-CHECK   OBJECT p_object
        ID 'EDI_TCD' FIELD p_editcd
        ID 'ACTVT'   FIELD p_ediact
        ID 'EDI_DIR' DUMMY
        ID 'EDI_MES' DUMMY
        ID 'EDI_PRN' DUMMY
        ID 'EDI_PRT' DUMMY.
  IF sy-subrc = 0.
* authoritycheck positive
    MOVE true  TO p_authority_ok.
  ELSE.
* authoritycheck negative; message for the user and stop program
    MESSAGE i893 WITH main_prog.
    MOVE false TO p_authority_ok.
  ENDIF.

ENDFORM.                               " AUTHORITY_CHECK
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_RESULT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM display_result.

  DATA: it_events TYPE  slis_t_event.
  DATA: is_keyinfo TYPE slis_keyinfo_alv.
  DATA: xfield TYPE slis_t_fieldcat_alv.
  DATA: tmp_ydata LIKE edidd OCCURS 0 WITH HEADER LINE.
  DATA: x_save.


  x_save = 'A'.
  PERFORM fill_fieldcat TABLES xfield.
  PERFORM fill_xdata.

  INSERT 'ITEM_DATA_EXPAND              LOAD_YDATA'
                                        INTO it_events INDEX 1.
  INSERT 'USER_COMMAND                  CALLBACK_FROM_LIST'
                                        INTO it_events INDEX 1.
 is_keyinfo-header01 = 'DOCNUM'. "This describes relation between tables
  is_keyinfo-item01 = 'DOCNUM'.
  is_keyinfo-item02 = 'SEGNUM'.
  CLEAR is_layout.
  is_layout-expand_fieldname = 'FOLDER'.
  is_layout-info_fieldname  = 'HIGHLIGHT'.

  CALL FUNCTION 'REUSE_ALV_HIERSEQ_LIST_DISPLAY'
       EXPORTING
*         I_INTERFACE_CHECK        = ' '
            i_callback_program       = main_prog
*         I_CALLBACK_PF_STATUS_SET = ' '
*              i_callback_user_command  =  'CALLBACK_FROM_LIST'
            is_layout                = is_layout
            it_fieldcat              = xfield
*         IT_EXCLUDING             =
*         IT_SPECIAL_GROUPS        =
*         IT_SORT                  =
*         IT_FILTER                =
*         IS_SEL_HIDE              =
*         I_SCREEN_START_COLUMN    = 0
*         I_SCREEN_START_LINE      = 0
*         I_SCREEN_END_COLUMN      = 0
*         I_SCREEN_END_LINE        = 0
*         I_DEFAULT                = 'X'
         i_save                   = x_save
         is_variant               = is_variant
          it_events                = it_events
*         IT_EVENT_EXIT            =
            i_tabname_header         = 'XDATA'
            i_tabname_item           = 'YDATA'
*         I_STRUCTURE_NAME_HEADER  =
*         I_STRUCTURE_NAME_ITEM    =
            is_keyinfo               = is_keyinfo
*         IS_PRINT                 =
*         IS_REPREP_ID             =
*    IMPORTING
*         E_EXIT_CAUSED_BY_CALLER  =
*         ES_EXIT_CAUSED_BY_USER   =
       TABLES
            t_outtab_header          = xdata
            t_outtab_item            = ydata
       EXCEPTIONS
            program_error            = 1
            OTHERS                   = 2.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.


ENDFORM.                               " DISPLAY_RESULT

*&---------------------------------------------------------------------*
*&      Form  FILL_FIELDCAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_XFIELD  text
*----------------------------------------------------------------------*
FORM fill_fieldcat TABLES   xfield.

  DATA: afield TYPE slis_fieldcat_alv.
  DATA: l_count LIKE sy-tabix.

  l_count =  1.

  CLEAR afield.
* this fields are the same for all entries
  afield-tabname   = 'XDATA'.
  afield-sp_group = 'A'.

  afield-fieldname = 'DOCNUM'.
  afield-ref_tabname = 'EDIDC'.
  afield-col_pos = l_count.
  afield-key = 'X'.
  afield-lzero = 'X'.                  "f¨¹hrende Nullen
  afield-ddictxt   = 'L'.              "langen Text
  afield-emphasize = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.
  CLEAR afield-lzero.
  CLEAR afield-ddictxt.
  CLEAR afield-key.
  CLEAR afield-emphasize.

  afield-col_pos = l_count.
  afield-fieldname = 'CREDAT'.
  afield-ref_tabname   = 'EDIDC'.
  afield-ddictxt   = 'S'.              "kurzen Text
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'CRETIM'.
  afield-ref_tabname   = 'EDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'DIRECT'.
  afield-ref_tabname   = 'EDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'PARTNR'.
  afield-ref_tabname   = 'LISTEDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'STATUS'.
  afield-ref_tabname   = 'EDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'STATXT'.
  afield-ref_tabname   = 'LISTEDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'DOCTYP'.
  afield-ref_tabname   = 'EDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'MESTYP'.
  afield-ref_tabname   = 'EDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'TEST'.
  afield-ref_tabname   = 'EDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'RCVPOR'.
  afield-ref_tabname   = 'LISTEDIDC'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'MESCOD'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'MESFCT'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'IDENT'.
  afield-ref_tabname   = 'LISTEDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'SNDPOR'.
  afield-ref_tabname   = 'LISTEDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'IDOCTP'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'CIMTYP'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'DOCREL'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'STD'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'STDVRS'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'STDMES'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'OUTMOD'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'REFINT'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'REFGRP'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'REFMES'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'ARCKEY'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'SERIAL'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'UPDDAT'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-col_pos = l_count.
  afield-fieldname = 'UPDTIM'.
  afield-ref_tabname   = 'EDIDC'.
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.

* now we look at the the selected datarecords

  CLEAR afield.
  afield-tabname   = 'YDATA'.
  afield-ref_tabname = 'EDIDD'.

  afield-fieldname = 'DOCNUM'.
  afield-col_pos = l_count.
*  afield-key = 'X'.
  afield-lzero = 'X'.                  "f¨¹hrende Nullen
*  afield-ddictxt   = 'L'.              "langen Text
  afield-no_out = 'X'.
  APPEND afield TO xfield.
  l_count = l_count + 1.
  CLEAR afield-no_out.



  afield-fieldname = 'SEGNUM'.
  afield-key = 'X'.
  afield-col_pos = l_count.
  afield-lzero = 'X'.                  "f¨¹hrende Nullen
  APPEND afield TO xfield.
  l_count = l_count + 1.

  CLEAR afield-lzero.
  CLEAR afield-key.

  afield-fieldname = 'SEGNAM'.
  afield-col_pos = l_count.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-fieldname = 'PSGNUM'.
  afield-col_pos = l_count.
  APPEND afield TO xfield.
  l_count = l_count + 1.

  afield-fieldname = 'HLEVEL'.
  afield-col_pos = l_count.
  APPEND afield TO xfield.
  l_count = l_count + 1.


ENDFORM.                               " FILL_FIELDCAT
*&---------------------------------------------------------------------*
*&      Form  FILL_XDATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_XDATA  text
*----------------------------------------------------------------------*
FORM fill_xdata.

  DATA: int_teds2 LIKE teds2 OCCURS 0 WITH HEADER LINE.
  DATA: int_xdata LIKE xdata.
* Statustext
  SELECT * FROM teds2 INTO TABLE int_teds2
     WHERE langua EQ sy-langu.
  CLEAR: xdata, int_xdata.
  REFRESH: xdata.
  LOOP AT prot_list.
    LOOP AT xdata WHERE docnum = prot_list-docnum.
    ENDLOOP.
* avoid dublicated entries
    IF sy-subrc <> 0.
      MOVE-CORRESPONDING prot_list TO int_xdata.
      READ TABLE int_teds2 WITH KEY status = prot_list-status
                                    langua = sy-langu.
      IF sy-subrc EQ 0.
        MOVE int_teds2-descrp TO int_xdata-statxt.
      ENDIF.
      IF prot_list-direct = '1'.       " Ausgang
        MOVE prot_list-rcvprt TO int_xdata-partnr(2). "partnerart
        MOVE '/'              TO int_xdata-partnr+2(1).
        MOVE prot_list-rcvpfc TO int_xdata-partnr+3(2). "partnerrolle
        MOVE '/'              TO int_xdata-partnr+5(1).
        MOVE prot_list-rcvprn TO int_xdata-partnr+6(10). "partnernummer
        MOVE prot_list-sndprt TO int_xdata-ident(2). "partnerart
        MOVE '/'              TO int_xdata-ident+2(1).
        MOVE prot_list-sndpfc TO int_xdata-ident+3(2). "partnerrolle
        MOVE prot_list-sndprn TO int_xdata-ident+6(10). "partnernummer
      ELSE.
        MOVE prot_list-sndprt TO int_xdata-partnr(2). "partnerart
        MOVE '/'              TO int_xdata-partnr+2(1).
        MOVE prot_list-sndpfc TO int_xdata-partnr+3(2). "partnerrolle
        MOVE '/'              TO int_xdata-partnr+5(1).
        MOVE prot_list-sndprn TO int_xdata-partnr+6(10). "partnernummer
        MOVE prot_list-rcvprt TO int_xdata-ident(2). "partnerart
        MOVE '/'              TO int_xdata-ident+2(1).
        MOVE prot_list-rcvpfc TO int_xdata-ident+3(2). "partnerrolle
        MOVE '/'              TO int_xdata-ident+5(1).
        MOVE prot_list-rcvprn TO int_xdata-ident+6(10). "partnernummer
      ENDIF.
      APPEND int_xdata TO xdata.
    ENDIF.
  ENDLOOP.


ENDFORM.                               " FILL_XDATA

*---------------------------------------------------------------------*
*       FORM CALLBACK_FROM_LIST                                       *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  R_UCOM                                                        *
*  -->  RS_SELFIELD                                                   *
*---------------------------------------------------------------------*
FORM callback_from_list USING r_ucom LIKE sy-ucomm
                              rs_selfield TYPE slis_selfield.

  IF rs_selfield-sel_tab_field = 'XDATA-DOCNUM'.
    IF a_search = ' '.
      READ TABLE xdata INDEX rs_selfield-tabindex.
      CLEAR idoc_doc_list_range.
      REFRESH idoc_doc_list_range.
*  loop at PROT_LIST.
      MOVE   'I'                       TO idoc_doc_list_range-sign.
      MOVE   'EQ'                      TO idoc_doc_list_range-option.
      MOVE   xdata-docnum TO idoc_doc_list_range-low-docnum.
      APPEND idoc_doc_list_range.
*  endloop.
      RANGES: local_credat FOR edidc-credat.

      CLEAR   local_credat.
      REFRESH local_credat.
      SUBMIT rseidoc2
             WITH credat IN local_credat
             WITH docnum IN idoc_doc_list_range
      AND RETURN.
    ELSE.
* Jump to rseidoc2 not possible in archive mode.
    ENDIF.
  ENDIF.
  IF rs_selfield-sel_tab_field = 'YDATA-SEGNUM'.
    READ TABLE ydata INDEX rs_selfield-tabindex.
    READ TABLE xdata WITH KEY docnum = ydata-docnum.
    IF a_search = ' '.
      PERFORM authority_check_idoc USING 'S_IDOCMONI'
                                         'WE09'
                                         '03'
                                   CHANGING authority_ok.
      IF authority_ok = true.
        CALL FUNCTION 'EDI_DATA_RECORD_DISPLAY'
             EXPORTING
                  docnum               = ydata-docnum
                  segnum               = ydata-segnum
*         SEGFLD               =
             EXCEPTIONS
                  no_data_record_found = 1
                  OTHERS               = 2.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
      ENDIF.
    ELSE.
      PERFORM authority_check_idoc USING 'S_IDOCMONI'
                                         'WE10'
                                         '03'
                                   CHANGING authority_ok.
      IF authority_ok = true.
        PERFORM display_datarecord USING ydata-docnum
                                         ydata-segnum.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    "callback_from_list

*&---------------------------------------------------------------------*
*&      Form  DISPLAY_MESSAGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_MSG_ID  text
*      -->P_MSG_NO  text
*      -->P_MSG_VAR1  text
*----------------------------------------------------------------------*
FORM display_message USING    p_msg_id LIKE t100-arbgb
                              p_msg_no LIKE t100-msgnr
                              p_msg_var1
                              p_msg_var2
                              p_msg_var3.
  DATA: msg_text(120) TYPE c.
  DATA: msg_var1 LIKE balm-msgv1.
  DATA: msg_var2 LIKE balm-msgv2.
  DATA: msg_var3 LIKE balm-msgv3.
  msg_var1 = p_msg_var1.
  msg_var2 = p_msg_var2.
  msg_var3 = p_msg_var3.
  CONDENSE msg_var1 NO-GAPS.
  CONDENSE msg_var2 NO-GAPS.
  CONDENSE msg_var3 NO-GAPS.

  CALL FUNCTION 'MESSAGE_PREPARE'
       EXPORTING
*         LANGUAGE               = ' '
            msg_id                 = p_msg_id
            msg_no                 = p_msg_no
            msg_var1               = msg_var1
            msg_var2               = msg_var2
            msg_var3               = msg_var3
*         MSG_VAR4               = ' '
       IMPORTING
            msg_text               = msg_text
       EXCEPTIONS
            function_not_completed = 1
            message_not_found      = 2
            OTHERS                 = 3.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
       EXPORTING
*         PERCENTAGE = 0
            text       = msg_text.

ENDFORM.                               " DISPLAY_MESSAGE
*&---------------------------------------------------------------------*
*&      Form  AUTHORITY_CHECK_IDOC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_AUTHORITY_OK  text
*----------------------------------------------------------------------*
FORM authority_check_idoc USING p_object LIKE edi_authmo-object
                                p_editcd LIKE edi_authct-editcd
                                p_ediact LIKE edi_authct-ediact
                          CHANGING p_authority_ok.

  IF xdata-direct EQ '1'.              " dann Empf#nger abzutesten
    AUTHORITY-CHECK OBJECT p_object
        ID 'EDI_TCD' FIELD p_editcd
        ID 'ACTVT'   FIELD p_ediact
        ID 'EDI_DIR' FIELD xdata-direct
        ID 'EDI_MES' FIELD xdata-mestyp
        ID 'EDI_PRN' FIELD xdata-rcvprn
        ID 'EDI_PRT' FIELD xdata-rcvprt.

    IF sy-subrc = 0.
* authoritycheck positive
      MOVE true  TO p_authority_ok.
    ELSE.
* authoritycheck negative; message for the user and stop program
      MESSAGE i169 WITH xdata-mestyp xdata-direct
                        xdata-rcvprt xdata-rcvprn.
      MOVE false TO p_authority_ok.
    ENDIF.
  ELSE.                                " Eingang -> Sender abzutesten
    AUTHORITY-CHECK OBJECT p_object
        ID 'EDI_TCD' FIELD p_editcd
        ID 'ACTVT'   FIELD p_ediact
        ID 'EDI_DIR' FIELD xdata-direct
        ID 'EDI_MES' FIELD xdata-mestyp
        ID 'EDI_PRN' FIELD xdata-sndprn
        ID 'EDI_PRT' FIELD xdata-sndprt.

    IF sy-subrc = 0.
* authoritycheck positive
      MOVE true  TO p_authority_ok.
    ELSE.
* authoritycheck negative; message for the user and stop program
      MESSAGE i169 WITH xdata-mestyp xdata-direct
                        xdata-sndprt xdata-sndprn.
      MOVE false TO p_authority_ok.
    ENDIF.
  ENDIF.

ENDFORM.                               " AUTHORITY_CHECK_IDOC
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_DATARECORD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_DOCNUM  text
*      -->P_SEGNUM  text
*----------------------------------------------------------------------*
FORM display_datarecord USING    p_docnum
                                 p_segnum.

  DATA:
    l_t_fields        LIKE sval  OCCURS 0 WITH HEADER LINE,
    l_t_dd03p         LIKE dd03p OCCURS 0 WITH HEADER LINE,
    l_curr_pos        TYPE i,
    l_node            LIKE snodetext,
    l_return(1)       TYPE c,
    l_popup_title(30) TYPE c,
    disp_edidd LIKE edidd OCCURS 100 WITH HEADER LINE,
    disp_edids LIKE edids OCCURS 100 WITH HEADER LINE,
    sdata_in LIKE edidd-sdata.

  CLEAR: disp_edidd, disp_edids.
  REFRESH: disp_edidd, disp_edids.

  CALL FUNCTION 'EDI_IDOC_GET_FROM_ARCHIVE'
       EXPORTING
            docnum                       = p_docnum
*    IMPORTING
*         INT_EDIDC                    =
       TABLES
            int_edidd                    = disp_edidd
            int_edids                    = disp_edids
       EXCEPTIONS
            OTHERS                       = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  READ TABLE disp_edidd WITH KEY docnum = p_docnum
                                 segnum = p_segnum.
  l_t_dd03p-tabname = disp_edidd-segnam.
  sdata_in = disp_edidd-sdata.
* get ddic information about the structure
  CALL FUNCTION 'DD_GET_DD03P'
    EXPORTING
      tabname       = l_t_dd03p-tabname
    TABLES
      dd03p_tab     = l_t_dd03p
    EXCEPTIONS
      illegal_value = 1
      OTHERS        = 2.

  IF   ( sy-subrc <> 0 )
    OR ( l_t_dd03p[] IS INITIAL ).
* structure invalid (segment not found)
*    message id     'E0'
*            type   'I'
*            number '785'
*            with   t_node_in-name.
    EXIT.
  ENDIF.

  LOOP AT l_t_dd03p.
    l_t_fields-tabname    = l_t_dd03p-tabname.
    l_t_fields-fieldname  = l_t_dd03p-fieldname.
    l_t_fields-novaluehlp = true.
    l_t_fields-field_attr = '03'.
    l_t_fields-value      = sdata_in+l_curr_pos(l_t_dd03p-leng).
    l_curr_pos = l_curr_pos + l_t_dd03p-leng.
    APPEND l_t_fields.
  ENDLOOP.

*  if t_node_in-type = c_node_type_h.
*    l_popup_title = text-011.
*  else.
*    l_popup_title = text-012.
*  endif.

* show all of the segment fields in popup
  CALL FUNCTION 'POPUP_GET_VALUES'
    EXPORTING
      no_value_check  = true
      popup_title     = l_popup_title
    IMPORTING
      returncode      = l_return
    TABLES
      fields          = l_t_fields
    EXCEPTIONS
      error_in_fields = 1
      OTHERS          = 2.

  IF sy-subrc <> 0.
* error, e.g. fields too long
    MESSAGE ID     sy-msgid
            TYPE   sy-msgty
            NUMBER sy-msgno
            WITH   sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.



ENDFORM.                               " DISPLAY_DATARECORD

*---------------------------------------------------------------------*
*       FORM LOAD_YDATA                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  RS_SELFIELD                                                   *
*  -->  RFLG_ALL                                                      *
*---------------------------------------------------------------------*
FORM load_ydata USING rs_selfield TYPE slis_selfield
                      rflg_all TYPE c.

  DATA: tmp_ydata LIKE edidd OCCURS 0 WITH HEADER LINE.
  CLEAR: tmp_ydata.                    ", ydata.
  REFRESH: tmp_ydata.                  ", ydata.

  IF   rflg_all = ' '.
    READ TABLE xdata INDEX rs_selfield-tabindex.
    IF a_search = ' '.
*      ydata = int_select_edidd.
*      ydata[] = int_select_edidd[].

      CALL FUNCTION 'IDOC_READ_COMPLETELY'
           EXPORTING
                document_number          = xdata-docnum
*    IMPORTING
*         IDOC_CONTROL             =
*         NUMBER_OF_DATA_RECORDS   =
*         NUMBER_OF_STATUS_RECORDS =
          TABLES
*              int_edids                =
               int_edidd                = tmp_ydata
           EXCEPTIONS
                document_not_exist       = 1
                document_number_invalid  = 2
                OTHERS                   = 3.
      IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

    ELSE.

      CALL FUNCTION 'EDI_IDOC_GET_FROM_ARCHIVE'
           EXPORTING
                docnum                       = xdata-docnum
*    IMPORTING
*         INT_EDIDC                    =
           TABLES
                int_edidd                    = tmp_ydata
*                int_edids                    =
           EXCEPTIONS
                OTHERS                       = 4.
      IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.
    ENDIF.

    LOOP AT tmp_ydata.
      CLEAR tmp_ydata-sdata.
      MOVE-CORRESPONDING tmp_ydata TO ydata.
      CLEAR ydata-highlight.
      LOOP AT int_select_edidd WHERE docnum = tmp_ydata-docnum
                                 AND segnum = tmp_ydata-segnum.
        ydata-highlight = 'C30'.
      ENDLOOP.
      APPEND ydata.
    ENDLOOP.
  ELSE.

    CLEAR ydata.
    REFRESH ydata.
    LOOP AT xdata.
      CLEAR: tmp_ydata.
      REFRESH: tmp_ydata.

      IF a_search = ' '.
*       ydata = int_select_edidd.
*       ydata[] = int_select_edidd[].

        CALL FUNCTION 'IDOC_READ_COMPLETELY'
             EXPORTING
                  document_number          = xdata-docnum
*    IMPORTING
*         IDOC_CONTROL             =
*         NUMBER_OF_DATA_RECORDS   =
*         NUMBER_OF_STATUS_RECORDS =
            TABLES
*                int_edids                =
                 int_edidd                = tmp_ydata
             EXCEPTIONS
                  document_not_exist       = 1
                  document_number_invalid  = 2
                  OTHERS                   = 3.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.

      ELSE.

        CALL FUNCTION 'EDI_IDOC_GET_FROM_ARCHIVE'
             EXPORTING
                  docnum                       = xdata-docnum
*    IMPORTING
*         INT_EDIDC                    =
             TABLES
                  int_edidd                    = tmp_ydata
*                 int_edids                    =
             EXCEPTIONS
                  OTHERS                       = 4.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
      ENDIF.
      LOOP AT tmp_ydata.
        CLEAR tmp_ydata-sdata.
        MOVE-CORRESPONDING tmp_ydata TO ydata.
        CLEAR ydata-highlight.
        LOOP AT int_select_edidd WHERE docnum = tmp_ydata-docnum
                                   AND segnum = tmp_ydata-segnum.
          ydata-highlight = 'C30'.
        ENDLOOP.
        APPEND ydata.
      ENDLOOP.
    ENDLOOP.
  ENDIF.

ENDFORM.                    "load_ydata
*&---------------------------------------------------------------------*
*&      Form  append_tab_selections
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_FIELDNAME  text
*      -->P_TABLE  text
*      -->P_TAB_SELECTIONS  text
*----------------------------------------------------------------------*
FORM append_tab_selections TABLES p_tab_selections
                                  p_selection_range
                           USING  p_fieldname.

  FIELD-SYMBOLS: <l_line>, <f_sign>, <f_option>, <f_low>, <f_high>.
  DATA: wa_selections TYPE rsds_frange.
  DATA: selection_range TYPE rsdsselopt.
  CLEAR sy-subrc.
  wa_selections-fieldname = p_fieldname.
  LOOP AT p_selection_range ASSIGNING <l_line>.
    IF sy-subrc = 0.
      ASSIGN COMPONENT 1 OF STRUCTURE <l_line> TO <f_sign>.
      IF sy-subrc = 0.
        selection_range-sign   = <f_sign>.
      ENDIF.
      ASSIGN COMPONENT 2 OF STRUCTURE <l_line> TO <f_option>.
      IF sy-subrc = 0.
        selection_range-option = <f_option>.
      ENDIF.
      ASSIGN COMPONENT 3 OF STRUCTURE <l_line> TO <f_low>.
      IF sy-subrc = 0.
        selection_range-low    = <f_low>.
      ENDIF.
      ASSIGN COMPONENT 4 OF STRUCTURE <l_line> TO <f_high>.
      IF sy-subrc = 0.
        selection_range-high   = <f_high>.
      ENDIF.
      APPEND selection_range TO wa_selections-selopt_t.
    ENDIF.
  ENDLOOP.

  APPEND wa_selections TO p_tab_selections.


ENDFORM.                               " append_tab_selections
*&---------------------------------------------------------------------*
*&      Form  update_field
*&---------------------------------------------------------------------*
*       Update field with the new value
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM update_field .

  DATA: lv_subrc LIKE sy-subrc,
        offset   TYPE i.

  offset = offset1 - 1.

  IF value1 IS INITIAL.

    LOOP AT int_edidc.
* lock idoc
      PERFORM sub_lock_idoc USING int_edidc-docnum
                                 CHANGING lv_subrc.
* select all segments(more then 1 possible)
      SELECT  * FROM edid4 WHERE docnum  = int_edidc-docnum
                                   AND counter = '000'
                                   AND segnam  = segment1.
* update segment
        edid4-sdata+offset(expleng1) = value2.
        UPDATE edid4.
        IF sy-subrc = 0.
          WRITE: / text-i01, int_edidc-docnum.
        ELSE.
          WRITE: / '!', text-e04, int_edidc-docnum.
        ENDIF.
      ENDSELECT.
* update status
      SELECT SINGLE * FROM edidc WHERE
               docnum = int_edidc-docnum.
      IF sy-subrc = 0.
        edidc-status = gv_idoc_status_change.
        UPDATE edidc.
      ENDIF.
* unlock idoc
      PERFORM sub_unlock_idoc USING int_edidc-docnum.
    ENDLOOP.

  ELSE.
    LOOP AT int_select_edidd.
* lock idoc
      PERFORM sub_lock_idoc USING int_select_edidd-docnum
                                 CHANGING lv_subrc.
* select all segments(more then 1 possible)
      SELECT * FROM edid4 WHERE docnum  = int_select_edidd-docnum
                                   AND counter = '000'
                                  AND segnum  = int_select_edidd-segnum.
* update segment
        edid4-sdata+offset(expleng1) = value2.
        UPDATE edid4.
        IF sy-subrc = 0.
          WRITE: / text-i01, int_select_edidd-docnum.
        ELSE.
          WRITE: / '!', text-e04, int_select_edidd-docnum.
        ENDIF.
      ENDSELECT.
* update status
      SELECT SINGLE * FROM edidc WHERE
               docnum = int_select_edidd-docnum.
      IF sy-subrc = 0.
        edidc-status = gv_idoc_status_change.
        UPDATE edidc.
      ENDIF.
* unlock idoc
      PERFORM sub_unlock_idoc USING int_select_edidd-docnum.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " update_field

*&---------------------------------------------------------------------*
*&      Form  sub_lock_idoc
*&---------------------------------------------------------------------*
*       Lock IDOC
*----------------------------------------------------------------------*
*      -->R_DOCNUM  IDOC document number
*      <--R_SUBRC   return code
*----------------------------------------------------------------------*
FORM sub_lock_idoc  USING    r_docnum
                    CHANGING r_subrc.

  CALL FUNCTION 'ENQUEUE_ES_EDIDOCE'
    EXPORTING
      mode_edidc           = 'E'
      mandt                = sy-mandt
      docnum               = r_docnum
*     X_DOCNUM             = ' '
*     _SCOPE               = '2'
*     _WAIT                = ' '
*     _COLLECT             = ' '
    EXCEPTIONS
      foreign_lock         = 1
      system_failure       = 2
      OTHERS               = 3
            .
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  r_subrc = sy-subrc.

ENDFORM.                    " sub_lock_idoc

*&---------------------------------------------------------------------*
*&      Form  sub_unlock_idoc
*&---------------------------------------------------------------------*
*       Unlock IDOC
*----------------------------------------------------------------------*
*      -->R_DOCNUM  IDOC document number
*----------------------------------------------------------------------*
FORM sub_unlock_idoc  USING    r_docnum.

  CALL FUNCTION 'DEQUEUE_ES_EDIDOCE'
    EXPORTING
      mode_edidc           = 'E'
      mandt                = sy-mandt
      docnum               = r_docnum
*     X_DOCNUM             = ' '
*     _SCOPE               = '3'
*     _WAIT                = ' '
*     _COLLECT             = ' '
            .

ENDFORM.                    " sub_unlock_idoc
*&---------------------------------------------------------------------*
*&      Form  list_idocs
*&---------------------------------------------------------------------*
*       list of idocs that can be updated in TESTRUN
*----------------------------------------------------------------------*
FORM list_idocs .

  DATA: lv_subrc LIKE sy-subrc,
        offset   TYPE i.

  offset = offset1 - 1.

  IF value1 IS INITIAL.
    LOOP AT int_edidc.

      SELECT SINGLE * FROM edid4 WHERE docnum  = int_edidc-docnum
                                   AND counter = '000'
                                   AND segnam  = segment1.

      IF sy-subrc = 0.
        WRITE: / text-i02, int_edidc-docnum.
      ELSE.
        WRITE: / '!', text-e01, int_edidc-docnum.
      ENDIF.

    ENDLOOP.
  ELSE.
    LOOP AT int_select_edidd.

     SELECT SINGLE * FROM edid4 WHERE docnum  = int_select_edidd-docnum
                                  AND counter = '000'
                                  AND segnum  = int_select_edidd-segnum.

      IF sy-subrc = 0.
        WRITE: / text-i02, int_select_edidd-docnum.
      ELSE.
        WRITE: / '!', text-e01, int_select_edidd-docnum.
      ENDIF.

    ENDLOOP.
  ENDIF.

ENDFORM.                    "list_idocs
