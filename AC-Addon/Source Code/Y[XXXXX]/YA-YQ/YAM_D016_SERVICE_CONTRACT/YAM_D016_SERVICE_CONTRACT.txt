*----------------------------------------------------------------------
* PROGRAM ID           : YAM_D016_SERVICE_CONTRACT                     *
* PROGRAM TITLE        : DATA UPLOAD PROGRAM FOR SERVICE CONTRACTS     *
* AUTHOR               : MIRA SAIKRISHNA                               *
* DATE                 : 03/09/2004                                    *
* DEVELOPMENT ID       : DDD:D016 UK                                   *
* CHANGE REQUEST NUMBER: CD1K900429                                    *
* PROGRAM DESCRIPTION  : THIS IS A DATA CONVERSION PROGRAM TO UPLOAD   *
*                        SERVICE CONTRACTS FOR THE CUT-OVER.           *
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG
*
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE #
*
*----------------------------------------------------------------------*
* MOD-001 | 2004.09.04 | Mira S|CD1K900544 |Changes to get the Equipment
*                                           Number in the Contract     |
*
* MOD-002 | 2004.12.03 | Marc J|CD1K901042 |Add some fields for
*                                           contractindexation
* MOD-003 | 2004.12.10 | Luc Mertens |CD1K901xxx | VASDA
* MOD-004 | 2004.12.21 | Marc Jacobs |CD1K901xxx |materials on contract|
* MOD-005 | 2004.12.21 | Marc Jacobs |CD1K901xxx |correct text sorting |
************************************************************************

REPORT yam_d016_service_contract
       NO STANDARD PAGE HEADING
       LINE-SIZE 270
       MESSAGE-ID yam_dc.

*---------------------------------------------------------------------*
* TABLE DECLARATION
*---------------------------------------------------------------------*

TABLES: rlgrap,               " PROGRAM FIELDS/SCREEN FIELDS FOR
                              " SAPLGRAP
        vbak,                 " SALES DOCUMENT: HEADER DATA
        vbap,                 " SALES DOCUMENT: ITEM DATA
        vbkd,                 " SALES DOCUMENT: BUSINESS DATA
        fpla,                 " BILLING PLAN
        veda,                 " CONTRACT DATA
        ypcccc_datab,         " SERVICE CONTRACT STRUCTURE TRANSACTION
                              " DATA FOR DIRECT INPUT
        apqi,                 " QUEUE INFO DEFINITION
        /sapdmc/lsmemory.     " DEFAULT VALUES FOR PROJECT, SUBPROJECT,
" OBJECT

*---------------------------------------------------------------------*
* TYPE DEFINITIONS
*---------------------------------------------------------------------*
* - DECLARATION FOR STRUCTURE TO READ THE FLAT FILE STRING PER STRING
TYPES: BEGIN OF ty_upload,
         v_text(500)   TYPE c,            " FILE UPLOAD TEXT
       END OF ty_upload.

* - DECLARATION FOR THE CORRESPONDING TARGET FIELDS
TYPES : BEGIN OF ty_final_record,
            reclink_c(020),             " IDENTIFIER
            vkgrp      TYPE vkgrp,      " SALES GROUP
            vkbur      TYPE vkbur,      " SALES OFFICE
            cccntp     TYPE auart,      " SALES DOCUMENT TYPE
            cccust     TYPE kunnr,      " SOLD-TO PARTY
            ccoref     TYPE bstkd,      " CUSTOMER PURCHASE ORDER
            ccsdat     TYPE vbdat_veda, " CONTRACT START DATE
            ccedat     TYPE vndat_veda, " CONTRACT END DATE
            ccscon     TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
            ccdurnd    TYPE vadat_veda, " AGREEMENT ACCEPTANCE DATE
            ccsdat1    TYPE vudat_veda, " DATE ON WHICH CONTRACT IS
                                        " SIGNED
            ccperiocat TYPE vlauk_veda, " VALIDITY PERIOD CATEGORY OF
                                        " CONTRACT
            ccdurn     TYPE vlauf_veda, " VALIDITY PERIOD OF CONTRACT
            ccniwk     TYPE bedat,      " START DATE OF BILL
            ccedatc    TYPE endat,      " END DATE
            ccifrq     TYPE zchar_1,    " RULE TO DETERMINE NEXT
                                        " BILLING
            cccsts     TYPE  autte,     " BILLING/INVOICE CREATION IN
                                        " ADVANCE
            mssprd     TYPE matnr,      " MATERIAL NUMBER
            msppyr     TYPE zchar15,    " AMOUNT
            msmsno     TYPE sernr,      " SERIAL NUMBER
            msmpno     TYPE matnr,      " MATERIAL NUMBER
            equnr      TYPE equnr,      " EQUIPMENT NUMBER
            text       TYPE tdline,     " TEXT DETAIL
* begin of insertion MOD-002
            vbeln      TYPE vbeln,      " SALES ORDER NUMBER
            vasdr      TYPE vasdr,      " Date rule for action
            kdkg1      TYPE kdkg1,      " customer condition group
            vasda      type vasda,      " Date for action
            vakt       type VASCH_VEDA, " Action at end of contract
* end of insertion MOD-002
        END OF ty_final_record.


* - DECLARATION FOR THE HEADER DATA
TYPES : BEGIN OF ty_header,
            reclink_c(020),             " IDENTIFIER
            vkgrp      TYPE vkgrp,      " SALES GROUP
            vkbur      TYPE vkbur,      " SALES OFFICE
            cccntp     TYPE auart,      " SALES DOCUMENT TYPE
            cccust     TYPE kunnr,      " SOLD-TO PARTY
            ccoref     TYPE bstkd,      " CUSTOMER PURCHASE ORDER
            ccsdat     TYPE vbdat_veda, " CONTRACT START DATE
            ccedat     TYPE vndat_veda, " CONTRACT END DATE
            ccscon     TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
            ccdurnd    TYPE vadat_veda, " AGREEMENT ACCEPTANCE DATE
            ccsdat1    TYPE vudat_veda, " DATE ON WHICH CONTRACT IS
                                        " SIGNED
            ccperiocat TYPE vlauk_veda, " VALIDITY PERIOD CATEGORY OF
                                        " CONTRACT
            ccdurn     TYPE vlauf_veda, " VALIDITY PERIOD OF CONTRACT
            ccniwk     TYPE bedat,      " START DATE OF BILL
            ccedatc    TYPE endat,      " END DATE
            ccifrq     TYPE zchar_1,    " 3 CHARACTER FIELD
            cccsts     TYPE autte,      " BILLING/INVOICE CREATION IN
                                        " ADVANCE
            text       TYPE tdline,     " TEXT DETAIL
            no         TYPE i,          " NO OF LOOP PASSES
* begin of insertion MOD-002
            vbeln      TYPE vbeln,      " SALES ORDER NUMBER
            vasdr      TYPE vasdr,      " Date rule for action
            kdkg1      TYPE kdkg1,      " customer condition group
            vasda      type vasda,      " Date for action
            vakt       type VASCH_VEDA, " Action at end of contract
* end of insertion MOD-002
        END OF ty_header.


* - DECLARATION FOR THE ITEM DATA
TYPES : BEGIN OF ty_detail,
            reclink_c(020),             " IDENTIFIER
            mssprd     TYPE matnr,      " MATERIAL NUMBER
            msppyr     TYPE zchar15,    " AMOUNT
            msmsno     TYPE gernr,      " SERIAL NUMBER
            msmpno     TYPE matnr,      " MATERIAL NUMBER
            equnr      TYPE equnr,      " EQUIPMENT NUMBER
            text       TYPE tdline,     " TEXT DETAIL
        END OF ty_detail.


* - DECLARATION FOR THE SALES DOCUMENT
TYPES : BEGIN OF ty_sales,
            vbeln      TYPE vbeln_va,   " SALES DOCUMENT NUMBER
            vsnmr_v    TYPE vsnmr_v,    " SALES DOCUMENT VERSION NUMBER
        END OF ty_sales.


*---------------------------------------------------------------------*
* WORK AREA DECLARATIONS                                              *
*---------------------------------------------------------------------*
DATA : wa_sales           TYPE  ty_sales.  " WORK AREA FOR SALES DOC
DATA : wa_contractheader  TYPE  bapisdhd1. " WORK AREA CONTRACT HEADER
DATA : wa_contractheaderx TYPE  bapisdhd1x." WORK AREA CONTRACT FILL
DATA : wa_contractheaderc TYPE  bapisdh1.  " WORK AREA CHANGE CONTRACT
DATA : wa_contractheaderu TYPE  bapisdh1x. " WORK AREA CONTRACT UPDATE
DATA : wa_contractitems   TYPE  bapisditm. " WORK AREA CONTRACT ITEMS
DATA : wa_contractitemsx  TYPE  bapisditmx." WORK AREA ITEMS FILL
DATA : wa_contractitemsu  TYPE  bapisditmx." WORK AREA ITEMS UPDATE
DATA : wa_contract        TYPE  bapictr.   " WORK AREA CONTRACT DATES
DATA : wa_contractx       TYPE  bapictrx.  " WORK AREA DATES FILL
DATA : wa_contractu       TYPE  bapictrx.  " WORK AREA DATES UPDATE
DATA : wa_partner         TYPE  bapiparnr. " WORK AREA PARTNER
DATA : wa_condition       TYPE  bapicond.  " WORK ARE CONDITION
DATA : wa_bapiret2        TYPE  bapiret2.  " WORK AREA CREATE RETURN
DATA : wa_bapiret         TYPE  bapiret2.  " WORK AREA CHANGE RETURN
DATA : wa_contracttext    TYPE  bapisdtext." WORK AREA CONTRACT TEXT
DATA : wa_conditionx      TYPE  bapicondx. " WORK AREA CONDITION FILL
DATA : wa_conditionu      TYPE  bapicondx. " WORK AREA CONDITION UPDATE
*---------------------------------------------------------------------*
* INTERNAL TABLE DECLARATIONS                                         *
*---------------------------------------------------------------------*
* - INTERNAL TABLE FOR THE FILE OF LEGACY DATA UPLOAD FOR CONTRACTS
DATA : i_upload TYPE STANDARD TABLE OF ty_upload
                       INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE LEGACY DATA
DATA : i_final_record TYPE STANDARD TABLE OF ty_final_record
                       INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE HEADER DATA
DATA : i_header TYPE STANDARD TABLE OF ty_header
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE DETAIL DATA
DATA : i_detail TYPE STANDARD TABLE OF ty_detail
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CONTRACT HEADER DATA
DATA : i_contractheader TYPE STANDARD TABLE OF bapisdhd1
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CONTRACT HEADER UPDATE
DATA : i_contractheaderx TYPE STANDARD TABLE OF bapisdhd1x
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CHANGE CONTRACT HEADER
DATA : i_contractheaderc TYPE STANDARD TABLE OF bapisdh1
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR BAPI STRUCTURE OF THE CHANGE CONTRACT HEADER
* - UPDATE DATA
DATA : i_contractheaderu TYPE STANDARD TABLE OF bapisdh1x
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT ITEM DATA
DATA : i_contract_items TYPE STANDARD TABLE OF bapisditm
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT ITEM UPDATE
* - DATA
DATA : i_contract_itemsx TYPE STANDARD TABLE OF bapisditmx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CHANGE CONTRACT ITEM
* - UPDATE DATA
DATA : i_contract_itemsu TYPE STANDARD TABLE OF bapisditmx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT DATES
DATA : i_contract TYPE STANDARD TABLE OF bapictr
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONTRACT DATES UPDATE
DATA : i_contractx TYPE STANDARD TABLE OF bapictrx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CHANGE CONTRACT DATES
* - UPDATE
DATA : i_contractu TYPE STANDARD TABLE OF bapictrx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE PARTNER DETAILS
DATA : i_partner TYPE STANDARD TABLE OF bapiparnr
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONDITION RECORD
DATA : i_condition TYPE STANDARD TABLE OF bapicond
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CONDITION RECORD
* - UPDATE
DATA : i_conditionx TYPE STANDARD TABLE OF bapicondx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE CHANGE
* - CONDITION RECORD UPDATE
DATA : i_conditionu TYPE STANDARD TABLE OF bapicondx
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTUE OF THE RETURN DATA
DATA : i_bapiret2 TYPE STANDARD TABLE OF bapiret2
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTUE OF THE RETURN DATA
DATA : i_bapiret TYPE STANDARD TABLE OF bapiret2
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE OF THE TEXT DETAILS.
DATA : i_contract_text TYPE STANDARD TABLE OF bapisdtext
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE FOR THE SALES DOCUMNET NUMBER
DATA : i_vbak TYPE STANDARD TABLE OF vbak
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE FOR THE SALES DOCUMNET NUMBER
DATA : i_salesdoc_in TYPE STANDARD TABLE OF ty_sales
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE FOR THE BAPI STRUCTURE FOR PARTNER CHANGES
DATA : i_partnerc TYPE STANDARD TABLE OF bapiparnrc
                      INITIAL SIZE 0 WITH HEADER LINE.

* - INTERNAL TABLE MANIPULATING THE HEADER AND DETAIL AND PASSING TO
* - BAPI.
DATA : i_contract_items1 LIKE i_contract_items
                            OCCURS 0 WITH HEADER LINE.

* - INTERNAL TABLE MANIPULATING DETAIL FOR EQUIPMENT.
DATA : i_detail_equip LIKE i_detail
                            OCCURS 0 WITH HEADER LINE.


*-ADDED BY MIRA_RECENT TO IDENTIFY TEXTS FOR EACH CONTRACT.
DATA: BEGIN OF i_contract_text_all OCCURS 0,
           reclink_c(020).    " IDENTIFIER
        INCLUDE STRUCTURE bapisdtext.
DATA: END OF i_contract_text_all.

*-WORK AREA FOR TEXTS FOR EACH CONTRACT.
DATA: BEGIN OF wa_contract_text,
           reclink_c(020).    " IDENTIFIER
        INCLUDE STRUCTURE bapisdtext.
DATA: END OF wa_contract_text.


*---------------------------------------------------------------------*
* VARIABLE DECLARATIONS                                               *
*---------------------------------------------------------------------*
DATA :  g_counter TYPE sy-tabix,                " FOR STORING LINE ITEM
                                                " INCREMENTS
        g_count   TYPE sy-tabix,                " COUNT
        g_vbeln   TYPE vbeln_va,                " SALES DOCUMENT NUMBER
        p_infile  LIKE /sapdmc/lsoinp-filename, " FILE
        g_vsnmr_v LIKE vbak-vsnmr_v,            " SALES DOCUMENT
                                                " VERSION
        g_lin     TYPE i,                       " TOTAL LINES
                                                " CONTRACT INTERNAL
* Begin of changes :- Mira_equipment
        v_indx(2) TYPE n,
        v_mod LIKE sy-tabix.
* End of changes:- Mira_equipment

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS                                               *
*---------------------------------------------------------------------*
CONSTANTS : c_rb_pre         TYPE c VALUE  ' ',      " SPACE
            c_filetype(10)   TYPE c VALUE 'ASC',     " FILE TYPE
            c_x              TYPE c VALUE 'X',       " CHECKED
            c_vkorg(4)       TYPE c VALUE 'GBAA',    " SALES
                                                     " ORGANIZATION
            c_vtweg(2)       TYPE c VALUE '11',      " SALES DIVISION
            c_spart(2)       TYPE c VALUE '01',      " SALES
                                                     " DISTRIBUTION
            c_partn1(2)      TYPE c VALUE 'AG',      " SOLD-TO PARTY
            c_partn2(2)      TYPE c VALUE 'WE',      " SHIP-TO PARTY
            c_cnd(4)         TYPE c VALUE 'ZPN0',    " DEFAULT
                                                     " CONDITION
                                                     " TYPE
            c_can(4)         TYPE c VALUE '0001',    " DEFAULT VALUE
                                                     " FOR
                                                     " CANCELLATION
            c_year(1)        TYPE c VALUE '4',       " DEFUALT UNIT VAL
                                                     " PERIOD
            c_curr(3)        TYPE c VALUE 'GBP',     " DEFAULT CURRENCY
            c_qnt(1)         TYPE c VALUE '1',       " DEFAULT VALUE
                                                     " FOR
                                                     " TARGET QTY
            c_ffprf(8)       TYPE c VALUE 'ZAM00001'," DYNAMIC ITEM
                                                     " PROCESSOR
* begin of deletion MOD-002
*           c_vakt(4)        TYPE c VALUE '0001',    " ACTION RULE
* end of deletion MOD-002
            c_rule(2)        TYPE c VALUE '3M',      " DATE RULE
            c_spras(2)       TYPE c VALUE 'EN',      " LANGUAGE
            c_tdid(4)        TYPE c VALUE '0002',    " TEXT ID
            c_tobj(4)        TYPE c VALUE 'VBBP',    " TEXT OBJECT
            c_tpar(2)        TYPE c VALUE ' ',       " TAG COLUMN
            c_itm(6)         TYPE c VALUE '000010',  " FIRST ITEM COUNT
            c_u(1)           TYPE c VALUE 'U',       " BAPI UPDATE FLAG
* begin of deletion MOD-002
*           c_fix(2)         TYPE c VALUE 'IN',      " CUSTOMER
*                                                    " CONDITION GROUP
*           c_fix1(2)        TYPE c VALUE 'NI',      " CUSTOMER
*                                                    " CONDITION GROUP
* end of deletion  MOD-002
            c_form(2)        TYPE c VALUE '/('.      " SPACE FOR
" NEWLINE

* Begin of changes :- Mira_equipment
CONSTANTS: c_incr TYPE sy-tabix VALUE 1.
* End of changes :- Mira_equipment


*-----------------------------------------------------------------------
*        P R I N T   V A R I A B L E    D E C L A R A T I O N
*-----------------------------------------------------------------------
DATA: g_valid          TYPE c,
      g_destination    LIKE pri_params-pdest.
DATA: wa_params        LIKE pri_params.

*-----------------------------------------------------------------------
*        P R I N T   C O N S T A N T S    D E C L A R A T I O N
*-----------------------------------------------------------------------
CONSTANTS: c_error      LIKE bapiret2-type    VALUE 'E',
           c_succ       LIKE bapiret2-type    VALUE 'S',
           c_list_name  LIKE pri_params-plist VALUE 'CONTRACREATE',
           c_list_text  LIKE pri_params-prtxt
                                           VALUE 'CONTARCT CREATE-LOG',
                                                            "#EC NOTEXT
           c_list_name1 LIKE pri_params-plist VALUE 'CONTRACHANGE',
           c_list_text1 LIKE pri_params-prtxt
                                           VALUE 'CONTARCT CHANGE-LOG',
                                                            "#EC NOTEXT

           c_size      TYPE i                 VALUE 255.

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS FOR BDC
*
*---------------------------------------------------------------------*
CONSTANTS : c_group     LIKE apqi-groupid VALUE 'Y_VA42',
            c_trans     LIKE tstc-tcode   VALUE 'VA42'.


****--------------------------------------------------------------------

**
**** SELECT-OPTIONS AND PARAMETERS
**
****--------------------------------------------------------------------

*
*SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
*
*PARAMETERS: P_FILE LIKE RLGRAP-FILENAME OBLIGATORY.
*
*SELECTION-SCREEN END OF BLOCK B1.
*
****--------------------------------------------------------------------

**
**** AT SELECTOIN-SCREEN EVENTS   - VALIDATE USER INPUT
**
****--------------------------------------------------------------------

*
*AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_FILE.
*
** - GET THE FILENAME ON THE PRESENTATION SERVER
*  PERFORM GET_FILENAME USING P_FILE.

*--------- S T A R T   O F   M A I N   P R O C E S S I N G -----------*

*---------------------------------------------------------------------*
* START-OF-SELECTION             - START OF DATABASE ACCESS           *
*---------------------------------------------------------------------*
START-OF-SELECTION.

* - GET THE FILENAME OF THE CONVERT FILE AND
* - IMPORT /SAPDMC/LSMEMORY FROM MEMORY ID '/SAPDMC/LSMW'.

  IMPORT /sapdmc/lsmemory FROM MEMORY ID '/SAPDMC/LSMW'.

  PERFORM get_lsmw IN PROGRAM yam_common_routines
                    USING  /sapdmc/lsmemory-project
                           /sapdmc/lsmemory-subproj
                           /sapdmc/lsmemory-object
                           c_x
                   CHANGING p_infile.

  IF sy-subrc <> 0.
    MESSAGE e007.
  ENDIF.


* - READ INPUT FILE FROM PRES/APPL SERVER INTO INTERNAL TABLE
  PERFORM get_input_file.

* - SPILT INTERNAL TABLE RECORDS INTO HEADER AND DETAIL RECORDS
  PERFORM split_file.

* - ERROR LOG REPORT LIST AT THE OUTPUT
  PERFORM output_report.

*---------------------------------------------------------------------*
* END-OF-SELECTION               - END OF DATABASE ACCESS             *
*---------------------------------------------------------------------*
END-OF-SELECTION.

*&---------------------------------------------------------------------*
*&      FORM  GET_INPUT_FILE
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM get_input_file .

  IF c_rb_pre = c_x.
* - FILE READ FROM PRESENTATION SERVER
    PERFORM get_from_pres IN PROGRAM yam_common_routines
                                     TABLES  i_upload
                                     USING   p_infile
                                             c_filetype
                                             c_x.

  ELSE.
* - FILE READ FROM APPLICATION SERVER
    PERFORM get_from_appl IN PROGRAM yam_common_routines
                                     TABLES i_upload
                                     USING  p_infile.

  ENDIF.

ENDFORM.                    " GET_INPUT_FILE


*&---------------------------------------------------------------------*
*&      FORM  SPLIT_FILE
*&---------------------------------------------------------------------*
*   SPLIT DATA FILE INTO HEADER AND DETAIL LEVEL FILES
*   HEADER FILE STORES THE TOTAL NUMBER OF LINE ITEMS WITHIN
*   THE RECORD.
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM split_file .

* - PASS THE RECORDS FROM FILE TO A COMMON INTERNAL TABLE
  LOOP AT i_upload.

    MOVE i_upload-v_text+13(20)    TO i_final_record-reclink_c.
* -  SKIP SPACE FOR SALES ORG(4),SALES DISTRIBUTION(2) AND DIVISION(2)
    MOVE i_upload-v_text+41(3)     TO i_final_record-vkgrp.
    MOVE i_upload-v_text+44(4)     TO i_final_record-vkbur.
    MOVE i_upload-v_text+48(4)     TO i_final_record-cccntp.
    MOVE i_upload-v_text+52(10)    TO i_final_record-cccust.
    MOVE i_upload-v_text+62(35)    TO i_final_record-ccoref.
    MOVE i_upload-v_text+97(8)     TO i_final_record-ccsdat.
    MOVE i_upload-v_text+105(8)    TO i_final_record-ccedat.
* begin of insertion MOD-002
    MOVE i_upload-v_text+113(4)    TO i_final_record-vakt.
* end of insertion MOD-002
    MOVE i_upload-v_text+117(12)   TO i_final_record-ccscon.
    MOVE i_upload-v_text+129(8)    TO i_final_record-ccdurnd.
    MOVE i_upload-v_text+137(8)    TO i_final_record-ccsdat1.
    MOVE i_upload-v_text+145(2)    TO i_final_record-ccperiocat.
    MOVE i_upload-v_text+147(3)    TO i_final_record-ccdurn.
* - SKIP SPACE FOR UNIT OF VALIDITY PERIOD OF CONTRACT(1)
    MOVE i_upload-v_text+151(8)    TO i_final_record-ccniwk.
* begin of deletion MOD-003
*    MOVE i_upload-v_text+159(8)    TO i_final_record-ccedatc.
* end of deletion MOD-003
    MOVE i_upload-v_text+167(2)    TO i_final_record-ccifrq.
* - SKIP SPACE PERIOD AND BILLING PLAN(4)
    MOVE i_upload-v_text+171(1)    TO i_final_record-cccsts.
* - SKIP SPACE FOR CUSTOMER CONDITION GROUP AND PERIOD(3)
* begin of insertion MOD-002
    MOVE i_upload-v_text+172(2)    TO i_final_record-kdkg1.
* end of insertion MOD-002
    MOVE i_upload-v_text+174(18)   TO i_final_record-mssprd.
* - SKIP SPACE FOR OTHER CONSTANT FIELDS
    MOVE i_upload-v_text+220(15)   TO i_final_record-msppyr.
    MOVE i_upload-v_text+235(18)   TO i_final_record-msmpno.
    MOVE i_upload-v_text+253(18)   TO i_final_record-msmsno.
* - EQUIPEMNT NUMBER (18)
    MOVE i_upload-v_text+289(132)  TO i_final_record-text.
    MOVE i_upload-v_text+421(18)   TO i_final_record-equnr.
* begin of insertion MOD-002
    MOVE i_upload-v_text+439(2)    TO i_final_record-vasdr.
    MOVE i_upload-v_text+441(10)   TO i_final_record-vbeln.
* begin of change MOD-003
*   move i_upload-v_text+451(8)    to i_final_record-vasda.
    move i_upload-v_text+453(8)    to i_final_record-vasda.
* end of change MOD-003
* end of insertion   MOD-002

    APPEND i_final_record.
*    CLEAR I_FINAL_RECORD.

* - PASS THE HEADER DETAILS TO THE HEADER INTERNAL TABLE
    MOVE-CORRESPONDING i_final_record TO i_header.
    APPEND i_header.
    CLEAR  i_header.

* - PASS THE ITEM DETAILS TO THE DETAIL INTERNAL TABLE
    MOVE-CORRESPONDING i_final_record TO i_detail.
    APPEND i_detail.
    CLEAR  i_detail.

  ENDLOOP.


  LOOP AT i_header WHERE reclink_c NE space.

    PERFORM header_text.

  ENDLOOP.

* - SORT THE HEADER INTERNAL TABLE AND DELETE THE DUPLICATES
  SORT i_header BY reclink_c.
  DELETE ADJACENT DUPLICATES FROM i_header COMPARING reclink_c.

* BEGIN OF CHANGES BY MIRA_RECENT
*- SORT THE CONTRACT TEXTS INTERNAL TABLE
* begin of modification MOD-005
* SORT i_contract_text_all BY reclink_c.
  SORT i_contract_text_all BY reclink_c text_line.
* end of modification MOD-005
*-SORT THE CONTRACT DETAIL TABLE

* begin of deletion MOD-003
*  SORT i_detail.
* end of deletion MOD-003

* END OF CHANGES BY MIRA_RECENT



* - CHECK IF HEADER IS NOT BLANK
  IF NOT i_header[] IS INITIAL.


    LOOP AT i_header WHERE reclink_c NE space.

*BEGIN OF CHANGES BY MIRA_RECENT
      LOOP AT i_contract_text_all WHERE reclink_c EQ
i_header-reclink_c.
        MOVE-CORRESPONDING i_contract_text_all TO wa_contracttext.
        APPEND wa_contracttext TO i_contract_text.
        CLEAR wa_contracttext.
      ENDLOOP.
*END OF CHANGES BY MIRA_RECENT

* - CHECK FOR THE EXISTING SERVICE CONTRACTS EXISTING.
      PERFORM sales_contract_doc.

    ENDLOOP.


  ENDIF.

ENDFORM.                    " SPLIT_FILE
*&---------------------------------------------------------------------*
*&   FORM SALES_CONTRACT_DOC
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM sales_contract_doc .

  REFRESH i_salesdoc_in.
  CLEAR: g_count,
         g_vsnmr_v.

* - CHECK FOR THE MULTIPLE SALES DOCUMENT VERSION
  SELECT vsnmr_v  COUNT( * ) FROM vbak
          INTO (g_vsnmr_v, g_count) WHERE
                         vsnmr_v EQ i_header-ccscon
                           GROUP BY vsnmr_v .

  ENDSELECT.
* - CHECK IF 1 ENTRY EXISTS FOR THE VERSION THEN OVERWRITE THE EXISTING
* - ONE
  IF g_count = 1.

    SELECT SINGLE vbeln
                  vsnmr_v INTO i_salesdoc_in
                  FROM vbak WHERE vsnmr_v EQ i_header-ccscon.

    APPEND i_salesdoc_in.



    PERFORM fill_data_to_change.
* - CHANGE SERVICE CONTRACT USING BAPI FOR THE EXISTING SINGLE CONTRACT
    PERFORM bapi_change_contracts.


* - CHECK IF NO ENTRY EXIST THEN CREATE SERVICE CONTRACTS
  ELSEIF g_count < 1.

    PERFORM fill_data_to_create.
* - CALLING CREATE SERVICE CONTRACTS.
    PERFORM bapi_create_contracts.

* IF MULTIPLE ENTRIES FOUND THEN DO NOT PROCESS
  ELSEIF g_count > 1.

    WRITE : / text-024.

  ENDIF.

ENDFORM.                    "SALES_CONTRACT_DOC

*&---------------------------------------------------------------------*
*&      FORM  BAPI_CREATE_CONTRACTS
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM bapi_create_contracts .

  DATA : c_10 LIKE vbap-posnr.
*  C_10 = C_ITM.

* - LINK THE HEADER & ITEM INTERNAL TABLE WITH THE REFERENCE LINK
* - TO PROCESS THE REQUIRED DATA

  LOOP AT i_detail WHERE
        reclink_c EQ i_header-reclink_c.

    REFRESH i_contract_items1.

* begin of deletion MOD-004
*    ON CHANGE OF i_detail-mssprd.
* end of deletion MOD-004
* begin of insertion MOD-004
    ON CHANGE OF i_detail-equnr.
* end of insertion MOD-004

      c_10 = c_10 + c_itm.

      MOVE c_10               TO   wa_contractitems-itm_number.
      MOVE c_u                TO   wa_contractitemsx-updateflag.
      MOVE i_detail-mssprd    TO   wa_contractitems-material.
      MOVE c_x                TO   wa_contractitemsx-material.
      MOVE c_qnt              TO   wa_contractitems-target_qty.
      MOVE c_x                TO   wa_contractitemsx-target_qty.
      MOVE c_10               TO   wa_conditionx-itm_number.
      MOVE c_10               TO   wa_condition-itm_number.
      MOVE c_u                TO   wa_conditionx-updateflag.
* begin of deletion MOD-002
*      MOVE c_cnd              TO   wa_condition-cond_type.
* end of deletion MOD-002
      MOVE i_detail-msppyr    TO   wa_condition-cond_value.
      MOVE c_x                TO   wa_conditionx-cond_value.
      MOVE c_curr             TO   wa_condition-currency.
      MOVE c_curr             TO   wa_contractitems-currency.
*    MOVE C_10               TO   WA_CONTRACTTEXT-ITM_NUMBER.
*    MOVE  C_SPRAS           TO   WA_CONTRACTTEXT-LANGU_ISO.
*    MOVE  C_TDID            TO   WA_CONTRACTTEXT-TEXT_ID.
*    MOVE I_DETAIL-TEXT      TO   WA_CONTRACTTEXT-TEXT_LINE.
*    MOVE C_FFPRF            TO   WA_CONTRACTITEMS-DLI_PROFIL.
*    MOVE 'X'                TO   WA_CONTRACTITEMSX-DLI_PROFIL.
*      MOVE i_detail-msmpno    TO   wa_contractitems-mat_entrd.
*      MOVE c_x                TO   wa_contractitemsx-mat_entrd.
      MOVE i_detail-mssprd    TO   i_detail_equip-mssprd.
      MOVE i_detail-msmpno    TO   i_detail_equip-msmpno.
      MOVE i_detail-msmsno    TO   i_detail_equip-msmsno.
      MOVE i_detail-equnr     TO   i_detail_equip-equnr.



      APPEND wa_contractitems  TO i_contract_items.
      APPEND wa_contractitemsx TO i_contract_itemsx.
      APPEND wa_condition      TO i_condition.
      APPEND wa_conditionx     TO i_conditionx.
      APPEND i_detail_equip.
*    APPEND WA_CONTRACTTEXT   TO I_CONTRACT_TEXT.
    ENDON.
    CLEAR wa_contractitems.
    CLEAR wa_contractitemsx.
    CLEAR wa_condition.
    CLEAR wa_conditionx.
    CLEAR i_detail_equip.
*    CLEAR WA_CONTRACTTEXT.
*
*    C_10 = C_10 + 10.

  ENDLOOP.

  i_contract_items1[] = i_contract_items[].
  REFRESH i_contract_items.

* - CALL THE BAPI FM TO CREATE SERVICE CONTRACTS
  PERFORM bapi_create_function.

ENDFORM.                    " BAPI_CREATE_CONTRACTS
*&---------------------------------------------------------------------*
*&      FORM  BAPI_CREATE_FUNCTION
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM bapi_create_function .

* - FOR MULTIPLE CONTRACT HEADER PASSED TO BAPI

  LOOP AT i_contractheader WHERE version EQ i_header-ccscon.
    CALL FUNCTION 'BAPI_CONTRACT_CREATEFROMDATA'
      EXPORTING
*     SALESDOCUMENTIN               =
*begin of insertion MOD-002
        SALESDOCUMENTIN               =   i_header-vbeln
* end of insertion MOD-002
        contract_header_in            =   i_contractheader
        contract_header_inx           =   i_contractheaderx
*     SENDER                        =
*     BINARY_RELATIONSHIPTYPE       = ' '
*     INT_NUMBER_ASSIGNMENT         = ' '
*     BEHAVE_WHEN_ERROR             = ' '
*     LOGIC_SWITCH                  =
*     TESTRUN                       =
*     CONVERT                       = ' '
*   IMPORTING
*     SALESDOCUMENT                 =
      TABLES
       return                         =   i_bapiret2
       contract_items_in              =   i_contract_items1[]
       contract_items_inx             =   i_contract_itemsx[]
       contract_partners              =   i_partner[]
       contract_conditions_in         =   i_condition[]
       contract_conditions_inx        =   i_conditionx[]
*     CONTRACT_CFGS_REF             =
*     CONTRACT_CFGS_INST            =
*     CONTRACT_CFGS_PART_OF         =
*     CONTRACT_CFGS_VALUE           =
*     CONTRACT_CFGS_BLOB            =
*     CONTRACT_CFGS_VK              =
*     CONTRACT_CFGS_REFINST         =
       contract_data_in               =   i_contract[]
       contract_data_inx              =   i_contractx[]
       contract_text                  =   i_contract_text[].
*     CONTRACT_KEYS                 =
*     EXTENSIONIN                   =
*     PARTNERADDRESSES              =
    .

    IF sy-subrc EQ 0.

* - COMMIT THE BAPI WHICH WILL FINALLY CREATE SERVICE CONTRACTS
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'.

    ENDIF.


* - DISPLAY ERROR LOG
    IF NOT i_bapiret2[] IS INITIAL.
*    CLEAR: I_BAPIRET2.
* - LOGS BAPI ERROR TO SPOOL
      PERFORM f_display_bapi_errors_spool.

    ENDIF.

*BEGIN OF CHANGES BY MIRA_RECENT
    REFRESH: i_contract, i_contractx, i_contract_text,
 i_contract_items1,
             i_contract_itemsx, i_partner, i_condition, i_conditionx.

    CLEAR: i_contract, i_contractx, i_contract_text, i_contract_items1,
           i_contract_itemsx, i_partner, i_condition, i_conditionx.


* - EXIT COME OUT OF THE LOOP AND GO TO THE NEXT STEP
    EXIT.

  ENDLOOP.

ENDFORM.                    " BAPI_CREATE_FUNCTION
*&---------------------------------------------------------------------*
*&      FORM  F_DISPLAY_BAPI_ERRORS_SPOOL
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM f_display_bapi_errors_spool .

  DATA: l_repid LIKE sy-repid.

  l_repid = sy-repid.
* - DETERMINE THE PRINTER CONFIGURATION FOR THE CURRENT USER
  SELECT SINGLE spld
    FROM usr01
    INTO g_destination
    WHERE bname EQ sy-uname.

  IF sy-subrc NE 0.
    CLEAR g_destination.
* - WRITE MESSAGE IF NO PRINTER SETTING DEFINED FOR THE USER
    WRITE : / text-025.
  ENDIF.

* - PASS THE ERROR LOG TO THE SPOOL
  CALL FUNCTION 'GET_PRINT_PARAMETERS'
    EXPORTING
      destination    = g_destination
      line_size      = c_size
      list_name      = c_list_name
      list_text      = c_list_text
      release        = c_x
      new_list_id    = c_x
      no_dialog      = c_x
      report         = l_repid
      user           = sy-uname
    IMPORTING
      out_parameters = wa_params
      valid          = g_valid.


  IF g_valid NE space.
* - WRITE ERROR LIST
    PERFORM write_errorlist_to_spool.
  ENDIF.

ENDFORM.                    " F_DISPLAY_BAPI_ERRORS_SPOOL

*&---------------------------------------------------------------------*
*&      FORM  FILL_DATA_TO_CREATE
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM fill_data_to_create .

*  MOVE  c_u                TO   wa_contractheaderx-updateflag.
  MOVE  c_vkorg            TO   wa_contractheader-sales_org.
  MOVE  c_vtweg            TO   wa_contractheader-distr_chan.
  MOVE  c_spart            TO   wa_contractheader-division.
  MOVE i_header-vkgrp      TO   wa_contractheader-sales_grp.
  MOVE  c_x                TO   wa_contractheaderx-sales_grp.
  MOVE i_header-vkbur      TO   wa_contractheader-sales_off.
  MOVE  c_x                TO   wa_contractheaderx-sales_off.
  MOVE i_header-cccntp     TO   wa_contractheader-doc_type.
  MOVE  c_x                TO   wa_contractheaderx-doc_type.
  MOVE i_header-cccust     TO   wa_contractheader-name.
  MOVE  c_x                TO   wa_contractheaderx-name.
  MOVE i_header-ccoref     TO   wa_contractheader-purch_no_c.
  MOVE  c_x                TO   wa_contractheaderx-purch_no_c.

  MOVE  c_u                TO   wa_contractx-updateflag.
  MOVE i_header-ccsdat     TO   wa_contract-con_st_dat.
  MOVE  c_x                TO   wa_contractx-con_st_dat.
  MOVE i_header-ccedat     TO   wa_contract-con_en_dat.
  MOVE  c_x                TO   wa_contractx-con_en_dat.
  MOVE i_header-ccscon     TO   wa_contractheader-version.
  MOVE  c_x                TO   wa_contractheaderx-version.
  MOVE i_header-ccdurnd    TO   wa_contract-accept_dat.
  MOVE  c_x                TO   wa_contractx-accept_dat.
  MOVE i_header-ccsdat1    TO   wa_contract-con_si_dat.
  MOVE  c_x                TO   wa_contractx-con_si_dat.
* begin of deletion MOD-002
*  MOVE c_vakt              TO   wa_contract-con_en_act.
* end of deletion MOD-002
* begin of insertion MOD-002
  MOVE I_header-vakt       TO   wa_contract-con_en_act.
* end of insertion MOD-002
  MOVE  c_x                TO   wa_contractx-con_en_act.
* begin of deletion MOD-002
* MOVE c_rule              TO   wa_contract-act_datrul.
* MOVE  c_x                TO   wa_contractx-act_datrul.
* end of deletion MOD-002
  MOVE i_header-ccperiocat TO   wa_contract-val_per_ca.
  MOVE  c_x                TO   wa_contractx-val_per_ca.
  MOVE i_header-ccdurn     TO   wa_contract-val_per.
  MOVE  c_x                TO   wa_contractx-val_per.
  MOVE c_year              TO   wa_contract-val_per_un.
  MOVE  c_x                TO   wa_contractx-val_per_un.
*  MOVE I_HEADER-CCNIWK     TO   WA_CONTRACTHEADER-BILL_DATE.
*  MOVE  C_X                TO   WA_CONTRACTHEADERX-BILL_DATE.
* begin of deletion MOD-003
*  MOVE i_header-ccedatc    TO   wa_contract-con_en_dat.
*  MOVE  c_x                TO   wa_contractx-con_en_dat.
* end of deletion MOD-003
  MOVE  c_can              TO   wa_contract-canc_proc.
  MOVE  c_x                TO   wa_contractx-canc_proc.
*  MOVE  C_SPRAS            TO   WA_CONTRACTTEXT-LANGU_ISO.
*  MOVE  C_TDID             TO   WA_CONTRACTTEXT-TEXT_ID.
*  MOVE I_HEADER-TEXT       TO   WA_CONTRACTTEXT-TEXT_LINE.
* begin of deletion MOD-002
*  IF i_header-cccsts EQ c_x.
*    MOVE  c_fix           TO   wa_contractheader-cstcndgrp1.
*  ELSE.
*    MOVE  c_fix1          TO   wa_contractheader-cstcndgrp1.
*  ENDIF.
* end of deletion MOD-002
* begin of insertion MOD-002
  move i_header-kdkg1      to   wa_contractheader-cstcndgrp1.
  MOVE c_rule              TO   wa_contract-ACT_DATRUL.
  move c_x                 TO   wa_contractx-ACT_DATRUL.
  MOVE i_header-vasda      TO   wa_contract-ACTION_DAT.
  move c_x                 TO   wa_contractx-ACTION_DAT.
* end of insertion MOD-002
  APPEND wa_contractheader   TO i_contractheader.
  APPEND wa_contract         TO i_contract.
  APPEND wa_contractheaderx  TO i_contractheaderx.
  APPEND wa_contractx        TO i_contractx.
*  APPEND WA_CONTRACTTEXT     TO I_CONTRACT_TEXT.

  CLEAR wa_contractheader.
  CLEAR wa_contract.
  CLEAR wa_contractheaderx.
  CLEAR wa_contractx.
*  CLEAR WA_CONTRACTTEXT.

*  CLEAR I_CONTRACTHEADER.
*  CLEAR I_CONTRACT.
*  CLEAR I_CONTRACTHEADERX.
*  CLEAR I_CONTRACTX.
*  CLEAR I_CONTRACT_TEXT.


* PASS THE PARTNER DETAILS TO THE PARTNER INTERNAL TABLE WHICH IS MUST
* TO PASS TO THE BAPI FM
  i_partner-partn_role = c_partn1.
  MOVE i_header-cccust TO i_partner-partn_numb.

  APPEND i_partner.
  CLEAR  i_partner.

  i_partner-partn_role = c_partn2.
  MOVE i_header-cccust TO i_partner-partn_numb.

  APPEND i_partner.
  CLEAR  i_partner.

ENDFORM.                    " FILL_DATA_TO_CREATE
*&---------------------------------------------------------------------*
*&      FORM  FILL_DATA_TO_CHANGE
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM fill_data_to_change.

  MOVE  C_U                    TO  WA_CONTRACTHEADERu-UPDATEFLAG.
  MOVE i_salesdoc_in-vbeln     TO  wa_contractheaderc-collect_no.
*  MOVE  c_x                    TO  wa_contractheaderu-collect_no.
  MOVE  c_vkorg                TO  wa_contractheaderc-sales_org.
*  MOVE  c_x                    TO  wa_contractheaderu-sales_org.
  MOVE  c_vtweg                TO  wa_contractheaderc-distr_chan.
*  MOVE  c_x                    TO  wa_contractheaderu-distr_chan.
  MOVE  c_spart                TO  wa_contractheaderc-division.
*  MOVE  c_x                    TO  wa_contractheaderu-division.
  MOVE i_header-vkgrp          TO  wa_contractheaderc-sales_grp.
  MOVE  c_x                    TO  wa_contractheaderu-sales_grp.
  MOVE i_header-vkbur          TO  wa_contractheaderc-sales_off.
  MOVE  c_x                    TO  wa_contractheaderu-sales_off.
  MOVE i_header-cccust         TO  wa_contractheaderc-name.
  MOVE  c_x                    TO  wa_contractheaderu-name.
  MOVE i_header-ccoref         TO  wa_contractheaderc-purch_no_c.
  MOVE  c_x                    TO  wa_contractheaderu-purch_no_c.
  MOVE  c_u                    TO  wa_contractu-updateflag.
  MOVE i_header-ccsdat         TO  wa_contract-con_st_dat.
  MOVE  c_x                    TO  wa_contractu-con_st_dat.
  MOVE i_header-ccedat         TO  wa_contract-con_en_dat.
  MOVE  c_x                    TO  wa_contractu-con_en_dat.
  MOVE i_salesdoc_in-vsnmr_v   TO  wa_contractheaderc-version.
*  MOVE  C_X                    TO  WA_CONTRACTHEADERU-VERSION.
  MOVE i_header-ccdurnd        TO  wa_contract-accept_dat.
  MOVE  c_x                    TO  wa_contractu-accept_dat.
  MOVE i_header-ccsdat1        TO  wa_contract-con_si_dat.
  MOVE  c_x                    TO  wa_contractu-con_si_dat.
  MOVE i_header-ccperiocat     TO  wa_contract-val_per_ca.
  MOVE  c_x                    TO  wa_contractu-val_per_ca.
  MOVE i_header-ccdurn         TO  wa_contract-val_per.
  MOVE  c_x                    TO  wa_contractu-val_per.
  MOVE c_year                  TO  wa_contract-val_per_un.
*  MOVE  c_x                    TO  wa_contractu-val_per_un.
  MOVE i_header-ccedatc        TO  wa_contract-con_en_dat.
  MOVE  C_X                    TO  WA_CONTRACTU-CON_EN_DAT.
  MOVE  c_can                  TO  wa_contract-canc_proc.
*  MOVE  c_x                    TO  wa_contractu-canc_proc.
*  MOVE  C_SPRAS                TO  WA_CONTRACTTEXT-LANGU_ISO.
*  MOVE  C_TDID                 TO  WA_CONTRACTTEXT-TEXT_ID.
*  MOVE I_HEADER-TEXT           TO  WA_CONTRACTTEXT-TEXT_LINE.
* begin of deletion MOD-002
*  IF i_header-cccsts EQ c_x.
*    MOVE  c_fix           TO   wa_contractheaderc-cstcndgrp1.
*  ELSE.
*    MOVE  c_fix1          TO   wa_contractheaderc-cstcndgrp1.
*  ENDIF.
* end of deletion MOD-002
* begin of insertion MOD-002
  move i_header-kdkg1      to   wa_contractheaderc-cstcndgrp1.
  MOVE c_rule              TO   wa_contract-ACT_DATRUL.
  MOVE  c_x                TO   wa_contractu-ACT_DATRUL.
  MOVE i_header-vasda      TO   wa_contract-ACTION_DAT.
  MOVE  c_x                TO   wa_contractu-ACTION_DAT.
* end of insertion MOD-002


  APPEND wa_contractheaderc  TO i_contractheaderc.
  APPEND wa_contract        TO i_contract.
  APPEND wa_contractheaderu TO i_contractheaderu.
  APPEND wa_contractu       TO i_contractu.
*  APPEND WA_CONTRACTTEXT    TO I_CONTRACT_TEXT.


  CLEAR wa_contractheaderc.
  CLEAR wa_contract.
  CLEAR wa_contractheaderu.
  CLEAR wa_contractu.
  CLEAR wa_contracttext.


* - PASS THE PARTNER DETAILS TO THE PARTNER INTERNAL TABLE WHICH IS
* - MUST TO PASS TO THE BAPI FM
  i_partner-partn_role = c_partn1.
  MOVE i_header-cccust TO i_partner-partn_numb.
  MOVE c_u             TO i_partnerc-updateflag.

  APPEND i_partner.
  APPEND i_partnerc.
  CLEAR  i_partner.
  CLEAR  i_partnerc.

  i_partner-partn_role = c_partn2.
  MOVE i_header-cccust TO i_partner-partn_numb.
  MOVE c_u             TO i_partnerc-updateflag.

  APPEND i_partner.
  APPEND i_partnerc.
  CLEAR  i_partner.
  CLEAR  i_partnerc.

ENDFORM.                    " FILL_DATA_TO_CHANGE
*&---------------------------------------------------------------------*
*&      FORM  BAPI_CHANGE_CONTRACTS
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM bapi_change_contracts .

  DATA : c_10 LIKE vbap-posnr.
*  C_10 = C_ITM.

* - LINK THE HEADER & ITEM INTERNAL TABLE WITH THE REFERENCE LINK
* - TO PROCESS THE REQUIRED DATA

  LOOP AT i_detail WHERE
        reclink_c EQ i_header-reclink_c.

    REFRESH i_contract_items1.

* begin of deletion MOD-004
*    ON CHANGE OF i_detail-mssprd.
* end of deletion MOD-004
* begin of insertion MOD-004
    ON CHANGE OF i_detail-equnr.
* end of insertion MOD-004

      c_10 = c_10 + c_itm.

      MOVE c_10               TO   wa_contractitems-itm_number.
      MOVE c_10               TO   wa_contractitemsx-itm_number.
      MOVE c_u                TO   wa_contractitemsx-updateflag.
      MOVE i_detail-mssprd    TO   wa_contractitems-material.
      MOVE C_X                TO   WA_CONTRACTITEMSX-MATERIAL.
      MOVE c_qnt              TO   wa_contractitems-target_qty.
*      MOVE c_x                TO   wa_contractitemsx-target_qty.
      MOVE c_10               TO   wa_conditionx-itm_number.
      MOVE c_10               TO   wa_condition-itm_number.
      MOVE  c_u               TO   wa_conditionx-updateflag.
      MOVE c_cnd              TO   wa_condition-cond_type.
      MOVE i_detail-msppyr    TO   wa_condition-cond_value.
      MOVE c_x                TO   wa_conditionx-cond_value.
      MOVE c_curr             TO   wa_condition-currency.
      MOVE c_curr             TO   wa_contractitems-currency.
*    MOVE C_10               TO   WA_CONTRACTTEXT-ITM_NUMBER.
*    MOVE  C_SPRAS           TO   WA_CONTRACTTEXT-LANGU_ISO.
*    MOVE  C_TDID            TO   WA_CONTRACTTEXT-TEXT_ID.
*    MOVE I_DETAIL-TEXT      TO   WA_CONTRACTTEXT-TEXT_LINE.
*    MOVE C_FFPRF            TO   WA_CONTRACTITEMS-DLI_PROFIL.
*    MOVE 'X'                TO   WA_CONTRACTITEMSX-DLI_PROFIL.
*      MOVE i_detail-msmpno    TO   wa_contractitems-mat_entrd.
*      MOVE c_x                TO   wa_contractitemsx-mat_entrd.
      MOVE i_detail-mssprd    TO   i_detail_equip-mssprd.
      MOVE i_detail-msmpno    TO   i_detail_equip-msmpno.
      MOVE i_detail-msmsno    TO   i_detail_equip-msmsno.
      MOVE i_detail-equnr     TO   i_detail_equip-equnr.


      APPEND wa_contractitems  TO i_contract_items.
      APPEND wa_contractitemsx TO i_contract_itemsx.
      APPEND wa_condition      TO i_condition.
      APPEND wa_conditionx     TO i_conditionx.
      APPEND i_detail_equip.
    ENDON.
    CLEAR wa_contractitems.
    CLEAR wa_contractitemsx.
    CLEAR wa_condition.
    CLEAR wa_conditionx.
*    CLEAR WA_CONTRACTTEXT.
*
*    C_10 = C_10 + 10.

  ENDLOOP.

  i_contract_items1[] = i_contract_items[].
  REFRESH i_contract_items.

* - CHANGE BAPI FOR THE EXISTING SINGLE CONTRACT
  PERFORM bapi_change_function.


ENDFORM.                    " BAPI_CHANGE_CONTRACTS

*&---------------------------------------------------------------------*
*&      FORM  BAPI_CHANGE_FUNCTION
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM bapi_change_function .

* - FOR MULTIPLE CONTRACT HEADER PASSED TO BAPI
  LOOP AT i_contractheaderc WHERE version EQ i_header-ccscon.


    CALL FUNCTION 'BAPI_CUSTOMERCONTRACT_CHANGE'
     EXPORTING
        salesdocument               =   i_salesdoc_in-vbeln
        contract_header_in          =   i_contractheaderc
        contract_header_inx         =   i_contractheaderu
*        SIMULATION             =  C_X
*        BEHAVE_WHEN_ERROR      =
*   INT_NUMBER_ASSIGNMENT       = ' '
*   LOGIC_SWITCH                =
      TABLES
        return                      =   i_bapiret
     contract_item_in               =   i_contract_items1[]
     contract_item_inx              =   i_contract_itemsx[]
     partners                       =   i_partner[]
    partnerchanges                  =   i_partnerc[]
*   PARTNERADDRESSES            =
      conditions_in                 =   i_condition[]
      conditions_inx                =   i_conditionx[]
*   CONTRACT_CFGS_REF           =
*   CONTRACT_CFGS_INST          =
*   CONTRACT_CFGS_PART_OF       =
*   CONTRACT_CFGS_VALUE         =
*   CONTRACT_CFGS_BLOB          =
*   CONTRACT_CFGS_VK            =
*   CONTRACT_CFGS_REFINST       =
     contract_text                  =   i_contract_text[]
     contract_data_in               =   i_contract[]
     contract_data_inx              =   i_contractu[].
*   CONTRACT_KEYS               =
*   EXTENSIONIN                 =


    IF sy-subrc EQ 0.                                       "#EC *

* - COMMIT THE BAPI WHICH WILL FINALLY CHANGE SERVICE CONTRACTS
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'.

    ENDIF.

* - DISPLAY ERROR LOG
    IF NOT i_bapiret[] IS INITIAL.
*    CLEAR: I_BAPIRET.

* - LOGS BAPI ERROR TO SPOOL
      PERFORM f_display_bapi_errors_spool1.

    ENDIF.


    REFRESH: i_contract, i_contractx, i_contract_text,
             i_contract_items1,
             i_contract_itemsx, i_partner, i_condition.

    CLEAR: i_contract, i_contractx, i_contract_text, i_contract_items1,
           i_contract_itemsx, i_partner, i_condition.

* - EXIT COME OUT OF THE LOOP AND GO TO THE NEXT STEP
    EXIT.

  ENDLOOP.

ENDFORM.                    " BAPI_CHANGE_FUNCTION

*&---------------------------------------------------------------------*
*&      FORM  F_DISPLAY_BAPI_ERRORS_SPOOL1
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM f_display_bapi_errors_spool1 .

  DATA: l_repid LIKE sy-repid.

  l_repid = sy-repid.
* - DETERMINE THE PRINTER CONFIGURATION FOR THE CURRENT USER
  SELECT SINGLE spld
    FROM usr01
    INTO g_destination
    WHERE bname EQ sy-uname.

  IF sy-subrc NE 0.
    CLEAR g_destination.
* - WRITE MESSAGE IF NO PRINTER SETTING DEFINED FOR THE USER
    WRITE : / text-025.
  ENDIF.

* - PASS THE ERROR LOG TO THE SPOOL
  CALL FUNCTION 'GET_PRINT_PARAMETERS'
    EXPORTING
      destination    = g_destination
      line_size      = c_size
      list_name      = c_list_name1
      list_text      = c_list_text1
      release        = c_x
      new_list_id    = c_x
      no_dialog      = c_x
      report         = l_repid
      user           = sy-uname
    IMPORTING
      out_parameters = wa_params
      valid          = g_valid.


  IF g_valid NE space.
* - WRITE ERROR LIST
    PERFORM write_errorlist_to_spool.
  ENDIF.

ENDFORM.                    " F_DISPLAY_BAPI_ERRORS_SPOOL1
*&---------------------------------------------------------------------*
*&      FORM  WRITE_ERRORLIST_TO_SPOOL
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM write_errorlist_to_spool .

  NEW-PAGE PRINT ON PARAMETERS wa_params NO DIALOG.

* WRITE HEADER
  WRITE:  /001 sy-uline(255),
         /001 text-009,
         /001 text-010,
          006 text-011,
          028 text-012,
          035 text-013,
          074 text-014,
          096 text-015,
          104 text-016,
          121 text-017,
          138 text-018,
          155 text-019,
          172 text-020,
          206 text-021,
          218 text-022,
          250 text-023,
         /001 sy-uline.

* WRITE ROW
  CLEAR i_bapiret.

* WRITE ALL THE BAPI ERRORS
  LOOP AT i_bapiret WHERE type = c_error.
    WRITE: /001 i_bapiret-type,
            006 i_bapiret-id,
            028 i_bapiret-number,
            035 i_bapiret-message,
            074 i_bapiret-log_no,
            096 i_bapiret-log_msg_no,
            104 i_bapiret-message_v1,
            121 i_bapiret-message_v2,
            138 i_bapiret-message_v3,
            155 i_bapiret-message_v4,
            172 i_bapiret-parameter,
            206 i_bapiret-row,
            218 i_bapiret-field,
            250 i_bapiret-system.
  ENDLOOP.
  WRITE: /001 sy-uline.
  NEW-PAGE PRINT OFF.


ENDFORM.                    " WRITE_ERRORLIST_TO_SPOOL

*&---------------------------------------------------------------------*
*&      FORM  OUTPUT_REPORT
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM output_report .

  IF NOT i_bapiret2[] IS INITIAL.
*  WRITE ALL THE BAPI ERRORS
    FORMAT COLOR 1 ON.
    WRITE: /001 sy-uline(255),
           /001 sy-vline,text-008,
            255 sy-vline,
           /001 sy-uline(255).


    FORMAT COLOR 4 ON.
    WRITE: /001 sy-vline, text-010,
            015 sy-vline, text-011,
            030 sy-vline, text-012,
            046 sy-vline, text-013,
            100 sy-vline, text-016,
            120 sy-vline, text-017,
            140 sy-vline, text-018,
            160 sy-vline, text-019,
            180 sy-vline, text-020,
            200 sy-vline, text-023,
            255 sy-vline,
           /001 sy-uline(255).
    .
* WRITE THE BAPI ERROR TO THE OUTPUT LIST
    LOOP AT i_bapiret2 WHERE type = c_error.

      FORMAT INTENSIFIED OFF.
      WRITE:    /001 sy-vline, i_bapiret2-type,
                 015 sy-vline, i_bapiret2-id,
                 030 sy-vline, i_bapiret2-number,
                 046 sy-vline, i_bapiret2-message,
                 100 sy-vline, i_bapiret2-message_v1,
                 120 sy-vline, i_bapiret2-message_v2,
                 140 sy-vline, i_bapiret2-message_v3,
                 160 sy-vline, i_bapiret2-message_v4,
                 180 sy-vline, i_bapiret2-parameter,
                 200 sy-vline, i_bapiret2-system,
                 255 sy-vline.

    ENDLOOP.
    WRITE: /001 sy-uline(255).
  ENDIF.


  IF NOT i_bapiret[] IS INITIAL.
*  WRITE ALL THE BAPI ERRORS
    FORMAT COLOR 1 ON.
    WRITE: /001 sy-uline(255),
           /001 sy-vline,text-008,
            255 sy-vline,
           /001 sy-uline(255).


    FORMAT COLOR 4 ON.
    WRITE: /001 sy-vline, text-010,
            015 sy-vline, text-011,
            030 sy-vline, text-012,
            046 sy-vline, text-013,
            100 sy-vline, text-016,
            120 sy-vline, text-017,
            140 sy-vline, text-018,
            160 sy-vline, text-019,
            180 sy-vline, text-020,
            200 sy-vline, text-023,
            255 sy-vline,
           /001 sy-uline(255).
    .
* WRITE THE BAPI ERROR TO THE OUTPUT LIST
    LOOP AT i_bapiret WHERE type = c_error.

      FORMAT INTENSIFIED OFF.
      WRITE:    /001 sy-vline, i_bapiret-type,
                 015 sy-vline, i_bapiret-id,
                 030 sy-vline, i_bapiret-number,
                 046 sy-vline, i_bapiret-message,
                 100 sy-vline, i_bapiret-message_v1,
                 120 sy-vline, i_bapiret-message_v2,
                 140 sy-vline, i_bapiret-message_v3,
                 160 sy-vline, i_bapiret-message_v4,
                 180 sy-vline, i_bapiret-parameter,
                 200 sy-vline, i_bapiret-system,
                 255 sy-vline.

    ENDLOOP.
    WRITE: /001 sy-uline(255).
 ENDIF.

  IF NOT I_BAPIRET[] IS INITIAL.

    LOOP AT i_bapiret WHERE type = c_succ.
      WRITE : / text-006, i_salesdoc_in-vbeln.
    ENDLOOP.

  ENDIF.



ENDFORM.                    " OUTPUT_REPORT
*&---------------------------------------------------------------------*
*&      FORM  HEADER_TEXT
*&---------------------------------------------------------------------*
*       TEXT
*----------------------------------------------------------------------*
*  -->  P1        TEXT
*  <--  P2        TEXT
*----------------------------------------------------------------------*
FORM header_text .

  MOVE i_header-reclink_c        TO   wa_contract_text-reclink_c.
  MOVE  c_spras                  TO   wa_contract_text-langu_iso.
  MOVE  c_tdid                   TO   wa_contract_text-text_id.
  MOVE  c_form                   TO   wa_contract_text-format_col.
  MOVE i_header-text             TO   wa_contract_text-text_line.

  APPEND wa_contract_text    TO i_contract_text_all.
  CLEAR wa_contract_text.

ENDFORM.                    " HEADER_TEXT

*Text symbol text
*001:Service Contract data transfer by Direct Input
*002:INFORMATION MESSAGE FOR CONFIRMATION
*003:Are you sure you want to overwrite the existing Service Contract?
*004:YES
*005:NO
*006:Overwritten the Service Contract
*008:BAPI Error Log Report List
*009:BAPI Error Log
*010:Message Type
*011:Message Class
*012:Message Number
*013:Error Message
*014:Application Log Number
*015:Application Message Number
*016:Message variable1
*017:Message Variable2
*018:Message Variable3
*019:Message Variable4
*020:Parameter Name
*021:Line in Parameter
*022:Field in Parameter
*023:Logical system from which message originates

*024:Error !!! Multiple Service Contracts found for this entry
*Selection text
*P_FILE:D       File name
