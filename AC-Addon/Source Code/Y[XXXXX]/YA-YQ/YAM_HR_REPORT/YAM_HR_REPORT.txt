*----------------------------------------------------------------------
* PROGRAM ID           : YAM_HR_REPORT                                 *
* PROGRAM TITLE        : AM: HR Report                                 *
* AUTHOR               : Luc Mertens                                   *
* DATE                 : 03/04/2006                                    *
* DEVELOPMENT ID       : ALL-CR 235                                    *
* CHANGE REQUEST NUMBER: CD1K904896                                    *
* PROGRAM DESCRIPTION  : Create report that allows for easy extraction *
*                        of HR data from technicians.                  *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 |2006.07.03|L. Mertens       |CD1K906066|                    *
*          - add column so that one value can be added to 2 columns    *
*          - add userid of the person who created the confirmation     *
*          - add cost center linked to work center                     *
* MOD-002 |2006.07.17|L. Mertens       |CD1K906239|                    *
*          - add column so that one value can be added to 3 columns    *
*          - add access to new custom table YAM_HR_FORMULA             *
*          - add level of layout                                       *
* MOD-003 |2006.08.01|L. Mertens       |CD1K906372|                    *
*          - take the workcenter description in the logon language     *
* MOD-004 |2006.08.29|L. Mertens       |CD1K906546|                    *
*          - file - spreadsheet function                               *
* MOD-005 |2006.09.08|L. Mertens       |CD1K906688|                    *
*          - add columns for formulas (C026-C030)                      *
* MOD-006 |2007.05.10|L. Mertens       |CD1K914876|                    *
*          - extend with more columns (100-110)                        *
* MOD-007 |2007.05.29|L. Mertens       |CD1K915509| All-CR345          *
*          - differences SAP-Excel                                     *
* MOD-008 |2007.09.04|L. Mertens       |CD1K920067| SE-CR040           *
*          - add creation date                                         *
* MOD-009 |2007.12.03|L. Mertens       |CD1K921167| SEED:CR 8588       *
* MOD-010 |2008.01.29|L. Mertens       |CD1K925820|                    *
*          - add plant to output                                       *
* MOD-011 |2008.02.14|L. Mertens       |CD1K926421|                    *
*          - add plant to output from level 1                          *
* MOD-012 |2008.12.02|G. Rutten        |CD1K944913|                    *
*           add field Business Line for productive                     *
*           hours report for CN IT +                                   *
*           extend with more columns(111-126) - CR0023                 *
* MOD-013 |2010.02.09|Satyabrata Basu  |CD1K954514| T#7834             *
*          - add Sold-to-party number and name                         *
* MOD-014 |2010.05.04|Satyabrata Basu  |CD1K956482| T#9338             *
*          - add Confirmation Text                                     *
* MOD-015 |2011.10.26|Alan Wang        |CD1K968588| T#2136             *
*          - Column 020-030 should be visible in report                *
* MOD-016 |2013.01.31|Johnny Wu        |CD1K975009|                    *
*          -                                                           *
*----------------------------------------------------------------------*
REPORT YAM_HR_REPORT      no standard page heading
                          line-size 200.

*----------------------------------------------------------------------*
* type-pool ALV                                                        *
*----------------------------------------------------------------------*
TYPE-POOLS: SLIS.

*----------------------------------------------------------------------*
* DB tables                                                            *
*----------------------------------------------------------------------*
TABLES: afru,                          " Confirmation
        T370a,                         " activity type of a transaction
        rihafvr,                       " display structure
        crhd,                          " work centers
* begin insert MOD-013   - Satya
        afih,                          "Customer number
* end insert MOD-013    - Satya
* begin insert MOD-012
        ihpa,
        kna1,
        yse_prctr_class.
* end insert MOD-012

*----------------------------------------------------------------------*
* global data                                                          *
*----------------------------------------------------------------------*
* display structure
DATA: begin of object_tab occurs 0.
        include structure yam_conf_hr.
data:   selected,
        pm_selected type pm_selected.
data: end of object_tab.

* selected confirmations
data: begin of gt_conf occurs 0,
        rueck   like afru-rueck,
        rmzhl   like afru-rmzhl,
        arbid   like afru-arbid,
        aufnr   like afru-aufnr,
        learr   like afru-learr,
        grund   like afru-grund,
        ismnw   type ismnw_2,
        ismne   like afru-ismne,
        ismnu   like afru-ismnu,
        stzhl   like afru-stzhl,
        budat   like afru-budat,
        isdd    like afru-isdd,
        isdz    like afru-isdz,
        iedd    like afru-iedd,
        iedz    like afru-iedz,
* begin of insert MOD-001
        ernam   like afru-ernam,
* end of insert MOD-001
* begin of insert MOD-008
        ersda   like afru-ersda,
* end of insert MOD-008
* begin of insert MOD-009
        bemot   like afru-bemot,
* end of insert MOD-009
* begin of insert MOD-010
        werks   like afru-werks,
* end of insert MOD-010
* begin of insert MOD-012
        buslin   type CHAR4,
* end of insert MOD-012
* begin of insert MOD-013 - Satya
        kunum   type afih-kunum,                       "+Mod-013
        sname   type kna1-name1,                       "+Mod-013
* end of insert MOD-013  - Satya
* begin of insert MOD-014 - Satya
        ltxa1   type afru-ltxa1,                       "+Mod-014
* end of insert MOD-014  - Satya
      end of gt_conf.

* data per column
data: begin of gt_col occurs 0,
        arbid   like afru-arbid,
        aufnr   like afru-aufnr,
        rueck   like afru-rueck,
        rmzhl   like afru-rmzhl,
        budat   like afru-budat,
        isdd    like afru-isdd,
        isdz    like afru-isdz,
        iedd    like afru-iedd,
        iedz    like afru-iedz,
* begin of insert MOD-001
        ernam   like afru-ernam,
        kostl   type kostl,
* end of insert MOD-001
* begin of insert MOD-008
        ersda   like afru-ersda,
* end of insert MOD-008
* begin of insert MOD-009
        bemot   like afru-bemot,
* end of insert MOD-009
        colnr   like yam_actyp_group-zcolnr,
        ismnw   type ismnw_2,
* begin of insert MOD-010
        werks   like afru-werks,
* end of insert MOD-010
* begin of insert MOD-012
        buslin  type CHAR4,
* end of insert MOD-012
* begin of insert MOD-013 - Satya
        kunum   type afih-kunum,                       "+Mod-013
        sname   type kna1-name1,                       "+Mod-013
* end of insert MOD-013  - Satya
* begin of insert MOD-014 - Satya
        ltxa1   type afru-ltxa1,                       "+Mod-014
* end of insert MOD-014  - Satya
      end of gt_col.

* work center of the confirmation
DATA: BEGIN OF arbid_tab_c OCCURS 0,
        arbid LIKE crhd-objid,
        arbpl LIKE crhd-arbpl.
DATA: END OF arbid_tab_c.

DATA: gt_yam_actyp_group type standard table of yam_actyp_group
                              with header line,
      gt_yam_col_head    type standard table of yam_col_head
                              with header line,
* begin of insert MOD-002
      gt_yam_hr_formulas type standard table of yam_hr_formulas
                              with header line,
* end of insert MOD-002
      wa_conf like gt_conf,
      wa_conf1 like gt_conf,
      wa_col  like gt_col,
      wa_obj  like object_tab.

* not used, needed for includes miolxtop, miolxf14, mioxf16
DATA: sel_tab LIKE yam_conf_hr OCCURS 0 WITH HEADER LINE.

DATA: go_on           VALUE '1',                            " 0 or 1
      gt_crhd         LIKE crhd OCCURS 0,
      gt_crtx         like crtx occurs 0,
      gt_fieldcat     TYPE slis_t_fieldcat_alv,
* begin of insert MOD-002
      g_zlevel        type zzlev,
* end of insert MOD-002
      gs_crid         TYPE crid,
      gt_crid         TYPE crid_tab,
* begin insert MOD-012
      ih_objnr        TYPE IHPA-objnr,
      ih_bran1        TYPE KNA1-BRAN1,
      ih_parnr        TYPE IHPA-PARNR,
      ih_class        TYPE YSE_PRCTR_CLASS-CLASS.
* end insert MOD-012
*----------------------------------------------------------------------*
* constants                                                            *
*----------------------------------------------------------------------*
CONSTANTS: c_e        type spras    value 'E',
* begin of insert MOD-002
           c_1        type c        value '1',
* end of insert MOD-002
           c_a        type CR_OBJTY value 'A'.

*----------------------------------------------------------------------*
* ranges                                                               *
*----------------------------------------------------------------------*
RANGES: arbid_c FOR afru-arbid.        " id of work center (conf.)

*----------------------------------------------------------------------*
* field symbols                                                        *
*----------------------------------------------------------------------*



*- SELECTION SCREEN---------------------------------------------------
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
SELECTION-SCREEN BEGIN OF BLOCK B2.
SELECT-OPTIONS s_budat    FOR  afru-budat.
* begin of insert MOD-008
SELECT-OPTIONS s_ersda    FOR  afru-ersda.
* end of insert MOD-008
SELECT-OPTIONS s_isdd     FOR  afru-isdd.
SELECTION-SCREEN END OF BLOCK B2.
SELECT-OPTIONS s_arbpl    FOR  rihafvr-iarbpl.
SELECT-OPTIONS s_origf    for  afru-origf.
* begin of change MOD-009
*ARAMETERS:    p_werki    type ISTWERK obligatory memory id WRK,
SELECT-OPTIONS s_werki    for  rihafvr-werki obligatory.
PARAMETERS:    p_wlayo    type werKs_d obligatory memory id WRK,
* end of change MOD-009
               p_reptp    type zreptp obligatory.
SELECTION-SCREEN END OF BLOCK B1.

* list variant
SELECTION-SCREEN BEGIN OF BLOCK B3 WITH FRAME TITLE TEXT-002.
PARAMETERS: variant LIKE disvariant-variant.
SELECTION-SCREEN END OF BLOCK B3.

PARAMETERS:
  dy_selm DEFAULT '0' NO-DISPLAY,      " selection mode
  dy_tcode LIKE sy-tcode NO-DISPLAY,   " transaction
  p_ocall NO-DISPLAY.                  " 'X' => prog called from
" pm order

*----------------------------------------------------------------------*
* includes                                                             *
*----------------------------------------------------------------------*
INCLUDE miolxtop.
INCLUDE miolxf14.
INCLUDE miolxf16.

*----------------------------------------------------------------------*
* initialization                                                       *
*----------------------------------------------------------------------*
INITIALIZATION.

* get aktype (display or change mode)
  PERFORM get_acttype_afru_l.
* get variant for selection screen
  PERFORM variant_start_f16.
* initializes g_variant
  PERFORM variant_init_f14 USING '    ' '    ' '    '.
* fill variant with the default variant
  IF variant IS INITIAL.
    PERFORM get_default_variant_f14 USING variant.
  ENDIF.
* fill g_fieldcat_tab
  PERFORM create_fieldcat_f14 USING 'YAM_CONF_HR'.

*----------------------------------------------------------------------*
* F4 help for list variant                                             *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR variant.

  PERFORM variant_inputhelp_f14 USING variant.

*----------------------------------------------------------------------*
* at selection-screen on block B2                                      *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON BLOCK B2.

  if ( s_budat is initial and
* begin of insert MOD-008
       s_ersda is initial and
* end of insert MOD-008
       s_isdd  is initial ) or
     ( not s_budat is initial and
* begin of insert MOD-008
       not s_ersda is initial and
* end of insert MOD-008
       not s_isdd  is initial ).
    message E001(00) with text-e01.
  endif.

*----------------------------------------------------------------------*
* at selection-screen on plant                                         *
*----------------------------------------------------------------------*
* begin of change MOD-009
*AT SELECTION-SCREEN ON p_werki.

*  AUTHORITY-CHECK OBJECT 'I_IWERK'
*           ID 'TCD'   FIELD sy-tcode
*           ID 'IWERK' FIELD p_werki.

*  IF sy-subrc NE 0.
**.... No authorization for plant
*    MESSAGE E001(00) WITH text-e03 p_werki.
*  ENDIF.

AT SELECTION-SCREEN ON s_werki.

  loop at s_werki.
    AUTHORITY-CHECK OBJECT 'I_IWERK'
             ID 'TCD'   FIELD sy-tcode
             ID 'IWERK' FIELD s_werki-low.

    IF sy-subrc NE 0.
*.... No authorization for plant
      MESSAGE E001(00) WITH text-e03 s_werki.
    ENDIF.
  endloop.
* end of change MOD-009

*----------------------------------------------------------------------*
* at selection-screen                                                  *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.

* preselect activity type groups
  select * from yam_actyp_group into table gt_yam_actyp_group
* begin of change MOD-009
*    where werks = p_werki
     where werks = p_wlayo
* end of change MOD-009
       and zreptp = p_reptp.

  if sy-subrc <> 0.
    message E001(00) with text-e02.
  endif.

  REFRESH arbid_tab_c.
  REFRESH arbid_c.

*--- take always default variant
  IF variant IS INITIAL.
    PERFORM get_default_variant_f14 USING variant.
  ENDIF.
*--- Correct Listvariant chosen ? -------------------------------------*
  PERFORM variant_existence_f14 USING variant.


*-START OF SELECTION----------------------------------------------------
START-OF-SELECTION.

  sort gt_yam_actyp_group by werks learr grund.

* preselect column headings
  select * from yam_col_head into table gt_yam_col_head
* begin of change MOD-009
*    where werks = p_werki
     where werks = p_wlayo
* end of change MOD-009
       and zreptp = p_reptp.

* begin of insert MOD-002
* select level of reporting in custom table YAM_REPTP
  clear g_zlevel.
  select single zlevel into g_zlevel
     from yam_reptp
* begin of change MOD-009
*    where werks = p_werki
     where werks = p_wlayo
* end of change MOD-009
       and zreptp = p_reptp.

* preselect formulas
  select * from yam_hr_formulas into table gt_yam_hr_formulas
* begin of change MOD-009
*    where werks = p_werki
     where werks = p_wlayo
* end of change MOD-009
       and zreptp = p_reptp.
* end of insert MOD-002

  g_form_set_pf_stat = 'PF_STATUS_L'.

  PERFORM determine_g_tcode_f16.
  PERFORM get_acttype_afru_l.
  PERFORM prepare_display_list_f14.
  PERFORM update_fieldcat_variant_f14.
  PERFORM check_fieldcat_variant_l.

  PERFORM get_arbid TABLES arbid_tab_c s_arbpl arbid_c
* begin of change MOD-009
*                   USING p_werki.
                    s_werki.
* end of change MOD-009

* select confirmations
  PERFORM select_conf.

  IF NOT gt_conf[] IS INITIAL.
    gs_crid-objty = c_a.
    LOOP AT gt_conf into wa_conf.
      gs_crid-objid = wa_conf-arbid.
      COLLECT gs_crid INTO gt_crid.

*---- determine the correct column in which the value is to be put in
* begin of change MOD-009
*     read table gt_yam_actyp_group with key werks  = p_werki
      read table gt_yam_actyp_group with key werks  = p_wlayo
* end of change MOD-009
                                             zreptp = p_reptp
                                             learr  = wa_conf-learr
                                             grund  = wa_conf-grund
                                    binary search.

      if sy-subrc = 0.
        move gt_yam_actyp_group-zcolnr to gt_col-colnr.
        move-corresponding wa_conf to gt_col.

        IF NOT wa_conf-ismnu IS INITIAL AND
           wa_conf-ismne NE wa_conf-ismnu.
          CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
            EXPORTING
              input    = wa_conf-ismnw
              unit_in  = wa_conf-ismne
              unit_out = wa_conf-ismnu
            IMPORTING
              output   = gt_col-ismnw.
        ENDIF.

*------ if cancellation
        IF NOT wa_conf-stzhl IS INITIAL.
          gt_col-ismnw = ( -1 ) * gt_col-ismnw.
        ENDIF.

        collect gt_col.
* begin of insert MOD-001
        if not gt_yam_actyp_group-zcolnr2 is initial.
          move gt_yam_actyp_group-zcolnr2 to gt_col-colnr.
          collect gt_col.
        endif.
* end of insert MOD-001
* begin of insert MOD-002
        if not gt_yam_actyp_group-zcolnr3 is initial.
          move gt_yam_actyp_group-zcolnr3 to gt_col-colnr.
          collect gt_col.
        endif.
        if not gt_yam_actyp_group-zcolnr4 is initial.
          move gt_yam_actyp_group-zcolnr4 to gt_col-colnr.
          collect gt_col.
        endif.
        if not gt_yam_actyp_group-zcolnr5 is initial.
          move gt_yam_actyp_group-zcolnr5 to gt_col-colnr.
          collect gt_col.
        endif.
* end of insert MOD-002
        clear gt_col.
      endif.
    ENDLOOP.
    sort gt_col by arbid aufnr rueck rmzhl colnr.
  ENDIF.

* preselect work centers
  PERFORM preselect_crhd TABLES gt_crid.

* preselect work center descriptions
  PERFORM preselect_crtx TABLES gt_crid.

  REFRESH object_tab.

  loop at gt_col into wa_col.
    PERFORM fill_object_tab using wa_col.
  endloop.

* begin of insert MOD-002
  if gt_yam_hr_formulas[] is not initial.
    loop at object_tab.
      perform calculate_extra_columns.
    endloop.
  endif.
* end of insert MOD-002

  DESCRIBE TABLE object_tab LINES sy-tabix.
  IF sy-tabix = 0.
    go_on = '0'.
    MESSAGE s047(ih).
  ENDIF.

*-----------------------------------------------------------------------
END-OF-SELECTION.

* create ALV-GRID
  PERFORM build_field_catlog CHANGING gt_fieldcat.
  PERFORM alv_display.


*- SUBROUTINES---------------------------------------------------------
*&---------------------------------------------------------------------*
*&      Form  SELECT_CONF
*&---------------------------------------------------------------------*
*       select data from the db
*----------------------------------------------------------------------*
FORM select_conf.

* begin of insert MOD-013   - Satya
DATA: lv_kunum like afih-kunum,
      lv_name1 like kna1-name1.
* end of insert MOD-013   - Satya
* begin of insert MOD-014   - Satya
DATA: lv_ltxa1 like afru-ltxa1.                        "+Mod-014
* end of insert MOD-014   - Satya

  if s_origf is initial.
    SELECT arbid aufnr ismnw stzhl learr grund rueck rmzhl budat
           isdd isdz iedd iedz ismnu ismne
* begin of insert MOD-001
           ernam
* end of insert MOD-001
* begin of insert MOD-008
           ersda
* end of insert MOD-008
* begin of insert MOD-009
           bemot
* end of insert MOD-009
* begin of insert MOD-010
           werks
* end of insert MOD-010
* begin of insert MOD-013    - Satya
           ltxa1                                  "+Mod-014
* end of insert MOD-013    - Satya
      FROM afru INTO corresponding fields of TABLE gt_conf
      WHERE budat IN s_budat
* begin of insert MOD-008
      AND ersda IN s_ersda
* end of insert MOD-008
* begin of change MOD-009
*     AND werks EQ p_werki
      and werks in s_werki
* end of change MOD-009
      AND arbid IN arbid_c
      AND isdd IN s_isdd.
  else.
    SELECT arbid aufnr ismnw stzhl learr grund rueck rmzhl budat
           isdd isdz iedd iedz ismnu ismne
* begin of insert MOD-001
           ernam
* end of insert MOD-001
* begin of insert MOD-008
           ersda
* end of insert MOD-008
* begin of insert MOD-009
           bemot
* end of insert MOD-009
* begin of insert MOD-010
           werks
* end of insert MOD-010
      FROM afru INTO corresponding fields of TABLE gt_conf
      WHERE budat IN s_budat
* begin of insert MOD-008
      AND ersda IN s_ersda
* end of insert MOD-008
*     AND werks EQ p_werki
      and werks in s_werki
* end of change MOD-009
      AND arbid IN arbid_c
      AND origf IN s_origf
      AND isdd IN s_isdd.
  endif.

* begin of insert MOD-012
LOOP at gt_conf into wa_conf1.
clear ih_objnr.
 CONCATENATE 'OR' wa_conf1-aufnr INTO ih_objnr.
      select single parnr into ih_parnr from ihpa
            where parvw = 'AG' and objnr = ih_objnr.
      select single bran1 into ih_bran1 from kna1
            where kunnr = ih_parnr.
      select single class into ih_class from yse_prctr_class
            where spart = '01' and bran1 = ih_bran1.

      wa_conf1-buslin = ih_class.

* begin of insert MOD-013    - Satya
     clear lv_kunum.                                    "+Mod-013
     clear lv_name1.                                    "+Mod-013
     select single kunum into lv_kunum from afih        "+Mod-013
                         where aufnr = wa_conf1-aufnr.  "+Mod-013
   if sy-subrc = 0.                                     "+Mod-013
     select single name1 into lv_name1 from kna1        "+Mod-013
                         where kunnr = lv_kunum.        "+Mod-013
    if sy-subrc = 0.                                    "+Mod-013
     wa_conf1-kunum = lv_kunum.                         "+Mod-013
     wa_conf1-sname = lv_name1.                         "+Mod-013
    ENDIF.                                              "+Mod-013
   ENDIF.                                               "+Mod-013
* end of insert MOD-013    - Satya

      MODIFY gt_conf FROM wa_conf1.

ENDLOOP.

* end of insert MOD-012


ENDFORM.                               " SELECT_CONF

*&---------------------------------------------------------------------*
*&      Form  build_field_catlog
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FIELDCAT  text
*----------------------------------------------------------------------*
FORM build_field_catlog  CHANGING pt_fieldcat TYPE slis_t_fieldcat_alv.

  DATA : ls_fcat TYPE slis_fieldcat_alv,
         lv_idx(3)   type n,
         lv_fname(9) type c.

* begin of insert MOD-010
*--------------------------Plant-----------------------------*
  ls_fcat-fieldname = 'WERKS'.
  ls_fcat-rollname = 'WERKS_D'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* end of insert MOD-010
*--------------------------Work center-----------------------*
  ls_fcat-fieldname = 'IARBPL'.
  ls_fcat-rollname = 'ISTARBPL'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Work center description-----------*
  ls_fcat-fieldname = 'KTEXT'.
  ls_fcat-outputlen = '23'.
  ls_fcat-seltext_l = text-i01.
* begin of insert MOD-004
  ls_fcat-seltext_m = text-i02.
* end of insert MOD-004
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Order number----------------------*
  ls_fcat-fieldname = 'AUFNR'.
  ls_fcat-rollname = 'AUFNR'.
* begin of change MOD-007
  ls_fcat-no_convext = 'X'.
* end of change MOD-007
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* Begin of Insert MOD-013   - Satya
*--------------------------Customer Number-----------------------*
  ls_fcat-fieldname = 'KUNUM'.
  ls_fcat-rollname = 'KUNUM'.
  LS_FCAT-OUTPUTLEN = 12.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*----------------Customer (Sold to party) Name------------------*
  ls_fcat-fieldname = 'SNAME'.
  ls_fcat-rollname = 'WVMI_KUNNRT'.
  LS_FCAT-OUTPUTLEN = 35.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* End of Insert MOD-013   - Satya
*--------------------------Confirmation----------------------*
  ls_fcat-fieldname = 'RUECK'.
  ls_fcat-rollname = 'CO_RUECK'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Counter---------------------------*
  ls_fcat-fieldname = 'RMZHL'.
  ls_fcat-rollname = 'CO_RMZHL'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.

* Begin of Insert MOD-014   - Satya
*--------------------------Confirmation Text-----------------------*
  ls_fcat-fieldname = 'LTXA1'.                         "+Mod-014
  ls_fcat-rollname = 'CO_RTEXT'.                       "+Mod-014
  LS_FCAT-OUTPUTLEN = 40.                              "+Mod-014
  APPEND ls_fcat TO pt_fieldcat.                       "+Mod-014
  CLEAR ls_fcat.                                       "+Mod-014
* End of Insert MOD-014   - Satya

* Begin of Insert MOD-012
*--------------------------Business Line---------------------------*
  ls_fcat-fieldname = 'BUSLIN'.
  ls_fcat-rollname = 'CHAR4'.
  ls_fcat-seltext_l = text-i08.
  ls_fcat-seltext_m = text-i09.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* End of Insert MOD-012
*--------------------------Entered on------------------------*
  ls_fcat-fieldname = 'ERSDA'.
  ls_fcat-rollname = 'RU_ERSDA'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Posting date----------------------*
  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-rollname = 'BUCHDATUM'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Actual start date-----------------*
  ls_fcat-fieldname = 'ISDD'.
  ls_fcat-rollname = 'RU_ISDD'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Actual start time-----------------*
  ls_fcat-fieldname = 'ISDZ'.
  ls_fcat-rollname = 'RU_ISDZ'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Actual end date-------------------*
  ls_fcat-fieldname = 'IEDD'.
  ls_fcat-rollname = 'RU_IEDD'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Actual end time-------------------*
  ls_fcat-fieldname = 'IEDZ'.
  ls_fcat-rollname = 'RU_IEDZ'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* begin of insert MOD-001
*--------------------------Created by------------------------*
  ls_fcat-fieldname = 'ERNAM'.
  ls_fcat-rollname = 'ICRNA'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
*--------------------------Cost center-----------------------*
  ls_fcat-fieldname = 'KOSTL'.
  ls_fcat-rollname = 'KOSTL'.
* begin of change MOD-007
  ls_fcat-no_convext = 'X'.
* end of change MOD-007
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* end of insert MOD-001

* begin of insert MOD-009
*--------------------------Accounting indicator--------------*
  ls_fcat-fieldname = 'BEMOT'.
  ls_fcat-rollname = 'BEMOT'.
  APPEND ls_fcat TO pt_fieldcat.
  CLEAR ls_fcat.
* end of insert MOD-009

* begin of change MOD-002
* do 20 times.
* begin of change MOD-005
* do 25 times.
  do 30 times.
* end of change MOD-005
* end of change MOD-002
    lv_idx = sy-index.
    concatenate 'ISMNW_' lv_idx into lv_fname.
    ls_fcat-fieldname = lv_fname.
    ls_fcat-outputlen = '20'.

* begin of change MOD-009
*   read table gt_yam_col_head with key werks  = p_werki
    read table gt_yam_col_head with key werks  = p_wlayo
* end of change MOD-009
                                        zreptp = p_reptp
                                        zcolnr = lv_idx
                            binary search.

    if sy-subrc = 0.
      ls_fcat-seltext_l = gt_yam_col_head-zcolhd.
* begin of insert MOD-004
      ls_fcat-seltext_m = gt_yam_col_head-zcolhd.
* end of insert MOD-004
    else.
      ls_fcat-seltext_l = '??????????'.
* begin of insert MOD-004
      ls_fcat-seltext_m = '??????????'.
* end of insert MOD-004
    endif.

    APPEND ls_fcat TO pt_fieldcat.
    CLEAR ls_fcat.

  enddo.

* begin of delete MOD-002
*--------------------------Row total value------------------*
* ls_fcat-fieldname = 'ISMNW_TOT'.
* ls_fcat-outputlen = '15'.
* ls_fcat-seltext_l = 'Total Conf.'.
* APPEND ls_fcat TO pt_fieldcat.
* CLEAR ls_fcat.
* end of delete MOD-002

* begin of insert MOD-006
  lv_idx = 099.
* begin of delete MOD-012
*  do 11 times.
* end of delete MOD-012
* begin of insert MOD-012
*   do 63 times.
* end of insert MOD-012
"MOD-016 begin
  do 87 times.
"MOD-016 end
    lv_idx = lv_idx + 1.
    concatenate 'ISMNW_' lv_idx into lv_fname.
    ls_fcat-fieldname = lv_fname.
    ls_fcat-outputlen = '20'.

* begin of change MOD-009
*   read table gt_yam_col_head with key werks  = p_werki
    read table gt_yam_col_head with key werks  = p_wlayo
* end of change MOD-009
                                        zreptp = p_reptp
                                        zcolnr = lv_idx
                            binary search.

    if sy-subrc = 0.
      ls_fcat-seltext_l = gt_yam_col_head-zcolhd.
      ls_fcat-seltext_m = gt_yam_col_head-zcolhd.
    else.
      ls_fcat-seltext_l = '??????????'.
      ls_fcat-seltext_m = '??????????'.
    endif.

    APPEND ls_fcat TO pt_fieldcat.
    CLEAR ls_fcat.

  enddo.
* end of insert MOD-006

ENDFORM.                    " build_field_catlog

*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND_L
*&---------------------------------------------------------------------*
*       event user_command, called from ALV
*----------------------------------------------------------------------*
FORM user_command_l USING p_ucomm LIKE sy-ucomm
                          p_selfield TYPE slis_selfield.

  p_selfield-refresh = g_s.

  PERFORM check_pf2_with_object_f16 USING p_ucomm.
  PERFORM set_p_selfield_general_f16 USING p_selfield.

* begin of insert MOD-002
  if g_zlevel = '1'.
    clear p_ucomm.
  endif.
* end of insert MOD-002

  CASE p_ucomm.
*   show order
    WHEN 'AUFK'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
*   show confirmation
    WHEN 'RMEL'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
*   show detail
    WHEN 'IOBJ'.
      p_ucomm = 'RMEL'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
* begin of insert MOD-004
*   Spreadsheet
    WHEN 'XXL '.
      p_selfield-refresh = space.
      PERFORM xxl_call_f16.
* end of insert MOD-004
  ENDCASE.

*--- If list is empty now - leave ALV
  IF object_tab[] IS INITIAL AND g_variant_save NE g_x.
    p_selfield-exit = g_x.
    MESSAGE s047(ih).
  ENDIF.

ENDFORM.                               " USER_COMMAND_L

*&---------------------------------------------------------------------*
*&      Form  PF_STATUS_L
*&---------------------------------------------------------------------*
*       set pf-status, called from ALV
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
FORM pf_status_l USING extab TYPE slis_t_extab.

  APPEND 'V-A' TO extab.
* begin of change MOD-002
* set pf-status 'MAIN' EXCLUDING extab.
  case g_zlevel.
    when '1'.
      set pf-status 'WC' EXCLUDING extab.
    when others.
      set pf-status 'MAIN' EXCLUDING extab.
  endcase.
* end of change MOD-002

ENDFORM.                               " PF_STATUS_L

*&---------------------------------------------------------------------*
*&      Form  GET_ARBPL
*&---------------------------------------------------------------------*
*       read working center
*----------------------------------------------------------------------*
*  -->  arbid
*  <--  arbpl
*----------------------------------------------------------------------*
FORM get_arbpl USING    arbid TYPE cr_objid
               CHANGING arbpl TYPE arbpl.

  DATA:
    l_crhd LIKE crhd.

  READ TABLE gt_crhd INTO l_crhd
    WITH KEY objid = arbid
    binary search.

  arbpl = l_crhd-arbpl.

ENDFORM.                               " GET_ARBPL

*&---------------------------------------------------------------------*
*&      Form  GET_KTEXT
*&---------------------------------------------------------------------*
*       read working center description
*----------------------------------------------------------------------*
*  -->  arbid
*  <--  ktext
*----------------------------------------------------------------------*
FORM get_ktext USING    arbid TYPE cr_objid
               CHANGING ktext type CR_KTEXT.

  DATA:
    l_crtx LIKE crtx.

  READ TABLE gt_crtx INTO l_crtx
    WITH KEY objid = arbid
    binary search.

  ktext = l_crtx-ktext.

ENDFORM.                               " GET_KTEXT

*&---------------------------------------------------------------------*
*&      Form  GET_KOSTL                                  MOD-001
*&---------------------------------------------------------------------*
*       read cost center
*----------------------------------------------------------------------*
*  -->  arbid
*  <--  kostl
*----------------------------------------------------------------------*
FORM get_kostl USING    arbid TYPE cr_objid
               CHANGING kostl TYPE kostl.

  DATA:
    i_rcrco_a like rcrco_a.

  CALL FUNCTION 'CR_WORKCENTER_READ_COSTING'
    EXPORTING
      ARBID                    = arbid
      DATE                     = sy-datum
*     ALL_SETS_FROM_DATE       = ' '
    IMPORTING
*     ECRHD                    =
      EDATA                    = i_rcrco_a
*   TABLES
*     ET_CRCO_A                =
   EXCEPTIONS
     NOT_FOUND                = 1
     OTHERS                   = 2
      .

  IF SY-SUBRC = 0 and not i_rcrco_a-kostl is initial.
    kostl = i_rcrco_a-kostl.
  ENDIF.

ENDFORM.                               " GET_ARBPL

*&---------------------------------------------------------------------*
*&      Form  GET_ARBID
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->ARBPL                                                        *
*      -->ARBID_TAB                                                    *
*      -->ARBID                                                        *
*      -->P_G_WERKI                                                    *
*----------------------------------------------------------------------*
FORM get_arbid TABLES arbid_tab STRUCTURE arbid_tab_c
                      arbpl STRUCTURE s_arbpl
                      arbid STRUCTURE arbid_c
* begin of change MOD-009
*              USING  p_g_werki.
                      werki structure s_werki.
* end of change MOD-009

* read internal number of a work center -------------------------------*
  DESCRIBE TABLE arbpl LINES sy-tabix.
  IF NOT sy-tabix IS INITIAL.
    SELECT objid arbpl FROM crhd INTO TABLE arbid_tab
      WHERE arbpl IN arbpl
* begin of change MOD-009
*     AND werks EQ p_g_werki.
      and werks in werki.
* end of change MOD-009

*-- no work center found ----------------------------------------------*
    DESCRIBE TABLE arbid_tab LINES sy-tabix.
    IF sy-tabix IS INITIAL.
      MESSAGE s047(ih).
      STOP.
    ENDIF.

*-- too many work centers for select-----------------------------------*
    IF sy-tabix > 255.
      MESSAGE i103(ih).
      STOP.
    ENDIF.

*-- fill range for selection ------------------------------------------*
    arbid-option = 'EQ'.
    arbid-sign = 'I'.
    LOOP AT arbid_tab.
      arbid-low = arbid_tab-arbid.
      APPEND arbid.
    ENDLOOP.
    SORT arbid_tab.
  ENDIF.

ENDFORM.                               " GET_ARBID

*&---------------------------------------------------------------------*
*&      Form  FILL_OBJECT_TAB
*&---------------------------------------------------------------------*
*       fill object_tab with selected data
*----------------------------------------------------------------------*
FORM fill_object_tab USING i_col structure gt_col.

  CLEAR object_tab.
* begin of change MOD-002
* MOVE-CORRESPONDING i_col TO object_tab.
  if g_zlevel is initial.
    MOVE-CORRESPONDING i_col TO object_tab.
* begin of insert MOD-011
  else.
    move i_col-werks to object_tab-werks.
* end of insert MOD-011
  endif.
* end of change MOD-002

  case i_col-colnr.
    when '001'.
      move i_col-ismnw to object_tab-ismnw_001.
    when '002'.
      move i_col-ismnw to object_tab-ismnw_002.
    when '003'.
      move i_col-ismnw to object_tab-ismnw_003.
    when '004'.
      move i_col-ismnw to object_tab-ismnw_004.
    when '005'.
      move i_col-ismnw to object_tab-ismnw_005.
    when '006'.
      move i_col-ismnw to object_tab-ismnw_006.
    when '007'.
      move i_col-ismnw to object_tab-ismnw_007.
    when '008'.
      move i_col-ismnw to object_tab-ismnw_008.
    when '009'.
      move i_col-ismnw to object_tab-ismnw_009.
    when '010'.
      move i_col-ismnw to object_tab-ismnw_010.
    when '011'.
      move i_col-ismnw to object_tab-ismnw_011.
    when '012'.
      move i_col-ismnw to object_tab-ismnw_012.
    when '013'.
      move i_col-ismnw to object_tab-ismnw_013.
    when '014'.
      move i_col-ismnw to object_tab-ismnw_014.
    when '015'.
      move i_col-ismnw to object_tab-ismnw_015.
    when '016'.
      move i_col-ismnw to object_tab-ismnw_016.
    when '017'.
      move i_col-ismnw to object_tab-ismnw_017.
    when '018'.
      move i_col-ismnw to object_tab-ismnw_018.
    when '019'.
      move i_col-ismnw to object_tab-ismnw_019.
    when '020'.
      move i_col-ismnw to object_tab-ismnw_020.

* begin of insert MOD-015
    when '021'.
      move i_col-ismnw to object_tab-ismnw_021.
    when '022'.
      move i_col-ismnw to object_tab-ismnw_022.
    when '023'.
      move i_col-ismnw to object_tab-ismnw_023.
    when '024'.
      move i_col-ismnw to object_tab-ismnw_024.
    when '025'.
      move i_col-ismnw to object_tab-ismnw_025.
    when '026'.
      move i_col-ismnw to object_tab-ismnw_026.
    when '027'.
      move i_col-ismnw to object_tab-ismnw_027.
    when '028'.
      move i_col-ismnw to object_tab-ismnw_028.
    when '029'.
      move i_col-ismnw to object_tab-ismnw_029.
    when '030'.
      move i_col-ismnw to object_tab-ismnw_030.
* end of insert MOD-015

* begin of insert MOD-006
    when '100'.
      move i_col-ismnw to object_tab-ismnw_100.
    when '101'.
      move i_col-ismnw to object_tab-ismnw_101.
    when '102'.
      move i_col-ismnw to object_tab-ismnw_102.
    when '103'.
      move i_col-ismnw to object_tab-ismnw_103.
    when '104'.
      move i_col-ismnw to object_tab-ismnw_104.
    when '105'.
      move i_col-ismnw to object_tab-ismnw_105.
    when '106'.
      move i_col-ismnw to object_tab-ismnw_106.
    when '107'.
      move i_col-ismnw to object_tab-ismnw_107.
    when '108'.
      move i_col-ismnw to object_tab-ismnw_108.
    when '109'.
      move i_col-ismnw to object_tab-ismnw_109.
    when '110'.
      move i_col-ismnw to object_tab-ismnw_110.
* end of insert MOD-006
*Begin of Insert MOD-012
    when '111'.
      move i_col-ismnw to object_tab-ismnw_111.
    when '112'.
      move i_col-ismnw to object_tab-ismnw_112.
    when '113'.
      move i_col-ismnw to object_tab-ismnw_113.
    when '114'.
      move i_col-ismnw to object_tab-ismnw_114.
    when '115'.
      move i_col-ismnw to object_tab-ismnw_115.
    when '116'.
      move i_col-ismnw to object_tab-ismnw_116.
    when '117'.
      move i_col-ismnw to object_tab-ismnw_117.
    when '118'.
      move i_col-ismnw to object_tab-ismnw_118.
    when '119'.
      move i_col-ismnw to object_tab-ismnw_119.
    when '120'.
      move i_col-ismnw to object_tab-ismnw_120.
    when '121'.
      move i_col-ismnw to object_tab-ismnw_121.
    when '122'.
      move i_col-ismnw to object_tab-ismnw_122.
    when '123'.
      move i_col-ismnw to object_tab-ismnw_123.
    when '124'.
      move i_col-ismnw to object_tab-ismnw_124.
    when '125'.
      move i_col-ismnw to object_tab-ismnw_125.
    when '126'.
      move i_col-ismnw to object_tab-ismnw_126.
    when '127'.
      move i_col-ismnw to object_tab-ismnw_127.
    when '128'.
      move i_col-ismnw to object_tab-ismnw_128.
    when '129'.
      move i_col-ismnw to object_tab-ismnw_129.
    when '130'.
      move i_col-ismnw to object_tab-ismnw_130.
    when '131'.
      move i_col-ismnw to object_tab-ismnw_131.
    when '132'.
      move i_col-ismnw to object_tab-ismnw_132.
    when '133'.
      move i_col-ismnw to object_tab-ismnw_133.
    when '134'.
      move i_col-ismnw to object_tab-ismnw_134.
    when '135'.
      move i_col-ismnw to object_tab-ismnw_135.
    when '136'.
      move i_col-ismnw to object_tab-ismnw_136.
    when '137'.
      move i_col-ismnw to object_tab-ismnw_137.
    when '138'.
      move i_col-ismnw to object_tab-ismnw_138.
    when '139'.
      move i_col-ismnw to object_tab-ismnw_139.
    when '140'.
      move i_col-ismnw to object_tab-ismnw_140.
    when '141'.
      move i_col-ismnw to object_tab-ismnw_141.
    when '142'.
      move i_col-ismnw to object_tab-ismnw_142.
    when '143'.
      move i_col-ismnw to object_tab-ismnw_143.
    when '144'.
      move i_col-ismnw to object_tab-ismnw_144.
    when '145'.
      move i_col-ismnw to object_tab-ismnw_145.
    when '146'.
      move i_col-ismnw to object_tab-ismnw_146.
    when '147'.
      move i_col-ismnw to object_tab-ismnw_147.
    when '148'.
      move i_col-ismnw to object_tab-ismnw_148.
    when '149'.
      move i_col-ismnw to object_tab-ismnw_149.
    when '150'.
      move i_col-ismnw to object_tab-ismnw_150.
    when '151'.
      move i_col-ismnw to object_tab-ismnw_151.
    when '152'.
      move i_col-ismnw to object_tab-ismnw_152.
    when '153'.
      move i_col-ismnw to object_tab-ismnw_153.
    when '154'.
      move i_col-ismnw to object_tab-ismnw_154.
    when '155'.
      move i_col-ismnw to object_tab-ismnw_155.
    when '156'.
      move i_col-ismnw to object_tab-ismnw_156.
    when '157'.
      move i_col-ismnw to object_tab-ismnw_157.
    when '158'.
      move i_col-ismnw to object_tab-ismnw_158.
    when '159'.
      move i_col-ismnw to object_tab-ismnw_159.
    when '160'.
      move i_col-ismnw to object_tab-ismnw_160.
    when '161'.
      move i_col-ismnw to object_tab-ismnw_161.
    when '162'.
      move i_col-ismnw to object_tab-ismnw_162.
*End of Insert MOD-012
    "MOD-016 begin
      when '163'.
      move i_col-ismnw to object_tab-ismnw_163.
      when '164'.
      move i_col-ismnw to object_tab-ismnw_164.
      when '165'.
      move i_col-ismnw to object_tab-ismnw_165.
      when '166'.
      move i_col-ismnw to object_tab-ismnw_166.
      when '167'.
      move i_col-ismnw to object_tab-ismnw_167.
      when '168'.
      move i_col-ismnw to object_tab-ismnw_168.
      when '169'.
      move i_col-ismnw to object_tab-ismnw_169.
      when '170'.
      move i_col-ismnw to object_tab-ismnw_170.
      when '171'.
      move i_col-ismnw to object_tab-ismnw_171.
      when '172'.
      move i_col-ismnw to object_tab-ismnw_172.
      when '173'.
      move i_col-ismnw to object_tab-ismnw_173.
      when '174'.
      move i_col-ismnw to object_tab-ismnw_174.
      when '175'.
      move i_col-ismnw to object_tab-ismnw_175.
      when '176'.
      move i_col-ismnw to object_tab-ismnw_176.
      when '177'.
      move i_col-ismnw to object_tab-ismnw_177.
      when '178'.
      move i_col-ismnw to object_tab-ismnw_178.
      when '179'.
      move i_col-ismnw to object_tab-ismnw_179.
      when '180'.
      move i_col-ismnw to object_tab-ismnw_180.
      when '181'.
      move i_col-ismnw to object_tab-ismnw_181.
      when '182'.
      move i_col-ismnw to object_tab-ismnw_182.
      when '183'.
      move i_col-ismnw to object_tab-ismnw_183.
      when '184'.
      move i_col-ismnw to object_tab-ismnw_184.
      when '185'.
      move i_col-ismnw to object_tab-ismnw_185.
      when '186'.
      move i_col-ismnw to object_tab-ismnw_186.
  "MOD-016 end

  endcase.

** begin of delete MOD-002
** begin of insert MOD-001
*  on change of i_col-arbid or i_col-aufnr or i_col-rueck or i_col-rmzhl
*.
** end of insert MOD-001
*    move i_col-ismnw to object_tab-ismnw_tot.
** begin of insert MOD-001
*  endon.
** end of insert MOD-001
** begin of delete MOD-002

  PERFORM get_arbpl USING i_col-arbid object_tab-iarbpl.
* begin of insert MOD-001
  perform get_kostl using i_col-arbid object_tab-kostl.
* end of insert MOD-001
  PERFORM get_ktext USING i_col-arbid object_tab-ktext.

  collect object_tab.

ENDFORM.                               " FILL_OBJECT_TAB

*&---------------------------------------------------------------------*
*&      Form  fcodes_with_mark_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_F_UCOMM  text
*      -->P_F_SELFIELD  text
*----------------------------------------------------------------------*
FORM fcodes_with_mark_l  USING   p_ucomm LIKE sy-ucomm
                              p_selfield TYPE slis_selfield.

  DATA: h_ucomm LIKE sy-ucomm.

  PERFORM mark_selected_f16 CHANGING object_tab-selected
                                     object_tab-pm_selected.

  CASE p_ucomm.
*   show confirmation
    WHEN 'RMEL'.
      SET PARAMETER ID 'RCK' FIELD  object_tab-rueck.
      SET PARAMETER ID 'RZL' FIELD  object_tab-rmzhl.
      SET PARAMETER ID 'ANR' FIELD  object_tab-aufnr.
      CALL TRANSACTION 'IW43' AND SKIP FIRST SCREEN.
*   Display order document
    WHEN 'AUFK'.
      SET PARAMETER ID 'ANR' FIELD  object_tab-aufnr.
      CALL TRANSACTION 'IW33' AND SKIP FIRST SCREEN.
  ENDCASE.

ENDFORM.                    " fcodes_with_mark_l

*&---------------------------------------------------------------------*
*&      Form  alv_display
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_display .

  data: g_title TYPE  LVC_TITLE.

  g_title = p_reptp.
  g_repid = sy-repid.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
     EXPORTING
       i_callback_program                =  g_repid
       i_save                            = 'A'
       it_events                         =  g_events_tab[]
       I_GRID_TITLE                      =  g_title
*      I_GRID_SETTINGS                   =
*      is_layout                         =  g_layout
       it_fieldcat                       =  gt_fieldcat[]
       is_variant                        =  g_variant
     TABLES
        t_outtab                         =  object_tab.

ENDFORM.                    " alv_display

*&---------------------------------------------------------------------*
*&      Form  PRESELECT_CRHD
*&---------------------------------------------------------------------*
FORM preselect_crhd TABLES it_crid TYPE crid_tab.

  SELECT * FROM crhd INTO TABLE gt_crhd
    FOR ALL ENTRIES IN it_crid
    WHERE objty = it_crid-objty
    AND   objid = it_crid-objid.

  SORT gt_crhd BY objid.

ENDFORM.                               " PRESELECT_CRHD

*&---------------------------------------------------------------------*
*&      Form  PRESELECT_CRTX
*&---------------------------------------------------------------------*
FORM preselect_crtx TABLES it_crid TYPE crid_tab.

  SELECT * FROM crtx INTO TABLE gt_crtx
    FOR ALL ENTRIES IN it_crid
    WHERE objty = it_crid-objty
* begin of insert MOD-003
    AND   spras = sy-langu
* end of insert MOD-003
    AND   objid = it_crid-objid.

  SORT gt_crtx BY objid.

ENDFORM.                               " PRESELECT_CRTX
*&---------------------------------------------------------------------*
*&      Form  CHECK_FIELDCAT_VARIANT_L
*&---------------------------------------------------------------------*
*       set disp. fields if no list variant exists
*----------------------------------------------------------------------*
FORM check_fieldcat_variant_l.

  DATA fieldcat_wa TYPE slis_fieldcat_alv.
  DATA index       LIKE sy-tabix.

  index = 1.

  DESCRIBE TABLE g_selfields_tab LINES sy-tabix.
  IF sy-tabix IS INITIAL.
    LOOP AT g_fieldcat_tab INTO fieldcat_wa.
      CASE fieldcat_wa-fieldname.
        WHEN 'PM_SELECTED'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 1.
        WHEN 'IARBPL'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 2.
        WHEN 'AUFNR'.
          fieldcat_wa-no_out = space.
          fieldcat_wa-col_pos = 3.
* begin of delete MOD-002
*       WHEN 'ISMNW_TOT'.
*         fieldcat_wa-no_out = space.
*         fieldcat_wa-col_pos = 4.
* end of delete MOD-002
        WHEN OTHERS.
          fieldcat_wa-no_out = g_x.
      ENDCASE.
      MODIFY g_fieldcat_tab FROM fieldcat_wa.
    ENDLOOP.
  ENDIF.

  PERFORM create_g_selfields_tab_f14.

ENDFORM.                               " CHECK_FIELDCAT_VARIANT_L

*&---------------------------------------------------------------------*
*&      Form  GET_ACTTYPE_AFRU_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_acttype_afru_l.

  SELECT SINGLE * FROM t370a WHERE tcode = g_tcode.
  IF sy-subrc <> 0.
    SELECT SINGLE * FROM t370a WHERE tcode = 'IW47'.
    IF sy-subrc <> 0.
      RAISE iw29_not_in_t370a.
    ENDIF.
  ENDIF.
  g_aktyp = t370a-aktyp.

ENDFORM.                               " GET_ACTTYPE_AFRU_L

*&---------------------------------------------------------------------*
*&      Form  calculate_extra_columns                     MOD-002
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM calculate_extra_columns .

  data: lv_string       type string,
        lv_prog         type repid,
        lv_RETCODE      LIKE SY-SUBRC,
        lv_FUNCNAME(30) TYPE C,
        lv_MESSAGE(70)  TYPE C,
        lv_POS          TYPE I,
        lv_res          type f.

  constants:
    lc_FORMC(16)    type c VALUE 'GET_CHECK_VALUES',
    lc_FORME(15)    type c VALUE 'GET_EVAL_VALUES'.

  loop at gt_yam_hr_formulas.

    clear: lv_string, lv_res.
    move gt_yam_hr_formulas-zfrm to lv_string.

*   Check formula on correctness
    lv_prog = sy-repid.

    CALL FUNCTION 'CHECK_FORMULA'
      EXPORTING
        FORMULA  = lv_string
        PROGRAM  = lv_prog
        ROUTINE  = lc_formc
      IMPORTING
        SUBRC    = lv_retcode
        FUNCNAME = lv_FUNCNAME
        MESSAGE  = lv_MESSAGE
        POS      = lv_POS.

    IF lv_RETCODE IS INITIAL.
      CALL FUNCTION 'EVAL_FORMULA'
       EXPORTING
*        DEGREES                 = ' '
         FORMULA                 = lv_string
         PROGRAM                 = lv_prog
         ROUTINE                 = lc_forme
*        UNIT_OF_MEASURE         = ' '
*        NO_EXISTENCE_CHECK      = ' '
       IMPORTING
         VALUE                   = lv_res
       EXCEPTIONS
         DIVISION_BY_ZERO        = 1
         EXP_ERROR               = 2
         FORMULA_TABLE_NOT_VALID = 3
         INVALID_EXPRESSION      = 4
         INVALID_VALUE           = 5
         LOG_ERROR               = 6
         PARAMETER_ERROR         = 7
         SQRT_ERROR              = 8
         UNITS_NOT_VALID         = 9
         MISSING_PARAMETER       = 10
         OTHERS                  = 11.

      IF SY-SUBRC <> 0.
        message s001(00) with text-e10 sy-subrc.
        exit.
      ENDIF.
    ELSE.
      message s001(00) with text-e11.
      exit.
    ENDIF.

    case gt_yam_hr_formulas-zcolnr.
      when '021'.
        move lv_res to object_tab-ismnw_021.
      when '022'.
        move lv_res to object_tab-ismnw_022.
      when '023'.
        move lv_res to object_tab-ismnw_023.
      when '024'.
        move lv_res to object_tab-ismnw_024.
      when '025'.
        move lv_res to object_tab-ismnw_025.
* begin of insert MOD-005
      when '026'.
        move lv_res to object_tab-ismnw_026.
      when '027'.
        move lv_res to object_tab-ismnw_027.
      when '028'.
        move lv_res to object_tab-ismnw_028.
      when '029'.
        move lv_res to object_tab-ismnw_029.
      when '030'.
        move lv_res to object_tab-ismnw_030.
* end of insert MOD-005
    endcase.

    modify object_tab.

  endloop.

ENDFORM.                    " calculate_extra_columns

*-----------------------------------------------------------------------
*  GET_CHECK_VALUES    check routine                       MOD-002
*-----------------------------------------------------------------------
FORM GET_CHECK_VALUES USING PARM
                      CHANGING SUBRC.

  CASE PARM.
    WHEN 'C001'.
      SUBRC = 0.
    WHEN 'C002'.
      SUBRC = 0.
    WHEN 'C003'.
      SUBRC = 0.
    WHEN 'C004'.
      SUBRC = 0.
    WHEN 'C005'.
      SUBRC = 0.
    WHEN 'C006'.
      SUBRC = 0.
    WHEN 'C007'.
      SUBRC = 0.
    WHEN 'C008'.
      SUBRC = 0.
    WHEN 'C009'.
      SUBRC = 0.
    WHEN 'C010'.
      SUBRC = 0.
    WHEN 'C011'.
      SUBRC = 0.
    WHEN 'C012'.
      SUBRC = 0.
    WHEN 'C013'.
      SUBRC = 0.
    WHEN 'C014'.
      SUBRC = 0.
    WHEN 'C015'.
      SUBRC = 0.
    WHEN 'C016'.
      SUBRC = 0.
    WHEN 'C017'.
      SUBRC = 0.
    WHEN 'C018'.
      SUBRC = 0.
    WHEN 'C019'.
      SUBRC = 0.
    WHEN 'C020'.
      SUBRC = 0.
    WHEN 'C021'.
      SUBRC = 0.
    WHEN 'C022'.
      SUBRC = 0.
    WHEN 'C023'.
      SUBRC = 0.
    WHEN 'C024'.
      SUBRC = 0.
    WHEN 'C025'.
      SUBRC = 0.
* begin of insert MOD-005
    WHEN 'C026'.
      SUBRC = 0.
    WHEN 'C027'.
      SUBRC = 0.
    WHEN 'C028'.
      SUBRC = 0.
    WHEN 'C029'.
      SUBRC = 0.
    WHEN 'C030'.
      SUBRC = 0.
* end of insert MOD-005
* begin of insert MOD-006
    WHEN 'C100'.
      SUBRC = 0.
    WHEN 'C101'.
      SUBRC = 0.
    WHEN 'C102'.
      SUBRC = 0.
    WHEN 'C103'.
      SUBRC = 0.
    WHEN 'C104'.
      SUBRC = 0.
    WHEN 'C105'.
      SUBRC = 0.
    WHEN 'C106'.
      SUBRC = 0.
    WHEN 'C107'.
      SUBRC = 0.
    WHEN 'C108'.
      SUBRC = 0.
    WHEN 'C109'.
      SUBRC = 0.
    WHEN 'C110'.
      SUBRC = 0.
* end of insert MOD-006
* begin of insert MOD-012
    WHEN 'C111'.
      SUBRC = 0.
    WHEN 'C112'.
      SUBRC = 0.
    WHEN 'C113'.
      SUBRC = 0.
    WHEN 'C114'.
      SUBRC = 0.
    WHEN 'C115'.
      SUBRC = 0.
    WHEN 'C116'.
      SUBRC = 0.
    WHEN 'C117'.
      SUBRC = 0.
    WHEN 'C118'.
      SUBRC = 0.
    WHEN 'C119'.
      SUBRC = 0.
    WHEN 'C120'.
      SUBRC = 0.
    WHEN 'C121'.
      SUBRC = 0.
    WHEN 'C122'.
      SUBRC = 0.
    WHEN 'C123'.
      SUBRC = 0.
    WHEN 'C124'.
      SUBRC = 0.
    WHEN 'C125'.
      SUBRC = 0.
    WHEN 'C126'.
      SUBRC = 0.
    WHEN 'C127'.
      SUBRC = 0.
    WHEN 'C128'.
      SUBRC = 0.
    WHEN 'C129'.
      SUBRC = 0.
    WHEN 'C130'.
      SUBRC = 0.
    WHEN 'C131'.
      SUBRC = 0.
    WHEN 'C132'.
      SUBRC = 0.
    WHEN 'C133'.
      SUBRC = 0.
    WHEN 'C134'.
      SUBRC = 0.
    WHEN 'C135'.
      SUBRC = 0.
    WHEN 'C136'.
      SUBRC = 0.
    WHEN 'C137'.
      SUBRC = 0.
    WHEN 'C138'.
      SUBRC = 0.
    WHEN 'C139'.
      SUBRC = 0.
    WHEN 'C140'.
      SUBRC = 0.
    WHEN 'C141'.
      SUBRC = 0.
    WHEN 'C142'.
      SUBRC = 0.
    WHEN 'C143'.
      SUBRC = 0.
    WHEN 'C144'.
      SUBRC = 0.
    WHEN 'C145'.
      SUBRC = 0.
    WHEN 'C146'.
      SUBRC = 0.
    WHEN 'C147'.
      SUBRC = 0.
    WHEN 'C148'.
      SUBRC = 0.
    WHEN 'C149'.
      SUBRC = 0.
    WHEN 'C150'.
      SUBRC = 0.
    WHEN 'C151'.
      SUBRC = 0.
    WHEN 'C152'.
      SUBRC = 0.
    WHEN 'C153'.
      SUBRC = 0.
    WHEN 'C154'.
      SUBRC = 0.
    WHEN 'C155'.
      SUBRC = 0.
    WHEN 'C156'.
      SUBRC = 0.
    WHEN 'C157'.
      SUBRC = 0.
    WHEN 'C158'.
      SUBRC = 0.
    WHEN 'C159'.
      SUBRC = 0.
    WHEN 'C160'.
      SUBRC = 0.
    WHEN 'C161'.
      SUBRC = 0.
    WHEN 'C162'.
      SUBRC = 0.
* end of insert MOD-012
    WHEN OTHERS.
      SUBRC = 1.
  ENDCASE.

ENDFORM.                    "GET_CHECK_VALUES

*-----------------------------------------------------------------------
*  GET_EVAL_VALUES    eval routine                       MOD-002
*-----------------------------------------------------------------------
FORM GET_EVAL_VALUES  USING    PARM
                      CHANGING WERT
                               SUBRC.

  CASE PARM.
    WHEN 'C001'.
      WERT  = object_tab-ismnw_001.
      SUBRC = 0.
    WHEN 'C002'.
      WERT  = object_tab-ismnw_002.
      SUBRC = 0.
    WHEN 'C003'.
      WERT  = object_tab-ismnw_003.
      SUBRC = 0.
    WHEN 'C004'.
      WERT  = object_tab-ismnw_004.
      SUBRC = 0.
    WHEN 'C005'.
      WERT  = object_tab-ismnw_005.
      SUBRC = 0.
    WHEN 'C006'.
      WERT  = object_tab-ismnw_006.
      SUBRC = 0.
    WHEN 'C007'.
      WERT  = object_tab-ismnw_007.
      SUBRC = 0.
    WHEN 'C008'.
      WERT  = object_tab-ismnw_008.
      SUBRC = 0.
    WHEN 'C009'.
      WERT  = object_tab-ismnw_009.
      SUBRC = 0.
    WHEN 'C010'.
      WERT  = object_tab-ismnw_010.
      SUBRC = 0.
    WHEN 'C011'.
      WERT  = object_tab-ismnw_011.
      SUBRC = 0.
    WHEN 'C012'.
      WERT  = object_tab-ismnw_012.
      SUBRC = 0.
    WHEN 'C013'.
      WERT  = object_tab-ismnw_013.
      SUBRC = 0.
    WHEN 'C014'.
      WERT  = object_tab-ismnw_014.
      SUBRC = 0.
    WHEN 'C015'.
      WERT  = object_tab-ismnw_015.
      SUBRC = 0.
    WHEN 'C016'.
      WERT  = object_tab-ismnw_016.
      SUBRC = 0.
    WHEN 'C017'.
      WERT  = object_tab-ismnw_017.
      SUBRC = 0.
    WHEN 'C018'.
      WERT  = object_tab-ismnw_018.
      SUBRC = 0.
    WHEN 'C019'.
      WERT  = object_tab-ismnw_019.
      SUBRC = 0.
    WHEN 'C020'.
      WERT  = object_tab-ismnw_020.
      SUBRC = 0.
    WHEN 'C021'.
      WERT  = object_tab-ismnw_021.
      SUBRC = 0.
    WHEN 'C022'.
      WERT  = object_tab-ismnw_022.
      SUBRC = 0.
    WHEN 'C023'.
      WERT  = object_tab-ismnw_023.
      SUBRC = 0.
    WHEN 'C024'.
      WERT  = object_tab-ismnw_024.
      SUBRC = 0.
    WHEN 'C025'.
      WERT  = object_tab-ismnw_025.
      SUBRC = 0.
* begin of insert MOD-005
    WHEN 'C026'.
      WERT  = object_tab-ismnw_026.
      SUBRC = 0.
    WHEN 'C027'.
      WERT  = object_tab-ismnw_027.
      SUBRC = 0.
    WHEN 'C028'.
      WERT  = object_tab-ismnw_028.
      SUBRC = 0.
    WHEN 'C029'.
      WERT  = object_tab-ismnw_029.
      SUBRC = 0.
    WHEN 'C030'.
      WERT  = object_tab-ismnw_030.
      SUBRC = 0.
* end of insert MOD-005
* begin of insert MOD-006
    WHEN 'C100'.
      WERT  = object_tab-ismnw_100.
      SUBRC = 0.
    WHEN 'C101'.
      WERT  = object_tab-ismnw_101.
      SUBRC = 0.
    WHEN 'C102'.
      WERT  = object_tab-ismnw_102.
      SUBRC = 0.
    WHEN 'C103'.
      WERT  = object_tab-ismnw_103.
      SUBRC = 0.
    WHEN 'C104'.
      WERT  = object_tab-ismnw_104.
      SUBRC = 0.
    WHEN 'C105'.
      WERT  = object_tab-ismnw_105.
      SUBRC = 0.
    WHEN 'C106'.
      WERT  = object_tab-ismnw_106.
      SUBRC = 0.
    WHEN 'C107'.
      WERT  = object_tab-ismnw_107.
      SUBRC = 0.
    WHEN 'C108'.
      WERT  = object_tab-ismnw_108.
      SUBRC = 0.
    WHEN 'C109'.
      WERT  = object_tab-ismnw_109.
      SUBRC = 0.
    WHEN 'C110'.
      WERT  = object_tab-ismnw_110.
      SUBRC = 0.
* end of insert MOD-006
* begin of insert MOD-012
    WHEN 'C111'.
      WERT  = object_tab-ismnw_111.
    WHEN 'C112'.
      WERT  = object_tab-ismnw_112.
    WHEN 'C113'.
      WERT  = object_tab-ismnw_113.
    WHEN 'C114'.
      WERT  = object_tab-ismnw_114.
    WHEN 'C115'.
      WERT  = object_tab-ismnw_115.
    WHEN 'C116'.
      WERT  = object_tab-ismnw_116.
    WHEN 'C117'.
      WERT  = object_tab-ismnw_117.
    WHEN 'C118'.
      WERT  = object_tab-ismnw_118.
    WHEN 'C119'.
      WERT  = object_tab-ismnw_119.
    WHEN 'C120'.
      WERT  = object_tab-ismnw_120.
    WHEN 'C121'.
      WERT  = object_tab-ismnw_121.
    WHEN 'C122'.
      WERT  = object_tab-ismnw_122.
    WHEN 'C123'.
      WERT  = object_tab-ismnw_123.
    WHEN 'C124'.
      WERT  = object_tab-ismnw_124.
    WHEN 'C125'.
      WERT  = object_tab-ismnw_125.
    WHEN 'C126'.
      WERT  = object_tab-ismnw_126.
    WHEN 'C127'.
      WERT  = object_tab-ismnw_127.
    WHEN 'C128'.
      WERT  = object_tab-ismnw_128.
    WHEN 'C129'.
      WERT  = object_tab-ismnw_129.
    WHEN 'C130'.
      WERT  = object_tab-ismnw_130.
    WHEN 'C131'.
      WERT  = object_tab-ismnw_131.
    WHEN 'C132'.
      WERT  = object_tab-ismnw_132.
    WHEN 'C133'.
      WERT  = object_tab-ismnw_133.
    WHEN 'C134'.
      WERT  = object_tab-ismnw_134.
    WHEN 'C135'.
      WERT  = object_tab-ismnw_135.
    WHEN 'C136'.
      WERT  = object_tab-ismnw_136.
    WHEN 'C137'.
      WERT  = object_tab-ismnw_137.
    WHEN 'C138'.
      WERT  = object_tab-ismnw_138.
    WHEN 'C139'.
      WERT  = object_tab-ismnw_139.
    WHEN 'C140'.
      WERT  = object_tab-ismnw_140.
    WHEN 'C141'.
      WERT  = object_tab-ismnw_141.
    WHEN 'C142'.
      WERT  = object_tab-ismnw_142.
    WHEN 'C143'.
      WERT  = object_tab-ismnw_143.
    WHEN 'C144'.
      WERT  = object_tab-ismnw_144.
    WHEN 'C145'.
      WERT  = object_tab-ismnw_145.
    WHEN 'C146'.
      WERT  = object_tab-ismnw_146.
    WHEN 'C147'.
      WERT  = object_tab-ismnw_147.
    WHEN 'C148'.
      WERT  = object_tab-ismnw_148.
    WHEN 'C149'.
      WERT  = object_tab-ismnw_149.
    WHEN 'C150'.
      WERT  = object_tab-ismnw_150.
    WHEN 'C151'.
      WERT  = object_tab-ismnw_151.
    WHEN 'C152'.
      WERT  = object_tab-ismnw_152.
    WHEN 'C153'.
      WERT  = object_tab-ismnw_153.
    WHEN 'C154'.
      WERT  = object_tab-ismnw_154.
    WHEN 'C155'.
      WERT  = object_tab-ismnw_155.
    WHEN 'C156'.
      WERT  = object_tab-ismnw_156.
    WHEN 'C157'.
      WERT  = object_tab-ismnw_157.
    WHEN 'C158'.
      WERT  = object_tab-ismnw_158.
    WHEN 'C159'.
      WERT  = object_tab-ismnw_159.
    WHEN 'C160'.
      WERT  = object_tab-ismnw_160.
    WHEN 'C161'.
      WERT  = object_tab-ismnw_161.
    WHEN 'C162'.
      WERT  = object_tab-ismnw_162.
* end of insert MOD-012
      "MOD-016 begin
   WHEN 'C163'.
      WERT  = object_tab-ismnw_163.
    WHEN 'C164'.
      WERT  = object_tab-ismnw_164.
    WHEN 'C165'.
      WERT  = object_tab-ismnw_165.
    WHEN 'C166'.
      WERT  = object_tab-ismnw_166.
    WHEN 'C167'.
      WERT  = object_tab-ismnw_167.
    WHEN 'C168'.
      WERT  = object_tab-ismnw_168.
    WHEN 'C169'.
      WERT  = object_tab-ismnw_169.
    WHEN 'C170'.
      WERT  = object_tab-ismnw_170.
    WHEN 'C171'.
      WERT  = object_tab-ismnw_171.
    WHEN 'C172'.
      WERT  = object_tab-ismnw_172.
    WHEN 'C173'.
      WERT  = object_tab-ismnw_173.
    WHEN 'C174'.
      WERT  = object_tab-ismnw_174.
    WHEN 'C175'.
      WERT  = object_tab-ismnw_175.
    WHEN 'C176'.
      WERT  = object_tab-ismnw_176.
    WHEN 'C177'.
      WERT  = object_tab-ismnw_177.
    WHEN 'C178'.
      WERT  = object_tab-ismnw_178.
    WHEN 'C179'.
      WERT  = object_tab-ismnw_179.
    WHEN 'C180'.
      WERT  = object_tab-ismnw_180.
    WHEN 'C181'.
      WERT  = object_tab-ismnw_181.
    WHEN 'C182'.
      WERT  = object_tab-ismnw_182.
    WHEN 'C183'.
      WERT  = object_tab-ismnw_183.
    WHEN 'C184'.
      WERT  = object_tab-ismnw_184.
    WHEN 'C185'.
      WERT  = object_tab-ismnw_185.
    WHEN 'C186'.
      WERT  = object_tab-ismnw_186.
      "MOD-016 END

    WHEN OTHERS.
      SUBRC = 1.
  ENDCASE.

ENDFORM.                    "GET_EVAL_VALUES

*Text symbol text
*001:Selection screen input
*002:Layout
*700:
*701:Wollen Sie die Verarbeitung fr
*702:
*703:selektierten Objekte abbrechen?
*704:
*705:
*706:Ja
*ANZ:Number
*E01:Make an entry in one of the three date fields
*E02:No report types in custom table for this plant
*E03:No authorisation for plant
*E10:Error in formula :
*E11:Syntax error in formula !
*I01:Work center description
*I02:Work center descr.
*I03:Order
*I08:Business line
*I09:Bus. Line

*SON:Others
*Selection text
*P_REPTP:        Report Type
*P_WLAYO:        Plant (layout)
*S_ARBPL:D       .
*S_BUDAT:D       .
*S_ERSDA:D       .
*S_ISDD:        Actual start
*S_ORIGF:D       .
*S_WERKI:        Plant (actual)
*VARIANT:        Layout
