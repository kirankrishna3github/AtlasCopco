*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_P022_ACTUAL_RUNNING_HRS                   *
* PROGRAM TITLE        : VARIANCE ESTIMATED/ACTUAL RUNNING HOURS       *
* AUTHOR               : Mira Saikrishna/Amit Mahajan                  *
* DATE                 : 28/10/2004                                    *
* DEVELOPMENT ID       : XXXX                                          *
*
* CHANGE REQUEST NUMBER:                                               *
* PROGRAM DESCRIPTION  : THIS REPORT IS A COPY OF IW75 TRANSACTION,AS  *
* PER THE CUSTOMER REQUIREMENT,SOME ADDITIONAL INORMATION IS NEED ON   *
* THE OUTPUT SCREEN AND INPUT SCREEN                                   *
* SELECTION SCREEN: DATE AND TIME SELECT OPTIONS ADDED                 *
* SELECTION SCREEN.                                                    *
* ALV LIST : MEASURING POINT,ESTIMATED RUNNING HOURS,ACTUAL RUNNING    *
* HOURS,VARIANCE AND VARIANCE PERCENTAGE.                              *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 | 2004.11.23 | Ravin Malhotra |CD1K900802 |xxxxxxxxxxxxx| *
* MOD-002 | 2004.12.07 | Ravin Malhotra |CD1K901088 |Sold to Party Name*
* MOD-003 | 2005.07.13 | Tvolkae        |           |Change running hrs*
*         |            |                |           |characteristic    *
* MOD-004 | 2005.10.11 | Luc Mertens    |CD1K903528 |syntax error      *
*      when moving structures must have the same layout                *
* MOD-005 | 2006.09.20 | Marc Jacobs    |CD1K906816 |Add Backbilling   *
*      hours and variance%                                             *
************************************************************************
* MOD-006 | 2009.05.04 | S. Basu        |CD1K947987 | SM#4040/CR-0808  *
*      Pick up Estimated hours from 015 instead of 010                 *
************************************************************************
*----------------------------------------------------------------------*
REPORT YAM_P022_ACTUAL_RUNNING_HRS MESSAGE-ID IH
                NO STANDARD PAGE HEADING.

*####################################################################*
* Datenteil                                                          *
*####################################################################*

*-------------------------------------------------------------------*
* Datenbanktabellen                                                 *
*-------------------------------------------------------------------*
TABLES: VIVEDA,
        VISER02,
        OBJK,
        IFLOTX,
        IFLOS,
        ILOA,
        MAKT,
        VEDA,
        VBKD,
        RIHVEDA,
*----------------------------------------------------------------------*
* YAM_RIHVEDA IS DEFINED TO PRINT THE FIELDCATLOG WITH ADITIONAL FIELDS*
* REQUIRED AS PER THE GAP00062                                         *
*----------------------------------------------------------------------*
      YAM_RIHVEDA.
* end of change MOD-004
TYPE-POOLS:  SLIS.
*-------------------------------------------------------------------*
* ATAB-Tabellen                                                     *
*-------------------------------------------------------------------*
TABLES: T370A.
*-------------------------------------------------------------------*
* Interne Tabellen                                                  *
*-------------------------------------------------------------------*
DATA: BEGIN OF OBJECT_TAB OCCURS 0.
* begin of change MOD-004
*       INCLUDE STRUCTURE YAM_RIHVEDA.
        include structure rihveda.
data:   pyear     type yampyear,
        ayear     type yamayear,
        variance  type yamvariance,
        variance% type yamvarianceper,
* begin of insertion mod-005
        bpoint    type imrc_point,
        byear     type yamayear,
        varianceb type yamvariance,
        varianceb% type yamvarianceper.
* end of insertion mod-005
* end of change MOD-004
DATA:   ILOAN     LIKE VISER02-ILOAN,
        TPLNR_INT LIKE IFLO-TPLNR,
        SELECTED,
        PM_SELECTED TYPE PM_SELECTED,
        MRNGU LIKE IMPTT-MRNGU.
*        color type slis_t_specialcol_alv. " Color for Release
DATA:   END OF OBJECT_TAB.
DATA : OBJECT_TAB_FINAL LIKE OBJECT_TAB OCCURS 0 WITH HEADER LINE.
DATA: BEGIN OF SEL_TAB OCCURS 0.
* begin of change MOD-004
*----------------------------------------------------------------------*
*STRUCTURE YAM_RIHVEDA HAVE BEEN ADDED IN THE INTERNAL TABLE OBJECT_TAB*
*AS PER  THE GAP00062                                                  *
*----------------------------------------------------------------------*
*       INCLUDE STRUCTURE YAM_RIHVEDA.
        include structure rihveda.
data:   pyear     type yampyear,
        ayear     type yamayear,
        variance  type yamvariance,
        variance% type yamvarianceper,
* begin of insertion mod-005
        bpoint    type imrc_point,
        byear     type yamayear,
        varianceb type yamvariance,
        varianceb% type yamvarianceper.
* end of insertion mod-005
.
* end of change MOD-004
DATA:   ILOAN     LIKE    VISER02-ILOAN.
DATA:   TPLNR_INT LIKE    IFLO-TPLNR.
DATA: END OF SEL_TAB.

DATA: SEL_TAB_HELP LIKE SEL_TAB OCCURS 0 WITH HEADER LINE.

*-----------------------------------------------------*
* DEFINE INTERNAL TABLE                               *
*-----------------------------------------------------*
DATA: BEGIN OF I_IMRG OCCURS 0,
      POINT LIKE IMRG-POINT,
      IDATE LIKE IMRG-IDATE,
      ITIME LIKE IMRG-ITIME,
      READG LIKE IMRG-READG.
DATA: END OF I_IMRG.
DATA: BEGIN OF I_IMPT OCCURS 0,
      POINT LIKE IMPTT-POINT,
* begin of insertion mod-005
      psort like imptt-psort,
* end of insertion mod-005
      PYEAR LIKE IMPTT-PYEAR,
      MPOBJ LIKE IMPTT-MPOBJ,
      MRNGU LIKE IMPTT-MRNGU,
      END OF I_IMPT.

DATA: I_IMPT2 LIKE I_IMPT.                          "MOD-006

DATA: BEGIN OF I_kna1 OCCURS 0,
      kunnr LIKE kna1-kunnr,
      name1 LIKE kna1-name1,
 END OF I_kna1.


*-----------------------------------------------------*
* DEFINE VARIABLES AND WORK AREAS AS PER GAP0062      *
*-----------------------------------------------------*
DATA: G_MPOBJ LIKE IMPTT-MPOBJ,
      G_ATINN LIKE CABN-ATINN,
      G_ATINN2 LIKE CABN-ATINN,                     "MOD-006
      G_POINT LIKE IMPTT-POINT,
      G_PYEAR LIKE IMPTT-PYEAR,
      G_MDOCM LIKE IMRG-MDOCM,
      G_COUNT TYPE I,
*      G_RESULT(16),
*      G_RESULT1(16),
     g_result(16) type P ,
     g_result1(16) type p ,

      L_INDEX TYPE SY-TABIX.
*-------------------------------------------------------------*
* CONSTANTS AS PER GAP0062                                    *
*-------------------------------------------------------------*
CONSTANTS: " CNST_CHAR LIKE CABN-ATNAM VALUE 'ZAM_RHRSTOTAL',   "MOD003
           CNST_CHAR LIKE CABN-ATNAM VALUE 'ZAM_RHRSTOTAL_ACT', "MOD003
           CNST_CHAR2 LIKE CABN-ATNAM VALUE 'ZAM_RHRSTOTAL',   "MOD-006
           CNST_VAR(7)  TYPE C VALUE '-999999',
           CNST_PER(8) TYPE C VALUE '-99999 %',
* begin of insertion mod-005
           CNST_PSORT like imptt-psort value 'BACKBILLING'.
* end of insertion mod-005
*-------------------------------------------------------------*

DATA: H_LINES LIKE SY-TABIX.

DATA: G_CHECK_OBJECT_LATE TYPE FLAG.

RANGES: I_SDAUFNR FOR RIHVEDA-SDAUFNR.
RANGES: I_EQUNR FOR RIHVEDA-EQUNR.
RANGES: I_AUFNR FOR AUFK-AUFNR.
RANGES: I_MATNR FOR RIHVEDA-MATNR.
* begin of change MOD-004
*ANGES: I_POINT FOR YAM_RIHVEDA-POINT.
RANGES: I_POINT FOR RIHVEDA-POINT.
* end of change MOD-004

*-------------------------------------------------------------------*
* Flags Sonderverarbeitungen                                        *
*-------------------------------------------------------------------*

*eject
*-------------------------------------------------------------------*
* INCLUDES                                                          *
*-------------------------------------------------------------------*
INCLUDE MIOLXTOP.
INCLUDE MIMACRO0.
INCLUDE RVVBTYP.
*eject
*####################################################################*
* Selektionsbild                                                     *
*####################################################################*
*objektdaten
SELECTION-SCREEN BEGIN OF BLOCK RIVEDA20_1 WITH FRAME TITLE TEXT-F01.
SELECT-OPTIONS:
  TPLNR      FOR IFLOS-TPLNR NO-DISPLAY                                ,
  STRNO      FOR IFLOS-STRNO   MATCHCODE OBJECT IFLM                   ,
  EQUNR      FOR VISER02-EQUNR MATCHCODE OBJECT EQUI                   ,
  MATNR      FOR VISER02-MATNR MATCHCODE OBJECT MAT1                   ,
  SERNR      FOR VISER02-SERNR                                         .
SELECTION-SCREEN END OF BLOCK RIVEDA20_1.
*----------------------------------------------------------------------*
* ADDED DATE AND TIME PARAMETERS IN THE SELECTION SCREEN AS PER GAP0062*
*----------------------------------------------------------------------*

SELECTION-SCREEN BEGIN OF BLOCK riveda20_a WITH FRAME TITLE text-f06.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(27) text-004 FOR FIELD P_DATE1.
PARAMETERS: P_DATE1 LIKE sy-datum.
PARAMETERS: P_time1 LIKE sy-uzeit default sy-uzeit .
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(27) text-005 FOR FIELD p_date2.
PARAMETERS: P_date2 LIKE sy-datum.
PARAMETERS: P_time2 LIKE sy-uzeit.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK riveda20_a.

*Vertragsdaten
SELECTION-SCREEN BEGIN OF BLOCK RIVEDA20_2 WITH FRAME TITLE TEXT-F02.
SELECT-OPTIONS:
  SDAUFNR    FOR VIVEDA-VBELN MATCHCODE OBJECT VMVA                    ,
  POSNR      FOR VIVEDA-POSNR                                          ,
  AUART      FOR VIVEDA-AUART                                          ,
  MATWA      FOR VIVEDA-MATWA MATCHCODE OBJECT MAT1                    ,
  AUGRU      FOR VIVEDA-AUGRU NO-DISPLAY        ,
  VBEGDAT    FOR VEDA-VBEGDAT                                          ,
  VENDDAT    FOR VEDA-VENDDAT                                          ,
  VUNTDAT    FOR VEDA-VUNTDAT                                          ,
  NETWRX     FOR VIVEDA-NETWRX                                         ,
  CHARG      FOR VIVEDA-CHARG  NO-DISPLAY        ,
  SUBMI      FOR VIVEDA-SUBMI                                          ,
  VINSDAT    FOR VEDA-VINSDAT                                          ,
  VABNDAT    FOR VEDA-VABNDAT                                          ,
  VDEMDAT    FOR VEDA-VDEMDAT                                          ,
  VKUESCH    FOR VEDA-VKUESCH   NO-DISPLAY   ,
  VKUEGRU    FOR VEDA-VKUEGRU   NO-DISPLAY    ,
  VBELKUE    FOR VEDA-VBELKUE   NO-DISPLAY  ,
  VWUNDAT    FOR VEDA-VWUNDAT   NO-DISPLAY   ,
  VKUEPAR    FOR VEDA-VKUEPAR   NO-DISPLAY           ,
  VEINDAT    FOR VEDA-VEINDAT   NO-DISPLAY          ,
  VBEDKUE    FOR VEDA-VBEDKUE   NO-DISPLAY          ,
  VAKTSCH    FOR VEDA-VAKTSCH   NO-DISPLAY           ,
  VVORZEIT   FOR VEDA-VVORZEIT  NO-DISPLAY             ,
  MATKL      FOR VIVEDA-MATKL                                          ,
  MVGR1      FOR VIVEDA-MVGR1   NO-DISPLAY      ,
  MVGR2      FOR VIVEDA-MVGR2   NO-DISPLAY               ,
  MVGR3      FOR VIVEDA-MVGR3   NO-DISPLAY              ,
  MVGR4      FOR VIVEDA-MVGR4   NO-DISPLAY          ,
  MVGR5      FOR VIVEDA-MVGR5   NO-DISPLAY.
SELECTION-SCREEN END OF BLOCK RIVEDA20_2.

*Bestelldaten
SELECTION-SCREEN BEGIN OF BLOCK RIVEDA20_3 WITH FRAME TITLE TEXT-F03.
SELECT-OPTIONS:
  KUNNR      FOR VIVEDA-KUNNR  MATCHCODE OBJECT DEBI                   ,
  BNAME      FOR VIVEDA-BNAME                                          ,
  TELF1      FOR VIVEDA-TELF1                                          ,
  IHREZ      FOR VBKD-IHREZ                                            ,
  BSTNK      FOR VBKD-BSTKD                                            ,
  BSTDK      FOR VBKD-BSTDK                                            ,
  BSARK      FOR VBKD-BSARK     NO-DISPLAY          ,
  BSTZD      FOR VIVEDA-BSTZD   NO-DISPLAY      ,
  UEPOS      FOR VIVEDA-UEPOS   NO-DISPLAY            ,
  ARKTX      FOR VIVEDA-ARKTX   NO-DISPLAY         ,
  PSTYV      FOR VIVEDA-PSTYV                                          ,
  ABGRU      FOR VIVEDA-ABGRU   NO-DISPLAY            ,
  PRODH      FOR VIVEDA-PRODH                                          ,
  ZMENG      FOR VIVEDA-ZMENG   NO-DISPLAY           ,
  MEINS      FOR VIVEDA-MEINS   NO-DISPLAY             ,
  KDMAT      FOR VIVEDA-KDMAT                                          ,
  POSEX      FOR VIVEDA-POSEX                                          ,
  VGBEL      FOR VIVEDA-VGBEL                                          ,
  VGPOS      FOR VIVEDA-VGPOS                                          ,
  WERKS      FOR VIVEDA-WERKS                                          ,
  EAN11      FOR VIVEDA-EAN11   NO-DISPLAY            .
SELECTION-SCREEN END OF BLOCK RIVEDA20_3.

*VERTRIEBSDATEN und Zusatzdaten
SELECTION-SCREEN BEGIN OF BLOCK RIVEDA20_4 WITH FRAME TITLE TEXT-F04.
SELECT-OPTIONS:
  VKORG      FOR VIVEDA-VKORG                                          ,
  VTWEG      FOR VIVEDA-VTWEG                                          ,
  SPART      FOR VIVEDA-SPART                                          ,
  VKBUR      FOR VIVEDA-VKBUR                                          ,
  VKGRP      FOR VIVEDA-VKGRP                                          ,
  VBEGREG    FOR VEDA-VBEGREG                                          ,
  VLAUFK     FOR VEDA-VLAUFK                                           ,
  VLAUFZ     FOR VEDA-VLAUFZ                                           ,
  ERNAM      FOR VIVEDA-ERNAM                                          .

SELECTION-SCREEN END OF BLOCK RIVEDA20_4.

*SELECTION-SCREEN BEGIN OF BLOCK RIVEDA20_5 WITH FRAME TITLE TEXT-F05.
PARAMETERS:
  WAERS LIKE RIHVEDA-WAERK NO-DISPLAY.
*SELECTION-SCREEN END OF BLOCK RIVEDA20_5.

SELECTION-SCREEN BEGIN OF BLOCK RIVEDA20_6 WITH FRAME.
PARAMETERS: VARIANT LIKE DISVARIANT-VARIANT default '/EST_ACT_HRS'.
SELECTION-SCREEN END OF BLOCK RIVEDA20_6.
PARAMETERS:
  DY_SELM DEFAULT '0' NO-DISPLAY,
  DY_TCODE LIKE SY-TCODE NO-DISPLAY.

RANGES:
  STAT  FOR VIQMELST-STAT,
  ILOAN FOR VISER02-ILOAN.

DATA: G_UCOMM   LIKE SY-UCOMM.
DATA: G_SDAUFNR LIKE RIHVEDA-SDAUFNR.
DATA: G_POSNR   LIKE RIHVEDA-POSNR.
*eject
*---------------------------------------------------------------------
* Initialization
*---------------------------------------------------------------------
INITIALIZATION.
*-------------------------------------------------------------------*
* SELECT POINT FROM IMRG BASED ON DATE AND TIME FIELD AS PER GAP062 *
*-------------------------------------------------------------------*
  PERFORM DATE_TIME.
*------------------------------------------------------------------*

*--- Aktivit#tstyp bestimmen -----------------------------------------
  PERFORM DETERMINE_ACTTYPE_VEDA_L.
*--- Listvariante initialisieren -------------------------------------
  PERFORM VARIANT_INIT_F14 USING 'SERV'
                                 'INST'
                                 'INST'.

*--- Feldkatalog aufbauen -------------------------------------------
  PERFORM CREATE_FIELDCAT_F14 USING 'YAM_RIHVEDA'.
*--- defaultvariante f¨¹r Selektionsbild ermitteln
  PERFORM VARIANT_START_F16.
*--- defaultvariante f¨¹r Feldauswahl ermitteln ----------------------
  IF VARIANT IS INITIAL.
    PERFORM GET_DEFAULT_VARIANT_F14 USING VARIANT.
  ENDIF.

  G_SECOND_VALUE = 'NETWRX'.
  G_PORT_TITLE1 = 'Hohe Anzahl, hoher Wert'(PO1).
  G_PORT_TITLE2 = 'Niedrige Anzahl, hoher Wert'(PO2).
  G_PORT_TITLE3 = 'Hohe Anzahl, niedriger Wert'(PO3).
  G_PORT_TITLE4 = 'Niedrige Anzahl, niedriger Wert'(PO4).
  G_PORT_VALUE_TEXT = 'Nettowert'(P05).

*---------------------------------------------------------------------
*--- F4 Eingabehilfe f¨¹r Listvariante
*---------------------------------------------------------------------
AT SELECTION-SCREEN ON VALUE-REQUEST FOR VARIANT.
  PERFORM VARIANT_INPUTHELP_F14 USING VARIANT.
*eject
*---------------------------------------------------------------------
* AT SELECTION_SCREEN OUTPUT
*---------------------------------------------------------------------
AT SELECTION-SCREEN OUTPUT.
  PERFORM INIT_SELECTION_SCREEN_F16.
*--- Konvertierungsexit Technischer Platz
  PERFORM CONVERSION_EXIT_TPLNR_OUTP_F16 TABLES TPLNR STRNO.

*eject
*---------------------------------------------------------------------
* AT SELECTION_SCREEN
*---------------------------------------------------------------------
AT SELECTION-SCREEN.
*--- Korrekte Listvariante ausgew#hlt ? -----------------------------
  PERFORM VARIANT_EXISTENCE_F14 USING VARIANT.

*eject
*---------------------------------------------------------------------
* START-OF-SELECTION
*---------------------------------------------------------------------
START-OF-SELECTION.

*--- Aktivit#tstyp bestimmen -----------------------------------------
  PERFORM DETERMINE_G_TCODE_F16.
  PERFORM DETERMINE_ACTTYPE_VEDA_L.

  REFRESH SEL_TAB.
  PERFORM EXPORT_SELTAB_MEM_F16.
*--- Allgem. Einstellungen f¨¹r Listviewer ----------------------------
  PERFORM PREPARE_DISPLAY_LIST_F14.
*--- Spezielle Einstellung Vertragsliste f¨¹r Listviewer --------------
  PERFORM FILL_EVENT_TAB_L.
*--- ausgew#hlte Listfelder ermitteln f¨¹r dynamischen select ---------
  PERFORM UPDATE_FIELDCAT_VARIANT_F14.
  PERFORM CHECK_FIELDCAT_VARIANT_L.
*--- Selektion Vertr#ge
  PERFORM CHECK_VEDA_DATE_L.
  PERFORM SELECTION_L.
*---------------------------------------------------------------------*
* CLACULATE THE MEASURING POINT ESTIMATED RUNNING HOUR ACTUAL RUNNING *
* HOURS VARIANCE AND VARIANCE%  BASED ON THE GAP0062                  *
*---------------------------------------------------------------------*
  PERFORM MEASURE_CALCULATE.
*---------------------------------------------------------------------
* END-OF-SELECTION
*---------------------------------------------------------------------
END-OF-SELECTION.

* G_UCOMM = 'VETR'.
*--- Liste ausgeben --------------------------------------------------*
  PERFORM DISPLAY_LIST_F14 USING G_UCOMM.

*---------------------------------------------------------------------*
*       FORM USER_COMMAND_L                                           *
*---------------------------------------------------------------------*
*       will be called out of listviewer                              *
*---------------------------------------------------------------------*
*  -->  P_UCOMM                                                       *
*  -->  P_SELFIELD                                                    *
*---------------------------------------------------------------------*
FORM USER_COMMAND_L USING P_UCOMM LIKE SY-UCOMM
                          P_SELFIELD TYPE SLIS_SELFIELD.

  PERFORM SET_P_SELFIELD_GENERAL_F16 USING P_SELFIELD.

  P_SELFIELD-REFRESH = G_S.
  G_INDEX = P_SELFIELD-TABINDEX.

*--- globale Merkfelder l#schen
  CLEAR G_SDAUFNR.
  CLEAR G_POSNR.

*--- pf2 umbiegen je nach modus (Ausw#hlen/Anzeigen) ---------------
  PERFORM CHECK_PF2_WITH_OBJECT_F16 USING P_UCOMM.

*--- Fcode umbiegen bei Doppelcklick auf Meldungsnummer oder text --
  PERFORM CHECK_OBJECT_DISPLAY_F16 USING P_UCOMM
                                         P_SELFIELD
                                         'OBJECT_TAB-SDAUFNR'
                                         'VETR'.

  CASE P_UCOMM.
    WHEN G_OL0.
*--- Aktuelle Feldauswahl #ndern -------------------------------------
      PERFORM REFRESH_L USING P_SELFIELD.
    WHEN G_OLX.
*--- Feldauswahl #ndern ---------------------------------------------
      PERFORM REFRESH_L USING P_SELFIELD.
    WHEN G_OAD.
*--- Feldauswahl ausw#hlen ------------------------------------------
      PERFORM REFRESH_L USING P_SELFIELD.
    WHEN G_LIS.
*--- Grundliste aufbauen --------------------------------------------
      PERFORM REFRESH_L USING P_SELFIELD.
*   when g_eta.
*--- Quickinfo einblenden -------------------------------------------
*     perform select_for_quickinfo_l using p_selfield.
    WHEN 'AKTU'.
*--- Auffrischen ----------------------------------------------------
      P_SELFIELD-REFRESH = G_X.
      PERFORM SELECTION_L.
    WHEN 'IOBJ'.
*--- Objektstammsatz anzeigen ---------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
*      RIHVEDA = OBJECT_TAB.
* begin of change MOD-004
*     yam_rihveda = OBJECT_TAB.
      rihveda = object_tab.
* end of change MOD-004

      PERFORM MASTER_DATA_F16 USING P_UCOMM
                                    P_SELFIELD.
*--- Wegen doppelclick sicherstellen das F-Code nicht zweimal -------
      CLEAR P_UCOMM.
    WHEN 'IGRF'.
*--- Termingrafik mit Vertragsdaten ---------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM GRAFICS_L.
    WHEN 'EQAZ'.
*--- Equipmentliste -------------------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.

      PERFORM DISPLAY_EQUI_L.
    WHEN 'SEAZ'.
*--- Serialnummernliste -------------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM DISPLAY_SEAZ_L.
    WHEN 'BTAZ'.
*--- Materialliste ------------------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM DISPLAY_MARA_L.
    WHEN 'AUFK'.
*--- Auftragsliste ------------------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM DISPLAY_AUFK_L.
    WHEN 'MPOS'.
*--- Wartungspositionsliste ---------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM DISPLAY_MPOS_L.
    WHEN 'MUEQ'.
*--- mehrstufige Equipmentliste -----------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM MULTI_EQUI_L.
    WHEN 'MUAU'.
*--- mehrstufige Auftragsliste ------------------------------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM
                                                P_SELFIELD.
      PERFORM MULTI_AUFK_L.
    WHEN 'WV_MPOS'.
*--- Wartungspositionsliste zur selektierten Vertragsposition -----
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM P_SELFIELD.
      PERFORM DISPLAY_VEDA_L USING 'X' ' ' ' ' ' ' ' '.
    WHEN 'WV_MHIO'.
*--- Wartungstermine (Liste) zur selektierten Vertragsposition ----
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM P_SELFIELD.
      PERFORM DISPLAY_VEDA_L USING ' ' 'X' ' ' ' ' ' '.
    WHEN 'WV_MHIS'.
*--- Wartungstermine (Grafik) zur selektierten Vertragsposition ---
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM P_SELFIELD.
      PERFORM DISPLAY_VEDA_L USING ' ' ' ' 'X' ' ' ' '.
    WHEN 'WV_AUFK'.
*--- Auftragsliste zur selektierten Vertragsposition --------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM P_SELFIELD.
      PERFORM DISPLAY_VEDA_L USING ' ' ' ' ' ' 'X' ' '.
    WHEN 'WV_QMEL'.
*--- Meldungsliste zur selektierten Vertragsposition --------------
      PERFORM CHECK_OBJECT_TAB_MARKED_F14 USING P_UCOMM P_SELFIELD.
      PERFORM DISPLAY_VEDA_L USING ' ' ' ' ' ' ' ' 'X'.
    WHEN 'VETR'.
*--- Vertragsdetail ----------------------------------------------
      PERFORM FCODES_WITH_MARK_F16 USING P_UCOMM P_SELFIELD.
    WHEN 'IP04'.
*--- Termin¨¹bersicht Wartungsplan --------------------------------
      PERFORM FCODES_WITH_MARK_F16 USING P_UCOMM P_SELFIELD.
    WHEN 'KONF'.
*--- Konfiguration Vertragsposition anzeigen ---------------------
      PERFORM FCODES_WITH_MARK_F16 USING P_UCOMM P_SELFIELD.
    WHEN OTHERS.
*--- zentrale F-codes f¨¹r alle Listen -----------------------------
      PERFORM USER_COMMAND_F16 USING P_UCOMM P_SELFIELD.
  ENDCASE.
ENDFORM.                    "user_command_l

*eject
*---------------------------------------------------------------------*
*       FORM SELECTION_L                                              *
*---------------------------------------------------------------------*
*       Wartungsvertr#ge selektieren                                  *
*---------------------------------------------------------------------*
FORM SELECTION_L.

  DATA: H LIKE SY-TABIX.
  DATA: H_START_FLAG.


  REFRESH OBJECT_TAB.
  CLEAR   OBJECT_TAB.

*--- Gro# und Kleinschreibung bei Kurztext ignorieren ----------------
  SET LOCALE LANGUAGE SY-LANGU.
  LOOP AT ARKTX.
    TRANSLATE ARKTX-LOW TO UPPER CASE.                   "#EC TRANSLANG
    TRANSLATE ARKTX-HIGH TO UPPER CASE.                  "#EC TRANSLANG
    MODIFY ARKTX.
  ENDLOOP.
  LOOP AT BNAME.
    TRANSLATE BNAME-LOW TO UPPER CASE.                   "#EC TRANSLANG
    TRANSLATE BNAME-HIGH TO UPPER CASE.                  "#EC TRANSLANG
    MODIFY BNAME.
  ENDLOOP.
  LOOP AT BSTNK.
    TRANSLATE BSTNK-LOW TO UPPER CASE.                   "#EC TRANSLANG
    TRANSLATE BSTNK-HIGH TO UPPER CASE.                  "#EC TRANSLANG
    MODIFY BSTNK.
  ENDLOOP.

  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
    EXPORTING
      TEXT = 'Vertragsselektion'(207).

*--- Konvertierungsexit T.P. ber¨¹cksichtigen ------------------------*
  PERFORM CHECK_TPLNR_F16 TABLES STRNO
                                 TPLNR
                          USING  ' '.
*--- Einstieg in Selektion festlegen  -------------------------------*
  CLEAR SEL_TAB_HELP.
  REFRESH SEL_TAB_HELP.
*--- Sonderfall wenn Aufruf f¨¹r Auswahl ¨¹ber FB oder Matchcode
  IF G_SELMOD = SELMOD_1 OR G_SELMOD = SELMOD_X.
    IMPORT SEL_TAB_HELP FROM MEMORY ID 'RIVEDA'.
  ENDIF.
  FREE MEMORY ID 'RIVEDA'.

  DESCRIBE TABLE SEL_TAB_HELP LINES H_LINES.

  IF H_LINES = 0.
    PERFORM CHECK_START_L USING H_START_FLAG.
  ELSE.
    H_START_FLAG = 9.
  ENDIF.

  CASE H_START_FLAG.
    WHEN '1'.                          "Selekt. ¨¹ber Objektliste
      PERFORM SELECT_VIA_VISER02.
    WHEN '2'.                          "Selekt. ¨¹ber Vertr.kopf/pos
      PERFORM SELECT_VIA_VIVEDA.
    WHEN '3'.                          "Selekt. ¨¹ber Zusatzdat.Vertrag
      PERFORM SELECT_VIA_VEDA.
    WHEN '4'.                          "Selekt. ¨¹ber Bestelldaten
      PERFORM SELECT_VIA_VBKD.
    WHEN '9'.                          "Aufruf ¨¹ber Funktionsbaustein
      PERFORM ASSIGN_OBJECT_TAB.
    WHEN OTHERS.                       "keine Selekt.einschr#nkungen
      PERFORM SELECT_VIA_VEDA.
  ENDCASE.

*--- eventl.doppelte Eintr#ge in Object_tab aufgrund Selektion ¨¹ber --*
*--- Equi, Mat-Sernr, und T.P. l#schen                              --*
  DESCRIBE TABLE OBJECT_TAB LINES H.
  CHECK NOT H IS INITIAL.

  SORT OBJECT_TAB BY SDAUFNR POSNR EQUNR TPLNR.
  DELETE ADJACENT DUPLICATES FROM OBJECT_TAB COMPARING ALL FIELDS.

  PERFORM AUTHORITY-CHECK_L.
  PERFORM FILL_OBJECT_TAB_L.
*--- Defaultsortiertung wenn nichts ¨¹ber SALV eingestellt -----------
  SORT OBJECT_TAB BY SDAUFNR POSNR OBKNR.

ENDFORM.                    "selection_l

*eject
*---------------------------------------------------------------------*
*       FORM FCODES_WITH_MARK_L                                       *
*---------------------------------------------------------------------*
*       FCodes, die auch im Loop verarbeitet werden k#nnen            *
*---------------------------------------------------------------------*
FORM FCODES_WITH_MARK_L USING F_UCOMM LIKE SY-UCOMM
                              F_SELFIELD TYPE SLIS_SELFIELD.

  DATA: H_UCOMM LIKE SY-UCOMM.

  PERFORM MARK_SELECTED_F16 CHANGING OBJECT_TAB-SELECTED
                                     OBJECT_TAB-PM_SELECTED.
*--- Bei PF2 -> in Vertragskopf Springen -----------------------------*
  IF F_UCOMM = 'ISEL'.
    H_UCOMM = 'VETR'.
  ELSE.
    H_UCOMM = F_UCOMM.
  ENDIF.
  MOVE-CORRESPONDING OBJECT_TAB TO RIHVEDA.
  CASE H_UCOMM.
    WHEN OTHERS.
      PERFORM CALL_CONTRACT_L USING H_UCOMM.
  ENDCASE.

ENDFORM.                    "fcodes_with_mark_l

*eject
*---------------------------------------------------------------------*
*       FORM DISPLAY_AUFK_L                                           *
*---------------------------------------------------------------------*
*       Auftr#ge                                                      *
*---------------------------------------------------------------------*
FORM DISPLAY_AUFK_L.

  DATA: F_RETC LIKE SY-SUBRC.
  DATA: F_TCODE LIKE SY-TCODE VALUE 'IW73'.
*### Verarbeitung ####################################################*

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING F_TCODE
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_EQUI_L.
    IF NOT I_EQUNR IS INITIAL.
      EXPORT F_TCODE TO MEMORY ID 'RIAUFK20'.
      SUBMIT RIAUFK20 VIA SELECTION-SCREEN
                      WITH EQUNR IN I_EQUNR
                      WITH DY_OFN   = 'X'
                      WITH DY_IAR   = 'X'
                      WITH DY_MAB   = 'X'
                      WITH DY_HIS   = 'X'
                      WITH DY_TCODE = F_TCODE
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "display_aufk_l

*eject
*---------------------------------------------------------------------*
*       FORM DISPLAY_MPOS_L                                           *
*---------------------------------------------------------------------*
*       Wartungspositionen                                            *
*---------------------------------------------------------------------*
FORM DISPLAY_MPOS_L.

  DATA: F_RETC LIKE SY-SUBRC.
  DATA: F_TCODE LIKE SY-TCODE VALUE 'IP18'.

*### Verarbeitung ####################################################*

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING F_TCODE
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_EQUI_L.
    IF NOT I_EQUNR IS INITIAL.
      SUBMIT RIMPOS00 WITH EQUNR IN I_EQUNR
                      WITH DY_TCODE = F_TCODE
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "display_mpos_l

*eject
*---------------------------------------------------------------------*
*       FORM DISPLAY_VEDA_L                                           *
*---------------------------------------------------------------------*
*       weitere Objekte zur Vertragsposition                          *
*---------------------------------------------------------------------*
FORM DISPLAY_VEDA_L USING WOSEL  TYPE CHAR01 "Wartungspositionen
                          CASEL1 TYPE CHAR01 "Wartungstermine (Liste)
                          CASEL2 TYPE CHAR01 "Wartungstermine (Grafik)
                          AUFSEL TYPE CHAR01 "Auftr#ge
                          QMSEL  TYPE CHAR01. "Meldungen

* data: f_retc like sy-subrc.
* data: f_tcode like sy-tcode value 'IP18'.

*### Verarbeitung ####################################################*

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
* perform auth_check_tcode_f16 using f_tcode
*                              changing f_retc.
* if f_retc is initial.
  SUBMIT RIVEDA00 AND RETURN
    WITH WOSEL     EQ WOSEL
    WITH CASEL1    EQ CASEL1
    WITH CASEL2    EQ CASEL2
    WITH AUFSEL    EQ AUFSEL
    WITH QMSEL     EQ QMSEL
    WITH DATUV     EQ '00000000'
    WITH DATUB     EQ '99991231'
    WITH KDAUF     EQ OBJECT_TAB-SDAUFNR
    WITH KDPOS     EQ OBJECT_TAB-POSNR.
* endif.

ENDFORM.                    "display_veda_l

*eject
*---------------------------------------------------------------------*
*       FORM DISPLAY_EQUI_L                                           *
*---------------------------------------------------------------------*
*       Equipments                                                    *
*---------------------------------------------------------------------*
FORM DISPLAY_EQUI_L.

  DATA: F_RETC LIKE SY-SUBRC.
  DATA: F_TCODE LIKE SY-TCODE VALUE 'IH10'.
*### Verarbeitung ####################################################*

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING F_TCODE
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_EQUI_L.
    EXPORT F_TCODE TO MEMORY ID 'RIEQUI20'.
    IF NOT I_EQUNR IS INITIAL.
      SUBMIT RIEQUI20 WITH EQUNR IN I_EQUNR
                      WITH DY_TCODE = F_TCODE
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "display_equi_l
*eject
*---------------------------------------------------------------------*
*       FORM DISPLAY_SEAZ_L                                           *
*---------------------------------------------------------------------*
*       Serialnummern                                                 *
*---------------------------------------------------------------------*
FORM DISPLAY_SEAZ_L.

  DATA: F_RETC LIKE SY-SUBRC.
  DATA: F_TCODE LIKE SY-TCODE VALUE 'IQ09'.
*### Verarbeitung ####################################################*

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING F_TCODE
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_EQUI_L.
    IF NOT I_EQUNR IS INITIAL.
      SUBMIT RIEQUI21 WITH EQUNR IN I_EQUNR
                      WITH DY_TCODE = F_TCODE
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "display_seaz_l

*eject
*---------------------------------------------------------------------*
*       FORM MULTI_EQUI_l                                             *
*---------------------------------------------------------------------*
*       Equipments mehrstufig                                         *
*---------------------------------------------------------------------*
FORM MULTI_EQUI_L.

  DATA: F_RETC LIKE SY-SUBRC.

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING 'IE07'
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_EQUI_L.
    IF NOT I_EQUNR IS INITIAL.
      SUBMIT RIEQUI30 WITH EQUNR IN I_EQUNR
             VIA SELECTION-SCREEN
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "multi_equi_l

*eject
*---------------------------------------------------------------------*
*       FORM MULTI_AUFK_l                                             *
*---------------------------------------------------------------------*
*       Auftr#ge mehrstufig                                           *
*---------------------------------------------------------------------*
FORM MULTI_AUFK_L.

  DATA: F_RETC LIKE SY-SUBRC.

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING 'IW40'
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_EQUI_L.
    IF NOT I_EQUNR IS INITIAL.
      SUBMIT RIAUFK10 WITH EQUNR IN I_EQUNR
             VIA SELECTION-SCREEN
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "multi_aufk_l

*eject
*---------------------------------------------------------------------*
*       FORM DISPLAY_MARA_L                                           *
*---------------------------------------------------------------------*
*       Materialien                                                   *
*---------------------------------------------------------------------*
FORM DISPLAY_MARA_L.

*### Datenvereinbarungen #############################################*
  DATA: F_RETC LIKE SY-SUBRC.
  DATA: F_TCODE LIKE SY-TCODE VALUE 'IH09'.

*### Verarbeitung ####################################################*

*--- Berechtigungspr¨¹fung auf T-code ------------------------------*
  PERFORM AUTH_CHECK_TCODE_F16 USING F_TCODE
                               CHANGING F_RETC.
  IF F_RETC IS INITIAL.
    PERFORM CREATE_RANGE_MARA_L.
    IF NOT I_MATNR IS INITIAL.
      SUBMIT RIMARA20 WITH MS_MATNR IN I_MATNR
                      WITH DY_TCODE = F_TCODE
             AND RETURN.
    ENDIF.
  ENDIF.

ENDFORM.                    "display_mara_l

*eject
*---------------------------------------------------------------------*
*       FORM AUTHORITY-CHECK_L                                        *
*---------------------------------------------------------------------*
*       Berechtigungen pr¨¹fen                                         *
*---------------------------------------------------------------------*
FORM AUTHORITY-CHECK_L.

*### Datenvereinbarungen #############################################*
  DATA: H_NO_AUTH.
  DATA: H_AUTH.

*### Verarbeitung ####################################################*
  H_NO_AUTH = NO.
  LOOP AT OBJECT_TAB.
    H_AUTH = YES.
    PERFORM AUTH_L USING OBJECT_TAB-AUART
                         OBJECT_TAB-VKORG
                         OBJECT_TAB-VTWEG
                         OBJECT_TAB-SPART
                         '03'
                         H_AUTH.
    IF H_AUTH = NO.
      H_NO_AUTH = YES.
      DELETE OBJECT_TAB.
    ENDIF.
  ENDLOOP.

  IF H_NO_AUTH = YES.
    MESSAGE I046.
  ENDIF.

ENDFORM.                    "authority-check_l

*---------------------------------------------------------------------*
*       FORM AUTH_L                                                   *
*---------------------------------------------------------------------*
*       Berechtigungspr¨¹fungen                                        *
*---------------------------------------------------------------------*
*  -->  F_AUART                                                       *
*  -->  F_VKORG                                                       *
*  -->  F_VTWEG                                                       *
*  -->  F_SPART                                                       *
*  -->  F_AKTYP                                                       *
*  -->  F_AUTH                                                        *
*---------------------------------------------------------------------*
FORM AUTH_L USING
            F_AUART      LIKE RIHVEDA-AUART
            F_VKORG      LIKE RIHVEDA-VKORG
            F_VTWEG      LIKE RIHVEDA-VTWEG
            F_SPART      LIKE RIHVEDA-SPART
            F_AKTYP      TYPE C
            F_AUTH       TYPE CHAR01.

  AUTHORITY-CHECK OBJECT 'V_VBAK_AAT'
    ID 'AUART' FIELD F_AUART
    ID 'ACTVT' FIELD F_AKTYP.
  IF SY-SUBRC <> 0.
    F_AUTH = NO.
    EXIT.
  ENDIF.
  AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
       ID 'VKORG' FIELD F_VKORG
       ID 'VTWEG' FIELD F_VTWEG
       ID 'SPART' FIELD F_SPART
       ID 'ACTVT' FIELD F_AKTYP.
  IF SY-SUBRC <> 0.
    F_AUTH = NO.
    EXIT.
  ENDIF.

ENDFORM.                    "auth_l

*eject
*---------------------------------------------------------------------*
*       FORM CREATE_RANGE_EQUI_L                                      *
*---------------------------------------------------------------------*
*       Range mit selektierten Equipments                             *
*---------------------------------------------------------------------*
FORM CREATE_RANGE_EQUI_L.

  CLEAR I_EQUNR.
  REFRESH I_EQUNR.
  LOOP AT OBJECT_TAB WHERE SELECTED = G_X.
    PERFORM MARK_SELECTED_F16 CHANGING OBJECT_TAB-SELECTED
                                       OBJECT_TAB-PM_SELECTED.
    CHECK NOT OBJECT_TAB-EQUNR IS INITIAL.
    CLEAR I_EQUNR.
    I_EQUNR-OPTION = 'EQ'.
    I_EQUNR-SIGN   = 'I'.
    I_EQUNR-LOW    = OBJECT_TAB-EQUNR.
    COLLECT I_EQUNR.
  ENDLOOP.
  IF I_EQUNR IS INITIAL.
    MESSAGE I011.
  ENDIF.


ENDFORM.                    "create_range_equi_l

*eject
*---------------------------------------------------------------------*
*       FORM CREATE_RANGE_MARA_L                                      *
*---------------------------------------------------------------------*
*       Range mit selektierten Equipments                             *
*---------------------------------------------------------------------*
FORM CREATE_RANGE_MARA_L.

  CLEAR I_MATNR.
  REFRESH I_MATNR.
  LOOP AT OBJECT_TAB WHERE SELECTED = G_X.
    PERFORM MARK_SELECTED_F16 CHANGING OBJECT_TAB-SELECTED
                                       OBJECT_TAB-PM_SELECTED.
    CHECK NOT OBJECT_TAB-MATNR IS INITIAL.
    CLEAR I_MATNR.
    I_MATNR-OPTION = 'EQ'.
    I_MATNR-SIGN   = 'I'.
    I_MATNR-LOW    = OBJECT_TAB-MATNR.
    COLLECT I_MATNR.
  ENDLOOP.
  IF I_MATNR IS INITIAL.
    MESSAGE I011.
  ENDIF.

ENDFORM.                    "create_range_mara_l

*eject
*---------------------------------------------------------------------*
*       FORM  CALL_CONTRACT_L
*---------------------------------------------------------------------*
* Form um die Vertr#ge  zu aendern
*---------------------------------------------------------------------*
FORM CALL_CONTRACT_L USING
            F_UCOMM      LIKE SYST-UCOMM.

  DATA: H_AUTH(2).
  DATA: F_RETC       LIKE SY-SUBRC.
  DATA: H_RIHVEDA_WA LIKE RIHVEDA.

  CASE F_UCOMM.
    WHEN 'IP04'.
      SET PARAMETER ID 'EQN' FIELD  OBJECT_TAB-EQUNR.
      PERFORM AUTH_CHECK_TCODE_F16 USING 'IP04'
                                   CHANGING F_RETC.
      IF F_RETC IS INITIAL.
        CALL TRANSACTION 'IP04'.
      ENDIF.
    WHEN 'KONF'.
*--- nicht gleiche Position mehrmals hintereinander aufrufen
      CHECK NOT ( OBJECT_TAB-SDAUFNR = G_SDAUFNR AND
                  OBJECT_TAB-POSNR   = G_POSNR ).
      IF NOT OBJECT_TAB-CUOBJ IS INITIAL.
        H_RIHVEDA_WA = OBJECT_TAB.
        CALL FUNCTION 'PM_DISPLAY_KONFIG_CONTRACT'
          EXPORTING
            I_RIHVEDA     = H_RIHVEDA_WA
            I_NO_MESSAGES = SPACE.
      ELSE.
        MESSAGE I082 WITH OBJECT_TAB-SDAUFNR OBJECT_TAB-POSNR.
      ENDIF.
    WHEN OTHERS.
*--- nicht gleiche Position mehrmals hintereinander aufrufen
      CHECK NOT ( OBJECT_TAB-SDAUFNR = G_SDAUFNR AND
                  OBJECT_TAB-POSNR   = G_POSNR ).
      IF T370A-AKTYP = 'V'.
        SET PARAMETER ID 'KTN' FIELD  OBJECT_TAB-SDAUFNR.
        SET PARAMETER ID 'VPO' FIELD  OBJECT_TAB-POSNR.
*--- Berechtigungspr¨¹fung bei Loop ¨¹ber Object_tab durchgef¨¹hrt -----*
        CALL TRANSACTION 'VA42' AND SKIP FIRST SCREEN.
      ELSE.
        SET PARAMETER ID 'KTN' FIELD  OBJECT_TAB-SDAUFNR.
        SET PARAMETER ID 'VPO' FIELD  OBJECT_TAB-POSNR.
*--- Berechtigungspr¨¹fung bei Loop ¨¹ber Object_tab durchgef¨¹hrt -----*
        CALL TRANSACTION 'VA43' AND SKIP FIRST SCREEN.
      ENDIF.
  ENDCASE.
  G_SDAUFNR = OBJECT_TAB-SDAUFNR.
  G_POSNR   = OBJECT_TAB-POSNR.

ENDFORM.                    "call_contract_l

*### Grafik ##########################################################*

*### Datenvereinbarungen ############################################*

*----------------------------------------------------------------------*
* Definition der ITEM-Tabelle (Zeilen der Grafik)
*----------------------------------------------------------------------*

DATA: BEGIN OF ITEM OCCURS 1.
        INCLUDE STRUCTURE GGAIT.
DATA: END OF ITEM.

*----------------------------------------------------------------------*
* Definition der ELEM-Tabelle (Objekte in der Grafik)
*----------------------------------------------------------------------*

DATA: BEGIN OF ELEM OCCURS 1.
        INCLUDE STRUCTURE GGAEL.
DATA: END OF ELEM.
DATA: BEGIN OF LGEL OCCURS 1.
        INCLUDE STRUCTURE GGAEL.
DATA: END OF LGEL.
DATA: BEGIN OF DFEL OCCURS 1.
        INCLUDE STRUCTURE GGAEL.
DATA: END OF DFEL.

*----------------------------------------------------------------------*
* Definition der MIST-Tabelle (Objekte in der Grafik)
*----------------------------------------------------------------------*

DATA: BEGIN OF MIST OCCURS 1.
        INCLUDE STRUCTURE GGAMI.
DATA: END OF MIST.
DATA: BEGIN OF LGMS OCCURS 1.
        INCLUDE STRUCTURE GGAMI.
DATA: END OF LGMS.
DATA: BEGIN OF DFMS OCCURS 1.
        INCLUDE STRUCTURE GGAMI.
DATA: END OF DFMS.

*----------------------------------------------------------------------*
* Definition der Rueckmeldetabelle
*----------------------------------------------------------------------*

DATA: BEGIN OF BACK OCCURS 1.
        INCLUDE STRUCTURE GGABA.
DATA: END OF BACK.

*---------------------------------------------------------------------*
*       FORM GRAFICS_L                                                *
*---------------------------------------------------------------------*
*       Grafik aufrufen                                               *
*---------------------------------------------------------------------*
FORM GRAFICS_L.

*### Datenvereinbarungen ############################################*
  DATA: H_DUR LIKE GGAEL-DUR,
        H_TABIX LIKE SY-TABIX,
        H_SELEC,
        H_STRLEN     LIKE SY-FDPOS,
        H_STRLEN_TMP LIKE SY-FDPOS.


*### Verarbeitung ###################################################*

  REFRESH: ITEM,
           MIST,
           ELEM,
           LGEL,
           BACK.

  H_SELEC  = NO.
  H_TABIX  = 0.
  H_STRLEN = 0.

  LOOP AT OBJECT_TAB WHERE SELECTED = G_X.
    PERFORM MARK_SELECTED_F16 CHANGING OBJECT_TAB-SELECTED
                                       OBJECT_TAB-PM_SELECTED.
    H_SELEC = YES.
    H_TABIX = H_TABIX + 1.
    IF ( NOT OBJECT_TAB-VENDDAT IS INITIAL ) AND
       ( NOT OBJECT_TAB-VBEGDAT IS INITIAL ).
      H_DUR = OBJECT_TAB-VENDDAT - OBJECT_TAB-VBEGDAT.
      H_DUR = H_DUR * 24 * 60 * 60.
      PERFORM FILL_ELEM USING
                  H_TABIX              "Itemnummer
                  ' '                  "Balkenbeschriftung
                  OBJECT_TAB-VBEGDAT   "Beginndatum
                  '000000'             "Beginnuhrzeit
                  H_DUR                "Dauer
                  'S'                  "Zeiteinheit Dauer
                  'GREEN'              "Farbe Balken
                  '7'                  "Gr##e Balken
                  'U'.                 "Position Balken
    ENDIF.
    IF ( NOT OBJECT_TAB-VINSDAT IS INITIAL ) AND
       ( NOT OBJECT_TAB-VDEMDAT IS INITIAL ).
      H_DUR = OBJECT_TAB-VDEMDAT - OBJECT_TAB-VINSDAT.
      H_DUR = H_DUR * 24 * 60 * 60.
      PERFORM FILL_ELEM USING
                  H_TABIX              "Itemnummer
                  ' '                  "Balkenbeschriftung
                  OBJECT_TAB-VINSDAT   "Beginndatum
                  '000000'             "Beginnuhrzeit
                  H_DUR                "Dauer
                  'S'                  "Zeiteinheit Dauer
                  'RED'                "Farbe Balken
                  '7'                  "Gr##e Balken
                  'L'.                 "Position Balken
    ENDIF.
    WRITE OBJECT_TAB-SDAUFNR TO ITEM-ITEXT.
    WRITE OBJECT_TAB-POSNR TO ITEM-ITEXT+11 USING EDIT MASK '==ALPHA'.
    WRITE OBJECT_TAB-EQUNR TO ITEM-ITEXT+18.
    CONDENSE ITEM-ITEXT.
    H_STRLEN_TMP = STRLEN( ITEM-ITEXT ) + 2.
    IF H_STRLEN_TMP > H_STRLEN.
      H_STRLEN = H_STRLEN_TMP.
    ENDIF.
    APPEND ITEM.
  ENDLOOP.

  IF H_SELEC = NO.
    MESSAGE I011.
  ELSE.
    REFRESH BACK.
    DFEL-FILLD = '1'.
    DFEL-BRDON = '1'.
    CLEAR G_TTEXT.
    G_TTEXT-TYP     = TSTCT-TTEXT.
    G_TTEXT-FILLER = ':'.
    G_TTEXT-SELTEXT = 'Termin¨¹bersicht'(204).
    CONDENSE G_TTEXT.

*--- Legende aufbauen ----------------------------------------------*
    LGEL-ITEMNO = 1.
    LGEL-TXT = 'Vertragszeitraum'(202).
    LGEL-DUR = 60 * 60 * 24 * 5.
    LGEL-BAKGR = 'GREEN'.
    LGEL-HEIGH = 4.
    LGEL-PLACE = 'CENTER'.
    APPEND LGEL.
    LGEL-ITEMNO = 1.
    LGEL-TXT = 'Installationszeitraum'(201).
    LGEL-DUR = 60 * 60 * 24 * 5.
    LGEL-BAKGR = 'RED'.
    LGEL-HEIGH = 4.
    LGEL-PLACE = 'CENTER'.
    APPEND LGEL.

*--- PF-Status setzten (sichern inaktiv)
    CALL FUNCTION 'GRAPH_SET_CUA_STATUS'
      EXPORTING
        PROGRAM      = 'SAPLIESC'
        STATUS       = 'GANT'
      EXCEPTIONS
        INV_CUA_INFO = 1
        OTHERS       = 2.

    CALL FUNCTION 'GRAPH_GANTT'
      EXPORTING
        VGRID   = ' '
        HGRID   = 'X'
        TLENGTH = H_STRLEN
        WHEADER = G_TTEXT
        TTEXT   = 'Vertr#ge zu IH-Objekten'(205)
        LEGEND  = 'Legende'(206)
        NOTXT   = SPACE
        TUNIT   = 'M'
        DFEL    = DFEL
        DFMS    = DFMS
      TABLES
        ITEM    = ITEM
        MIST    = MIST
        ELEM    = ELEM
        LGMS    = MIST
        LGEL    = LGEL
        MSGT    = BACK.
  ENDIF.

ENDFORM.                    "grafics_l

*---------------------------------------------------------------------*
*       FORM FILL_ELEM                                                *
*---------------------------------------------------------------------*
*       Grafik-Balken erstellen                                       *
*---------------------------------------------------------------------*
*  -->  F_ITEMNO               Itemnummer                             *
*  -->  F_TEXT                 Balkentext                             *
*  -->  F_DBEG                 Beginntag                              *
*  -->  F_TBEG                 Beginnuhrzeit                          *
*  -->  F_F_DUR                  Dauer
*  -->  F_UNIT                 Zeiteinheit Dauer                      *
*  -->  f_COL                  Farbe Balken                           *
*  -->  F_SIZE                 Gr##e Balken                           *
*  -->  F_POS                  Position Balken                        *
*---------------------------------------------------------------------*
FORM FILL_ELEM USING
            F_ITEMNO     LIKE SYST-TABIX
            F_TEXT       TYPE C
            F_DBEG       LIKE RIHVEDA-VBEGDAT
            F_TBEG       TYPE C
            F_DUR        LIKE GGAEL-DUR
            F_UNIT       TYPE C
            F_COL        TYPE C
            F_SIZE       TYPE C
            F_POS        TYPE C.
*ORM FILL_ELEM USING F_ITEMNO F_TEXT F_DBEG F_TBEG
*                    F_DUR F_UNIT F_COL F_SIZE F_POS.

*### Datenvereinbarungen #############################################*
  DATA: T TYPE T,
        D TYPE D.

*### Verarbeitung ####################################################*
  ELEM-ITEMNO = F_ITEMNO.
  ELEM-TXT = F_TEXT.
  D = F_DBEG.
  T = F_TBEG.
  ELEM-BEG = ( D - DATE_NULL ) * 86400 + T.
  CASE F_UNIT.
    WHEN 'S'.
      ELEM-DUR = F_DUR.
    WHEN 'M'.
      ELEM-DUR = F_DUR * 60.
    WHEN 'H'.
      ELEM-DUR = F_DUR * 60 * 60.
    WHEN 'D'.
      ELEM-DUR = F_DUR * 60 * 60 * 24.
    WHEN 'W'.
      ELEM-DUR = F_DUR * 60 * 60 * 24 * 7.
    WHEN 'N'.
      ELEM-DUR = F_DUR * 60 * 60 * 24 * 30.
    WHEN 'Q'.
      ELEM-DUR = F_DUR * 60 * 60 * 24 * 90.
    WHEN 'Y'.
      ELEM-DUR = F_DUR * 60 * 60 * 24 * 365.
  ENDCASE.
  ELEM-BAKGR = F_COL.
  ELEM-HEIGH = F_SIZE.
  CASE F_POS.
    WHEN 'U'.
      ELEM-PLACE = 'OVER'.
    WHEN 'C'.
      ELEM-PLACE = 'CENTER'.
    WHEN 'L'.
      ELEM-PLACE = 'BELOW'.
  ENDCASE.
  CHECK ELEM-DUR > 0.
  APPEND ELEM.
ENDFORM.                    "fill_elem


*&---------------------------------------------------------------------*
*&      Form  FILL_OBJECT_TAB_L
*&---------------------------------------------------------------------*
*       Technische Pl#tze nachlesen ¨¹ber iloan                         *
*----------------------------------------------------------------------*
FORM FILL_OBJECT_TAB_L.

  TYPES: BEGIN OF LSTYPE_ILOAN_TPLNR,
           ILOAN LIKE IFLO-ILOAN,
           TPLNR LIKE IFLO-TPLNR,
         END OF LSTYPE_ILOAN_TPLNR,

         BEGIN OF LSTYPE_ILOAN,
           ILOAN LIKE ILOA-ILOAN,
         END OF LSTYPE_ILOAN.

  DATA: LT_ILOAN_TPLNR TYPE TABLE OF LSTYPE_ILOAN_TPLNR,
        LT_ILOAN       TYPE TABLE OF LSTYPE_ILOAN,
        LS_ILOAN       TYPE LSTYPE_ILOAN,
        LT_EQUNR       TYPE TABLE OF IREP1_EQUNR_WA,
        LS_EQUNR       TYPE IREP1_EQUNR_WA,
        LT_TPLNR       TYPE TABLE OF IREP1_TPLNR_WA,
        LS_TPLNR       TYPE IREP1_TPLNR_WA,
        LT_MATNR       TYPE TABLE OF IREP1_MATNR_WA,
        LS_MATNR       TYPE IREP1_MATNR_WA,
        L_EQKTX_FLAG   TYPE CHAR01,
        L_TPLNR_FLAG   TYPE CHAR01,
        L_PLTXT_FLAG   TYPE CHAR01,
        L_MAKTX_FLAG   TYPE CHAR01.

  FIELD-SYMBOLS: <LS_OBJECT_TAB>  LIKE LINE OF OBJECT_TAB[],
                 <LS_ILOAN_TPLNR> TYPE LSTYPE_ILOAN_TPLNR.

*--- only if object_tab is filled
  IF OBJECT_TAB[] IS INITIAL.
    EXIT.
  ENDIF.

*--- Sort for binary search
  SORT G_FIELDCAT_TAB BY FIELDNAME.

*--- Texts for Equi, f.loc, Material only if on list
  PERFORM CHECK_FIELD_DISPLAY_F14 USING 'EQKTX' L_EQKTX_FLAG.
  PERFORM CHECK_FIELD_DISPLAY_F14 USING 'TPLNR' L_TPLNR_FLAG.
  PERFORM CHECK_FIELD_DISPLAY_F14 USING 'PLTXT' L_PLTXT_FLAG.
  PERFORM CHECK_FIELD_DISPLAY_F14 USING 'MAKTX' L_MAKTX_FLAG.

*--- if object must be checked or Text for func.loc. TPLNR must be read.
  IF G_CHECK_OBJECT_LATE = G_X OR L_PLTXT_FLAG = YES.
    L_TPLNR_FLAG = YES.
  ENDIF.

*--- fill prefetch tables
  IF L_EQKTX_FLAG = YES OR
     L_TPLNR_FLAG = YES OR
     L_MAKTX_FLAG = YES.
    LOOP AT OBJECT_TAB ASSIGNING <LS_OBJECT_TAB>.
      IF L_TPLNR_FLAG = YES AND NOT <LS_OBJECT_TAB>-ILOAN IS INITIAL.
        LS_ILOAN-ILOAN = <LS_OBJECT_TAB>-ILOAN.
        COLLECT LS_ILOAN INTO LT_ILOAN.
      ENDIF.

      IF L_EQKTX_FLAG = YES AND NOT <LS_OBJECT_TAB>-EQUNR IS INITIAL.
        LS_EQUNR-EQUNR = <LS_OBJECT_TAB>-EQUNR.
        COLLECT LS_EQUNR INTO LT_EQUNR.
      ENDIF.

      IF L_MAKTX_FLAG = YES AND NOT <LS_OBJECT_TAB>-MATNR IS INITIAL.
        LS_MATNR-MATNR = <LS_OBJECT_TAB>-MATWA.
        COLLECT LS_MATNR INTO LT_MATNR.
      ENDIF.

    ENDLOOP.
  ENDIF.

*--- read TPLNR from ILOA
  IF NOT LT_ILOAN IS INITIAL.
    SELECT ILOAN TPLNR FROM ILOA INTO TABLE LT_ILOAN_TPLNR
                       FOR ALL ENTRIES IN LT_ILOAN
                       WHERE ILOAN = LT_ILOAN-ILOAN.
    SORT LT_ILOAN_TPLNR BY ILOAN.
    IF L_PLTXT_FLAG = YES.
      LOOP AT LT_ILOAN_TPLNR ASSIGNING <LS_ILOAN_TPLNR>.
        LS_TPLNR-TPLNR =  <LS_ILOAN_TPLNR>-TPLNR.
        COLLECT LS_TPLNR INTO LT_TPLNR.
      ENDLOOP.
    ENDIF.
  ENDIF.

*--- prefetch Texts for functional location
  IF L_PLTXT_FLAG = YES.
    CALL FUNCTION 'IREP1_LOCATION_TEXT_PRE_FETCH'
      TABLES
        TPLNR_TAB     = LT_TPLNR
      EXCEPTIONS
        NO_TEXT_FOUND = 1
        OTHERS        = 2.
  ENDIF.

*--- prefetch Texts for equipment
  IF L_EQKTX_FLAG = YES.
    CALL FUNCTION 'IREP1_EQUIPMENT_TEXT_PRE_FETCH'
      TABLES
        EQUNR_TAB     = LT_EQUNR
      EXCEPTIONS
        NO_TEXT_FOUND = 1
        OTHERS        = 2.
  ENDIF.

*--- prefetch Texts for equipment
  IF L_MAKTX_FLAG = YES.
    CALL FUNCTION 'IREP1_MATERIAL_TEXT_PRE_FETCH'
      TABLES
        MATNR_TAB     = LT_MATNR
      EXCEPTIONS
        NO_TEXT_FOUND = 1
        OTHERS        = 2.
  ENDIF.

*--- currency for convertion
  IF WAERS IS INITIAL.
    READ TABLE OBJECT_TAB ASSIGNING <LS_OBJECT_TAB> INDEX 1.
    WAERS = <LS_OBJECT_TAB>-WAERK.
  ENDIF.

*--- fill fields in object_tab
  LOOP AT OBJECT_TAB ASSIGNING <LS_OBJECT_TAB>.
*--- fill functional location
    IF L_TPLNR_FLAG = YES AND NOT <LS_OBJECT_TAB>-ILOAN IS INITIAL.
      READ TABLE LT_ILOAN_TPLNR ASSIGNING <LS_ILOAN_TPLNR>
                                WITH KEY ILOAN = <LS_OBJECT_TAB>-ILOAN
                                BINARY SEARCH.
      IF SY-SUBRC IS INITIAL.
        MOVE  <LS_ILOAN_TPLNR>-TPLNR TO <LS_OBJECT_TAB>-TPLNR_INT.
        WRITE <LS_ILOAN_TPLNR>-TPLNR TO <LS_OBJECT_TAB>-TPLNR.
      ENDIF.
    ENDIF.

*--- check for object late ( if object list was not used)
    IF G_CHECK_OBJECT_LATE = G_X.
      IF NOT <LS_OBJECT_TAB>-TPLNR_INT IN TPLNR OR
         NOT <LS_OBJECT_TAB>-EQUNR IN EQUNR OR
         NOT <LS_OBJECT_TAB>-MATNR IN MATNR OR
         NOT <LS_OBJECT_TAB>-SERNR IN SERNR.
        DELETE OBJECT_TAB.
        CONTINUE.
      ENDIF.
    ENDIF.

*--- fill functional location text
    IF L_PLTXT_FLAG = YES AND NOT <LS_OBJECT_TAB>-TPLNR_INT IS INITIAL.
      CALL FUNCTION 'IREP1_LOCATION_TEXT_READ'
        EXPORTING
          I_TPLNR       = <LS_OBJECT_TAB>-TPLNR_INT
        IMPORTING
          E_PLTXT       = <LS_OBJECT_TAB>-PLTXT
        EXCEPTIONS
          NO_TEXT_FOUND = 1
          OTHERS        = 2.
    ENDIF.

*--- fill equipment text
    IF L_EQKTX_FLAG = YES AND NOT <LS_OBJECT_TAB>-EQUNR IS INITIAL.
      CALL FUNCTION 'IREP1_EQUIPMENT_TEXT_READ'
        EXPORTING
          I_EQUNR       = <LS_OBJECT_TAB>-EQUNR
        IMPORTING
          E_EQKTX       = <LS_OBJECT_TAB>-EQKTX
        EXCEPTIONS
          NO_TEXT_FOUND = 1
          OTHERS        = 2.

    ENDIF.

*--- fill material text
    IF L_MAKTX_FLAG = YES AND NOT <LS_OBJECT_TAB>-MATWA IS INITIAL.
      CALL FUNCTION 'IREP1_MATERIAL_TEXT_READ'
        EXPORTING
          I_MATNR       = <LS_OBJECT_TAB>-MATWA
        IMPORTING
          E_MAKTX       = <LS_OBJECT_TAB>-MAKTX
        EXCEPTIONS
          NO_TEXT_FOUND = 1
          OTHERS        = 2.
    ENDIF.

*--- convert currency
    IF WAERS <> <LS_OBJECT_TAB>-WAERK.
      CALL FUNCTION 'CONVERT_TO_LOCAL_CURRENCY'
        EXPORTING
          DATE             = SY-DATLO
          FOREIGN_AMOUNT   = <LS_OBJECT_TAB>-NETPR
          FOREIGN_CURRENCY = <LS_OBJECT_TAB>-WAERK
          LOCAL_CURRENCY   = WAERS
        IMPORTING
          LOCAL_AMOUNT     = <LS_OBJECT_TAB>-NETPR
        EXCEPTIONS
          NO_RATE_FOUND    = 01
          OVERFLOW         = 02.

      CALL FUNCTION 'CONVERT_TO_LOCAL_CURRENCY'
        EXPORTING
          DATE             = SY-DATLO
          FOREIGN_AMOUNT   = <LS_OBJECT_TAB>-NETWRX
          FOREIGN_CURRENCY = <LS_OBJECT_TAB>-WAERK
          LOCAL_CURRENCY   = WAERS
        IMPORTING
          LOCAL_AMOUNT     = <LS_OBJECT_TAB>-NETWRX
        EXCEPTIONS
          NO_RATE_FOUND    = 01
          OVERFLOW         = 02.

      <LS_OBJECT_TAB>-WAERK = WAERS.
    ENDIF.

  ENDLOOP.

ENDFORM.                               " FILL_OBJECT_TAB_L
*&---------------------------------------------------------------------*
*&      Form  CHECK_START_L
*&---------------------------------------------------------------------*
*       Prim#reinstieg festlegen                                      *
*----------------------------------------------------------------------*
FORM CHECK_START_L USING H_FLAG TYPE CHAR01.

*--- Es gibt vier Einstiegsm#glichkeiten:                           --*
*       1. #ber Objektliste (Viser02), VIVEDA und VEDA nachlesen    --*
*       2. #ber Vertragskopf/pos (VIVEDA), VISER02 und VEDA nachlesen-*
*       3. #ber Vertragszus.Daten (VEDA), VISER02 unb VIVEDA NACHLESEN*
*       4. #ber Kaufm Daten (VBKD) -> nur Bei Bestelldaten          --*
  DATA: H LIKE SY-TABIX.
  DATA: POSS_1 VALUE '1',
        POSS_2 VALUE '2',
        POSS_3 VALUE '3',
        POSS_4 VALUE '4'.

  CLEAR H_FLAG.

*--- M#glichkeit ¨¹ber ILOA ------------------------------------------*

*--- Bei Selektion ¨¹ber T.P's werden ILOAN's ben#tigt wegen VISER02  *
  PERFORM USE_OBJECT_LIST_L USING TPLNR[] H_FLAG.
  PERFORM USE_OBJECT_LIST_L USING EQUNR[] H_FLAG.
  PERFORM USE_OBJECT_LIST_L USING MATNR[] H_FLAG.
  PERFORM USE_OBJECT_LIST_L USING SERNR[] H_FLAG.

  IF H_FLAG = YES.
    H_FLAG = POSS_1.
  ELSEIF H_FLAG = NO.
    CLEAR H_FLAG.
    G_CHECK_OBJECT_LATE = G_X.
  ENDIF.

  CHECK H_FLAG IS INITIAL.

*--- M#glichkeit ¨¹ber Bestelldaten ----------------------------------

  DESCRIBE TABLE BSTNK  LINES H.
  IF H > 0. H_FLAG = POSS_4. ENDIF.
  DESCRIBE TABLE BSTDK  LINES H.
  IF H > 0. H_FLAG = POSS_4. ENDIF.
  DESCRIBE TABLE BSARK  LINES H.
  IF H > 0. H_FLAG = POSS_4. ENDIF.
  DESCRIBE TABLE IHREZ  LINES H.
  IF H > 0. H_FLAG = POSS_4. ENDIF.

  CHECK H_FLAG IS INITIAL.

*--- M#glichkeit ¨¹ber Auftragsdaten ------------------------------*
  DESCRIBE TABLE BSTZD  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.

  DESCRIBE TABLE SDAUFNR LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE POSNR LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE AUART LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MATWA LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE AUGRU LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MATKL LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MVGR1 LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MVGR2 LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MVGR3 LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MVGR4 LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MVGR5 LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE NETWRX LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE CHARG  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE SUBMI  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE KUNNR  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE BNAME  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE TELF1  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE UEPOS  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE ARKTX  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE PSTYV  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE ABGRU  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE PRODH  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE ZMENG  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE MEINS LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE KDMAT  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE POSEX  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE SPART  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VGBEL  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VGPOS  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE WERKS  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE EAN11  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VKORG  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VTWEG  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VKGRP  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VKBUR  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE VBEGREG LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.
  DESCRIBE TABLE ERNAM  LINES H.
  IF H > 0. H_FLAG = POSS_2. ENDIF.

  CHECK H_FLAG IS INITIAL.

*--- M#glichkeit Vertragsdaten -----------------------------------*

  DESCRIBE TABLE VBEGDAT LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VENDDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VUNTDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VINSDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VABNDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VDEMDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VKUESCH  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VKUEGRU  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VBELKUE  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VWUNDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VKUEPAR  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VEINDAT  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VBEDKUE  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VAKTSCH  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VVORZEIT LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VBEGREG  LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VLAUFK   LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.
  DESCRIBE TABLE VLAUFZ   LINES H.
  IF H > 0. H_FLAG = POSS_3. ENDIF.

ENDFORM.                               " CHECK_START_L


*&---------------------------------------------------------------------*
*&      Form  SELECT_VIA_VISER02
*&---------------------------------------------------------------------*
*       Datenselektion, Einstieg ¨¹ber Ojektliste                       *
*----------------------------------------------------------------------*
FORM SELECT_VIA_VISER02.

  TYPES: BEGIN OF LSTYPE_ILOAN,
           ILOAN TYPE ILOAN,
         END OF LSTYPE_ILOAN,

         BEGIN OF LSTYPE_VBELN,
           VBELN TYPE VBELN_VA,
         END OF LSTYPE_VBELN,

         BEGIN OF LSTYPE_VBKD,
           VBELN LIKE VBKD-VBELN,
           POSNR LIKE VBKD-POSNR,
           BSTKD LIKE VBKD-BSTKD,
           BSTDK LIKE VBKD-BSTDK,
           BSARK LIKE VBKD-BSARK,
           IHREZ LIKE VBKD-IHREZ,
         END OF LSTYPE_VBKD.

  CONSTANTS: L_VPOSN LIKE VEDA-VPOSN VALUE '000000'.

  DATA: LT_ILOAN   TYPE TABLE OF LSTYPE_ILOAN,
        LT_VISER02 TYPE TABLE OF VISER02,
        LT_VIVEDA  TYPE TABLE OF VIVEDA,
        LS_VIVEDA  TYPE VIVEDA,
        LT_VBELN   TYPE TABLE OF LSTYPE_VBELN,
        LS_VBELN   TYPE LSTYPE_VBELN,
        LT_VEDA    TYPE TABLE OF VEDA,
        LT_VBKD    TYPE TABLE OF LSTYPE_VBKD,
        L_ARKTX    LIKE VIVEDA-ARKTX,
        L_BNAME    LIKE VIVEDA-BNAME,
        L_VBELN    LIKE VEDA-VBELN.                         "#EC NEEDED

  RANGES: LR_OWNER FOR ILOA-OWNER.

  FIELD-SYMBOLS: <LS_VISER02> TYPE VISER02,
                 <LS_VIVEDA>  TYPE VIVEDA,
                 <LS_VEDA>    TYPE VEDA,
                 <LS_VBKD>    TYPE LSTYPE_VBKD.

*--- if functional location is used -> search with ILOAN
  IF NOT TPLNR[] IS INITIAL.
    LR_OWNER-SIGN   = 'I'.
    LR_OWNER-OPTION = 'EQ'.
    LR_OWNER-LOW    = ' '.
    APPEND LR_OWNER.
    LR_OWNER-LOW    = '2'.
    APPEND LR_OWNER.

    SELECT ILOAN FROM ILOA INTO TABLE LT_ILOAN
                 WHERE TPLNR IN TPLNR
                 AND   OWNER IN LR_OWNER.

*--- if search for funct. loc. = INITIAL or with Exluding
*--- select objects without ILOAN too
    LOOP AT TPLNR.
      IF ( TPLNR-SIGN   = 'I'  AND
           TPLNR-OPTION = 'EQ' AND
           TPLNR-LOW    IS INITIAL )
         OR
         ( TPLNR-SIGN   = 'I'  AND
           TPLNR-OPTION = 'NE' AND
           NOT TPLNR-LOW IS INITIAL )
         OR
         ( TPLNR-SIGN   = 'E'  AND
           NOT TPLNR-LOW IS INITIAL ).
        APPEND SPACE TO LT_ILOAN.
        EXIT.
      ENDIF.
    ENDLOOP.

    IF LT_ILOAN IS INITIAL.                                 "P6BK128985
*---- nothing found -> leave
      EXIT.                                                 "P6BK128985
    ENDIF.                                                  "P6BK128985

    SELECT * FROM VISER02 INTO TABLE LT_VISER02
             FOR ALL ENTRIES IN LT_ILOAN
             WHERE ILOAN  = LT_ILOAN-ILOAN
             AND   EQUNR IN EQUNR
             AND   MATNR IN MATNR
             AND   SERNR IN SERNR
             AND   OBJVW <> 'A'
             AND   TASER = 'SER02'.

*--- serch with equipment, material and serial number
  ELSEIF NOT EQUNR[] IS INITIAL OR
         NOT MATNR[] IS INITIAL OR
         NOT SERNR[] IS INITIAL.

    SELECT * FROM VISER02 INTO TABLE LT_VISER02
             WHERE EQUNR IN EQUNR
             AND   MATNR IN MATNR
             AND   SERNR IN SERNR
             AND   OBJVW <> 'A'
             AND   TASER = 'SER02'.
  ENDIF.

*--- nothing found -> leave
  IF LT_VISER02 IS INITIAL.
    EXIT.
  ENDIF.

*--- Vertragskopf/pos-Daten nachlesen -------------------------------*
  SELECT * FROM VIVEDA INTO TABLE LT_VIVEDA
           FOR ALL ENTRIES IN LT_VISER02
           WHERE VBELN       = LT_VISER02-SDAUFNR
           AND   POSNR       = LT_VISER02-POSNR
           AND   VBELN      IN SDAUFNR
           AND   POSNR      IN POSNR
           AND   AUART      IN AUART
           AND   AUGRU      IN AUGRU
           AND   ERNAM      IN ERNAM
           AND   SUBMI      IN SUBMI
           AND   VKORG      IN VKORG
           AND   VTWEG      IN VTWEG
           AND   VKGRP      IN VKGRP
           AND   VKBUR      IN VKBUR
           AND   BSTZD      IN BSTZD
           AND   TELF1      IN TELF1
           AND   KUNNR      IN KUNNR
           AND   MATWA      IN MATWA
           AND   CHARG      IN CHARG
           AND   MATKL      IN MATKL
           AND   PSTYV      IN PSTYV
           AND   UEPOS      IN UEPOS
           AND   ABGRU      IN ABGRU
           AND   PRODH      IN PRODH
           AND   ZMENG      IN ZMENG
           AND   MEINS      IN MEINS
           AND   KDMAT      IN KDMAT
           AND   POSEX      IN POSEX
           AND   SPART      IN SPART
           AND   NETWRX     IN NETWRX
           AND   VGBEL      IN VGBEL
           AND   VGPOS      IN VGPOS
           AND   WERKS      IN WERKS
           AND   EAN11      IN EAN11
           AND   MVGR1      IN MVGR1
           AND   MVGR2      IN MVGR2
           AND   MVGR3      IN MVGR3
           AND   MVGR4      IN MVGR4
           AND   MVGR5      IN MVGR5
           AND   VBTYP      EQ VBTYP_KONT.

  LOOP AT LT_VIVEDA ASSIGNING <LS_VIVEDA>.
    L_ARKTX = <LS_VIVEDA>-ARKTX.
    TRANSLATE L_ARKTX TO UPPER CASE.                     "#EC TRANSLANG
    IF NOT L_ARKTX IN ARKTX.
      DELETE LT_VIVEDA.
      CONTINUE.
    ENDIF.

    L_BNAME = <LS_VIVEDA>-BNAME.
    TRANSLATE L_BNAME TO UPPER CASE.                     "#EC TRANSLANG
    IF NOT L_BNAME IN BNAME.
      DELETE LT_VIVEDA.
      CONTINUE.
    ENDIF.

    LS_VBELN-VBELN = <LS_VIVEDA>-VBELN.
    COLLECT LS_VBELN INTO LT_VBELN.
  ENDLOOP.

  CHECK NOT LT_VIVEDA IS INITIAL.
  SORT LT_VIVEDA BY VBELN POSNR.

*--- Zusatzdaten zu Vertrag nachlesen --------------------------------*
  SELECT * FROM VEDA INTO TABLE LT_VEDA
           FOR ALL ENTRIES IN LT_VBELN
           WHERE VBELN     = LT_VBELN-VBELN
           AND   VLAUFK   IN VLAUFK
           AND   VINSDAT  IN VINSDAT
           AND   VABNDAT  IN VABNDAT
           AND   VBEGDAT  IN VBEGDAT
           AND   VUNTDAT  IN VUNTDAT
           AND   VKUESCH  IN VKUESCH
           AND   VAKTSCH  IN VAKTSCH
           AND   VEINDAT  IN VEINDAT
           AND   VWUNDAT  IN VWUNDAT
           AND   VKUEPAR  IN VKUEPAR
           AND   VKUEGRU  IN VKUEGRU
           AND   VENDDAT  IN VENDDAT
           AND   VBELKUE  IN VBELKUE
           AND   VBEDKUE  IN VBEDKUE
           AND   VBEGREG  IN VBEGREG
           AND   VVORZEIT IN VVORZEIT
           AND   VDEMDAT  IN VDEMDAT.

  SORT LT_VEDA BY VBELN VPOSN.

*--- Kaufm. Daten lesen ----------------------------------------------*
  SELECT VBELN POSNR BSTKD BSTDK BSARK IHREZ
          FROM VBKD INTO CORRESPONDING FIELDS OF TABLE LT_VBKD
          FOR ALL ENTRIES IN LT_VBELN
          WHERE VBELN    = LT_VBELN-VBELN
          AND   BSTKD_M IN BSTNK
          AND   BSTDK   IN BSTDK
          AND   BSARK   IN BSARK
          AND   IHREZ   IN IHREZ.

  CHECK SY-SUBRC IS INITIAL.
  SORT LT_VBKD BY VBELN POSNR.

*--- jetzt gehts rund -> Tabellen werden zur Object_tab zus.gestellt--*
  LOOP AT LT_VISER02 ASSIGNING <LS_VISER02>.
    CLEAR OBJECT_TAB.
*--- allgemeine Vertragsdaten lesen --------------------------------*
    READ TABLE LT_VIVEDA ASSIGNING <LS_VIVEDA>
                         WITH KEY VBELN = <LS_VISER02>-SDAUFNR
                                  POSNR = <LS_VISER02>-POSNR
                         BINARY SEARCH.
    IF SY-SUBRC IS INITIAL.
      MOVE-CORRESPONDING <LS_VISER02> TO OBJECT_TAB.        "#EC ENHOK
      MOVE-CORRESPONDING <LS_VIVEDA>  TO OBJECT_TAB.        "#EC ENHOK
*--- VEDA zur Vertragsposition suchen ------------------------------*
      READ TABLE LT_VEDA ASSIGNING <LS_VEDA>
                         WITH KEY VBELN = <LS_VIVEDA>-VBELN
                                  VPOSN = <LS_VIVEDA>-POSNR
                         BINARY SEARCH.
      IF NOT SY-SUBRC IS INITIAL.
*--- Es gibt keine VEDA zur Position --> VEDA zum Vert.Kopf nehmen---*
        READ TABLE LT_VEDA ASSIGNING <LS_VEDA>
                           WITH KEY VBELN = <LS_VIVEDA>-VBELN
                                    VPOSN = L_VPOSN
                           BINARY SEARCH.
        IF SY-SUBRC IS INITIAL.
*    nochmals pr¨¹fen, ob wirklich keine veda f¨¹r posnr vorhanden (k#nnte
*    auch nur wegen select-options nicht selektiert worden sein)
          SELECT SINGLE VBELN FROM VEDA              "#EC CI_SEL_NESTED
                              INTO L_VBELN
                              WHERE VBELN = <LS_VIVEDA>-VBELN
                              AND   VPOSN = <LS_VIVEDA>-POSNR.
          IF SY-SUBRC IS INITIAL.
            CONTINUE.
          ENDIF.
        ELSE.
*--- Es gibt ¨¹berhaupt keine VEDA --> kein Service-Vertrag ----------*
          CONTINUE.
        ENDIF.
      ENDIF.
      MOVE-CORRESPONDING <LS_VEDA> TO OBJECT_TAB.           "#EC ENHOK
*--- Bestelldaten hinzulesen ----------------------------------------*
      READ TABLE LT_VBKD ASSIGNING <LS_VBKD>
                         WITH KEY VBELN = <LS_VIVEDA>-VBELN
                                  POSNR = <LS_VIVEDA>-POSNR
                         BINARY SEARCH.
      IF NOT SY-SUBRC IS INITIAL.
        READ TABLE LT_VBKD ASSIGNING <LS_VBKD>
                           WITH KEY VBELN = <LS_VIVEDA>-VBELN
                                    POSNR = L_VPOSN
                           BINARY SEARCH.
      ENDIF.
      IF SY-SUBRC IS INITIAL.
        MOVE-CORRESPONDING <LS_VBKD> TO OBJECT_TAB.         "#EC ENHOK
        MOVE <LS_VBKD>-BSTKD         TO OBJECT_TAB-BSTNK.
      ENDIF.
*--- Beleg und Pos immer aus h_viveda
      MOVE <LS_VIVEDA>-VBELN TO OBJECT_TAB-SDAUFNR.
      MOVE <LS_VIVEDA>-POSNR TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDIF.
  ENDLOOP.

ENDFORM.                               " SELECT_VIA_VISER02


*&---------------------------------------------------------------------*
*&      Form  SELECT_VIA_VIVEDA
*&---------------------------------------------------------------------*
*       Datenselektion, Einstieg ¨¹ber Vertragsview                     *
*----------------------------------------------------------------------*
FORM SELECT_VIA_VIVEDA.


  DATA: BEGIN OF H_VISER02 OCCURS 100.
          INCLUDE STRUCTURE VISER02.
  DATA: END OF H_VISER02.

  DATA: BEGIN OF H_VIVEDA OCCURS 100.
          INCLUDE STRUCTURE VIVEDA.
  DATA: END OF H_VIVEDA.

  DATA: BEGIN OF H_VEDA OCCURS 100.
          INCLUDE STRUCTURE VEDA.
  DATA: END OF H_VEDA.

  DATA: BEGIN OF H_VBKD_TAB OCCURS 100,
         VBELN LIKE VBKD-VBELN,
         POSNR LIKE VBKD-POSNR,
         BSTKD LIKE VBKD-BSTKD,
         BSTDK LIKE VBKD-BSTDK,
         BSARK LIKE VBKD-BSARK,
         IHREZ LIKE VBKD-IHREZ,
        END OF H_VBKD_TAB.

  DATA: BEGIN OF H_VBELN_TAB OCCURS 100,
         VBELN LIKE VBAK-VBELN,
        END OF H_VBELN_TAB.

  DATA: H_ARKTX LIKE VIVEDA-ARKTX.
  DATA: H_BNAME LIKE VIVEDA-BNAME.
  DATA: H_VPOSN LIKE VEDA-VPOSN VALUE '000000'.
  DATA: H_VBELN LIKE VEDA-VBELN.

  RANGES: R_SDAUFNR FOR VISER02-SDAUFNR.
  RANGES: R_SDAUFNR_TEMP FOR VISER02-SDAUFNR.

  REFRESH: H_VISER02,
           H_VIVEDA,
           H_VEDA.

*--- Vertragskopf/pos-Daten lesen -----------------------------------*
  SELECT * FROM VIVEDA
                   WHERE VBELN      IN SDAUFNR
                   AND   POSNR      IN POSNR
                   AND   AUART      IN AUART
                   AND   AUGRU      IN AUGRU
                   AND   ERNAM      IN ERNAM
                   AND   SUBMI      IN SUBMI
                   AND   VKORG      IN VKORG
                   AND   VTWEG      IN VTWEG
                   AND   VKGRP      IN VKGRP
                   AND   VKBUR      IN VKBUR
                   AND   BSTZD      IN BSTZD
                   AND   TELF1      IN TELF1
                   AND   KUNNR      IN KUNNR
                   AND   MATWA      IN MATWA
                   AND   CHARG      IN CHARG
                   AND   MATKL      IN MATKL
                   AND   PSTYV      IN PSTYV
                   AND   UEPOS      IN UEPOS
                   AND   ABGRU      IN ABGRU
                   AND   PRODH      IN PRODH
                   AND   ZMENG      IN ZMENG
                   AND   MEINS      IN MEINS
                   AND   KDMAT      IN KDMAT
                   AND   POSEX      IN POSEX
                   AND   SPART      IN SPART
                   AND   NETWRX     IN NETWRX
                   AND   VGBEL      IN VGBEL
                   AND   VGPOS      IN VGPOS
                   AND   WERKS      IN WERKS
                   AND   EAN11      IN EAN11
                   AND   MVGR1      IN MVGR1
                   AND   MVGR2      IN MVGR2
                   AND   MVGR3      IN MVGR3
                   AND   MVGR4      IN MVGR4
                   AND   MVGR5      IN MVGR5
                   AND   VBTYP      EQ VBTYP_KONT.
    H_ARKTX = VIVEDA-ARKTX.
    TRANSLATE H_ARKTX TO UPPER CASE.                     "#EC TRANSLANG
    CHECK H_ARKTX IN ARKTX.
    H_BNAME = VIVEDA-BNAME.
    TRANSLATE H_BNAME TO UPPER CASE.                     "#EC TRANSLANG
    CHECK H_BNAME IN BNAME.
    H_VIVEDA = VIVEDA.
    APPEND H_VIVEDA.
    R_SDAUFNR-LOW = VIVEDA-VBELN.
    R_SDAUFNR-SIGN = 'I'.
    R_SDAUFNR-OPTION = 'EQ'.
    COLLECT R_SDAUFNR.
  ENDSELECT.

  CHECK NOT H_VIVEDA[] IS INITIAL.
*--- Zusatzdaten zu Vertrag nachlesen --------------------------------*
  SELECT * FROM VEDA FOR ALL ENTRIES IN R_SDAUFNR
                   WHERE VBELN =  R_SDAUFNR-LOW
                   AND   VLAUFK   IN VLAUFK
                   AND   VINSDAT  IN VINSDAT
                   AND   VABNDAT  IN VABNDAT
                   AND   VBEGDAT  IN VBEGDAT
                   AND   VUNTDAT  IN VUNTDAT
                   AND   VKUESCH  IN VKUESCH
                   AND   VAKTSCH  IN VAKTSCH
                   AND   VEINDAT  IN VEINDAT
                   AND   VWUNDAT  IN VWUNDAT
                   AND   VKUEPAR  IN VKUEPAR
                   AND   VKUEGRU  IN VKUEGRU
                   AND   VENDDAT  IN VENDDAT
                   AND   VBELKUE  IN VBELKUE
                   AND   VBEDKUE  IN VBEDKUE
                   AND   VBEGREG  IN VBEGREG
                   AND   VVORZEIT IN VVORZEIT
                   AND   VDEMDAT  IN VDEMDAT.
    H_VEDA = VEDA.
    APPEND H_VEDA.
    H_VBELN_TAB-VBELN = VEDA-VBELN.
    COLLECT H_VBELN_TAB.
  ENDSELECT.

  CHECK SY-SUBRC IS INITIAL.
  SORT H_VEDA BY VBELN VPOSN.
*--- hilfstab l#schen
  CLEAR   R_SDAUFNR.
  REFRESH R_SDAUFNR.
*--- Bestelldaten nachlesen ------------------------------------------*
  SELECT
        VBELN
        POSNR
        BSTKD
        BSTDK
        BSARK
        IHREZ
          FROM VBKD
          INTO CORRESPONDING FIELDS OF VBKD
              FOR ALL ENTRIES IN H_VBELN_TAB
              WHERE VBELN   = H_VBELN_TAB-VBELN
              AND   BSTKD_M IN BSTNK
              AND   BSTDK   IN BSTDK
              AND   BSARK   IN BSARK
              AND   IHREZ   IN IHREZ.
    MOVE-CORRESPONDING VBKD TO H_VBKD_TAB.
    APPEND H_VBKD_TAB.
    R_SDAUFNR-LOW = VBKD-VBELN.
    R_SDAUFNR-SIGN = 'I'.
    R_SDAUFNR-OPTION = 'EQ'.
    COLLECT R_SDAUFNR.
  ENDSELECT.
  CHECK SY-SUBRC IS INITIAL.
  SORT H_VBKD_TAB BY VBELN POSNR.
*--- Objektlisten zu Vertr#gen nachlesen -----------------------------*
  M_COUNT = 1.
  DO.
    GET_TABLE_LINES R_SDAUFNR R_SDAUFNR_TEMP
                    M_COUNT MAX_SELECT M_RC.
    IF M_RC = 7. EXIT. ENDIF.   " nothing more to select
    SELECT * FROM VISER02 APPENDING TABLE H_VISER02
                     WHERE SDAUFNR IN R_SDAUFNR_TEMP
                     AND OBJVW <> 'A'
                     AND TASER = 'SER02'.
    IF M_RC <> 0.
      EXIT.
    ENDIF.
    M_COUNT = M_COUNT + MAX_SELECT.
  ENDDO.
*--- hilftabelle l#schen
  FREE: R_SDAUFNR,
        R_SDAUFNR_TEMP,
        H_VBELN_TAB.
*--- Object_tab wird aus obigen Tabellen zusammengebaut -------------*
  LOOP AT H_VIVEDA.
    CLEAR OBJECT_TAB.
*--- Vertragsdaten lesen: erst Pos dann Kopf
    READ TABLE H_VEDA WITH KEY VBELN = H_VIVEDA-VBELN
                               VPOSN = H_VIVEDA-POSNR
                               BINARY SEARCH.
    IF NOT SY-SUBRC IS INITIAL.
      READ TABLE H_VEDA WITH KEY VBELN = H_VIVEDA-VBELN
                                 VPOSN = H_VPOSN
                                 BINARY SEARCH.
      IF NOT SY-SUBRC IS INITIAL.
*    keine Vertragsdaten -> kein Vertrag -> exit
        CHECK 1 = 2.
      ELSE.
*    nochmals pr¨¹fen, ob wirklich keine veda f¨¹r posnr vorhanden (k#nnte
*    auch nur wegen select-options nicht selektiert worden sein)
        SELECT SINGLE VBELN INTO H_VBELN FROM VEDA
                                         WHERE VBELN = H_VIVEDA-VBELN
                                         AND   VPOSN = H_VIVEDA-POSNR.
        IF SY-SUBRC IS INITIAL.
          CHECK 1 = 2.
        ENDIF.
      ENDIF.
    ENDIF.
*--- Bestelldaten lesen: erst Pos dann Kopf
    READ TABLE H_VBKD_TAB WITH KEY VBELN = H_VIVEDA-VBELN
                                   POSNR = H_VIVEDA-POSNR
                                   BINARY SEARCH.
    IF NOT SY-SUBRC IS INITIAL.
      READ TABLE H_VBKD_TAB WITH KEY VBELN = H_VIVEDA-VBELN
                                     POSNR = H_VPOSN
                                     BINARY SEARCH.
    ENDIF.
*--- Objektlisten werden dazugemischt -------------------------------*
    LOOP AT H_VISER02 WHERE SDAUFNR = H_VIVEDA-VBELN
                       AND  POSNR   = H_VIVEDA-POSNR.
      MOVE-CORRESPONDING H_VIVEDA   TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VBKD_TAB TO OBJECT_TAB.
      MOVE H_VBKD_TAB-BSTKD         TO OBJECT_TAB-BSTNK.
      MOVE-CORRESPONDING H_VEDA     TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VISER02  TO OBJECT_TAB.
*--- Beleg und Pos immer aus h_viveda
      MOVE H_VIVEDA-VBELN           TO OBJECT_TAB-SDAUFNR.
      MOVE H_VIVEDA-POSNR           TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDLOOP.
    IF SY-SUBRC <> 0.
*--- Es gibt keine Objektliste --> nur eine Zeile ausgeben f¨¹r Pos.--*
      MOVE-CORRESPONDING H_VIVEDA TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VBKD_TAB TO OBJECT_TAB.
      MOVE H_VBKD_TAB-BSTKD         TO OBJECT_TAB-BSTNK.
      MOVE-CORRESPONDING H_VEDA TO OBJECT_TAB.
*--- Beleg und Pos immer aus h_viveda
      MOVE H_VIVEDA-VBELN           TO OBJECT_TAB-SDAUFNR.
      MOVE H_VIVEDA-POSNR           TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDIF.
  ENDLOOP.
ENDFORM.                               " SELECT_VIA_VIVEDA

*&---------------------------------------------------------------------*
*&      Form  SELECT_VIA_VEDA
*&---------------------------------------------------------------------*
*       Datenselektion, Einstieg ¨¹ber Veda (Kontraktdaten)             *
*----------------------------------------------------------------------*
FORM SELECT_VIA_VEDA.

  DATA: BEGIN OF H_VISER02 OCCURS 100.
          INCLUDE STRUCTURE VISER02.
  DATA: END OF H_VISER02.

  DATA: BEGIN OF H_VIVEDA OCCURS 100.
          INCLUDE STRUCTURE VIVEDA.
  DATA: END OF H_VIVEDA.

  DATA: BEGIN OF H_VEDA OCCURS 100.
          INCLUDE STRUCTURE VEDA.
  DATA: END OF H_VEDA.

  DATA: BEGIN OF H_VBKD_TAB OCCURS 100,
         VBELN LIKE VBKD-VBELN,
         POSNR LIKE VBKD-POSNR,
         BSTKD LIKE VBKD-BSTKD,
         BSTDK LIKE VBKD-BSTDK,
         BSARK LIKE VBKD-BSARK,
         IHREZ LIKE VBKD-IHREZ,
        END OF H_VBKD_TAB.

  DATA: BEGIN OF H_VBELN_TAB OCCURS 100,
         VBELN LIKE VBAK-VBELN,
        END OF H_VBELN_TAB.

  DATA: H_ARKTX LIKE VIVEDA-ARKTX.
  DATA: H_BNAME LIKE VIVEDA-BNAME.
  DATA: H_VPOSN LIKE VEDA-VPOSN VALUE '000000'.
  DATA: H_VBELN LIKE VEDA-VBELN.

  RANGES: R_SDAUFNR FOR VISER02-SDAUFNR.
  RANGES: R_SDAUFNR_TEMP FOR VISER02-SDAUFNR.

  REFRESH: H_VISER02,
           H_VIVEDA,
           H_VEDA.

*--- Zusatzdaten zu Vertrag lesen ------------------------------------*
  SELECT * FROM VEDA                                    "#EC CI_NOFIELD
                   WHERE VLAUFK   IN VLAUFK
                   AND   VINSDAT  IN VINSDAT
                   AND   VABNDAT  IN VABNDAT
                   AND   VBEGDAT  IN VBEGDAT
                   AND   VUNTDAT  IN VUNTDAT
                   AND   VKUESCH  IN VKUESCH
                   AND   VAKTSCH  IN VAKTSCH
                   AND   VEINDAT  IN VEINDAT
                   AND   VWUNDAT  IN VWUNDAT
                   AND   VKUEPAR  IN VKUEPAR
                   AND   VKUEGRU  IN VKUEGRU
                   AND   VENDDAT  IN VENDDAT
                   AND   VBELKUE  IN VBELKUE
                   AND   VBEDKUE  IN VBEDKUE
                   AND   VBEGREG  IN VBEGREG
                   AND   VVORZEIT IN VVORZEIT
                   AND   VDEMDAT  IN VDEMDAT.
    H_VEDA = VEDA.
    APPEND H_VEDA.
    R_SDAUFNR-LOW = VEDA-VBELN.
    R_SDAUFNR-SIGN = 'I'.
    R_SDAUFNR-OPTION = 'EQ'.
    COLLECT R_SDAUFNR.
  ENDSELECT.

  CHECK SY-SUBRC IS INITIAL.
  SORT H_VEDA BY VBELN VPOSN.
*--- Vertragskopf/pos-Daten lesen -----------------------------------*
  SELECT * FROM VIVEDA FOR ALL ENTRIES IN R_SDAUFNR
                   WHERE VBELN    = R_SDAUFNR-LOW
                   AND   VBELN      IN SDAUFNR
                   AND   POSNR      IN POSNR
                   AND   AUART      IN AUART
                   AND   AUGRU      IN AUGRU
                   AND   ERNAM      IN ERNAM
                   AND   SUBMI      IN SUBMI
                   AND   VKORG      IN VKORG
                   AND   VTWEG      IN VTWEG
                   AND   VKGRP      IN VKGRP
                   AND   VKBUR      IN VKBUR
                   AND   BSTZD      IN BSTZD
                   AND   TELF1      IN TELF1
                   AND   KUNNR      IN KUNNR
                   AND   MATWA      IN MATWA
                   AND   CHARG      IN CHARG
                   AND   MATKL      IN MATKL
                   AND   PSTYV      IN PSTYV
                   AND   UEPOS      IN UEPOS
                   AND   ABGRU      IN ABGRU
                   AND   PRODH      IN PRODH
                   AND   ZMENG      IN ZMENG
                   AND   MEINS      IN MEINS
                   AND   KDMAT      IN KDMAT
                   AND   POSEX      IN POSEX
                   AND   SPART      IN SPART
                   AND   NETWRX     IN NETWRX
                   AND   VGBEL      IN VGBEL
                   AND   VGPOS      IN VGPOS
                   AND   WERKS      IN WERKS
                   AND   EAN11      IN EAN11
                   AND   MVGR1      IN MVGR1
                   AND   MVGR2      IN MVGR2
                   AND   MVGR3      IN MVGR3
                   AND   MVGR4      IN MVGR4
                   AND   MVGR5      IN MVGR5
                   AND   VBTYP      EQ VBTYP_KONT.
    H_ARKTX = VIVEDA-ARKTX.
    TRANSLATE H_ARKTX TO UPPER CASE.                     "#EC TRANSLANG
    CHECK H_ARKTX IN ARKTX.
    H_BNAME = VIVEDA-BNAME.
    TRANSLATE H_BNAME TO UPPER CASE.                     "#EC TRANSLANG
    CHECK H_BNAME IN BNAME.
    H_VIVEDA = VIVEDA.
    APPEND H_VIVEDA.
    H_VBELN_TAB-VBELN = VIVEDA-VBELN.
    COLLECT H_VBELN_TAB.
  ENDSELECT.
  CHECK NOT H_VBELN_TAB[] IS INITIAL.
*--- hilfstab wieder l#schen
  CLEAR   R_SDAUFNR.
  REFRESH R_SDAUFNR.
*--- Kaufm. Daten lesen ----------------------------------------------*
  SELECT
        VBELN
        POSNR
        BSTKD
        BSTDK
        BSARK
        IHREZ
          FROM VBKD
          INTO CORRESPONDING FIELDS OF VBKD
              FOR ALL ENTRIES IN H_VBELN_TAB
              WHERE VBELN   = H_VBELN_TAB-VBELN
              AND   BSTKD_M IN BSTNK
              AND   BSTDK   IN BSTDK
              AND   BSARK   IN BSARK
              AND   IHREZ   IN IHREZ.
    MOVE-CORRESPONDING VBKD TO H_VBKD_TAB.
    APPEND H_VBKD_TAB.
    R_SDAUFNR-LOW     = VBKD-VBELN.
    R_SDAUFNR-SIGN    = 'I'.
    R_SDAUFNR-OPTION  = 'EQ'.
    COLLECT R_SDAUFNR.
  ENDSELECT.
  CHECK SY-SUBRC IS INITIAL.
  SORT H_VBKD_TAB BY VBELN POSNR.
*--- Objektlisten zu Vertr#gen nachlesen -----------------------------*
  M_COUNT = 1.
  DO.
    GET_TABLE_LINES R_SDAUFNR R_SDAUFNR_TEMP
                    M_COUNT MAX_SELECT M_RC.
    IF M_RC = 7. EXIT. ENDIF.   " nothing more to select
    SELECT * FROM VISER02 APPENDING TABLE H_VISER02
                     WHERE SDAUFNR IN R_SDAUFNR_TEMP
                     AND OBJVW <> 'A'
                     AND TASER = 'SER02'.
    IF M_RC <> 0.
      EXIT.
    ENDIF.
    M_COUNT = M_COUNT + MAX_SELECT.
  ENDDO.
*--- hilfstabellen l#schen
  FREE: H_VBELN_TAB,
        R_SDAUFNR,
        R_SDAUFNR_TEMP.
*--- Object_tab wird aus obigen Tabellen zusammengebaut -------------*
  LOOP AT H_VIVEDA.
    CLEAR OBJECT_TAB.
*--- Vertragsdaten lesen: erst Pos dann Kopf
    READ TABLE H_VEDA WITH KEY VBELN = H_VIVEDA-VBELN
                               VPOSN = H_VIVEDA-POSNR
                               BINARY SEARCH.
    IF NOT SY-SUBRC IS INITIAL.
      READ TABLE H_VEDA WITH KEY VBELN = H_VIVEDA-VBELN
                                 VPOSN = H_VPOSN
                                 BINARY SEARCH.
      IF NOT SY-SUBRC IS INITIAL.
*    keine Vertragsdaten -> kein Vertrag -> exit
        CHECK 1 = 2.
      ELSE.
*    nochmals pr¨¹fen, ob wirklich keine veda f¨¹r posnr vorhanden (k#nnte
*    auch nur wegen select-options nicht selektiert worden sein)
        SELECT SINGLE VBELN INTO H_VBELN FROM VEDA
                                         WHERE VBELN = H_VIVEDA-VBELN
                                         AND   VPOSN = H_VIVEDA-POSNR.
        IF SY-SUBRC IS INITIAL.
          CHECK 1 = 2.
        ENDIF.
      ENDIF.
    ENDIF.
*--- Bestelldaten lesen: erst Pos dann Kopf
    READ TABLE H_VBKD_TAB WITH KEY VBELN = H_VIVEDA-VBELN
                                   POSNR = H_VIVEDA-POSNR
                                   BINARY SEARCH.
    IF NOT SY-SUBRC IS INITIAL.
      READ TABLE H_VBKD_TAB WITH KEY VBELN = H_VIVEDA-VBELN
                                     POSNR = H_VPOSN
                                     BINARY SEARCH.
    ENDIF.
*--- Objektlisten werden dazugemischt -------------------------------*
    LOOP AT H_VISER02 WHERE SDAUFNR = H_VIVEDA-VBELN
                       AND  POSNR   = H_VIVEDA-POSNR.
      MOVE-CORRESPONDING H_VIVEDA   TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VBKD_TAB TO OBJECT_TAB.
      MOVE H_VBKD_TAB-BSTKD         TO OBJECT_TAB-BSTNK.
      MOVE-CORRESPONDING H_VEDA     TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VISER02  TO OBJECT_TAB.
*--- Beleg und Pos immer aus h_viveda
      MOVE H_VIVEDA-VBELN           TO OBJECT_TAB-SDAUFNR.
      MOVE H_VIVEDA-POSNR           TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDLOOP.
    IF SY-SUBRC <> 0.
*--- Es gibt keine Objektliste --> nur eine Zeile ausgeben f¨¹r Pos.--*
      MOVE-CORRESPONDING H_VIVEDA TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VBKD_TAB TO OBJECT_TAB.
      MOVE H_VBKD_TAB-BSTKD         TO OBJECT_TAB-BSTNK.
      MOVE-CORRESPONDING H_VEDA TO OBJECT_TAB.
*--- Beleg und Pos immer aus h_viveda
      MOVE H_VIVEDA-VBELN           TO OBJECT_TAB-SDAUFNR.
      MOVE H_VIVEDA-POSNR           TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDIF.
  ENDLOOP.
**-------------------------------------------------------------------*
** CLACULATE THE MEASURING POINT BASED ON THE GAP0062                *
**-------------------------------------------------------------------*
*  PERFORM MEASURE_CALCULATE.
ENDFORM.                               " SELECT_VIA_VEDA

*&---------------------------------------------------------------------*
*&      Form  DETERMINE_ACTTYPE_VEDA_L
*&---------------------------------------------------------------------*
*       text                                                           *
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DETERMINE_ACTTYPE_VEDA_L.

  SELECT SINGLE * FROM T370A WHERE TCODE = G_TCODE.
  IF SY-SUBRC <> 0.
    SELECT SINGLE * FROM T370A WHERE TCODE = 'IW75'.
    IF SY-SUBRC <> 0.
      MESSAGE X160 WITH 'IW75'.
    ENDIF.
  ENDIF.
  G_AKTYP = T370A-AKTYP.
ENDFORM.                               " DETERMINE_ACTTYPE_VEDA_L
*&---------------------------------------------------------------------*
*&      Form  ASSIGN_OBJECT_TAB
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ASSIGN_OBJECT_TAB.

  CLEAR OBJECT_TAB.
  REFRESH OBJECT_TAB.

  LOOP AT SEL_TAB_HELP.
    MOVE-CORRESPONDING SEL_TAB_HELP TO OBJECT_TAB.
    APPEND OBJECT_TAB.
  ENDLOOP.


ENDFORM.                               " ASSIGN_OBJECT_TAB
*&---------------------------------------------------------------------*
*&      Form  CHECK_FIELDCAT_VARIANT_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM CHECK_FIELDCAT_VARIANT_L.

  DATA H_FIELDCAT_WA TYPE SLIS_FIELDCAT_ALV.
  DATA H_INDEX       LIKE SY-TABIX.

  H_INDEX = 1.

  DESCRIBE TABLE G_SELFIELDS_TAB LINES SY-TABIX.
  IF SY-TABIX IS INITIAL.
    LOOP AT G_FIELDCAT_TAB INTO H_FIELDCAT_WA.
      CASE H_FIELDCAT_WA-FIELDNAME.
*        WHEN 'PM_SELECTED'.
*          H_FIELDCAT_WA-NO_OUT  = SPACE.
*          H_FIELDCAT_WA-COL_POS = 1.
        WHEN 'SDAUFNR'.
          H_FIELDCAT_WA-NO_OUT  = SPACE.
          H_FIELDCAT_WA-COL_POS = 1.
        WHEN 'KUNNR'.
          H_FIELDCAT_WA-NO_OUT  = SPACE.
          H_FIELDCAT_WA-COL_POS = 2.
        WHEN 'KTEXT'.
          H_FIELDCAT_WA-NO_OUT  = SPACE.
          H_FIELDCAT_WA-COL_POS = 3.
        WHEN 'POSNR'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
          H_FIELDCAT_WA-COL_POS = 4.
* begin of deletion mod-005
*        WHEN 'POINT'.
*          H_FIELDCAT_WA-NO_OUT = SPACE.
*          H_FIELDCAT_WA-COL_POS = 5.
* end of deletion mod-005
        WHEN 'EQUNR'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*          H_FIELDCAT_WA-COL_POS = 6.
           H_FIELDCAT_WA-COL_POS = 5.
* end of change mod-005
        WHEN 'PYEAR'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*          H_FIELDCAT_WA-COL_POS = 7.
           H_FIELDCAT_WA-COL_POS = 6.
* end of change mod-005
        WHEN 'AYEAR'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*         H_FIELDCAT_WA-COL_POS = 8.
          H_FIELDCAT_WA-COL_POS = 7.
* end of change mod-005
          H_FIELDCAT_WA-emphasize = 'C600'.
* begin of insertion mod-005
        WHEN 'BYEAR'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
          H_FIELDCAT_WA-COL_POS = 8.
          H_FIELDCAT_WA-emphasize = 'C600'.
* end of insertion mod-005
        WHEN 'VARIANCE'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
          H_FIELDCAT_WA-COL_POS = 9.
          H_FIELDCAT_WA-emphasize = 'C600'.
* begin of insertion mod-005
        WHEN 'VARIANCEB'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
          H_FIELDCAT_WA-COL_POS = 10.
          H_FIELDCAT_WA-emphasize = 'C600'.
* end of insertion mod-005
        WHEN 'VARIANCE%'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*         H_FIELDCAT_WA-COL_POS = 10.
          H_FIELDCAT_WA-COL_POS = 11.
* end of change mod-005
          H_FIELDCAT_WA-emphasize = 'C600'.
* begin of insertion mod-005
        WHEN 'VARIANCEB%'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*          H_FIELDCAT_WA-COL_POS = 11.
           H_FIELDCAT_WA-COL_POS = 12.
* end of change mod-005
          H_FIELDCAT_WA-emphasize = 'C600'.
* end of insertion mod-005
        WHEN 'VBEGDAT'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*         H_FIELDCAT_WA-COL_POS = 11.
          H_FIELDCAT_WA-COL_POS = 13.
* end of change mod-005
        WHEN 'VENDDAT'.
          H_FIELDCAT_WA-NO_OUT = SPACE.
* begin of change mod-005
*         H_FIELDCAT_WA-COL_POS = 12.
          H_FIELDCAT_WA-COL_POS = 14.
* end of change mod-005

        WHEN OTHERS.
          H_FIELDCAT_WA-NO_OUT = G_X.
      ENDCASE.
*--- no obligatory fields ------------------------------------------
      H_FIELDCAT_WA-KEY     = SPACE.
      MODIFY G_FIELDCAT_TAB FROM H_FIELDCAT_WA.
    ENDLOOP.
  ELSE.
    LOOP AT G_FIELDCAT_TAB INTO H_FIELDCAT_WA.
*--- no obligatory fields ------------------------------------------
      H_FIELDCAT_WA-KEY     = SPACE.
      if h_fieldcat_wa-fieldname = 'AYEAR' .
        H_FIELDCAT_WA-emphasize = 'C600'.
      endif .
       if h_fieldcat_wa-fieldname = 'VARIANCE' .
        H_FIELDCAT_WA-emphasize = 'C600'.
      endif .
      if h_fieldcat_wa-fieldname = 'VARIANCE%' .
        H_FIELDCAT_WA-emphasize = 'C600'.
      endif .
* begin of insertion mod-005
      if h_fieldcat_wa-fieldname = 'BYEAR' .
        H_FIELDCAT_WA-emphasize = 'C600'.
      endif .
      if h_fieldcat_wa-fieldname = 'VARIANCEB' .
        H_FIELDCAT_WA-emphasize = 'C600'.
      endif .
      if h_fieldcat_wa-fieldname = 'VARIANCEB%' .
        H_FIELDCAT_WA-emphasize = 'C600'.
      endif .
* end of insertion mod-005

      MODIFY G_FIELDCAT_TAB FROM H_FIELDCAT_WA.
    ENDLOOP.
  ENDIF.

ENDFORM.                               " CHECK_FIELDCAT_VARIANT_L

INCLUDE MIOLXF14.
INCLUDE MIOLXF16.
*&---------------------------------------------------------------------*
*&      Form  REFRESH_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM REFRESH_L USING P_SELFIELD TYPE SLIS_SELFIELD.

  DATA H_CHANGE LIKE SY-UCOMM.

  PERFORM GET_FIELDCAT_ACTUAL_F14 USING H_CHANGE.
*--- Nachselektion nur wenn Feldkatalog ver#ndert ------------------*
  IF H_CHANGE = YES.
    P_SELFIELD-REFRESH = G_X.
    PERFORM FILL_OBJECT_TAB_L.
  ENDIF.

ENDFORM.                               " REFRESH_L

*&---------------------------------------------------------------------*
*&      Form  SELECT_FOR_QUICKINFO_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_SELFIELD  text                                           *
*----------------------------------------------------------------------*
FORM SELECT_FOR_QUICKINFO_L USING P_SELFIELD TYPE SLIS_SELFIELD.

  DATA H_INDEX LIKE SY-TABIX.
  DATA H_TEXT_TABLE LIKE EQKT OCCURS 1 WITH HEADER LINE.

  READ TABLE OBJECT_TAB WITH KEY SELECTED = G_X.
  IF NOT SY-SUBRC IS INITIAL AND
     NOT P_SELFIELD-TABINDEX IS INITIAL.
    READ TABLE OBJECT_TAB INDEX P_SELFIELD-TABINDEX.
    H_INDEX = P_SELFIELD-TABINDEX.
  ELSE.
    H_INDEX = SY-TABIX.
  ENDIF.
*--- Techn.Platzbezeichnung hinzulesen ------------------------------*
  IF OBJECT_TAB-PLTXT IS INITIAL AND NOT OBJECT_TAB-ILOAN IS INITIAL.
    SELECT SINGLE * FROM ILOA WHERE ILOAN = OBJECT_TAB-ILOAN.
    IF SY-SUBRC IS INITIAL.
      SELECT SINGLE * FROM IFLOTX WHERE TPLNR = ILOA-TPLNR
                                  AND   SPRAS = SY-LANGU.
      IF NOT SY-SUBRC IS INITIAL.
        SELECT * FROM IFLOTX WHERE TPLNR = ILOA-TPLNR.
        ENDSELECT.
      ENDIF.
      OBJECT_TAB-TPLNR = IFLOTX-TPLNR.
      OBJECT_TAB-PLTXT = IFLOTX-PLTXT.
    ENDIF.
  ENDIF.
*--- Equi-Bezeichnung hinzulesen ------------------------------------*
  IF OBJECT_TAB-EQKTX IS INITIAL AND NOT OBJECT_TAB-EQKTX IS INITIAL.
    CALL FUNCTION 'EQUIPMENT_TEXT_READ'
      EXPORTING
        EQUI_NO        = OBJECT_TAB-EQUNR
      IMPORTING
        EQUI_TEXT      = OBJECT_TAB-EQKTX
      TABLES
        TEXT_TABLE     = H_TEXT_TABLE
      EXCEPTIONS
        EQUI_NOT_FOUND = 01
        TEXT_NOT_FOUND = 02.
    IF NOT SY-SUBRC IS INITIAL.
      CLEAR OBJECT_TAB-EQKTX.
    ENDIF.
  ENDIF.
*--- Materialbezeichung (eingegebenes Material)-----------------------*
  IF OBJECT_TAB-MAKTX IS INITIAL AND NOT OBJECT_TAB-MATWA IS INITIAL.
    SELECT SINGLE * FROM MAKT WHERE MATNR = OBJECT_TAB-MATWA
                              AND   SPRAS = SY-LANGU.
    IF NOT SY-SUBRC IS INITIAL.
      SELECT * FROM MAKT WHERE MATNR = OBJECT_TAB-MATWA.
      ENDSELECT.
    ENDIF.
    OBJECT_TAB-MAKTX = MAKT-MAKTX.
  ENDIF.
  MODIFY OBJECT_TAB INDEX H_INDEX.

ENDFORM.                               " SELECT_FOR_QUICKINFO_L
*&---------------------------------------------------------------------*
*&      Form  SELECT_VIA_VBKD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SELECT_VIA_VBKD.

  DATA: BEGIN OF H_VISER02 OCCURS 100.
          INCLUDE STRUCTURE VISER02.
  DATA: END OF H_VISER02.

  DATA: BEGIN OF H_VIVEDA OCCURS 100.
          INCLUDE STRUCTURE VIVEDA.
  DATA: END OF H_VIVEDA.

  DATA: BEGIN OF H_VEDA OCCURS 100.
          INCLUDE STRUCTURE VEDA.
  DATA: END OF H_VEDA.

  DATA: BEGIN OF H_VBKD_TAB OCCURS 100,
         VBELN LIKE VBKD-VBELN,
         POSNR LIKE VBKD-POSNR,
         BSTKD LIKE VBKD-BSTKD,
         BSTDK LIKE VBKD-BSTDK,
         BSARK LIKE VBKD-BSARK,
         IHREZ LIKE VBKD-IHREZ,
        END OF H_VBKD_TAB.

  DATA: BEGIN OF H_VBELN_TAB OCCURS 100,
         VBELN LIKE VBAK-VBELN,
        END OF H_VBELN_TAB.

  DATA: H_ARKTX LIKE VIVEDA-ARKTX.
  DATA: H_BNAME LIKE VIVEDA-BNAME.
  DATA: H_VPOSN LIKE VEDA-VPOSN VALUE '000000'.
  DATA: H_VBELN LIKE VEDA-VBELN.

  RANGES: R_SDAUFNR FOR VISER02-SDAUFNR.
  RANGES: R_SDAUFNR_TEMP FOR VISER02-SDAUFNR.

  REFRESH: H_VISER02,
           H_VIVEDA,
           H_VEDA.

*--- Kaufm. Daten lesen ----------------------------------------------*
  SELECT
        VBELN
        POSNR
        BSTKD
        BSTDK
        BSARK
        IHREZ
          FROM VBKD
          INTO CORRESPONDING FIELDS OF VBKD
              WHERE BSTKD_M IN BSTNK
              AND   BSTDK   IN BSTDK
              AND   BSARK   IN BSARK
              AND   IHREZ   IN IHREZ.
    MOVE-CORRESPONDING VBKD TO H_VBKD_TAB.
    APPEND H_VBKD_TAB.
    R_SDAUFNR-LOW = VBKD-VBELN.
    R_SDAUFNR-SIGN = 'I'.
    R_SDAUFNR-OPTION = 'EQ'.
    COLLECT R_SDAUFNR.
  ENDSELECT.
  CHECK SY-SUBRC IS INITIAL.
  SORT H_VBKD_TAB BY VBELN POSNR.
*--- Zusatzdaten zu Vertrag lesen ------------------------------------*
  SELECT * FROM VEDA
                   FOR ALL ENTRIES IN R_SDAUFNR
                   WHERE VBELN    = R_SDAUFNR-LOW
                   AND   VLAUFK   IN VLAUFK
                   AND   VINSDAT  IN VINSDAT
                   AND   VABNDAT  IN VABNDAT
                   AND   VBEGDAT  IN VBEGDAT
                   AND   VUNTDAT  IN VUNTDAT
                   AND   VKUESCH  IN VKUESCH
                   AND   VAKTSCH  IN VAKTSCH
                   AND   VEINDAT  IN VEINDAT
                   AND   VWUNDAT  IN VWUNDAT
                   AND   VKUEPAR  IN VKUEPAR
                   AND   VKUEGRU  IN VKUEGRU
                   AND   VENDDAT  IN VENDDAT
                   AND   VBELKUE  IN VBELKUE
                   AND   VBEDKUE  IN VBEDKUE
                   AND   VBEGREG  IN VBEGREG
                   AND   VVORZEIT IN VVORZEIT
                   AND   VDEMDAT  IN VDEMDAT.
    H_VEDA = VEDA.
    APPEND H_VEDA.
    H_VBELN_TAB-VBELN = VEDA-VBELN.
    COLLECT H_VBELN_TAB.
  ENDSELECT.
  CHECK SY-SUBRC IS INITIAL.
  SORT H_VEDA BY VBELN VPOSN.
*--- Hilftab wieder l#schen
  CLEAR   R_SDAUFNR.
  REFRESH R_SDAUFNR.
*--- Vertragskopf/pos-Daten lesen -----------------------------------*
  SELECT * FROM VIVEDA FOR ALL ENTRIES IN H_VBELN_TAB
                   WHERE VBELN    = H_VBELN_TAB-VBELN
                   AND   VBELN      IN SDAUFNR
                   AND   POSNR      IN POSNR
                   AND   AUART      IN AUART
                   AND   AUGRU      IN AUGRU
                   AND   ERNAM      IN ERNAM
                   AND   SUBMI      IN SUBMI
                   AND   VKORG      IN VKORG
                   AND   VTWEG      IN VTWEG
                   AND   VKGRP      IN VKGRP
                   AND   VKBUR      IN VKBUR
                   AND   BSTZD      IN BSTZD
                   AND   TELF1      IN TELF1
                   AND   KUNNR      IN KUNNR
                   AND   MATWA      IN MATWA
                   AND   CHARG      IN CHARG
                   AND   MATKL      IN MATKL
                   AND   PSTYV      IN PSTYV
                   AND   UEPOS      IN UEPOS
                   AND   ABGRU      IN ABGRU
                   AND   PRODH      IN PRODH
                   AND   ZMENG      IN ZMENG
                   AND   MEINS      IN MEINS
                   AND   KDMAT      IN KDMAT
                   AND   POSEX      IN POSEX
                   AND   SPART      IN SPART
                   AND   NETWRX     IN NETWRX
                   AND   VGBEL      IN VGBEL
                   AND   VGPOS      IN VGPOS
                   AND   WERKS      IN WERKS
                   AND   EAN11      IN EAN11
                   AND   MVGR1      IN MVGR1
                   AND   MVGR2      IN MVGR2
                   AND   MVGR3      IN MVGR3
                   AND   MVGR4      IN MVGR4
                   AND   MVGR5      IN MVGR5
                   AND   VBTYP      EQ VBTYP_KONT.
    H_ARKTX = VIVEDA-ARKTX.
    TRANSLATE H_ARKTX TO UPPER CASE.                     "#EC TRANSLANG
    CHECK H_ARKTX IN ARKTX.
    H_BNAME = VIVEDA-BNAME.
    TRANSLATE H_BNAME TO UPPER CASE.                     "#EC TRANSLANG
    CHECK H_BNAME IN BNAME.
    H_VIVEDA = VIVEDA.
    APPEND H_VIVEDA.
    R_SDAUFNR-LOW = VIVEDA-VBELN.
    R_SDAUFNR-SIGN = 'I'.
    R_SDAUFNR-OPTION = 'EQ'.
    COLLECT R_SDAUFNR.
  ENDSELECT.
  CHECK NOT H_VIVEDA[] IS INITIAL.
*--- Objektlisten zu Vertr#gen nachlesen -----------------------------*
  M_COUNT = 1.
  DO.
    GET_TABLE_LINES R_SDAUFNR R_SDAUFNR_TEMP
                    M_COUNT MAX_SELECT M_RC.
    IF M_RC = 7. EXIT. ENDIF.   " nothing more to select
    SELECT * FROM VISER02 APPENDING TABLE H_VISER02
                     WHERE SDAUFNR IN R_SDAUFNR_TEMP
                     AND OBJVW <> 'A'
                     AND TASER = 'SER02'.
    IF M_RC <> 0.
      EXIT.
    ENDIF.
    M_COUNT = M_COUNT + MAX_SELECT.
  ENDDO.
*--- hilftabellen l#schne
  FREE: H_VBELN_TAB,
        R_SDAUFNR,
        R_SDAUFNR_TEMP.
*--- Object_tab wird aus obigen Tabellen zusammengebaut -------------*
  LOOP AT H_VIVEDA.
    CLEAR OBJECT_TAB.
*--- Vertragsdaten lesen: erst ¨¹ber Postion dann zum Kopf
    READ TABLE H_VEDA WITH KEY VBELN = H_VIVEDA-VBELN
                               VPOSN = H_VIVEDA-POSNR
                               BINARY SEARCH.
    IF NOT SY-SUBRC IS INITIAL.
      READ TABLE H_VEDA WITH KEY VBELN = H_VIVEDA-VBELN
                                 VPOSN = H_VPOSN
                                 BINARY SEARCH.
      IF NOT SY-SUBRC IS INITIAL.
*    Keine Vertragsdaten -> kein Vertrag -> Exit
        CHECK 1 = 2.
      ELSE.
*    nochmals pr¨¹fen, ob wirklich keine veda f¨¹r posnr vorhanden (k#nnte
*    auch nur wegen select-options nicht selektiert worden sein)
        SELECT SINGLE VBELN INTO H_VBELN FROM VEDA
                                         WHERE VBELN = H_VIVEDA-VBELN
                                         AND   VPOSN = H_VIVEDA-POSNR.
        IF SY-SUBRC IS INITIAL.
          CHECK 1 = 2.
        ENDIF.
      ENDIF.
    ENDIF.
*--- Bestelldaten lesen: erst ¨¹ber Position dann zum Kopf
    READ TABLE H_VBKD_TAB WITH KEY VBELN = H_VIVEDA-VBELN
                                   POSNR = H_VIVEDA-POSNR
                                   BINARY SEARCH.
    IF NOT SY-SUBRC IS INITIAL.
      READ TABLE H_VBKD_TAB WITH KEY VBELN = H_VIVEDA-VBELN
                                     POSNR = H_VPOSN
                                     BINARY SEARCH.
    ENDIF.
*--- Objektlisten werden dazugemischt -------------------------------*
    LOOP AT H_VISER02 WHERE SDAUFNR = H_VIVEDA-VBELN
                       AND  POSNR   = H_VIVEDA-POSNR.
      MOVE-CORRESPONDING H_VIVEDA   TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VBKD_TAB TO OBJECT_TAB.
      MOVE H_VBKD_TAB-BSTKD         TO OBJECT_TAB-BSTNK.
      MOVE-CORRESPONDING H_VEDA     TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VISER02 TO OBJECT_TAB.
*--- Beleg und Pos immer aus h_viveda
      MOVE H_VIVEDA-VBELN           TO OBJECT_TAB-SDAUFNR.
      MOVE H_VIVEDA-POSNR           TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDLOOP.
    IF SY-SUBRC <> 0.
*--- Es gibt keine Objektliste --> nur eine Zeile ausgeben f¨¹r Pos.--*
      MOVE-CORRESPONDING H_VIVEDA TO OBJECT_TAB.
      MOVE-CORRESPONDING H_VBKD_TAB TO OBJECT_TAB.
      MOVE H_VBKD_TAB-BSTKD         TO OBJECT_TAB-BSTNK.
      MOVE-CORRESPONDING H_VEDA TO OBJECT_TAB.
*--- Beleg und Pos immer aus h_viveda
      MOVE H_VIVEDA-VBELN           TO OBJECT_TAB-SDAUFNR.
      MOVE H_VIVEDA-POSNR           TO OBJECT_TAB-POSNR.
      APPEND OBJECT_TAB.
    ENDIF.
  ENDLOOP.

ENDFORM.                               " SELECT_VIA_VBKD
*&---------------------------------------------------------------------*
*&      Form  FILL_EVENT_TAB_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FILL_EVENT_TAB_L.

  DATA H_EVENT       TYPE SLIS_ALV_EVENT.

*--- allocate form for set-pf-status---------------------------------*
*--- within this list local form is taken !!! -----------------------*
  READ TABLE G_EVENTS_TAB WITH KEY NAME = SLIS_EV_PF_STATUS_SET
                        INTO H_EVENT.
  IF SY-SUBRC = 0.
    MOVE 'SET_PF_STAT_L' TO H_EVENT-FORM.
    MODIFY G_EVENTS_TAB FROM H_EVENT INDEX SY-TABIX.
  ENDIF.

ENDFORM.                               " FILL_EVENT_TAB_L
*---------------------------------------------------------------------*
*       FORM SET_PF_STAT_L                                            *
*---------------------------------------------------------------------*
*       pf-stat: MAIN -> Display mode, AEND -> Change mode            *
*---------------------------------------------------------------------*
*  -->  RT_EXTAG                                                      *
*---------------------------------------------------------------------*
FORM SET_PF_STAT_L USING RT_EXTAG TYPE SLIS_T_EXTAB.

*--- link to SAPPHONE not aktive -> deaktivate function --------------
  IF NOT G_SAPPHONE_ACTIVE = G_X.
    APPEND 'PHON' TO RT_EXTAG.
  ENDIF.
*--- not in select mode -> deaktivate function -----------------------
  IF G_SELMOD = SELMOD_0 OR G_SELMOD = SELMOD_S.
    APPEND 'ISEL' TO RT_EXTAG.
  ELSE.
*--- in selection mode -> deaktivate function akualization
    APPEND 'AKTU' TO RT_EXTAG.
  ENDIF.
*--- customizing mode -> display/change mode inactive ----------------
  IF G_VARIANT_SAVE = G_X.
    APPEND 'V-A ' TO RT_EXTAG.
  ENDIF.

  SET TITLEBAR 'LVS' WITH TSTCT-TTEXT.

  IF G_AKTYP IS INITIAL.
    G_AKTYP = T370A-AKTYP.
  ENDIF.

  IF G_AKTYP = 'V'.
    SET PF-STATUS 'AEND' EXCLUDING RT_EXTAG.
  ELSE.
    SET PF-STATUS 'MAIN' EXCLUDING RT_EXTAG.
  ENDIF.

ENDFORM.                    "set_pf_stat_l

*&---------------------------------------------------------------------*
*&      Form  check_veda_date_l
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_VEDA_DATE_L.

*    start/enddate if selected between fill low-value if initial
  LOOP AT VBEGDAT WHERE SIGN = 'I' AND OPTION = 'BT'.
    IF VBEGDAT-LOW IS INITIAL.
      VBEGDAT-LOW = '00010101'. MODIFY VBEGDAT.
    ENDIF.
  ENDLOOP.
  LOOP AT VENDDAT WHERE SIGN = 'I' AND OPTION = 'BT'.
    IF VENDDAT-LOW IS INITIAL.
      VENDDAT-LOW = '00010101'. MODIFY VENDDAT.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "CHECK_VEDA_DATE_L

*&---------------------------------------------------------------------*
*&      Form  use_object_list_l
*&---------------------------------------------------------------------*
*       Check if object list can used for selection.
*       This is not possible for serch with I EQ Space or search
*       with excluding. Because there could be objects without
*       object list.
*----------------------------------------------------------------------*
*      -->P_RANGE   Select Option
*      -->P_FLAG    Flag if Object list can be used
*----------------------------------------------------------------------*
FORM USE_OBJECT_LIST_L  USING    P_RANGE TYPE ANY TABLE
                                 P_FLAG  TYPE CHAR01.

  TYPES: BEGIN OF LSTYPE_RANGE,
           SIGN(1)   TYPE C,
           OPTION(2) TYPE C,
           DATA(30)  TYPE C,
         END OF LSTYPE_RANGE.

  DATA: LS_RANGE TYPE LSTYPE_RANGE.

*--- if still clear that object list have to be used - do not
*--- check again.
  IF P_FLAG = YES OR P_RANGE[] IS INITIAL.
    EXIT.
  ENDIF.

  P_FLAG = NO.

  LOOP AT P_RANGE INTO LS_RANGE.
    IF LS_RANGE-SIGN = 'I'.
      IF ( LS_RANGE-OPTION <> 'NE' AND
           LS_RANGE-DATA   IS INITIAL ) OR
         ( LS_RANGE-OPTION = 'NE' AND
           NOT LS_RANGE-DATA IS INITIAL ).
        P_FLAG = NO.
        EXIT.
      ELSE.
        P_FLAG = YES.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " use_object_list_l
*&---------------------------------------------------------------------*
*&      Form  DATE_TIME
*&---------------------------------------------------------------------*
*       Set from date to current date - 1 year
*----------------------------------------------------------------------*
FORM DATE_TIME .
  CALL FUNCTION 'CCM_GO_BACK_MONTHS'
    EXPORTING
      currdate   = sy-datum
      backmonths = 012
    IMPORTING
      NEWDATE    = P_DATE1.

  P_DATE2 = SY-DATUM.
  P_TIME2 = SY-UZEIT.
ENDFORM.                    " DATE_TIME
*&---------------------------------------------------------------------*
*&      Form  MEASURE_CALCULATE
*&---------------------------------------------------------------------*
FORM MEASURE_CALCULATE .
  DATA : EQUNR LIKE IMPTT-MPOBJ,
         L_INDEX1 LIKE SY-TABIX.
  CLEAR :  g_mpobj,
           g_atinn,
           g_pyear,
           g_point.

  LOOP AT OBJECT_TAB where EQUNR NE SPACE.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = OBJECT_TAB-EQUNR
      IMPORTING
        OUTPUT = OBJECT_TAB-EQUNR.
*----------------------------------------------------------*
    CONCATENATE 'IE' OBJECT_TAB-EQUNR INTO g_mpobj.
*----------------------------------------------------------*
* SELECT ATINN FROM CABN TABLE BASED ON THE CNST_CHAR VALE *
* ZAM_RHRSTOTAL                                            *
*----------------------------------------------------------*
    SELECT ATINN INTO G_ATINN UP TO 1 ROWS
                  FROM CABN WHERE ATNAM EQ CNST_CHAR
                            AND LKENZ EQ SPACE.
    ENDSELECT.
    IF SY-SUBRC EQ  0.
* begin of change mod-006
          SELECT ATINN INTO G_ATINN2 UP TO 1 ROWS
                  FROM CABN WHERE ATNAM EQ CNST_CHAR2
                            AND LKENZ EQ SPACE.
          ENDSELECT.
* end of change mod-006
* begin of change mod-005
*      SELECT POINT PYEAR MPOBJ MRNGU INTO  I_IMPT
      SELECT POINT PSORT PYEAR MPOBJ MRNGU INTO  I_IMPT
* end of change mod-005
                               FROM IMPTT
                               where mpobj eq g_MPOBJ
                                 and atinn eq g_atinn
                                 and INDCT EQ 'X'
                                 AND LVORM EQ ' '.

* begin of change mod-006
     SELECT POINT PSORT PYEAR MPOBJ MRNGU INTO I_IMPT2
                               FROM IMPTT
                               where mpobj eq g_MPOBJ
                                 and atinn eq g_atinn2
                                 and INDCT EQ 'X'
                                 AND LVORM EQ ' '.
       I_IMPT-PYEAR = I_IMPT2-PYEAR.
       I_IMPT-MRNGU = I_IMPT2-MRNGU.

     ENDSELECT.
* end of change mod-006

*--------------------------------------------------------------*
* UNIT_CONVERSION_SIMPLE WILL CONVERT THE PYEAR INTO THE UNIT  *
* INDICATED IN IMPTT-MRNGU                                     *
*--------------------------------------------------------------*
        CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
          EXPORTING
            INPUT    = I_IMPT-PYEAR
            UNIT_OUT = I_IMPT-MRNGU
          IMPORTING
            OUTPUT   = I_IMPT-PYEAR.
*-------------------------------------------------------------- *
        APPEND I_IMPT.
        CLEAR I_IMPT.
      ENDSELECT.
    ENDIF.
  ENDLOOP.
*---------------------------------------------------------------------*
* SORT I_IMPT BY POINT AND MPOBJ AND THEN DELETE THE DUPLICATE ENTRIES*
*---------------------------------------------------------------------*
  SORT I_IMPT BY POINT MPOBJ.
  DELETE ADJACENT DUPLICATES FROM I_IMPT  COMPARING  POINT MPOBJ.
*---------------------------------------------------------------------*
*LOOP AT IMPT AND BIULD THE OBJECT_TAB_FINAL INTERNAL TABLE           *
*---------------------------------------------------------------------*
  LOOP AT OBJECT_TAB.
    L_INDEX = SY-TABIX.
    EQUNR = OBJECT_TAB-EQUNR.
    CONCATENATE 'IE' EQUNR INTO EQUNR.
* begin of deletion mod-005
*   LOOP AT I_IMPT WHERE MPOBJ = EQUNR.
* end of deletion mod-005
        MOVE-CORRESPONDING OBJECT_TAB TO OBJECT_TAB_FINAL.
* begin of insertion mod-005
      LOOP AT I_IMPT WHERE MPOBJ = EQUNR.
      if i_impt-psort = cnst_psort.
        move i_IMPT-POINT to OBJECT_TAB_FINAL-BPOINT.
      else.
* end of insertion mod-005
        MOVE I_IMPT-POINT TO OBJECT_TAB_FINAL-POINT.
        MOVE I_IMPT-PYEAR TO OBJECT_TAB_FINAL-PYEAR.
        MOVE I_IMPT-MRNGU TO OBJECT_TAB_FINAL-MRNGU.
* begin of insertion mod-005
      endif.
      endloop.
* end of insertion mod-005
        APPEND OBJECT_TAB_FINAL.
        CLEAR OBJECT_TAB_FINAL.
* begin of deletion mod-005.
*    ENDLOOP.
* end of deletion mod-005
    IF SY-SUBRC NE 0.
      MOVE-CORRESPONDING OBJECT_TAB TO OBJECT_TAB_FINAL.
      APPEND OBJECT_TAB_FINAL.
      CLEAR OBJECT_TAB_FINAL.
    ENDIF.
  ENDLOOP.
*---------------------------------------------------------------------*
*REFRESH ALL THE ENTRIES FROM OBJECT_TAB AND PASS THE OBJECT_TAB_FINAL
*TO THE OBJECT_TAB,THIS IS DONE BECAUSE THIS PROGRAM IS USING OBJECT_TAB
*AT MANY PLACES AND THEN BUILDING ANOTHER TABLE WILL RESULT CHANGES IN
*MANY PLACES AND INCONSISTENCY ALSO.
*---------------------------------------------------------------------*
  REFRESH OBJECT_TAB.
  CLEAR OBJECT_TAB.
  OBJECT_TAB[] = OBJECT_TAB_FINAL[].
*--------------------------------------------------------*
*SELECT POINT TIME DATE AND READG FIELD FROM imrg BASED  *
*ON THE DATE AND TIME FIELDS ON SELECTION SCREEN         *
*--------------------------------------------------------*
  SELECT POINT IDATE ITIME READG
         INTO TABLE I_IMRG
         FROM IMRG WHERE IDATE BETWEEN P_DATE1 AND P_DATE2.
*---------------------------------------------------------*
* DELETE ENTRIES FROM I_IMRG,WHERE I_IMRG-IDATE EQ DATE2
* AND I_IMRG-ITIME GE TIME2.
* DELETE ENTRIES FROM I_IMRG,WHERE I_IMRG-IDATE EQ P_DATE1
* AND  I_IMRG-ITIME LT TIME1
* DELETE ENTRIES FROM I_IMRG,WHERE P_DATE1 EQ DATE2 AND
* I_IMRG-ITIME LT TIME1.
*---------------------------------------------------------*
  LOOP AT I_IMRG.
    L_INDEX1 = SY-TABIX..
    IF I_IMRG-IDATE EQ P_DATE2 AND I_IMRG-ITIME GE P_TIME2.
      DELETE I_IMRG INDEX L_INDEX1.
    ELSEIF I_IMRG-IDATE EQ P_DATE1 AND I_IMRG-ITIME LT P_TIME1.
      DELETE I_IMRG INDEX L_INDEX1.
    ENDIF.
  ENDLOOP.

*----------------------------------------------------------------*
* GO INTO THE BELOW ROUTINES ONLY IF SY-SUBRC EQ 0 BECAUSE AS PER*
* GAP0062,IF POINT IS FOUND THEN ONLY CALCULATE                  *
* ACTUAL/VARIANCE/VARIANCE%                                      *
*----------------------------------------------------------------*
  IF SY-SUBRC EQ 0.
*----------------------------------------------------------------*
* CALCULATE ACTUAL RUNNING HOURS
*----------------------------------------------------------------*
    PERFORM CALCULATE_ACTUAL.
*----------------------------------------------------------------*
* CALCULATE VARIANCE ACTUAL - ESTIMATED ANNUAL RUNNING HOURS
*----------------------------------------------------------------*
    PERFORM CALCULATE_VARIANCE.
*----------------------------------------------------------------*
* CALCULATE VARIANCE PERCENTAGE
*----------------------------------------------------------------*
    PERFORM CALCULATE_VARPERCENT.
* begin of insertion mod-005
*----------------------------------------------------------------*
* CALCULATE BACKBILLING HOURS
*----------------------------------------------------------------*
    PERFORM CALCULATE_BACKBILLING.
*----------------------------------------------------------------*
* CALCULATE VARIANCE ACTUAL - BACKBILLING HOURS
*----------------------------------------------------------------*
    PERFORM CALCULATE_VARIANCEB.
*----------------------------------------------------------------*
* CALCULATE VARIANCE PERCENTAGE ACTUAL - BACKBILLING
*----------------------------------------------------------------*
    PERFORM CALCULATE_VARPERCENTB.

* end of insertion mod-005
*----------------------------------------------------------------*
* Populate Sold to party name
*----------------------------------------------------------------*
    PERFORM Sold_to_Party .

  ENDIF.
ENDFORM.                    " MEASURE_CALCULATE
*&---------------------------------------------------------------------*
*&      Form  CALCULATE_ACTUAL
*&---------------------------------------------------------------------*
FORM CALCULATE_ACTUAL .

*** Commented by Ravin on 23.11.04
*  data : i_readg like i_imrg-readg,
*         i_readg1 like i_imrg-readg,
*         i_readg2(16),
*         i_readg3(16),

data:  i_readg(15) type p,
       i_readg1(15) type p ,
       i_readg2 type I ,
       i_readg3 type I ,
        IDATE_LAST LIKE I_IMRG-IDATE,
         IDATE_FIRST LIKE I_IMRG-IDATE,
*** commented by Ravin on 22.11.04
*         IDATE_FINAL LIKE I_IMRG-IDATE,
*** Inserted by Ravin on 22.11.04
          idate_final type I ,
         L_INDEX2 LIKE SY-TABIX..
*SORT I_IMRG TABLE BY POINT AND IDATE
  sort i_imrg by point idate.
  LOOP AT OBJECT_TAB where EQUNR NE SPACE AND  POINT NE SPACE .
    L_INDEX = SY-TABIX.
    clear  g_count.
    LOOP AT I_IMRG where point EQ OBJECT_TAB-point.
      L_INDEX2 = SY-TABIX.

*--------------------------------------------------------------*
* UNIT_CONVERSION_SIMPLE WILL CONVERT THE READG INTO THE UNIT  *
* INDICATED IN OBJECT_TAB-MRNGU                                     *
*--------------------------------------------------------------*
      CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
        EXPORTING
          INPUT    = I_IMRG-READG
          UNIT_OUT = OBJECT_TAB-MRNGU
        IMPORTING
          OUTPUT   = I_IMRG-READG.
*-------------------------------------------------------------- *
      MODIFY I_IMRG INDEX L_INDEX2.
*COUNT IF THERE ARE MULTIPLE POINTS
      g_count = g_count + 1.
    ENDLOOP.
*-----------------------------------------------------*
*IF G_COUNT IS GREATER THAN 1                         *
*-----------------------------------------------------*
    if g_count > 1.
*-----------------------------------------------------*
*SORT THE I_IMRG INTERNAL TABLE TO GET THE LAST READMG *
*----------------------------------------------------- *
      sort i_imrg descending.
      read table i_imrg with key point = OBJECT_TAB-point.
      move i_imrg-readg to i_readg .
*      i_readg = i_imrg-readg.   "Commented by Ravin
      IDATE_LAST = I_IMRG-IDATE.
*-----------------------------------------------------*
*SORT THE I_IMRG INTERNAL TABLE TO GET THE FIRST READMG *
*-----------------------------------------------------
      sort i_imrg ascending.
      read table i_imrg with key point = OBJECT_TAB-point.
       move i_imrg-readg to i_readg1 .
*      i_readg1 = i_imrg-readg. "Commented by Ravin
      IDATE_FIRST = I_IMRG-IDATE.
*      i_readg2 = i_readg.    " Commented by Ravin
*      i_readg3 = i_readg1.   " Commented by Ravin
*      I_READG3 = I_READG2+0(12) - I_READG3+0(12).
*      g_result =  i_readg3.  " Commented by Ravin
      g_result = i_readg - i_readg1 .
    endif.
*----------------------------------------------------------------------*
* IF G_COUNT EQ 0 THEN MOVE 0 TO ACTUAL HRS                            *
* IF G_COUNT EQ 1 THEN MOVE 1 TO ACTUAL HRS                            *
* IF G_RESULT LESS THEN 0 THEN MOVE -1 TO ACTUAL HRS                   *
* IF G_RESULT GT 0 THEN ACTUAL RUNNING HRS = G_RESULT*365(IMRG_IDATE   *
* FROM LAST MEASUREMENT DOCUMENT -IMRG_IDATE FROM FIRST MEASUREMENT    *
* DOCUMENT
*----------------------------------------------------------------------*
    if g_count eq 0.
      OBJECT_TAB-AYEAR = 0.
    elseif g_count eq 1.
      OBJECT_TAB-AYEAR = 1.
    else.
      IF G_RESULT < 0.
        OBJECT_TAB-AYEAR = -1.
      ELSE.
        IDATE_FINAL = IDATE_LAST - IDATE_FIRST .
        IF IDATE_FINAL NE 0.
*** Commented by Ravin on 22.11.04
*         G_RESULT1 = G_RESULT * 365 MOD ( IDATE_LAST - IDATE_FIRST ).
         G_RESULT1 = G_RESULT * 365 / idate_final .
        ELSE.
          G_RESULT1 = G_RESULT * 365 .
        ENDIF.
        OBJECT_TAB-AYEAR = g_result1.
      ENDIF.
    endif.
    MODIFY OBJECT_TAB INDEX L_INDEX.
  ENDLOOP.

ENDFORM.                    " CALCULATE_ACTUAL
*&---------------------------------------------------------------------*
*&      Form  CALCULATE_VARIANCE
*&---------------------------------------------------------------------*
FORM CALCULATE_VARIANCE .
  LOOP AT OBJECT_TAB where EQUNR NE SPACE AND  POINT NE SPACE .

    L_INDEX = SY-TABIX.
    OBJECT_TAB-VARIANCE = OBJECT_TAB-AYEAR -
                                OBJECT_TAB-PYEAR.
    IF OBJECT_TAB-AYEAR EQ 0 OR
       OBJECT_TAB-AYEAR EQ 1 OR
       OBJECT_TAB-AYEAR EQ -1.
      OBJECT_TAB-VARIANCE  = CNST_VAR.
    endif.
    MODIFY OBJECT_TAB INDEX L_INDEX.

  ENDLOOP.

ENDFORM.                    " CALCULATE_VARIANCE
*&---------------------------------------------------------------------*
*&      Form  CALCULATE_VARPERCENT
*&---------------------------------------------------------------------*
FORM CALCULATE_VARPERCENT .
data: l_object_tab(15) type p decimals 2 ,
      l_object_tab_c(15) type c          ,
      c_%    type c value '%'            .


  LOOP AT OBJECT_TAB where EQUNR NE SPACE AND  POINT NE SPACE .
    L_INDEX =  SY-TABIX.
    IF OBJECT_TAB-PYEAR NE SPACE.
** Inserted by Ravin on 22.11.04
      l_object_tab = ( OBJECT_TAB-VARIANCE /
                                   OBJECT_TAB-PYEAR ) * 100 .
      write l_object_tab to l_object_tab_c .
      concatenate l_object_tab_c c_% into object_tab-variance% .

** Commented by Ravin on 23.11.04
*      OBJECT_TAB-VARIANCE% = OBJECT_TAB-VARIANCE /
*                                   OBJECT_TAB-PYEAR .
    ELSE.
   write object_tab-variance to l_object_tab_c .
   concatenate l_object_tab_c c_% into object_tab-variance% .
*      OBJECT_TAB-VARIANCE% = OBJECT_TAB-VARIANCE.
    ENDIF.
    IF OBJECT_TAB-AYEAR EQ 0 OR
       OBJECT_TAB-AYEAR EQ 1 OR
       OBJECT_TAB-AYEAR EQ  -1.

      OBJECT_TAB-VARIANCE% = CNST_PER.
    ENDIF.
    MODIFY OBJECT_TAB INDEX L_INDEX.
  ENDLOOP.
ENDFORM.                    " CALCULATE_VARPERCENT
*&---------------------------------------------------------------------*
*&      Form  Sold_to_Party
*&---------------------------------------------------------------------*
*       Populate Sold to party Name
FORM Sold_to_Party .

  if not object_tab[] is initial .
  select kunnr name1 from kna1
            into table i_kna1
            for all entries in object_tab
            where kunnr eq object_tab-kunnr .
    loop at object_tab .
      read table i_kna1 with key kunnr =  object_tab-kunnr .
       if sy-subrc eq 0 .
        object_tab-sname = i_kna1-name1 .
        modify object_tab .
       endif .
    endloop .
  endif .

ENDFORM.                    " Sold_to_Party
* begin of insertion mod-005
*&---------------------------------------------------------------------*
*&      Form  calculate backbilling
*&---------------------------------------------------------------------*
FORM CALCULATE_BACKBILLING .

data:  i_readg(15) type p,
       i_readg1(15) type p ,
       i_readg2 type I ,
       i_readg3 type I ,
        IDATE_LAST LIKE I_IMRG-IDATE,
         IDATE_FIRST LIKE I_IMRG-IDATE,
          idate_final type I ,
         L_INDEX2 LIKE SY-TABIX..
*SORT I_IMRG TABLE BY POINT AND IDATE
  sort i_imrg by point idate.
  LOOP AT OBJECT_TAB where EQUNR NE SPACE AND BPOINT NE SPACE .
    L_INDEX = SY-TABIX.
    clear  g_count.
    LOOP AT I_IMRG where point EQ OBJECT_TAB-BPOINT.
      L_INDEX2 = SY-TABIX.

*--------------------------------------------------------------*
* UNIT_CONVERSION_SIMPLE WILL CONVERT THE READG INTO THE UNIT  *
* INDICATED IN OBJECT_TAB-MRNGU                                     *
*--------------------------------------------------------------*
      CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
        EXPORTING
          INPUT    = I_IMRG-READG
          UNIT_OUT = I_IMPT-MRNGU
        IMPORTING
          OUTPUT   = I_IMRG-READG.
*-------------------------------------------------------------- *
      MODIFY I_IMRG INDEX L_INDEX2.
*COUNT IF THERE ARE MULTIPLE POINTS
      g_count = g_count + 1.
    ENDLOOP.
*-----------------------------------------------------*
*IF G_COUNT IS GREATER THAN 1                         *
*-----------------------------------------------------*
    if g_count > 1.
*-----------------------------------------------------*
*SORT THE I_IMRG INTERNAL TABLE TO GET THE LAST READMG *
*----------------------------------------------------- *
      sort i_imrg descending.
      read table i_imrg with key point = OBJECT_TAB-BPOINT.
      move i_imrg-readg to i_readg .
      IDATE_LAST = I_IMRG-IDATE.
*-----------------------------------------------------*
*SORT THE I_IMRG INTERNAL TABLE TO GET THE FIRST READMG *
*-----------------------------------------------------
      sort i_imrg ascending.
      read table i_imrg with key point = OBJECT_TAB-BPOINT.
       move i_imrg-readg to i_readg1 .
      IDATE_FIRST = I_IMRG-IDATE.
      g_result = i_readg - i_readg1 .
    endif.
*----------------------------------------------------------------------*
* IF G_COUNT EQ 0 THEN MOVE 0 TO BACKBILLING HOURS                     *
* IF G_COUNT EQ 1 THEN MOVE 0 TO BACKBILLING HOURS                     *
* IF G_RESULT LESS THEN 0 THEN MOVE -1 TO BACKBILLING HOURS            *
* IF G_RESULT GT 0 THEN BACKBILLING HRS = G_RESULT*365(IMRG_IDATE      *
* FROM LAST MEASUREMENT DOCUMENT -IMRG_IDATE FROM FIRST MEASUR.DOC     *
*----------------------------------------------------------------------*
    if g_count eq 0.
      OBJECT_TAB-BYEAR = 0.
    elseif g_count eq 1.
      OBJECT_TAB-BYEAR = 0.
    else.
      IF G_RESULT < 0.
        OBJECT_TAB-BYEAR = -1.
      ELSE.
        IDATE_FINAL = IDATE_LAST - IDATE_FIRST .
        IF IDATE_FINAL NE 0.
         G_RESULT1 = G_RESULT * 365 / idate_final .
        ELSE.
          G_RESULT1 = G_RESULT * 365 .
        ENDIF.
        OBJECT_TAB-BYEAR = g_result1.
      ENDIF.
    endif.
    MODIFY OBJECT_TAB INDEX L_INDEX.
  ENDLOOP.

ENDFORM.                    " CALCULATE_BACKBILIING
*&---------------------------------------------------------------------*
*&      Form  CALCULATE_VARIANCEB (backbilling)
*&---------------------------------------------------------------------*
FORM CALCULATE_VARIANCEB.
  LOOP AT OBJECT_TAB where EQUNR NE SPACE AND BPOINT NE SPACE .

    L_INDEX = SY-TABIX.
    OBJECT_TAB-VARIANCEB = OBJECT_TAB-AYEAR -
                                OBJECT_TAB-BYEAR.
    IF OBJECT_TAB-BYEAR EQ 0 OR
       OBJECT_TAB-BYEAR EQ 1 OR
       OBJECT_TAB-BYEAR EQ -1.
      OBJECT_TAB-VARIANCEB  = CNST_VAR.
    endif.
    MODIFY OBJECT_TAB INDEX L_INDEX.

  ENDLOOP.

ENDFORM.                    " CALCULATE_VARIANCEB
*&---------------------------------------------------------------------*
*&      Form  CALCULATE_VARPERCENT BACKBILLING
*&---------------------------------------------------------------------*
FORM CALCULATE_VARPERCENTB.
data: l_object_tab(15) type p decimals 2 ,
      l_object_tab_c(15) type c          ,
      c_%    type c value '%'            .

  LOOP AT OBJECT_TAB where EQUNR NE SPACE AND BPOINT NE SPACE .
    L_INDEX =  SY-TABIX.
    IF OBJECT_TAB-AYEAR NE SPACE.

      l_object_tab = ( OBJECT_TAB-VARIANCEB /
                                   OBJECT_TAB-AYEAR ) * 100 .
      write l_object_tab to l_object_tab_c .
      concatenate l_object_tab_c c_% into object_tab-varianceb% .

*      OBJECT_TAB-VARIANCEBb% = OBJECT_TAB-VARIANCE /
*                                   OBJECT_TAB-AYEAR .
    ELSE.
   write object_tab-varianceb to l_object_tab_c .
   concatenate l_object_tab_c c_% into object_tab-varianceb% .
    ENDIF.
    IF OBJECT_TAB-BYEAR EQ 0 OR
       OBJECT_TAB-BYEAR EQ 1 OR
       OBJECT_TAB-BYEAR EQ  -1.

      OBJECT_TAB-VARIANCEB% = CNST_PER.
    ENDIF.
    MODIFY OBJECT_TAB INDEX L_INDEX.
  ENDLOOP.
ENDFORM.                    " CALCULATE_VARPERCENTB


* end of insertion mod-005
*Text symbol text£º
*004:From (date/time)
*005:To (date/time)
*201:Installation period
*202:Contract period
*204:Schedule overview
*205:Contracts for PM objects
*206:Legend
*207:Contract selection
*700:**** LINES 701, 702, 703 are one sentence.
*701:Do you want to cancel processing
*702:for all the objects selected that
*703:have not yet been processed?
*704:List editing canceled
*705:No
*706:Yes
*800:Unprocessed        objects
*801:Processed          objects
*802:Last objects processed
*ANZ:Number
*F01:Object data
*F02:Contract data
*F03:Purchase order data
*F04:SD data
*F05:Cur. translation
*F06:Time Restriction
*P05:Net value
*PO1:High no., high value
*PO2:Low number, high value
*PO3:High number, low value
*PO4:Low number, low value

*SON:Others
*Selection text£º
*ABGRU:D       Reason for rejection
*ARKTX:D       Description
*AUART:D       Sales document type
*AUGRU:D       Reason for order
*BNAME:D       Name
*BSARK:D       Order type
*BSTDK:D       Purchase order date
*BSTNK:D       Purchase order number
*BSTZD:D       Additional data
*CHARG:D       Batch
*DATE1:D
*DATE2:D
*EAN11:D       EAN/UPC
*EQUNR:D       Equipment
*ERNAM:D       Created by
*IHREZ:D       Your reference
*KDMAT:D       Customer material
*KUNNR:D       Sold-to party
*MATKL:D       Material group
*MATNR:D       Material
*MATWA:D       Material entered
*MEINS:D       Base unit of measure
*MVGR1:D       Material Group 1
*MVGR2:D       Material Group 2
*MVGR3:D       Material Group 3
*MVGR4:D       Material Group 4
*MVGR5:D       Material Group 5
*NETWRX:D       Net value
*POSEX:D       Purchase order item
*POSNR:D       Item
*PRODH:D       Product hierarchy
*PSTYV:D       Item category
*SDAUFNR:D       Sales document
*SERNR:D       Serial number
*SPART:D       Division
*STRNO:D       Functional location
*SUBMI:D       Submission
*TELF1:D       Telephone
*UEPOS:D       Superior item
*VABNDAT:D       Acceptance date
*VAKTSCH:D       Activity
*VARIANT:D       Layout
*VBEDKUE:D       Date of cancellation document
*VBEGDAT:D       Contract start date
*VBEGREG:D       Contract start rule
*VBELKUE:D       Cancellation doc. for partner
*VDEMDAT:D       Dismantling date
*VEINDAT:D       Receipt of cancellation
*VENDDAT:D       Contract end date
*VGBEL:D       Reference document
*VGPOS:D       Reference item
*VINSDAT:D       Installation date
*VKBUR:D       Sales office
*VKGRP:D       Sales group
*VKORG:D       Sales organization
*VKUEGRU:D       Cancellation reason
*VKUEPAR:D       Cancellation party
*VKUESCH:D       Cancellation procedure
*VLAUFK:D       Validity period category
*VLAUFZ:D       Validity period of contract
*VTWEG:D       Distribution channel
*VUNTDAT:D       Contract signed
*VVORZEIT:D       Activity lead time
*VWUNDAT:D       Required cancellation date
*WAERS:D       To-currency
*WERKS:D       Plant
*ZMENG:D       Target quantity
