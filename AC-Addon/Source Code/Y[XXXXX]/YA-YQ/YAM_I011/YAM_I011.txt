*----------------------------------------------------------------------*
*
* PROGRAM ID           : YAM_I011                                      *
* PROGRAM TITLE        : Stand Alone ServiceOrder Idoc Program         *
* AUTHOR               : Amit Mahajan                                  *
* DATE                 : 10/08/2004                                    *
* DEVELOPMENT ID       : XXXX                                          *
*
* CHANGE REQUEST NUMBER:                                               *
* PROGRAM DESCRIPTION  : THIS IS A CUSTOM PROGRAM TO GENERATE THE      *
*                        SERVICE ORDER OUTBOUND IDOC FROM SAP TO       *
*                        BPCS.THIS PROGRAM CHECKS ONLY FOR THE ORDERS  *
*                        WHICH HAVE CREATED OR RELEASED STATUS.        *
*                                                                      *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 | 2004.10.05 | AMIT MAHAJAN |CD1K900553 |CR041| ADD ADDRESS *
*                                      INFO,MATERIAL AND SERIAL NUMBER*
* MOD-002 | 2004.11.24 | Ravin Malhotra|CD1K900840|CR053| Service Order*
*                                        close date needs to be sent  *
* MOD-003 | 2004.12.03 | Ravin Malhotra|CD1K901055|CR058| Service Order*
*                                       info to be sent based on status*
* MOD-004 | 2004.12.15 | AMIT MAHAJAN|CD1K901181|| Sortl field based on
*                                       the service order Status Closed*
* MOD-005 | 2004.01.19 | Luc Mertens    |CD1K901366| TPR UAT-028       *
* MOD-006 | 2004.01.21 | Luc Mertens    |CD1K901392| CR107 | Addition. *
*                                         selection on ordertype       *
* MOD-007 | 2004.01.27 | Luc Mertens    |CD1K901443| TPR CP013         *
*                                         select also PRIOK            *
* MOD-008  | 2005.02.02 | Vikrant Sud   | Additional fields ZZCON and  *
*                                         ZZSDC required as per CR120  *
* MOD-009 | 2005.02.14 | Luc Mertens    |CD1K901620|CR127| add. fields *
*                 INGPR and ERNAM ; correct read of component table    *
* MOD-010 | 2005.03.01 | Luc Mertens  |CD1K901776 |CR145 |send complete*
*                                        header when closed status     *
* MOD-011 | 2005.03.21 | Luc Mertens  |CD1K901910 |CR158 |send acc.ind *
* MOD-012 | 2005.03.30 | Luc Mertens  |CD1K901958 |CR164 |             *
*                    send order data when order is reopened            *
* MOD-013 | 2005.05.26 | Luc Mertens  |CD1K902402 |DE-CR044            *
*                    send additionnal fields                           *
* MOD-014 | 2005.05.27 | Luc Mertens  |CD1K902402 |CR164               *
* MOD-015 | 2005.06.10 | Luc Mertens  |CD1K902528 |DE-TPR-CP017        *
* MOD-016 | 2005.06.28 | Luc Mertens  |CD1K902683 |DE-CR052            *
* MOD-017 | 2005.07.18 | Luc Mertens  |CD1K902833 |DE-TPR-CP023        *
* MOD-018 | 2005.07.18 | Luc Mertens  |CD1K902841 |DE-CR052            *
* MOD-019 | 2005.09.20 | Luc Mertens  |CD1K903252 |DE-CR065            *
*                    add fields from enhancement tab                   *
* MOD-020 | 2006.02.16 | Luc Mertens  |CD1K904782 |ALL-CR209           *
*            - replace GSTRP by GSTRS and send complete header when    *
*              sched.startdate (GSTRS) is changed                      *
* MOD-021 | 2006.06.22 | Luc Mertens  |CD1K905945 |NL-Issue081         *
* MOD-022 | 2006.06.26 | Luc Mertens  |CD1K905967 |                    *
*            - improve search for components with help of AFKO-table   *
*            - if old value of 'EPANF' or 'EPEND' is initial           *
*                ---> this is no change                                *
* MOD-023 | 2006.11.06 | Luc Mertens  |CD1K907257 |NL-Issue276         *
* MOD-024 | 2007.01.23 | Marc Jacobs  |CD1K909679 |NO CR017            *
*            - functional location info in field remark if empty       *
* MOD-025 | 2008.04.10 | Marc Jacobs  |CD2K940573 |partner  via        *
*            yam_sel_partner                                           *
* MOD-026 | 2008.06.05 | Marc Jacobs  |CD1K941072 | performance change *
* MOD-027 | 2008.06.12 | Luc Mertens  |CD1K941    | CR0168             *
* MOD-028 | 2009.02.05 | Geert Rutten |CD1K946325 | CR0651             *
*           - Send Planner                                             *
* MOD-029 | 2009.06.05 | Satyabrata Basu |CD1K948613 | CR0858          *
*           - Bugfix in Ship-to-address going empty to middleware      *
* MOD-030 | 2009.06.17 | GBA change to fill REMARK field               *
* MOD-031 | 2011.01.17 | Lakshmi Reddy|CD1K962425 | CR1880             *
*                        Prevent sending Idocs with SEO CLSD but       *
*                        quotation is not acceppted                    *
* MOD-032 | 2012.04.17 | Geert Rutten|CD1K971389 | CR2493              *
*                        extension of accounting indicators            *
*                        for FP flow: OH, AN, ER and ZSM7 contracts    *
*                        send other acc indicator to bpcs              *
* MOD-033 | 2012.11.19 | Geert Rutten|CD1K973942|                      *
*                        Reduce number of idcos                        *
* MOD-034 | 2013.02.06 | Jules Smets | BugFix | CD1K975065             *
*                        Checkbox for end time determination           *
************************************************************************
REPORT  yam_i011 NO STANDARD PAGE HEADING MESSAGE-ID yam_inf.

************************************************************************
*                  D A T A B A S E   T A B L E S                       *
************************************************************************
TABLES:  aufk,               "Order master data
         afko,               "Order master data
         afih,               "Maintenance order header
         caufv,              "View "Order Headers PP/CO"
         resb,               "Reservation/dependent requirements
         qmel,               "Quality Notification
         adrc,               "Addresses (Business Address Services)
         ihpa,               "Plant Maintenance: Partnersa
         kna1,               "Customer Master
* begin of insert MOD-013
         pmsdo,              "PM organizational data for SD documents
* end of insert MOD-013
         edidc,              "Control record (EDI Intermediate Document)
         edidd,               "Data record (IDoc)
         edids,               "Status Record (IDoc)
         yam_io11_e1ordhdr,   "HEADER SEGMENT FOR SERVICE ORDER IDOC
         yam_io11_e1oropr_mat,"SEGMENT COMPONENT OF SERVICE ORDER IDOC
* begin of insert MOD-017
         yam_io11_status, "table for check status in order to send parts
* end of insert MOD-017
* begin of insert MOD-024
         iloa,               "functional locations
         iflotx,             "description of functional locations
* end of insert MOD-024
         yam_io11.           "TABLE FOR CHECKING COMPONENT DATA

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************
*     ORDER HEADER DATA TABLE                                          *
************************************************************************

DATA : BEGIN OF i_ord_head OCCURS 0,
       aufnr LIKE aufk-aufnr,
       erdat LIKE aufk-erdat,
       aedat LIKE aufk-aedat,
       objnr LIKE aufk-objnr,
* begin of change MOD-020
*      gstrp LIKE afko-gstrp,
       gstrs LIKE afko-gstrs,
* end of change MOD-020
       priok LIKE afko-aprio,
       kunum LIKE qmel-kunum,
       ilart LIKE afih-ilart,
*------------------------------------------------------------*
* BEGIN OF CR041                                             *
*------------------------------------------------------------*
       equi_name1 LIKE adrc-name1,
       equi_street LIKE adrc-street,
       equi_city1  LIKE adrc-city1,
       equi_country LIKE adrc-country,
       equi_post_code1 LIKE adrc-post_code1,
       equi_region LIKE adrc-region,
       equi_matnr LIKE riwol-matnr,
       equi_sernr LIKE riwol-sernr,
*------------------------------------------------------------*
* END OF CR041                                               *
*------------------------------------------------------------*
*------------------------------------------------------------*
* BEGIN OF CR053                                             *
*------------------------------------------------------------*
      flag(1) TYPE c ,
*------------------------------------------------------------*
* BEGIN OF CR053                                             *
*------------------------------------------------------------*
* Start of MOD-008
       zzcon LIKE aufk-zzcon,
       zzsdc LIKE aufk-zzsdc,
* End of MOD-008
* Start of MOD-009
       ingpr LIKE afih-ingpr,
       ernam LIKE aufk-ernam,
* End of MOD-009
* Start of MOD-011
       bemot LIKE aufk-bemot,
* End of MOD-011
* Start of MOD-013
       bstkd TYPE bstkd,
* End of MOD-013
* Start of MOD-019
       zzapc LIKE aufk-zzapc,
       zzpsf LIKE aufk-zzpsf,
       zztrc LIKE aufk-zztrc,
* End of MOD-019
* begin of insertion MOD-025
       bukrs LIKE aufk-bukrs,
* end of insertion MOD-025
* begin of insert MOD-028
       iwerk LIKE afih-iwerk,
* end of insert MOD-028
* begin of insert MOD-032
       kdauf LIKE aufk-kdauf,
* end of insert MOD-032
END OF i_ord_head.

* Begin of insert MOD-032
DATA: lv_auart TYPE auart,
      lv_convert TYPE c,
      lv_bemot TYPE bemot,
      lv_matkl TYPE matkl,
      lv_servp TYPE matnr.
* End of insert MOD-032

************************************************************************
*    ORDER COMPONENT DATA TABLE                                        *
************************************************************************

DATA : BEGIN OF i_ord_comp OCCURS 0,
       aufnr LIKE resb-aufnr,
       posnr LIKE resb-posnr,
       matnr LIKE resb-matnr,
       bdmng LIKE resb-bdmng,
       bdter LIKE resb-bdter,
       wempf LIKE resb-wempf,
       END OF i_ord_comp.

************************************************************************
*    ORDER SYSTEM STATUS TABLE                                         *
************************************************************************

DATA : BEGIN OF i_status OCCURS 0,
       objnr LIKE jest-objnr,
       stat LIKE jstat-stat,
       inact LIKE jstat-inact,
       END OF i_status.

DATA :BEGIN OF i_ihpa OCCURS 0,
       objnr LIKE aufk-objnr,
       parnr LIKE ihpa-parnr,
       parvw LIKE ihpa-parvw,
       sortl LIKE kna1-sortl,
       kunnr LIKE kna1-kunnr,
       name1 LIKE kna1-name1,
       street LIKE kna1-stras,
       city1 LIKE kna1-ort01,
* begin of insert MOD-013
       adrnr LIKE ihpa-adrnr,
* end of insert MOD-013
* begin of insert MOD-015
       adrnr_kna1 LIKE kna1-adrnr,
* end of insert MOD-015
       post_code1 LIKE kna1-pstlz,
       country LIKE kna1-land1,
       END OF i_ihpa.

*------------------------------------------------------------*
* BEGIN OF CR041                                             *
*------------------------------------------------------------*
DATA: BEGIN OF  i_iriwol OCCURS 100.
        INCLUDE STRUCTURE  riwol .
DATA: END OF i_iriwol.

* begin of insert MOD-022
DATA : BEGIN OF gt_afko OCCURS 0,
         rsnum LIKE afko-rsnum,
       END OF gt_afko.
* end of insert MOD-022
* begin of insert MOD-024
DATA : g_tplnr LIKE iloa-tplnr,
       g_iloan LIKE iloa-iloan,
       g_pltxt LIKE iflotx-pltxt.
* end of insert MOD-024
* begin of insertion MOD-025
DATA : g_bukrs LIKE aufk-bukrs.
* end of insertion MOD-025
*------------------------------------------------------------*
* END OF CR041                                             *
*------------------------------------------------------------*
************************************************************************
*    Internal Table and Work area                                      *
************************************************************************

DATA: i_edidc_control_comm LIKE edidc OCCURS 1 WITH HEADER LINE.
DATA: i_edidd_data LIKE edidd OCCURS 0 WITH HEADER LINE.
DATA: i_edids LIKE edids OCCURS 0 WITH HEADER LINE.
DATA: i_yam_io11 LIKE yam_io11 OCCURS 0 WITH HEADER LINE.
DATA:wa_yam_io11_e1ordhdr LIKE yam_io11_e1ordhdr.
DATA: wa_yam_io11_e1oropr_mat LIKE yam_io11_e1oropr_mat.
DATA: wa_edidc_control LIKE edidc.
DATA: wa_yam_io11 LIKE yam_io11.
** added by Ravin for CR-053
DATA: wa_ord_cls_date TYPE sy-datum ,
      wa_aufk_objnr TYPE aufk-objnr ,
      wa_jest_chgnr TYPE jest-chgnr,
************************************************************************
* added by amit for the sortl field when service order is closed *
* 15.12.2004
************************************************************************
      wa_sortl TYPE kna1-sortl.
************************************************************************

** Begin of Mod-029 - Satya
**
DATA lt_adrc TYPE TABLE OF adrc.
DATA ls_adrc LIKE LINE OF lt_adrc.
** End of Mod-029 - Satya

**
*CONSTANTS
CONSTANTS :c_ord_header LIKE edidd-segnam VALUE 'YAM_IO11_E1ORDHDR',
           c_ord_detail LIKE edidd-segnam VALUE 'YAM_IO11_E1OROPR_MAT',
           c_idoc_type  LIKE edidc-idoctp VALUE 'YAM_IO11_IORDER01',
           c_plant LIKE aufk-werks VALUE 'GBAA',
           c_mestyp LIKE edidc-mestyp VALUE 'YAM_IO11_IORDER',
           c_sc1(3) VALUE 'SC1',
           c_input VALUE '0',
           c_ls(2) VALUE 'LS',
           c_status(4) VALUE 'XXXX',
           c_x VALUE 'X',
           c_t VALUE 'T' ,
           c_n VALUE 'N',                    "insert MOD-031
* begin of insert MOD-013
           c_e          TYPE spras VALUE 'E',
* end of insert MOD-013
* Begin of insert MOD-030
           c_remark(50) VALUE 'Compressor Spares for the AtlasCopco Service visit'.
* End of insert MOD-030
* begin of deletion MOD-025
*           c_clnt(4)    TYPE c VALUE 'CLNT' ,
*           c_wbi(3)     TYPE c VALUE 'WBI'   .
* end of deletion MOD-025

************************************************************************
*                   V A R I A B L E S / C O N S T A N T S              *
************************************************************************

DATA: l_index LIKE sy-tabix,
      l_index1 LIKE sy-tabix,
      l_index2 LIKE sy-tabix,
      l_flag(1),
      l_flag1(1),
* begin of insertion MOD-005
      g_stat(6) TYPE c,
* end of insertion MOD-005
* begin of insert MOD-017,
      g_istat TYPE j_status,
* end of insert MOD-017,
* begin of insertion MOD-012
      g_flag_reopened(1) TYPE c,
* end of insertion MOD-012
* begin of insert MOD-020
      g_chgd(1),
* end of insert MOD-020
      g_idoc_sent(1),
      g_date LIKE sy-datum,
* begin of insert MOD-033
      lv_datum TYPE sy-datum,
      lv_time TYPE sy-uzeit,
* end of insert MOD-033

*------------------------------------------------------------*
* BEGIN OF CR041                                             *
*------------------------------------------------------------*
     adrnr LIKE adrc-addrnumber,
     aufnr LIKE afko-aufnr,
     l_status(15),
     l_flag2(1),
     l_flag3(1),
     l_vbeln TYPE vbak-vbeln ,
     p_logsys LIKE tbdlst-logsys .

*------------------------------------------------------------*
* END OF CR041                                               *
*------------------------------------------------------------*
DATA: lv_idoc_flag TYPE c LENGTH 1.

************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************

SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
SELECT-OPTIONS: s_aufnr FOR afko-aufnr .
SELECT-OPTIONS: s_erdat FOR aufk-erdat .
* begin of insert MOD-033
SELECT-OPTIONS: s_erzeit FOR aufk-erfzeit .
* end of insert MOD-033
SELECT-OPTIONS: s_werks FOR aufk-werks OBLIGATORY  DEFAULT c_plant .
* begin of insertion MOD-006
SELECT-OPTIONS: s_auart FOR aufk-auart .
* end of insertion MOD-006
*MESSAGE SYSTEM
PARAMETERS: p_mestyp LIKE edmsg-msgtyp DEFAULT c_mestyp MODIF ID sc1.
*DESTINATION SYSTEM
*PARAMETERS: P_LOGSYS LIKE TBDLST-LOGSYS OBLIGATORY .
*** MOD-034 * begin ***
SELECTION-SCREEN SKIP.
* Checkbox for end time determination
PARAMETERS: p_oretd  AS CHECKBOX.
*** MOD-034 * end ***
SELECTION-SCREEN: END OF BLOCK b1.


************************************************************************
*      INITIALIZE THE CREATION DATE FIELD OF SERVICE ORDER             *
*      S_ERDAT-LOW WILL HOLD THE DATE OF 2 DAYS EARLIER THAN THE       *
*      SYSTEM DATE AND S_ERDAT-HIGH WILL HOLD THE TODAY'S DATE VALUE   *
*      BY DEFAULT.USER CAN CHANGE THIS AS PER CONVINANCE               *
************************************************************************

INITIALIZATION.
  g_date = sy-datum - 2.
  MOVE: 'BT' TO s_erdat-option,
         g_date TO s_erdat-low,
         sy-datum TO s_erdat-high.
  APPEND s_erdat.


  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = p_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
* begin of deletion MOD-025
*  ELSE.
*    REPLACE FIRST OCCURRENCE OF c_clnt IN p_logsys WITH c_wbi .
* end of deletion MOD-025
  ENDIF.

************************************************************************
*      MODIFY THE SELECTION SCREEN BY MAKING THE INPUT FIELDS AS       *
*      READALE                                                         *
************************************************************************
AT SELECTION-SCREEN OUTPUT.

  LOOP AT SCREEN.
    IF screen-group1 = c_sc1.
      screen-input   = c_input.
      MODIFY SCREEN.
      CONTINUE.
    ENDIF.
  ENDLOOP.

************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.
************************************************************************
*      CLEAR THE WORK AREA AND INTERNAL TABLES                         *
************************************************************************
  CLEAR: wa_yam_io11_e1ordhdr,
         wa_yam_io11_e1oropr_mat,
         i_edidc_control_comm,
         i_edidd_data,
         wa_yam_io11.
  REFRESH: i_ord_head,
           i_ord_comp.



************************************************************************
*CHECK IF IDOC CONFIGURATION IS READY AND IDOC CAN BE PROCESSED.       *
************************************************************************

  CALL FUNCTION 'ALE_MODEL_DETERMINE_IF_TO_SEND'
    EXPORTING
      message_type           = p_mestyp
    IMPORTING
      idoc_must_be_sent      = g_idoc_sent
    EXCEPTIONS
      own_system_not_defined = 1
      OTHERS                 = 2.

  IF sy-subrc <> 0.
    MESSAGE e029 WITH c_mestyp.
    EXIT.
  ENDIF.

************************************************************************
*          FILL CONTROL RECORDS                                        *
************************************************************************

  wa_edidc_control-mestyp = p_mestyp.
  wa_edidc_control-idoctp = c_idoc_type.
  wa_edidc_control-rcvprt = c_ls.
* begin of deletion MOD-025
*  wa_edidc_control-rcvprn =  p_logsys .
* end of deletion MOD-025

************************************************************************
*  SELECT SERVICE ORDER HEADER DATA                                    *
************************************************************************
*Start of MOD-008
*  SELECT aufnr erdat aedat objnr gstrp
*start of mod-009
* SELECT aufnr erdat aedat objnr gstrp zzcon zzsdc
* begin of change MOD-020
* SELECT aufnr erdat aedat objnr gstrp zzcon zzsdc ernam

* begin of insert MOD-033
* Make sure that only for scheduled jobs we will change the selection to the changes of the last hour
  IF s_erdat-low = sy-datum  AND
     sy-batch = 'X'          AND
     p_oretd IS INITIAL.                                    "MOD-034
    CALL FUNCTION 'END_TIME_DETERMINE'
      EXPORTING
        duration                   = -1
        unit                       = 'H'
        factory_calendar           = '99'
      IMPORTING
        end_date                   = lv_datum
        end_time                   = lv_time
      CHANGING
        start_date                 = sy-datum
        start_time                 = sy-uzeit
      EXCEPTIONS
        factory_calendar_not_found = 1
        date_out_of_calendar_range = 2
        date_not_valid             = 3
        unit_conversion_error      = 4
        si_unit_missing            = 5
        parameters_no_valid        = 6
        OTHERS                     = 7.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      WRITE: / 'error', lv_datum, lv_time, sy-datum, sy-uzeit, s_erdat-low, s_erdat-high, s_erzeit-low, s_erzeit-high.
    ELSE.
      CLEAR: s_erdat[], s_erzeit[].
      s_erdat-sign = 'I'.
      MOVE: 'BT' TO s_erdat-option,
      lv_datum TO s_erdat-low,
      lv_datum TO s_erdat-high.
      APPEND s_erdat.
      s_erzeit-sign = 'I'.
      MOVE: 'BT' TO s_erzeit-option.
      IF lv_time < '010000'.
        lv_time = '000000'.
      ELSE.
        MOVE lv_time TO s_erzeit-low.
      ENDIF.
      IF sy-datum <> lv_datum.
        s_erzeit-high = '235959'.
      ELSE.
        MOVE sy-uzeit TO s_erzeit-high.
      ENDIF.
      APPEND s_erzeit.

    ENDIF.
  ENDIF.
* end of insert MOD-033
  SELECT aufnr erdat aedat objnr gstrs zzcon zzsdc ernam
* end of change MOD-020
* begin of mod-011
         bemot
* end of mod-011
* begin of mod-019
         zzapc zzpsf zztrc
* end of mod-019
*end of mod-009
* begin of insert mod-032
         kdauf
* end of insert mod-032
*       INTO  i_ord_head FROM caufv
       INTO  CORRESPONDING FIELDS OF i_ord_head FROM caufv
*End of MOD-008
       WHERE aufnr IN s_aufnr
* begin of insertion MOD-006
       AND   auart IN s_auart
* end of insertion MOD-006
       AND   werks IN s_werks
* begin of insertion MOD-026
       AND   erdat IN s_erdat
* begin of insert MOD-033
       AND   erfzeit IN s_erzeit
* end of insert MOD-033
       OR    aufnr IN s_aufnr
       AND   auart IN s_auart
       AND   werks IN s_werks
       AND   aedat IN s_erdat
* end of insertion MOD-026
* begin of insert MOD-033
       AND   aezeit IN s_erzeit.
* end of insert MOD-033
************************************************************************
*         VALIDATION FOR SERVICE ORDER                                 *
************************************************************************
    IF sy-subrc NE 0.
      MESSAGE e024 .
    ENDIF.
************************************************************************
*         CHECK FOR THE SERVICE ORDER IN BETWEEN DATE                  *
************************************************************************
* begin of deletion MOD-026
*    IF i_ord_head-erdat IN s_erdat OR i_ord_head-aedat IN s_erdat.
* end of deletion MOD-026
    IF sy-subrc EQ 0.
      APPEND i_ord_head.
      CLEAR i_ord_head.
    ENDIF.
* begin of deletion MOD-026
*    ENDIF.
* end of deletion MOD-026
  ENDSELECT.


************************************************************************

  LOOP AT i_ord_head.
    l_index = sy-tabix.

************************************************************************
* SHIP TO ADDRESS IS NOT AVAILABLE ON THE COMPONENT LEVEL IN SAP       *
* SO TO CLASSIFY THE SERVICE ORDER'S SELECT MAINTENANCE ACTIVITY TYPE  *
* FROM MAINTENANCE ORDER HEADER WHICH WILL BEMAINTAINED AT HEADER LEVEL*
* TO IDENTIFY THE SERVICE ORDER'S                                      *
************************************************************************

* begin of change MOD-007
*   SELECT SINGLE ILART INTO I_ORD_HEAD-ILART FROM AFIH
* begin of change mod-028 iwerk into (i_ord_head-iwerk)
* begin of change mod-009
*   SELECT SINGLE ilart priok INTO (i_ord_head-ilart, i_ord_head-priok)
    SELECT SINGLE ilart priok ingpr iwerk INTO
             (i_ord_head-ilart, i_ord_head-priok, i_ord_head-ingpr, i_ord_head-iwerk)
* end of change mod-009
* end of change mod-028
                           FROM afih
* end of change MOD-007
                        WHERE aufnr EQ i_ord_head-aufnr.
    MODIFY i_ord_head INDEX l_index.

* begin of insert MOD-013
    SELECT SINGLE bstkd INTO i_ord_head-bstkd
       FROM pmsdo WHERE objnr = i_ord_head-objnr.
    MODIFY i_ord_head INDEX l_index.
* end of insert MOD-013

************************************************************************
*    SELECT m~objnr m~parnr m~parvw  n~sortl n~name1 n~stras n~ort01
** begin of insert MOD-013
*    m~adrnr
** end of insert MOD-013
** begin of insert MOD-015
*    n~adrnr
** end of insert MOD-015
*    n~pstlz n~land1 INTO (i_ihpa-objnr,i_ihpa-parnr,i_ihpa-parvw,
*    i_ihpa-sortl,i_ihpa-name1,i_ihpa-street,i_ihpa-city1,
** begin of insert MOD-013
*    i_ihpa-adrnr,
** end of insert MOD-013
** begin of insert MOD-015
*    i_ihpa-adrnr_kna1,
** end of insert MOD-015
*    i_ihpa-post_code1,i_ihpa-country) FROM ihpa
*      AS m JOIN kna1 AS n
*      ON m~parnr = n~kunnr
*      WHERE m~objnr = i_ord_head-objnr.
*      APPEND i_ihpa.
*      CLEAR  i_ihpa.
*    ENDSELECT.

*------------------------------------------------------------*
* BEGIN OF CR041                                             *
*------------------------------------------------------------*
***********************************************************************
************************************************************************
* CALL FUNCTION MODULE MSM_GRAPH_GET_ADDRESS_NUMBER TO GET THE ADRESS *
* NUMBER FOR THE SERVICE ORDER
************************************************************************
    CALL FUNCTION 'MSM_GRAPH_GET_ADDRESS_NUMBER'
      EXPORTING
        aufnr      = i_ord_head-aufnr
      IMPORTING
        addrnumber = adrnr.
    IF sy-subrc EQ 0.
      SELECT SINGLE name1 street city1 country post_code1 region INTO
    (i_ord_head-equi_name1,i_ord_head-equi_street,i_ord_head-equi_city1,
       i_ord_head-equi_country,i_ord_head-equi_post_code1,
       i_ord_head-equi_region)
       FROM adrc WHERE addrnumber = adrnr.
      MODIFY i_ord_head INDEX l_index.
    ENDIF.
    CLEAR adrnr .
*---------------------------------------------------------------------*
* CALL IWOL_GET_OBJECT_LIST_ALL  TO GET THE MATERIAL NUMBER AND SERIAL*
* NUMBER BASED ON ORDER NO                                            *
*---------------------------------------------------------------------*
    aufnr = i_ord_head-aufnr.
    CALL FUNCTION 'IWOL_GET_OBJECT_LIST_ALL'
      EXPORTING
        i_aufnr = aufnr
      TABLES
        iriwol  = i_iriwol.
    .
    IF sy-subrc = 0.
      READ TABLE i_iriwol INDEX 1.
      MOVE i_iriwol-matnr TO  i_ord_head-equi_matnr.
      MOVE i_iriwol-sernr TO  i_ord_head-equi_sernr.
      MODIFY i_ord_head INDEX l_index.
    ENDIF.
    CLEAR aufnr.
*------------------------------------------------------------*
* END OF CR041                                               *
*------------------------------------------------------------*
*------------------------------------------------------------*
* BEGIN OF CR041                                             *
*------------------------------------------------------------*
    CLEAR: l_vbeln, i_ord_head-flag .
    CLEAR: lv_idoc_flag.              "insert MOD-031
** Modified by Ravin on 24/11/04
** Validate for Service Order Close status
    SELECT SINGLE objnr stat inact FROM jest
     INTO (i_status-objnr,i_status-stat,i_status-inact)
                 WHERE objnr = i_ord_head-objnr
                 AND stat EQ 'I0046'
                 AND inact NE 'X' .
    IF sy-subrc EQ 0 .
      i_ord_head-flag = c_x .
      MODIFY i_ord_head INDEX l_index.
*Begin of insert MOD-031
*Validate for Service Order QUCR status
      SELECT SINGLE objnr stat inact FROM jest
       INTO (i_status-objnr,i_status-stat,i_status-inact)
                   WHERE objnr = i_ord_head-objnr
                   AND stat EQ 'I0395'
                   AND inact NE 'X'.
      IF sy-subrc EQ 0.
        i_ord_head-flag = c_n .
        MODIFY i_ord_head INDEX l_index.
      ENDIF.
*End   of insert MOD-031
    ELSE .
** Modified by Ravin on 03/12/04
** Identification for TECO status in Service Order
      SELECT SINGLE objnr stat inact FROM jest
       INTO (i_status-objnr,i_status-stat,i_status-inact)
                   WHERE objnr = i_ord_head-objnr
                   AND stat EQ 'I0045'
                   AND inact NE 'X' .
      IF sy-subrc EQ 0 .
        i_ord_head-flag = c_t .
        MODIFY i_ord_head INDEX l_index.
      ELSE.


** Modification by Ravin on 031204
*   select single vbeln into l_vbeln from vbak*
*                       where aufnr eq i_ord_head-aufnr .
** Inserted by Ravin on 031204
* begin of delete MOD-017
*       SELECT SINGLE objnr stat inact FROM jest
*        INTO (i_status-objnr,i_status-stat,i_status-inact)
*                    WHERE objnr = i_ord_head-objnr
*                    AND stat EQ 'I0395'
*                    AND inact NE 'X' .
* end of delete MOD-017
* begin of insert MOD-017
        CLEAR g_istat.
        SELECT SINGLE stat FROM yam_io11_status
          INTO g_istat
          WHERE bemot = i_ord_head-bemot.
* end of insert MOD-017
        IF sy-subrc NE 0 .
************************************************************************
*   CHECK SYSTEM STATUS FOR THE ORDER                                  *
************************************************************************
          SELECT objnr stat inact FROM jest
          INTO (i_status-objnr,i_status-stat,i_status-inact)
          WHERE objnr = i_ord_head-objnr
          AND stat IN ('I0001','I0002') .

************************************************************************
*     CHECKING THE STATUS TABLE FOR VARIOUS SYSTEM STATUS              *
************************************************************************
            IF sy-subrc EQ 0 AND i_status-inact EQ space .
              APPEND i_status.
              CLEAR  i_status.
            ENDIF.
          ENDSELECT.
          IF sy-subrc EQ 0.
            READ TABLE i_status WITH KEY objnr = i_ord_head-objnr.
            IF sy-subrc NE 0.
              DELETE i_ord_head INDEX l_index.
              CLEAR i_ord_head.
              l_flag = c_x.
            ENDIF.
          ENDIF.
        ELSE .
* begin of delete MOD-017
** if service order linked to Quotation check the statu QUAC
* end of delete MOD-017
          SELECT SINGLE objnr stat inact FROM jest
           INTO (i_status-objnr,i_status-stat,i_status-inact)
                       WHERE objnr = i_ord_head-objnr
* begin of change MOD-017
*                      AND stat EQ 'I0396'
                       AND stat EQ g_istat
* end of change MOD-017
                       AND inact NE 'X' .
          IF sy-subrc EQ 0 .
************************************************************************
*   CHECK SYSTEM STATUS FOR THE ORDER                                  *
************************************************************************
            SELECT objnr stat inact FROM jest
            INTO (i_status-objnr,i_status-stat,i_status-inact)
            WHERE objnr = i_ord_head-objnr
            AND stat IN ('I0001','I0002') .

************************************************************************
*     CHECKING THE STATUS TABLE FOR VARIOUS SYSTEM STATUS              *
************************************************************************
              IF sy-subrc EQ 0.
                APPEND i_status.
                CLEAR  i_status.
              ENDIF.
            ENDSELECT.
            IF sy-subrc EQ 0.
              READ TABLE i_status WITH KEY objnr = i_ord_head-objnr.
              IF sy-subrc NE 0.
                DELETE i_ord_head INDEX l_index.
                CLEAR i_ord_head.
                l_flag = c_x.
              ENDIF.
            ENDIF.
          ELSE .
            DELETE i_ord_head INDEX l_index.
            CLEAR i_ord_head.
            l_flag = c_x.
          ENDIF .
        ENDIF .
      ENDIF .
    ENDIF .
*Commented by Ravin on 09/11/04
***********************************************************************
* CHECK SYSTEM STATUS FOR THE ORDER ,ADDITIONALLY CHECK FOR THE STATUS*
* OF ORDER WHICH AREASSIGNED TO QUOTATION OR FOR WHICH QUOTATION IS   *
* THERE IN THE SYSTEM AND SEND ONLY THOSE QUOTATION ORDERS WHICH HAVE *
* STATUS QUAC ACTIVE AND IT IS CREATED OR RELEASED,APART FROM SENDING *
* THE NORMAL ORDERS                                                   *
***********************************************************************
*    SELECT OBJNR STAT INACT FROM JEST
*    INTO (I_STATUS-OBJNR,I_STATUS-STAT,I_STATUS-INACT)
*    WHERE OBJNR = I_ORD_HEAD-OBJNR
*    AND STAT IN ('I0001','I0002','I0396') .
************************************************************************
*
**     CHECKING THE STATUS TABLE FOR VARIOUS SYSTEM STATUS
*
************************************************************************
*
*      IF SY-SUBRC EQ 0.
*        CONCATENATE L_STATUS I_STATUS-STAT I_STATUS-INACT INTO
*L_STATUS.
*        IF I_STATUS-STAT EQ 'I0396' AND I_STATUS-INACT EQ SPACE.
*          SEARCH L_STATUS FOR 'I0001X'.
*          IF SY-SUBRC EQ 0.
*            L_FLAG2 = C_X.
*          ENDIF.
*          SEARCH L_STATUS FOR 'I0002X'.
*          IF SY-SUBRC EQ 0.
*            L_FLAG3 = C_X.
*          ENDIF.
*          IF L_FLAG2 = SPACE OR L_FLAG3 = SPACE.
*            APPEND I_STATUS.
*            CLEAR I_STATUS.
*          ENDIF.
*        ELSEIF I_STATUS-INACT EQ SPACE.
*          APPEND I_STATUS.
*          CLEAR I_STATUS.
*        ENDIF.
*      ENDIF.
*    ENDSELECT.
*    IF SY-SUBRC EQ 0.
*      READ TABLE I_STATUS WITH KEY OBJNR = I_ORD_HEAD-OBJNR.
*      IF SY-SUBRC NE 0.
*        DELETE I_ORD_HEAD INDEX L_INDEX.
*        CLEAR I_ORD_HEAD.
*        L_FLAG = C_X.
*      ENDIF.
*    ENDIF.
  ENDLOOP.
*------------------------------------------------------------*
* END OF CR041                                               *
*------------------------------------------------------------*

************************************************************************
*       SELECT SERVICE ORDER COMPONENT DATA                            *
************************************************************************

*Begin of insert MOD-031
  DELETE i_ord_head[] WHERE flag = 'N'.
*End   of insert MOD-031

  IF NOT i_ord_head[] IS INITIAL.
* begin of insert MOD-022
    SELECT rsnum              " Reservation number
       INTO TABLE gt_afko
       FROM afko
       FOR ALL ENTRIES IN i_ord_head
       WHERE aufnr = i_ord_head-aufnr.

* end of insert MOD-022
    SELECT posnr matnr bdmng bdter aufnr INTO
    (i_ord_comp-posnr,i_ord_comp-matnr,
    i_ord_comp-bdmng,i_ord_comp-bdter,i_ord_comp-aufnr)
* begin of change MOD-022
*   FROM resb FOR ALL ENTRIES IN i_ord_head
*   WHERE aufnr EQ i_ord_head-aufnr
    FROM resb FOR ALL ENTRIES IN gt_afko
    WHERE rsnum = gt_afko-rsnum
* end of change MOD-022
    AND   xloek EQ space .
      IF sy-subrc EQ 0.
        IF i_ord_comp-wempf = ' '.
          APPEND i_ord_comp.
          CLEAR i_ord_comp.
        ENDIF.
      ENDIF.
    ENDSELECT.

************************************************************************
*         COMPARING WITH CUSTOMER TABLE YAM_IO11 FOR THE COMPONENT     *
*         LEVEL DATA.                                                  *
*       1.IF AN ENTRY ALREADY EXISTS WITH THE SAME ORDERNO             *
*         AND ITEM NO,THEN DELETE THAT ENTRY FROM INTERNAL TABLE       *
*       2.IF THE ORDER DONT CONTAIN THE COMPONENT DATA AND STILL THE   *
*         ENTRY EXISTS IN THE CUSTOM TABLE ,THEN AGAIN DELETE THAT     *
*         ENTRY FROM INTERNAL TABLE                                    *
*       3. IF NO ENTRY EXISTS IN THE CUSTOM TABLE THEN GENERATE THE    *
*          IDOC FOR THAT ORDER,IT IS SAME WITH COMPONENT LEVEL INFO    *
*       4. UPDATE THE CUSTOM DATA WITH THE IDOC DATA SO THAT NEXT      *
*          TIME THERE IS A CHECK FOR THE ALREADY SENT DATA             *
************************************************************************

    IF NOT i_ord_head[] IS INITIAL.
      SELECT aufnr posnr INTO (i_yam_io11-aufnr,i_yam_io11-posnr) FROM
      yam_io11 FOR ALL ENTRIES IN i_ord_head
                 WHERE aufnr = i_ord_head-aufnr.
        IF sy-subrc = 0.
          APPEND i_yam_io11.
          CLEAR i_yam_io11.
        ENDIF.
      ENDSELECT.
    ENDIF.

  ENDIF.
************************************************************************
*        SORT  DATA IN INTERNAL TABLE FOR THE ORDER NO AND POSNR       *
************************************************************************

  SORT i_yam_io11 BY aufnr posnr.
  SORT i_ord_comp BY aufnr posnr.

************************************************************************
*         LOOP THE ORDER HEADER AND OPERATION TABLE                    *
*         READ THE CUSTOM TABLE WITH THE ORDER NO AND                  *
*         IF IT MATCHES THE CRITERIA DELETE IT FROM THE                *
*         HEADER AND OPERATION INTERNAL TABLES                         *
************************************************************************

  LOOP AT i_ord_head.
*   begin of insertion MOD-012
    CLEAR g_flag_reopened.
*   end of insertion   MOD-012
* begin of insertion MOD-025
    CLEAR  wa_edidc_control-rcvprn.
    IF NOT i_ord_head-bukrs IS INITIAL.
      g_bukrs = i_ord_head-bukrs.
    ELSE.
      SELECT SINGLE bukrs INTO g_bukrs FROM aufk
        WHERE aufnr = i_ord_head-aufnr.
    ENDIF.
    SELECT SINGLE parnum INTO wa_edidc_control-rcvprn
    FROM yam_sel_partner
         WHERE bukrs  = g_bukrs
           AND msgtyp = p_mestyp.
* end of insertion MOD-025
    IF i_ord_head-flag NE c_x .
      l_index1 = sy-tabix.
      READ TABLE i_yam_io11 WITH KEY aufnr = i_ord_head-aufnr.
      IF i_yam_io11-posnr = c_status.
        IF sy-subrc EQ 0.
*       begin of deletion mod-009
*         IF i_ord_comp[] IS INITIAL.
*       end of deletion mod-009
*       begin of insertion mod-009
          IF i_ord_head-flag NE c_t.
            LOOP AT i_ord_comp TRANSPORTING NO FIELDS
                               WHERE aufnr = i_ord_head-aufnr.
            ENDLOOP.
            IF NOT sy-subrc IS INITIAL.
*       end of insertion mod-009
*             begin of insertion MOD-012
              SELECT SINGLE chgnr FROM jest
                       INTO wa_jest_chgnr
                       WHERE objnr = i_ord_head-objnr
                       AND   stat  = 'I0046'
                       AND  inact  = 'X'.
              IF sy-subrc = 0.
                g_flag_reopened = 'X'.
              ELSE.
*             end of insertion   MOD-012
*  begin of insert MOD-020
*  check on change of 'Scheduled startdate'
                CLEAR g_chgd.
                PERFORM check_changedoc USING i_ord_head-aufnr
                                        CHANGING g_chgd.
                IF g_chgd NE c_x.
*  end of insert MOD-020
                  DELETE i_ord_head INDEX l_index1.
                  CLEAR i_ord_head.
                  l_flag1 = c_x.
*  begin of insert MOD-020
                ENDIF.
*  end of insert MOD-020
*             begin of insertion MOD-012
              ENDIF.
*             end of insertion   MOD-012
*           begin of deletion mod-009
*             EXIT.
*           end of deletion mod-009
            ENDIF.
*         begin of insertion mod-009
          ENDIF.
*         end of insertion mod-009
        ENDIF.
*     begin of deletion mod-009
*     ENDIF.
*     end of deletion mod-009
*     begin of insertion mod-009
      ELSE.
*     end of insertion mod-009
        LOOP AT i_ord_comp WHERE aufnr EQ i_ord_head-aufnr.
          l_index2 = sy-tabix.
          READ TABLE i_yam_io11 WITH KEY aufnr = i_ord_comp-aufnr
                                           posnr = i_ord_comp-posnr.
          IF sy-subrc EQ 0.
            DELETE i_ord_comp INDEX l_index2.
            CLEAR i_ord_comp.
          ENDIF.
        ENDLOOP.
        READ TABLE i_yam_io11 WITH KEY aufnr = i_ord_head-aufnr.
        IF sy-subrc EQ 0.
*     begin of deletion mod-009
*       IF i_ord_comp[] IS INITIAL.
*     end of deletion mod-009
*       begin of insertion mod-009
          IF i_ord_head-flag NE c_t.
            LOOP AT i_ord_comp TRANSPORTING NO FIELDS
                               WHERE aufnr = i_ord_head-aufnr.
            ENDLOOP.
            IF NOT sy-subrc IS INITIAL.
*       end of insertion mod-009
*           begin of insertion MOD-012
              SELECT SINGLE chgnr FROM jest
                       INTO wa_jest_chgnr
                       WHERE objnr = i_ord_head-objnr
                       AND   stat  = 'I0046'
                       AND  inact  = 'X'.
              IF sy-subrc = 0.
                g_flag_reopened = 'X'.
              ELSE.
*           end of insertion
*  begin of insert MOD-020
*  check on change of 'Scheduled startdate'
                CLEAR g_chgd.
                PERFORM check_changedoc USING i_ord_head-aufnr
                                        CHANGING g_chgd.
                IF g_chgd NE c_x.
*  end of insert MOD-020
                  DELETE i_ord_head INDEX l_index1.
                  CLEAR i_ord_head.
                  l_flag1 = c_x.
*  begin of insert MOD-020
                ENDIF.
*  end of insert MOD-020
*           begin of insertion MOD-012
              ENDIF.
*           end of insertion   MOD-012
            ENDIF.
*       begin of insertion mod-009
          ENDIF.
*       end of insertion mod-009
        ENDIF.
*   begin of insertion mod-009
      ENDIF.
*   end of insertion mod-009

************************************************************************
*         PROGRAM LOGIC FOR GENERATING IDOC                            *
************************************************************************
************************************************************************
*         BUILDING HEADER DATA                                         *
************************************************************************
      CHECK  i_ord_head-aufnr NE  ' '.
      CLEAR wa_yam_io11_e1ordhdr.
* begin of insert MOD-021
      SELECT SINGLE bemot
                    zzsdc zzcon zzapc zzpsf zztrc
* begin of insertion MOD-025
                    bukrs
* end of insertion MOD-025
         INTO (i_ord_head-bemot, i_ord_head-zzsdc, i_ord_head-zzcon,
* begin of change MOD-025
*               i_ord_head-zzapc, i_ord_head-zzpsf, i_ord_head-zztrc)
                i_ord_head-zzapc, i_ord_head-zzpsf,
                i_ord_head-zztrc, i_ord_head-bukrs)
* end of change MOD-025
         FROM aufk
         WHERE aufnr = i_ord_head-aufnr.
* end of insert MOD-021
* begin of insert MOD-027
      SELECT SINGLE gstrs INTO i_ord_head-gstrs
           FROM afko WHERE aufnr = i_ord_head-aufnr.
* end of insert MOD-027
      REFRESH i_edidd_data.
      wa_yam_io11_e1ordhdr-aufnr  =  i_ord_head-aufnr.
* begin of change MOD-020
*     wa_yam_io11_e1ordhdr-gstrp  =  i_ord_head-gstrp.
      wa_yam_io11_e1ordhdr-gstrs  =  i_ord_head-gstrs.
* end of change MOD-020
      wa_yam_io11_e1ordhdr-priok  =  i_ord_head-priok.
      wa_yam_io11_e1ordhdr-ilart  =   i_ord_head-ilart.
*------------------------------------------------------------*
* BEGIN OF CR041                                             *
*------------------------------------------------------------*
      wa_yam_io11_e1ordhdr-equi_name1      = i_ord_head-equi_name1.
      wa_yam_io11_e1ordhdr-equi_street     = i_ord_head-equi_street.
      wa_yam_io11_e1ordhdr-equi_city1      = i_ord_head-equi_city1.
      wa_yam_io11_e1ordhdr-equi_country    = i_ord_head-equi_country.
      wa_yam_io11_e1ordhdr-equi_post_code1 = i_ord_head-equi_post_code1.
      wa_yam_io11_e1ordhdr-equi_region     = i_ord_head-equi_region.
      wa_yam_io11_e1ordhdr-equi_matnr      = i_ord_head-equi_matnr.
      wa_yam_io11_e1ordhdr-equi_sernr      = i_ord_head-equi_sernr.
*------------------------------------------------------------*
* END  OF CR041                                              *
*------------------------------------------------------------*
*  Start of MOD-008
      wa_yam_io11_e1ordhdr-zzsdc      = i_ord_head-zzsdc.
      wa_yam_io11_e1ordhdr-zzcon      = i_ord_head-zzcon.
* End of MOD-008
* Start of MOD-009
      wa_yam_io11_e1ordhdr-ingpr      = i_ord_head-ingpr.
* Begin of insert MOD-028

      SELECT SINGLE ernam FROM yam_planner_map
      INTO wa_yam_io11_e1ordhdr-ernam
      WHERE iwerk = i_ord_head-iwerk AND ingpr = i_ord_head-ingpr.
      IF sy-subrc NE 0.
* End of insert MOD-028
        wa_yam_io11_e1ordhdr-ernam      = i_ord_head-ernam.
* Begin of insert MOD-028
      ENDIF.
* End of insert MOD-028
* End of MOD-009
* Begin of insert MOD-032
* contract type = ZSM7?
      CLEAR: lv_convert, lv_auart,  lv_bemot, lv_matkl, lv_servp.

      IF NOT i_ord_head-kdauf IS INITIAL.
        SELECT SINGLE auart FROM vbak INTO lv_auart
        WHERE vbeln = i_ord_head-kdauf.
        IF lv_auart = 'ZSM7'.
          lv_convert = 'Y'.
        ENDIF.
      ENDIF.
* Order Type is ZSM2 + OH/AN/ER
      SELECT SINGLE auart
        FROM aufk INTO lv_auart
        WHERE aufnr = i_ord_head-aufnr AND bemot = 'FP'.
      IF sy-subrc = 0 AND lv_auart = 'ZSM2'.
        lv_convert = 'Y'.
      ENDIF.

      IF lv_convert = 'Y'.
* Retrieve material group of service product
        SELECT SINGLE matnr INTO lv_servp
          FROM pmsdo
          WHERE objnr = i_ord_head-objnr.

        SELECT SINGLE matkl
          FROM mara INTO lv_matkl
          WHERE matnr = lv_servp.

        SELECT SINGLE bemot INTO lv_bemot
        FROM yam_accind_conv
        WHERE matkl = lv_matkl.

        IF sy-subrc = 0.
          wa_yam_io11_e1ordhdr-bemot  = lv_bemot.
        ELSE.
          wa_yam_io11_e1ordhdr-bemot  = i_ord_head-bemot.
        ENDIF.
      ELSE.
* End of insert MOD-032
* Start of MOD-011
        wa_yam_io11_e1ordhdr-bemot      = i_ord_head-bemot.
* End of MOD-011
* begin of insert MOD-032
      ENDIF.
* end of insert MOD-032
* begin of insert MOD-013
      wa_yam_io11_e1ordhdr-bstkd      = i_ord_head-bstkd.
* end of insert MOD-013
* start of MOD-019
      wa_yam_io11_e1ordhdr-zzapc      = i_ord_head-zzapc.
      wa_yam_io11_e1ordhdr-zzpsf      = i_ord_head-zzpsf.
      wa_yam_io11_e1ordhdr-zztrc      = i_ord_head-zztrc.
* End of MOD-019

* begin of insert MOD-023
      REFRESH i_ihpa.
      SELECT m~objnr m~parnr m~parvw  n~sortl n~name1 n~stras n~ort01
             m~adrnr n~adrnr
        n~pstlz n~land1 INTO (i_ihpa-objnr,i_ihpa-parnr,i_ihpa-parvw,
        i_ihpa-sortl,i_ihpa-name1,i_ihpa-street,i_ihpa-city1,
        i_ihpa-adrnr,
        i_ihpa-adrnr_kna1,
        i_ihpa-post_code1,i_ihpa-country) FROM ihpa
        AS m JOIN kna1 AS n
        ON m~parnr = n~kunnr
        WHERE m~objnr    =  i_ord_head-objnr
          AND m~kzloesch <> 'X'.
        APPEND i_ihpa.
        CLEAR  i_ihpa.
      ENDSELECT.
* end of insert MOD-023

      LOOP AT i_ihpa WHERE objnr = i_ord_head-objnr .
        IF i_ihpa-parvw EQ 'AG'.
          wa_yam_io11_e1ordhdr-sortl = i_ihpa-sortl.
        ELSEIF i_ihpa-parvw EQ 'WE'.

* begin of insert MOD-029 - Satya
* Check if the IHPA-ADRNR is valid entry in ADRC
* If not valid, empty the IHPA-ADRNR
          IF i_ihpa-adrnr NE space.
            CLEAR ls_adrc.

            SELECT SINGLE * FROM adrc INTO ls_adrc
                              WHERE addrnumber = i_ihpa-adrnr.
            IF sy-subrc NE 0.
              i_ihpa-adrnr = space.
* update table
              UPDATE ihpa
              SET    adrnr = space
              WHERE  objnr = i_ihpa-objnr
              AND   parvw = i_ihpa-parvw.
            ENDIF.
          ENDIF.
* end of insert MOD-029 - Satya

* begin of insert MOD-015
          IF i_ihpa-adrnr IS INITIAL.
* end of insert MOD-015
            wa_yam_io11_e1ordhdr-name1        = i_ihpa-name1.
            wa_yam_io11_e1ordhdr-street       = i_ihpa-street.
            wa_yam_io11_e1ordhdr-city1        = i_ihpa-city1.
            wa_yam_io11_e1ordhdr-post_code1   = i_ihpa-post_code1.
            wa_yam_io11_e1ordhdr-country      = i_ihpa-country.
* begin of insert MOD-013
** begin of change MOD-016
*         select name_co into wa_yam_io11_e1ordhdr-name_co
            SELECT name_co str_suppl1
* begin of insert MOD-018
                    name2
* end of insert MOD-018
                  INTO (wa_yam_io11_e1ordhdr-name_co,
* begin of change MOD-018
*                     wa_yam_io11_e1ordhdr-str_suppl1)
                        wa_yam_io11_e1ordhdr-str_suppl1,
                        wa_yam_io11_e1ordhdr-name2)
* end of change MOD-018
** end of change MOD-016
* begin of change MOD-015
*             from ADRC where addrnumber = i_ihpa-adrnr.
                FROM adrc WHERE addrnumber = i_ihpa-adrnr_kna1.
* end of change MOD-015
            ENDSELECT.
            IF sy-subrc = 0.
              SELECT remark INTO wa_yam_io11_e1ordhdr-remark
* begin of change MOD-015
*               from ADRCT where addrnumber = i_ihpa-adrnr
                  FROM adrct WHERE addrnumber = i_ihpa-adrnr_kna1
* end of change MOD-015
                               AND langu      = c_e.
              ENDSELECT.
            ENDIF.
* end of insert MOD-013
* begin of insert MOD-015
          ELSE.
            SELECT name_co name1 street city1 post_code1 country
* begin of insert MOD-016
* begin of insert MOD-018
                   name2
* end of insert MOD-018
                   str_suppl1
* end of insert MOD-016
                INTO (wa_yam_io11_e1ordhdr-name_co,
                      wa_yam_io11_e1ordhdr-name1,
                      wa_yam_io11_e1ordhdr-street,
                      wa_yam_io11_e1ordhdr-city1,
                      wa_yam_io11_e1ordhdr-post_code1,
* begin of change MOD-016
*                   wa_yam_io11_e1ordhdr-country)
                      wa_yam_io11_e1ordhdr-country,
* begin of insert MOD-018
                      wa_yam_io11_e1ordhdr-name2,
* end of insert MOD-018
                      wa_yam_io11_e1ordhdr-str_suppl1)
* end of change MOD-016
                FROM adrc WHERE addrnumber = i_ihpa-adrnr.
            ENDSELECT.
            IF sy-subrc = 0.
              SELECT remark INTO wa_yam_io11_e1ordhdr-remark
                  FROM adrct WHERE addrnumber = i_ihpa-adrnr
                               AND langu      = c_e.
              ENDSELECT.
            ENDIF.
          ENDIF.
* end of insert MOD-015
        ENDIF.
      ENDLOOP.
* begin of insert MOD-024
      CLEAR : g_iloan,
              g_tplnr,
              g_pltxt.
      IF wa_yam_io11_e1ordhdr-remark = ' '.
        SELECT SINGLE iloan INTO g_iloan FROM afih
          WHERE aufnr = i_ord_head-aufnr.
        IF sy-subrc IS INITIAL.
          SELECT SINGLE tplnr INTO g_tplnr FROM iloa
           WHERE iloan = g_iloan.
          IF sy-subrc IS INITIAL.
            g_tplnr = g_tplnr+0(13).
            SELECT SINGLE pltxt INTO g_pltxt FROM iflotx
              WHERE tplnr = g_tplnr.
            IF sy-subrc IS INITIAL.
              IF g_pltxt(6) CO '1234567890'.
                wa_yam_io11_e1ordhdr-remark = g_pltxt+7(33).
              ELSE.
                wa_yam_io11_e1ordhdr-remark = g_pltxt.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
      CLEAR sy-subrc.
* end of insert MOD-024
      i_edidd_data-segnam = c_ord_header.
      i_edidd_data-sdata = wa_yam_io11_e1ordhdr.
      APPEND i_edidd_data.
************************************************************************
*         BUILDING COMPONENT DATA                                      *
************************************************************************
** Inserted by Ravin on 031204 for CR058
      IF i_ord_head-flag NE c_t .
*      begin of insertion MOD-012
        IF g_flag_reopened <> 'X'.
*      end of insertion   MOD-012
          LOOP AT i_ord_comp WHERE aufnr = i_ord_head-aufnr .
            IF sy-subrc EQ 0.
              wa_yam_io11_e1oropr_mat-posnr       = i_ord_comp-posnr.
              wa_yam_io11_e1oropr_mat-matnr       = i_ord_comp-matnr.
              wa_yam_io11_e1oropr_mat-bdmng       = i_ord_comp-bdmng.
              wa_yam_io11_e1oropr_mat-bdter       = i_ord_comp-bdter.
              i_edidd_data-segnam                 = c_ord_detail.
              i_edidd_data-sdata                  = wa_yam_io11_e1oropr_mat.
              APPEND i_edidd_data.
            ENDIF.
          ENDLOOP.
*      begin of insertion MOD-012
        ENDIF.
*      end of insertion   MOD-012
      ENDIF .
************************************************************************
*        PASSING THE CONTROL TO IDOC GENERATION FUNCTION MODULE        *
************************************************************************
    ELSE .
** Select object number from AUFK
      CLEAR: wa_aufk_objnr, wa_jest_chgnr, wa_ord_cls_date,wa_sortl.
* begin of insert MOD-027
      SELECT SINGLE gstrs INTO i_ord_head-gstrs
           FROM afko WHERE aufnr = i_ord_head-aufnr.
* end of insert MOD-027
* begin of change MOD-021
*     SELECT SINGLE objnr INTO wa_aufk_objnr  FROM aufk
*                              WHERE aufnr EQ i_ord_head-aufnr .
      SELECT SINGLE objnr bemot
                    zzsdc zzcon zzapc zzpsf zztrc
* begin of insertion MOD-025
                    bukrs
* end of insertion MOD-025
         INTO (wa_aufk_objnr, i_ord_head-bemot,
               i_ord_head-zzsdc, i_ord_head-zzcon,
* begin of change MOD-025
*               i_ord_head-zzapc, i_ord_head-zzpsf, i_ord_head-zztrc)
                i_ord_head-zzapc, i_ord_head-zzpsf,
                i_ord_head-zztrc, i_ord_head-bukrs)
* end of change MOD-025
         FROM aufk
         WHERE aufnr = i_ord_head-aufnr.
* end of change MOD-021
      IF sy-subrc = 0 .

* begin of insert MOD-023
        REFRESH i_ihpa.
        SELECT m~objnr m~parnr m~parvw  n~sortl n~name1 n~stras n~ort01
               m~adrnr n~adrnr
          n~pstlz n~land1 INTO (i_ihpa-objnr,i_ihpa-parnr,i_ihpa-parvw,
          i_ihpa-sortl,i_ihpa-name1,i_ihpa-street,i_ihpa-city1,
          i_ihpa-adrnr,
          i_ihpa-adrnr_kna1,
          i_ihpa-post_code1,i_ihpa-country) FROM ihpa
          AS m JOIN kna1 AS n
          ON m~parnr = n~kunnr
          WHERE m~objnr    =  wa_aufk_objnr
            AND m~kzloesch <> 'X'.
          APPEND i_ihpa.
          CLEAR  i_ihpa.
        ENDSELECT.
* end of insert MOD-023

        SELECT SINGLE chgnr INTO wa_jest_chgnr FROM jest
                              WHERE objnr EQ wa_aufk_objnr
                              AND   stat  EQ 'I0046'
                              AND inact NE 'X' .
************************************************************************
* added by amit date 15.12.2004
*added the BPCS customer no with Fam code which is stored in field
**sortl
************************************************************************
        IF sy-subrc EQ 0.
          READ TABLE i_ihpa WITH KEY objnr = wa_aufk_objnr.
          wa_sortl = i_ihpa-sortl.
        ENDIF.

        IF sy-subrc = 0 .
          SELECT SINGLE udate INTO wa_ord_cls_date FROM jcds
                                WHERE objnr EQ wa_aufk_objnr
                                AND stat EQ 'I0046'
                                AND chgnr EQ wa_jest_chgnr
                                AND inact NE 'X' .

        ENDIF .
      ENDIF .
      CLEAR wa_yam_io11_e1ordhdr.
      REFRESH i_edidd_data.
      wa_yam_io11_e1ordhdr-aufnr        =  i_ord_head-aufnr.
      wa_yam_io11_e1ordhdr-ord_cls_date =  wa_ord_cls_date .
************************************************************************
*added by amit for sortl field 15.12.2004
      wa_yam_io11_e1ordhdr-sortl       =  wa_sortl.
************************************************************************

* begin of change MOD-010
* begin of change MOD-020
*     wa_yam_io11_e1ordhdr-gstrp  =  i_ord_head-gstrp.
      wa_yam_io11_e1ordhdr-gstrs  =  i_ord_head-gstrs.
* end of change MOD-020
      wa_yam_io11_e1ordhdr-priok  =  i_ord_head-priok.
      wa_yam_io11_e1ordhdr-ilart  =  i_ord_head-ilart.
      wa_yam_io11_e1ordhdr-equi_name1      = i_ord_head-equi_name1.
      wa_yam_io11_e1ordhdr-equi_street     = i_ord_head-equi_street.
      wa_yam_io11_e1ordhdr-equi_city1      = i_ord_head-equi_city1.
      wa_yam_io11_e1ordhdr-equi_country    = i_ord_head-equi_country.
      wa_yam_io11_e1ordhdr-equi_post_code1 = i_ord_head-equi_post_code1.
      wa_yam_io11_e1ordhdr-equi_region     = i_ord_head-equi_region.
      wa_yam_io11_e1ordhdr-equi_matnr      = i_ord_head-equi_matnr.
      wa_yam_io11_e1ordhdr-equi_sernr      = i_ord_head-equi_sernr.
      wa_yam_io11_e1ordhdr-zzsdc  = i_ord_head-zzsdc.
      wa_yam_io11_e1ordhdr-zzcon  = i_ord_head-zzcon.
      wa_yam_io11_e1ordhdr-ingpr  = i_ord_head-ingpr.
* Begin of insert MOD-028
      SELECT SINGLE ernam FROM yam_planner_map
      INTO wa_yam_io11_e1ordhdr-ernam
      WHERE iwerk = i_ord_head-iwerk AND ingpr = i_ord_head-ingpr.
      IF sy-subrc NE 0.
* End of insert MOD-028
        wa_yam_io11_e1ordhdr-ernam      = i_ord_head-ernam.
* Begin of insert MOD-028
      ENDIF.
* End of insert MOD-028

* Begin of insert MOD-032
* contract type = ZSM7?
      CLEAR: lv_convert, lv_auart, lv_bemot, lv_matkl, lv_servp.

      IF NOT i_ord_head-kdauf IS INITIAL.
        SELECT SINGLE auart FROM vbak INTO lv_auart
        WHERE vbeln = i_ord_head-kdauf.
        IF lv_auart = 'ZSM7'.
          lv_convert = 'Y'.
        ENDIF.
      ENDIF.
* Order Type is ZSM2 + OH/AN/ER
      SELECT SINGLE auart
        FROM aufk INTO lv_auart
        WHERE aufnr = i_ord_head-aufnr AND bemot = 'FP'.
      IF sy-subrc = 0 AND lv_auart = 'ZSM2'.
        lv_convert = 'Y'.
      ENDIF.

      IF lv_convert = 'Y'.
* Retrieve material group of service product
        SELECT SINGLE matnr INTO lv_servp
          FROM pmsdo
          WHERE objnr = i_ord_head-objnr.

        SELECT SINGLE matkl
          FROM mara INTO lv_matkl
          WHERE matnr = lv_servp.

        SELECT SINGLE bemot INTO lv_bemot
        FROM yam_accind_conv
        WHERE matkl = lv_matkl.

        IF sy-subrc = 0.
          wa_yam_io11_e1ordhdr-bemot  = lv_bemot.
        ELSE.
          wa_yam_io11_e1ordhdr-bemot  = i_ord_head-bemot.
        ENDIF.
      ELSE.
* End of insert MOD-032
* Start of MOD-011
        wa_yam_io11_e1ordhdr-bemot  = i_ord_head-bemot.
* End of MOD-011
* Begin of insert MOD-032
      ENDIF.
* End of insert MOD-032
* begin of insert MOD-013
      wa_yam_io11_e1ordhdr-bstkd  = i_ord_head-bstkd.
* end of insert MOD-013

* begin of insert MOD-019
      wa_yam_io11_e1ordhdr-zzapc  = i_ord_head-zzapc.
      wa_yam_io11_e1ordhdr-zzpsf  = i_ord_head-zzpsf.
      wa_yam_io11_e1ordhdr-zztrc  = i_ord_head-zztrc.
* end of insert MOD-019

      LOOP AT i_ihpa WHERE objnr = wa_aufk_objnr.
* begin of change MOD-014
*       IF i_ihpa-parvw EQ 'WE'.
        IF i_ihpa-parvw EQ 'AG'.
          wa_yam_io11_e1ordhdr-sortl = i_ihpa-sortl.
        ELSEIF i_ihpa-parvw EQ 'WE'.
* end of change MOD-014

* begin of insert MOD-029 - Satya
* Check if the IHPA-ADRNR is valid entry in ADRC
* If not valid, empty the IHPA-ADRNR
          IF i_ihpa-adrnr NE space.
            CLEAR ls_adrc.

            SELECT SINGLE * FROM adrc INTO ls_adrc
                              WHERE addrnumber = i_ihpa-adrnr.
            IF sy-subrc NE 0.
              i_ihpa-adrnr = space.
* update table
              UPDATE ihpa
              SET    adrnr = space
              WHERE  objnr = i_ihpa-objnr
              AND   parvw = i_ihpa-parvw.
            ENDIF.
          ENDIF.
* end of insert MOD-029 - Satya

* begin of insert MOD-015
          IF i_ihpa-adrnr IS INITIAL.
* end of insert MOD-015
            wa_yam_io11_e1ordhdr-name1        = i_ihpa-name1.
            wa_yam_io11_e1ordhdr-street       = i_ihpa-street.
            wa_yam_io11_e1ordhdr-city1        = i_ihpa-city1.
            wa_yam_io11_e1ordhdr-post_code1   = i_ihpa-post_code1.
            wa_yam_io11_e1ordhdr-country      = i_ihpa-country.
* begin of insert MOD-013
** begin of change MOD-016
**        select name_co into wa_yam_io11_e1ordhdr-name_co
            SELECT name_co str_suppl1
* begin of insert MOD-018
                   name2
* end of insert MOD-018
              INTO (wa_yam_io11_e1ordhdr-name_co,
* begin of change MOD-018
*                 wa_yam_io11_e1ordhdr-str_suppl1)
                    wa_yam_io11_e1ordhdr-str_suppl1,
                    wa_yam_io11_e1ordhdr-name2)
* end of change MOD-018
** end of change MOD-016
* begin of change MOD-015
*             from ADRC where addrnumber = i_ihpa-adrnr.
                FROM adrc WHERE addrnumber = i_ihpa-adrnr_kna1.
* end of change MOD-015
            ENDSELECT.
            IF sy-subrc = 0.
              SELECT remark INTO wa_yam_io11_e1ordhdr-remark
* begin of change MOD-015
*               from ADRCT where addrnumber = i_ihpa-adrnr
                  FROM adrct WHERE addrnumber = i_ihpa-adrnr_kna1
* end of change MOD-015
                               AND langu      = c_e.
              ENDSELECT.
            ENDIF.
* end of insert MOD-013
* begin of insert MOD-015
          ELSE.
            SELECT name_co name1 street city1 post_code1 country
* begin of insert MOD-016
* begin of insert MOD-018
                   name2
* end of insert MOD-018
                   str_suppl1
* end of insert MOD-016
                INTO (wa_yam_io11_e1ordhdr-name_co,
                      wa_yam_io11_e1ordhdr-name1,
                      wa_yam_io11_e1ordhdr-street,
                      wa_yam_io11_e1ordhdr-city1,
                      wa_yam_io11_e1ordhdr-post_code1,
* begin of change MOD-016
*                   wa_yam_io11_e1ordhdr-country)
                      wa_yam_io11_e1ordhdr-country,
* begin of insert MOD-018
                      wa_yam_io11_e1ordhdr-name2,
* end of insert MOD-018
                      wa_yam_io11_e1ordhdr-str_suppl1)
* end of change MOD-016
* end of insert MOD-015
                FROM adrc WHERE addrnumber = i_ihpa-adrnr.
            ENDSELECT.
            IF sy-subrc = 0.
              SELECT remark INTO wa_yam_io11_e1ordhdr-remark
                  FROM adrct WHERE addrnumber = i_ihpa-adrnr
                               AND langu      = c_e.
              ENDSELECT.
            ENDIF.
          ENDIF.
* end of insert MOD-015
        ENDIF.
      ENDLOOP.
* end of change MOD-010
* begin of insert MOD-024
      CLEAR : g_iloan,
              g_tplnr,
              g_pltxt.
      IF wa_yam_io11_e1ordhdr-remark = ' '.
        IF i_ord_head-iwerk = c_plant.
          wa_yam_io11_e1ordhdr-remark = c_remark.
        ELSE.
          SELECT SINGLE iloan INTO g_iloan FROM afih
            WHERE aufnr = i_ord_head-aufnr.
          IF sy-subrc IS INITIAL.
            SELECT SINGLE tplnr INTO g_tplnr FROM iloa
             WHERE iloan = g_iloan.
            IF sy-subrc IS INITIAL.
              g_tplnr = g_tplnr+0(13).
              SELECT SINGLE pltxt INTO g_pltxt FROM iflotx
                WHERE tplnr = g_tplnr.
              IF sy-subrc IS INITIAL.
                IF g_pltxt(6) CO '1234567890'.
                  wa_yam_io11_e1ordhdr-remark = g_pltxt+7(33).
                ELSE.
                  wa_yam_io11_e1ordhdr-remark = g_pltxt.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
* Begin of insert MOD-030
        ENDIF.
* End of insert MOD-030
      ENDIF.
      CLEAR sy-subrc.
* end of insert MOD-024

      i_edidd_data-segnam = c_ord_header.
      i_edidd_data-sdata = wa_yam_io11_e1ordhdr.
      APPEND i_edidd_data.
    ENDIF .

* begin of insertion MOD-005
    REFRESH i_edidc_control_comm.
* end of insertion MOD-005

    CALL FUNCTION 'MASTER_IDOC_DISTRIBUTE'
      EXPORTING
        master_idoc_control            = wa_edidc_control
      TABLES
        communication_idoc_control     = i_edidc_control_comm
        master_idoc_data               = i_edidd_data
      EXCEPTIONS
        error_in_idoc_control          = 1
        error_writing_idoc_status      = 2
        error_in_idoc_data             = 3
        sending_logical_system_unknown = 4
        OTHERS                         = 5.
    IF sy-subrc NE 0.
      MESSAGE e025.
    ELSE.
************************************************************************
*         UPDATE THE CUSTOM DATA WITH THE IDOC DATA SO THAT NEXT       *
*         TIME THERE IS A CHECK FOR THE ALREADY SENT DATA              *
************************************************************************
* begin of deletion mod-009
*     LOOP AT i_ord_comp.
* end of deletion mod-009
* begin of insertion mod-009
      IF NOT ( i_ord_head-flag = c_x OR i_ord_head-flag = c_t ).
        LOOP AT i_ord_comp WHERE aufnr = i_ord_head-aufnr.
* end of insertion mod-009
          wa_yam_io11-aufnr = i_ord_comp-aufnr.
          wa_yam_io11-posnr = i_ord_comp-posnr.
          INSERT into yam_io11 values wa_yam_io11.
        ENDLOOP.
        IF sy-subrc NE 0.
          wa_yam_io11-aufnr = i_ord_head-aufnr.
          wa_yam_io11-posnr = c_status.
          INSERT into yam_io11 values wa_yam_io11.
        ENDIF.
* begin of insertion mod-009
      ENDIF.
* end of insertion mod-009
      CLEAR  wa_yam_io11.
* begin of deletion mod-005
*     WRITE:/30 TEXT-T02.
*     SKIP 3.
* end of deletion mod-005

* begin of insertion mod-005
      CLEAR g_stat.
      IF i_ord_head-flag = c_x.
        g_stat = text-002.                 "Closed
      ELSEIF i_ord_head-flag = c_t.
        g_stat = text-003.                 "TECO
      ENDIF.
      WRITE: / i_ord_head-aufnr, g_stat.
* end of insertion mod-005

      LOOP AT i_edidc_control_comm.
* begin of deletion mod-005
*       WRITE:/ TEXT-T03 , I_EDIDC_CONTROL_COMM-DOCNUM.
* end of deletion mod-005
* begin of insertion mod-005
        WRITE: 25 text-t03 , i_edidc_control_comm-docnum.
* end of insertion mod-005
      ENDLOOP.
    ENDIF.
  ENDLOOP.
  WRITE: / lv_datum, sy-datum, lv_time, sy-uzeit.
  WRITE: / s_erdat-low, s_erdat-high, s_erzeit-low, s_erzeit-high.

* begin of deletion MOD-005
* IF L_FLAG EQ C_X.
*   WRITE :/ TEXT-T01.
*   CLEAR L_FLAG.
* ENDIF.
* IF L_FLAG1 = C_X.
*   WRITE:/30 TEXT-T04.
*   SKIP 3.
*   WRITE:/5 TEXT-T00.
* ENDIF.
* end of deletion MOD-005

* begin of insertion mod-005
TOP-OF-PAGE.
*-----------*
  WRITE:/30 text-t02.
  SKIP 3.
* end of insertion mod-005

***********************************************************************
*&---------------------------------------------------------------------*
*&      Form  check_changedoc                         MOD-020
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_AUFNR   ordernumber
*      <--P_G_CHGD  flag changed
*----------------------------------------------------------------------*
FORM check_changedoc USING    p_aufnr
                     CHANGING p_g_chgd.

  DATA: g_changenr     TYPE cdchangenr,
* begin of change MOD-022
*       g_value_new    type CDFLDVALN,
        g_value_old    TYPE cdfldvalo,
* end of change MOD-022
        g_objectid(17) TYPE c.

  CONSTANTS: c_30(2)    TYPE c VALUE '30',        "Order category
             c_order(5) TYPE c VALUE 'ORDER'.

  CLEAR g_changenr.

  CONCATENATE sy-mandt c_30 p_aufnr INTO g_objectid.

  SELECT changenr INTO g_changenr
     FROM cdhdr
     WHERE objectclas = c_order
       AND objectid   = g_objectid
       AND udate      IN s_erdat
       AND change_ind = 'U'.

* begin of change MOD-022
*   select single value_new into g_value_new
    SELECT SINGLE value_old INTO g_value_old
* end of change MOD-022
       FROM cdpos
       WHERE objectclas = c_order
         AND objectid   = g_objectid
         AND changenr   = g_changenr
         AND tabname    = 'AFVV'
         AND fname      IN ('EPEND', 'EPANF')
         AND chngind    = 'U'.

* begin of change MOD-022
*   if sy-subrc = 0.
* begin of change MOD-027
*   if sy-subrc = 0 and
*      g_value_old(8) <> '00000000'.
    IF sy-subrc = 0.
* end of change MOD-027
* end of change MOD-022
      p_g_chgd = c_x.
      EXIT.
    ENDIF.

  ENDSELECT.

ENDFORM.                    " check_changedoc

*
*Text symbol text
*001:SERVICE ORDER IDOC SCREEN
*002:Closed
*003:TECO
*T00:ORDER HAVE BEEN ALREADY SENT PLZ CHECK
*T01:ORDER NO IS EITHER CLOSED/TECHNICALLY COMPLETED/or Status QUCR
*T02:GENERATION REPORT FOR IDOC
*T03:IDOC GENERATED

*T04:GENERATION REPORT FOR IDOC
*Selection text
*P_MESTYP:D       .
*P_ORETD:        Overrule End Time Determin.
*S_AUART:D       .
*S_AUFNR:D       .
*S_ERDAT:        Created/Changed on
*S_ERZEIT:        Time created
*S_WERKS:D       .
