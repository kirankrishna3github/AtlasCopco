*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_DOWNLOAD_TASKLISTS                        *
* PROGRAM TITLE        : Download General Tasklists                    *
* AUTHOR               : Luc Mertens   USG Innotiv                     *
* DATE                 : 08/06/2012                                    *
* DEVELOPMENT ID       :                                               *
*                                                                      *
* CHANGE REQUEST NUMBER: CD1K972150                                    *
*                                                                      *
* Program Description:  Download of general tasklists for cutover      *
*                       Act! program                                   *
************************************************************************
* MOD-001 - 05/08/2015 - ACTEXTSF
* Reason: - adding additional checks for oil
*         - adding column PSTXT to file MP_Schedule
************************************************************************
* MOD-002 - 20/08/2015 - ACTEXTSF
* Reason: - adding column EQUNR/KDAUF/KDPOS to file MP_Schedule
*         - remove check DLFL/INAC for MP_Header
*         - add Future Visit plan to MP_Header
* MOD-003 - 26/10/2015 - ACTGR
* Reason: - adding structure maitenance plan item
*         - bug ratio
* MOD-004 - 23/12/2015 - ACTGR
* Reason: - add field BISMT (components) and BISMT_EQUI (equipment)
* MOD-005 - 22/02/2016 - ACTEXTSF
* Reason: - ARBEI should just take the data from the tasklist when
*           PLNTY = 'E'
* MOD-006 - 03/04/2017 - ACTGR
* Reason: - Only active contracts
* MOD-007 - 06/06/2017 - ACTEXTAJSI - PBCS-1268
* Change of data types for two local variables.
************************************************************************
REPORT yam_download_tasklists MESSAGE-ID yam_inf.

************************************************************************
*                   T A B L E S                                        *
************************************************************************
TABLES: vbak,
        mpla,
        mpos.

************************************************************************
*                   T Y P E - P O O L S                                *
************************************************************************
TYPE-POOLS: ibco2.

************************************************************************
*                   C O N S T A N T S                                  *
************************************************************************
CONSTANTS: c_i0076         LIKE jest-stat  VALUE 'I0076', "stat deleted
           c_i0320         LIKE jest-stat  VALUE 'I0320', "stat inact
           c_rec_t(13)     TYPE c          VALUE 'MP_taskl_oper',
           c_rec_c(10)     TYPE c          VALUE 'Components',
           c_rec_s(06)     TYPE c          VALUE 'Skills',
           c_rec_mh(09)    TYPE c          VALUE 'MP_Header',
* Begin of insert Mod-003
           c_rec_it(07)    TYPE c          VALUE 'MP_item',
* End of insert Mod-003
           c_rec_ms(11)    TYPE c          VALUE 'MP_Schedule',
           c_rec_th(12)    TYPE c          VALUE 'Taskl_Header',
           gc_zam010       TYPE lstar      VALUE 'ZAM010',
           gc_zam019       TYPE lstar      VALUE 'ZAM019',
           gc_zam026       TYPE lstar      VALUE 'ZAM026',
           gc_zam025       TYPE lstar      VALUE 'ZAM025',
           gc_tl9080       TYPE ktsch      VALUE 'TL9080',
           gc_tl9081       TYPE ktsch      VALUE 'TL9081',  "MOD-001+
           gc_tl9082       TYPE ktsch      VALUE 'TL9082',  "MOD-001+
           gc_zco3         TYPE steus      VALUE 'ZCO3',
           gc_z_vc_table   TYPE vtnam      VALUE 'Z_VC_TABLE',
           gc_country(20)  TYPE c          VALUE 'CH_EQUIPMENT_COUNTRY',
           gc_km(08)       TYPE c          VALUE 'CH_TL_KM',
           gc_exlab(17)    TYPE c          VALUE 'CH_TL_EXTRALABOUR',
           gc_subcontr(19) TYPE c          VALUE 'CH_TL_SUBCONTRACTOR',
           gc_allow(15)    TYPE c          VALUE 'CH_TL_ALLOWANCE',
           gc_visitour(14) TYPE c          VALUE 'CH_TL_VISITOUR',
           gc_oil(9)       TYPE c          VALUE 'CH_TL_OIL',
           gc_cooltype(14) TYPE c          VALUE 'CH_TL_COOLTYPE',  "MOD-001+
           gc_levels(10)   TYPE c          VALUE 'ZAM_LEVELS',
           gc_skills(13)   TYPE c          VALUE 'ZAM_SKILL_SET',
           gc_gmix         TYPE werks_d    VALUE 'GMIX',
           c_char(13)      TYPE c          VALUE 'ZAM_RHRSTOTAL',
* Begin of insert MOD-006
           c_000000(6)       TYPE c     VALUE '000000'.
* End of insert MOD-006

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************
DATA: BEGIN OF gt_mplan OCCURS 0,
        warpl     LIKE mpla-warpl,
        wapos     LIKE mpos-wapos,
        equnr     LIKE mpos-equnr,
        pstxt     LIKE mpos-pstxt,
        plnty     LIKE mpos-plnty,
        plnnr     LIKE mpos-plnnr,
        plnal     LIKE mpos-plnal,
        gewrk     LIKE mpos-gewrk,
        iwerk     LIKE mpos-iwerk,
        kdauf     LIKE mpos-kdauf,
        kdpos     LIKE mpos-kdpos,
        strat     LIKE mpla-strat,
        wpgrp     LIKE mpos-wpgrp,
        qmart     LIKE mpos-qmart,
        priok     LIKE mpos-priok,
        task_determine LIKE mpos-task_determine,
        stat      LIKE jest-stat, "MOD-002+
* Begin of insert MOD-003
        matnr     LIKE equi-matnr,
        sernr     LIKE equi-sernr,
        bismt_equi LIKE mara-bismt,
* End of insert MOD-003
      END OF gt_mplan.

DATA: BEGIN OF gt_mplan2 OCCURS 0,
        warpl     LIKE mpla-warpl,
        wapos     LIKE mpos-wapos,
        equnr     LIKE mpos-equnr,
        pstxt     LIKE mpos-pstxt,
        plnty     LIKE mpos-plnty,
        plnnr     LIKE mpos-plnnr,
        plnal     LIKE mpos-plnal,
        gewrk     LIKE mpos-gewrk,
        iwerk     LIKE mpos-iwerk,
        kdauf     LIKE mpos-kdauf,
        kdpos     LIKE mpos-kdpos,
        strat     LIKE mpla-strat,
        stat      LIKE jest-stat, "MOD-002+
        bismt_equi LIKE mara-bismt,
      END OF gt_mplan2.

DATA: BEGIN OF gt_mhis OCCURS 0,
        warpl      LIKE mhis-warpl,
        deli1      TYPE c,
        wppos      LIKE mhio-wppos,
        deli2      TYPE c,
        abnum2(10) TYPE c,
        deli3      TYPE c,
        zaehl      LIKE mhis-zaehl,
        deli4      TYPE c,
        ktex1      LIKE t351x-ktex1,
        deli5      TYPE c,
        strat      LIKE t351-strat,
        deli6      TYPE c,
        nplda      LIKE mhis-nplda, "Plan Date
        deli7      TYPE c,
*        stdta      LIKE mhis-stadt, "Call Date
        stadt      LIKE mhis-stadt,
        deli8      TYPE c,
        dpack      TYPE ktextzyk,
        deli9      TYPE c,
        terma      LIKE mhis-terma, "Schedule Type
        deli10     TYPE c,
        abrud      LIKE mhis-abrud, "Call date
        deli11     TYPE c,
        lrmdt      LIKE mhis-lrmdt, "Completion date
        deli12     TYPE c,
        zykzt2(22) TYPE c, " Cycle
        deli13     TYPE c,
        offle2(22) TYPE c, "Annual Estim
        deli14     TYPE c,
        offze2(22) TYPE c,
        deli15     TYPE c,
        offzo2(22) TYPE c,
        deli16     TYPE c,
        tstat      TYPE mhis-tstat,
        deli17     TYPE c,          "MOD-001+
        pstxt      LIKE mpos-pstxt, "MOD-001+
        deli18     TYPE c,          "MOD-002+
        equnr      LIKE mpos-equnr, "MOD-002+
        deli19     TYPE c,          "MOD-002+
        kdauf      LIKE mpos-kdauf, "MOD-002+
        deli20     TYPE c,          "MOD-002+
        kdpos      LIKE mpos-kdpos, "MOD-002+
      END OF gt_mhis.

DATA: BEGIN OF gt_mhis_c OCCURS 0,
        warpl     LIKE dd03l-fieldname,
        deli1     TYPE c,
        wppos     LIKE dd03l-fieldname,
        deli2     TYPE c,
        abnum2    LIKE dd03l-fieldname,
        deli3     TYPE c,
        zaehl     LIKE dd03l-fieldname,
        deli4     TYPE c,
        ktex1     LIKE dd03l-fieldname,
        deli5     TYPE c,
        strat     LIKE dd03l-fieldname,
        deli6     TYPE c,
        nplda     LIKE dd03l-fieldname, "Plan Date
        deli7     TYPE c,
*        stdta     LIKE dd03l-fieldname, "Call Date
        stadt      LIKE dd03l-fieldname,
        deli8     TYPE c,
        dpack     LIKE dd03l-fieldname,
        deli9     TYPE c,
        terma     LIKE dd03l-fieldname, "Schedule Type
        deli10    TYPE c,
        abrud     LIKE dd03l-fieldname, "Call date
        deli11    TYPE c,
        lrmdt     LIKE dd03l-fieldname, "Completion date
        deli12    TYPE c,
        zykzt2    LIKE dd03l-fieldname, " Cycle
        deli13    TYPE c,
        offle2    LIKE dd03l-fieldname, "Annual Estim
        deli14    TYPE c,
        offze2    LIKE dd03l-fieldname,
        deli15    TYPE c,
        offzo2    LIKE dd03l-fieldname,
        deli16    TYPE c,
        tstat     LIKE dd03l-fieldname,
        deli17    TYPE c,               "MOD-001+
        pstxt     LIKE dd03l-fieldname, "MOD-001+
        deli18    TYPE c,               "MOD-002+
        equnr     LIKE dd03l-fieldname, "MOD-002+
        deli19    TYPE c,               "MOD-002+
        kdauf     LIKE dd03l-fieldname, "MOD-002+
        deli20    TYPE c,               "MOD-002+
        kdpos     LIKE dd03l-fieldname, "MOD-002+
      END OF gt_mhis_c.

* Begin of insert MOD-003
DATA: BEGIN OF gt_mplan_item_c OCCURS 0,
        warpl     LIKE dd03l-fieldname,
        deli1     TYPE c,
        wapos     LIKE dd03l-fieldname,
        deli2     TYPE c,
        pstxt     LIKE dd03l-fieldname,
        deli3     TYPE c,
        equnr     LIKE dd03l-fieldname,
        deli4     TYPE c,
        matnr     LIKE dd03l-fieldname,
        deli5     TYPE c,
        sernr     LIKE dd03l-fieldname,
        deli6     TYPE c,
        kdauf     LIKE dd03l-fieldname,
        deli7     TYPE c,
        kdpos     LIKE dd03l-fieldname,
        deli8     TYPE c,
        vkorg     LIKE dd03l-fieldname,
        deli9    TYPE c,
        vtweg     LIKE dd03l-fieldname,
        deli10    TYPE c,
        spart     LIKE dd03l-fieldname,
        deli11    TYPE c,
        qmart     LIKE dd03l-fieldname,
        deli12    TYPE c,
        iwerk     LIKE dd03l-fieldname,
        deli13    TYPE c,
        wpgrp     LIKE dd03l-fieldname,
        deli14    TYPE c,
        gewrk     LIKE dd03l-fieldname,
        deli15    TYPE c,
        plnty     LIKE dd03l-fieldname,
        deli16    TYPE c,
        plnnr     LIKE dd03l-fieldname,
        deli17    TYPE c,
        plnal     LIKE dd03l-fieldname,
      END OF gt_mplan_item_c.
* End of insert MOD-003

DATA: BEGIN OF gt_mhis2 OCCURS 0,
        warpl LIKE mhis-warpl,
        wppos LIKE mhio-wppos,
        abnum LIKE mhis-abnum,
        zaehl LIKE mhis-zaehl,
        ktex1 LIKE t351x-ktex1,
        strat LIKE t351-strat,
        nplda LIKE mhis-nplda, "Plan Date
*        stdta LIKE mhis-stadt, "Call Date
        stadt LIKE mhis-stadt,
        dpack TYPE ktextzyk,
        terma LIKE mhis-terma, "Schedule Type
        abrud LIKE mhis-abrud, "Call date
        lrmdt LIKE mhis-lrmdt, "Completion date
        zykzt TYPE mhis-zykzt, " Cycle
        offle TYPE mhis-offle, "Annual Estim
        offze TYPE mhis-offze,
        offzo TYPE mhis-offzo,
        tstat TYPE mhis-tstat,
        pstxt TYPE mpos-pstxt, "MOD-001+
        equnr TYPE mpos-equnr, "MOD-002+
        kdauf TYPE mpos-kdauf, "MOD-002+
        kdpos TYPE mpos-kdpos, "MOD-002+
      END OF gt_mhis2.

DATA: BEGIN OF gt_mplanh_c OCCURS 0,
        warpl     LIKE dd03l-fieldname,
        deli1     TYPE c,
        wptxt     LIKE dd03l-fieldname,
        deli2     TYPE c,
        equnr     LIKE dd03l-fieldname,
        deli3     TYPE c,
        point     LIKE dd03l-fieldname,
        deli4     TYPE c,
        vspos     LIKE dd03l-fieldname,
        deli5     TYPE c,
        topos     LIKE dd03l-fieldname,
        deli6     TYPE c,
        vsneg     LIKE dd03l-fieldname,
        deli7     TYPE c,
        toneg     LIKE dd03l-fieldname,
        deli8     TYPE c,
        sfakt     LIKE dd03l-fieldname,
        deli9     TYPE c,
        horiz     LIKE dd03l-fieldname,
        deli10    TYPE c,
        abrho     LIKE dd03l-fieldname,
        deli11    TYPE c,
        hunit     LIKE dd03l-fieldname,
        deli12    TYPE c,
        plan_sort LIKE dd03l-fieldname,
        deli13    TYPE c,
        mptyp     LIKE dd03l-fieldname,
        deli14    TYPE c,
        strat     LIKE dd03l-fieldname,
        deli15    TYPE c,
        stich     LIKE dd03l-fieldname,
        deli16    TYPE c,               "MOD-002+
        status    LIKE dd03l-fieldname, "MOD-002+
        deli17    TYPE c,               "MOD-002+
        future_v  LIKE dd03l-fieldname, "MOD-002+
        deli18    TYPE c,               "MOD-002+
        visit_index LIKE dd03l-fieldname, "MOD-002+
        deli19    TYPE c,               "MOD-002+
        nplda2     LIKE dd03l-fieldname, "MOD-002+
        deli20    TYPE c,               "MOD-002+
        packages  LIKE dd03l-fieldname, "MOD-002+
        deli21    TYPE c,               "MOD-002+
        ratio     LIKE dd03l-fieldname, "MOD-002+
        deli22    TYPE c,               "MOD-004
        bismt_equi LIKE dd03l-fieldname,"MOD-004
      END OF gt_mplanh_c.


DATA: lv_date_6 TYPE sy-datum,
      lv_enddat TYPE endat_fp.


DATA: BEGIN OF gt_plko OCCURS 0,
        plnty     LIKE plko-plnty,
        plnnr     LIKE plko-plnnr,
        plnal     LIKE plko-plnal,
        datuv     LIKE plko-datuv,
        ktext     LIKE plko-ktext,
        arbid     LIKE plko-arbid,
        arbpl     LIKE crhd-arbpl,
        vagrp     LIKE plko-vagrp,
        anlzu     LIKE plko-anlzu,
        strat     LIKE plko-strat,
      END OF gt_plko.

DATA: BEGIN OF gt_tasklh OCCURS 0,
        plnty     LIKE plko-plnty,
        deli1     TYPE c,
        plnnr     LIKE plko-plnnr,
        deli2     TYPE c,
        plnal     LIKE plko-plnal,
        deli3     TYPE c,
        datuv     LIKE plko-datuv,
        deli4     TYPE c,
        ktext     LIKE plko-ktext,
        deli5     TYPE c,
        arbpl     LIKE crhd-arbpl,
        deli6     TYPE c,
        vagrp     LIKE plko-vagrp,
        deli7     TYPE c,
        anlzu     LIKE plko-anlzu,
        deli8     TYPE c,
        strat     LIKE plko-strat,
      END OF gt_tasklh.

DATA: BEGIN OF gt_tasklh_c OCCURS 0,
        plnty     LIKE dd03l-fieldname,
        deli1     TYPE c,
        plnnr     LIKE dd03l-fieldname,
        deli2     TYPE c,
        plnal     LIKE dd03l-fieldname,
        deli3     TYPE c,
        datuv     LIKE dd03l-fieldname,
        deli4     TYPE c,
        ktext     LIKE dd03l-fieldname,
        deli5     TYPE c,
        arbpl     LIKE dd03l-fieldname,
        deli6     TYPE c,
        vagrp     LIKE dd03l-fieldname,
        deli7     TYPE c,
        anlzu     LIKE dd03l-fieldname,
        deli8     TYPE c,
        strat     LIKE dd03l-fieldname,
      END OF gt_tasklh_c.

* Begin of insert MOD-003
DATA: BEGIN OF gt_mplan_item OCCURS 0,
        warpl     LIKE mpos-warpl,
        deli1     TYPE c,
        wapos     LIKE mpos-wapos,
        deli2     TYPE c,
        pstxt     LIKE mpos-pstxt,
        deli3     TYPE c,
        equnr     LIKE mpos-equnr,
        deli4     TYPE c,
        matnr     LIKE equi-matnr,
        deli5     TYPE c,
        sernr     LIKE equi-sernr,
        deli6     TYPE c,
        kdauf     LIKE mpos-kdauf,
        deli7     TYPE c,
        kdpos     LIKE mpos-kdpos,
        deli8     TYPE c,
        vkorg     TYPE vbak-vkorg,
        deli9     TYPE c,
        vtweg     LIKE vbak-vtweg,
        deli10    TYPE c,
        spart     LIKE vbak-spart,
        deli11    TYPE c,
        qmart     TYPE mpos-qmart,
        deli12    TYPE c,
        iwerk     LIKE mpos-iwerk,
        deli13    TYPE c,
        wpgrp     LIKE mpos-wpgrp,
        deli14    TYPE c,
        gewrk     LIKE crhd-arbpl,
        deli15    TYPE c,
        plnty     LIKE mpos-plnty,
        deli16    TYPE c,
        plnnr     LIKE mpos-plnnr,
        deli17    TYPE c,
        plnal     LIKE mpos-plnal,
      END OF gt_mplan_item.
* End of insert MOD-003

DATA: BEGIN OF gt_mplanh OCCURS 0,
        warpl     LIKE mpla-warpl,
        deli1     TYPE c,
        wptxt     LIKE mpla-wptxt,
        deli2     TYPE c,
        equnr     LIKE mpos-equnr,
        deli3     TYPE c,
        point     LIKE imptt-point,
        deli4     TYPE c,
        vspos     LIKE mpla-vspos,
        deli5     TYPE c,
        topos     LIKE mpla-topos,
        deli6     TYPE c,
        vsneg     LIKE mpla-vsneg,
        deli7     TYPE c,
        toneg     LIKE mpla-toneg,
        deli8     TYPE c,
        sfakt2(4) TYPE c,
        deli9     TYPE c,
        horiz     LIKE mpla-horiz,
        deli10    TYPE c,
        abrho     LIKE mpla-abrho,
        deli11    TYPE c,
        hunit2(3) TYPE c,
        deli12    TYPE c,
        plan_sort LIKE mpla-plan_sort,
        deli13    TYPE c,
        mptyp     LIKE mpla-mptyp,
        deli14    TYPE c,
        strat     LIKE mpla-strat,
        deli15    TYPE c,
        stich     LIKE mpla-stich,
        deli16    TYPE c,             "MOD-002+
        status    TYPE c LENGTH 6,    "MOD-002+
        deli17    TYPE c,             "MOD-002+
        future_v  TYPE c LENGTH 10,   "MOD-002+
        deli18    TYPE c,             "MOD-002+
        visit_index(20),              "MOD-002+
        deli19    TYPE c,             "MOD-002+
        nplda2(10),                   "MOD-002+
        deli20    TYPE c,             "MOD-002+
        packages(100),                "MOD-002+
        deli21    TYPE c,             "MOD-002+
        ratio(100),                   "MOD-002+
        deli22    TYPE c,             "MOD-004
        bismt_equi TYPE mara-bismt,   "MOD-004
      END OF gt_mplanh.

DATA: BEGIN OF gt_mplans OCCURS 0,
        warpl     LIKE mpla-warpl,
        wptxt     LIKE mpla-wptxt,
        equnr     LIKE mpos-equnr,
        point     LIKE imptt-point,
        vspos     LIKE mpla-vspos,
        topos     LIKE mpla-topos,
        vsneg     LIKE mpla-vsneg,
        sfakt     LIKE mpla-sfakt,
        horiz     LIKE mpla-horiz,
        abrho     LIKE mpla-abrho,
        hunit     LIKE mpla-hunit,
        plan_sort LIKE mpla-plan_sort,
        mptyp     LIKE mpla-mptyp,
        strat     LIKE mpla-strat,
      END OF gt_mplans.



DATA: BEGIN OF gt_taskl_oper OCCURS 0,
        warpl     LIKE mpla-warpl,
        deli1     TYPE c,
        wapos     LIKE mpos-wapos,
        deli2     TYPE c,
        pstxt     LIKE mpos-pstxt,
        deli3     TYPE c,
        plnnr     LIKE mpos-plnnr,
        deli4     TYPE c,
        plnal     LIKE mpos-plnal,
        deli5     TYPE c,
        equnr     LIKE mpos-equnr,
        deli6     TYPE c,
        arbpl     LIKE crhd-arbpl,
        deli7     TYPE c,
        iwerk     LIKE mpos-iwerk,
        deli8     TYPE c,
        kdauf     LIKE mpos-kdauf,
        deli9     TYPE c,
        kdpos     LIKE mpos-kdpos,
        deli10    TYPE c,
        strat     LIKE mpla-strat,
        deli11    TYPE c,
        kzyk1     LIKE t351x-kzyk1,
        deli12    TYPE c,
        plnkn     LIKE plas-plnkn,
        deli13    TYPE c,
        vornr     LIKE plpo-vornr,
        deli14    TYPE c,
        steus     LIKE plpo-steus,
        deli15    TYPE c,
        larnt     LIKE plpo-larnt,
        deli16    TYPE c,
        arbei(9),
        deli17    TYPE c,
        arbeh(3),
        deli18    TYPE c,
        werks     LIKE plpo-werks,
        deli19    TYPE c,
        arbpl_t   LIKE crhd-arbpl,
        deli20    TYPE c,
        ktsch     LIKE plpo-ktsch,
        deli21    TYPE c,
        ltxa1     LIKE plpo-ltxa1,
        deli22    TYPE c,
        equsol    TYPE kunnr,
        deli23    TYPE c,
        comlng(2) TYPE c,
        deli24    TYPE c,
        txtlng    TYPE ltxa1,
        deli25    TYPE c,
        wpgrp     LIKE mpos-wpgrp,
        deli26    TYPE c,
        datuv     TYPE plko-datuv,
        deli27    TYPE c,
        qmart     LIKE mpos-qmart,
        deli28    TYPE c,
        priok     LIKE mpos-priok,
        deli29    TYPE c,
        task_determine LIKE mpos-task_determine,
        deli30    TYPE c,
        pyear(22) TYPE c,
      END OF gt_taskl_oper.

DATA: BEGIN OF gt_taskl_oper_c OCCURS 0,
        warpl     LIKE dd03l-fieldname,
        deli1     TYPE c,
        wapos     LIKE dd03l-fieldname,
        deli2     TYPE c,
        pstxt     LIKE dd03l-fieldname,
        deli3     TYPE c,
        plnnr     LIKE dd03l-fieldname,
        deli4     TYPE c,
        plnal     LIKE dd03l-fieldname,
        deli5     TYPE c,
        equnr     LIKE dd03l-fieldname,
        deli6     TYPE c,
        arbpl     LIKE dd03l-fieldname,
        deli7     TYPE c,
        iwerk     LIKE dd03l-fieldname,
        deli8     TYPE c,
        kdauf     LIKE dd03l-fieldname,
        deli9     TYPE c,
        kdpos     LIKE dd03l-fieldname,
        deli10    TYPE c,
        strat     LIKE dd03l-fieldname,
        deli11    TYPE c,
        kzyk1     LIKE dd03l-fieldname,
        deli12    TYPE c,
        plnkn     LIKE dd03l-fieldname,
        deli13    TYPE c,
        vornr     LIKE dd03l-fieldname,
        deli14    TYPE c,
        steus     LIKE dd03l-fieldname,
        deli15    TYPE c,
        larnt     LIKE dd03l-fieldname,
        deli16    TYPE c,
        arbei     LIKE dd03l-fieldname,
        deli17    TYPE c,
        arbeh     LIKE dd03l-fieldname,
        deli18    TYPE c,
        werks     LIKE dd03l-fieldname,
        deli19    TYPE c,
        arbpl_t   LIKE dd03l-fieldname,
        deli20    TYPE c,
        ktsch     LIKE dd03l-fieldname,
        deli21    TYPE c,
        ltxa1     LIKE dd03l-fieldname,
        deli22    TYPE c,
        equsol    TYPE dd03l-fieldname,
        deli23    TYPE c,
        comlng    TYPE dd03l-fieldname,
        deli24    TYPE c,
        txtlng    TYPE dd03l-fieldname,
        deli25    TYPE c,
        wpgrp     LIKE dd03l-fieldname,
        deli26    TYPE c,
        datuv     LIKE dd03l-fieldname,
        deli27    TYPE c,
        qmart     LIKE dd03l-fieldname,
        deli28    TYPE c,
        priok     LIKE dd03l-fieldname,
        deli29    TYPE c,
        task_determine LIKE dd03l-fieldname,
        deli30    TYPE c,
        pyear     LIKE dd03l-fieldname,
      END OF gt_taskl_oper_c.

DATA: BEGIN OF gt_crhd OCCURS 0.
        INCLUDE STRUCTURE crhd.
DATA: END OF gt_crhd.

DATA: BEGIN OF gt_plas OCCURS 0,
        plnty     LIKE plas-plnty,
        plnnr     LIKE plas-plnnr,
        plnal     LIKE plas-plnal,
        plnfl     LIKE plas-plnfl,
        plnkn     LIKE plas-plnkn,
        zaehl     LIKE plas-zaehl,
      END OF gt_plas.

DATA: BEGIN OF gt_plpo OCCURS 0,
        plnty     LIKE plas-plnty,
        plnnr     LIKE plas-plnnr,
        plnkn     LIKE plas-plnkn,
        zaehl     LIKE plas-zaehl,
        vornr     LIKE plpo-vornr,
        steus     LIKE plpo-steus,
        larnt     LIKE plpo-larnt,
        arbei     LIKE plpo-arbei,
        arbeh     LIKE plpo-arbeh,
        werks     LIKE plpo-werks,
        ktsch     LIKE plpo-ktsch,
        ltxa1     LIKE plpo-ltxa1,
        arbid     LIKE plpo-arbid,
        vplal     LIKE plpo-vplal,
      END OF gt_plpo.

DATA: BEGIN OF gt_plmz OCCURS 0,
        plnty     LIKE plas-plnty,
        plnnr     LIKE plas-plnnr,
        plnkn     LIKE plas-plnkn,
        stlty     LIKE plmz-stlty,
        stlnr     LIKE plmz-stlnr,
        stlkn     LIKE plmz-stlkn,
        imeng     LIKE plmz-imeng,
        imein     LIKE plmz-imein,
      END OF gt_plmz.

DATA: BEGIN OF gt_stpo OCCURS 0,
        stlty     LIKE stpo-stlty,
        stlnr     LIKE stpo-stlnr,
        stlkn     LIKE stpo-stlkn,
        idnrk     LIKE stpo-idnrk,
      END OF gt_stpo.

DATA: BEGIN OF gt_comp OCCURS 0,
        warpl     LIKE mpla-warpl,
        deli1     TYPE c,
        wapos     LIKE mpos-wapos,
        deli2     TYPE c,
        plnnr     LIKE mpos-plnnr,
        deli3     TYPE c,
        plnal     LIKE mpos-plnal,
        deli4     TYPE c,
        vornr     LIKE plpo-vornr,
        deli5     TYPE c,
        imeng(17),
        deli6     TYPE c,
        imein(3),
        deli7     TYPE c,
        idnrk     LIKE stpo-idnrk,
        deli8     TYPE c,  "MOD-004
        bismt     LIKE mara-bismt, "MOD-004
      END OF gt_comp.

DATA: BEGIN OF gt_comp_c OCCURS 0,
        warpl     LIKE dd03l-fieldname,
        deli1     TYPE c,
        wapos     LIKE dd03l-fieldname,
        deli2     TYPE c,
        plnnr     LIKE dd03l-fieldname,
        deli3     TYPE c,
        plnal     LIKE dd03l-fieldname,
        deli4     TYPE c,
        vornr     LIKE dd03l-fieldname,
        deli5     TYPE c,
        imeng     LIKE dd03l-fieldname,
        deli6     TYPE c,
        imein     LIKE dd03l-fieldname,
        deli7     TYPE c,
        idnrk     LIKE dd03l-fieldname,
        deli8     TYPE c,
        bismt     LIKE dd03l-fieldname,  "MOD-004
      END OF gt_comp_c.

DATA: BEGIN OF gt_skills_c OCCURS 0,
        warpl     LIKE dd03l-fieldname,
        deli1     TYPE c,
        wapos     LIKE dd03l-fieldname,
        deli2     TYPE c,
        plnnr     LIKE dd03l-fieldname,
        deli3     TYPE c,
        plnal     LIKE dd03l-fieldname,
        deli4     TYPE c,
        class     LIKE dd03l-fieldname,
        deli5     TYPE c,
        atnam     LIKE dd03l-fieldname,
        deli6     TYPE c,
        atwrt     LIKE dd03l-fieldname,
        deli7     TYPE c,
        atwtb     LIKE dd03l-fieldname,
      END OF gt_skills_c.

DATA: BEGIN OF gt_skills OCCURS 0,
        warpl     LIKE mpla-warpl,
        deli1     TYPE c,
        wapos     LIKE mpos-wapos,
        deli2     TYPE c,
        plnnr     LIKE mpos-plnnr,
        deli3     TYPE c,
        plnal     LIKE mpos-plnal,
        deli4     TYPE c,
        class     TYPE klasse_d,
        deli5     TYPE c,
        atnam     TYPE atnam,
        deli6     TYPE c,
        atwrt     TYPE atwrt,
        deli7     TYPE c,
        atwtb     TYPE atwtb,
      END OF gt_skills.

DATA: gt_basic_data TYPE cuvtab OCCURS 0  WITH HEADER LINE,
      gt_value_n    TYPE cuvtab_valn OCCURS 0  WITH HEADER LINE,
      gt_value_c    TYPE cuvtab_valc OCCURS 0  WITH HEADER LINE,
      gs_mplanh     LIKE gt_mplanh,
* Begin of insert MOD-003
      gs_mplan_item LIKE gt_mplan_item,
* End of insert MOd-003
      lv_hunit      TYPE mpla-hunit,
      lv_sfakt      TYPE mpla-sfakt,
      gs_mhis       LIKE gt_mhis,
      gs_tasklh     LIKE gt_tasklh.

DATA: lv_atinn  TYPE atinn,
      lv_mpobj  LIKE imptt-mpobj,
      lv1_point LIKE imptt-point,
      lv_index  TYPE sy-tabix,
      lv_pyear  LIKE imptt-pyear,
      lv_mrngu  TYPE imptt-mrngu,
      lv_pyear_i TYPE i.

* Begin of insert MOD-006
DATA: lv_venddat TYPE vndat_veda.
* End of insert MOD-006

*------------------------------------------------------------------
* Variables
DATA: gv_atinn_country    TYPE atinn,
      gv_atinn_km         TYPE atinn,
      gv_atinn_exlab      TYPE atinn,
      gv_atinn_subcontr   TYPE atinn,
      gv_atinn_allow      TYPE atinn,
      gv_atinn_visitour   TYPE atinn,
      gv_atinn_oil        TYPE atinn,
      gv_atinn_cooltype   TYPE atinn, "MOD-001+
      gv_atinn_levels     TYPE atinn,
      gv_atinn_skills     TYPE atinn,
      gv_comp             TYPE bukrs,
      gv_werks            TYPE iwerk,
      gv_dist             TYPE arbeit,
      gv_dist_eq          TYPE arbeit,
      gv_dist_eq_c(9)     TYPE c,
      gv_hrs              TYPE arbeit,
      gv_hrs_vis          TYPE arbeit,
      gv_hrs_vis_c(9)     TYPE c,
      gv_hrs_eq           TYPE arbeit,
      gv_hrs_eq_c(9)        TYPE c,
      gv_paket            TYPE plwp-paket,
      gv_save_werks       TYPE iwerk,
      gv_kzyk1            TYPE t351x-kzyk1,
      gv_objek            LIKE inob-objek,
      gv_char(19)         TYPE c,
      gv_float            TYPE f,
      gv_atinn_exlabvis   TYPE atinn,
      gv_cuobj            TYPE cuib_cuobj,
      gv_atzhl            TYPE ausp-atzhl,
      gt_values           TYPE ibco2_value_tab,
      gs_values           TYPE LINE OF ibco2_value_tab,
      gv_allow(1)         TYPE c,
      gv_subcontr(1)      TYPE c,
      gv_visitour(1)      TYPE c,
      gv_oil(1)           TYPE c,
      gv_oil_eq(1)        TYPE c,
      gv_cooltype(1)      TYPE c, "MOD-001+
      gv_cooltype_eq(1)   TYPE c, "MOD-001+
      gv_objnr_warpl      LIKE jest-objnr.

DATA: lv_kunnr TYPE kunnr,
      lv_spras TYPE sy-langu,
      lv_spras2(2) TYPE c,
      lv_objnr TYPE j_objnr.

DATA: g_directory(25) TYPE c VALUE '/var/load/xxx/UK/read/',
      g_ofile         LIKE /sapdmc/lsoinp-filename,
      p_logsys        LIKE tbdlst-logsys.

* Begin of insert MOD-003
DATA: lv_vkorg TYPE vkorg,
      lv_vtweg TYPE vtweg,
      lv_spart TYPE spart,
      lv_zyk1g TYPE dzyk1_ges.
DATA: gt_config       TYPE conf_out   OCCURS 0 WITH HEADER LINE,
      gs_config       TYPE conf_out.
* End of insert MOD-003
*>>> Begin insert MOD-002
TYPES: BEGIN OF t_schedule,
           warpl TYPE warpl,
           abnum TYPE abnum,
           nplda TYPE nplda, "PlanDate
           terma TYPE terma, "Schedule Type
           zaehl TYPE paketzaehl, "Visit package
           addat TYPE datum. "completion date
TYPES: END OF t_schedule.

DATA: i_schedule TYPE STANDARD TABLE OF t_schedule WITH HEADER LINE.
DATA lv_inactive(1) TYPE c.
DATA lv_future_visits TYPE string.
DATA lv_strategy TYPE strat.
DATA lv_package(5) TYPE c.
DATA: lt_mhis TYPE TABLE OF mhis.
*<<< End insert MOD-002

FIELD-SYMBOLS: <gs_value>  TYPE ibco2_value_rec.

DATA : lt_lines TYPE STANDARD TABLE OF tline,
       lw_lines TYPE tline,
       l_name   TYPE tdobname.

DATA: lv_fplnr TYPE fplnr.

************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************
SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
PARAMETERS:     p_iwerk  LIKE mpos-iwerk MEMORY ID wrk.
SELECT-OPTIONS: s_equnr  FOR  mpos-equnr,
                s_kdauf  FOR  vbak-vbeln  MATCHCODE OBJECT vmva,
                s_warpl  FOR  mpla-warpl.
PARAMETERS:     p_bukrs  TYPE aufk-bukrs OBLIGATORY MEMORY ID buk,
                p_vkorg  TYPE knvv-vkorg MEMORY ID vko.
PARAMETERS:     p_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\MP_taskl_oper',
                p_filec  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Components',
                p_files  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Skills',
                p_filemh  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\MaintPlansHeader',
* Begin of insert MOD-003
                p_filemi LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\MaintPlanItems',
* End of insert MOD-003
                p_filems  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\MaintPlanSchedule',
                p_fileth  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\Taskl_Header'.

* Begin of insert MOD-006
PARAMETERS:     p_active AS CHECKBOX DEFAULT 'X'.
* End of insert MOD-006

SELECTION-SCREEN: END OF BLOCK b1.

* Comment
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c01.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c02.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c03.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b2.

*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_iwerk.

  IF p_iwerk IS NOT INITIAL.
* Check planning plant
    SELECT SINGLE werks
         INTO gv_werks
         FROM t001w
         WHERE werks = p_iwerk.

    IF sy-subrc <> 0.
*.. Planning plant does not exist
      MESSAGE e001(00) WITH text-e02.
    ENDIF.

    AUTHORITY-CHECK OBJECT 'I_IWERK'
             ID 'TCD'   FIELD sy-tcode
             ID 'IWERK' FIELD p_iwerk.

    IF sy-subrc NE 0.
*.. No authorization for plant: &1
      MESSAGE e001(00) WITH text-e03 p_iwerk.
    ENDIF.
  ENDIF.


*- Initialization -----------------------------------------------------*
INITIALIZATION.

  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = p_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.


*  SELECT
*     a~warpl b~wapos b~pstxt b~plnty b~plnnr b~plnal b~gewrk b~equnr
*     b~kdauf b~kdpos b~iwerk a~strat b~wpgrp b~qmart b~priok b~task_determine
*        INTO CORRESPONDING FIELDS OF TABLE gt_mplan
*        FROM mpla AS a
*        INNER JOIN mpos AS b
*           ON  a~warpl = b~warpl
*        WHERE  a~warpl IN s_warpl
*          AND  b~equnr IN s_equnr
*          AND  b~kdauf IN s_kdauf
*          AND  b~iwerk EQ p_iwerk.
  DATA: lv_where TYPE string.
  lv_where = 'a~warpl IN s_warpl AND b~equnr IN s_equnr AND b~kdauf IN s_kdauf'.
  IF p_iwerk IS NOT INITIAL.
    CONCATENATE lv_where 'AND b~iwerk EQ p_iwerk' INTO lv_where SEPARATED BY space.
  ENDIF.
  CONCATENATE lv_where 'AND t001k~bukrs EQ p_bukrs' INTO lv_where SEPARATED BY space.
  IF p_vkorg IS INITIAL.
    SELECT
       a~warpl b~wapos b~pstxt b~plnty b~plnnr b~plnal b~gewrk b~equnr
       b~kdauf b~kdpos b~iwerk a~strat b~wpgrp b~qmart b~priok b~task_determine
          INTO CORRESPONDING FIELDS OF TABLE gt_mplan
          FROM mpla AS a
          INNER JOIN mpos AS b
             ON  a~warpl = b~warpl
          INNER JOIN t001k AS t001k
             ON t001k~bwkey EQ b~iwerk
          WHERE (lv_where) .
  ELSE.
    CONCATENATE lv_where 'AND v_equi~vkorg eq p_vkorg AND v_equi~datbi = ''99991231'' '  INTO lv_where SEPARATED BY space.
    SELECT
       a~warpl b~wapos b~pstxt b~plnty b~plnnr b~plnal b~gewrk b~equnr
       b~kdauf b~kdpos b~iwerk a~strat b~wpgrp b~qmart b~priok b~task_determine
* Begin of insert MOD-003
       v_equi~matnr v_equi~sernr b~kdauf
* End of insert MOD-003
          INTO CORRESPONDING FIELDS OF TABLE gt_mplan
          FROM mpla AS a
          INNER JOIN mpos AS b
             ON  a~warpl = b~warpl
          INNER JOIN t001k AS t001k
             ON t001k~bwkey EQ b~iwerk
          INNER JOIN v_equi AS v_equi
             ON v_equi~equnr EQ b~equnr
            WHERE (lv_where) .
  ENDIF.

* Retrieve system date - 6 months

  CALL FUNCTION 'HR_PT_ADD_MONTH_TO_DATE'
    EXPORTING
      dmm_datin = sy-datum
      dmm_count = '6'
      dmm_oper  = '-'
      dmm_pos   = ' '
    IMPORTING
      dmm_daout = lv_date_6.

* Select only the active maintenance plans
* not deleted / not inactive
  LOOP AT gt_mplan.

* Begin of insert MOD-006
    IF s_kdauf IS INITIAL AND p_active = 'X'.
      SELECT SINGLE venddat INTO lv_venddat
        FROM veda
        WHERE vbeln = gt_mplan-kdauf AND vposn = gt_mplan-kdpos.
      IF sy-subrc = 0.
        IF lv_venddat < lv_date_6.
* Also check the billing plan

          SELECT SINGLE fplnr INTO lv_fplnr
           FROM vbkd
           WHERE vbeln EQ gt_mplan-kdauf
             AND posnr EQ gt_mplan-kdpos.


          SELECT SINGLE endat INTO lv_enddat
            FROM fpla
            WHERE fplnr = lv_fplnr AND endat < lv_date_6.
          IF sy-subrc = 0.
            DELETE gt_mplan.
            CONTINUE.
          ENDIF.
        ENDIF.
      ELSE.
        SELECT SINGLE venddat INTO lv_venddat
        FROM veda
        WHERE vbeln = gt_mplan-kdauf AND vposn = c_000000.
        IF sy-subrc = 0.
          IF lv_venddat < lv_date_6.
* Also check the billing plan

            SELECT SINGLE fplnr INTO lv_fplnr
             FROM vbkd
             WHERE vbeln EQ gt_mplan-kdauf
               AND posnr EQ gt_mplan-kdpos.


            SELECT SINGLE endat INTO lv_enddat
              FROM fpla
              WHERE fplnr = lv_fplnr AND endat < lv_date_6.
            IF sy-subrc = 0.
              DELETE gt_mplan.
              CONTINUE.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.

    ENDIF.
* End of insert MOD-006

    lv_index = sy-tabix.  "MOD-002+
    CONCATENATE 'WO' gt_mplan-warpl INTO gv_objnr_warpl.

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = gt_mplan-matnr
      IMPORTING
        output = gt_mplan-matnr.

    SELECT SINGLE bismt FROM mara INTO gt_mplan-bismt_equi
       WHERE matnr = gt_mplan-matnr.

    CALL FUNCTION 'STATUS_CHECK'
      EXPORTING
        objnr             = gv_objnr_warpl
        status            = 'I0320'
      EXCEPTIONS
        object_not_found  = 1
        status_not_active = 2
        OTHERS            = 3.
    IF sy-subrc EQ 0.
*      DELETE gt_mplan.                                 "MOD-002-
      gt_mplan-stat = c_i0320.                          "MOD-002+
      MODIFY gt_mplan INDEX lv_index TRANSPORTING stat. "MOD-002+
      CONTINUE.
    ELSE.
      CALL FUNCTION 'STATUS_CHECK'
        EXPORTING
          objnr             = gv_objnr_warpl
          status            = 'I0076'
        EXCEPTIONS
          object_not_found  = 1
          status_not_active = 2
          OTHERS            = 3.
      IF sy-subrc EQ 0.
*        DELETE gt_mplan.                                 "MOD-002-
        gt_mplan-stat = c_i0076.                          "MOD-002+
        MODIFY gt_mplan INDEX lv_index TRANSPORTING stat. "MOD-002+
        CONTINUE.
      ENDIF.
    ENDIF.
  ENDLOOP.

  IF gt_mplan[] IS INITIAL.
    WRITE: / text-i01.              "No MP's selected
    EXIT.
  ENDIF.

* Preselect variant table for central task lists
  CALL FUNCTION 'CUTX_INIT_STRUC_ENTRY_PLANNING'
    EXPORTING
      var_tab          = gc_z_vc_table
    TABLES
      et_basic_data    = gt_basic_data
      et_table_value_n = gt_value_n
      et_table_value_c = gt_value_c
    EXCEPTIONS
      table_not_found  = 1
      OTHERS           = 2.

  IF sy-subrc <> 0.
    WRITE: / text-i02.              "No variant table available
    EXIT.
  ENDIF.

* Get company code for the selected planning plant
  SELECT SINGLE bukrs INTO gv_comp
     FROM t001k
     WHERE bwkey = p_iwerk.

* Preselect workcenters
  SELECT * FROM crhd INTO TABLE gt_crhd
    WHERE werks = p_iwerk
      AND objty = 'A'.

  SORT gt_crhd BY objid.

* Get internal numbers for the caracteristics
  SELECT SINGLE atinn INTO gv_atinn_country
      FROM cabn
      WHERE atnam = gc_country.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_EQUIPMENT_COUNTRY'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_km
      FROM cabn
      WHERE atnam = gc_km.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_KM'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_exlab
      FROM cabn
      WHERE atnam = gc_exlab.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_EXTRALABOUR'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_allow
      FROM cabn
      WHERE atnam = gc_allow.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_ALLOWANCE'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_subcontr
      FROM cabn
      WHERE atnam = gc_subcontr.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_SUBCONTRACTOR'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_visitour
      FROM cabn
      WHERE atnam = gc_visitour.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_VISITOUR'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_oil
      FROM cabn
      WHERE atnam = gc_oil.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_OIL'.
    EXIT.
  ENDIF.

*>>> Begin insert MOD-001
  SELECT SINGLE atinn INTO gv_atinn_cooltype
      FROM cabn
      WHERE atnam = gc_cooltype.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'CH_TL_COOLTYPE'.
    EXIT.
  ENDIF.
*<<< End insert MOD-001

  SELECT SINGLE atinn INTO gv_atinn_levels
      FROM cabn
      WHERE atnam = gc_levels.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'ZAM_LEVELS'.
    EXIT.
  ENDIF.

  SELECT SINGLE atinn INTO gv_atinn_skills
      FROM cabn
      WHERE atnam = gc_skills.

  IF sy-subrc <> 0.
    WRITE: / text-i03, 'ZAM_SKILL_SET'.
    EXIT.
  ENDIF.

*-----------------------------------------------------------------------
END-OF-SELECTION.

  DATA: lv_visit_index TYPE i,
        lv_nplda TYPE nplda,
        lv_packages TYPE string,
        lv_ratio TYPE string.

  FIELD-SYMBOLS: <ls_mhis> LIKE LINE OF gt_mhis.

  SORT gt_mplan BY warpl wapos.

  REFRESH: gt_plas,
           gt_plko,
           gt_plpo.

* Begin of insert MOD-003
* Maintenance Plan Item
  LOOP AT gt_mplan.
*    WHERE stat NE c_i0320 AND stat NE c_i0076.
    CLEAR: lv_vkorg, lv_vtweg, lv_spart.
    MOVE-CORRESPONDING gt_mplan TO gs_mplan_item.
    SELECT SINGLE vkorg vtweg spart INTO (lv_vkorg, lv_vtweg, lv_spart)
      FROM vbak
     WHERE vbeln = gt_mplan-kdauf.
    gs_mplan_item-vkorg = lv_vkorg.
    gs_mplan_item-vtweg = lv_vtweg.
    gs_mplan_item-spart = lv_spart.
    IF gt_mplan-matnr IS INITIAL.
      SELECT SINGLE matnr sernr INTO (gs_mplan_item-matnr, gs_mplan_item-sernr)
        FROM v_equi
       WHERE equnr = gt_mplan-equnr AND datbi = '99991231'.
    ENDIF.

    SELECT SINGLE arbpl INTO gs_mplan_item-gewrk
       FROM crhd WHERE objty = 'A'
                 AND objid = gt_mplan-gewrk.

    MOVE '|' TO: gs_mplan_item-deli1, gs_mplan_item-deli2, gs_mplan_item-deli3,
                 gs_mplan_item-deli4, gs_mplan_item-deli5, gs_mplan_item-deli6,
                 gs_mplan_item-deli7, gs_mplan_item-deli8, gs_mplan_item-deli9,
                 gs_mplan_item-deli10, gs_mplan_item-deli11, gs_mplan_item-deli12,
                 gs_mplan_item-deli13, gs_mplan_item-deli14, gs_mplan_item-deli15,
                 gs_mplan_item-deli16, gs_mplan_item-deli17.


    APPEND gs_mplan_item TO gt_mplan_item.
  ENDLOOP.
* End of insert MOd-003

*  LOOP AT gt_mplan.                                          "MOD-002-
  LOOP AT gt_mplan.
*    WHERE stat NE c_i0320 AND stat NE c_i0076. "MOD-002+
    CLEAR gt_taskl_oper.
    MOVE-CORRESPONDING gt_mplan TO gt_taskl_oper.

*   Select tasklist info
    SELECT plnty plnnr plnal datuv ktext arbid vagrp anlzu strat
           APPENDING CORRESPONDING FIELDS OF TABLE gt_plko
           FROM plko
           WHERE plnty = gt_mplan-plnty
             AND plnnr = gt_mplan-plnnr
             AND plnal = gt_mplan-plnal
             AND loekz = space.

    SELECT plnty plnnr plnal plnfl plnkn zaehl
           INTO TABLE gt_plas
           FROM plas
           WHERE plnty = gt_mplan-plnty
             AND plnnr = gt_mplan-plnnr
             AND plnal = gt_mplan-plnal
             AND loekz = space.

    IF NOT gt_plas[] IS INITIAL.
      SELECT plnty plnnr plnkn zaehl vornr steus
             larnt arbei arbeh werks ktsch ltxa1 arbid vplal
             INTO TABLE gt_plpo
             FROM plpo
             FOR ALL ENTRIES IN gt_plas
             WHERE plnty = gt_plas-plnty
               AND plnnr = gt_plas-plnnr
               AND plnkn = gt_plas-plnkn
               AND loekz = space
               AND NOT ( steus = 'ZCO3' AND arbei = 0 AND ltxa1 = ' ' ).
    ENDIF.

*.. Select workcenter
    READ TABLE gt_crhd WITH KEY objid = gt_mplan-gewrk
             BINARY SEARCH.

    IF sy-subrc = 0.
      MOVE gt_crhd-arbpl TO: gt_taskl_oper-arbpl.
    ENDIF.

*.. Get skills from tasklist
    CONCATENATE gt_mplan-plnty gt_mplan-plnnr gt_mplan-plnal INTO gv_objek.
    SELECT SINGLE cuobj INTO gv_cuobj
      FROM inob WHERE klart = '018'
                  AND obtab = 'PLKO'
                  AND objek = gv_objek.

    IF sy-subrc = 0.
      MOVE-CORRESPONDING gt_mplan TO gt_skills.
      gt_skills-class = 'ZAM_SKILLS'.
      gt_skills-atnam = gc_levels.

      SELECT SINGLE atwrt INTO gt_skills-atwrt
        FROM ausp WHERE objek = gv_cuobj
                    AND atinn = gv_atinn_levels.

      IF sy-subrc = 0.
        SELECT SINGLE atzhl INTO gv_atzhl
          FROM cawn WHERE atinn = gv_atinn_levels
                      AND atwrt = gt_skills-atwrt.

        IF sy-subrc = 0.
          SELECT SINGLE atwtb INTO gt_skills-atwtb
            FROM cawnt WHERE atinn = gv_atinn_levels
                         AND atzhl = gv_atzhl
                         AND spras = sy-langu.
          IF sy-subrc = 0.
            MOVE '|' TO: gt_skills-deli1, gt_skills-deli2, gt_skills-deli3,
                         gt_skills-deli4, gt_skills-deli5, gt_skills-deli6,
                         gt_skills-deli7.
            APPEND gt_skills.
            CLEAR gt_skills.
          ENDIF.
        ENDIF.
      ENDIF.

      SELECT atwrt INTO gt_skills-atwrt
        FROM ausp WHERE objek = gv_cuobj
                    AND atinn = gv_atinn_skills.

        IF sy-subrc = 0.
          SELECT SINGLE atzhl INTO gv_atzhl
            FROM cawn WHERE atinn = gv_atinn_skills
                        AND atwrt = gt_skills-atwrt.

          IF sy-subrc = 0.
            SELECT SINGLE atwtb INTO gt_skills-atwtb
              FROM cawnt WHERE atinn = gv_atinn_skills
                           AND atzhl = gv_atzhl
                           AND spras = sy-langu.

            IF sy-subrc = 0.
              MOVE-CORRESPONDING gt_mplan TO gt_skills.
              gt_skills-class = 'ZAM_SKILLS'.
              gt_skills-atnam = gc_skills.
              MOVE '|' TO: gt_skills-deli1, gt_skills-deli2, gt_skills-deli3,
                           gt_skills-deli4, gt_skills-deli5, gt_skills-deli6,
                           gt_skills-deli7.
              APPEND gt_skills.
              CLEAR gt_skills.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDSELECT.
    ENDIF.

*.. Extra action on operations
    IF NOT gt_plpo[] IS INITIAL.
      SORT gt_plpo BY plnty plnnr plnkn zaehl.
      CLEAR: gv_kzyk1, gv_save_werks.

      LOOP AT gt_plpo.
        MOVE gt_plpo-werks TO gv_save_werks.

        AT FIRST.
          CLEAR: gv_dist, gv_hrs, gv_allow, gv_subcontr.

*........ Only for GMIX: read Variant table for Central task lists
          IF gv_save_werks = gc_gmix.
            READ TABLE gt_basic_data WITH KEY mandt = sy-mandt
                                              vtnam = gc_z_vc_table.

            IF sy-subrc = 0.
              READ TABLE gt_value_c WITH KEY mandt = sy-mandt
                                             vtint = gt_basic_data-vtint
                                             atinn = gv_atinn_country
*                                             valc  = gv_comp.
                                             valc = p_bukrs.
              IF sy-subrc = 0.
*.............. Get km
                READ TABLE gt_value_n WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_km.
                IF sy-subrc = 0.
                  ADD gt_value_n-val_from TO gv_dist.
                ENDIF.
*.............. Get extra labour
                READ TABLE gt_value_n WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_exlab.
                IF sy-subrc = 0.
                  ADD gt_value_n-val_from TO gv_hrs.
                ENDIF.
*.............. Get allowance indicator
                READ TABLE gt_value_c WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_allow.
                IF sy-subrc = 0.
                  gv_allow = gt_value_c-valc.
                ENDIF.
*.............. Get subcontracting indicator
                READ TABLE gt_value_c WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_subcontr.
                IF sy-subrc = 0.
                  gv_subcontr = gt_value_c-valc.
                ENDIF.
*.............. Get VisiTour indicator
                READ TABLE gt_value_c WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_visitour.
                IF sy-subrc = 0.
                  gv_visitour = gt_value_c-valc.
                ENDIF.
*.............. Get Oil Included indicator
                READ TABLE gt_value_c WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_oil.
                IF sy-subrc = 0.
                  gv_oil = gt_value_c-valc.
                ENDIF.
*>>> Begin insert MOD-001
*.............. Get Cooltype indicator
                READ TABLE gt_value_c WITH KEY mandt = sy-mandt
                                               vtint = gt_basic_data-vtint
                                               slnid = gt_value_c-slnid
                                               atinn = gv_atinn_cooltype.
                IF sy-subrc = 0.
                  gv_cooltype = gt_value_c-valc.
                ENDIF.
*<<< End insert MOD-001
              ENDIF.
            ENDIF.
          ENDIF.

*........ Get maintenance pack
          SELECT SINGLE paket INTO gv_paket
              FROM plwp WHERE plnty = gt_mplan-plnty
                          AND plnnr = gt_mplan-plnnr
                          AND plnal = gt_mplan-plnal
                          AND strat = gt_mplan-strat
                          AND loekz = ' '.

          IF sy-subrc = 0.
            SELECT SINGLE kzyk1 INTO gv_kzyk1
                FROM t351x WHERE strat = gt_mplan-strat
                             AND spras = sy-langu
                             AND paket = gv_paket.
          ENDIF.

*........ Internal objectnr. from equipment
          CLEAR gv_cuobj.
          SELECT SINGLE cuobj INTO gv_cuobj
            FROM equi WHERE equnr = gt_mplan-equnr.

* Only for General Task List.
          IF gt_mplan-plnty = 'A'.
*........ Get values
*          REFRESH gt_values.
            REFRESH gt_config.
*          CALL FUNCTION 'CUCB_GET_VALUES_FROM_INSTANCE'
*            EXPORTING
*              iv_instance      = gv_cuobj
*            IMPORTING
*              et_values        = gt_values
*            EXCEPTIONS
*              invalid_instance = 1
*              OTHERS           = 2.
            CALL FUNCTION 'VC_I_GET_CONFIGURATION'
              EXPORTING
                instance                    = gv_cuobj
*             BUSINESS_OBJECT             =
*             LANGUAGE                    = SY-LANGU
*             PRINT_SALES                 = ' '
*             PRINT_PURCHASE              = ' '
*             PRINT_ENGINEERING           = ' '
*             IDOC_MODE                   = ' '
*             ANW_SICHT                   = ' '
*             EXCL_IND                    = ' '
*             IV_INVALID_POSSIBLE         = ' '
*             IV_MAX_MASSPROCESSING       = 0
*             IV_EXPLICIT_ORGAREA         = ' '
*             IV_NO_DESCRIPTION           = ' '
*             IV_USER                     = ' '
*             IV_NO_VALUE_CHECK           = 'X'
*             IV_NO_DIALOG                = ' '
*             IV_DISPLAY_WARNING          = ' '
              TABLES
                configuration               = gt_config
*             CONFIGURATION_IDOC          =
             EXCEPTIONS
               instance_not_found          = 1
               internal_error              = 2
               no_class_allocation         = 3
               instance_not_valid          = 4
               OTHERS                      = 5
                      .
            IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
            ENDIF.

***
*          LOOP AT gt_values INTO gs_values.
*            IF gs_values-atflv < 0.
*              gs_values-atflv = abs( gs_values-atflv ).
*              MODIFY gt_values FROM gs_values TRANSPORTING atflv.
*            ENDIF.
*          ENDLOOP.
          ELSE.
            CLEAR gt_config[].
          ENDIF.
***
          IF NOT gv_kzyk1 IS INITIAL.
            CONCATENATE 'CH_TL_EXTRA_LABOUR' gv_kzyk1 INTO gv_char.

*.......... Get internal characteristic
            CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
              EXPORTING
                input  = gv_char
              IMPORTING
                output = gv_atinn_exlabvis.
          ENDIF.

          CLEAR: gv_hrs_vis, gv_hrs_eq, gv_dist_eq, gv_oil_eq, gv_cooltype_eq.  "MOD-001: added gv_cooltype_eq

*          LOOP AT gt_values ASSIGNING <gs_value>.
          LOOP AT gt_config INTO gs_config.
            IF NOT gv_kzyk1 IS INITIAL.
              IF gs_config-atinn = gv_atinn_exlabvis.
                gv_hrs_vis_c = gs_config-atwrt.
                REPLACE ALL OCCURRENCES OF ',' IN gv_hrs_vis_c WITH '.'.
                MOVE gv_hrs_vis_c TO gv_hrs_vis.
              ENDIF.
            ENDIF.
            IF gs_config-atinn = gv_atinn_exlab.
              gv_hrs_eq_c = gs_config-atwrt.
              REPLACE ALL OCCURRENCES OF ',' IN gv_hrs_eq_c WITH '.'.
              MOVE gv_hrs_eq_c TO gv_hrs_eq.
*              REPLACE ALL OCCURRENCES OF ',' IN gs_config-atwrt WITH ''.
*              REPLACE ALL OCCURRENCES OF '.' IN gs_config-atwrt WITH ''.
*              CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*                EXPORTING
*                  input  = gs_config-atwrt
*                IMPORTING
*                  output = gv_hrs_eq_c.
*              move gv_hrs_eq_c to gv_hrs_eq.
            ENDIF.
            IF gs_config-atinn = gv_atinn_km.
*              REPLACE ALL OCCURRENCES OF ',' IN gs_config-atwrt WITH ''.
*              REPLACE ALL OCCURRENCES OF '.' IN gs_config-atwrt WITH ''.
*              CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*                EXPORTING
*                  input  = gs_config-atwrt
*                IMPORTING
*                  output = gv_dist_eq_c.
*              move gv_dist_eq_c to gv_dist_eq.
              gv_dist_eq_c = gs_config-atwrt.
              REPLACE ALL OCCURRENCES OF ',' IN gv_dist_eq_c WITH '.'.
              MOVE gv_dist_eq_c TO gv_dist_eq.
            ENDIF.
            IF gs_config-atinn = gv_atinn_oil.
              WRITE gs_config-atwrt TO gv_atinn_oil.
            ENDIF.
            IF gs_config-atinn = gv_atinn_cooltype.  "MOD-001+
              WRITE gs_config-atwrt TO gv_cooltype_eq.      "MOD-001+
            ENDIF.                                    "MOD-001+
          ENDLOOP.
        ENDAT.

        MOVE-CORRESPONDING gt_plpo TO gt_taskl_oper.
        MOVE gv_kzyk1 TO gt_taskl_oper-kzyk1.

*...... Select workcenter
        SELECT SINGLE arbpl INTO gt_taskl_oper-arbpl_t
          FROM crhd WHERE objty = 'A'
                      AND objid = gt_plpo-arbid.

        IF gt_plpo-plnty NE 'E'.  "MOD-005+
          IF gt_plpo-steus = gc_zco3.          " Labour
            IF NOT gv_hrs_vis IS INITIAL.
              gt_taskl_oper-arbei = gt_taskl_oper-arbei + gv_hrs_vis.
            ENDIF.
            IF gv_visitour = 'N'.
              IF gv_hrs_eq IS INITIAL.
                gt_taskl_oper-arbei = gt_taskl_oper-arbei + gv_hrs.
              ELSE.
                gt_taskl_oper-arbei = gt_taskl_oper-arbei + gv_hrs_eq.
              ENDIF.
            ENDIF.
          ENDIF.

          IF gt_plpo-larnt = gc_zam010.        " Travel distance
            IF gv_dist_eq IS INITIAL.
              gt_taskl_oper-arbei = gt_taskl_oper-arbei + gv_dist.
            ELSE.
              gt_taskl_oper-arbei = gt_taskl_oper-arbei + gv_dist_eq.
            ENDIF.
          ENDIF.


        IF gt_plpo-larnt = gc_zam019.        " Subcontracting
          IF gv_subcontr = 'N'.
            CONTINUE.
          ENDIF.
        ENDIF.

        IF gt_plpo-larnt = gc_zam026.        " Allowance
          IF gv_allow = 'N'.
            CONTINUE.
          ENDIF.
        ENDIF.

        IF gt_plpo-larnt = gc_zam025.        " Travel time
          IF gv_visitour = 'N'.
            CONTINUE.
          ELSE.
            IF gv_hrs_eq IS INITIAL.
              gt_taskl_oper-arbei = 0 + gv_hrs.
            ELSE.
              gt_taskl_oper-arbei = 0 + gv_hrs_eq.
            ENDIF.
          ENDIF.
        ENDIF.

        IF gt_plpo-ktsch = gc_tl9080.        " Oil included
          IF gv_oil_eq = 'N'.
            CONTINUE.
          ENDIF.
          IF gv_oil = 'N' AND gv_oil_eq IS INITIAL.
            CONTINUE.
          ENDIF.
*>>> Begin insert MOD-001
        ELSEIF gt_plpo-ktsch = gc_tl9081.
          IF gv_oil_eq = 'N'.
            CONTINUE.
          ENDIF.
          IF gv_oil = 'N' AND gv_oil_eq IS INITIAL.
            CONTINUE.
          ENDIF.
          IF ( gv_cooltype_eq IS NOT INITIAL AND gv_cooltype_eq NE 'A' ) OR
             ( gv_cooltype_eq IS INITIAL AND gv_cooltype NE 'A' ).
            CONTINUE.
          ENDIF.
        ELSEIF gt_plpo-ktsch = gc_tl9082.
          IF gv_oil_eq = 'N'.
            CONTINUE.
          ENDIF.
          IF gv_oil = 'N' AND gv_oil_eq IS INITIAL.
            CONTINUE.
          ENDIF.
          IF ( gv_cooltype_eq IS NOT INITIAL AND gv_cooltype_eq NE 'W' ) OR
             ( gv_cooltype_eq IS INITIAL AND gv_cooltype NE 'W' ).
            CONTINUE.
          ENDIF.
*<<< End insert MOD-001
        ENDIF.
        ENDIF.  "gt_plpo-plnty NE 'E'     "MOD-005+
*...... Special case (from earlier times perhaps)
        IF gt_plpo-steus = space.
          gt_taskl_oper-steus = 'ZCO4'.
        ENDIF.

*       Retrieve Key date
        SELECT SINGLE datuv INTO gt_taskl_oper-datuv
             FROM plko
          WHERE plnty = gt_plpo-plnty AND plnnr = gt_plpo-plnnr AND plnal = gt_mplan-plnal.

* Retrieve Annual Estimate


        CLEAR: lv_mpobj, lv_atinn, lv_pyear, lv_mrngu, lv_pyear_i.
        SELECT SINGLE atinn INTO lv_atinn
            FROM cabn
            WHERE atnam = c_char.

        CONCATENATE 'IE' gt_taskl_oper-equnr INTO lv_mpobj.

        SELECT SINGLE pyear mrngu INTO (lv_pyear, lv_mrngu)
            FROM imptt
            WHERE atinn = lv_atinn
              AND psort IN ('015')
              AND mpobj = lv_mpobj.

        IF sy-subrc = 0.
*--------------------------------------------------------------*
* UNIT_CONVERSION_SIMPLE WILL CONVERT THE PYEAR INTO THE UNIT  *
* INDICATED IN IMPTT-MRNGU                                     *
*--------------------------------------------------------------*
          CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
            EXPORTING
              input    = lv_pyear
              unit_out = lv_mrngu
            IMPORTING
              output   = lv_pyear.

          lv_pyear_i  = lv_pyear.
          gt_taskl_oper-pyear = lv_pyear_i.
        ENDIF.
***

        CLEAR: lv_spras, lv_kunnr, lv_objnr.
        CLEAR: gt_taskl_oper-comlng, gt_taskl_oper-txtlng, gt_taskl_oper-equsol.

        CONCATENATE 'IE' gt_mplan-equnr INTO lv_objnr.

        SELECT SINGLE parnr FROM ihpa INTO lv_kunnr
          WHERE objnr = lv_objnr AND
                parvw = 'AG' AND
                kzloesch <> 'X'.
        IF sy-subrc = 0.

          SELECT SINGLE spras
                 FROM kna1 INTO (lv_spras )
          WHERE kunnr = lv_kunnr.

          l_name = gt_plpo-ktsch.


          CLEAR lt_lines[].
          CALL FUNCTION 'READ_TEXT'
            EXPORTING
              id                      = 'SUBM'
              object                  = 'WORKST'
              name                    = l_name
              language                = lv_spras
            TABLES
              lines                   = lt_lines
            EXCEPTIONS
              id                      = 1
              language                = 2
              name                    = 3
              not_found               = 4
              object                  = 5
              reference_check         = 6
              wrong_access_to_archive = 7
              OTHERS                  = 8.

          IF sy-subrc EQ 0 AND lt_lines[] IS NOT INITIAL.

            READ TABLE lt_lines INTO lw_lines INDEX 1.

            IF sy-subrc EQ 0.
              gt_taskl_oper-equsol = lv_kunnr.

              CALL FUNCTION 'CONVERSION_EXIT_ISOLA_OUTPUT'
                EXPORTING
                  input  = lv_spras
                IMPORTING
                  output = lv_spras2.
              gt_taskl_oper-comlng = lv_spras2.
              gt_taskl_oper-txtlng = lw_lines-tdline.
            ENDIF.
          ENDIF.


        ENDIF.


***

        MOVE '|' TO: gt_taskl_oper-deli1, gt_taskl_oper-deli2, gt_taskl_oper-deli3,
                     gt_taskl_oper-deli4, gt_taskl_oper-deli5, gt_taskl_oper-deli6,
                     gt_taskl_oper-deli7, gt_taskl_oper-deli8, gt_taskl_oper-deli9,
                     gt_taskl_oper-deli10, gt_taskl_oper-deli11, gt_taskl_oper-deli12,
                     gt_taskl_oper-deli13, gt_taskl_oper-deli14, gt_taskl_oper-deli15,
                     gt_taskl_oper-deli16, gt_taskl_oper-deli17, gt_taskl_oper-deli18,
                     gt_taskl_oper-deli19, gt_taskl_oper-deli20, gt_taskl_oper-deli21,
                     gt_taskl_oper-deli22, gt_taskl_oper-deli23,
                     gt_taskl_oper-deli24, gt_taskl_oper-deli25, gt_taskl_oper-deli26, gt_taskl_oper-deli27,
                     gt_taskl_oper-deli28, gt_taskl_oper-deli29, gt_taskl_oper-deli30.

        APPEND gt_taskl_oper.

*...... Select spare parts
        IF gt_plpo-vornr = '0010' OR
           ( gt_plpo-vornr >= '0080' AND gt_plpo-vornr <= '0089' ).
          REFRESH: gt_plmz,
                   gt_stpo.

          SELECT plnty plnnr plnkn stlty stlnr stlkn imeng imein
                 INTO TABLE gt_plmz
                 FROM plmz
                 WHERE plnnr = gt_plpo-plnnr
                   AND plnty = gt_plpo-plnty
                   AND plnkn = gt_plpo-plnkn
                   AND loekz = space.

          IF NOT gt_plmz[] IS INITIAL.
            SELECT stlty stlnr stlkn idnrk
                   INTO TABLE gt_stpo
                   FROM stpo
                   FOR ALL ENTRIES IN gt_plmz
                   WHERE stlty = gt_plmz-stlty
                     AND stlnr = gt_plmz-stlnr
                     AND stlkn = gt_plmz-stlkn
                     AND lkenz = space.
          ENDIF.

          IF NOT gt_stpo[] IS INITIAL.
            SORT gt_stpo BY stlty stlnr stlkn.

            LOOP AT gt_plmz.
              CLEAR gt_stpo.
              READ TABLE gt_stpo WITH KEY stlty = gt_plmz-stlty
                                          stlnr = gt_plmz-stlnr
                                          stlkn = gt_plmz-stlkn.
              IF sy-subrc = 0.
                MOVE-CORRESPONDING gt_mplan TO gt_comp.
                MOVE-CORRESPONDING gt_plmz  TO gt_comp.
                MOVE gt_plpo-vornr TO gt_comp-vornr.
                MOVE gt_stpo-idnrk TO gt_comp-idnrk.

                CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
                  EXPORTING
                    input  = gt_comp-idnrk
                  IMPORTING
                    output = gt_comp-idnrk.

                SELECT SINGLE bismt FROM mara INTO gt_comp-bismt "MOD-004
                 WHERE matnr = gt_comp-idnrk.                    "MOD-004

                CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
                  EXPORTING
                    input  = gt_comp-idnrk
                  IMPORTING
                    output = gt_comp-idnrk.

                MOVE '|' TO: gt_comp-deli1, gt_comp-deli2, gt_comp-deli3,
                             gt_comp-deli4, gt_comp-deli5, gt_comp-deli6,
                             gt_comp-deli7,
                             gt_comp-deli8. "MOD-004

                APPEND gt_comp.
                CLEAR gt_comp.
              ENDIF.
            ENDLOOP.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDLOOP.

*>>> Begin replace MOD-002
*  gt_mplan2[] = gt_mplan[].
  REFRESH gt_mplan2.
  LOOP AT gt_mplan.
    MOVE-CORRESPONDING gt_mplan TO gt_mplan2.
    APPEND gt_mplan2.
  ENDLOOP.
*<<< End replace MOD-002
* Maintenance plan header
  DELETE ADJACENT DUPLICATES FROM gt_mplan2 COMPARING warpl.

  LOOP AT gt_mplan2.
    CLEAR gs_mplanh.

    SELECT SINGLE * INTO CORRESPONDING FIELDS OF  gs_mplanh
      FROM mpla
      WHERE warpl = gt_mplan2-warpl.

    CLEAR lv_sfakt.
    SELECT SINGLE sfakt INTO lv_sfakt
       FROM mpla
       WHERE warpl = gt_mplan2-warpl.
    IF sy-subrc = 0.
      gs_mplanh-sfakt2 = lv_sfakt.
    ENDIF.

    CLEAR lv_hunit.
    SELECT SINGLE hunit INTO lv_hunit
       FROM mpla
       WHERE warpl = gt_mplan2-warpl.
    IF sy-subrc = 0.
      CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
        EXPORTING
          input          = lv_hunit
          language       = sy-langu
        IMPORTING
          output         = gs_mplanh-hunit2
        EXCEPTIONS
          unit_not_found = 1
          OTHERS         = 2.
    ENDIF.
    MOVE-CORRESPONDING gt_mplan2 TO gs_mplanh.
    MOVE '|' TO: gs_mplanh-deli1, gs_mplanh-deli2, gs_mplanh-deli3,
                 gs_mplanh-deli4, gs_mplanh-deli5, gs_mplanh-deli6,
                 gs_mplanh-deli7, gs_mplanh-deli8, gs_mplanh-deli9,
                 gs_mplanh-deli10, gs_mplanh-deli11, gs_mplanh-deli12,
                 gs_mplanh-deli13, gs_mplanh-deli14, gs_mplanh-deli15,
                 gs_mplanh-deli16, gs_mplanh-deli17, gs_mplanh-deli18,  "MOD-002+
                 gs_mplanh-deli19, gs_mplanh-deli20, gs_mplanh-deli21,  "MOD-002+
                 gs_mplanh-deli22. "MOD-004

*>>> Begin insert MOD-002
    CASE gt_mplan2-stat.
      WHEN c_i0320.
        gs_mplanh-status = 'DLFL'.
      WHEN c_i0076.
        gs_mplanh-status = 'INAC'.
      WHEN OTHERS.
        gs_mplanh-status = 'ACTIVE'.
*       Future visit plan
        "read the mp scheduling:
        SELECT a~warpl a~abnum a~nplda a~terma a~zaehl b~addat
          INTO CORRESPONDING FIELDS OF TABLE i_schedule
          FROM mhis AS a
          LEFT OUTER JOIN mhio AS b ON a~warpl = b~warpl AND
                                  a~abnum = b~abnum
          WHERE                   a~warpl = gs_mplanh-warpl AND
                                  a~terma <> 'M' AND
                                  a~tstat <> 'X'. "not skipped
        "Delete closed calls
        DELETE i_schedule WHERE addat > 0.
        "to make sure it is not initial when writing...
        IF i_schedule IS NOT INITIAL.
          SORT i_schedule BY warpl abnum.
        ENDIF.
        "Loop over the maintenance plan schedule
        CLEAR lv_future_visits.
        LOOP AT i_schedule.
          "translate package to short text
          SELECT SINGLE strat FROM mpla INTO lv_strategy WHERE
                          warpl EQ gs_mplanh-warpl.
          IF sy-subrc = 0.
            SELECT SINGLE kzyk1 FROM t351x INTO lv_package WHERE
                          spras = 'EN' AND
                          strat = gs_mplanh-strat AND
                          paket = i_schedule-zaehl.
            IF sy-subrc <> 0.
              lv_package = i_schedule-zaehl.
            ENDIF.
          ENDIF.
          "build the visit string
          CONCATENATE lv_future_visits lv_package INTO lv_future_visits.
        ENDLOOP.
        gs_mplanh-future_v = lv_future_visits.

    ENDCASE.

    CLEAR: lv_visit_index.
    PERFORM get_mp_details
      USING gs_mplanh-warpl
      CHANGING lv_visit_index lv_nplda gs_mplanh-packages gs_mplanh-ratio.
    gs_mplanh-visit_index = lv_visit_index.
    WRITE lv_nplda TO gs_mplanh-nplda2.
*<<< End insert MOD-002
    APPEND gs_mplanh TO gt_mplanh.
  ENDLOOP.

  LOOP AT gt_mplanh.
    lv_index = sy-tabix.
    SELECT SINGLE atinn INTO lv_atinn
      FROM cabn
      WHERE atnam =  c_char.

    SELECT SINGLE point INTO lv1_point
        FROM mmpt
        WHERE warpl = gt_mplanh-warpl.

    IF sy-subrc = 0.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = lv1_point
        IMPORTING
          output = lv1_point.
      gt_mplanh-point = lv1_point.
    ENDIF.

    MODIFY gt_mplanh INDEX lv_index TRANSPORTING point.
  ENDLOOP.

*  DELETE gt_mplan WHERE stat EQ c_i0320 OR stat EQ c_i0076. "MOD-002+

* Maintenance plan schedule

*>>> Begin replace MOD-001
*  LOOP AT gt_mplan.
**   Visits scheduled
*    SELECT *  APPENDING CORRESPONDING FIELDS
*      OF TABLE gt_mhis2 FROM mhio AS o JOIN mhis AS s
*      ON  s~warpl = o~warpl AND  s~abnum = o~abnum
*    WHERE o~warpl = gt_mplan-warpl AND
*          o~wppos = gt_mplan-wapos.
*
*  ENDLOOP.
  IF gt_mplan[] IS NOT INITIAL.
    SELECT * APPENDING CORRESPONDING FIELDS OF TABLE gt_mhis2
      FROM mhio AS mhio
      INNER JOIN mhis AS mhis
        ON mhis~warpl EQ mhio~warpl AND
           mhis~abnum EQ mhio~abnum
      INNER JOIN mpos AS mpos
        ON mpos~wapos EQ mhio~wppos
      FOR ALL ENTRIES IN gt_mplan
      WHERE mhio~warpl = gt_mplan-warpl AND
            mhio~wppos = gt_mplan-wapos.
  ENDIF.
*<<< End replace MOD-001

  LOOP AT gt_mhis2.
    lv_index = sy-tabix.
    MOVE-CORRESPONDING gt_mhis2 TO gs_mhis.

    SELECT SINGLE strat FROM mpla INTO gs_mhis-strat
      WHERE warpl = gt_mhis2-warpl.
    gs_mhis-abnum2 = gt_mhis2-abnum.
    gs_mhis-zykzt2 = gt_mhis2-zykzt.
    gs_mhis-offle2 = gt_mhis2-offle.
    gs_mhis-offze2 = gt_mhis2-offze.
    gs_mhis-offzo2 = gt_mhis2-offzo.

    MOVE '|' TO: gs_mhis-deli1, gs_mhis-deli2, gs_mhis-deli3,
                 gs_mhis-deli4, gs_mhis-deli5, gs_mhis-deli6,
                 gs_mhis-deli7, gs_mhis-deli8, gs_mhis-deli9,
                 gs_mhis-deli10, gs_mhis-deli11, gs_mhis-deli12,
                 gs_mhis-deli13, gs_mhis-deli14, gs_mhis-deli15, gs_mhis-deli16,
                 gs_mhis-deli17,  "MOD-001+
                 gs_mhis-deli18, gs_mhis-deli19, gs_mhis-deli20.  "MOD-002+
    APPEND gs_mhis TO gt_mhis.
  ENDLOOP.

  LOOP AT gt_mhis.
    lv_index = sy-tabix.
    SELECT SINGLE kzyk1 INTO gt_mhis-dpack
        FROM t351x WHERE spras = sy-langu
                     AND strat = gt_mhis-strat
                     AND paket = gt_mhis-zaehl.
    IF sy-subrc = 0.
      MODIFY gt_mhis INDEX lv_index TRANSPORTING dpack.
    ENDIF.
  ENDLOOP.

*  LOOP AT gt_mhis ASSIGNING <ls_mhis>.
*    PERFORM get_mp_details
*      USING gs_mplanh-warpl ' '
*      CHANGING lv_visit_index <ls_mhis>-nplda2 <ls_mhis>-packages <ls_mhis>-ratio. "TODO!!!
*  ENDLOOP.

  LOOP AT gt_plko.
    MOVE-CORRESPONDING gt_plko TO gs_tasklh.

    READ TABLE gt_crhd WITH KEY objid = gt_plko-arbid
             BINARY SEARCH.

    IF sy-subrc = 0.
      MOVE gt_crhd-arbpl TO gs_tasklh-arbpl.
    ENDIF.

    MOVE '|' TO: gs_tasklh-deli1, gs_tasklh-deli2, gs_tasklh-deli3,
                 gs_tasklh-deli4, gs_tasklh-deli5, gs_tasklh-deli6,
                 gs_tasklh-deli7, gs_tasklh-deli8.
    APPEND gs_tasklh TO gt_tasklh.

  ENDLOOP.

  IF NOT gt_taskl_oper[] IS INITIAL.
    PERFORM download_files.
  ENDIF.

*&---------------------------------------------------------------------*
*&      Form  download_files
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_files.

  DATA: file TYPE string.
  DATA: lv_selections TYPE string.

  lv_selections = p_bukrs.
  IF p_iwerk IS NOT INITIAL.
    CONCATENATE lv_selections p_iwerk INTO lv_selections SEPARATED BY '_'.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_selections p_vkorg INTO lv_selections SEPARATED BY '_'.
  ENDIF.


  PERFORM header_fill.

  IF sy-batch = 'X'.
    REPLACE 'xxx' IN g_directory WITH p_logsys(3).

*   MP_taskl_oper
*    CONCATENATE g_directory c_rec_t '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_t '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_taskl_oper_c.
      TRANSFER gt_taskl_oper_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_taskl_oper.
      TRANSFER gt_taskl_oper TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
* Begin of insert MOD-003
    CONCATENATE g_directory c_rec_it '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT  gt_mplan_item_c.
      TRANSFER gt_mplan_item_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_mplan_item.
      TRANSFER gt_mplan_item TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
* End of insert MOD-003
***

*   Components
*    CONCATENATE g_directory c_rec_c '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_c '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_comp_c.
      TRANSFER gt_comp_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_comp.
      TRANSFER gt_comp TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

*   Skills
*    CONCATENATE g_directory c_rec_s '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_s '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_skills_c.
      TRANSFER gt_skills_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_skills.
      TRANSFER gt_skills TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

*   MP Header
*    CONCATENATE g_directory c_rec_mh '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_mh '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_mplanh_c.
      TRANSFER gt_mplanh_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_mplanh.
      TRANSFER gt_mplanh TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

*   MP Schedule
*    CONCATENATE g_directory c_rec_ms '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_ms '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_mhis_c.
      TRANSFER gt_mhis_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_mhis.
      TRANSFER gt_mhis TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

*   Tasklist Header
*    CONCATENATE g_directory c_rec_th '_' p_iwerk '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_th '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_tasklh_c.
      TRANSFER gt_tasklh_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_tasklh.
      TRANSFER gt_tasklh TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

  ELSE.
    file = p_filet.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_taskl_oper_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_taskl_oper
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
*
    file = p_filec.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_comp_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_comp
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
*
    file = p_files.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_skills_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_skills
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
*
***
* Begin of insert MOD-003
    file = p_filemi.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_mplan_item_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_mplan_item
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
* End of insert MOD-003
***

    file = p_filemh.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_mplanh_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_mplanh
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
*
    file = p_filems.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_mhis_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_mhis
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
*
    file = p_fileth.
*    CONCATENATE file '_' p_iwerk '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_tasklh_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_tasklh
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
  ENDIF.

ENDFORM.                    "download_file

*&---------------------------------------------------------------------*
*&      Form  header_fill
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM header_fill.

  MOVE '|' TO: gt_taskl_oper_c-deli1, gt_taskl_oper_c-deli2, gt_taskl_oper_c-deli3,
               gt_taskl_oper_c-deli4, gt_taskl_oper_c-deli5, gt_taskl_oper_c-deli6,
               gt_taskl_oper_c-deli7, gt_taskl_oper_c-deli8, gt_taskl_oper_c-deli9,
               gt_taskl_oper_c-deli10, gt_taskl_oper_c-deli11, gt_taskl_oper_c-deli12,
               gt_taskl_oper_c-deli13, gt_taskl_oper_c-deli14, gt_taskl_oper_c-deli15,
               gt_taskl_oper_c-deli16, gt_taskl_oper_c-deli17, gt_taskl_oper_c-deli18,
               gt_taskl_oper_c-deli19, gt_taskl_oper_c-deli20, gt_taskl_oper_c-deli21,
               gt_taskl_oper_c-deli22, gt_taskl_oper_c-deli23,
               gt_taskl_oper_c-deli24, gt_taskl_oper_c-deli25, gt_taskl_oper_c-deli26,
               gt_taskl_oper_c-deli27, gt_taskl_oper_c-deli28, gt_taskl_oper_c-deli29,
               gt_taskl_oper_c-deli30.

  gt_taskl_oper_c-warpl = 'WARPL'.
  gt_taskl_oper_c-wapos = 'WAPOS'.
  gt_taskl_oper_c-pstxt = 'PSTXT'.
  gt_taskl_oper_c-plnnr = 'PLNNR'.
  gt_taskl_oper_c-plnal = 'PLNAL'.
  gt_taskl_oper_c-equnr = 'EQUNR'.
  gt_taskl_oper_c-arbpl = 'ARBPL'.
  gt_taskl_oper_c-iwerk = 'IWERK'.
  gt_taskl_oper_c-kdauf = 'KDAUF'.
  gt_taskl_oper_c-kdpos = 'KDPOS'.
  gt_taskl_oper_c-strat = 'STRAT'.
  gt_taskl_oper_c-kzyk1 = 'KZYK1'.
  gt_taskl_oper_c-plnkn = 'PLNKN'.
  gt_taskl_oper_c-vornr = 'VORNR'.
  gt_taskl_oper_c-steus = 'STEUS'.
  gt_taskl_oper_c-larnt = 'LARNT'.
  gt_taskl_oper_c-arbei = 'ARBEI'.
  gt_taskl_oper_c-arbeh = 'ARBEH'.
  gt_taskl_oper_c-werks  = 'WERKS'.
  gt_taskl_oper_c-arbpl_t = 'ARBPL_T'.
  gt_taskl_oper_c-ktsch  = 'KTSCH'.
  gt_taskl_oper_c-ltxa1  = 'LTXA1'.
  gt_taskl_oper_c-equsol = 'EQUNR_SOL'.
  gt_taskl_oper_c-comlng  = 'LANGU'.
  gt_taskl_oper_c-txtlng  = 'TXT_COM_LNG'.
  gt_taskl_oper_c-wpgrp  = 'WPGRP'.
  gt_taskl_oper_c-datuv  = 'DATUV'.
  gt_taskl_oper_c-qmart  = 'QMART'.
  gt_taskl_oper_c-priok  = 'PRIOK'.
  gt_taskl_oper_c-task_determine = 'TASK_DETERMINE'.
  gt_taskl_oper_c-pyear = 'PYEAR'.
  APPEND gt_taskl_oper_c.  "MOD-001-

  gt_taskl_oper_c-warpl = 'Maint. Plan'.
  gt_taskl_oper_c-wapos = 'Item'.
  gt_taskl_oper_c-pstxt = 'Short Text'.
  gt_taskl_oper_c-plnnr = 'Task List'.
  gt_taskl_oper_c-plnal = 'Countr'.
  gt_taskl_oper_c-equnr = 'Equipment'.
  gt_taskl_oper_c-arbpl = 'Work Ctr'.
  gt_taskl_oper_c-iwerk = 'Plann. Plant'.
  gt_taskl_oper_c-kdauf = 'Sales Order'.
  gt_taskl_oper_c-kdpos = 'SO Item'.
  gt_taskl_oper_c-strat = 'Strategy'.
  gt_taskl_oper_c-kzyk1 = 'Cycle'.
  gt_taskl_oper_c-plnkn = 'TL Node'.
  gt_taskl_oper_c-vornr = 'Oper.'.
  gt_taskl_oper_c-steus = 'Control'.
  gt_taskl_oper_c-larnt = 'Act. Type'.
  gt_taskl_oper_c-arbei = 'Work'.
  gt_taskl_oper_c-arbeh = 'UoM'.
  gt_taskl_oper_c-werks = 'Plant'.
  gt_taskl_oper_c-arbpl_t = 'Work Ctr Tasklist'.
  gt_taskl_oper_c-ktsch = 'Text Key'.
  gt_taskl_oper_c-ltxa1 = 'Oper. Short Text'.
  gt_taskl_oper_c-equsol = 'Equipment Soldto'.
  gt_taskl_oper_c-comlng = 'Communication Language'.
  gt_taskl_oper_c-txtlng = 'Text for communication language'.
  gt_taskl_oper_c-wpgrp = 'Planner Grp'.
  gt_taskl_oper_c-datuv = 'Valid-From'.
  gt_taskl_oper_c-qmart = 'Notif. Type'.
  gt_taskl_oper_c-priok = 'Priority'.
  gt_taskl_oper_c-task_determine = 'Task Determ.'.
  gt_taskl_oper_c-pyear = 'Annual Estimate'.
*  APPEND gt_taskl_oper_c.  "MOD-001-

  MOVE '|' TO: gt_comp_c-deli1, gt_comp_c-deli2, gt_comp_c-deli3,
               gt_comp_c-deli4, gt_comp_c-deli5, gt_comp_c-deli6,
               gt_comp_c-deli7,
               gt_comp_c-deli8. "MOd-004

  gt_comp_c-warpl = 'WARPL'.
  gt_comp_c-wapos = 'WAPOS'.
  gt_comp_c-plnnr = 'PLNNR'.
  gt_comp_c-plnal = 'PLNAL'.
  gt_comp_c-vornr = 'VORNR'.
  gt_comp_c-imeng = 'MENGE'.
  gt_comp_c-imein = 'MEINS'.
  gt_comp_c-idnrk = 'IDNRK'.
  gt_comp_c-bismt = 'BISMT'. "MOD-004
  APPEND gt_comp_c.

  gt_comp_c-warpl = 'Maint. Plan'.
  gt_comp_c-wapos = 'Item'.
  gt_comp_c-plnnr = 'Task List'.
  gt_comp_c-plnal = 'Countr'.
  gt_comp_c-vornr = 'Oper.'.
  gt_comp_c-imeng = 'Quantity'.
  gt_comp_c-imein = 'UoM'.
  gt_comp_c-idnrk = 'BOM component'.
  gt_comp_c-bismt = 'Old Material component'. "MOD-004
*  APPEND gt_comp_c.  "MOD-001-

  MOVE '|' TO: gt_skills_c-deli1, gt_skills_c-deli2, gt_skills_c-deli3,
               gt_skills_c-deli4, gt_skills_c-deli5, gt_skills_c-deli6,
               gt_skills_c-deli7.

  gt_skills_c-warpl = 'WARPL'.
  gt_skills_c-wapos = 'WAPOS'.
  gt_skills_c-plnnr = 'PLNNR'.
  gt_skills_c-plnal = 'PLNAL'.
  gt_skills_c-class = 'CLASS'.
  gt_skills_c-atnam = 'ATNAM'.
  gt_skills_c-atwrt = 'ATWRT'.
  gt_skills_c-atwtb = 'ATWTB'.
  APPEND gt_skills_c.

  gt_skills_c-warpl = 'Maint. Plan'.
  gt_skills_c-wapos = 'Item'.
  gt_skills_c-plnnr = 'Task List'.
  gt_skills_c-plnal = 'Countr'.
  gt_skills_c-class = 'Class'.
  gt_skills_c-atnam = 'Characteristic Name'.
  gt_skills_c-atwrt = 'Characteristic Value'.
  gt_skills_c-atwtb = 'Description'.
*  APPEND gt_skills_c.  "MOD-001-
* Begin of insert MOD-003
  MOVE '|' TO: gt_mplan_item_c-deli1, gt_mplan_item_c-deli2, gt_mplan_item_c-deli3,
               gt_mplan_item_c-deli4, gt_mplan_item_c-deli5, gt_mplan_item_c-deli6,
               gt_mplan_item_c-deli7, gt_mplan_item_c-deli8, gt_mplan_item_c-deli9,
               gt_mplan_item_c-deli10, gt_mplan_item_c-deli11, gt_mplan_item_c-deli12,
               gt_mplan_item_c-deli13, gt_mplan_item_c-deli14, gt_mplan_item_c-deli15,
               gt_mplan_item_c-deli16, gt_mplan_item_c-deli17.


  gt_mplan_item_c-warpl = 'WARPL'.
  gt_mplan_item_c-wapos = 'WAPOS'.
  gt_mplan_item_c-pstxt = 'PSTXT'.
  gt_mplan_item_c-equnr = 'EQUNR'.
  gt_mplan_item_c-matnr = 'MATNR'.
  gt_mplan_item_c-sernr = 'SERNR'.
  gt_mplan_item_c-kdauf = 'KDAUF'.
  gt_mplan_item_c-kdpos = 'KDPOS'.
  gt_mplan_item_c-vkorg = 'VKORG'.
  gt_mplan_item_c-vtweg = 'VTWEG'.
  gt_mplan_item_c-spart = 'SPART'.
  gt_mplan_item_c-qmart = 'QMART'.
  gt_mplan_item_c-iwerk = 'IWERK'.
  gt_mplan_item_c-wpgrp = 'WPGRP'.
  gt_mplan_item_c-gewrk = 'GEWRK'.
  gt_mplan_item_c-plnty = 'PLNTY'.
  gt_mplan_item_c-plnnr = 'PLNNR'.
  gt_mplan_item_c-plnal = 'PLNAL'.
  APPEND gt_mplan_item_c.

* End of insert MOD-003
  MOVE '|' TO: gt_mplanh_c-deli1, gt_mplanh_c-deli2, gt_mplanh_c-deli3,
               gt_mplanh_c-deli4, gt_mplanh_c-deli5, gt_mplanh_c-deli6,
               gt_mplanh_c-deli7, gt_mplanh_c-deli8, gt_mplanh_c-deli9,
               gt_mplanh_c-deli10, gt_mplanh_c-deli11, gt_mplanh_c-deli12,
               gt_mplanh_c-deli13, gt_mplanh_c-deli14, gt_mplanh_c-deli15,
               gt_mplanh_c-deli16, gt_mplanh_c-deli17, gt_mplanh_c-deli18,  "MOD-002+
               gt_mplanh_c-deli19, gt_mplanh_c-deli20, gt_mplanh_c-deli21,  "MOD-002+
               gt_mplanh_c-deli22. "MOD-004

  gt_mplanh_c-warpl = 'WARPL'.
  gt_mplanh_c-wptxt = 'WPTXT'.
  gt_mplanh_c-equnr = 'EQUNR'.
  gt_mplanh_c-point = 'POINT'.
  gt_mplanh_c-vspos = 'VSPOS'.
  gt_mplanh_c-topos = 'TOPOS'.
  gt_mplanh_c-vsneg = 'VSNEG'.
  gt_mplanh_c-toneg = 'TONEG'.
  gt_mplanh_c-sfakt = 'SFAKT'.
  gt_mplanh_c-horiz = 'HORIZ'.
  gt_mplanh_c-abrho = 'ABRHO'.
  gt_mplanh_c-hunit = 'HUNIT'.
  gt_mplanh_c-plan_sort = 'PLAN_SORT'.
  gt_mplanh_c-mptyp = 'MPTYP'.
  gt_mplanh_c-strat = 'STRAT'.
  gt_mplanh_c-stich = 'STICH'.
  gt_mplanh_c-status = 'STATUS'.      "MOD-002+
  gt_mplanh_c-future_v = 'FUTURE_V'.  "MOD-002+
  gt_mplanh_c-visit_index = 'VISIT_INDEX'. "MOD-002+
  gt_mplanh_c-nplda2  = 'NPLDA2'. "MOD-002+
  gt_mplanh_c-packages  = 'PACKAGES'. "MOD-002+
  gt_mplanh_c-ratio  = 'RATIO'. "MOD-002+
  gt_mplanh_c-bismt_equi  = 'BISMT_EQUI'. "MOD-004
  APPEND gt_mplanh_c.

  gt_mplanh_c-warpl = 'Maint. Plan'.
  gt_mplanh_c-wptxt = 'Maint. Plan Text'.
  gt_mplanh_c-equnr = 'Equipment'.
  gt_mplanh_c-point = 'Meas. Point'.
  gt_mplanh_c-vspos = 'Shift Late Compl.'.
  gt_mplanh_c-topos = 'Toler. LC'.
  gt_mplanh_c-vsneg = 'Shift Early Compl.'.
  gt_mplanh_c-toneg = 'Toler. EC'.
  gt_mplanh_c-sfakt = 'Cycle'.
  gt_mplanh_c-horiz = 'Call Horizon'.
  gt_mplanh_c-abrho = 'Sched. Per.'.
  gt_mplanh_c-hunit = 'UoM'.
  gt_mplanh_c-plan_sort = 'Sort Field'.
  gt_mplanh_c-mptyp = 'Cat.'.
  gt_mplanh_c-strat = 'Strategy'.
  gt_mplanh_c-stich = 'Sched.'.
  gt_mplanh_c-status = 'Status'.              "MOD-002+
  gt_mplanh_c-future_v = 'Future Visit plan'. "MOD-002+
  gt_mplanh_c-visit_index = 'Visit Index'. "MOD-002+
  gt_mplanh_c-nplda2  = 'Planned date'. "MOD-002+
  gt_mplanh_c-packages  = 'Packages'. "MOD-002+
  gt_mplanh_c-ratio  = 'Ratio'. "MOD-002+
  gt_mplanh_c-bismt_equi  = 'Old Material  Number Equipment'. "MOD-004
*  APPEND gt_mplanh_c.  "MOD-001-

  MOVE '|' TO: gt_mhis_c-deli1, gt_mhis_c-deli2, gt_mhis_c-deli3,
               gt_mhis_c-deli4, gt_mhis_c-deli5, gt_mhis_c-deli6,
               gt_mhis_c-deli7, gt_mhis_c-deli8, gt_mhis_c-deli9,
               gt_mhis_c-deli10, gt_mhis_c-deli11, gt_mhis_c-deli12,
               gt_mhis_c-deli13, gt_mhis_c-deli14, gt_mhis_c-deli15, gt_mhis_c-deli16,
               gt_mhis_c-deli17,  "MOD-001+
               gt_mhis_c-deli18, gt_mhis_c-deli19, gt_mhis_c-deli20.  "MOD-002+

  gt_mhis_c-warpl  = 'WARPL'.
  gt_mhis_c-wppos  = 'WPPOS'.
  gt_mhis_c-abnum2 = 'ABNUM'.
  gt_mhis_c-zaehl  = 'ZAEHL'.
  gt_mhis_c-ktex1  = 'KTEX1'.
  gt_mhis_c-strat  = 'STRAT'.
  gt_mhis_c-nplda  = 'NPLDA'.
*  gt_mhis_c-stdta  = 'STDTA'.
  gt_mhis_c-stadt  = 'STADT'.
  gt_mhis_c-dpack  = 'DPACK'.
  gt_mhis_c-terma  = 'TERMA'.
  gt_mhis_c-abrud  = 'ABRUD'.
  gt_mhis_c-lrmdt  = 'LRMDT'.
  gt_mhis_c-zykzt2 = 'ZYKZT2'.
  gt_mhis_c-offle2 = 'OFFLE'.
  gt_mhis_c-offze2 = 'OFFZE'.
  gt_mhis_c-offzo2 = 'OFFZO'.
  gt_mhis_c-tstat  = 'TSTAT'.
  gt_mhis_c-pstxt  = 'PSTXT'. "MOD-001+
  gt_mhis_c-equnr  = 'EQUNR'. "MOD-002+
  gt_mhis_c-kdauf  = 'KDAUF'. "MOD-002+
  gt_mhis_c-kdpos  = 'KDPOS'. "MOD-002+
  APPEND gt_mhis_c.

  gt_mhis_c-warpl  = 'Maint. Plan'.
  gt_mhis_c-wppos  = 'Item'.
  gt_mhis_c-abnum2 = 'MP Call No.'.
  gt_mhis_c-zaehl  = 'package'.
  gt_mhis_c-ktex1  = 'Package/Cycle'.
  gt_mhis_c-strat  = 'Strategy'.
  gt_mhis_c-nplda  = 'Planned Date'.
*  gt_mhis_c-stdta  = 'STDTA'.
  gt_mhis_c-stadt  = 'Start Date'.
  gt_mhis_c-dpack  = 'Cycle'.
  gt_mhis_c-terma  = 'Sched. Type'.
  gt_mhis_c-abrud  = 'Call Date'.
  gt_mhis_c-lrmdt  = 'Compl. Date'.
  gt_mhis_c-zykzt2 = 'Cycle/Offset'.
  gt_mhis_c-offle2 = 'Estim. Perform.'.
  gt_mhis_c-offze2 = 'Current Offset'.
  gt_mhis_c-offzo2 = 'Previous Offset'.
  gt_mhis_c-tstat  = 'Scheduling status'.
  gt_mhis_c-pstxt  = 'Item Short Text'. "MOD-001+
  gt_mhis_c-equnr  = 'Equipment Number'.    "MOD-002+
  gt_mhis_c-kdauf  = 'Sales Document'.      "MOD-002+
  gt_mhis_c-kdpos  = 'Sales Document Item'. "MOD-002+
*  APPEND gt_mhis_c.  "MOD-001-

  MOVE '|' TO: gt_tasklh_c-deli1, gt_tasklh_c-deli2, gt_tasklh_c-deli3,
               gt_tasklh_c-deli4, gt_tasklh_c-deli5, gt_tasklh_c-deli6,
               gt_tasklh_c-deli7, gt_tasklh_c-deli8.

  gt_tasklh_c-plnty = 'PLNTY'.
  gt_tasklh_c-plnnr = 'PLNNR'.
  gt_tasklh_c-plnal = 'PLNAL'.
  gt_tasklh_c-datuv = 'DATUV'.
  gt_tasklh_c-ktext = 'KTEXT'.
  gt_tasklh_c-arbpl = 'ARBPL'.
  gt_tasklh_c-vagrp = 'VAGRP'.
  gt_tasklh_c-anlzu = 'ANLZU'.
  gt_tasklh_c-strat = 'STRAT'.
  APPEND gt_tasklh_c.

  gt_tasklh_c-plnty = 'TL Type'.
  gt_tasklh_c-plnnr = 'Task List'.
  gt_tasklh_c-plnal = 'Countr'.
  gt_tasklh_c-datuv = 'Valid-From'.
  gt_tasklh_c-ktext = 'TL Description'.
  gt_tasklh_c-arbpl = 'Work Ctr'.
  gt_tasklh_c-vagrp = 'Respons.'.
  gt_tasklh_c-anlzu = 'Syst.Cond.'.
  gt_tasklh_c-strat = 'Strategy'.
*  APPEND gt_tasklh_c.  "MOD-001-

ENDFORM.                    "header_fill
*&---------------------------------------------------------------------*
*&      Form  GET_MP_DETAILS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GS_MPLANH_WARPL  text
*----------------------------------------------------------------------*
FORM get_mp_details  USING    uv_warpl    TYPE warpl
                     CHANGING cv_index    TYPE i
                              cv_nplda    TYPE nplda
                              cv_packages
                              cv_ratio.

* define internal tables
  TYPES: BEGIN OF t_schedule,
             warpl TYPE warpl,
             wppos TYPE wapos,
             abnum TYPE abnum,
             nplda TYPE nplda, "PlanDate
             terma TYPE terma, "Schedule Type
             offze TYPE offze, "Offset in current cycle
             zaehl TYPE paketzaehl, "Visit package
             addat TYPE datum, "completion date
             tsabr TYPE tsabr, "call object created flag
             tstat TYPE tstat, "call skipped
             adextstartdate TYPE datum, "plan startdate
             adoffset TYPE f. "start in cycle offset
  TYPES: END OF t_schedule.

  DATA: lt_schedule TYPE STANDARD TABLE OF t_schedule WITH HEADER LINE.
  DATA: lv_objnr(14) TYPE c.
  DATA: lv_inactive(1) TYPE c.
  DATA: lv_char_abnum(4) TYPE c.
  DATA: lv_char_offset(40) TYPE c.
  DATA: lv_plan_date(12) TYPE c.
  DATA: lv_strategy TYPE strat.
  DATA: lv_package(5) TYPE c.
  DATA: lv_warpl TYPE warpl,
        lv_cycle_length TYPE i.

  DATA: lo_mp_util TYPE REF TO ycl_mplan_utilities.

  DATA: lt_mpos  TYPE TABLE OF mpos,
        lt_plwp  TYPE TABLE OF plwp,
        lt_t351p TYPE TABLE OF t351p,
* Begin of insert MOd-003
        lt_t351p2 TYPE TABLE OF t351p,
* End of insert MOd-003
        lt_t351x TYPE TABLE OF t351x,
        lv_zykzt TYPE dzyk_zeit,
        lv_ratio TYPE p DECIMALS 2,
        lv_ratio_string(100),
        lv_len TYPE i.

  FIELD-SYMBOLS: <ls_mpos> TYPE mpos,
                 <ls_t351p> TYPE t351p,
                 <ls_t351x> TYPE t351x.

  FIELD-SYMBOLS: <ls_schedule> TYPE t_schedule.

* Get visit index and planned date
  DO 1 TIMES.
    "add leading zeros to maintenance plan (needed for select later on)
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = uv_warpl
      IMPORTING
        output = lv_warpl.

    "Check whether the plan is inactive.
    CONCATENATE 'WO' lv_warpl INTO lv_objnr.
    SELECT SINGLE objnr FROM jest INTO lv_objnr
      WHERE objnr EQ lv_objnr
        AND stat IN ('I0320', 'I0076')
        AND inact <> 'X'.
    IF sy-subrc = 0.
      lv_inactive = 'X'.
      "plan is inactive, open calls are locked.
      "check whether there is a not yet completed call
      SELECT a~warpl b~wppos a~abnum a~nplda a~terma a~offze a~zaehl b~addat
             a~tsabr a~tstat a~adextstartdate a~adoffset
             INTO CORRESPONDING FIELDS OF TABLE lt_schedule
             FROM mhis AS a
             INNER JOIN mhio AS b ON a~warpl = b~warpl AND
                                     a~abnum = b~abnum
             WHERE                   a~warpl = lv_warpl AND
                                     a~terma <> 'M' AND
                                     a~tsabr = 'X' AND "inact:future=locked
                                     a~tstat <> 'X' AND "not skipped
                                     a~tsenq <> 'X' AND "not stopped
                                     b~addat = '00000000'. "call compl
      "if multiple open calls, select the last one
      SORT lt_schedule BY abnum DESCENDING.

    ELSE.
      "plan is active, first check open call
      SELECT a~warpl b~wppos a~abnum a~nplda a~terma a~offze a~zaehl b~addat
             a~tsabr a~tstat a~adextstartdate a~adoffset
             INTO CORRESPONDING FIELDS OF TABLE lt_schedule
             FROM mhis AS a
             INNER JOIN mhio AS b ON a~warpl = b~warpl AND
                                     a~abnum = b~abnum
             WHERE                   a~warpl = lv_warpl AND
                                     a~terma <> 'M' AND
                                     a~tsabr = 'X' AND "exclude future calls
                                     a~tstat <> 'X' AND "not skipped
                                     a~tsenq <> 'X' AND "not stopped
                                     b~addat = '00000000'.  "call compl
      "if multiple open calls, select the last one
      SORT lt_schedule BY abnum DESCENDING.
      IF sy-subrc <> 0.
        "if no open call found, find the next plan date
        SELECT a~warpl b~wppos a~abnum a~nplda a~terma a~offze a~zaehl b~addat
               a~tsabr a~tstat a~adextstartdate a~adoffset
               INTO CORRESPONDING FIELDS OF TABLE lt_schedule
               FROM mhis AS a
               INNER JOIN mhio AS b ON a~warpl = b~warpl AND
                                       a~abnum = b~abnum
               WHERE                   a~warpl = lv_warpl AND
                                       a~terma <> 'M' AND
                                       a~tsabr <> 'X' AND "future calls
                                       a~tstat <> 'X' AND "not skipped
                                       b~addat = '00000000'. "call compl
        SORT lt_schedule BY warpl abnum.
      ENDIF.
    ENDIF.

    "Find the most recent start/start in cycle before that call
    READ TABLE lt_schedule ASSIGNING <ls_schedule> INDEX 1.
    CHECK sy-subrc EQ 0.

    "Planned date of the open call
    cv_nplda = <ls_schedule>-nplda.

    "Determine smallest cycle in the plan
    CREATE OBJECT lo_mp_util
      EXPORTING
        fi_warpl = lv_warpl.

    lo_mp_util->get_min_cycle_length( IMPORTING length_in_days = lv_cycle_length ).

    "Get the visit index
    cv_index = <ls_schedule>-offze / 86400 / lv_cycle_length.
  ENDDO.  "1 TIMES

* Get used packages and ratio between them
  DO 1 TIMES.
    "Get all maintenance items
    SELECT * FROM mpos
      INTO TABLE lt_mpos
      WHERE warpl EQ lv_warpl.
    CHECK sy-subrc EQ 0.

    "Get all packages
    SELECT * FROM plwp
      INTO TABLE lt_plwp
      FOR ALL ENTRIES IN lt_mpos
      WHERE plnty EQ lt_mpos-plnty
        AND plnnr EQ lt_mpos-plnnr
        AND plnal EQ lt_mpos-plnal.
    CHECK sy-subrc EQ 0.

    "Get the strategy
    READ TABLE lt_mpos ASSIGNING <ls_mpos> INDEX 1.
    CHECK sy-subrc EQ 0.

    "Get details about the maintenance packages
    SELECT * FROM t351p
      INTO TABLE lt_t351p
*      FOR ALL ENTRIES IN lt_plwp
      WHERE strat EQ <ls_mpos>-wstra.
*        AND zaehl EQ lt_plwp-paket.
    CHECK sy-subrc EQ 0.

    SELECT * FROM t351x
      INTO TABLE lt_t351x
      WHERE strat EQ <ls_mpos>-wstra.
    CHECK sy-subrc EQ 0.
* Begin of insert MOD-003
    CLEAR lv_zyk1g.
* End of insert MOD-003
    READ TABLE lt_t351x ASSIGNING <ls_t351x>
      WITH KEY kzyk1 = 'A'.
    IF sy-subrc EQ 0.
      READ TABLE lt_t351p ASSIGNING <ls_t351p>
        WITH KEY zaehl = <ls_t351x>-paket.
      IF sy-subrc EQ 0.
        lv_zykzt = <ls_t351p>-zykzt.
      ENDIF.
    ENDIF.

* Begin of insert MOD-003
    SELECT * FROM t351p
      INTO TABLE lt_t351p
      FOR ALL ENTRIES IN lt_plwp
      WHERE strat EQ <ls_mpos>-wstra
        AND zaehl EQ lt_plwp-paket.
* End of insert MOD-003

    SORT lt_t351p ASCENDING BY zykzt.

    "Fill CV_PACKAGES and CV_RATIO
    LOOP AT lt_t351p ASSIGNING <ls_t351p>.
      IF sy-tabix GT 1.
        CONCATENATE cv_packages ';' INTO cv_packages.
        CONCATENATE cv_ratio ';' INTO cv_ratio.
      ENDIF.
      READ TABLE lt_t351x ASSIGNING <ls_t351x>
        WITH KEY paket = <ls_t351p>-zaehl.
      IF sy-subrc EQ 0.
        CONCATENATE cv_packages <ls_t351x>-kzyk1 INTO cv_packages.
      ENDIF.
      IF lv_zykzt IS NOT INITIAL.
        lv_ratio = <ls_t351p>-zykzt / lv_zykzt.
        WRITE lv_ratio TO lv_ratio_string.
        CONDENSE lv_ratio_string NO-GAPS.
        "Remove trailing zeros, comma's and dots
        DO 3 TIMES.
          lv_len = STRLEN( lv_ratio_string ) - 1.
          IF lv_ratio_string+lv_len(1) EQ '0' OR lv_ratio_string+lv_len(1) EQ ',' OR lv_ratio_string+lv_len(1) EQ '.'.
            lv_ratio_string = lv_ratio_string(lv_len).
          ENDIF.
        ENDDO.
        CONCATENATE cv_ratio lv_ratio_string INTO cv_ratio.
* Begin of insert MOD-003
*       ELSE.
*       IF lv_zyk1g IS NOT INITIAL.
*       lv_ratio = <ls_t351p>-zykzt / lv_zyk1g.
*        WRITE lv_ratio TO lv_ratio_string.
*        CONDENSE lv_ratio_string NO-GAPS.
*        "Remove trailing zeros, comma's and dots
*        DO 3 TIMES.
*          lv_len = STRLEN( lv_ratio_string ) - 1.
*          IF lv_ratio_string+lv_len(1) EQ '0' OR lv_ratio_string+lv_len(1) EQ ',' OR lv_ratio_string+lv_len(1) EQ '.'.
*            lv_ratio_string = lv_ratio_string(lv_len).
*          ENDIF.
*        ENDDO.
*        CONCATENATE cv_ratio lv_ratio_string INTO cv_ratio.
*        ENDIF.
* End of insert MOD-003
      ENDIF.
    ENDLOOP.

    CONDENSE: cv_packages NO-GAPS, cv_ratio NO-GAPS.
  ENDDO.  "1 TIMES
* Begin of MOD-007
* Chaging the Data type of LV_LCM and LV_SMALLEST
*  DATA: LV_LCM type i,
*        LV_SMALLEST type i.
  DATA: lv_lcm TYPE cl_reca_math_services=>mtype_d_number,
*        mtype_d_number TYPE p LENGTH 16 DECIMALS 4 ,
        lv_smallest TYPE dzyk_zeit.
  DATA: lw_t351p LIKE LINE OF lt_t351p.
* End of MOd-007
  lv_lcm = 1.
* Least common multiple is length of visit string

  SORT lt_t351p BY zykzt.
  LOOP AT lt_t351p INTO lw_t351p.
    IF lv_smallest IS INITIAL.
      lv_smallest = lw_t351p-zykzt.
    ENDIF.

    CALL METHOD cl_reca_math_services=>lcm(
      EXPORTING
        id_a   = lw_t351p-zykzt
        id_b   = lv_lcm
      RECEIVING
        rd_lcm = lv_lcm
      EXCEPTIONS
        error  = 1 ).
  ENDLOOP.

  IF lv_smallest = 0.
    cv_index = 0.
  ELSE.
    lv_lcm = lv_lcm / lv_smallest.
    cv_index = ( cv_index MOD lv_lcm ).   "cv_index has the total number of visits as of the mp start and can be more than 1 repeating cycle -> divide and get remaining
    IF cv_index = 0.                      "if there is no remainder, it means that the visit string was a multiplication of the repeating cycle AND the last visit is due.
      cv_index = lv_lcm.                  "therefore, we visit index becomes the full length of the repeating cycle (last visit)
    ENDIF.
  ENDIF.
ENDFORM.                    " GET_MP_DETAILS

*Text symbol text
*001:Selection Screen Input
*002:Remarks
*C01:* If started in background, files are stored on the application server
*C02:* /var/load/xxx/UK/read/
*C03:* xxx = logical system
*E02:Planning plant does not exist
*E03:No authorization for plant :
*E04:Open dataset failed for :
*E05:Close dataset failed for :
*I01:No maintenance plans selected !
*I02:No variant table for Central Task Lists found (CU60)

*I03:Could not find caracteristic :
*Selection text
*P_ACTIVE:        Active Contracts Only
*P_BUKRS:D       .
*P_FILEC:        Filename Components
*P_FILEMH:        Filename MaintPlan Header
*P_FILEMI:        filename MaitPlan Item
*P_FILEMS:        Filename MaintPlan Schedule
*P_FILES:        Filename Skills
*P_FILET:        Filename Tasklists-Operations
*P_FILETH:        Filename Tasklis-Header
*P_IWERK:D       .
*P_VKORG:D       .
*S_EQUNR:D       .
*S_KDAUF:D       .
*S_WARPL:D       .
