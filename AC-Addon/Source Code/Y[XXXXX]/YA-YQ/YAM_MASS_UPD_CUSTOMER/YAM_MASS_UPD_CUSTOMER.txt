*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_MASS_UPD_CUSTOMER                         *
* PROGRAM TITLE        : AM: Mass update customer                      *
* AUTHOR               : MARC JACOBS                                   *
* DATE                 : 04/06/2007                                    *
* DEVELOPMENT ID       :                                               *
* CHANGE REQUEST NUMBER: CD1K915822                                    *
* PROGRAM DESCRIPTION  : This is a program to do mass-updates of       *
*                         customers                                    *
*                        in : - open orders                            *
*                             - notifications                          *
*                             - equipments                             *
*                             - functional locations                   *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE   *
*----------------------------------------------------------------------*
* MOD-001 |05/03/2008|M.Jacobs  |CD1K926925 sort before del adjacent
************************************************************************
REPORT yam_mass_upd_customer
       NO STANDARD PAGE HEADING
       LINE-SIZE 120
       MESSAGE-ID yam_dc.

*---------------------------------------------------------------------*
* TABLES DECLARATION
*---------------------------------------------------------------------*
TABLES: kna1,                              " Customer master
        knvv,                              " Customer master sales
        afih,                              " Maintenance order header
        knvk,                              " Relation cust-contactperson
        equi,                              " Equipments
        viqmel,                            " Notifications
        v_equi,                            " Equipments
        iflot.                             " Functional locations

*---------------------------------------------------------------------*
* INTERNAL TABLE DECLARATIONS                                         *
*---------------------------------------------------------------------*
DATA: l_struct_bdcdata  TYPE bdcdata ,             "BDCDATA table
      l_i_bdcdata TYPE STANDARD TABLE OF bdcdata.  "Table for BDC data

DATA g_api_values LIKE api_value OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF gt_par OCCURS 0,
       objnr LIKE ihpa-objnr,
       parvw LIKE ihpa-parvw,
       counter LIKE ihpa-counter,
       parnr LIKE ihpa-parnr,
      END   OF gt_par.

DATA: BEGIN OF gt_parc OCCURS 0,
       vbeln LIKE vbpa-vbeln,
       parvw LIKE vbpa-parvw,
       kunnr LIKE vbpa-kunnr,
      END   OF gt_parc.

DATA: BEGIN OF gt_ord OCCURS 0,
       objnr LIKE ihpa-objnr,
       aufnr LIKE afih-aufnr,
       qmnum LIKE afih-qmnum,
      END   OF gt_ord.

DATA: BEGIN OF gt_not OCCURS 0,
       objnr LIKE ihpa-objnr,
       qmnum LIKE afih-qmnum,
      END   OF gt_not.

DATA: BEGIN OF gt_equ OCCURS 0,
       objnr LIKE ihpa-objnr,
       equnr LIKE v_equi-equnr,
      END   OF gt_equ.

DATA: BEGIN OF gt_flo OCCURS 0,
       objnr LIKE ihpa-objnr,
       tplnr LIKE iflo-tplnr,
      END   OF gt_flo.

*---------------------------------------------------------------------*
* VARIABLE DECLARATIONS                                               *
*---------------------------------------------------------------------*
DATA : g_ind(2)          TYPE n,
       g_aufnr           LIKE afih-aufnr,      "ordernumber
       g_parvw           LIKE ihpa-parvw,      "partner type
       g_parnr           LIKE ihpa-parnr,      "partner number
       g_kunnr           LIKE knvk-kunnr,      "customer number
       gv_objnr          LIKE jest-objnr,      "object number
       gv_bukrs          TYPE bukrs,
       gv_kokrs          TYPE kokrs,
       gv_textline(132)  TYPE c,
       gv_scr_field(25)  TYPE c.

*---------------------------------------------------------------------*
* CONSTANT DECLARATIONS                                               *
*---------------------------------------------------------------------*
CONSTANTS: c_blank(1)    TYPE c             VALUE ' ',
           c_ori         LIKE ihpa-obtyp    VALUE 'ORI',   "order
           c_qmi         LIKE ihpa-obtyp    VALUE 'QMI',   "notification
           c_ieq         LIKE ihpa-obtyp    VALUE 'IEQ',   "equipment
           c_ifl         LIKE ihpa-obtyp    VALUE 'IFL',   "func.loc
           c_i0068       LIKE jest-stat     VALUE 'I0068', "stat osno
           c_datbi       TYPE sy-datum      VALUE '99991231',
           c_zsm5        TYPE auart         VALUE 'ZSM5',
           c_x(1)        TYPE c             VALUE 'X'.

*---------------------------------------------------------------------*
* PARAMETER DECLARATION
*---------------------------------------------------------------------*
* sales organisation
SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
SELECTION-SCREEN : BEGIN OF BLOCK b1a.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (31)   text-sc1 FOR FIELD p_vkorg.
PARAMETERS: p_vkorg  LIKE mvke-vkorg OBLIGATORY MEMORY ID vko.
SELECTION-SCREEN COMMENT (2) g_blank1.
SELECTION-SCREEN COMMENT (30) g_ktext1.
SELECTION-SCREEN END OF LINE.

* distribution channel
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (31)   text-sc2 FOR FIELD p_vtweg.
PARAMETERS: p_vtweg  LIKE mvke-vtweg OBLIGATORY MEMORY ID vtw.
SELECTION-SCREEN COMMENT (4) g_blank2.
SELECTION-SCREEN COMMENT (30) g_ktext2.
SELECTION-SCREEN END OF LINE.

* division
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (31)   text-sc3 FOR FIELD p_spart.
PARAMETERS: p_spart  LIKE mara-spart OBLIGATORY MEMORY ID spa.
SELECTION-SCREEN COMMENT (4) g_blank3.
SELECTION-SCREEN COMMENT (30) g_ktext3.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b1a.

* plant
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (31)   text-sc4 FOR FIELD p_werks.
PARAMETERS: p_werks  LIKE marc-werks OBLIGATORY MEMORY ID wrk.
SELECTION-SCREEN COMMENT (2) g_blank4.
SELECTION-SCREEN COMMENT (30) g_ktext4.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN: END OF BLOCK b1.

* Customer
SELECTION-SCREEN : BEGIN OF BLOCK b2 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (31) text-sc5 FOR FIELD p_custf.
PARAMETERS: p_custf  LIKE kna1-kunnr.
SELECTION-SCREEN COMMENT (48) cusfname.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT (31) text-sc6 FOR FIELD p_custt.
PARAMETERS: p_custt  LIKE kna1-kunnr.
SELECTION-SCREEN COMMENT (48) custname.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN: END OF BLOCK b2.

* equipment
SELECTION-SCREEN : BEGIN OF BLOCK b3 WITH FRAME TITLE text-003.
SELECT-OPTIONS: s_equnr      FOR   equi-equnr     MATCHCODE OBJECT equi.
SELECTION-SCREEN: END OF BLOCK b3.


SELECTION-SCREEN : BEGIN OF BLOCK b8 WITH FRAME TITLE text-008.
PARAMETERS : p_updoo AS CHECKBOX DEFAULT ' ',
             p_updno AS CHECKBOX DEFAULT ' ',
             p_updeq AS CHECKBOX DEFAULT ' ',
             p_updfl AS CHECKBOX DEFAULT ' '.
SELECTION-SCREEN: END OF BLOCK b8.
*---------------------------------------------------------------------*
* Initialization                                                      *
*---------------------------------------------------------------------*
INITIALIZATION.

*---------------------------------------------------------------------*
*--- AT selection-screen on block b1a: sales area
*---------------------------------------------------------------------*
AT SELECTION-SCREEN ON BLOCK b1a.

  DATA: lt_tvkot LIKE tvkot,
        lt_tvko  LIKE tvko,
        lt_tvtwt LIKE tvtwt,
        lt_tspat LIKE tspat,
        lt_tvkbt LIKE tvkbt,
        lt_tvgrt LIKE tvgrt.

  CLEAR: lt_tvkot, lt_tvtwt, lt_tspat, lt_tvkbt, lt_tvgrt.

*.. Check sales organization
  CALL FUNCTION 'ITOB_CHECK_SALES_ORGANIZATION'
    EXPORTING
      vkorg                   = p_vkorg
*     LANGU                   = SY-LANGU
*     USE_BUF                 = 'X'
*     DIALOG_MODE             = 'X'
      dialog_cursor           = 'P_VKORG'
*     DIALOG_STEPL            = 0
*     INIT_MESSAGE_DATA       = 'X'
*     X_MESS_TYPE             = 'E'
*     READ_TEXT_TABLES        = 'X'
    IMPORTING
      tvko_exp                = lt_tvko
      tvkot_exp               = lt_tvkot
*   EXCEPTIONS
*     EMPTY_KEY               = 1
*     APPLICATION_ERROR       = 2
*     OTHERS                  = 3
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  MOVE lt_tvkot-vtext TO g_ktext1.
  MOVE lt_tvko-bukrs  TO gv_bukrs.

*.. Check distribution channel
  CALL FUNCTION 'ITOB_CHECK_SALES_CHANNEL'
    EXPORTING
      vtweg                   = p_vtweg
*   LANGU                   = SY-LANGU
*   USE_BUF                 = 'X'
*   DIALOG_MODE             = 'X'
      dialog_cursor           = 'P_VTWEG'
*   DIALOG_STEPL            = 0
*   INIT_MESSAGE_DATA       = 'X'
*   X_MESS_TYPE             = 'E'
*   READ_TEXT_TABLES        = 'X'
    IMPORTING
*   TVTW_EXP                =
      tvtwt_exp               = lt_tvtwt
* EXCEPTIONS
*   EMPTY_KEY               = 1
*   APPLICATION_ERROR       = 2
*   OTHERS                  = 3
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  MOVE lt_tvtwt-vtext TO g_ktext2.

*.. Check division
  CALL FUNCTION 'ITOB_CHECK_SALES_DIVISION'
    EXPORTING
      spart                   = p_spart
*   LANGU                   = SY-LANGU
*   USE_BUF                 = 'X'
*   DIALOG_MODE             = 'X'
      dialog_cursor           = 'P_SPART'
*   DIALOG_STEPL            = 0
*   INIT_MESSAGE_DATA       = 'X'
*   X_MESS_TYPE             = 'E'
*   READ_TEXT_TABLES        = 'X'
    IMPORTING
*   TSPA_EXP                =
      tspat_exp               = lt_tspat
* EXCEPTIONS
*   EMPTY_KEY               = 1
*   APPLICATION_ERROR       = 2
*   OTHERS                  = 3
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  MOVE lt_tspat-vtext TO g_ktext3.

* authority check
  AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
         ID 'VKORG' FIELD p_vkorg
         ID 'VTWEG' FIELD p_vtweg
         ID 'SPART' FIELD p_spart
         ID 'ACTVT' FIELD '01'.
  IF sy-subrc <> 0.
    MESSAGE e001(00) WITH text-e01 p_vkorg.
  ENDIF.

*.. Check Sales area
  CALL FUNCTION 'ITOB_CHECK_SALES_AREA'
    EXPORTING
      vkorg = p_vkorg
      vtweg = p_vtweg
      spart = p_spart.

  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

*-----------------------------------------------------------------*
AT SELECTION-SCREEN ON p_werks.

  SELECT SINGLE name1 INTO g_ktext4
     FROM t001w WHERE werks = p_werks.
  IF sy-subrc <> 0.
    MESSAGE e001(00) WITH text-e08.
  ENDIF.

* authority check
  AUTHORITY-CHECK OBJECT 'I_IWERK'
             ID 'TCD'   FIELD sy-tcode
             ID 'IWERK' FIELD p_werks.

  IF sy-subrc <> 0.
    MESSAGE e001(00) WITH text-e06 p_werks.
  ENDIF.

** customer
AT SELECTION-SCREEN ON BLOCK b2.
  CLEAR: cusfname,
         custname.
* Customer from
  IF p_custf IS INITIAL.
    MESSAGE e001(00) WITH text-e09.
  ELSE.
    SELECT SINGLE * FROM kna1 WHERE kunnr = p_custf.
    IF sy-subrc <> 0.
      MESSAGE e001(00) WITH text-e10.
    ELSE.
      MOVE kna1-name1 TO cusfname.
    ENDIF.
  ENDIF.
* Customer to
  IF p_custt IS INITIAL.
    MESSAGE e001(00) WITH text-e11.
  ELSE.
    SELECT SINGLE * FROM kna1 WHERE kunnr = p_custt.
    IF sy-subrc <> 0.
      MESSAGE e001(00) WITH text-e12.
    ELSE.
      MOVE kna1-name1 TO custname.
    ENDIF.
  ENDIF.
* check customer from and to in knvv
  SELECT SINGLE * FROM knvv
   WHERE kunnr = p_custf
     AND vkorg = p_vkorg
     AND vtweg = p_vtweg
     AND spart = p_spart.
  IF NOT sy-subrc IS INITIAL.
    MESSAGE e001(00) WITH text-e14.
  ENDIF.

  SELECT SINGLE * FROM knvv
   WHERE kunnr = p_custt
     AND vkorg = p_vkorg
     AND vtweg = p_vtweg
     AND spart = p_spart.
  IF NOT sy-subrc IS INITIAL.
    MESSAGE e001(00) WITH text-e15.
  ENDIF.

* customer from and to cannot be the same
  IF p_custf = p_custt.
    MESSAGE e001(00) WITH text-e13.
  ENDIF.

*---------------------------------------------------------------------*
*--- F4 Inputhelp
*---------------------------------------------------------------------*


*--------- S T A R T   O F   M A I N   P R O C E S S I N G -----------*

*---------------------------------------------------------------------*
* START-OF-SELECTION                                                  *
*---------------------------------------------------------------------*
START-OF-SELECTION.

* at least 1 item must be filled in in the tab changes
  IF p_updoo IS INITIAL AND
     p_updno IS INITIAL AND
     p_updeq IS INITIAL AND
     p_updfl IS INITIAL.
    MESSAGE s001(00) WITH text-e03  .
    EXIT.
  ENDIF.

** Update service orders ?
  IF p_updoo = c_x.
* get the open orders
    REFRESH gt_ord.
    PERFORM select-orders.
* update the open orders
    IF NOT gt_ord[] IS INITIAL.
      WRITE : / text-009 , p_custf , text-010 , p_custt ,
               90 sy-datum , sy-uzeit.
      ULINE.
      PERFORM update-orders.
    ENDIF.
  ENDIF.

** Update notifications ?

  IF p_updno = c_x.
* get the notifications
    REFRESH gt_not.
    PERFORM select-notifs.
* update the open notifications
    IF NOT gt_not[] IS INITIAL.
      WRITE : / text-009 , p_custf , text-010 , p_custt ,
                 90 sy-datum , sy-uzeit.
      ULINE.
      PERFORM update-notifs.
    ENDIF.
  ENDIF.

** Update equipments ?

  IF p_updeq = c_x.
* get the equipments
    REFRESH gt_equ.
    PERFORM select-equipm.
* update the equipments
    IF NOT gt_equ[] IS INITIAL.
      WRITE : / text-009 , p_custf , text-010 , p_custt ,
                 90 sy-datum , sy-uzeit.
      ULINE.
      PERFORM update-equipm.
    ENDIF.
  ENDIF.

** Update functional locations ?

  IF p_updfl = c_x.
* get the functional locations
    REFRESH gt_flo.
    PERFORM select-funcloc.
* update functional locations
    IF NOT gt_flo[] IS INITIAL.
      WRITE : / text-009 , p_custf , text-010 , p_custt ,
                 90 sy-datum , sy-uzeit.
      ULINE.
      PERFORM update-funcloc.
    ENDIF.
  ENDIF.

*----------------------------------------------------------------------*
* END-OF-SELECTION                                                     *
*----------------------------------------------------------------------*
END-OF-SELECTION.

*-S U B R O U T I N E S------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  HELP_F4
*&---------------------------------------------------------------------*
*       Inputhelp                                                      *
*----------------------------------------------------------------------*

FORM select-orders.

* select all  orders for the from customer in file IHPA

  SELECT objnr INTO CORRESPONDING FIELDS OF TABLE gt_ord
     FROM ihpa WHERE parnr EQ p_custf
                 AND obtyp = c_ori
                 AND kzloesch = c_blank.

* begin of insertion MOD-001
  SORT gt_ord BY objnr.
* end of insertion MOD-001

* delete adjacent records
  DELETE ADJACENT DUPLICATES FROM gt_ord COMPARING objnr.

* check status open
  LOOP AT gt_ord.
    g_aufnr = gt_ord-objnr+2(12).
    SELECT SINGLE * FROM afih WHERE aufnr = g_aufnr.
    IF sy-subrc IS INITIAL.
      IF afih-iphas >= '3'.
        DELETE gt_ord.
      ELSE.
        MOVE afih-aufnr TO gt_ord-aufnr.
        MOVE afih-qmnum TO gt_ord-qmnum.
        MODIFY gt_ord.
      ENDIF.
    ENDIF.
  ENDLOOP.

* check for equipments
  IF NOT s_equnr IS INITIAL.
    LOOP AT gt_ord.
      SELECT SINGLE * FROM afih WHERE aufnr = gt_ord-aufnr.
      IF sy-subrc = 0.
        IF NOT afih-equnr IN s_equnr.
          DELETE gt_ord.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.

* sort
  SORT gt_ord BY aufnr.

ENDFORM.                    "select-orders
*&---------------------------------------------------------------------*
*&      Form  update-orders
*&---------------------------------------------------------------------*
FORM update-orders.

  LOOP AT gt_ord.
** get all partners of the corresponding order
    REFRESH gt_par.

    SELECT objnr parvw counter parnr
     INTO CORRESPONDING FIELDS OF TABLE gt_par
     FROM ihpa WHERE objnr EQ gt_ord-objnr
                 AND obtyp = c_ori
                 AND kzloesch EQ c_blank.

    IF NOT gt_par[] IS INITIAL.
      REFRESH l_i_bdcdata.
** screen get order
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPLCOIH'  '0101'  'X'  ''  ''
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '/00'
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_CURSOR'  'CAUFVD-AUFNR'
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'CAUFVD-AUFNR'  gt_ord-aufnr
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

* on headerdata --> go to partners
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPLCOIH'  '3000'  'X'  ''  ''
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=PARU'
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.

* on partners
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPLCOIH'  '3000'  'X'  ''  ''
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=IPAR_DELP'
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.
* delete all partner lines (as many as in table gt_par
      g_ind = 0.
      LOOP AT gt_par.

        g_ind = g_ind + 1.

        CONCATENATE 'IHPAVB-SLKNZ(' g_ind ')' INTO gv_scr_field.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                CHANGING l_struct_bdcdata.
        APPEND l_struct_bdcdata  TO l_i_bdcdata.
        CLEAR  l_struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  gv_scr_field  'X'
                CHANGING l_struct_bdcdata.
        APPEND l_struct_bdcdata  TO l_i_bdcdata.
        CLEAR  l_struct_bdcdata.

      ENDLOOP.

* insert new partners and save
      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    'SAPLCOIH'  '3000'  'X'  ''  ''
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      PERFORM fill_bdcdata IN PROGRAM yam_common_routines
              USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
              CHANGING l_struct_bdcdata.
      APPEND l_struct_bdcdata  TO l_i_bdcdata.
      CLEAR  l_struct_bdcdata.

      g_ind = 0.
      LOOP AT gt_par.
        CLEAR :g_parvw,
               g_parnr.
        g_ind = g_ind + 1.
        MOVE gt_par-parvw TO g_parvw.
        IF gt_par-parnr = p_custf.
          MOVE p_custt TO g_parnr.
        ELSE.
          MOVE gt_par-parnr TO g_parnr.
        ENDIF.
* partner type
        CONCATENATE 'IHPA-PARVW(' g_ind ')' INTO gv_scr_field.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                CHANGING l_struct_bdcdata.
        APPEND l_struct_bdcdata  TO l_i_bdcdata.
        CLEAR  l_struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  gv_scr_field  g_parvw
                CHANGING l_struct_bdcdata.
        APPEND l_struct_bdcdata  TO l_i_bdcdata.
        CLEAR  l_struct_bdcdata.

* partner number
        CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                CHANGING l_struct_bdcdata.
        APPEND l_struct_bdcdata  TO l_i_bdcdata.
        CLEAR  l_struct_bdcdata.

        PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                USING    ''  ''  ''  gv_scr_field  g_parnr
                CHANGING l_struct_bdcdata.
        APPEND l_struct_bdcdata  TO l_i_bdcdata.
        CLEAR  l_struct_bdcdata.
* exception for contact person
        IF g_parvw = 'AP'.
          CLEAR g_kunnr.
          SELECT SINGLE * FROM knvk WHERE
           parnr = g_parnr.
          IF sy-subrc IS INITIAL.
            MOVE knvk-kunnr TO g_kunnr.
* overwrite partner number and name
            CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parnr
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            CONCATENATE 'DIADR-NAME_LIST(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parnr
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

          ENDIF.
        ENDIF.
      ENDLOOP.

* call transaction IW32
      IF NOT l_i_bdcdata[] IS INITIAL.
        CALL TRANSACTION 'IW32' USING l_i_bdcdata
        MODE 'N' UPDATE 'S' .
** Logging of changes
        IF sy-subrc NE 0 .
          WRITE : /'Order ' , gt_ord-aufnr, ' not updated.'.
        ELSE.
          WRITE : / 'Order ' , gt_ord-aufnr, ' updated.'.
          IF NOT gt_ord-qmnum IS INITIAL.
** update corresponding notification
            REFRESH gt_not.
            MOVE gt_ord-qmnum TO gt_not-qmnum.
            APPEND gt_not.
            PERFORM update-notifs.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "update-orders

*&---------------------------------------------------------------------*
*&      Form  select-notifications
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*

FORM select-notifs.

* select all notifications for the from customer from IHPA

  SELECT objnr INTO CORRESPONDING FIELDS OF TABLE gt_not
     FROM ihpa WHERE parnr EQ p_custf
                 AND obtyp = c_qmi
                 AND kzloesch = c_blank.

* begin of insertion MOD-001
  SORT gt_not BY objnr.
* end of insertion MOD-001

* delete adjacent records
  DELETE ADJACENT DUPLICATES FROM gt_not COMPARING objnr.

* status notification must be outstanding (OSNO) or (NOPR)

  LOOP AT gt_not.

    CALL FUNCTION 'STATUS_CHECK'
      EXPORTING
        objnr             = gt_not-objnr
        status            = c_i0068
      EXCEPTIONS
        object_not_found  = 1
        status_not_active = 2
        OTHERS            = 3.

    IF sy-subrc NE 0.
      DELETE gt_not.
    ELSE.
      gt_not-qmnum = gt_not-objnr+2(12).
      MODIFY gt_not.
    ENDIF.

  ENDLOOP.

* check for equipments
  IF NOT s_equnr IS INITIAL.
    LOOP AT gt_not.
      SELECT SINGLE * FROM viqmel WHERE qmnum = gt_not-qmnum.
      IF sy-subrc = 0.
        IF NOT viqmel-equnr IN s_equnr.
          DELETE gt_not.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.

* sort
  SORT gt_not BY qmnum.

ENDFORM.                    "select-notifs
*&---------------------------------------------------------------------*
*&      Form  updat-notifications
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM update-notifs.

  LOOP AT gt_not.

* is notification locked

    CALL FUNCTION 'ENQUEUE_EIQMEL'
      EXPORTING
        qmnum          = gt_not-qmnum
      EXCEPTIONS
        foreign_lock   = 01
        system_failure = 02.

    IF NOT sy-subrc IS INITIAL.
      WRITE : / 'Notification ' , gt_not-qmnum , ' locked.'.
    ELSE.
** unlock notification
      CALL FUNCTION 'DEQUEUE_EIQMEL'
        EXPORTING
          qmnum  = gt_not-qmnum
        EXCEPTIONS
          OTHERS = 1.
* notification is now unlocked again.
      IF sy-subrc IS INITIAL.

** get all partners of the corresponding notification

        REFRESH gt_par.

        SELECT objnr parvw counter parnr
         INTO CORRESPONDING FIELDS OF TABLE gt_par
         FROM ihpa WHERE objnr EQ gt_not-objnr
                     AND obtyp = c_qmi
                     AND kzloesch EQ c_blank.

        IF NOT gt_par[] IS INITIAL.


          REFRESH l_i_bdcdata.
** screen get order
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIQS0'  '0100'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'RIWO00-QMNUM'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'RIWO00-QMNUM'  gt_not-qmnum
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

** to partners
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIQS0'  '7200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=PART'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.
* on partners
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=DELP'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

* delete all partner lines (as many as in table gt_par
          g_ind = 0.
          LOOP AT gt_par.

            g_ind = g_ind + 1.

            CONCATENATE 'IHPAVB-SLKNZ(' g_ind ')' INTO gv_scr_field.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  'X'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

          ENDLOOP.

* insert new partners and back
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=BACK'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          g_ind = 0.
          LOOP AT gt_par.
            CLEAR :g_parvw,
                   g_parnr.
            g_ind = g_ind + 1.
            MOVE gt_par-parvw TO g_parvw.
            IF gt_par-parnr = p_custf.
              MOVE p_custt TO g_parnr.
            ELSE.
              MOVE gt_par-parnr TO g_parnr.
            ENDIF.
* partner type
            CONCATENATE 'IHPA-PARVW(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parvw
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

* partner number
            CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parnr
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.
* exception for contact person
            IF g_parvw = 'AP'.
              CLEAR g_kunnr.
              SELECT SINGLE * FROM knvk WHERE
               parnr = g_parnr.
              IF sy-subrc IS INITIAL.
                MOVE knvk-kunnr TO g_kunnr.
* overwrite partner number and name
                CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  gv_scr_field  g_parnr
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

             CONCATENATE 'DIADR-NAME_LIST(' g_ind ')' INTO gv_scr_field.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  gv_scr_field  g_parnr
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

              ENDIF.
            ENDIF.

          ENDLOOP.
** save
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIQS0'  '7200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=BUCH'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

* call transaction IW52
          IF NOT l_i_bdcdata[] IS INITIAL.
            CALL TRANSACTION 'IW52' USING l_i_bdcdata
            MODE 'N' UPDATE 'S'.
** Logging of changes
            IF sy-subrc NE 0 .
              WRITE : / 'Notification ' , gt_not-qmnum, ' not updated.'.
            ELSE.
              WRITE : / 'Notification ' , gt_not-qmnum, ' updated.'.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "updat-notifs

*&---------------------------------------------------------------------*
*&      Form  select-equipments
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM select-equipm.

* select all equipments for the from customer from IHPA

  SELECT objnr INTO CORRESPONDING FIELDS OF TABLE gt_equ
     FROM ihpa WHERE parnr EQ p_custf
                 AND obtyp = c_ieq
                 AND kzloesch = c_blank.

* begin of insertion MOD-001
  SORT gt_equ BY objnr.
* end of insertion MOD-001

* delete adjacent records
  DELETE ADJACENT DUPLICATES FROM gt_equ COMPARING objnr.

* update equipment number
  LOOP AT gt_equ.
    gt_equ-equnr = gt_equ-objnr+2(18).
    MODIFY gt_equ.
  ENDLOOP.

* check for equipments
  IF NOT s_equnr IS INITIAL.
    LOOP AT gt_equ.
      IF NOT gt_equ-equnr IN s_equnr.
        DELETE gt_equ.
      ENDIF.
    ENDLOOP.
  ENDIF.

* sort
  SORT gt_equ BY equnr.

ENDFORM.                    "select-equipm
*&---------------------------------------------------------------------*
*&      Form  update-equipments
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM update-equipm.

  LOOP AT gt_equ.

* is equipment locked
    CALL FUNCTION 'ENQUEUE_EIEQUI'
      EXPORTING
        equnr          = gt_equ-equnr
      EXCEPTIONS
        foreign_lock   = 1
        system_failure = 2.
    IF NOT sy-subrc IS INITIAL.
      WRITE : / 'Equipment ' , gt_equ-equnr , ' locked.'.
    ELSE.
** unlock equipment
      CALL FUNCTION 'DEQUEUE_EIEQUI'
        EXPORTING
          equnr  = gt_equ-equnr
        EXCEPTIONS
          OTHERS = 1.
* equipment is now unlocked again.
      IF sy-subrc IS INITIAL.

        REFRESH gt_par.

        SELECT objnr parvw counter parnr
         INTO CORRESPONDING FIELDS OF TABLE gt_par
         FROM ihpa WHERE objnr EQ gt_equ-objnr
                     AND obtyp = c_ieq
                     AND kzloesch EQ c_blank.

        IF NOT gt_par[] IS INITIAL.

          REFRESH l_i_bdcdata.
** screen select equipment
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPMIEQ0'  '0100'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'RM63E-EQUNR'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'RM63E-EQUNR'  gt_equ-equnr
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.
** to screen partners
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMIEQ0'  '0101'  'X'  ''  ''
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=PART'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.
** on screen partners
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=DELP'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
* delete all partner lines (as many as in table gt_par
          g_ind = 0.
          LOOP AT gt_par.

            g_ind = g_ind + 1.

            CONCATENATE 'IHPAVB-SLKNZ(' g_ind ')' INTO gv_scr_field.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  'X'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

          ENDLOOP.

* insert new partners and back
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=BACK'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          g_ind = 0.
          LOOP AT gt_par.
            CLEAR :g_parvw,
                   g_parnr.
            g_ind = g_ind + 1.
            MOVE gt_par-parvw TO g_parvw.
            IF gt_par-parnr = p_custf.
              MOVE p_custt TO g_parnr.
            ELSE.
              MOVE gt_par-parnr TO g_parnr.
            ENDIF.
* partner type
            CONCATENATE 'IHPA-PARVW(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parvw
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

* partner number
            CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parnr
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.
* exception for contact person
            IF g_parvw = 'AP'.
              CLEAR g_kunnr.
              SELECT SINGLE * FROM knvk WHERE
               parnr = g_parnr.
              IF sy-subrc IS INITIAL.
                MOVE knvk-kunnr TO g_kunnr.
* overwrite partner number and name
                CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  gv_scr_field  g_parnr
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

             CONCATENATE 'DIADR-NAME_LIST(' g_ind ')' INTO gv_scr_field.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  gv_scr_field  g_parnr
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

              ENDIF.
            ENDIF.

          ENDLOOP.
** on screen sales and distribution
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMIEQ0'  '0101'  'X'  ''  ''
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=BU'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.
* call transaction IE02
          IF NOT l_i_bdcdata[] IS INITIAL.
            CALL TRANSACTION 'IE02' USING l_i_bdcdata
            MODE 'N' UPDATE 'S' .
            IF sy-subrc NE 0 .
** Logging of changes
              WRITE : / 'Equipment ' , gt_equ-equnr , ' not updated.'.
            ELSE.
              WRITE : / 'Equipment ' , gt_equ-equnr , ' updated.'.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

  ENDLOOP.

ENDFORM.                    "update-equipm

*&---------------------------------------------------------------------*
*&      Form  select-functional locations
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM select-funcloc.
* select all functional locations for the from customer from IHPA

  SELECT objnr INTO CORRESPONDING FIELDS OF TABLE gt_flo
     FROM ihpa WHERE parnr EQ p_custf
                 AND obtyp = c_ifl
                 AND kzloesch = c_blank.

* delete adjacent records
  DELETE ADJACENT DUPLICATES FROM gt_flo COMPARING objnr.

* begin of insertion MOD-001
  sort gt_flo by objnr.
* end of insertin MOD-001

* update functional location number
  LOOP AT gt_flo.
    SELECT SINGLE * FROM iflot
     WHERE objnr = gt_flo-objnr.
    IF sy-subrc IS INITIAL.
      MOVE iflot-tplnr TO gt_flo-tplnr.
      MODIFY gt_flo.
    ENDIF.
  ENDLOOP.

* check for equipments
  IF NOT s_equnr IS INITIAL.
    LOOP AT gt_flo.
      SELECT * FROM v_equi WHERE tplnr = gt_flo-tplnr.
        IF sy-subrc = 0.
          IF NOT v_equi-equnr IN s_equnr.
            DELETE gt_flo.
          ENDIF.
        ENDIF.
      ENDSELECT.
    ENDLOOP.
  ENDIF.


* sort
  SORT gt_flo BY tplnr.

ENDFORM.                    "select-funcloc
*&---------------------------------------------------------------------*
*&      Form  update-functional locations
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM update-funcloc.

  LOOP AT gt_flo.

* is functional location locked?

    CALL FUNCTION 'ENQUEUE_EIFLOT'
      EXPORTING
        tplnr          = gt_flo-tplnr
      EXCEPTIONS
        foreign_lock   = 1
        system_failure = 2
        OTHERS         = 3.

    IF NOT sy-subrc IS INITIAL.
      WRITE : / 'Functional location ' , gt_flo-tplnr , ' locked.'.
    ELSE.
** unlock functional location
      CALL FUNCTION 'DEQUEUE_EIFLOT'
        EXPORTING
          tplnr  = gt_flo-tplnr
        EXCEPTIONS
          OTHERS = 1.
* functional location is now unlocked again.
      IF sy-subrc IS INITIAL.

        REFRESH gt_par.

        SELECT objnr parvw counter parnr
         INTO CORRESPONDING FIELDS OF TABLE gt_par
         FROM ihpa WHERE objnr EQ gt_flo-objnr
                     AND obtyp = c_ifl
                     AND kzloesch EQ c_blank.

        IF NOT gt_par[] IS INITIAL.


          REFRESH l_i_bdcdata.
** screen select equipment
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPMILO0'  '1110'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '/00'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_CURSOR'  'IFLO-TPLNR'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'IFLO-TPLNR'  gt_flo-tplnr
            CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.
** to partners
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                   USING    'SAPMILO0'  '2100'  'X'  ''  ''
                   CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=PA'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.
** on partners
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                       USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                       CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=DELP'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
* delete all partner lines (as many as in table gt_par
          g_ind = 0.
          LOOP AT gt_par.

            g_ind = g_ind + 1.

            CONCATENATE 'IHPAVB-SLKNZ(' g_ind ')' INTO gv_scr_field.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  'X'
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

          ENDLOOP.

* insert new partners and back
          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    'SAPLIPAR'  '0200'  'X'  ''  ''
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                  USING    ''  ''  ''  'BDC_OKCODE'  '=SAVE'
                  CHANGING l_struct_bdcdata.
          APPEND l_struct_bdcdata  TO l_i_bdcdata.
          CLEAR  l_struct_bdcdata.

          g_ind = 0.
          LOOP AT gt_par.
            CLEAR :g_parvw,
                   g_parnr.
            g_ind = g_ind + 1.
            MOVE gt_par-parvw TO g_parvw.
            IF gt_par-parnr = p_custf.
              MOVE p_custt TO g_parnr.
            ELSE.
              MOVE gt_par-parnr TO g_parnr.
            ENDIF.
* partner type
            CONCATENATE 'IHPA-PARVW(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parvw
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

* partner number
            CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.

            PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                    USING    ''  ''  ''  gv_scr_field  g_parnr
                    CHANGING l_struct_bdcdata.
            APPEND l_struct_bdcdata  TO l_i_bdcdata.
            CLEAR  l_struct_bdcdata.
* exception for contact person
            IF g_parvw = 'AP'.
              CLEAR g_kunnr.
              SELECT SINGLE * FROM knvk WHERE
               parnr = g_parnr.
              IF sy-subrc IS INITIAL.
                MOVE knvk-kunnr TO g_kunnr.
* overwrite partner number and name
                CONCATENATE 'IHPA-PARNR(' g_ind ')' INTO gv_scr_field.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  gv_scr_field  g_parnr
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

             CONCATENATE 'DIADR-NAME_LIST(' g_ind ')' INTO gv_scr_field.
                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  'BDC_CURSOR'  gv_scr_field
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

                PERFORM fill_bdcdata IN PROGRAM yam_common_routines
                        USING    ''  ''  ''  gv_scr_field  g_parnr
                        CHANGING l_struct_bdcdata.
                APPEND l_struct_bdcdata  TO l_i_bdcdata.
                CLEAR  l_struct_bdcdata.

              ENDIF.
            ENDIF.

          ENDLOOP.

* call transaction IL02
          IF NOT l_i_bdcdata[] IS INITIAL.
            CALL TRANSACTION 'IL02' USING l_i_bdcdata
            MODE 'N' UPDATE 'S' .
            IF sy-subrc NE 0 .
** Logging of changes
              WRITE : / 'Func.Loc. ' , gt_flo-tplnr , ' not updated.'.
            ELSE.
              WRITE : / 'Func.Loc. ' , gt_flo-tplnr , ' updated.'.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

  ENDLOOP.

ENDFORM.                    "update-funcloc

*Text symbol text
*001:Basic parameters
*002:Customer
*003:Equipments
*004:Sales Office - Sales Group
*005:Planner Group
*006:Cost Center
*008:Changes
*009:Update customer from
*010:to
*E01:You have no authorisation for sales organisation :
*E02:Select at least 1 field to change
*E03:Select at least 1 item in the tab Changes
*E06:You have no authorisation for plant :
*E07:You have no authorisation for delivering plant :
*E08:Invalid plant
*E09:Old customer number is mandatory.
*E10:Old customer number is invalid.
*E11:New customer number is mandatory.
*E12:New customer number is invalid.
*E13:Old and new customer cannot be the same
*E14:Old customer not valid for sales org.,distr.channel,division
*E15:New customer not valid for sales org.,distr.channel,division
*SC1:Sales Organization
*SC2:Distribution Channel
*SC3:Division
*SC4:Plant
*SC5:Old customer
*SC6:New customer

*SC7:Functions
*Selection text
*P_SPART:D       Division
*P_UPDEQ:        Change Equipments
*P_UPDFL:        Change Functional Locations
*P_UPDNO:        Change Notifications
*P_UPDOO:        Change Open Orders
*P_VKORG:D       Sales Organization
*P_VTWEG:D       Distribution Channel
*P_WERKS:D       Plant
*S_EQUNR:        Equipment
