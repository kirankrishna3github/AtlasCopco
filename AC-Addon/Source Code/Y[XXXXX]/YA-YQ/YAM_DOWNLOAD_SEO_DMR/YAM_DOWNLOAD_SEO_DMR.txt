*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_DOWNLOAD_SEO_DMR                          *
* PROGRAM TITLE        : Download DMR                                  *
* AUTHOR               : Geert Rutten                                  *
* DATE                 : 08/11/2012                                    *
* DEVELOPMENT ID       :                                               *
*                                                                      *
* CHANGE REQUEST NUMBER:  CD1K973807                                   *
*                                                                      *
* Program Description:  Download of DMR for cutover                    *
*                       Act! program                                   *
************************************************************************
REPORT yam_download_seo_dmr MESSAGE-ID yam_inf.

************************************************************************
*                   T A B L E S                                        *
************************************************************************
TABLES: vbak,
        aufk,
        tj02t,
        mpos,
        pmsdo,
        knvv.

************************************************************************
*                   T Y P E - P O O L S                                *
************************************************************************
TYPE-POOLS: ibco2.

************************************************************************
*                   C O N S T A N T S                                  *
************************************************************************
CONSTANTS: gc_stat_dl  TYPE j_status  VALUE 'I0076',
           c_rec_h(10)     TYPE c        VALUE 'DMR_Header',
           c_rec_p(12)     TYPE c        VALUE 'DMR_Partners',
           c_rec_l(15)     TYPE c        VALUE 'DMR_header_note',
           c_rec_l1(16)    TYPE c        VALUE 'DMR_header_note1',
           c_rec_l2(16)    TYPE c        VALUE 'DMR_header_note2',
*           c_rec_o(14)     TYPE c        VALUE 'dmr_Operations',
*           c_rec_p(17)     TYPE c        VALUE 'dmr_Parts_Ordered',
*           c_rec_l1(20)    TYPE c        VALUE 'dmr_header_longtxt',
*           c_rec_l2(18)    TYPE c        VALUE 'dmr_item_longtxt',
           gc_charx(1)  TYPE c        VALUE 'X',
           c_000000(6)  TYPE c        VALUE '000000',
           c_ag(2)      TYPE c        VALUE 'AG',
           c_re(2)      TYPE c        VALUE 'RE',
           c_rg(2)      TYPE c        VALUE 'RG',
           c_we(2)      TYPE c        VALUE 'WE'.

************************************************************************
*                  I N T E R N A L   T A B L E S                       *
************************************************************************
TYPES:
     BEGIN OF t_vbak,
       vbeln TYPE vbeln,
     END OF t_vbak.

DATA: it_vbak TYPE TABLE OF t_vbak,
      wa_vbak TYPE t_vbak,
      wa_vbak_dmr TYPE t_vbak,
      ls_vbak TYPE vbak,
      ls_vbkd TYPE vbkd.

DATA: txt_dmr TYPE yse_j_3rf_txt. "internal table for texts
DATA: wa_txt LIKE LINE OF txt_dmr.

DATA: BEGIN OF gt_equi OCCURS 0,
        equnr     LIKE equi-equnr,
        objnr     LIKE equi-objnr,
        eqktx     LIKE eqkt-eqktx,
      END OF gt_equi.

DATA: BEGIN OF h_status_tab OCCURS 30.
        INCLUDE STRUCTURE jstat.
DATA: END OF h_status_tab.

DATA: BEGIN OF gt_dmr OCCURS 0,
       qmnum LIKE qmel-qmnum,
       objnr LIKE qmel-objnr,
      END OF gt_dmr.

DATA: lv_sttxt(40)  TYPE c.
DATA: lv_sttxtu(40)  TYPE c.

DATA: BEGIN OF i_lines OCCURS 0.
        INCLUDE STRUCTURE tline.
DATA: END OF i_lines.

TYPES: BEGIN OF ty_stxh,
         tdname      TYPE tdobname,
         tdid        TYPE tdid,
         tdspras     TYPE spras,
       END OF ty_stxh.

DATA: gt_stxh  TYPE SORTED TABLE OF ty_stxh
                    WITH NON-UNIQUE KEY tdname
                    WITH HEADER LINE.

DATA: BEGIN OF gt_dmr_p_c OCCURS 0,
        aufnr      LIKE dd03l-fieldname,
        deli1      TYPE c,
        vbeln      LIKE dd03l-fieldname,
        deli2      TYPE c,
        posnr      LIKE dd03l-fieldname,
        deli3      TYPE c,
        parvw_ag   LIKE dd03l-fieldname,
        deli4      TYPE c,
        kunnr_ag   LIKE dd03l-fieldname,
        deli5      TYPE c,
        parvw_re   LIKE dd03l-fieldname,
        deli6      TYPE c,
        kunnr_re   LIKE dd03l-fieldname,
        deli7      TYPE c,
        parvw_rg     LIKE dd03l-fieldname,
        deli8      TYPE c,
        kunnr_rg     LIKE dd03l-fieldname,
        deli9      TYPE c,
        parvw_we     LIKE dd03l-fieldname,
        deli10      TYPE c,
        kunnr_we      LIKE dd03l-fieldname,
      END OF gt_dmr_p_c.

DATA: BEGIN OF gt_dmr_p OCCURS 0,
        aufnr      LIKE aufk-aufnr,
        deli1      TYPE c,
        vbeln      LIKE qmfe-qmnum,
        deli2      TYPE c,
        posnr      LIKE qmfe-fenum,
        deli3      TYPE c,
        parvw_ag   LIKE vbpa-parvw,
        deli4      TYPE c,
        kunnr_ag   LIKE vbpa-kunnr,
        deli5      TYPE c,
        parvw_re   LIKE vbpa-parvw,
        deli6      TYPE c,
        kunnr_re   LIKE vbpa-kunnr,
        deli7      TYPE c,
        parvw_rg     LIKE vbpa-parvw,
        deli8      TYPE c,
        kunnr_rg     LIKE vbpa-kunnr,
        deli9      TYPE c,
        parvw_we   LIKE vbpa-parvw,
        deli10      TYPE c,
        kunnr_we   LIKE vbpa-kunnr,
      END OF gt_dmr_p.

DATA: BEGIN OF gt_dmr_h_c OCCURS 0,
  aufnr      LIKE dd03l-fieldname,
  deli1      TYPE c,
  ffprf      LIKE dd03l-fieldname,
  deli2      TYPE c,
  vbtyp      LIKE dd03l-fieldname,
  deli3      TYPE c,
  audat      LIKE dd03l-fieldname,
  deli4      TYPE c,
  kprgbz     LIKE dd03l-fieldname,
  deli5      TYPE c,
  vdatu      LIKE dd03l-fieldname,
  deli6      TYPE c,
  autlf      LIKE dd03l-fieldname,
  deli7      TYPE c,
  auart      LIKE dd03l-fieldname,
  deli8      TYPE c,
  augru      LIKE dd03l-fieldname,
  deli9      TYPE c,
  lifsk      LIKE dd03l-fieldname,
  deli10     TYPE c,
  faksk      LIKE dd03l-fieldname,
  deli11     TYPE c,
  waerk      LIKE dd03l-fieldname,
  deli12     TYPE c,
  guebg      LIKE dd03l-fieldname,
  deli13     TYPE c,
  gueen      LIKE dd03l-fieldname,
  deli14     TYPE c,
  knumv      LIKE dd03l-fieldname,
  deli15     TYPE c,
  vprgr      LIKE dd03l-fieldname,
  deli16     TYPE c,
  vbkla      LIKE dd03l-fieldname,
  deli17     TYPE c,
  vbklt      LIKE dd03l-fieldname,
  deli18     TYPE c,
  vsbed      LIKE dd03l-fieldname,
  deli19     TYPE c,
  fkara      LIKE dd03l-fieldname,
  deli20     TYPE c,
  bstnk      LIKE dd03l-fieldname,
  deli21     TYPE c,
  bstdk      LIKE dd03l-fieldname,
  deli22     TYPE c,
  prsdt      LIKE dd03l-fieldname,
  deli23     TYPE c,
  zterm      LIKE dd03l-fieldname,
  deli24     TYPE c,
  inco1      LIKE dd03l-fieldname,
  deli25     TYPE c,
  inco2      LIKE dd03l-fieldname,
  deli26     TYPE c,
  kunnr      LIKE dd03l-fieldname,
  deli27     TYPE c,
  kvgr4      LIKE dd03l-fieldname,
  deli28     TYPE c,
  vbeln      LIKE dd03l-fieldname,
END OF gt_dmr_h_c.


DATA: BEGIN OF gt_dmr_h OCCURS 0,
  aufnr      LIKE aufk-aufnr,
  deli1      TYPE c,
  ffprf      LIKE pmsdo-ffprf,
  deli2      TYPE c,
  vbtyp      LIKE vbak-vbtyp,
  deli3      TYPE c,
  audat      LIKE vbak-audat,
  deli4      TYPE c,
  kprgbz     LIKE tvak-kprgbz,
  deli5      TYPE c,
  vdatu      LIKE vbak-vdatu,
  deli6      TYPE c,
  autlf      TYPE vbak-autlf,
  deli7      TYPE c,
  auart      TYPE vbak-auart,
  deli8      TYPE c,
  augru      LIKE vbak-augru,
  deli9      TYPE c,
  lifsk      LIKE vbak-lifsk,
  deli10      TYPE c,
  faksk      LIKE vbak-faksk,
  deli11      TYPE c,
  waerk      LIKE vbak-waerk,
  deli12     TYPE c,
  guebg      LIKE vbak-guebg,
  deli13     TYPE c,
  gueen      LIKE vbak-gueen,
  deli14     TYPE c,
  knumv      LIKE vbak-knumv,
  deli15     TYPE c,
  vprgr      LIKE vbak-vprgr,
  deli16     TYPE c,
  vbkla      LIKE vbak-vbkla,
  deli17     TYPE c,
  vbklt      LIKE vbak-vbklt,
  deli18     TYPE c,
  vsbed      LIKE vbak-vsbed,
  deli19     TYPE c,
  fkara      LIKE vbak-fkara,
  deli20     TYPE c,
  bstnk      LIKE vbak-bstnk,
  deli21     TYPE c,
  bstdk      LIKE vbak-bstdk,
  deli22     TYPE c,
  prsdt      LIKE vbkd-prsdt,
  deli23     TYPE c,
  zterm      LIKE vbkd-zterm,
  deli24     TYPE c,
  inco1      LIKE vbkd-inco1,
  deli25     TYPE c,
  inco2      LIKE vbkd-inco2,
  deli26     TYPE c,
  kunnr      LIKE vbak-kunnr,
  deli27     TYPE c,
  kvgr4      LIKE vbak-kvgr4,
  deli28     TYPE c,
  vbeln      LIKE vbak-vbeln,
END OF gt_dmr_h.

DATA: BEGIN OF gt_dmr_h2 OCCURS 0,
  aufnr      LIKE aufk-aufnr,
  deli1      TYPE c,
  ffprf      LIKE pmsdo-ffprf,
  deli2      TYPE c,
  vbtyp      LIKE vbak-vbtyp,
  deli3      TYPE c,
  audat      LIKE vbak-audat,
  deli4      TYPE c,
  kprgbz     LIKE tvak-kprgbz,
  deli5      TYPE c,
  vdatu      LIKE vbak-vdatu,
  deli6      TYPE c,
  autlf      TYPE vbak-autlf,
  deli7      TYPE c,
  auart      TYPE vbak-auart,
  deli8      TYPE c,
  augru      LIKE vbak-augru,
  deli9      TYPE c,
  lifsk      LIKE vbak-lifsk,
  deli10     TYPE c,
  faksk      LIKE vbak-faksk,
  deli11     TYPE c,
  waerk      LIKE vbak-waerk,
  deli12     TYPE c,
  guebg      LIKE vbak-guebg,
  deli13     TYPE c,
  gueen      LIKE vbak-gueen,
  deli14     TYPE c,
  knumv      LIKE vbak-knumv,
  deli15     TYPE c,
  vprgr      LIKE vbak-vprgr,
  deli16     TYPE c,
  vbkla      LIKE vbak-vbkla,
  deli17     TYPE c,
  vbklt      LIKE vbak-vbklt,
  deli18     TYPE c,
  vsbed      LIKE vbak-vsbed,
  deli19     TYPE c,
  fkara      LIKE vbak-fkara,
  deli20     TYPE c,
  bstnk      LIKE vbak-bstnk,
  deli21     TYPE c,
  bstdk      LIKE vbak-bstdk,
  deli22     TYPE c,
  prsdt      LIKE vbkd-prsdt,
  deli23     TYPE c,
  zterm      LIKE vbkd-zterm,
  deli24     TYPE c,
  inco1      LIKE vbkd-inco1,
  deli25     TYPE c,
  inco2      LIKE vbkd-inco2,
  deli26     TYPE c,
  kunnr      LIKE vbak-kunnr,
  deli27     TYPE c,
  kvgr4      LIKE vbak-kvgr4,
  deli28     TYPE c,
  vbeln      LIKE vbak-vbeln,
  objnr      LIKE viaufkst-objnr,
END OF gt_dmr_h2.

DATA: BEGIN OF gt_dmr_l1_c OCCURS 0,
        aufnr      LIKE dd03l-fieldname,
        deli1      TYPE c,
        vbeln      LIKE dd03l-fieldname,
        deli2      TYPE c,
        spras      TYPE dd03l-fieldname,
        deli3      TYPE c,
        tdformat   TYPE dd03l-fieldname,
        deli4      TYPE c,
        tdline     TYPE dd03l-fieldname,
        deli5      TYPE c,
        line       TYPE dd03l-fieldname,
      END OF gt_dmr_l1_c.

DATA: BEGIN OF gt_dmr_l1 OCCURS 0,
        aufnr      LIKE aufk-aufnr,
        deli1      TYPE c,
        vbeln      LIKE vbak-vbeln,
        deli2      TYPE c,
        spras      TYPE tdspras,
        deli3      TYPE c,
        tdformat   TYPE tdformat,
        deli4      TYPE c,
        tdline     TYPE tdline,
        deli5      TYPE c,
        line       TYPE tdlineno,
      END OF gt_dmr_l1.

DATA: BEGIN OF gt_dmr_l2_c OCCURS 0,
        aufnr      LIKE dd03l-fieldname,
        deli1      TYPE c,
        vbeln      LIKE dd03l-fieldname,
        deli2      TYPE c,
        spras      TYPE dd03l-fieldname,
        deli3      TYPE c,
        tdformat   TYPE dd03l-fieldname,
        deli4      TYPE c,
        tdline     TYPE dd03l-fieldname,
        deli5      TYPE c,
        line       TYPE dd03l-fieldname,
      END OF gt_dmr_l2_c.

DATA: BEGIN OF gt_dmr_l2 OCCURS 0,
        aufnr      LIKE aufk-aufnr,
        deli1      TYPE c,
        vbeln      LIKE vbak-vbeln,
        deli2      TYPE c,
        spras      TYPE tdspras,
        deli3      TYPE c,
        tdformat   TYPE tdformat,
        deli4      TYPE c,
        tdline     TYPE tdline,
        deli5      TYPE c,
        line       TYPE tdlineno,
      END OF gt_dmr_l2.

DATA: BEGIN OF gt_dmr_l_c OCCURS 0,
        aufnr      LIKE dd03l-fieldname,
        deli1      TYPE c,
        vbeln      LIKE dd03l-fieldname,
        deli2      TYPE c,
        spras      TYPE dd03l-fieldname,
        deli3      TYPE c,
        tdformat   TYPE dd03l-fieldname,
        deli4      TYPE c,
        tdline     TYPE dd03l-fieldname,
        deli5      TYPE c,
        line       TYPE dd03l-fieldname,
      END OF gt_dmr_l_c.

DATA: BEGIN OF gt_dmr_l OCCURS 0,
        aufnr      LIKE aufk-aufnr,
        deli1      TYPE c,
        vbeln      LIKE vbak-vbeln,
        deli2      TYPE c,
        spras      TYPE tdspras,
        deli3      TYPE c,
        tdformat   TYPE tdformat,
        deli4      TYPE c,
        tdline     TYPE tdline,
        deli5      TYPE c,
        line       TYPE tdlineno,
      END OF gt_dmr_l.

DATA: lv_atinn  TYPE atinn,
      lv_mpobj  LIKE imptt-mpobj,
      lv1_point LIKE imptt-point,
      lv_index TYPE sy-tabix.

DATA: h_stat_flag,
      lv_objnr_ord LIKE aufk-objnr,
      ls_pmsdo TYPE pmsdo,
      ls_iloan TYPE iloa.

*------------------------------------------------------------------
* Variables
DATA: lt_viqmfe TYPE TABLE OF wqmfe,
      ls_viqmfe TYPE wqmfe,
      lt_viqmur TYPE TABLE OF wqmur,
      ls_viqmur TYPE wqmur,
      es_viqmel TYPE viqmel,
      lt_longtxt TYPE TABLE OF alm_me_longtext,
      ls_longtxt TYPE alm_me_longtext,
      lt_longtxt_item TYPE TABLE OF alm_me_longtext.

DATA  gv_werks TYPE werks.

DATA: g_directory(25) TYPE c VALUE '/var/load/xxx/UK/read/',
      g_ofile         LIKE /sapdmc/lsoinp-filename,
      p_logsys        LIKE tbdlst-logsys.

FIELD-SYMBOLS: <gs_value>  TYPE ibco2_value_rec.

TABLES: qmel.
DATA   lv_line TYPE i.
DATA:  lv_kdauf TYPE kdauf,
       lv_kdpos TYPE kdpos,
       lv_plnnr TYPE mpos-plnnr,
       lv_plnal TYPE mpos-plnal,
       lv_plnty TYPE mpos-plnty,
       lv_pstxt TYPE mpos-pstxt,
       lv_vbeln TYPE vbeln,
       lv_vbeln_dmr TYPE vbeln,
       lv_waerk TYPE waerk,
       lv_netwr TYPE netwr.
DATA  lv_kprgbz TYPE tvak-kprgbz.


************************************************************************
*       S E L E C T - O P T I O N S / P A R A M E T E R S              *
************************************************************************
SELECTION-SCREEN : BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
PARAMETERS:     p_werks  TYPE aufk-werks MEMORY ID wrk.
SELECT-OPTIONS: s_aufnr  FOR  aufk-aufnr.
SELECT-OPTIONS: s_auart  FOR  aufk-auart.
SELECT-OPTIONS: s_erdat  FOR  aufk-erdat.
SELECT-OPTIONS: s_aedat  FOR  aufk-aedat.
SELECT-OPTIONS: s_vtweg  FOR  knvv-vtweg.
PARAMETERS:     p_bukrs  TYPE aufk-bukrs OBLIGATORY MEMORY ID buk,
                p_vkorg  TYPE knvv-vkorg MEMORY ID vko.

PARAMETERS:     h_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\dmr_Header',
                p_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\dmr_Partners',
                l_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\dmr_Header_note',
                l1_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\dmr_Header_note1',
                l2_filet  LIKE rlgrap-filename
                    DEFAULT 'C:\SAP\dmr_Header_note2'.

*PARAMETERS:     o_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\dmr_Operations'.
*PARAMETERS:     p_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\dmr_Parts_Ordered'.
*PARAMETERS:     l1_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\dmr_header_longtext'.
*PARAMETERS:     l2_filet  LIKE rlgrap-filename
*                    DEFAULT 'C:\SAP\dmr_item_longtext'.
SELECTION-SCREEN: END OF BLOCK b1.

* Comment
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE text-002.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c01.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c02.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(72) text-c03.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK b2.

*.................. Selection screen validations...................... *
AT SELECTION-SCREEN ON p_werks.

IF p_werks IS NOT INITIAL.
* Check planning plant
  SELECT SINGLE werks
       INTO gv_werks
       FROM t001w
       WHERE werks = p_werks.

  IF sy-subrc <> 0.
*.. Planning plant does not exist
    MESSAGE e001(00) WITH text-e02.
  ENDIF.
ENDIF.


*- Initialization -----------------------------------------------------*
INITIALIZATION.

  CALL FUNCTION 'OWN_LOGICAL_SYSTEM_GET'
    IMPORTING
      own_logical_system             = p_logsys
    EXCEPTIONS
      own_logical_system_not_defined = 1
      OTHERS                         = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
         WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

************************************************************************
*       S T A R T - O F - S E L E C T I O N    E V E N T               *
************************************************************************
START-OF-SELECTION.

* Select all dmrications
*  SELECT qmnum objnr
*    INTO CORRESPONDING FIELDS OF TABLE gt_dmr
*    FROM viqmel
*    WHERE qmnum IN s_qmnum
*      AND qmart IN s_qmart
*      AND iwerk EQ p_iwerk .
*  SELECT *
*    INTO CORRESPONDING FIELDS OF TABLE gt_dmr_h2
*     FROM viaufkst
*     WHERE aufnr IN s_aufnr
*       AND auart IN s_auart
*       AND erdat IN s_erdat
*       AND aedat IN s_aedat
*       AND werks EQ p_werks
**       AND loekz NE 'X'
*       AND iphas NE '6'
*       AND vtweg IN s_vtweg.
  DATA: lv_where TYPE string.
  lv_where = 'aufnr IN s_aufnr AND auart IN s_auart AND erdat IN s_erdat AND aedat IN s_aedat AND bukrs EQ p_bukrs'.
  IF p_werks IS NOT INITIAL.
    CONCATENATE lv_where 'AND werks EQ p_werks' INTO lv_where SEPARATED BY space.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_where 'AND vkorg EQ p_vkorg' INTO lv_where SEPARATED BY space.
  ENDIF.
  CONCATENATE lv_where 'AND iphas NE ''6'' AND vtweg IN s_vtweg' INTO lv_where SEPARATED BY space.
  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE gt_dmr_h2
     FROM viaufkst
     WHERE (lv_where).

  PERFORM get_data.

  IF NOT gt_dmr_h2[] IS INITIAL.
    PERFORM download_files.
  ENDIF.


*&---------------------------------------------------------------------*
*&      Form  get_details
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_data.

  LOOP AT gt_dmr_h2.

    SELECT SINGLE * FROM pmsdo INTO CORRESPONDING FIELDS OF ls_pmsdo
     WHERE objnr = gt_dmr_h2-objnr.

    CLEAR: lv_sttxt, lv_sttxtu.

    CALL FUNCTION 'STATUS_TEXT_EDIT'
      EXPORTING
        objnr         = gt_dmr_h2-objnr
        spras         = sy-langu
        flg_user_stat = 'X'
        only_active   = 'X'
      IMPORTING
        line          = lv_sttxt
        user_line     = lv_sttxtu.

    IF lv_sttxt CS 'CLSD'.
      CONTINUE.
    ENDIF.
*   Detect quotation/DMR
    CLEAR: lv_netwr, lv_waerk, lv_vbeln, lv_vbeln_dmr.

    SELECT SINGLE netwr waerk vbeln
      FROM vbak INTO (lv_netwr, lv_waerk, lv_vbeln)
      WHERE aufnr = gt_dmr_h2-aufnr
            AND vbtyp = 'B'.
    IF sy-subrc = 0.
      SELECT SINGLE vbeln FROM vbfa INTO lv_vbeln_dmr
        WHERE vbelv = lv_vbeln
        AND vbtyp_n = 'L'.
      IF sy-subrc = 0.
        gt_dmr_h2-vbeln = lv_vbeln_dmr.
      ENDIF.
    ELSE.
      SELECT SINGLE netwr waerk vbeln
        FROM vbak INTO (lv_netwr, lv_waerk, lv_vbeln_dmr)
        WHERE aufnr = gt_dmr_h2-aufnr
              AND vbtyp = 'L'.
      IF sy-subrc = 0.
        gt_dmr_h2-vbeln = lv_vbeln_dmr.
      ENDIF.
    ENDIF.

    IF lv_vbeln_dmr IS NOT INITIAL.

      MOVE '|' TO: gt_dmr_h2-deli1, gt_dmr_h2-deli2, gt_dmr_h2-deli3,
                   gt_dmr_h2-deli4, gt_dmr_h2-deli5, gt_dmr_h2-deli6,
                   gt_dmr_h2-deli7, gt_dmr_h2-deli8, gt_dmr_h2-deli9,
                   gt_dmr_h2-deli10, gt_dmr_h2-deli11, gt_dmr_h2-deli12,
                   gt_dmr_h2-deli13, gt_dmr_h2-deli14, gt_dmr_h2-deli15,
                   gt_dmr_h2-deli16, gt_dmr_h2-deli17, gt_dmr_h2-deli18,
                   gt_dmr_h2-deli19, gt_dmr_h2-deli20, gt_dmr_h2-deli21,
                   gt_dmr_h2-deli22, gt_dmr_h2-deli23, gt_dmr_h2-deli24,
                   gt_dmr_h2-deli25, gt_dmr_h2-deli26, gt_dmr_h2-deli27,
                   gt_dmr_h2-deli28.

      MOVE '|' TO: gt_dmr_p-deli1, gt_dmr_p-deli2, gt_dmr_p-deli3,
                   gt_dmr_p-deli4, gt_dmr_p-deli5, gt_dmr_p-deli6,
                   gt_dmr_p-deli7, gt_dmr_p-deli8, gt_dmr_p-deli9,
                   gt_dmr_p-deli10.

      MOVE '|' TO: gt_dmr_l-deli1, gt_dmr_l-deli2, gt_dmr_l-deli3, gt_dmr_l-deli4, gt_dmr_l-deli5.

      MOVE '|' TO: gt_dmr_l1-deli1, gt_dmr_l1-deli2, gt_dmr_l1-deli3, gt_dmr_l1-deli4, gt_dmr_l1-deli5.

      MOVE '|' TO: gt_dmr_l2-deli1, gt_dmr_l2-deli2, gt_dmr_l2-deli3, gt_dmr_l2-deli4, gt_dmr_l2-deli5.

      MOVE-CORRESPONDING gt_dmr_h2 TO gt_dmr_h.

      CLEAR ls_vbak.
      SELECT SINGLE * FROM vbak INTO CORRESPONDING FIELDS OF ls_vbak
        WHERE vbeln = lv_vbeln_dmr.

      CLEAR ls_vbkd.
      SELECT SINGLE prsdt zterm inco1 inco2 INTO CORRESPONDING FIELDS OF ls_vbkd
       FROM vbkd
       WHERE vbeln = lv_vbeln_dmr
         AND posnr = c_000000.

      CLEAR lv_kprgbz.

      SELECT SINGLE kprgbz FROM tvak INTO lv_kprgbz
        WHERE auart = ls_vbak-auart.

      gt_dmr_h-ffprf = ls_pmsdo-ffprf.

      gt_dmr_h-vbtyp = ls_vbak-vbtyp.
      gt_dmr_h-audat = ls_vbak-audat.
      gt_dmr_h-kprgbz =    lv_kprgbz.
      gt_dmr_h-vdatu  =    ls_vbak-vdatu.
      gt_dmr_h-autlf  =    ls_vbak-autlf.
      gt_dmr_h-auart  =    ls_vbak-auart.
      gt_dmr_h-augru  =    ls_vbak-augru.
      gt_dmr_h-lifsk =     ls_vbak-lifsk.
      gt_dmr_h-faksk =     ls_vbak-faksk.
      gt_dmr_h-guebg =     ls_vbak-guebg.
      gt_dmr_h-gueen =     ls_vbak-gueen.
      gt_dmr_h-knumv =     ls_vbak-knumv.
      gt_dmr_h-vprgr =     ls_vbak-vprgr.
      gt_dmr_h-vbkla =     ls_vbak-vbkla.
      gt_dmr_h-vbklt =     ls_vbak-vbklt.
      gt_dmr_h-waerk = ls_vbak-waerk.
      gt_dmr_h-vsbed = ls_vbak-vsbed.
      gt_dmr_h-fkara = ls_vbak-fkara.
      gt_dmr_h-bstnk = ls_vbak-bstnk.
      gt_dmr_h-bstdk = ls_vbak-bstdk.
      gt_dmr_h-kunnr = ls_vbak-kunnr.
      gt_dmr_h-kvgr4 = ls_vbak-kvgr4.
      gt_dmr_h-prsdt = ls_vbkd-prsdt.
      gt_dmr_h-zterm = ls_vbkd-zterm.
      gt_dmr_h-inco1 = ls_vbkd-inco1.
      gt_dmr_h-inco2 = ls_vbkd-inco2.

      SELECT SINGLE kunnr parvw INTO (gt_dmr_p-kunnr_ag, gt_dmr_p-parvw_ag)
         FROM vbpa
         WHERE vbeln = gt_dmr_h-vbeln
           AND posnr = c_000000
           AND parvw = c_ag.

      SELECT SINGLE kunnr parvw INTO (gt_dmr_p-kunnr_re, gt_dmr_p-parvw_re)
         FROM vbpa
         WHERE vbeln = gt_dmr_h-vbeln
           AND posnr = c_000000
           AND parvw = c_re.

      SELECT SINGLE kunnr parvw INTO (gt_dmr_p-kunnr_rg, gt_dmr_p-parvw_rg)
         FROM vbpa
         WHERE vbeln = gt_dmr_h-vbeln
           AND posnr = c_000000
           AND parvw = c_rg.

      SELECT SINGLE kunnr parvw INTO (gt_dmr_p-kunnr_we, gt_dmr_p-parvw_we)
         FROM vbpa
         WHERE vbeln = gt_dmr_h-vbeln
           AND posnr = c_000000
           AND parvw = c_we.

      gt_dmr_p-aufnr =  gt_dmr_h-aufnr.
      gt_dmr_p-vbeln =  gt_dmr_h-vbeln.
      gt_dmr_p-posnr =  c_000000.
      gt_dmr_l-aufnr =  gt_dmr_h-aufnr.
      gt_dmr_l-vbeln =  gt_dmr_h-vbeln.
      gt_dmr_l1-aufnr =  gt_dmr_h-aufnr.
      gt_dmr_l1-vbeln =  gt_dmr_h-vbeln.
      gt_dmr_l2-aufnr =  gt_dmr_h-aufnr.
      gt_dmr_l2-vbeln =  gt_dmr_h-vbeln.

      SELECT tdname tdid tdspras
             INTO TABLE gt_stxh
             FROM stxh
             WHERE tdobject = 'VBBK'
               AND tdname   = gt_dmr_h-vbeln.

      LOOP AT gt_stxh.

        IF gt_stxh-tdid = '0001'.
          CALL FUNCTION 'READ_TEXT'
            EXPORTING
              id                      = '0001'
              language                = gt_stxh-tdspras
              name                    = gt_stxh-tdname
              object                  = 'VBBK'
            TABLES
              lines                   = i_lines
            EXCEPTIONS
              id                      = 1
              language                = 2
              name                    = 3
              not_found               = 4
              object                  = 5
              reference_check         = 6
              wrong_access_to_archive = 7
              OTHERS                  = 8.
          IF sy-subrc = 0.
            LOOP AT i_lines.
              gt_dmr_l-tdformat = i_lines-tdformat.
              gt_dmr_l-tdline = i_lines-tdline.
              gt_dmr_l-spras = gt_stxh-tdspras.
              gt_dmr_l-line = sy-tabix.
              APPEND gt_dmr_l.
            ENDLOOP.
          ENDIF.

        ELSEIF gt_stxh-tdid = '0002'.

          CALL FUNCTION 'READ_TEXT'
            EXPORTING
              id                      = '0002'
              language                = gt_stxh-tdspras
              name                    = gt_stxh-tdname
              object                  = 'VBBK'
            TABLES
              lines                   = i_lines
            EXCEPTIONS
              id                      = 1
              language                = 2
              name                    = 3
              not_found               = 4
              object                  = 5
              reference_check         = 6
              wrong_access_to_archive = 7
              OTHERS                  = 8.
          IF sy-subrc = 0.
            LOOP AT i_lines.
              gt_dmr_l1-tdformat = i_lines-tdformat.
              gt_dmr_l1-tdline = i_lines-tdline.
              gt_dmr_l1-spras = gt_stxh-tdspras.
              gt_dmr_l1-line = sy-tabix.
              APPEND gt_dmr_l1.
            ENDLOOP.
          ENDIF.

        ELSEIF gt_stxh-tdid = '0003'.

          CALL FUNCTION 'READ_TEXT'
            EXPORTING
              id                      = '0003'
              language                = gt_stxh-tdspras
              name                    = gt_stxh-tdname
              object                  = 'VBBK'
            TABLES
              lines                   = i_lines
            EXCEPTIONS
              id                      = 1
              language                = 2
              name                    = 3
              not_found               = 4
              object                  = 5
              reference_check         = 6
              wrong_access_to_archive = 7
              OTHERS                  = 8.
          IF sy-subrc = 0.
            LOOP AT i_lines.
              gt_dmr_l2-tdformat = i_lines-tdformat.
              gt_dmr_l2-tdline = i_lines-tdline.
              gt_dmr_l2-spras = gt_stxh-tdspras.
              gt_dmr_l2-line = sy-tabix.
              APPEND gt_dmr_l2.
            ENDLOOP.
          ENDIF.

        ENDIF.

      ENDLOOP.

      APPEND gt_dmr_p.
      APPEND gt_dmr_h.

    ENDIF.

  ENDLOOP.

ENDFORM.                    "get_data

*&---------------------------------------------------------------------*
*&      Form  download_files
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_files.

  DATA: file TYPE string.
  DATA: lv_selections TYPE string.

  lv_selections = p_bukrs.
  IF p_werks IS NOT INITIAL.
    CONCATENATE lv_selections p_werks INTO lv_selections SEPARATED BY '_'.
  ENDIF.
  IF p_vkorg IS NOT INITIAL.
    CONCATENATE lv_selections p_vkorg INTO lv_selections SEPARATED BY '_'.
  ENDIF.


  PERFORM header_fill.

  IF sy-batch = 'X'.
    REPLACE 'xxx' IN g_directory WITH p_logsys(3).

*   Header
*    CONCATENATE g_directory c_rec_h '_' p_werks '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_h '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_dmr_h_c.
      TRANSFER gt_dmr_h_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_dmr_h.
      TRANSFER gt_dmr_h TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Partners
*    CONCATENATE g_directory c_rec_p '_' p_werks '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_p '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_dmr_p_c.
      TRANSFER gt_dmr_p_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_dmr_p.
      TRANSFER gt_dmr_p TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Header note
*    CONCATENATE g_directory c_rec_l '_' p_werks '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_l '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_dmr_l_c.
      TRANSFER gt_dmr_l_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_dmr_l.
      TRANSFER gt_dmr_l TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Header note1
*    CONCATENATE g_directory c_rec_l1 '_' p_werks '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_l1 '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_dmr_l1_c.
      TRANSFER gt_dmr_l1_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_dmr_l1.
      TRANSFER gt_dmr_l1 TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.
***
*   Header note2
*    CONCATENATE g_directory c_rec_l2 '_' p_werks '_' syst-datlo syst-timlo INTO g_ofile.
    CONCATENATE g_directory c_rec_l2 '_' lv_selections '_' syst-datlo syst-timlo INTO g_ofile.

    OPEN DATASET g_ofile FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc <> 0.
      WRITE: / text-e04, g_ofile.
      EXIT.
    ENDIF.

    LOOP AT gt_dmr_l2_c.
      TRANSFER gt_dmr_l2_c TO g_ofile.
    ENDLOOP.

    LOOP AT gt_dmr_l2.
      TRANSFER gt_dmr_l2 TO g_ofile.
    ENDLOOP.

    CLOSE DATASET g_ofile.
    IF sy-subrc <> 0.
      WRITE: / text-e05, g_ofile.
      EXIT.
    ENDIF.

  ELSE.

    file = h_filet.
*    CONCATENATE file '_' p_werks '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_h_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_h
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = p_filet.
*    CONCATENATE file '_' p_werks '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_p_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_p
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = l_filet.
*    CONCATENATE file '_' p_werks '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_l_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_l
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = l1_filet.
*    CONCATENATE file '_' p_werks '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_l1_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_l1
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.
***
    file = l2_filet.
*    CONCATENATE file '_' p_werks '_' syst-datlo syst-timlo '.txt' INTO file.
    CONCATENATE file '_' lv_selections '_' syst-datlo syst-timlo '.txt' INTO file.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = ' '
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_l2_c
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

    CALL FUNCTION 'GUI_DOWNLOAD'
      EXPORTING
        filename                = file
        append                  = 'X'
        filetype                = 'DAT'
        write_field_separator   = 'X'
      TABLES
        data_tab                = gt_dmr_l2
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        OTHERS                  = 22.

  ENDIF.

ENDFORM.                    "download_file

*&---------------------------------------------------------------------*
*&      Form  header_fill
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM header_fill.

  MOVE '|' TO: gt_dmr_h_c-deli1, gt_dmr_h_c-deli2, gt_dmr_h_c-deli3,
               gt_dmr_h_c-deli4, gt_dmr_h_c-deli5, gt_dmr_h_c-deli6,
               gt_dmr_h_c-deli7, gt_dmr_h_c-deli8, gt_dmr_h_c-deli9,
               gt_dmr_h_c-deli10, gt_dmr_h_c-deli11, gt_dmr_h_c-deli12,
               gt_dmr_h_c-deli13, gt_dmr_h_c-deli14, gt_dmr_h_c-deli15,
               gt_dmr_h_c-deli16, gt_dmr_h_c-deli17, gt_dmr_h_c-deli18,
               gt_dmr_h_c-deli19, gt_dmr_h_c-deli20, gt_dmr_h_c-deli21,
               gt_dmr_h_c-deli22, gt_dmr_h_c-deli23, gt_dmr_h_c-deli24,
               gt_dmr_h_c-deli25, gt_dmr_h_c-deli26, gt_dmr_h_c-deli27,
               gt_dmr_h_c-deli28.

  gt_dmr_h_c-aufnr = 'AUFNR'.
  gt_dmr_h_c-ffprf = 'FFPRF'.
  gt_dmr_h_c-vbtyp = 'VBTYP'.
  gt_dmr_h_c-audat = 'AUDAT'.
  gt_dmr_h_c-kprgbz = 'KPRGBZ'.
  gt_dmr_h_c-vdatu = 'VDATU'.
  gt_dmr_h_c-autlf = 'AUTLF'.
  gt_dmr_h_c-auart = 'AUART'.
  gt_dmr_h_c-augru = 'AUGRU'.
  gt_dmr_h_c-lifsk = 'LIFSK'.
  gt_dmr_h_c-faksk = 'FAKSK'.
  gt_dmr_h_c-waerk = 'WAERK'.
  gt_dmr_h_c-guebg = 'GUEBG'.
  gt_dmr_h_c-gueen = 'GUEEN'.
  gt_dmr_h_c-knumv = 'KNUMV'.
  gt_dmr_h_c-vprgr = 'VPRGR'.
  gt_dmr_h_c-vbkla = 'VBKLA'.
  gt_dmr_h_c-vbklt = 'VBKLT'.
  gt_dmr_h_c-vsbed = 'VSBED'.
  gt_dmr_h_c-fkara = 'FKARA'.
  gt_dmr_h_c-bstnk = 'BSTNK'.
  gt_dmr_h_c-bstdk = 'BSTDK'.
  gt_dmr_h_c-prsdt = 'PRSDT'.
  gt_dmr_h_c-zterm = 'ZTERM'.
  gt_dmr_h_c-inco1 = 'INCO1'.
  gt_dmr_h_c-inco2 = 'INCO2'.
  gt_dmr_h_c-kunnr = 'KUNNR'.
  gt_dmr_h_c-kvgr4 = 'KVGR4'.
  gt_dmr_h_c-vbeln = 'VBELN'.
  APPEND gt_dmr_h_c.

  gt_dmr_h_c-aufnr = 'Serv. Order'.
  gt_dmr_h_c-ffprf = 'Profile'.
  gt_dmr_h_c-vbtyp = 'Cat.'.
  gt_dmr_h_c-audat = 'Doc. Date'.
  gt_dmr_h_c-kprgbz = 'Type'.
  gt_dmr_h_c-vdatu = 'Req. Deliv.'.
  gt_dmr_h_c-autlf = 'Compl.Del.'.
  gt_dmr_h_c-auart = 'Doc.Type'.
  gt_dmr_h_c-augru = 'Reason'.
  gt_dmr_h_c-lifsk = 'Del. Blck'.
  gt_dmr_h_c-faksk = 'Bill. Blck'.
  gt_dmr_h_c-waerk = 'Curr.'.
  gt_dmr_h_c-guebg = 'Valid-From'.
  gt_dmr_h_c-gueen = 'Valid-To'.
  gt_dmr_h_c-knumv = 'Doc. Cond.'.
  gt_dmr_h_c-vprgr = 'Date Type'.
  gt_dmr_h_c-vbkla = 'Orig. Syst.'.
  gt_dmr_h_c-vbklt = 'Ind.'.
  gt_dmr_h_c-vsbed = 'Shipp. Cond.'.
  gt_dmr_h_c-fkara = 'Bill.Type'.
  gt_dmr_h_c-bstnk = 'Cust. PO No.'.
  gt_dmr_h_c-bstdk = 'PO Date'.
  gt_dmr_h_c-prsdt = 'Pric. Date'.
  gt_dmr_h_c-zterm = 'Paym. Terms'.
  gt_dmr_h_c-inco1 = 'Incoterms (1)'.
  gt_dmr_h_c-inco2 = 'Incoterms (2)'.
  gt_dmr_h_c-kunnr = 'Sold-to'.
  gt_dmr_h_c-kvgr4 = 'Cust.Gr.4'.
  gt_dmr_h_c-vbeln = 'DMR'.
  APPEND gt_dmr_h_c.


  MOVE '|' TO: gt_dmr_p_c-deli1, gt_dmr_p_c-deli2, gt_dmr_p_c-deli3,
               gt_dmr_p_c-deli4, gt_dmr_p_c-deli5, gt_dmr_p_c-deli6,
               gt_dmr_p_c-deli7, gt_dmr_p_c-deli8, gt_dmr_p_c-deli9,
               gt_dmr_p_c-deli10.

  gt_dmr_p_c-aufnr = 'AUFNR'.
  gt_dmr_p_c-vbeln = 'VBELN'.
  gt_dmr_p_c-posnr = 'POSNR'.
  gt_dmr_p_c-parvw_ag = 'PARVW_AG'.
  gt_dmr_p_c-kunnr_ag = 'KUNNR_AG'.
  gt_dmr_p_c-parvw_re = 'PARVW_RE'.
  gt_dmr_p_c-kunnr_re = 'KUNNR_RE'.
  gt_dmr_p_c-parvw_rg = 'PARVW_RG'.
  gt_dmr_p_c-kunnr_rg = 'KUNNR_RG'.
  gt_dmr_p_c-parvw_we = 'PARVW_WE'.
  gt_dmr_p_c-kunnr_we = 'KUNNR_WE'.
  APPEND gt_dmr_p_c.

  gt_dmr_p_c-aufnr    = 'Serv. Order'.
  gt_dmr_p_c-vbeln    = 'DMR'.
  gt_dmr_p_c-posnr    = 'Item'.
  gt_dmr_p_c-parvw_ag = 'AG'.
  gt_dmr_p_c-kunnr_ag = 'Sold-to'.
  gt_dmr_p_c-parvw_re = 'RE'.
  gt_dmr_p_c-kunnr_re = 'Bill-to'.
  gt_dmr_p_c-parvw_rg = 'RG'.
  gt_dmr_p_c-kunnr_rg = 'Payer'.
  gt_dmr_p_c-parvw_we = 'WE'.
  gt_dmr_p_c-kunnr_we = 'Ship-to'.
  APPEND gt_dmr_p_c.


  MOVE '|' TO: gt_dmr_l_c-deli1, gt_dmr_l_c-deli2, gt_dmr_l_c-deli3, gt_dmr_l_c-deli4, gt_dmr_l_c-deli5.

  gt_dmr_l_c-aufnr = 'AUFNR'.
  gt_dmr_l_c-vbeln = 'VBELN'.
  gt_dmr_l_c-spras = 'SPRAS'.
  gt_dmr_l_c-tdformat = 'TDFORMAT'.
  gt_dmr_l_c-tdline = 'TDLINE'.
  gt_dmr_l_c-line   = 'LINE.'.
  APPEND gt_dmr_l_c.

  gt_dmr_l_c-aufnr    = 'Serv. Order'.
  gt_dmr_l_c-vbeln    = 'DMR'.
  gt_dmr_l_c-spras    = 'Lang.'.
  gt_dmr_l_c-tdformat = 'Form.'.
  gt_dmr_l_c-tdline   = 'Text Line'.
  gt_dmr_l_c-line   = 'Line Nbr.'.
  APPEND gt_dmr_l_c.


  MOVE '|' TO: gt_dmr_l1_c-deli1, gt_dmr_l1_c-deli2, gt_dmr_l1_c-deli3, gt_dmr_l1_c-deli4, gt_dmr_l1_c-deli5.

  gt_dmr_l1_c-aufnr = 'AUFNR'.
  gt_dmr_l1_c-vbeln = 'VBELN'.
  gt_dmr_l1_c-spras = 'SPRAS'.
  gt_dmr_l1_c-tdformat = 'TDFORMAT'.
  gt_dmr_l1_c-tdline = 'TDLINE'.
  gt_dmr_l1_c-line   = 'LINE'.
  APPEND gt_dmr_l1_c.

  gt_dmr_l1_c-aufnr    = 'Serv. Order'.
  gt_dmr_l1_c-vbeln    = 'DMR'.
  gt_dmr_l1_c-spras    = 'Lang.'.
  gt_dmr_l1_c-tdformat = 'Form.'.
  gt_dmr_l1_c-tdline   = 'Text Line'.
  gt_dmr_l1_c-line   = 'Line Nbr.'.
  APPEND gt_dmr_l1_c.


  MOVE '|' TO: gt_dmr_l2_c-deli1, gt_dmr_l2_c-deli2, gt_dmr_l2_c-deli3, gt_dmr_l2_c-deli4, gt_dmr_l2_c-deli5.

  gt_dmr_l2_c-aufnr = 'AUFNR'.
  gt_dmr_l2_c-vbeln = 'VBELN'.
  gt_dmr_l2_c-spras = 'SPRAS'.
  gt_dmr_l2_c-tdformat = 'TDFORMAT'.
  gt_dmr_l2_c-tdline = 'TDLINE'.
  gt_dmr_l2_c-line   = 'LINE'.
  APPEND gt_dmr_l2_c.

  gt_dmr_l2_c-aufnr    = 'Serv. Order'.
  gt_dmr_l2_c-vbeln    = 'DMR'.
  gt_dmr_l2_c-spras    = 'Lang.'.
  gt_dmr_l2_c-tdformat = 'Form.'.
  gt_dmr_l2_c-tdline   = 'Text Line'.
  gt_dmr_l2_c-line   = 'Line Nbr.'.
  APPEND gt_dmr_l2_c.

ENDFORM.                    "header_fill

*Text symbol text£º
*001:Selection Screen Input
*002:Remarks
*C01:* If started in background, files are stored on the application server
*C02:* /var/load/xxx/UK/read/
*C03:* xxx = logical system
*E02:Planning plant does not exist
*E03:No authorization for plant :
*E04:Open dataset failed for :
*E05:Close dataset failed for :
*I01:No maintenance plans selected !
*I02:No variant table for Central Task Lists found (CU60)

*I03:Could not find caracteristic :
*Selection text£º
*H_FILET:        Filename Notification Header
*L1_FILET:        Filename Header note 1
*L2_FILET:        Filename Header note 2
*L_FILET:        Filename Header note
*P_BUKRS:D       .
*P_FILET:        Partners
*P_VKORG:D       .
*P_WERKS:        Plant
*S_AEDAT:        Date of last change
*S_AUART:        Order Type
*S_AUFNR:        Order Number
*S_ERDAT:        Creation Date
*S_VTWEG:D       .
