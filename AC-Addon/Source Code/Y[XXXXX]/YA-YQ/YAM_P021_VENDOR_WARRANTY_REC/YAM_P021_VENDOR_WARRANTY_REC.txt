*----------------------------------------------------------------------*
* PROGRAM ID           : YAM_P021_VENDOR_WARRANTY_REC                  *
* PROGRAM TITLE        : Vendor Warranty Recovery Report               *
* AUTHOR               : Amit Mahajan                                  *
* DATE                 : 20/10/2004                                    *
* DEVELOPMENT ID       : XXXX                                          *
*
* CHANGE REQUEST NUMBER:                                               *
* PROGRAM DESCRIPTION  : THIS REPORT IS A COPY OF IW47 TRANSACTION,AS  *
* PER THE CUSTOMER REQUIREMENT,SOME ADDITIONAL INORMATION IS NEED ON   *
* THE OUTPUT SCREEN AND INPUT SCREEN                                   *
* INPUT SCREEN: COMPANY CODE AND ACCOUNTING INDICATOR IS NEEDED ON     *
* SELECTION SCREEN.                                                    *
* OUTPUT SCREEN : PROFIT CENTER,NOTIFICATION FAILURE,ACTUAL MATERIAL   *
* COST,ACTUAL LABOUR COST,TOTAL ACTUAL COST,CURRENCY,SERIAL NUMBER     *
* OBJECT TYPE,MATERIAL NUMBER IS NEEDED ON OUTPUT LIST.                *
*----------------------------------------------------------------------*
* CHANGE HISTORY LOG                                                   *
*----------------------------------------------------------------------*
* MOD. NO.|  DATE    | NAME     |CORRECTION NUMBER| CHANGE REFERENCE # *
*----------------------------------------------------------------------*
* MOD-001 | 2004.11.10 | Ravin Malhotra |CD1K900851 |Validation on   | *
*                                                    Company Code      *
* MOD-002 | 2004.11.18 | Amit Mahajan   |CD1K900851 |CR-44 Addition  | *
*                                                    of Fields         *
* MOD-003 | 2004.11.24 | Ravin Malhotra |CD1K900851 |CR-54 Additional| *
*                                                   Fields Required  | *
* MOD-004 | 2005.06.13 | Luc Mertens    |CD1K902544 |P021            | *
* MOD-005 | 2005.07.05 | Luc Mertens    |CD1k902737 |CR185           | *
* MOD-006 | 2005.07.12 | Luc Mertens    |CD1K902799 |P021            | *
* MOD-007 | 2005.09.08 | Luc Mertens    |CD1K903171 |P021            | *
*                                      addition of fields (failure)    *
* MOD-008 | 2005.10.20 | Luc Mertens    |CD1K903682 |DE-TPR-CP034    | *
*     - group multiple lines for same order                            *
*     - do not show leading zeroes in fields PGC and GAC               *
*     - add productline code on selection screen                       *
*     - add date if order has been closed in a previous period         *
*     - improve performance                                            *
* MOD-009 | 2005.11.28 | Luc Mertens    |CD1K904024 |                  *
* MOD-010 | 2006.03.02 | Luc Mertens    |CD1K904948 |                  *
*     - improve performance by selecting COPA-data before selecting    *
*       the notification related data                                  *
*     - do not show orders with a total actual cost equal to zero      *
* MOD-011 | 2006.03.17 | Luc Mertens    |CD1K905028 |                  *
*     - improve performance by selecting on AUFK-IDAT3 (close date)    *
* MOD-012 | 2006.07.17 | Luc Mertens    |CD1K906233 |                  *
*     - add BPCS customer number                                       *
* MOD-013 | 2006.10.19 | Luc Mertens    |CD1K907091 |                  *
*     - correction: give errormessage when no orders were found        *
* MOD-014 | 2006.11.15 | Luc Mertens    |CD1K907603 |All-CR309         *
* MOD-015 | 2007.02.22 | Luc Mertens    |CD1K910935 |DE-CR069;ES-CR015 *
*                                                    IT-CR039          *
* MOD-016 | 2008.04.16 | Luc Mertens    |CD2K940697 |                  *
*     - exclude orders with zero total actual cost on orderlevel       *
************************************************************************
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
* YAM_P021_VENDOR_WARRANTY_REC : Vendor Warranty Recovery              *
*----------------------------------------------------------------------*
REPORT YAM_P021_VENDOR_WARRANTY_REC MESSAGE-ID ih.

*----------------------------------------------------------------------*
* type-pool ALV                                                        *
*----------------------------------------------------------------------*
TYPE-POOLS: slis.

*----------------------------------------------------------------------*
* DB tables                                                            *
*----------------------------------------------------------------------*
TABLES: afru,                          " confirmation
        viauf_afvc,                    " view orders & operation list
        crhd,                          " work centers
        t370a,                         " activity type of a transaction
*----------------------------------------------------------------------*
* YAM_P021 IS DEFINED TO PRINT THE FIELDCATLOG WITH ADITIONAL FIELDS   *
* REQUIRED AS PER THE GAP00061                                         *
*----------------------------------------------------------------------*
        YAM_P021,                      "Display Struc. Reporting PM
                                       "Order Operations & Confirmations
        AFIH,                          "Maintenance order header
        QMUR,                          "Quality notification - causes
        EQUI,                          "Equipment master dat
* begin of insert MOD-004
        aufk,                          "View "Orders Headers PP/CO"
        jest,                          "System status
        jcds,                          "Change Doc. for System/User Stat
* end of insert MOD-004
*----------------------------------------------------------------------*
* END OF TABLE DECELARTIONS AS PER THE GAP00061                        *
*----------------------------------------------------------------------*
        rihafvr,
        iflos,                         " func. location sign
        viauf_afvc_iflos.      " view orders & operation list  N:0444874

*----------------------------------------------------------------------*
* internal tables                                                      *
*----------------------------------------------------------------------*
* display structure
DATA: BEGIN OF object_tab OCCURS 0.
*        INCLUDE STRUCTURE rihafvr.
        INCLUDE STRUCTURE YAM_P021.

DATA tplnr_int LIKE iflo-tplnr.
DATA selected.
DATA pm_selected TYPE pm_selected.
*----------------------------------------------------------------------*
*ADDITIONAL FIELDS ARE ADDED IN THE INTERNAL TABLE OBJECT_TAB AS PER   *
*THE GAP00061                                                          *
*----------------------------------------------------------------------*
*DATA : PRCTR          LIKE AUFK-PRCTR.            "Profit Centre
**----------------------------------------------------------------------
*
**BEGIN OF CR-44
**----------------------------------------------------------------------
*
*DATA : OTGRP	        LIKE YAM_P021-OTGRP.
*DATA : TXTCDGROT      LIKE YAM_P021-TXTCDGROT.
*DATA : TXTCDFE	 LIKE  YAM_P021-TXTCDFE.
*DATA : FETXT          LIKE	YAM_P021-FETXT.
*DATA : TXTCDGR        LIKE	YAM_P021-TXTCDGR.
**----------------------------------------------------------------------
*
**END OF CR-44
**----------------------------------------------------------------------
*
*DATA : URTXT          LIKE  YAM_P021-URTXT.       "Notification
*FailCode
*DATA : AMC_IKOSTENKGR LIKE YAM_P021-AMC_IKOSTENKGR."Actual Material
*Cost
*DATA : ALC_IKOSTENKGR LIKE YAM_P021-ALC_IKOSTENKGR."Actual Labour
*Cost
*DATA : TAC_IKOSTENKGR LIKE YAM_P021-TAC_IKOSTENKGR."Total  Actual
*Cost
*DATA : WAERS          LIKE AUFK-WAERS.       "Currency
*DATA : SERNR          LIKE EQUI-SERNR.       "Serial Number
*DATA : EQART          LIKE EQUI-EQART.       "Object Type
*DATA : MATNR          LIKE EQUI-MATNR.       "Material Number
*----------------------------------------------------------------------*
*END OF ADDITIONAL FIELDS                                              *
*----------------------------------------------------------------------*
DATA: END OF object_tab.
*---------------------------------------------------------------*
* INTERNAL TABLE DECLERATION FOR GETTING THE DETAIL             *
* OF ORDER FROM BAPI-ALM_ORDER_GETDETAIL AS PER THE GAP00061    *
*---------------------------------------------------------------*
DATA: BEGIN OF I_ES_HEADER OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_HEADER_E.
DATA: END OF I_ES_HEADER.

DATA: BEGIN OF I_ES_SRVDAT OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_SRVDAT_E.
DATA: END OF I_ES_SRVDAT.

DATA: BEGIN OF I_PARTNER OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_PARTNER.
DATA: END OF I_PARTNER.

DATA: BEGIN OF I_OPERATIONS OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_OPERATION_E.
DATA: END OF I_OPERATIONS.
DATA: BEGIN OF I_COMPONENTS OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_COMPONENT_E.
DATA: END OF I_COMPONENTS.
DATA: BEGIN OF I_RELATIONS OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_RELATION_EXPORT.
DATA: END OF I_RELATIONS.
DATA: BEGIN OF I_TEXTS OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_TEXT.
DATA: END OF I_TEXTS.
DATA: BEGIN OF I_TEXT_LINES OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_TEXT_LINES.
DATA: END OF I_TEXT_LINES.
DATA: BEGIN OF I_PRTS OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_PRT_E.
DATA: END OF I_PRTS.
DATA: BEGIN OF I_COSTS_SUM OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_COSTS_SUM_E.
DATA: END OF I_COSTS_SUM.
DATA: BEGIN OF I_COSTS_DETAIL OCCURS 100.
        INCLUDE STRUCTURE BAPI_ALM_ORDER_COSTS_DETAIL_E.
DATA: END OF I_COSTS_DETAIL.
DATA: BEGIN OF I_RETURN OCCURS 100.
        INCLUDE STRUCTURE BAPIRET2.
DATA: END OF I_RETURN.
*-------------------------------------------------------------*
* END OF  BAPI INTERNAL TABLE                                 *
*-------------------------------------------------------------*
* work center of the order
DATA: BEGIN OF arbid_tab_o OCCURS 0,
        arbid LIKE crhd-objid,
        arbpl LIKE crhd-arbpl.
DATA: END OF arbid_tab_o.

* work center of the confirmation
DATA: BEGIN OF arbid_tab_c OCCURS 0,
        arbid LIKE crhd-objid,
        arbpl LIKE crhd-arbpl.
DATA: END OF arbid_tab_c.

** Inserted by Ravin on 10.11.04
DATA: BEGIN OF i_aufk OCCURS 0,
        aufnr LIKE aufk-aufnr,
        bukrs LIKE aufk-bukrs.
DATA: END OF i_aufk .

* begin of insert MOD-004
data:  begin of gt_aufk occurs 0,
        aufnr like aufk-aufnr,
        mandt like aufk-mandt,
        kokrs like aufk-kokrs,
        kostv like aufk-kostv,
        objnr like aufk-objnr,
        auart like aufk-auart,
        bukrs like aufk-bukrs,
        waers like aufk-waers,
        qmnum like afih-qmnum,
        equnr like afih-equnr,
        serialnr like afih-serialnr,
        sermat like afih-sermat,
        maktx like makt-maktx,
        loadhours type yloadhours,
        runhours  type yrunhours,
* begin of insert MOD-007
        kunum    like afih-kunum,
        pltxt    like kna1-name1,
        cls_date like sy-datum,
        period   type yam_period,
        ansdt    like equi-ansdt,
        inbdt    like equi-inbdt,
* end of insert MOD-007
* begin of insert MOD-008
        first_cls_date like sy-datum,
* end of insert MOD-008
* begin of insert MOD-012
        sortl    like kna1-sortl,
* end of insert MOD-012
* begin of insert MOD-015
        arbpl    like crhd-arbpl,
        ingpr    type ingrp,
        innam    type innam,
* end of insert MOD-015
      end of gt_aufk.

data:  begin of gt_conf occurs 0,
        rueck like afru-rueck,
        rmzhl like afru-rmzhl,
        budat like afru-budat,
        bemot like afru-bemot,
        arbid like afru-arbid,
        ismnw like afru-ismnw,
        ismne like afru-ismne,
        learr like afru-learr,
        stzhl like afru-stzhl,
        aufnr like afru-aufnr,
        prctr type prctr,
       end of gt_conf.

data:  begin of gt_notif occurs 0,
        aufnr     like qmel-aufnr,
        OTGRP     like wqmfe-otgrp,
        TXTCDGROT like wqmfe-txtcdgrot,
        FETXT     like wqmfe-fetxt,
        TXTCDGR   like wqmfe-txtcdgr,
        oteil     like wqmfe-oteil,
        fegrp     like wqmfe-fegrp,
        fecod     like wqmfe-fecod,
        urcod     like wqmur-urcod,
        urgrp     like wqmur-urgrp,
        txtcdfe   like wqmur-txtcdgr,
        urtxt     like qmur-urtxt,
* begin of insert MOD-014
        add_comments like yam_p021-add_comments,
* end of insert MOD-014
* begin of insert MOD-007
        txtgrot   like wqmfe-txtgrot,
        txtgr     like wqmfe-txtgr,
        ausvn     like qmih-ausvn,
        part_sernr     like equi-sernr,
        part_objnr     like equi-objnr,
        part_date      like equi-inbdt,
        part_hours     type yrunhours,
        partn          type matnr,
        part_descr(30) type c,
        original(3)    type c,
* end of insert
* begin of insert MOD-015
        mtoodc   type flag,
* end of insert MOD-015
      end of gt_notif.

* begin of delete MOD-006
*data: begin of gt_afru occurs 0.
*        include structure afrud.
*data: end of gt_afru.
* end of delete

data: i_cosel    TYPE STANDARD TABLE OF
                 cosel   INITIAL SIZE 0,

      i_costa    TYPE STANDARD TABLE OF
                 costa   INITIAL SIZE 0.
* end of insert MOD-004

* begin of insert MOD-006
data:  begin of gt_ce11000 occurs 0,
         rkaufnr like ce11000-rkaufnr,
         prctr   like ce11000-prctr,
* begin of insert MOD-008
         ww002   like ce11000-ww002,
* end of insert MOD-008
         ww003   like ce11000-ww003,
         vv200   like ce11000-vv200,
         vv300   like ce11000-vv300,
         vv400   like ce11000-vv400,
         vv500   like ce11000-vv500,
         vv600   like ce11000-vv600,
* begin of insert MOD-008
         belnr   like ce11000-belnr,
* end of insert MOD-008
       end of gt_ce11000.
* end of insert

* begin of insert MOD-008
data: begin of gt_jest occurs 0,
        objnr    like jest-objnr,
        stat     like jest-stat,
        chgnr    like jest-chgnr,
        inact    like jest-inact,
      end of gt_jest.

data: begin of gt_jcds occurs 0,
        objnr    like jcds-objnr,
        stat     like jcds-stat,
        chgnr    like jcds-chgnr,
        udate    like jcds-udate,
        inact    like jcds-inact,
      end of gt_jcds.

data: begin of gt_afih occurs 0,
        aufnr    like afih-aufnr,
        qmnum    like afih-qmnum,
        equnr    like afih-equnr,
        sermat   like afih-sermat,
        serialnr like afih-serialnr,
        kunum    like afih-kunum,
* begin of insert MOD-015
        gewrk    like afih-gewrk,
        iwerk    type iwerk,
        ingpr    type ingrp,
* end of insert MOD-015
      end of gt_afih.

data: begin of gt_equi occurs 0,
        equnr    like equi-equnr,
        objnr    like equi-objnr,
        ansdt    like equi-ansdt,
        inbdt    like equi-inbdt,
      end of gt_equi.

data: begin of gt_kna1 occurs 0,
        kunnr    like kna1-kunnr,
        name1    like kna1-name1,
* begin of insert MOD-012
        sortl    like kna1-sortl,
* end of insert MOD-012
      end of gt_kna1.

data: begin of gt_makt occurs 0,
        matnr    like makt-matnr,
        maktx    like makt-maktx,
      end of gt_makt.

data: begin of gt_equz occurs 0,
        hequi    like equz-hequi,
        equnr    like equz-equnr,
      end of gt_equz.
* end of insert MOD-008

* not used, needed for includes miolxtop, miolxf14, mioxf16
*---------------------------------------------------*
*Changed as per Gap00061                            *
*---------------------------------------------------*
*DATA: sel_tab LIKE rihafvr OCCURS 0 WITH HEADER LINE.
DATA: sel_tab LIKE yam_p021 OCCURS 0 WITH HEADER LINE.
DATA: I_wiqmfe LIKE wqmfe   occurs 0 with header line.
*--- Causes table
DATA: I_wiqmur like wqmur   occurs 0 with header line.

*---------------------------------------------------*
* WORK AREAS AND DATA DECLRATIONS                   *
*---------------------------------------------------*
DATA:  WA_QMNUM LIKE AFIH,"WORK AREA FOR ORDER HEADER
       WA_EQUI LIKE EQUI, "WORK AREA FOR THE EQUIPMENT MASTER
* begin of insert MOD-004
       wa_ord_cls_date type sy-datum,
       wa_jest_chgnr type jest-chgnr,
       wa_order_range   TYPE bapi_pp_orderrange,
       wa_confirmations TYPE bapi_conf_key,
       wa_returnconf    TYPE bapiret2,
       wa_returnconfdet TYPE bapiret2,
       wa_confdet       TYPE bapi_alm_confirmation,
       wa_cosel         TYPE cosel,
       wa_costa         TYPE costa,
* end of insert MOD-004
* begin of insert MOD-007
       wa_viqmel        type viqmel,
       wa_riwo03        type riwo03,
* end of insert MOD-007
       gt_tline_tmp TYPE STANDARD TABLE OF tline INITIAL SIZE 0
                                          WITH HEADER LINE,
       P_DATE1 LIKE sy-datum .

DATA : AUFNR LIKE  OBJECT_TAB-AUFNR,
       NUMBER LIKE  BAPI2080_NOTHDRE-NOTIF_NO.

*---------------------------------------------------*

*----------------------------------------------------------------------*
* global data                                                          *
*----------------------------------------------------------------------*
DATA: g_selflag.                       " selection flag (1 or 2)
DATA: go_on VALUE '1'.                                      " 0 or 1
DATA:
* begin of change MOD-015
* gt_crhd LIKE crhd OCCURS 0.
  gt_crhd LIKE crhd OCCURS 0 with header line.
* end of change MOD-015

* begin of change MOD-015
data: gt_t024i LIKE t024i OCCURS 0 with header line.
* end of change MOD-015

* begin of insert MOD-004
data: g_monat        TYPE bkpf-monat,
      g_value(7)     TYPE p DECIMALS 2,
      g_quant(7)     TYPE p DECIMALS 2,
      g_jahr         LIKE bkpf-gjahr,
      g_objnr        type cssl-objnr,
      g_objeq        like imptt-mpobj,
      g_fldperiod    type dd03l-fieldname,
      g_kdauf        type kdauf,
      g_equnr        type equnr,
      g_prctr        type prctr,
      g_tabix        like sy-tabix,
      g_leinh        LIKE cssl-leinh.
* end of insert MOD-004
* begin of insert MOD-007
data:  g_partn(10)     type c,             "part number
       g_part_sernr    like equi-sernr,
       g_part_objnr    like equi-objnr,
       g_part_date     like equi-inbdt.
* end of insert MOD-007

* begin of insert MOD-014
DATA: ld_tdname        TYPE tdobname,
      gv_comm_02       like tline-tdline,
      gv_comm_03       like tline-tdline,
      gv_comm_04       like tline-tdline.
* end of insert MOD-014

* begin of insert MOD-015
DATA: gv_cnt(3)        TYPE c.
* end of insert MOD-015

* begin of insert MOD-016
DATA: gv_ord_tac       type YTACDKGRKOSIST.

* table with ordernumbers to be deleted (tot_act_cost = 0)
data: begin of gt_del occurs 0,
        aufnr type aufnr,
      end of gt_del.
* end of insert MOD-016

*----------------------------------------------------------------------*
* constants                                                            *
*----------------------------------------------------------------------*
CONSTANTS: false TYPE i VALUE 0,
           true TYPE i VALUE 1,
* begin of insert MOD-004
           c_i0046        like jest-stat  value 'I0046',
           c_kl(2)        type c          value 'KL',
           c_tof0(4)      type c          value 'TOF0',
           c_toe0(4)      type c          value 'TOE0',
           c_x(1)         type c          value 'X',
           c_ie(2)        type c          value 'IE',
* begin of change MOD-005
*          c_run_hours    type impt-atnam value 'ZAM_RHRSTOTAL',
           c_run_hours    type impt-atnam value 'ZAM_RHRSTOTAL_ACT',
* end of change MOD-005
           c_loaded_hours type impt-atnam value 'ZAM_RHRSLOADED',
* end of insert MOD-004
* begin of insert MOD-006
           c_02(2)        type c          value '02',
           c_0(1)         type c          value '0',
* end of insert
* begin of insert MOD-007
           c_99991231(8)  type c          value '99991231',
           c_00000000(8)  type c          value '00000000',
* end of insert
*----------------------------------------------------------------------*
* CONSTANTS FOR SERVICE COSTS AND SPARE PARTS COST AS PER GAP00061     *
*----------------------------------------------------------------------*
           C_Z03(3) VALUE 'Z03', "SERVICE COSTS
           C_Z04(3) VALUE 'Z04'. "SPARE PARTS COST
*----------------------------------------------------------------------*
* LOCAL VARIABLE
*----------------------------------------------------------------------*
DATA : L_INDEX LIKE SY-TABIX..
*----------------------------------------------------------------------*
* ranges                                                               *
*----------------------------------------------------------------------*
RANGES: arbid_o FOR viauf_afvc-arbid.  " id of work center (order)
RANGES: arbid_c FOR afru-arbid.        " id of work center (conf.)
RANGES: r_iphas FOR viauf_afvc-iphas.  " status order
RANGES: gr_stzhl FOR afru-stzhl,
        gr_stokz FOR afru-stokz.

*----------------------------------------------------------------------*
* selection screen                                                     *
*----------------------------------------------------------------------*
* order status
SELECTION-SCREEN BEGIN OF BLOCK block0 WITH FRAME TITLE text-004.
* begin of insert MOD-004
select-options: s_aufnr for aufk-aufnr,
                s_auart for aufk-auart,
                s_bukrs for aufk-bukrs obligatory memory id buk.
* end of insert MOD-004

* begin of delete MOD-004
*SELECTION-SCREEN BEGIN OF LINE.
*PARAMETERS dy_iar AS CHECKBOX.
*SELECTION-SCREEN COMMENT 3(15) text-005 FOR FIELD dy_iar.
*PARAMETERS dy_abg AS CHECKBOX DEFAULT 'X'.
*SELECTION-SCREEN COMMENT 21(15) text-008 FOR FIELD dy_abg .
*SELECTION-SCREEN COMMENT 50(10) text-009 FOR FIELD selschem.
*PARAMETERS: selschem LIKE tj48t-selid.
*SELECTION-SCREEN END OF LINE.
* end of delete MOD-004

* begin of insert MOD-004
select-options s_cldate for jcds-udate.
* end of insert MOD-004
* begin of insert MOD-008
select-options s_plc for gt_ce11000-ww002.
* end of insert MOD-008
* begin of insert MOD-015
select-options s_ingpr for afih-ingpr.
* end of insert MOD-015
SELECTION-SCREEN END OF BLOCK block0.

* begin of delete MOD-004
* order and operation list
*SELECTION-SCREEN BEGIN OF BLOCK block1 WITH FRAME TITLE text-001.
*--------------------------------------------------------------*
* Added Company code as per the Requirement in GAP00061        *
*--------------------------------------------------------------*
*SELECT-OPTIONS bukrs_o FOR viauf_afvc-bukrs MATCHCODE OBJECT C_T001
*MEMORY ID BUK.
*--------------------------------------------------------------*
*SELECT-OPTIONS aufnr_o FOR viauf_afvc-aufnr MATCHCODE OBJECT ordp.
*SELECT-OPTIONS auart_o FOR viauf_afvc-auart.
*SELECT-OPTIONS equnr_o FOR viauf_afvc-equnr MATCHCODE OBJECT equi.
*SELECT-OPTIONS tplnr_o FOR viauf_afvc-tplnr NO-DISPLAY.
*SELECT-OPTIONS strno_o FOR iflos-strno MATCHCODE OBJECT iflm.
*SELECT-OPTIONS arbpl_o FOR rihafvr-parbpl.
*SELECT-OPTIONS werks_o FOR rihafvr-pwerk.
*SELECT-OPTIONS larnt_o FOR viauf_afvc-larnt.
*SELECTION-SCREEN END OF BLOCK block1.
* end of delete MOD-004

* confirmation
SELECTION-SCREEN BEGIN OF BLOCK block2 WITH FRAME TITLE text-002.
* begin of delete MOD-004
*SELECT-OPTIONS ersda_c FOR afru-ersda .
*SELECT-OPTIONS ernam_c FOR afru-ernam   MATCHCODE OBJECT user_addr.
*SELECT-OPTIONS budat_c FOR afru-budat.
*SELECT-OPTIONS pernr_c FOR afru-pernr MATCHCODE OBJECT lo_prem.
*SELECT-OPTIONS werks_c FOR rihafvr-werki.
*SELECT-OPTIONS arbpl_c FOR rihafvr-iarbpl.
*SELECT-OPTIONS aueru_c FOR afru-aueru.
*SELECT-OPTIONS grund_c FOR afru-grund.
*SELECT-OPTIONS loart_c FOR afru-loart. " P45K076586
*SELECT-OPTIONS learr_c FOR afru-learr. " P45K076586
*SELECT-OPTIONS isdd_c FOR afru-isdd.
*SELECT-OPTIONS isdz_c FOR afru-isdz.
*SELECT-OPTIONS iedd_c FOR afru-iedd.
*SELECT-OPTIONS iedz_c FOR afru-iedz.
*SELECT-OPTIONS rueck_c FOR afru-rueck.
* end of delete MOD-004
*----------------------------------------------------------------------*
* Added Accounting Indicator as per the Requirement in GAP00061        *
*----------------------------------------------------------------------*
SELECT-OPTIONS bemot_c FOR afru-bemot  DEFAULT 'PG'.
*----------------------------------------------------------------------*
*PARAMETERS: no_canc TYPE no_cancellations.
SELECTION-SCREEN END OF BLOCK block2.

* list variant
SELECTION-SCREEN BEGIN OF BLOCK block3 WITH FRAME.
PARAMETERS: variant LIKE disvariant-variant  default '/VENDOR WARR'.
SELECTION-SCREEN END OF BLOCK block3.

PARAMETERS:
  dy_selm DEFAULT '0' NO-DISPLAY,      " selection mode
  dy_tcode LIKE sy-tcode NO-DISPLAY,   " transaction
  p_ocall NO-DISPLAY.                  " 'X' => prog called from
" pm order

*----------------------------------------------------------------------*
* includes                                                             *
*----------------------------------------------------------------------*
INCLUDE miolxtop.
INCLUDE miolxf14.
INCLUDE miolxf16.

*----------------------------------------------------------------------*
* initialization                                                       *
*----------------------------------------------------------------------*
INITIALIZATION.
*----------------------------------------------------------------------*
*BEGIN OF CR-44
*----------------------------------------------------------------------*
  PERFORM DATE.
*----------------------------------------------------------------------*
*END OF CR-44
*----------------------------------------------------------------------*

* get aktype (display or change mode)
  PERFORM get_acttype_afru_l.
* get variant for selection screen
  PERFORM variant_start_f16.
* initializes g_variant
  PERFORM variant_init_f14 USING 'RMEL' 'RMEL' 'RMEL'.
* fill variant with the default variant
  IF variant IS INITIAL.
    PERFORM get_default_variant_f14 USING variant.
  ENDIF.
* fill g_fieldcat_tab
*--------------------------------------------------------*
*PASSING THE YAM_P021 TO THE FIELDCATLOG ROUTINE SO THAT *
*IT PRINTS THE CATALOGUE AS PER THE GAP00061             *
*--------------------------------------------------------*
  PERFORM create_fieldcat_f14 USING 'YAM_P021'.
*--------------------------------------------------------*
* set parameters for portfolio
  g_second_value = 'ISMNW'.
  g_port_title1 = 'Hohe Anzahl, hohe Istarbeit'(po1).
  g_port_title2 = 'Niedrige Anzahl, hohe Istarbeit'(po2).
  g_port_title3 = 'Hohe Anzahl, niedrige Istarbeit'(po3).
  g_port_title4 = 'Niedrige Anzahl, niedrige Istarbeit'(po4).
  g_port_value_text = 'Istarbeit (h)'(p05).

*----------------------------------------------------------------------*
* F4 help for list variant                                             *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR variant.
  PERFORM variant_inputhelp_f14 USING variant.

* begin of delete MOD-004
*----------------------------------------------------------------------*
* F4 help for wage type                                       P45K076586
*----------------------------------------------------------------------*
*AT SELECTION-SCREEN ON VALUE-REQUEST FOR loart_c-low.
*  PERFORM f4_loart CHANGING loart_c-low..

*AT SELECTION-SCREEN ON VALUE-REQUEST FOR loart_c-high.
*  PERFORM f4_loart CHANGING loart_c-high.

*eject
*---------------------------------------------------------------------
* AT SELECTION_SCREEN OUTPUT
*---------------------------------------------------------------------
*AT SELECTION-SCREEN OUTPUT.                                "note 444874
*--- Konvertierung Technischer Platz                        "note444874
*  PERFORM conversion_exit_tplnr_outp_f16 TABLES tplnr_o strno_o.
* end of delete MOD-004

*----------------------------------------------------------------------*
* at selection-screen                                                  *
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
* begin of delete MOD-004
*  REFRESH arbid_tab_o.
*  REFRESH arbid_tab_c.
*  REFRESH arbid_o.
*  REFRESH arbid_c.
* end of delete MOD-004

*--- immer Defaultvariante nehmen, da ALV-GRID diese immer nimmt
  IF variant IS INITIAL.
    PERFORM get_default_variant_f14 USING variant.
  ENDIF.
*--- Korrekte Listvariante ausgew#hlt ? -----------------------------*
  PERFORM variant_existence_f14 USING variant.

*----------------------------------------------------------------------*
* start-of-selection                                                   *
*----------------------------------------------------------------------*
START-OF-SELECTION.
  g_form_set_pf_stat = 'PF_STATUS_L'.

  PERFORM determine_g_tcode_f16.
  PERFORM get_acttype_afru_l.
  PERFORM prepare_display_list_f14.
  PERFORM update_fieldcat_variant_f14.
  PERFORM check_fieldcat_variant_l.
* begin of delete MOD-004
* PERFORM get_arbid TABLES arbid_tab_o arbpl_o werks_o arbid_o.
* PERFORM get_arbid TABLES arbid_tab_c arbpl_c werks_c arbid_c.
* PERFORM set_no_cancellation_l.
* PERFORM fill_selflag.
* PERFORM select_l.
* PERFORM auth_check_l.
*---------------------------------------------------------------------*
*USE BAPI BAPI_ALM_ORDER_GET_DETAIL TO GET THE SERVICE ORDER DATA     *
*THIS BAPI WILL GIVES THE INFO ABOUT PROFIT CENTRE,ACTUAL MATERIAL    *
*COST,ACTUAL LABOUR COST,CURRENCY AS PER GAP00061                     *
*---------------------------------------------------------------------*
*LOOP OBJECT-TAB INTERNAL TABLE TO GET THE SERVICE ORDER NO AND PASS  *
*THE ORDER NO TO BAPI AS A INPUT TO READ THE SERVICE ORDER DATA       *
*---------------------------------------------------------------------*
* PERFORM FILL_OBJECT_FIELDS.
* end of delete MOD-004

* begin of delete MOD-011
** begin of insert MOD-010
** preselect details from service orders in CO-PA
*  perform preselect_details_COPA.
** end of insert MOD-010
* end of delete MOD-011

* begin of insert MOD-004
  perform select_orders.

* begin of insert MOD-013
  if gt_aufk[] is initial.
    go_on = '0'.
    message S047.
    exit.
  endif.
* end of insert MOD-013

* begin of insert MOD-011
* preselect details from service orders in CO-PA
  perform preselect_details_COPA.

* check if selected orders are also selected for CO-PA,
* if not, delete them in internal table
  perform check_selected.
* end of insert MOD-011

* begin of insert MOD-008
* begin of delete MOD-015
**preselect data from maint.order, equipments, customers, materials
**and measurement points
* perform preselect_afih.
* sort gt_afih by aufnr.
* end of delete MOD-015

  perform preselect_equi.
  sort gt_equi by equnr.

  perform preselect_kna1.
  sort gt_kna1 by kunnr.
  delete adjacent duplicates from gt_kna1 comparing kunnr.

  perform preselect_makt.
  sort gt_makt by matnr.
  delete adjacent duplicates from gt_makt comparing matnr.

  perform preselect_equz.
  sort gt_equz by hequi.
* end of insert MOD-008

* begin of insert MOD-015
* preselect workcenters
  perform preselect_wc.
  sort gt_crhd by objty objid.
  delete adjacent duplicates from gt_crhd comparing objty objid.

* preselect maint. planner groups
  perform preselect_plangrp.
  sort gt_t024i by iwerk ingrp.
  delete adjacent duplicates from gt_t024i comparing iwerk ingrp.
* end of insert MOD-015

* begin of change MOD-006
* perform get_conf_and_notif_and_equip.
  perform get_notif_and_equip.
* end of change

* begin of change MOD-010
** begin of insert MOD-006
** preselect details from service orders in CO-PA
*  perform preselect_details_COPA.
** end of insert MOD-006
* end of change MOD-010

* begin of delete MOD-006
* preselect workcenters
* PERFORM preselect_wc
*   TABLES gt_conf.
*
* sort gt_aufk by aufnr.
* end of delete
  sort gt_notif by aufnr.

* begin of change MOD-006
* perform fill_object_table tables gt_conf.
  perform fill_object_table tables gt_aufk.
* end of change

* begin of insert MOD-016
  clear gv_ord_tac.
  refresh gt_del.
  sort object_tab by rueck rmzhl aufnr.
* end of insert MOD-016

* begin of insert MOD-010
* check if there are entries with 'total actual cost' = 0
* then do not display them on list
  loop at object_tab.
    if object_tab-tac_ikostenkgr = 0.
      delete object_tab.
      continue.
    endif.
* begin of insert MOD-016
    add object_tab-tac_ikostenkgr to gv_ord_tac.
    at end of aufnr.
      if gv_ord_tac = 0.
*...... put ordernumber into table (to be deleted)
        move object_tab-aufnr to gt_del-aufnr.
        append gt_del.
      endif.
      clear gv_ord_tac.
    endat.
* end of insert MOD-016
  endloop.
* end of insert MOD-010

* begin of insert MOD-016
* delete orders with 'total actual cost' = 0 (orderlevel)
  loop at object_tab.
    read table gt_del with key aufnr = object_tab-aufnr
                   binary search transporting no fields.
    if sy-subrc = 0.
      delete object_tab.
    endif.
  endloop.
* end of insert MOD-016

* describe table object_tab lines sy-tabix.
  if sy-tabix = 0.
    go_on = '0'.
    message s047.
  endif.

* begin of delete MOD-008
* sort object_tab BY prctr.
* end of delete MOD-008

* end of insert MOD-004
*---------------------------------------------------------------------*
END-OF-SELECTION.

  PERFORM display_list.
*&---------------------------------------------------------------------*
*&      Form  SELECT_L
*&---------------------------------------------------------------------*
*       select data from the db
*----------------------------------------------------------------------*
FORM select_l.

* begin of delete MOD-004
*  REFRESH object_tab. CLEAR object_tab.
*
** status
*  IF NOT dy_iar IS INITIAL.
*    CLEAR r_iphas.
*    r_iphas-option = 'EQ'.
*    r_iphas-sign = 'I'.
*    r_iphas-low = '2'.
*    APPEND r_iphas.
*  ENDIF.
*  IF NOT dy_abg IS INITIAL.
*    CLEAR r_iphas.
** technically completet
*    r_iphas-option = 'EQ'.
*    r_iphas-sign = 'I'.
*    r_iphas-low = '3'.
*    APPEND r_iphas.
** deletion flag
*    r_iphas-low = '4'.
*    APPEND r_iphas.
** completed
*    r_iphas-low = '6'.
*    APPEND r_iphas.
*  ENDIF.
*
** conversion exit finc. loc.
** PERFORM check_tplnr_f16    "note 444874
**      TABLES strno_o        "note 444874
**             tplnr_o        "note 444874
**      USING  g_x.
*
** choose selection routine
*  CASE g_selflag.
*    WHEN '1'.
*      PERFORM select_1.                " operation list->confirmation
*    WHEN '2'.
*      PERFORM select_2.                " confirmation->operation list
*  ENDCASE.
*
*  DESCRIBE TABLE object_tab LINES sy-tabix.
*  IF sy-tabix = 0.
*    go_on = '0'.
*    MESSAGE s047.
*  ENDIF.
**--- Defaultsortiertung wenn nichts ¨¹ber SALV eingestellt -----------
*  SORT object_tab BY aufnr rueck rmzhl.
* end of delete MOD-004

ENDFORM.                               " SELECT_L
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND_L
*&---------------------------------------------------------------------*
*       event user_command, called from ALV
*----------------------------------------------------------------------*
FORM user_command_l USING p_ucomm LIKE sy-ucomm
                          p_selfield TYPE slis_selfield.

  p_selfield-refresh = g_s.

*--- pf2 umbiegen je nach modus (Ausw#hlen/Anzeigen) ---------------
  PERFORM check_pf2_with_object_f16 USING p_ucomm.

  PERFORM set_p_selfield_general_f16 USING p_selfield.

  CASE p_ucomm.
*   update list
    WHEN 'AKTU'.
      p_selfield-refresh = g_x.
      PERFORM select_l.
*   show order
    WHEN 'AUFK'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
*   sho confirmation
    WHEN 'RMEL'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
*   show detail
    WHEN 'IOBJ'.
* begin of change MOD-006
*     p_ucomm = 'RMEL'.                                     "P45K078161
      p_ucomm = 'AUFK'.
* end of change MOD-006
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield."P45K078161
*   cancel confirmation
    WHEN 'STOR'.                       " cancel confirmation
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
*   display funtional location
    WHEN 'TPAZ'.
      PERFORM check_object_tab_marked_f14 USING p_ucomm p_selfield.
      PERFORM func_location_l.
*   display equipment
    WHEN 'EQUI'.
      PERFORM check_object_tab_marked_f14 USING p_ucomm p_selfield.
      PERFORM equi_l.
*   show longtext
    WHEN 'LGTX'.
      PERFORM fcodes_with_mark_f16 USING p_ucomm p_selfield.
*   choose fileds
    WHEN g_ol0.
      PERFORM refresh_l.
*   choose fields
    WHEN g_olx.
      PERFORM refresh_l.
*   change list variant
    WHEN g_oad.
      PERFORM refresh_l.
*   display basic list
    WHEN g_lis.
      PERFORM refresh_l.
*   others
    WHEN OTHERS.
      PERFORM user_command_f16 USING p_ucomm p_selfield.
  ENDCASE.

*--- If list is empty now - leave ALV
  IF object_tab[] IS INITIAL AND g_variant_save NE g_x.
    p_selfield-exit = g_x.
    MESSAGE s047(ih).
  ENDIF.

ENDFORM.                               " USER_COMMAND_L
*&---------------------------------------------------------------------*
*&      Form  PF_STATUS_L
*&---------------------------------------------------------------------*
*       set pf-status, called from ALV
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
FORM pf_status_l USING extab TYPE slis_t_extab.

* data h_excl_tab(10) occurs 0 with header line.

* h_excl_tab = 'V-A'.
* append h_excl_tab.
* h_excl_tab = 'AUFK'.
* append h_excl_tab.
* h_excl_tab = 'STOR'.
* append h_excl_tab.

* if p_ocall is initial.
*   set pf-status 'MAIN' excluding 'V-A'.
* else.
*   set pf-status 'MAIN' excluding h_excl_tab.
* endif.

  APPEND 'V-A' TO extab.

  IF NOT p_ocall IS INITIAL.
    APPEND 'AUFK' TO extab.
    APPEND 'STOR' TO extab.
  ENDIF.

  SET PF-STATUS 'MAIN' EXCLUDING extab.

ENDFORM.                               " PF_STATUS_L
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_LIST
*&---------------------------------------------------------------------*
*       display list
*----------------------------------------------------------------------*
FORM display_list.

  DATA subrc LIKE sy-subrc.
  DATA line  TYPE slis_fieldcat_alv.
  DATA ucomm LIKE sy-ucomm.

* begin of delete MOD-004
** do not allow sum
*  READ TABLE g_fieldcat_tab INTO line WITH KEY fieldname = 'ARBEI'.
*  line-no_sum = 'X'.
*  MODIFY g_fieldcat_tab FROM line INDEX sy-tabix.
* end of delete MOD-004

* begin of change MOD-007
* ucomm = 'RMEL'.
  ucomm = 'AUFK'.
* end of change MOD-007
  PERFORM display_list_f14 USING ucomm.

ENDFORM.                               " DISPLAY_LIST
*&---------------------------------------------------------------------*
*&      Form  FILL_SELFLAG
*&---------------------------------------------------------------------*
*       fill selection flag:  1, if block1 is filled
*                             2, if only block2 is filled.
*----------------------------------------------------------------------*
FORM fill_selflag.

* begin of delete MOD-004
*  IF NOT rueck_c[] IS INITIAL.
*    g_selflag = '2'.
*    EXIT.
*  ENDIF.
*  IF NOT aufnr_o[] IS INITIAL.
*    g_selflag = '1'.
*    EXIT.
*  ENDIF.
*  READ TABLE ersda_c INDEX 1.
*  READ TABLE budat_c INDEX 1.
*  IF NOT ( pernr_c[] IS INITIAL AND arbpl_c[] IS INITIAL ) OR
*         ( ersda_c-sign = 'I' AND ersda_c-option = 'EQ' ) OR
*         ( budat_c-sign = 'I' AND budat_c-option = 'EQ' ).
*    g_selflag = '2'.
*    EXIT.
*  ENDIF.
*  IF NOT ( equnr_o[] IS INITIAL AND strno_o[] IS INITIAL AND
*           arbpl_o[] IS INITIAL ).
*    g_selflag = '1'.
*    EXIT.
*  ENDIF.
*
**--- if nothing relevant is entered always use AFRU
*  g_selflag = '2'.
* end of delete MOD-004

ENDFORM.                               " FILL_SEL_FLAG
*&---------------------------------------------------------------------*
*&      Form  SELECT_1
*&---------------------------------------------------------------------*
*       operation list->confirmation
*----------------------------------------------------------------------*
FORM select_1.

* begin of delete MOD-004
*  DATA:
*    lt_task TYPE STANDARD TABLE OF viauf_afvc_iflos,    " note 444874
*    lt_conf TYPE STANDARD TABLE OF afru,
*    l_flag,                            " note 155676
*    lt_jsto_pre TYPE STANDARD TABLE OF jsto_pre,           " note
*155676
*    l_jsto_pre TYPE jsto_pre.          " note 155676
*
*  FIELD-SYMBOLS:
*    <task> TYPE viauf_afvc_iflos,      " note 444874
*    <conf> TYPE afru.
*
**--- wenn range mit prim#rkey zu gro# -> select #ndern ---------------
*  DESCRIBE TABLE aufnr_o LINES sy-tabix.
*  IF sy-tabix > 50.
**--- keine generisches Eingrenzen erlaubt ----------------------------
*    LOOP AT aufnr_o WHERE option <> 'EQ'.
*      MESSAGE i113.
*      STOP.
*    ENDLOOP.
*
**--- if G_ALTERN_ACT is activ use special views            "note 444874
*    IF g_altern_act = g_x AND NOT strno_o[] IS INITIAL.    "note 444874
*      g_viewname = 'VIAUF_AFVC_IFLOS'.                     "note 444874
*    ELSE.                                                  "note 444874
*      g_viewname = 'VIAUF_AFVC'.                           "note 444874
*    ENDIF.
*
*    SELECT * FROM (g_viewname)
*    INTO CORRESPONDING FIELDS OF TABLE lt_task             "note 444874
*      FOR ALL ENTRIES IN aufnr_o
**-----------------------------------------------------------------*
** Added the company code in the Select Option as per the Gap00061 *
**-----------------------------------------------------------------*
**     WHERE bukrs in bukrs_o                        " Commented by
*Ravin
*      where  aufnr = aufnr_o-low
*      AND  auart IN auart_o
*      AND  iphas IN r_iphas
*      AND  equnr IN equnr_o
*      AND  tplnr IN strno_o                                "note 444874
*      AND  arbid IN arbid_o
*      AND  werks IN werks_o
*      AND  larnt IN larnt_o
*      AND  rueck IN rueck_c
**-----------------------------------------------------------------*
** Added the acconting Indicator in the Select Option as per the   *
** Gap00061                                                        *
**-----------------------------------------------------------------*
*      AND  bemot IN bemot_c.
*  ELSE.
**--- if G_ALTERN_ACT is activ use special views            "note 444874
*    IF g_altern_act = g_x AND NOT strno_o[] IS INITIAL.    "note 444874
*      g_viewname = 'VIAUF_AFVC_IFLOS'.                     "note 444874
*    ELSE.                                                  "note 444874
*      g_viewname = 'VIAUF_AFVC'.                           "note 444874
*    ENDIF.
*
*    SELECT * FROM (g_viewname)                              "note
*444874
*    INTO CORRESPONDING FIELDS OF TABLE lt_task              "note
*444874
*       WHERE iphas IN r_iphas
**-----------------------------------------------------------------*
** Added the Company Code in the Select Option as per the Gap00061 *
**-----------------------------------------------------------------*
**        AND BUKRS IN BUKRS_O            " Commented by Ravin
*         AND aufnr IN aufnr_o
*         AND auart IN auart_o
*         AND equnr IN equnr_o
*         AND tplnr IN strno_o                               "note
*444874
*         AND arbid IN arbid_o
*         AND werks IN werks_o
*         AND larnt IN larnt_o
*         AND rueck IN rueck_c.
*  ENDIF.
*
*  LOOP AT lt_task ASSIGNING <task>.    " note 155676
*    l_jsto_pre-objnr = <task>-objnr.   " note 155676
*    APPEND l_jsto_pre TO lt_jsto_pre.  " note 155676
*  ENDLOOP.                             " note 155676
*
*  CALL FUNCTION 'STATUS_PRE_READ'      " note 155676
*       TABLES                          " note 155676
*            jsto_pre_tab         = lt_jsto_pre.            " note
*155676
*
*  LOOP AT lt_task ASSIGNING <task>.
*    PERFORM check_selschem USING <task>-objnr
*                           CHANGING l_flag.
*
*    IF NOT l_flag = 'X'.
*      DELETE lt_task.
*    ENDIF.
*  ENDLOOP.
*
*  IF NOT lt_task[] IS INITIAL.
*    SELECT * FROM afru INTO TABLE lt_conf
*      FOR ALL ENTRIES IN lt_task
*      WHERE rueck = lt_task-rueck
*      AND pernr IN pernr_c
*      AND ersda IN ersda_c
*      AND ernam IN ernam_c
*      AND budat IN budat_c
*      AND werks IN werks_c
*      AND arbid IN arbid_c
*      AND aueru IN aueru_c
*      AND grund IN grund_c
*      AND loart IN loart_c
*      AND learr IN learr_c
*      AND isdd IN isdd_c
*      AND isdz IN isdz_c
*      AND iedd IN iedd_c
*      AND iedz IN iedz_c
**-----------------------------------------------------------------*
** Added the acconting Indicator in the Select Option as per the   *
** Gap00061                                                        *
**-----------------------------------------------------------------*
*      AND BEMOT IN BEMOT_C
*      AND stzhl IN gr_stzhl
*      AND stokz IN gr_stokz.
*  ENDIF.
*
** preselect work centers
*  PERFORM preselect_crhd
*    TABLES
*       lt_conf
*       lt_task.
*
*  SORT lt_task BY rueck.               " note 186488
*  LOOP AT lt_conf ASSIGNING <conf>.
*    IF <task> IS ASSIGNED.
*      IF <conf>-rueck NE <task>-rueck.
*        READ TABLE lt_task
*          WITH KEY rueck = <conf>-rueck ASSIGNING <task>  " note 186488
*          BINARY SEARCH.               " note 186488
*        CHECK sy-subrc IS INITIAL.
*      ENDIF.
*    ELSE.
*      READ TABLE lt_task WITH KEY rueck =                 " note 186488
*                         <conf>-rueck ASSIGNING <task>    " note 186488
*                         BINARY SEARCH." note 186488
*      CHECK sy-subrc IS INITIAL.
*    ENDIF.
*
*    IF g_altern_act <> g_x OR strno_o[] IS INITIAL.       "note 444874
*      <task>-tplnr_int = <task>-tplnr.                    "note 444874
*    ENDIF.                                                "note 444874
*
*    PERFORM fill_object_tab
*       USING
*            <task>
*            <conf>.
*  ENDLOOP.
* end of delete MOD-004

ENDFORM.                                                    " SELECT_1
*&---------------------------------------------------------------------*
*&      Form  SELECT_2
*&---------------------------------------------------------------------*
*       confirmation->operation list
*----------------------------------------------------------------------*
FORM select_2.

* begin of delete MOD-004
*  DATA:
*     lt_task TYPE STANDARD TABLE OF viauf_afvc_iflos,      "note 444874
*     lt_conf TYPE STANDARD TABLE OF afru,
*     l_flag,                           " note 155676
*     lt_jsto_pre TYPE STANDARD TABLE OF jsto_pre,          " note
*155676
*     l_jsto_pre TYPE jsto_pre.         " note 155676
*
*  FIELD-SYMBOLS:
*    <task> TYPE viauf_afvc_iflos,      " note 444874
*    <conf> TYPE afru.
*
*  SELECT * FROM afru INTO TABLE lt_conf
*    WHERE rueck IN rueck_c
*    AND pernr IN pernr_c
*    AND ersda IN ersda_c
*    AND ernam IN ernam_c
*    AND budat IN budat_c
*    AND werks IN werks_c
*    AND arbid IN arbid_c
*    AND aueru IN aueru_c
*    AND grund IN grund_c
*    AND loart IN loart_c
*    AND learr IN learr_c
*    AND isdd IN isdd_c
*    AND isdz IN isdz_c
*    AND iedd IN iedd_c
*    AND iedz IN iedz_c
**-----------------------------------------------------------------*
** Added the acconting Indicator in the Select Option as per the   *
** Gap00061                                                        *
**-----------------------------------------------------------------*
*    AND bemot in bemot_c
*    AND stzhl IN gr_stzhl
*    AND stokz IN gr_stokz.
*
*  IF NOT lt_conf[] IS INITIAL.
**--- if G_ALTERN_ACT is activ use special views            "note 444874
*    IF g_altern_act = g_x AND NOT strno_o[] IS INITIAL.    "note 444874
*      g_viewname = 'VIAUF_AFVC_IFLOS'.                     "note 444874
*    ELSE.                                                  "note 444874
*      g_viewname = 'VIAUF_AFVC'.                           "note 444874
*    ENDIF.
*    SELECT * FROM (g_viewname)                              "note
*444874
*    INTO CORRESPONDING FIELDS OF TABLE lt_task              "note
*444874
*       FOR ALL ENTRIES IN lt_conf
*       WHERE aufnr = lt_conf-aufnr
*       AND rueck = lt_conf-rueck      " note 186488
**-----------------------------------------------------------------*
** Added the Company Code in the Select Option as per the Gap00061 *
**-----------------------------------------------------------------*
**       AND bukrs IN bukrs_o       " Commented by Ravin
*       AND auart IN auart_o
*       AND iphas IN r_iphas
*       AND arbid IN arbid_o
*       AND werks IN werks_o
*       AND equnr IN equnr_o
*       AND tplnr IN strno_o          " note 444874
*       AND larnt IN larnt_o.
*
*    LOOP AT lt_task ASSIGNING <task>.  " note 155676
*      l_jsto_pre-objnr = <task>-objnr. " note 155676
*      APPEND l_jsto_pre TO lt_jsto_pre." note 155676
*    ENDLOOP.                           " note 155676
*
*    CALL FUNCTION 'STATUS_PRE_READ'    " note 155676
*         TABLES                        " note 155676
*            jsto_pre_tab         = lt_jsto_pre.            " note
*155676
*  ENDIF.
*
**--- operations selected to completion confirmations?
*  IF NOT lt_task[] IS INITIAL.
*    READ TABLE lt_task INDEX 1 ASSIGNING <task>.
*  ELSE.
*    EXIT.
*  ENDIF.
*
** preselect work centers
*  PERFORM preselect_crhd
*    TABLES
*       lt_conf
*       lt_task.
*
*  SORT lt_task BY rueck.               " note 186488
*  LOOP AT lt_conf ASSIGNING <conf>.
*    IF <conf>-rueck NE <task>-rueck.
*      READ TABLE lt_task WITH KEY rueck =                  " note
*186488
*                         <conf>-rueck ASSIGNING <task>     " note
*186488
*                         BINARY SEARCH." note 186488
*
*      IF sy-subrc NE 0. " no order found with given selection criterias
*        CONTINUE.
*      ENDIF.
*    ENDIF.
*
*    PERFORM check_selschem
*         USING
*              <task>-objnr
*         CHANGING
*               l_flag.
*
*    IF NOT l_flag = 'X'.
*      CONTINUE.
*    ENDIF.
*
*    IF g_altern_act <> g_x OR strno_o[] IS INITIAL.       "note 444874
*      <task>-tplnr_int = <task>-tplnr.                    "note 444874
*    ENDIF.                                                "note 444874
*
*    PERFORM fill_object_tab
*         USING
*              <task>
*              <conf>.
*  ENDLOOP.
* end of delete MOD-004

ENDFORM.                                                    "select_2
*&---------------------------------------------------------------------*
*&      Form  GET_STATUS
*&---------------------------------------------------------------------*
*       get status text
*----------------------------------------------------------------------*
*      -->P_OBJNR  object number                                       *
*----------------------------------------------------------------------*
FORM get_status USING    p_objnr.
  DATA: sttxt LIKE rihafvr-sttxt,      " system status
        ustxt LIKE rihafvr-ustxt.      " user status

  CALL FUNCTION 'STATUS_TEXT_EDIT'
       EXPORTING
*           CLIENT            = SY-MANDT
            flg_user_stat     = 'X'
            objnr             = p_objnr
*           ONLY_ACTIVE       = 'X'
            spras             = sy-langu
       IMPORTING
*           ANW_STAT_EXISTING =
*           E_STSMA           =
            line              = sttxt
            user_line         = ustxt
       EXCEPTIONS
            object_not_found  = 1
            OTHERS            = 2.

* begin of delete MOD-004
*  MOVE sttxt TO object_tab-sttxt.
*  MOVE ustxt TO object_tab-ustxt.
* end of delete MOD-004
ENDFORM.                               " GET_STATUS
*&---------------------------------------------------------------------*
*&      Form  CHECK_SELSCHEMA
*&---------------------------------------------------------------------*
*       check further selection options
*----------------------------------------------------------------------*
*      <--P_FLAG                                                       *
*----------------------------------------------------------------------*
FORM check_selschem USING p_objnr CHANGING p_flag.
* begin of delete MOD-004
*  CALL FUNCTION 'STATUS_CHECK_BY_SELSCHEM'
*    EXPORTING
*      objnr          = p_objnr
*      selid          = selschem
*    IMPORTING
*      fullfill       = p_flag
*    EXCEPTIONS
*      no_stat_tab    = 1
*      no_stat_scheme = 2
*      OTHERS         = 3.
* end of delete MOD-004
ENDFORM.                               " CHECK_SELSCHEMA
*&---------------------------------------------------------------------*
*&      Form  GET_ARBPL
*&---------------------------------------------------------------------*
*       read working center
*----------------------------------------------------------------------*
*  -->  arbid
*  <--  arbpl
*----------------------------------------------------------------------*
FORM get_arbpl USING    arbid TYPE cr_objid
               CHANGING arbpl TYPE arbpl.

  DATA:
    l_crhd LIKE crhd.

  READ TABLE gt_crhd INTO l_crhd
    WITH KEY objid = arbid.

  arbpl = l_crhd-arbpl.

ENDFORM.                               " GET_ARBPL
*&---------------------------------------------------------------------*
*&      Form  GET_ARBID
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->ARBPL                                                        *
*      -->WERK                                                         *
*      -->ARBID_TAB                                                    *
*      -->ARBID                                                        *
*----------------------------------------------------------------------*
* begin of delete MOD-004
*FORM get_arbid TABLES arbid_tab STRUCTURE arbid_tab_o
*                      arbpl STRUCTURE arbpl_o
*                      werks STRUCTURE werks_o
*                      arbid STRUCTURE arbid_o.
** read internal number of a work center
*-------------------------------*
*  DESCRIBE TABLE arbpl LINES sy-tabix.
*  IF NOT sy-tabix IS INITIAL.
*    SELECT objid arbpl FROM crhd INTO TABLE arbid_tab
*      WHERE arbpl IN arbpl
*      AND werks IN werks.
**-- no work center found
*----------------------------------------------*
*    DESCRIBE TABLE arbid_tab LINES sy-tabix.
*    IF sy-tabix IS INITIAL.
*      MESSAGE s047.
*      STOP.
*    ENDIF.
**-- too many work centers for
*select-----------------------------------*
*    IF sy-tabix > 255.
*      MESSAGE i103.
*      STOP.
*    ENDIF.
**-- fill range for selection
*------------------------------------------*
*    arbid-option = 'EQ'.
*    arbid-sign = 'I'.
*    LOOP AT arbid_tab.
*      arbid-low = arbid_tab-arbid.
*      APPEND arbid.
*    ENDLOOP.
*    SORT arbid_tab.
*  ENDIF.
*ENDFORM.                               " GET_ARBID
* end of delete MOD-004
*&---------------------------------------------------------------------*
*&      Form  FILL_OBJECT_TAB
*&---------------------------------------------------------------------*
*       fill object_tab with selected data
*----------------------------------------------------------------------*
FORM fill_object_tab USING i_task TYPE viauf_afvc_iflos    "note 444874
                           i_conf TYPE afru.
  DATA: idx TYPE i,
        wa LIKE object_tab,
        l_vornr LIKE afvc-vornr.
* get status
  PERFORM get_status
       USING
            i_task-objnr.
* if cancel
  IF NOT i_conf-stzhl IS INITIAL.
    i_conf-idaur = ( -1 ) * i_conf-idaur.
    i_conf-odaur = ( -1 ) * i_conf-odaur.
    i_conf-ofmnw = ( -1 ) * i_conf-ofmnw.
    i_conf-ismnw = ( -1 ) * i_conf-ismnw.
  ENDIF.
  CLEAR object_tab.                                         "N212796
  MOVE-CORRESPONDING i_task TO object_tab.
  MOVE-CORRESPONDING i_conf TO object_tab.

* Systemstatus neu ermitteln                                    N310055
  PERFORM get_status USING i_task-objnr.

* begin of delete MOD-004
** sub-operation ?
*  IF NOT i_task-sumnr IS INITIAL.
*    object_tab-uvorn = i_task-vornr.
*    SELECT SINGLE vornr INTO l_vornr FROM afvc
*      WHERE aufpl = i_task-aufpl
*      AND   aplzl = i_task-sumnr.
*    object_tab-vornr = l_vornr.
*  ELSE.
*    CLEAR object_tab-uvorn.
*  ENDIF.
*
** name of employee and personal area
*  IF NOT object_tab-pernr IS INITIAL.
*    CALL FUNCTION 'RP_CHECK_PERNR'
*      EXPORTING
*        beg               = sy-datum
*        pnr               = object_tab-pernr
*      IMPORTING
*        name              = object_tab-name
*        persa             = object_tab-persa
*      EXCEPTIONS
*        data_fault        = 1
*        person_not_active = 2
*        person_unknown    = 3
*        exit_fault        = 4
*        pernr_missing     = 5
*        date_missing      = 6
*        OTHERS            = 7.
*  ENDIF.
*
*  IF NOT i_conf-ismnu IS INITIAL AND
*     i_conf-ismne NE i_conf-ismnu.
*    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
*      EXPORTING
*        input    = i_conf-ismnw
*        unit_in  = i_conf-ismne
*        unit_out = i_conf-ismnu
*      IMPORTING
*        output   = object_tab-ismnw.
*    object_tab-ismne = i_conf-ismnu.
*  ENDIF.
*
*  IF NOT i_conf-ofmnu IS INITIAL AND
*      i_conf-ofmne NE i_conf-ofmnu.
*    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
*      EXPORTING
*        input    = i_conf-ofmnw
*        unit_in  = i_conf-ofmne
*        unit_out = i_conf-ofmnu
*      IMPORTING
*        output   = object_tab-ofmnw.
*    object_tab-ofmne = i_conf-ofmnu.
*  ENDIF.
*
*  PERFORM get_arbpl USING i_conf-arbid object_tab-iarbpl.
*  PERFORM get_arbpl USING i_task-arbid object_tab-parbpl.
*
*  object_tab-werki = i_conf-werks.
*  object_tab-pwerk = i_task-werks.
*
** conversion exit func. loc.
*  WRITE i_task-tplnr_int TO object_tab-tplnr.    "note 444874
*
*  IF NOT i_conf-stzhl IS INITIAL.
*    READ TABLE object_tab INTO wa WITH KEY rueck = i_conf-rueck
*                                         rmzhl = i_conf-stzhl.
*    IF sy-subrc = 0.
*      idx = sy-tabix + 1.
*      INSERT object_tab INDEX idx.
*    ELSE.
*      APPEND object_tab.
*    ENDIF.
*  ELSE.
*    APPEND object_tab.
*  ENDIF.
* end of delete MOD-004

ENDFORM.                               " FILL_OBJECT_TAB
*---------------------------------------------------------------------*
*       FORM FCODES_WITH_MARK_L                                       *
*---------------------------------------------------------------------*
*       FCodes, which can be proccessed in a loop                     *
*---------------------------------------------------------------------*
FORM fcodes_with_mark_l USING p_ucomm LIKE sy-ucomm
                              p_selfield TYPE slis_selfield.
  DATA: h_ucomm LIKE sy-ucomm.

  PERFORM mark_selected_f16 CHANGING object_tab-selected
                                     object_tab-pm_selected.

  CASE p_ucomm.
*   show confirmation
    WHEN 'RMEL'.
* begin of delete MOD-006
*     PERFORM confirmation_l USING object_tab-rueck object_tab-rmzhl
*       'DISP'.
* end of delete
*   cancel confirmation
    WHEN 'STOR'.
* begin of delete MOD-006
*     PERFORM confirmation_l USING object_tab-rueck object_tab-rmzhl
*       'CANC'.
* end of delete
*   show order
    WHEN 'AUFK'.
      PERFORM order_l USING object_tab-aufnr.
* show longtext
    WHEN 'LGTX'.
* begin of delete MOD-006
*     PERFORM longtext_l.
* end of delete
  ENDCASE.
ENDFORM.                    "fcodes_with_mark_l
*&---------------------------------------------------------------------*
*&      Form  CONFIRMATION_L
*&---------------------------------------------------------------------*
*       display confirmation
*----------------------------------------------------------------------*
*      -->P_OBJECT_TAB-RUECK                                           *
*----------------------------------------------------------------------*
FORM confirmation_l USING    p_rueck     TYPE co_rueck
                             p_rmzhl     TYPE co_rmzhl
                             p_transflag TYPE c.
  DATA: rueck LIKE coruf-rueck,
        aufnr LIKE coruf-aufnr,
        vornr LIKE coruf-vornr,
        rmzhl LIKE coruf-rmzhl,
        kapar LIKE coruf-kapar,
        tplnr LIKE coruf-tplnr,
        equnr LIKE coruf-equnr,
        rueck_ini LIKE coruf-rueck,
        aufnr_ini LIKE coruf-aufnr,
        vornr_ini LIKE coruf-vornr,
        rmzhl_ini LIKE coruf-rmzhl,
        kapar_ini LIKE coruf-kapar,
        tplnr_ini LIKE coruf-tplnr,
        equnr_ini LIKE coruf-equnr,
        l_tcode   LIKE sy-tcode,
        l_retc    LIKE sy-subrc.

  GET PARAMETER ID 'RCK' FIELD rueck.
  GET PARAMETER ID 'ANR' FIELD aufnr.
  GET PARAMETER ID 'VGN' FIELD vornr.
  GET PARAMETER ID 'RZL' FIELD rmzhl.
  GET PARAMETER ID 'CAA' FIELD kapar.
  GET PARAMETER ID 'IFL' FIELD tplnr.
  GET PARAMETER ID 'EQN' FIELD equnr.

  SET PARAMETER ID 'ANR' FIELD aufnr_ini.
  SET PARAMETER ID 'VGN' FIELD vornr_ini.
  SET PARAMETER ID 'RZL' FIELD rmzhl_ini.
  SET PARAMETER ID 'CAA' FIELD kapar_ini.
  SET PARAMETER ID 'IFL' FIELD tplnr_ini.
  SET PARAMETER ID 'EQN' FIELD equnr_ini.
  SET PARAMETER ID 'RCK' FIELD p_rueck.
  SET PARAMETER ID 'RZL' FIELD p_rmzhl.

*--- set TCODE
  CASE p_transflag.
    WHEN 'DISP'.
      l_tcode = 'IW43'.
    WHEN 'CANC'.
      l_tcode = 'IW45'.
  ENDCASE.

*--- Authority Check for T-code
  PERFORM auth_check_tcode_f16 USING    l_tcode
                               CHANGING l_retc.
*--- call transaction
  IF l_retc IS INITIAL AND NOT l_tcode IS INITIAL.
    CALL TRANSACTION l_tcode AND SKIP FIRST SCREEN.
    IMPORT return_code FROM MEMORY ID 'IW41'.
    FREE MEMORY ID 'IW41'.
  ENDIF.

  SET PARAMETER ID 'RCK' FIELD rueck.
  SET PARAMETER ID 'ANR' FIELD aufnr.
  SET PARAMETER ID 'VGN' FIELD vornr.
  SET PARAMETER ID 'RZL' FIELD rmzhl.
  SET PARAMETER ID 'CAA' FIELD kapar.
  SET PARAMETER ID 'IFL' FIELD tplnr.
  SET PARAMETER ID 'EQN' FIELD equnr.
ENDFORM.                               " DISP_CONFIRMATION
*&---------------------------------------------------------------------*
*&      Form  ORDER_L
*&---------------------------------------------------------------------*
*       display order
*----------------------------------------------------------------------*
*      -->P_OBJECT_TAB-AUFNR                                           *
*----------------------------------------------------------------------*
FORM order_l USING    p_aufnr TYPE aufnr.
  DATA: aufnr LIKE afru-aufnr.

  GET PARAMETER ID 'ANR' FIELD aufnr.
  SET PARAMETER ID 'ANR' FIELD p_aufnr.
  CALL TRANSACTION 'IW33' AND SKIP FIRST SCREEN.
  IMPORT return_code FROM MEMORY ID 'PMWOC'.
  FREE MEMORY ID  'PMWOC'.
  SET PARAMETER ID 'ANR' FIELD aufnr.
ENDFORM.                               " ORDER_L

*&---------------------------------------------------------------------*
*&      Form  FUNCT_LOCATION_L
*&---------------------------------------------------------------------*
*       display functional location
*----------------------------------------------------------------------*
FORM func_location_l.
  DATA: subrc LIKE sy-subrc.
  DATA: tcode LIKE sy-tcode.
  RANGES tplnr FOR object_tab-tplnr_int.

  tcode = 'IH06'.

  PERFORM auth_check_tcode_f16 USING tcode CHANGING subrc.

  IF subrc IS INITIAL.
    LOOP AT object_tab WHERE selected = yes OR selected = g_x.
      PERFORM mark_selected_f16 CHANGING object_tab-selected
                                         object_tab-pm_selected.
      CHECK NOT object_tab-tplnr_int IS INITIAL.
      CLEAR tplnr.
      tplnr-option = 'EQ'.
      tplnr-sign = 'I'.
      tplnr-low = object_tab-tplnr_int.
      COLLECT tplnr.
    ENDLOOP.
    IF tplnr IS INITIAL.
      IF object_tab-pm_selected <> space.
        MESSAGE i077.
      ELSE.
        MESSAGE i011.
      ENDIF.
    ELSE.
      SUBMIT riiflo20 WITH tplnr IN tplnr
                      WITH dy_tcode = tcode
                      AND RETURN.
    ENDIF.
  ENDIF.
ENDFORM.                               " FUNC_LOCATION_L
*&---------------------------------------------------------------------*
*&      Form  EQUI_L  I
*&---------------------------------------------------------------------*
*       display equi
*----------------------------------------------------------------------*
FORM equi_l.
  DATA: subrc LIKE sy-subrc.
  DATA: tcode LIKE sy-tcode.
  RANGES equnr FOR object_tab-equnr.

  tcode = 'IH08'.

  PERFORM auth_check_tcode_f16 USING tcode CHANGING subrc.
  IF subrc IS INITIAL.
    LOOP AT object_tab WHERE selected = yes OR selected = g_x.
      PERFORM mark_selected_f16 CHANGING object_tab-selected
                                         object_tab-pm_selected.
      CHECK NOT object_tab-equnr IS INITIAL.
      CLEAR equnr.
      equnr-sign = 'I'.
      equnr-option = 'EQ'.
      equnr-low = object_tab-equnr.
      COLLECT equnr.
    ENDLOOP.
    IF equnr IS INITIAL.
      IF object_tab-pm_selected <> space.
        MESSAGE i079.
      ELSE.
        MESSAGE i011.
      ENDIF.
    ELSE.
      SUBMIT riequi20 WITH equnr IN equnr
                      WITH dy_tcode = tcode
                      AND RETURN.
    ENDIF.
  ENDIF.
ENDFORM.                               " EQUI_L

*&---------------------------------------------------------------------*
*&      Form  LONGTEXT_L
*&---------------------------------------------------------------------*
*       show longtext
*----------------------------------------------------------------------*
FORM longtext_l.

* begin of delete MOD-006
*  DATA: txt_name(30).
*  DATA: string1(30).
*  DATA: string2(30).
*  DATA: string3(30).
*  DATA: h_result LIKE itcer.
*  DATA: h_txtsp  LIKE afru-txtsp.
*
*  WRITE object_tab-mandt TO string1.
*  WRITE object_tab-rueck TO string2.
*  WRITE object_tab-rmzhl TO string3.
*
*  CONDENSE string1.
*  CONDENSE string2.
*  CONDENSE string3.
*
*  CONCATENATE string1 string2 string3 INTO txt_name.
*
**--- select language of compf.confirmation
*  SELECT SINGLE txtsp INTO h_txtsp FROM afru
*                       WHERE rueck = object_tab-rueck
*                       AND   rmzhl = object_tab-rmzhl.
*
*  CALL FUNCTION 'LANGTEXT_ONLY'
*    EXPORTING
*      object    = 'AUFK'
*      object_nr = txt_name
*      spras     = h_txtsp
*      txtid     = 'RMEL'
*      x_xaktyp  = 'A'
*    IMPORTING
*      RESULT    = h_result
*    EXCEPTIONS
*      OTHERS    = 0.
*
**--- Longtext left with pf15 -> end of loop-session (popup)
*  IF h_result-userexit = 'E'.
*    return_code = 8.
*  ENDIF.
* end of delete

ENDFORM.                               " LONGTEXT_L

*&---------------------------------------------------------------------*
*&      Form  CHECK_FIELDCAT_VARIANT_L
*&---------------------------------------------------------------------*
*       set disp. fields if no list variant exists
*----------------------------------------------------------------------*
FORM check_fieldcat_variant_l.

  DATA fieldcat_wa TYPE slis_fieldcat_alv.
  DATA index       LIKE sy-tabix.

  index = 1.

  DESCRIBE TABLE g_selfields_tab LINES sy-tabix.
  IF sy-tabix IS INITIAL.
    LOOP AT g_fieldcat_tab INTO fieldcat_wa.
      CASE fieldcat_wa-fieldname.
        WHEN 'PM_SELECTED'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 1.
        WHEN 'RUECK'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 2.
        WHEN 'RMZHL'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 3.
        WHEN 'ERSDA'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 4.
        WHEN 'ERNAM'.
          fieldcat_wa-no_out  = space.
          fieldcat_wa-col_pos = 5.
        WHEN 'AUFNR'.
          fieldcat_wa-no_out = space.
          fieldcat_wa-col_pos = 6.
        WHEN OTHERS.
          fieldcat_wa-no_out = g_x.
      ENDCASE.
      MODIFY g_fieldcat_tab FROM fieldcat_wa.
    ENDLOOP.
  ENDIF.

  PERFORM create_g_selfields_tab_f14.

ENDFORM.                               " CHECK_FIELDCAT_VARIANT_L

*&---------------------------------------------------------------------*
*&      Form  REFRESH_L
*&---------------------------------------------------------------------*
*       refresh fieldcatalog g_fidcat_tab
*----------------------------------------------------------------------*
FORM refresh_l.
  DATA ucomm LIKE sy-ucomm.

  PERFORM get_fieldcat_actual_f14 USING ucomm.
ENDFORM.                               " REFRESH_L

*&---------------------------------------------------------------------*
*&      Form  GET_ACTTYPE_AFRU_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_acttype_afru_l.

  SELECT SINGLE * FROM t370a WHERE tcode = g_tcode.
  IF sy-subrc <> 0.
*-------------------------------------------------*
*CHANGED AS PER THE GAP00061                      *
*-------------------------------------------------*
    SELECT SINGLE * FROM t370a WHERE
    tcode = 'YAM_P021_VEN_WAR_REC'.
*-------------------------------------------------*
* END OF CHANGE                                   *
*-------------------------------------------------*
    IF sy-subrc <> 0.
      RAISE iw29_not_in_t370a.
    ENDIF.
  ENDIF.
  g_aktyp = t370a-aktyp.
ENDFORM.                               " GET_ACTTYPE_AFRU_L

*&---------------------------------------------------------------------*
*&      Form  AUTH_CHECK_L
*&---------------------------------------------------------------------*
*       check authority
*----------------------------------------------------------------------*
FORM auth_check_l.

* begin of delete MOD-004
*  DATA h_auth_all TYPE i.
*
*  h_auth_all = true.
*
*  LOOP AT object_tab.
*
*    CALL FUNCTION 'INST_AUTHORITY_CHECK_ALL'
*      EXPORTING
*        iwerk                    = object_tab-iwerk
*        tcode                    = 'YP021'
*        auart                    = object_tab-auart
*        ingrp                    = object_tab-ingpr
*      EXCEPTIONS
*        keine_berechtigung_begrp = 1
*        keine_berechtigung_iwerk = 2
*        keine_berechtigung_swerk = 3
*        keine_berechtigung_auart = 4
*        keine_berechtigung_ingrp = 5
*        keine_berechtigung_kostl = 6
*        OTHERS                   = 7.
*
*    IF sy-subrc NE 0.
*      DELETE object_tab.
*      h_auth_all = false.
*    ENDIF.
*
*  ENDLOOP.
*
*  IF h_auth_all = false.
*    MESSAGE s046.
*  ENDIF.
* end of delete MOD-004

ENDFORM.                               " AUTH_CHECK_L

*-------------------------- E N D -------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  MARK_SELECTED_L
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_SELFIELD_TABINDEX  text
*----------------------------------------------------------------------*
FORM mark_selected_l USING p_index LIKE sy-tabix.

  CHECK NOT p_index IS INITIAL.

  READ TABLE object_tab INDEX p_index.
  IF sy-subrc IS INITIAL.
    object_tab-selected    = space.
    object_tab-pm_selected = sym_check_mark.
    MODIFY object_tab INDEX p_index.
  ENDIF.

ENDFORM.                               " MARK_SELECTED_L

*&----------------------------------------------------------------------
*&      Form  F4_LOART                                        P45K076586
*&----------------------------------------------------------------------
FORM f4_loart CHANGING e_loart LIKE bas_check_wagetype-lgart.
  DATA: lt_fields LIKE sval OCCURS 0 WITH HEADER LINE,
        lt_dfies LIKE dfies OCCURS 0 WITH HEADER LINE,
        l_werks LIKE bas_check_wagetype-werks,
        l_begda LIKE bas_check_wagetype-begda,
        l_returncode LIKE sy-ucomm.

  CALL FUNCTION 'DDIF_FIELDINFO_GET'
    EXPORTING
      tabname   = 'BAS_CHECK_WAGETYPE'
      fieldname = 'LGART'
    TABLES
      dfies_tab = lt_dfies.

  READ TABLE lt_dfies INDEX 1.
  lt_fields-tabname = 'BAS_CHECK_WAGETYPE'.
  lt_fields-fieldname = 'BEGDA'.
  lt_fields-field_obl = 'X'.
  APPEND lt_fields.
  lt_fields-fieldname = 'WERKS'.
  APPEND lt_fields.

  CALL FUNCTION 'POPUP_GET_VALUES'
    EXPORTING
      popup_title = lt_dfies-scrtext_m
    IMPORTING
      returncode  = l_returncode
    TABLES
      fields      = lt_fields.

  IF l_returncode = 'A'.
    EXIT.
  ENDIF.

  READ TABLE lt_fields WITH KEY fieldname = 'BEGDA'.
  l_begda = lt_fields-value.


  READ TABLE lt_fields WITH KEY fieldname = 'WERKS'.
  l_werks = lt_fields-value.

  CALL FUNCTION 'WAGE_TYPE_VALUES'
    EXPORTING
      date                    = l_begda
      werk                    = l_werks
    IMPORTING
      lgart                   = e_loart
    EXCEPTIONS
      date_missing            = 1
      plant_missing           = 2
      no_molga                = 3
      pernr_and_plant_missing = 4
      data_fault              = 5
      OTHERS                  = 6.

ENDFORM.                                                    "f4_loart

*&---------------------------------------------------------------------*
*&      Form  PRESELECT_CRHD
*&---------------------------------------------------------------------*
FORM preselect_crhd TABLES   it_conf STRUCTURE afru
                             it_task STRUCTURE viauf_afvc_iflos.

  DATA:
    lt_task LIKE viauf_afvc_iflos OCCURS 0,
    l_task LIKE viauf_afvc_iflos,
    l_crhd.

  SELECT * FROM crhd INTO TABLE gt_crhd
    FOR ALL ENTRIES IN it_conf
    WHERE objty = 'A'
    AND   objid = it_conf-arbid.

  LOOP AT it_task INTO l_task.
    READ TABLE gt_crhd INTO l_crhd
      WITH KEY objid = l_task-arbid.

    IF sy-subrc <> 0.
      APPEND l_task TO lt_task.
    ENDIF.
  ENDLOOP.

  CHECK NOT lt_task[] IS INITIAL.

  SELECT * FROM crhd APPENDING TABLE gt_crhd
    FOR ALL ENTRIES IN lt_task
    WHERE objty = 'A'
    AND   objid = lt_task-arbid.

ENDFORM.                               " PRESELECT_CRHD
*&---------------------------------------------------------------------*
*&      Form  set_no_cancellation_l
*&---------------------------------------------------------------------*
*       set select options for no cancellation
*----------------------------------------------------------------------*
FORM set_no_cancellation_l .

* begin of delete MOD-004
*  IF NOT no_canc IS INITIAL.
*    gr_stzhl-sign   = 'I'.
*    gr_stzhl-option = 'EQ'.
*    gr_stzhl-low    = '00000000'.
*    APPEND gr_stzhl.
*    gr_stokz-sign   = 'I'.
*    gr_stokz-option = 'EQ'.
*    gr_stokz-low    = ' '.
*    APPEND gr_stokz.
*  ENDIF.
* end of delete MOD-004

ENDFORM.                    " set_no_cancellation_l
*&---------------------------------------------------------------------*
*&      Form  FILL_OBJECT_FIELDS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FILL_OBJECT_FIELDS .

* begin of delete MOD-004
** Modified by Ravin on 10.11.04
*  if not object_tab[]  is initial .
*
*    select aufnr bukrs from aufk into table i_aufk
*                        for all entries in object_tab
*                        where aufnr eq object_tab-aufnr
*                        and bukrs in bukrs_o.
*  endif .
*
*  LOOP AT OBJECT_TAB.
*    L_INDEX = SY-TABIX.
*    read table i_aufk with key aufnr = object_tab-aufnr.
*    if sy-subrc ne 0 .
*      delete object_tab .
*      continue .
*    endif .
*
*    CLEAR OBJECT_TAB-WAERS.
*    CALL FUNCTION 'BAPI_ALM_ORDER_GET_DETAIL'
*      EXPORTING
*        NUMBER           = OBJECT_TAB-AUFNR
*      IMPORTING
*        ES_HEADER        = I_ES_HEADER
*        ES_SRVDATA       = I_ES_SRVDAT
*      TABLES
*        ET_PARTNER       = I_PARTNER
*        ET_OPERATIONS    = I_OPERATIONS
*        ET_COMPONENTS    = I_COMPONENTS
*        ET_RELATIONS     = I_RELATIONS
*        ET_TEXTS         = I_TEXTS[]
*        ET_TEXT_LINES    = I_TEXT_LINES[]
*        ET_PRTS          = I_PRTS[]
*        ET_COSTS_SUM     = I_COSTS_SUM[]
*        ET_COSTS_DETAILS = I_COSTS_DETAIL[]
*        RETURN           = I_RETURN[].
**---------------------------------------------------------*
** READ THE HEADER TABLE TO GET THE PROFIT CENTER          *
**---------------------------------------------------------*
*    READ TABLE I_ES_HEADER INDEX 1.
*    IF I_ES_HEADER-ORDERID = OBJECT_TAB-AUFNR.
*      MOVE I_ES_HEADER-PROFIT_CTR TO OBJECT_TAB-PRCTR.
*      MODIFY  OBJECT_TAB INDEX L_INDEX.
*    ENDIF.
**-------------------------------------------------------------*
** LOOP THE I_COSTS_DETAIL TO GET THE SERVICE COSTS WHICH      *
** IS  Z03 AND SPARE PARTS COST WHICH IS Z04 AND GET THE ACTUAL*
** COST FOR BOTH AND MOVE TO THE OBJECT_TAB TABLE              *
** ON CHANGE OF THE AUFNR GO INTO THE LOOP ELSE NOT            *
**-------------------------------------------------------------*
*    AUFNR = OBJECT_TAB-AUFNR.
*    ON CHANGE OF AUFNR.
*      LOOP AT I_COSTS_DETAIL.
*        CASE  I_COSTS_DETAIL-VALUE_CATEGORY.
*          WHEN C_Z03.
*            MOVE I_COSTS_DETAIL-COSTS_ACT TO  OBJECT_TAB-AMC_IKOSTENKGR
*.
*          WHEN C_Z04.
*            MOVE I_COSTS_DETAIL-COSTS_ACT TO  OBJECT_TAB-ALC_IKOSTENKGR
*.
*        ENDCASE.
*      ENDLOOP.
**------------------------------------------------------------*
** ADD ACTUAL MATERIAL COST AND ACTUAL LABOUR COST TO GET THE *
** TOTAL ACTUAL COST                                          *
**------------------------------------------------------------*
*      OBJECT_TAB-TAC_IKOSTENKGR =  OBJECT_TAB-AMC_IKOSTENKGR +
*                                   OBJECT_TAB-ALC_IKOSTENKGR.
**-------------------------------------------------------------*
** MOVE COSTS CURRENCY TO THE OBJECT-TAB TABLE                 *
**-------------------------------------------------------------*
*      OBJECT_TAB-WAERS = I_COSTS_DETAIL-CURRENCY.
*      MODIFY  OBJECT_TAB INDEX L_INDEX.
*    ENDON.
**---------------------------------------------------------------------*
**SELECT THE NOTIFICATION FAILURE TEXT BASED ON THE NOTIFICATION NUMBER*
**---------------------------------------------------------------------*
*    SELECT SINGLE QMNUM INTO WA_QMNUM-QMNUM FROM AFIH
*                        WHERE AUFNR EQ OBJECT_TAB-AUFNR.
*    NUMBER = WA_QMNUM-QMNUM.
**----------------------------------------------------------------------
**
**BEGIN OF CR-44
**----------------------------------------------------------------------
**
**USE FUCNTION MODULE IQS4_GET_NOTIFICATION TO SELECT ADDITIONAL FIELDS
**
**A)NOTIFICATION OBJECT PART GROUP
**B)NOTIFICATION OBJECT PART
**C)NOTIFICATION DAMAGE
**D)NOTIFICATION DAMAGE SHORT TEXT
**E)NOTIFICATION CAUSE
** MENTIONED IN CR-44
**----------------------------------------------------------------------
**
*    CALL FUNCTION 'IQS4_GET_NOTIFICATION'
*      EXPORTING
*        I_QMNUM     = NUMBER
*      TABLES
*        E_IVIQMFE_T = I_wiqmfe[]
*        E_IVIQMUR_T = I_wiqmur[].
*    IF SY-SUBRC EQ 0.
*      READ TABLE I_WIQMFE INDEX 1.
*      MOVE I_WIQMFE-OTGRP TO OBJECT_TAB-OTGRP.
*      MOVE I_WIQMFE-TXTCDGROT TO OBJECT_TAB-TXTCDGROT.
*      MOVE I_WIQMFE-FETXT TO OBJECT_TAB-FETXT.
*      MOVE I_WIQMFE-TXTCDGR TO OBJECT_TAB-TXTCDGR.
*** MOD-003 Modification by Ravin for CR-54
*      move I_WIQMFE-oteil to object_tab-oteil .
*      move i_wiqmfe-fegrp to object_tab-fegrp .
*      move i_wiqmfe-fecod to object_tab-fecod .
*** MOD-003
*      READ TABLE I_WIQMUR INDEX 1.
*      MOVE I_WIQMUR-TXTCDGR TO OBJECT_TAB-TXTCDFE.
*** MOD-003 Modification by Ravin for CR-54
*      MOVE I_WIQMUR-urgrp TO OBJECT_TAB-urgrp .
*      MOVE I_WIQMUR-urcod TO OBJECT_TAB-urcod .
*** MOD-003
*    ENDIF.
*    CLEAR NUMBER          .
**----------------------------------------------------------------------
**
**END OF CR-44
**----------------------------------------------------------------------
**
*    SELECT SINGLE URTXT INTO OBJECT_TAB-URTXT FROM QMUR
*                        WHERE QMNUM EQ WA_QMNUM-QMNUM
*                        AND  KZLOESCH EQ ' '.
*    IF SY-SUBRC EQ  0.
*      MODIFY  OBJECT_TAB INDEX L_INDEX.
*    ENDIF.
**---------------------------------------------------------------------*
** SELECT THE SERIAL NUMBER OBJECT TYPE AND MATERIAL NUMBER FROM THE   *
** EQUIPMENT MASTER                                                    *
**---------------------------------------------------------------------*
*    SELECT SINGLE SERNR EQART MATNR FROM EQUI INTO (WA_EQUI-SERNR,
*    WA_EQUI-EQART,WA_EQUI-MATNR) WHERE EQUNR EQ OBJECT_TAB-EQUNR.
*    IF SY-SUBRC EQ 0.
*      select single maktx into object_tab-maktx from MAKT
*                                    where matnr eq WA_EQUI-MATNR
*                                    and   spras eq sy-langu .
*      MOVE WA_EQUI-SERNR TO OBJECT_TAB-SERNR.
*      MOVE WA_EQUI-EQART TO OBJECT_TAB-EQART.
*      MOVE WA_EQUI-MATNR TO OBJECT_TAB-MATNR.
*      MODIFY  OBJECT_TAB INDEX L_INDEX.
*    ENDIF.
*  ENDLOOP.
* end of delete MOD-004
ENDFORM.                    " FILL_OBJECT_FIELDS
*----------------------------------------------------------------------*
*BEGIN OF CR-44
*----------------------------------------------------------------------*
*---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  DATE                                                     *
*----------------------------------------------------------------------*
FORM DATE .

* begin of delete MOD-004
*  CALL FUNCTION 'CCM_GO_BACK_MONTHS'
*    EXPORTING
*      currdate   = sy-datum
*      backmonths = 01
*    IMPORTING
*      NEWDATE    = P_DATE1.
*
* MOVE: 'I'      TO  ersda_c-SIGN,
*        'EQ'     TO  ersda_c-OPTION,
*        P_DATE1 TO  ersda_c-LOW,
*        SY-DATUM TO  ersda_c-HIGH.
*
*  APPEND  ersda_c.
* end of delete MOD-004

* begin of insert MOD-004

  data: g_date like sy-datum.

  g_date = sy-datum.
  g_date+6(2) = '01'.

  s_cldate-high = g_date - 1.

  s_cldate-low = s_cldate-high.
  s_cldate-low+6(2) = '01'.

  s_cldate-sign = 'I'.
  s_cldate-option = 'BT'.

  append s_cldate.

* end of insert MOD-004

ENDFORM.                    " DATE
*----------------------------------------------------------------------*
*END OF CR-44
*----------------------------------------------------------------------
*&---------------------------------------------------------------------*
*&      Form  select_orders                                MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM select_orders .

  select aufnr bukrs objnr waers auart mandt kokrs kostv
     into corresponding fields of table gt_aufk
     from aufk
     where aufnr in s_aufnr
       and bukrs in s_bukrs
* begin of insert MOD-011
       and idat3 in s_cldate
* end of insert MOD-011
       and auart in s_auart.

* begin of insert MOD-013
  if sy-subrc <> 0.
    exit.
  endif.
* end of insert MOD-013

* begin of insert MOD-015
* preselect data from maint.order, equipments, customers, materials
* and measurement points
  perform preselect_afih.
  sort gt_afih by aufnr.
* end of delete MOD-015

* begin of insert MOD-008
* preselect close status of orderselection
  select objnr stat chgnr inact
     from JEST
     into corresponding fields of table gt_jest
     for all entries in gt_aufk
     where objnr eq gt_aufk-objnr
       and stat  eq c_i0046
       and inact ne c_x.

  select objnr stat chgnr udate inact
     from JCDS
     into corresponding fields of table gt_jcds
     for all entries in gt_jest
     where objnr eq gt_jest-objnr
       and stat  eq c_i0046
       and inact ne c_x.

  sort gt_jest by objnr.
  sort gt_jcds by objnr chgnr.
* end of insert MOD-008

  clear gt_aufk.
  loop at gt_aufk.

* begin of insert MOD-015
    read table gt_afih with key aufnr = gt_aufk-aufnr
                           binary search.

    if sy-subrc <> 0.
      delete gt_aufk.
      continue.
    endif.
* end of insert MOD-015

* begin of change MOD-008
*   select single chgnr into wa_jest_chgnr
*                       from jest
*                       where objnr eq gt_aufk-objnr
*                         and stat  eq c_i0046
*                         and inact ne c_x.
    read table gt_jest with key objnr = gt_aufk-objnr
                           binary search.
* end of change MOD-008

    if sy-subrc <> 0.
      delete gt_aufk.
* begin of insert MOD-010
      continue.
* end of insert MOD-010
    else.

* begin of change MOD-008
*     select single udate into wa_ord_cls_date
*                         from jcds
*                         where objnr eq gt_aufk-objnr
*                           and stat  eq c_i0046
*                           and chgnr eq wa_jest_chgnr
*                           and inact ne c_x.
      read table gt_jcds with key  objnr = gt_aufk-objnr
                                   chgnr = gt_jest-chgnr
                            binary search.
* end of change MOD-008

      if sy-subrc <> 0.
        delete gt_aufk.
* begin of insert MOD-010
        continue.
* end of insert MOD-010
      else.
* begin of change MOD-008
*       if not wa_ord_cls_date in s_cldate.
        if not gt_jcds-udate in s_cldate.
* end of change MOD-008
          delete gt_aufk.

* begin of insert MOD-010
          continue.
* end of insert MOD-010

* begin of insert MOD-007
        else.
* begin of change MOD-008
*         move wa_ord_cls_date to gt_aufk-cls_date.
*         move wa_ord_cls_date(6) to gt_aufk-period.
          move gt_jcds-udate to gt_aufk-cls_date.
          move gt_jcds-udate(6) to gt_aufk-period.
* end of change MOD-008

* begin of change MOD-008
*         modify gt_aufk.
          modify gt_aufk transporting cls_date period.
* end of change MOD-008

* end of insert MOD-007

* begin of insert MOD-008
*         check if order was already closed in a previous period
          check gt_jest-chgnr > 1.
          loop at gt_jcds where objnr eq gt_aufk-objnr.
            if gt_jcds-udate < s_cldate-low.
              move gt_jcds-udate to gt_aufk-first_cls_date.
              modify gt_aufk transporting first_cls_date.
              exit.
            endif.
          endloop.
* end of insert MOD-008

        endif.
      endif.
    endif.

* begin of delete MOD-011
** begin of insert MOD-010
*    loop at gt_ce11000 where rkaufnr = gt_aufk-aufnr.
*      exit.
*    endloop.
*
*    if sy-subrc ne 0.
*      delete gt_aufk.
*      continue.
*    endif.
** end of insert MOD-010
* end of delete MOD-011

  endloop.

ENDFORM.                    " select_orders
*
*&---------------------------------------------------------------------*
*&      Form  get_conf_and_notif_and_equip               MOD-004
*&---------------------------------------------------------------------*
*       Get all related confirmations and notifications
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
* begin of change MOD-006
*FORM get_conf_and_notif_and_equip.
FORM get_notif_and_equip.
* end of change

  clear gt_aufk.
  loop at gt_aufk.

    g_tabix = sy-tabix.

*   Select the notification, equipment, material and serialnumber

* begin of change MOD-008
*    SELECT SINGLE qmnum equnr sermat serialnr
** begin of insert MOD-007
*                  kunum
** end of insert MOD-007
*              INTO (gt_aufk-qmnum, gt_aufk-equnr, gt_aufk-sermat,
** begin of change MOD-007
**                   gt_aufk-serialnr)
*                    gt_aufk-serialnr,
*                    gt_aufk-kunum)
** end of change MOD-007
*              FROM AFIH
*              WHERE AUFNR EQ gt_aufk-AUFNR.
    read table gt_afih with key aufnr = gt_aufk-aufnr
                          binary search.
* end of change MOD-008

    if sy-subrc = 0.

* begin of insert MOD-008
      move gt_afih-qmnum    to gt_aufk-qmnum.
      move gt_afih-equnr    to gt_aufk-equnr.
      move gt_afih-sermat   to gt_aufk-sermat.
      move gt_afih-serialnr to gt_aufk-serialnr.
      move gt_afih-kunum    to gt_aufk-kunum.
* end of insert MOD-008

      move gt_aufk-aufnr to gt_notif-aufnr.

* begin of insert MOD-015
      move gt_afih-ingpr    to gt_aufk-ingpr.
      read table gt_crhd with key objty = 'A'
                                  objid = gt_afih-gewrk.

      if sy-subrc = 0.
        move gt_crhd-arbpl to gt_aufk-arbpl.
      endif.

      read table gt_t024i with key iwerk = gt_afih-iwerk
                                   ingrp = gt_afih-ingpr
                                   mandt = sy-mandt.

      if sy-subrc = 0.
        move gt_t024i-innam to gt_aufk-innam.
      endif.
* end of insert MOD-015

* begin of insert MOD-007
*     get start-up and delivery date(acquisition date) from equipment

* begin of change MOD-008
*     select single ansdt inbdt
*                 into (gt_aufk-ansdt, gt_aufk-inbdt)
*                 from EQUI
*                 where equnr = gt_aufk-equnr.
      read table gt_equi with key equnr = gt_aufk-equnr
                           binary search.
      if sy-subrc = 0.
        move gt_equi-ansdt to gt_aufk-ansdt.
        move gt_equi-inbdt to gt_aufk-inbdt.
      endif.
* end of change MOD-008

*     get name of sold-to customer

* begin of change MOD-008
*     select single name1 into gt_aufk-pltxt
*                 from KNA1
*                 where kunnr = gt_aufk-kunum.
      read table gt_kna1 with key kunnr = gt_aufk-kunum
                          binary search.
      if sy-subrc = 0.
        move gt_kna1-name1 to gt_aufk-pltxt.
* begin of insert MOD-012
        move gt_kna1-sortl+3(7) to gt_aufk-sortl.
* end of insert MOD-012
      endif.
* end of change MOD-008

* end of insert MOD-007

*     get material description

* begin of change MOD-008
*     clear gt_aufk-maktx.
*     select single maktx into gt_aufk-maktx from MAKT
*                         where matnr eq gt_aufk-sermat
*                           and spras eq sy-langu .
      read table gt_makt with key matnr = gt_aufk-sermat
                            binary search.
      if sy-subrc = 0.
        move gt_makt-maktx to gt_aufk-maktx.
      endif.
* end of change MOD-008

*     get running hours and loaded hours of equipment
      clear: gt_aufk-runhours,
             gt_aufk-loadhours,
             g_objeq.
      g_objeq(2) = c_ie.
      g_objeq+2(18) = gt_aufk-equnr.

      perform get_hours using g_objeq
                              c_run_hours
                     changing gt_aufk-runhours.

      perform get_hours using g_objeq
                              c_loaded_hours
                     changing gt_aufk-loadhours.

      modify gt_aufk index g_tabix.

*     get notification information
      number = gt_aufk-qmnum.

      CALL FUNCTION 'IQS4_GET_NOTIFICATION'
        EXPORTING
          I_QMNUM     = NUMBER
* begin of insert MOD-007
        IMPORTING
          E_VIQMEL    = wa_viqmel
          E_RIWO03    = wa_riwo03
* end of insert MOD-007
        TABLES
          E_IVIQMFE_T = I_wiqmfe[]
          E_IVIQMUR_T = I_wiqmur[].

      IF SY-SUBRC EQ 0.

* begin of insert MOD-007
        move wa_viqmel-ausvn to gt_notif-ausvn.
* end of insert MOD-007

* begin of change MOD-009
*       READ TABLE I_WIQMFE INDEX 1.
*       if sy-subrc = 0.

        loop at i_wiqmfe.

          if i_wiqmfe-otgrp = 'ZACO-020' and
             i_wiqmfe-oteil = '098'      and
             i_wiqmfe-fegrp = 'ZACD-020' and
             i_wiqmfe-fecod = '098'.
            continue.
          endif.
* end of change MOD-009

          MOVE I_WIQMFE-OTGRP TO  gt_notif-OTGRP.
          MOVE I_WIQMFE-TXTCDGROT TO  gt_notif-TXTCDGROT.

* begin of change MOD-014
*         MOVE I_WIQMFE-FETXT TO gt_notif-FETXT.
          if i_wiqmfe-fetxt(10) co '1234567890' and
             i_wiqmfe-fetxt+10(30) co ' '.
            move i_wiqmfe-fetxt to gt_notif-fetxt.
          endif.

*........ Get the longtext related to the problem/damage code
          CONCATENATE gt_aufk-qmnum i_wiqmfe-fenum INTO ld_tdname.
          refresh gt_tline_tmp.

          CALL FUNCTION 'READ_TEXT'
            EXPORTING
              id                      = 'LTXT'
              language                = sy-langu
              name                    = ld_tdname
              object                  = 'QMFE'
            TABLES
              lines                   = gt_tline_tmp
            EXCEPTIONS
              id                      = 1
              language                = 2
              name                    = 3
              not_found               = 4
              object                  = 5
              reference_check         = 6
              wrong_access_to_archive = 7
              OTHERS                  = 8.
          IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
          ENDIF.

*........ Reformat the lines
          LOOP AT gt_tline_tmp.
*.......... Protected line
            IF gt_tline_tmp-tdformat EQ '>X'.
              SHIFT gt_tline_tmp-tdline LEFT BY 2 PLACES.
            ENDIF.
*.......... Do not show paragraph format
            CLEAR gt_tline_tmp-tdformat.
            MODIFY gt_tline_tmp TRANSPORTING tdformat tdline.
          ENDLOOP.

          clear: gv_comm_02,
                 gv_comm_03,
                 gv_comm_04.

          loop at gt_tline_tmp.
            if sy-tabix > 1 and
               sy-tabix < 5.
              case sy-tabix.
                when 2.
                  move gt_tline_tmp-tdline to gv_comm_02.
                when 3.
                  move gt_tline_tmp-tdline to gv_comm_03.
                when 4.
                  move gt_tline_tmp-tdline to gv_comm_04.
              endcase.
            endif.
            concatenate gv_comm_02 gv_comm_03 gv_comm_04
                   into gt_notif-add_comments.
          endloop.
* end of change MOD-014

          MOVE I_WIQMFE-TXTCDGR TO  gt_notif-TXTCDGR.
          move I_WIQMFE-oteil to  gt_notif-oteil .
          move i_wiqmfe-fegrp to  gt_notif-fegrp .
          move i_wiqmfe-fecod to  gt_notif-fecod .

* begin of insert MOD-007
          move i_wiqmfe-fetxt(10) to g_partn.
          move i_wiqmfe-txtgrot to gt_notif-txtgrot.
          move i_wiqmfe-txtgr   to gt_notif-txtgr.

*         get serialnr, name and start-up date of part
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
            EXPORTING
              input  = g_partn
            IMPORTING
              output = gt_notif-partn.

          clear gt_notif-part_descr.
          select single maktx into gt_notif-part_descr
                  from MAKT
                  where matnr = gt_notif-partn
                    and spras = sy-langu.

          clear g_part_objnr.

* begin of change MOD-008
*         select equnr into g_equnr
*                from EQUZ
*                where hequi = gt_aufk-equnr
*                  and datbi = c_99991231.
          loop at gt_equz where hequi = gt_aufk-equnr.
* end of change MOD-008

            select single sernr objnr inbdt
                   into (g_part_sernr, g_part_objnr, g_part_date)
                   from EQUI
* begin of change MOD-008
*                  where equnr = g_equnr
                   where equnr = gt_equz-equnr
* end of change MOD-008
                     and matnr = gt_notif-partn.

            if sy-subrc = 0.
              move g_part_sernr to gt_notif-part_sernr.
              move g_part_objnr to gt_notif-part_objnr.
              move g_part_date  to gt_notif-part_date.
              exit.
            endif.

* begin of change MOD-008
*         endselect.
          endloop.
* end of change MOD-008

          if not g_part_objnr is initial.
*           get running hours of subequipment
            clear: gt_notif-part_hours.

            perform get_hours using gt_notif-part_objnr
                                    c_run_hours
                           changing gt_notif-part_hours.
          endif.

*         determine originality of part
          if gt_aufk-inbdt ne gt_notif-part_date and
             gt_notif-part_date ne c_00000000 and
             gt_aufk-inbdt ne c_00000000.
            move 'NO ' to gt_notif-original.
          else.
            move 'YES' to gt_notif-original.
          endif.
* end of insert MOD-007

* begin of change MOD-009
*         READ TABLE I_WIQMUR INDEX 1.
          read table i_wiqmur with key qmnum = i_wiqmfe-qmnum
                                       fenum = i_wiqmfe-fenum
                                       urnum = '0001'.
* end of change MOD-009
          if sy-subrc = 0.
            MOVE I_WIQMUR-TXTCDGR TO gt_notif-TXTCDFE.
            MOVE I_WIQMUR-urgrp TO  gt_notif-urgrp .
            MOVE I_WIQMUR-urcod TO  gt_notif-urcod .
* begin of insert MOD-007
            move i_wiqmur-urtxt to  gt_notif-urtxt.
* end of insert MOD-007
          endif.
* begin of change MOD-009
*       endif.
          exit.          " select only 1 entry

        endloop.
* end of change MOD-009

* begin of insert MOD-015
*...... Check if more then one object/damage code different
*...... from the comment ones
        clear gv_cnt.
        loop at i_wiqmfe.
          if i_wiqmfe-otgrp = 'ZACO-020' and
             i_wiqmfe-oteil = '098'      and
             i_wiqmfe-fegrp = 'ZACD-020' and
             i_wiqmfe-fecod = '098'.
            continue.
          endif.
          add 1 to gv_cnt.
        endloop.
        if gv_cnt > 1.
          gt_notif-mtoodc = c_x.
        endif.
* end of insert MOD-015

      ENDIF.
      CLEAR NUMBER.

* begin of delete MOD-007
*     SELECT SINGLE URTXT INTO gt_notif-URTXT FROM QMUR
*                     WHERE QMNUM EQ WA_QMNUM-QMNUM
*                       AND  KZLOESCH EQ ' '.
* end of delete MOD-007

      append gt_notif.
      clear gt_notif.
    endif.

* begin of delete MOD-006
**  get confirmations for service order
*   data: gt_afrud type afrud.
*
*   clear gt_afru.
*   refresh gt_afru.
*
*   SELECT * from AFRU
*          INTO TABLE gt_afru
*          where aufnr eq gt_aufk-aufnr
*            and bemot in bemot_c.
*
**   Get details on confirmations
*    if not gt_afru[] is initial.
*
*      loop at gt_afru.
*
*        move-corresponding gt_afru to gt_afrud.
*
*        CALL FUNCTION 'MAP2E_AFRUD_TO_ALM_CONF_DETAIL'
*          EXPORTING
*            AFRUD     = gt_afrud
*          CHANGING
*            BAPI_ALM_CONFIRMATION = wa_confdet.
*
**       Derive profit centre for item
*        g_kdauf = gt_aufk-aufnr.
*        clear g_prctr.
*
*        CALL METHOD YAM_CL_PRCTR_DERIVATION=>CONFIRMATION
*          EXPORTING
*            I_CONF_DETAIL = wa_confdet
*            I_EQUNR       = gt_aufk-equnr
*            I_KDAUF       = g_kdauf
*            I_AUART       = gt_aufk-auart
*          IMPORTING
*            E_PRCTR       = g_prctr.
*
*        move wa_confdet-conf_no to gt_conf-rueck.
*        move wa_confdet-conf_cnt to gt_conf-rmzhl.
*        move wa_confdet-postg_date to gt_conf-budat.
*        move wa_confdet-calc_motive to gt_conf-bemot.
*        move wa_confdet-rev_conf_cnt to gt_conf-stzhl.
*        move wa_confdet-orderid to gt_conf-aufnr.
*        move wa_confdet-act_work to gt_conf-ismnw.
*        move wa_confdet-un_work to gt_conf-ismne.
*        move wa_confdet-act_type to gt_conf-learr.
*        move gt_afru-arbid to gt_conf-arbid.
*        move g_prctr to gt_conf-prctr.
*        append gt_conf.
*        clear gt_conf.
*
*      endloop.
*
*    endif.
* end of delete

  endloop.

ENDFORM.                    " process_orders
*&---------------------------------------------------------------------*
*&      Form  fill_object_table                            MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_object_table
* begin of change MOD-006
*                      tables i_conf structure gt_conf.
                       tables i_aufk structure gt_aufk.
* end of change

* begin of change MOD-006
* loop at i_conf.
  loop at i_aufk.
* end of change

    CLEAR object_tab.
* begin of delete MOD-006
*   MOVE-CORRESPONDING i_conf TO object_tab.

*   get workcenter
*   PERFORM get_arbpl USING i_conf-arbid object_tab-iarbpl.

*   split profitcenter into 3 extra outputfields (division, GAC and PGC)
*   move i_conf-prctr+1(1) to object_tab-division.
*   move i_conf-prctr+2(4) to object_tab-gac.
*   move i_conf-prctr+6(4) to object_tab-pgc.
* end of delete

* begin of insert MOD-006
    loop at gt_ce11000 where rkaufnr = i_aufk-aufnr.

      object_tab-alc_ikostenkgr = gt_ce11000-vv300.
      object_tab-amc_ikostenkgr = gt_ce11000-vv200 + gt_ce11000-vv500.
      object_tab-aoc_ikostenkgr = gt_ce11000-vv400 + gt_ce11000-vv600.

      object_tab-tac_ikostenkgr = object_tab-alc_ikostenkgr +
               object_tab-amc_ikostenkgr + object_tab-aoc_ikostenkgr.

      object_tab-bemot = gt_ce11000-ww003.
      object_tab-prctr = gt_ce11000-prctr.

*   split profitcenter into 3 extra outputfields (division, GAC and PGC)
* begin of change MOD-008
*     move gt_ce11000-prctr+1(1) to object_tab-division.
*     move gt_ce11000-prctr+2(4) to object_tab-gac.
*     move gt_ce11000-prctr+6(4) to object_tab-pgc.
      move gt_ce11000-ww002       to object_tab-plc.
      write gt_ce11000-prctr+2(4) to object_tab-gac no-zero.
      write gt_ce11000-prctr+6(4) to object_tab-pgc no-zero.
* end of change MOD-008
* end of insert

* begin of delete MOD-006
*   read table gt_notif with key aufnr = i_conf-aufnr
      read table gt_notif with key aufnr = i_aufk-aufnr
* end of delete
                         binary search.
      MOVE-CORRESPONDING gt_notif TO object_tab.

* begin of delete MOD-006
*   read table gt_aufk with key aufnr = i_conf-aufnr
*                      binary search.
* end of delete MOD-006
      MOVE-CORRESPONDING gt_aufk TO object_tab.
      move gt_aufk-sermat to object_tab-matnr.
      move gt_aufk-serialnr to object_tab-sernr.

* begin of delete MOD-006
**   get financial period
*    clear: g_monat,
*           g_jahr.
*    PERFORM get_fi_period USING    i_conf-budat
*                                   gt_aufk-bukrs
*                          CHANGING g_monat
*                                   g_jahr.
*
**   calculate values of operations
*    clear g_value.
*    PERFORM calc_value_operations USING gt_aufk-kokrs
*                                        gt_aufk-kostv
*                                        i_conf-budat
*                                        i_conf-ismnw
*                                        i_conf-ismne
*                                        i_conf-learr
*                                        g_monat
*                                        g_jahr
*                               CHANGING g_value.
*
**   If reversed : multiply by -1
*    IF NOT i_conf-stzhl IS INITIAL.
*      g_value = g_value * -1.
*    ENDIF.
*
**   test on activity type to make distinction between labour, parts and
**   miscellaneous
*    case i_conf-learr.
*      when 'ZAM001' or 'ZAM002' or 'ZAM003' or 'ZAM007' or 'ZAM008' or
*           'ZAM009' or 'ZAM011' or 'ZAM012' or 'ZAM014' or 'ZAM015' or
*           'ZAM016' or 'ZAM017' or 'ZAM018' or 'ZAM024' or 'ZAM028' or
*           'ZAM029' or 'ZAM031' or 'ZAM032'.
*        move g_value to object_tab-alc_ikostenkgr.
*      when 'ZAM019'.
*        move g_value to object_tab-amc_ikostenkgr.
*      when others.
*        move g_value to object_tab-aoc_ikostenkgr.
*    endcase.
*    move g_value to object_tab-tac_ikostenkgr.
* end of delete

* begin of change MOD-008
*     append object_tab.
      collect object_tab.
* end of change MOD-008
      clear object_tab.
* begin of insert MOD-006
    endloop.
* end of insert MOD-006

  endloop.

ENDFORM.                    " fill_object_table

*&---------------------------------------------------------------------*
*&      Form  get_fi_period                              MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_fi_period USING    p_budat
                            p_bukrs
                   CHANGING p_monat
                            p_gjahr.

  CALL FUNCTION 'FI_PERIOD_DETERMINE'
    EXPORTING
      i_budat              = p_budat
      i_bukrs              = p_bukrs
*     I_PERIV              = ' '
*     I_GJAHR              = 0000
*     I_MONAT              = 00
*     X_XMO16              = ' '
    IMPORTING
      e_gjahr              = p_gjahr
      e_monat              = p_monat
*     E_POPER              =
    EXCEPTIONS
      fiscal_year          = 1
      period               = 2
      period_version       = 3
      posting_period       = 4
      special_period       = 5
      version              = 6
      posting_date         = 7
      OTHERS               = 8.

ENDFORM.                    " get_fi_period
*&---------------------------------------------------------------------*
*&      Form  calc_value_operations                      MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM calc_value_operations USING    p_kokrs
                                    p_costc
                                    p_budat
                                    p_quant
                                    p_unit
                                    p_operation
                                    p_monat
                                    p_jahr
                           CHANGING p_value.

  DATA: l_pricequant(7) TYPE p DECIMALS 2 VALUE 1,
        l_unit(10) TYPE c,
        l_messagetext(80) TYPE c.

  FIELD-SYMBOLS: <fs>  TYPE ANY,
                 <fs2> TYPE ANY.

  CLEAR: i_cosel[],
         i_costa[],
         wa_cosel.

  REFRESH: i_cosel[],
           i_costa[].

* Construct internal table for COSEL.
  wa_cosel-sign   = 'I'.
  wa_cosel-option = 'EQ'.

* Field Fiscal year
  wa_cosel-field  = 'GJAHR'.
  wa_cosel-low    = p_jahr.
  APPEND wa_cosel TO i_cosel.
  CLEAR: wa_cosel-field,
         wa_cosel-low.

* Field Ledger for Controlling objects
  wa_cosel-field  = 'LEDNR'.
  wa_cosel-low    = '00'.
  APPEND wa_cosel TO i_cosel.
  CLEAR: wa_cosel-field,
         wa_cosel-low.

* Field Object Number
* Construct object number
  CLEAR g_objnr.

  CONCATENATE c_kl
              p_kokrs
              p_costc
              p_operation INTO g_objnr.

  wa_cosel-field  = 'OBJNR'.
  wa_cosel-low    = g_objnr.
  APPEND wa_cosel TO i_cosel.
  CLEAR: wa_cosel-field,
         wa_cosel-low.

* Field Version
  wa_cosel-field  = 'VERSN'.
  wa_cosel-low    = '000'.
  APPEND wa_cosel TO i_cosel.
  CLEAR: wa_cosel-field,
         wa_cosel-low.

* Field Value Type
  wa_cosel-field  = 'WRTTP'.
  wa_cosel-low    = '01'.
  APPEND wa_cosel TO i_cosel.
  CLEAR: wa_cosel-field,
         wa_cosel-low.

* Get totals table for prices of all periods
  CALL FUNCTION 'K_COSTA_READ_MULTI'
    EXPORTING
      von_periode       = '001'
      bis_periode       = '500'
      modus             = '1'
*     PROGNAME          =
*     FORMNAME          =
    TABLES
      t_cosel           = i_cosel
      t_costa           = i_costa
*     T_FGR             =
            .

  CONCATENATE c_tof0 p_monat INTO g_fldperiod.

* This table should only come back with one row
  LOOP AT i_costa INTO wa_costa.

*   Get Activity Unit
    CLEAR: g_leinh.

    FREE: g_leinh.

    SELECT SINGLE leinh FROM cssl INTO g_leinh WHERE
                             kokrs = p_kokrs               AND
                             kostl = p_costc               AND
                             lstar = p_operation           AND
                             gjahr = p_budat(4).

    IF sy-subrc NE 0.
*     Activity Unit Not Found in Table CSSL For Key & & & &
    ELSE.

      ASSIGN COMPONENT g_fldperiod
      OF STRUCTURE     wa_costa TO <fs>.

      ASSIGN <fs> TO <fs2>.

      IF p_unit NE g_leinh.

        PERFORM unit_conversion USING  g_leinh
                                       p_unit
                                       p_quant
                              CHANGING l_pricequant.
      ELSE.

        l_pricequant = p_quant.

      ENDIF.

*     Part calculation of field value (has to be divided still by price
*     unit)
      p_value = <fs> * l_pricequant.

*     Get price unit out of TOE0xx and recalculate correct value
      CLEAR g_fldperiod.
      CONCATENATE c_toe0 p_monat INTO g_fldperiod.

      ASSIGN COMPONENT g_fldperiod
      OF STRUCTURE     wa_costa TO <fs>.

      p_value = p_value / <fs>.

    ENDIF.

  ENDLOOP.

ENDFORM.                    " calc_value_operations
*&---------------------------------------------------------------------*
*&      Form  unit_conversion                             MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_WA_OPERATIONS_DURATION_NORMAL_  text
*      -->P_G_LEINH  text
*      <--P_P_VALUE  text
*----------------------------------------------------------------------*
FORM unit_conversion  USING    p_tounit
                               p_fromunit
                               p_pricequant
                      CHANGING p_quantity.

  CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
    EXPORTING
      input                      = p_pricequant
*     NO_TYPE_CHECK              = 'X'
*     ROUND_SIGN                 = ' '
      unit_in                    = p_fromunit
      unit_out                   = p_tounit
    IMPORTING
*     ADD_CONST                  =
*     DECIMALS                   =
*     DENOMINATOR                =
*     NUMERATOR                  =
      output                     = p_quantity
    EXCEPTIONS
      conversion_not_found       = 1
      division_by_zero           = 2
      input_invalid              = 3
      output_invalid             = 4
      overflow                   = 5
      type_invalid               = 6
      units_missing              = 7
      unit_in_not_found          = 8
      unit_out_not_found         = 9
      OTHERS                     = 10.

ENDFORM.                    " unit_conversion
*&---------------------------------------------------------------------*
*&      Form  preselect_wc                               MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
* begin of change MOD-015
*FORM preselect_wc  TABLES   P_GT_CONF STRUCTURE gt_conf.

* SELECT * FROM crhd INTO TABLE gt_crhd
*   FOR ALL ENTRIES IN p_gt_conf
*   WHERE objty = 'A'
*   AND   objid = p_gt_conf-arbid.
FORM preselect_wc.

  SELECT * FROM crhd INTO TABLE gt_crhd
    FOR ALL ENTRIES IN gt_afih
    WHERE objty = 'A'
    AND   objid = gt_afih-gewrk.
* end of change MOD-015

ENDFORM.                    " preselect_wc
*&---------------------------------------------------------------------*
*&      Form  get_hours                                     MOD-004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_OBJEQ  text
*      <--P_HOURS
*----------------------------------------------------------------------*
FORM get_hours  USING    P_OBJEQ
                         P_INPUT
                CHANGING P_HOURS.

  data: g_fm_atinn type ausp-atinn,
        g_point like imptt-point,
        i_wa_point like impt,
        i_wa_value like imrg.

* convert characteristic into internal value
  clear g_fm_atinn .
  CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
    EXPORTING
      INPUT  = p_input
    IMPORTING
      OUTPUT = g_FM_ATINN.

* get measurement point
  if sy-subrc = 0.
    clear g_point.
    select point from IMPTT into g_point
       where mpobj eq p_objeq
         and atinn eq g_fm_atinn.
    endselect.

    if sy-subrc = 0.
*     read last counter
      CALL FUNCTION 'MEASUREM_POINT_LAST_VALUE'
        EXPORTING
          I_POINT           = g_point
        IMPORTING
          E_WA_POINT        = i_wa_POINT
          E_WA_VALUE        = i_wa_VALUE
        EXCEPTIONS
          POINTER_NOT_FOUND = 01.
*
      if sy-subrc = 0.
*       convert value into display format
        PERFORM UNIT_CONV_DISPL USING I_WA_POINT-MSEHI
                                      I_WA_VALUE-READG
                                      p_hours
                                      I_WA_POINT-DECIM
                                      I_WA_POINT-EXPON.
      endif.
    endif.
  endif.

ENDFORM.                    " get_running_and_loaded_hours
*---------------------------------------------------------------------
*  FORM UNIT_CONV_DISPL
*---------------------------------------------------------------------
FORM UNIT_CONV_DISPL USING P_EINHEIT
                           P_FLTP_WERT
                           P_CHAR_WERT
                           P_DECIMAL
                           P_EXPONENT.

  CLEAR P_CHAR_WERT.
  CHECK NOT ( P_FLTP_WERT IS INITIAL ).

  CALL FUNCTION 'FLTP_CHAR_CONVERSION_FROM_SI'
    EXPORTING
      CHAR_UNIT       = P_EINHEIT
      DECIMALS        = P_DECIMAL
      EXPONENT        = P_EXPONENT
      FLTP_VALUE_SI   = P_FLTP_WERT
      INDICATOR_VALUE = c_x
      MASC_SYMBOL     = ' '
    IMPORTING
      CHAR_VALUE      = P_CHAR_WERT.

ENDFORM.                    "UNIT_CONV_DISPL
*&---------------------------------------------------------------------*
*&      Form  preselect_details_COPA                        MOD-006
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_details_COPA .

  select prctr vv200 vv300 vv400 vv500 vv600 rkaufnr ww003
* begin of insert MOD-008
         ww002
* end of insert MOD-008
* begin of insert MOD-011
         belnr
* end of insert MOD-011
      into corresponding fields of table gt_ce11000
      from CE11000
* begin of insert MOD-011
      for all entries in gt_aufk
* end of insert MOD-011
      where paledger eq c_02
        and vrgar    eq c_0
        and bukrs    in s_bukrs
        and ww003    in bemot_c
* begin of insert MOD-008
        and ww002    in s_plc
* end of insert MOD-008
* begin of change MOD-011
        and rkaufnr  eq gt_aufk-aufnr.
*     order by rkaufnr.

  sort gt_ce11000 by rkaufnr.
* end of change MOD-011

ENDFORM.                    " preselect_details_COPA
*&---------------------------------------------------------------------*
*&      Form  preselect_afih                              MOD-008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_afih .

* get data from maintenance order header
  SELECT aufnr qmnum equnr sermat serialnr kunum
* begin of insert MOD-015
         gewrk iwerk ingpr
* end of insert MOD-015
              FROM AFIH
              INTO corresponding fields of table gt_afih
              FOR ALL ENTRIES IN gt_aufk
              WHERE AUFNR EQ gt_aufk-AUFNR
* begin of insert MOD-015
                and ingpr in s_ingpr.
* end of insert MOD-015

ENDFORM.                    " preselect_afih
*&---------------------------------------------------------------------*
*&      Form  preselect_equi                           MOD-008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_equi .

* get data from equipment
  select ansdt inbdt equnr objnr
             from EQUI
             into corresponding fields of table gt_equi
             for all entries in gt_afih
             where equnr = gt_afih-equnr.

ENDFORM.                    " preselect_equi
*&---------------------------------------------------------------------*
*&      Form  preselect_kna1                           MOD-008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_kna1 .

* get customer name from KNA1
  select name1 kunnr
* begin of insert MOD-012
         sortl
* end of insert MOD-012
              from KNA1
              into corresponding fields of table gt_kna1
              for all entries in gt_afih
              where kunnr = gt_afih-kunum.

ENDFORM.                    " preselect_kna1
*&---------------------------------------------------------------------*
*&      Form  preselect_makt                             MOD-008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_makt .

* get material description from MAKTX
  select matnr maktx
             from MAKT
             into corresponding fields of table gt_makt
             for all entries in gt_afih
             where matnr eq gt_afih-sermat
               and spras eq sy-langu .

ENDFORM.                    " preselect_makt
*&---------------------------------------------------------------------*
*&      Form  preselect_equz                            MOD-008
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_equz .

  select equnr hequi
         from EQUZ
         into corresponding fields of table gt_equz
         for all entries in gt_afih
         where hequi = gt_afih-equnr
           and datbi = c_99991231.

ENDFORM.                    " preselect_equz
*&---------------------------------------------------------------------*
*&      Form  check_selected
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM check_selected .

  loop at gt_aufk.
    loop at gt_ce11000 where rkaufnr = gt_aufk-aufnr.
      exit.
    endloop.

    if sy-subrc ne 0.
      delete gt_aufk.
      continue.
    endif.
  endloop.

ENDFORM.                    " check_selected
*&---------------------------------------------------------------------*
*&      Form  preselect_plangrp                         MOD-015
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM preselect_plangrp .

* get Name of the Maintenance Planner Group from T024I
  select * from T024I
             into table gt_t024I
             for all entries in gt_afih
             where iwerk eq gt_afih-iwerk.

ENDFORM.                    " preselect_plangrp

*Text symbol text£º
*001:Operation
*002:Confirmation
*004:Order status
*005:In process
*008:Completed
*009:Select. profile
*700:**** LINES 701, 702, 703 are one sentence
*701:Do you want to cancel processing
*702:for all the objects selected that
*703:have not yet been processed?
*704:List editing canceled
*705:No
*706:Yes
*ANZ:Number
*P05:Act. work (h)
*PO1:High number, high act. work
*PO2:Low number, high actual work
*PO3:High number, low actual work
*PO4:Low number, low actual work

*SON:Others
*Selection text£º
*BEMOT_C:        Accounting Indicator
*S_AUART:D       Order Type
*S_AUFNR:D       Order
*S_BUKRS:D       Company Code
*S_CLDATE:        Business completed CLSD on
*S_INGPR:D       Planner group
*S_PLC:D       PLC
*VARIANT:D       Layout
