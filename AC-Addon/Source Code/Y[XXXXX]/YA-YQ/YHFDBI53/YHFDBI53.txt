************************************************************************
*          Copyright(c) 2003 Deutsche Bank AG
* All rights reserved. This Software is proprietary to Deutsche Bank AG
* and is protected by copyright law and international treaties. Under no
* circumstances are you permitted to make any attempt to alter, decrypt
* or reverse engineer this software, and any unauthorised reproduction
* of this software or any portion thereof may result in severe civil and
* criminal penalties, and will be prosecuted to the maximum extent
* possible under the law.
************************************************************************
REPORT YHFDBI53 LINE-COUNT 65 LINE-SIZE 160
                NO STANDARD PAGE HEADING
                MESSAGE-ID 00.
************************************************************************
*  Author       :  Deutsche Bank AG
*  Date         :  Apr/2003
*  Description  :  This program is called by YHFDBI52.
************************************************************************
** DDIC-Customized Objects ********************************************
TABLES: BSEG, YHFAUDTR, YHFPARMI, WITH_ITEM, BKPF,RLGRAP.

* Selection screen parameters *****************************************
PARAMETERS: CO_CODE  LIKE BSEG-BUKRS OBLIGATORY.
SELECT-OPTIONS: W_DOCNO  FOR BSEG-BELNR,
                PAY_METH FOR BSEG-ZLSCH OBLIGATORY.
PARAMETERS:  W_FYR LIKE BSEG-GJAHR.
*SELECT-OPTIONS:W_VALUT   FOR  BSEG-VALUT NO-EXTENSION.
SELECT-OPTIONS:S_BUDAT   FOR  BKPF-BUDAT.

PARAMETERS: DBD_PAY LIKE YHFHELP-YHDBDPY OBLIGATORY VISIBLE LENGTH 35.


PARAMETERS: FALLBACK LIKE RFPDO1-F170XCRE.
PARAMETERS: KATAKANA LIKE RFPDO1-F170XCRE.

PARAMETERS: P_EMID LIKE REGUH-SRTF2.

SELECTION-SCREEN BEGIN OF BLOCK HOUSEBANK WITH FRAME TITLE TEXT-012.

PARAMETERS: HBK_KEY LIKE REGUH-HBKID.
PARAMETERS: ACCT_ID LIKE REGUH-HKTID.
SELECTION-SCREEN END OF BLOCK HOUSEBANK.

SELECTION-SCREEN BEGIN OF BLOCK RUNMODE WITH FRAME TITLE TEXT-007.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS:
   YHTEST LIKE YHFHELP-YHTEST RADIOBUTTON GROUP 1.
SELECTION-SCREEN:
  COMMENT 03(50) TEXT-005 FOR FIELD YHTEST,
  END OF LINE.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS:
  YHLIVE LIKE YHFHELP-YHLIVE RADIOBUTTON GROUP 1.
SELECTION-SCREEN:
  COMMENT 03(50) TEXT-006 FOR FIELD YHLIVE,
  END OF LINE.
SELECTION-SCREEN END OF BLOCK RUNMODE.

SELECTION-SCREEN BEGIN OF BLOCK CHEQUE WITH FRAME TITLE TEXT-003.
PARAMETERS:
   PAYPROG(50) TYPE C,
   PAYDET LIKE YHFHELP-YHPAYFILE VISIBLE LENGTH 35.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: REF1 RADIOBUTTON GROUP RAD.
SELECTION-SCREEN COMMENT 4(50) TEXT-010 .
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: REF2 RADIOBUTTON GROUP RAD.
SELECTION-SCREEN COMMENT 4(50) TEXT-011 .
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: REF3 RADIOBUTTON GROUP RAD.
SELECTION-SCREEN COMMENT 4(50) TEXT-009 .
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK CHEQUE.

SELECTION-SCREEN BEGIN OF BLOCK WTXRUN WITH FRAME TITLE TEXT-004.
PARAMETERS: WTXPROG(50) TYPE C DEFAULT 'YHFDBI54'.
SELECT-OPTIONS: S_WITHT FOR WITH_ITEM-WITHT NO INTERVALS.
SELECTION-SCREEN END OF BLOCK WTXRUN.

** Global fields *******************************************************
** Global constants ****************************************************
************************* Data Declaration *****************************
DATA: RWBTR_TOT(13) TYPE P DECIMALS 2. "accum. payment total
DATA: WS_CHKSUM(1), WS_VALUT(10), RC LIKE SY-SUBRC,WS_COMP_CHKSUM(1),
            V_PAYFILE(270), V_CHECK_FILE(270), DIS_PLY(270),
      WS_CHKSUM1(1).
*DATA: V_DBCHK LIKE SXPGCOLIST-NAME.
DATA:  V_WTXREPFILE(120) .
DATA: V_PAYFILE1(270), WS_SER_DELFILE(1), V_ERRFILE(270),
             IN LIKE RLGRAP-FILENAME, L_FILENAME LIKE RLGRAP-FILENAME,
             WS_EXT LIKE RLGRAP-FILENAME, RNUM TYPE I , BYTES TYPE I,
              SUBRC LIKE SY-SUBRC.
DATA:  CHKSUM(80) TYPE C,  CNT TYPE I.
DATA: WS_PC_DOWNLOAD(1),WS_PC_EOP(1),  L_FILELENGTH TYPE I.
DATA: NRLINES TYPE I ,  DBD_PAY1  LIKE YHFHELP-YHDBDPY.
** Global arrays and internal tables ***********************************
DATA: BEGIN OF MASTER_ITAB OCCURS 5000,
        VALUE_DATE          LIKE REGUH-VALUT,
        REC_AC_NAME         LIKE REGUH-ZNME1,
        REC_BANK_CD         LIKE REGUH-ZBNKY,
        REC_BR              LIKE REGUH-ZBNKY,
        REC_AC_NO(34)                       ,
        TR_CD               LIKE T042N-BKTCP,
        PAYMENT_AMT         LIKE REGUH-RWBTR,
*       PAYMENT_AMT(13)     TYPE P DECIMALS 2,
        PAY_AMT_LOCAL       LIKE REGUH-RWBTR,
        PAYMENT_DOC_NO      LIKE REGUH-VBLNR, "payment doc no
        COUNTRY_KEY         LIKE REGUH-LAND1,
        PAY_METHOD          LIKE REGUH-RZAWE, "payment method
        BANK_KEY            LIKE REGUH-HBKID, "house bank key
        ACCOUNT_ID          LIKE REGUH-HKTID, "account id
        BANK_AC_NO          LIKE REGUH-UBKNT, "our account number
        PAY_CURR            LIKE REGUH-WAERS, "currency key
        BANK_NUMBER         LIKE REGUH-UBNKL,
        BENE_NUMBER         LIKE REGUH-LIFNR, "vendor number
        WTX_INCLUD          LIKE YHFFMTXR-YPAYDTL,
      END OF MASTER_ITAB.

DATA: BEGIN OF EXEC_PROTOCOL OCCURS 100.  "protocol table for call func.
        INCLUDE STRUCTURE BTCXPM.
DATA: END OF EXEC_PROTOCOL.
DATA: BEGIN OF SELTAB OCCURS 5.
        INCLUDE STRUCTURE RSPARAMS.
DATA: END OF SELTAB.
DATA: BEGIN OF ITAB_WTXDET OCCURS 0,
        DETAILS(5000),
      END OF ITAB_WTXDET.
DATA: BEGIN OF I_TABLE OCCURS 10,
                LINE(800),
END OF I_TABLE.

**********************Report heading**********************************
TOP-OF-PAGE.
  WRITE: /1 'REF: YHFDBI51', 50 'DEUTSCHE BANK AG'
         , 107 SY-DATUM, SY-TIMLO.
  WRITE: /1 SY-UNAME,   46 'OUTGOING PAYMENT CHECKSUM'
         , 107 'PAGE: ', SY-PAGNO.
  ULINE.
************************* Main Program *********************************
START-OF-SELECTION.
  PERFORM IMPORT_VAR.

*  IF WS_PC_EOP EQ  'Y'  AND DBD_PAY1 NE SPACE.
*      EXPORT V_ERRFILE TO MEMORY ID 'V_ERRFILE'.
*    PERFORM  DOWN_LOAD_PC.
*  ENDIF.

  CLEAR: RWBTR_TOT, RC.
  IF RC = 0.
** Check sum Genration logic ***********************************
    PERFORM MD5_COMPUTE_CHKSUM USING V_PAYFILE
                                     V_CHECK_FILE.
    PERFORM PRINT_HEADING USING V_PAYFILE
                                V_CHECK_FILE.
    PERFORM PRINT_CHECK_DBI.
*    PERFORM DATA_TRANSFER USING V_PAYFILE
*                                V_CHECK_FILE.
    YHFAUDTR-YHPAYKEY = 'dbi.txt'.
    INSERT INTO YHFAUDTR VALUES YHFAUDTR.
  ENDIF.
  COMMIT WORK.

** start 07/05/2007
** Download encrypted file to workstation
  perform data_transfer using v_payfile
                              v_check_file.


  IF WS_PC_DOWNLOAD EQ 'Y'.
    PERFORM DOWN_LOAD_PC.
  ENDIF.

  IF WS_SER_DELFILE EQ 'Y'.
    DELETE DATASET V_PAYFILE.
    DELETE DATASET V_CHECK_FILE.
    DELETE DATASET V_ERRFILE.
  ENDIF.

** end 07/05/2007

** to pop up confirmation if STR SPL param is set.
  PERFORM POP_UP_INFOR_PAYFILE.


************************* Sub-Routines *********************************
FORM IMPORT_VAR.
  IMPORT V_PAYFILE FROM MEMORY ID 'PAYFILE'.
  IMPORT V_CHECK_FILE FROM MEMORY ID 'CHECKFILE'.
  IMPORT MASTER_ITAB       FROM MEMORY ID 'master_itab'.
  IMPORT ITAB_WTXDET FROM MEMORY ID 'WTX_ITAB'.
  IMPORT V_PAYFILE1 FROM MEMORY ID 'V_PAYFILE1'.
  CONCATENATE DBD_PAY V_PAYFILE1 INTO DIS_PLY.
  IMPORT V_ERRFILE FROM MEMORY ID 'V_ERRFILE'.
  IMPORT WS_PC_EOP FROM MEMORY ID 'WS_PC_EOP'.
  IMPORT  DBD_PAY1 FROM  MEMORY ID 'DBD_PAY1'.
  IMPORT DBD_PAY FROM MEMORY ID 'DBD_PAY'.
ENDFORM.
*---------------------------------------------------------------------*
*       FORM PRINT_CHECK_DBI                                          *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM PRINT_CHECK_DBI.
*  DATA: WS_RWBTR LIKE REGUH-RWBTR.
  DATA: WS_RWBTR(13) TYPE P DECIMALS 2.

  SKIP 2.
  WRITE: /1 'Payment List Summary'.
  ULINE.
  WRITE: /4 'Bank A/C No',
         17 'Curr',
         23 'Value Date',
         37 'Rec A/C Name',
         63 'Rec Bank Cd',
         75 'Rec Br',
         84 'Rec A/C No',
         114 'Tr Cd',
         123 'Payment Amt',
*        121 'Payment Doc No'.
        150 'Pay.Doc No'.


*         99 'Tr Cd',
*        108 'Payment Amt',
**        121 'Payment Doc No'.
*        130 'Pay.Doc No'.


  WRITE: /4 'WHT Code',
         23 'Base Amt',
         63 'Tax Rate',
         75 'Tax Amt'.
  ULINE.

  IF DBD_PAY1 NE SPACE.
    CONCATENATE DBD_PAY1 'WTX' SY-DATUM 'REP' INTO V_WTXREPFILE.
  ELSE.
    CONCATENATE DBD_PAY 'WTX' SY-DATUM 'REP' INTO V_WTXREPFILE.
  ENDIF.
  SORT MASTER_ITAB BY VALUE_DATE REC_AC_NO PAY_METHOD PAYMENT_DOC_NO.
  LOOP AT MASTER_ITAB.
    IF SY-SUBRC NE 0.
      EXIT.
    ENDIF.
    CNT = CNT + 1.
    CONCATENATE MASTER_ITAB-VALUE_DATE+0(2)
                '.' MASTER_ITAB-VALUE_DATE+2(2)
                '.' MASTER_ITAB-VALUE_DATE+4(4) INTO WS_VALUT.
    WS_RWBTR = MASTER_ITAB-PAYMENT_AMT.
    WRITE: /1(4) CNT,
           6  MASTER_ITAB-BANK_AC_NO,
           18 MASTER_ITAB-PAY_CURR,
           23 WS_VALUT,
           37(25) MASTER_ITAB-REC_AC_NAME,
           63 MASTER_ITAB-REC_BANK_CD,
           75 MASTER_ITAB-REC_BR,
           84 MASTER_ITAB-REC_AC_NO,

          114 MASTER_ITAB-TR_CD,
          123 WS_RWBTR,
          150 MASTER_ITAB-PAYMENT_DOC_NO.

*           99 MASTER_ITAB-TR_CD,
*          102 WS_RWBTR,
*          130 MASTER_ITAB-PAYMENT_DOC_NO.

    IF MASTER_ITAB-WTX_INCLUD NE SPACE.
      PERFORM PRINT_WTX_DETAILS USING MASTER_ITAB-PAYMENT_DOC_NO.
    ENDIF.
*    RWBTR_TOT = RWBTR_TOT + MASTER_ITAB-PAYMENT_AMT. "payment total
  ENDLOOP.
  ULINE.
  SKIP 2.
  WRITE: /1 'Checksum Summary '.
  ULINE.
  IF WS_PC_DOWNLOAD NE 'Y'.
    WRITE: /1 'Checksum File  :',  30(50) V_CHECK_FILE.
  ELSE.
    WRITE: /1 'Checksum File  :',  30(50) RLGRAP-FILENAME.
  ENDIF.
  SKIP 1.
  IF SYST-OPSYS = 'AS/400' OR SYST-OPSYS = 'OS/400'.
   IF WS_CHKSUM1 = 'Y'.
    WRITE: /1 'Check Total    : ', 18(40) EXEC_PROTOCOL+3.
   ELSE.
    WRITE: /1 'Check Total    : ', 18(32) EXEC_PROTOCOL+3.
   ENDIF.
  ELSE.
    WRITE: /1 'Check Total    : ', 18(128) EXEC_PROTOCOL+3.
  ENDIF.
  WRITE: /1 'Check Date     : ', 32 SY-DATUM.
  WRITE: /1 'Check Time     : ', 34 SY-UZEIT.
  ULINE.

* write to aduit file - YHFAUDTR
  YHFAUDTR-YSYSDATE  = SY-DATUM.
  YHFAUDTR-YSYSTIME  = SY-UZEIT.
  YHFAUDTR-YHPAYFILE  = V_PAYFILE.

  DELETE DATASET V_WTXREPFILE.

ENDFORM.

*---------------------------------------------------------------------*
*       FORM PRINT_WTX_DETAILS                                        *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  VALUE(P_PAY_DOC)                                              *
*---------------------------------------------------------------------*
FORM PRINT_WTX_DETAILS USING VALUE(P_PAY_DOC) TYPE C.
  DATA: V_MATCH_FLAG(1), V_DOC_NO(10) TYPE N.
  DATA: F(1), V_TAX_CODE(5), V_BASE_AMT(15),
        V_TAX_RATE(15), V_TAX_AMT(15).

  LOOP AT ITAB_WTXDET.
    IF ITAB_WTXDET-DETAILS+0(11) = '>>NO OF REC'.
      IF V_MATCH_FLAG = 'Y'.
        EXIT.
      ENDIF.
    ELSEIF ITAB_WTXDET-DETAILS+0(9) = '>>PAYMENT'.
      V_DOC_NO = ITAB_WTXDET-DETAILS+12(10).
      IF V_MATCH_FLAG = 'Y'.
        EXIT.
      ELSEIF V_DOC_NO = P_PAY_DOC.
        V_MATCH_FLAG = 'Y'.
        CONTINUE.
      ENDIF.
    ENDIF.
    IF V_MATCH_FLAG = 'Y' AND ITAB_WTXDET-DETAILS NE SPACE.
      CLEAR: V_TAX_CODE, V_TAX_AMT.
      CNT = CNT + 1.
      SPLIT ITAB_WTXDET-DETAILS AT ';' INTO F F F F F F F F F F F F
            F F F F F V_TAX_CODE F V_BASE_AMT V_TAX_RATE V_TAX_AMT F.
      WRITE: /1(4) CNT,
              6 V_TAX_CODE,
              23 V_BASE_AMT,
              63 V_TAX_RATE,
              75 V_TAX_AMT.
    ENDIF.
  ENDLOOP.
ENDFORM.

* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
*---------------------------------------------------------------------*
*       FORM MD5_COMPUTE_CHKSUM                                       *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  PAYFILE                                                       *
*  -->  CHKFILE                                                       *
*---------------------------------------------------------------------*
FORM MD5_COMPUTE_CHKSUM USING PAYFILE CHKFILE.
  DATA: V_FILE_FLAG LIKE YHFPARMI-PARM_VAL.
****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
****************************************************PP01

*  DATA: ADDPARAM LIKE SXPGCOLIST-PARAMETERS.
*  DATA: V_DBCHK LIKE SXPGCOLIST-NAME.
*  ADDPARAM = PAYFILE.
*  REFRESH EXEC_PROTOCOL.

*  IF SYST-OPSYS = 'AS/400' OR SYST-OPSYS = 'OS/400'.
*    CONCATENATE 'PARM(' '''' ADDPARAM '''' ')' INTO ADDPARAM.
*  ENDIF.

****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
****************************************************PP01
  SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = SPACE
                    AND PARM1 = 'WDN'
                    AND PARM2 = 'EOP'.
  IF SY-SUBRC EQ 0.
    MOVE YHFPARMI-PARM_VAL TO WS_PC_DOWNLOAD.
  ELSE.
    SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = CO_CODE
                      AND PARM1 = 'WDN'
                      AND PARM2 = 'EOP'.
    IF SY-SUBRC EQ 0.
      MOVE YHFPARMI-PARM_VAL TO WS_PC_DOWNLOAD.
    ENDIF.
  ENDIF.

  IF WS_PC_DOWNLOAD EQ 'Y'.
    SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = SPACE
                      AND PARM1 = 'WDN'
                      AND PARM2 = 'EXP'.
    IF SY-SUBRC EQ 0.
      MOVE YHFPARMI-PARM_VAL TO DBD_PAY1.
    ELSE.
      SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = CO_CODE
                        AND PARM1 = 'WDN'
                        AND PARM2 = 'EXP'.
      IF SY-SUBRC EQ 0.
        MOVE YHFPARMI-PARM_VAL TO DBD_PAY1.
      ENDIF.
    ENDIF.

    SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = SPACE
                        AND PARM1 = 'WDN'
                        AND PARM2 = 'DEL'.
    IF SY-SUBRC EQ 0.
      MOVE YHFPARMI-PARM_VAL TO WS_SER_DELFILE.
    ELSE.
      SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = CO_CODE
                        AND PARM1 = 'WDN'
                        AND PARM2 = 'DEL'.
      IF SY-SUBRC EQ 0.
        MOVE YHFPARMI-PARM_VAL TO WS_SER_DELFILE.
      ENDIF.
    ENDIF.
  ENDIF.
****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
****************************************************PP01
  SELECT PARM_VAL INTO WS_COMP_CHKSUM FROM YHFPARMI
                  WHERE BUKRS = SPACE
                    AND PARM1 = 'CHK'
                    AND PARM2 = SPACE.
  ENDSELECT.
  IF WS_COMP_CHKSUM NE 'N'.
    SELECT PARM_VAL INTO WS_CHKSUM FROM YHFPARMI
                   WHERE BUKRS = SPACE
                     AND PARM1 = 'COM'
                     AND PARM2 = 'FUN'.
    ENDSELECT.
  SELECT PARM_VAL INTO WS_CHKSUM1 FROM YHFPARMI
                  WHERE ( BUKRS = SPACE OR BUKRS = CO_CODE ) AND
                        PARM1 = 'CHK'   AND
                        PARM2 = 'SHA'.
  ENDSELECT.
***************************************************************
* If WS_CHKSUM1 EQ 'Y' it will generate the SHA checksum program
* which generate the 40 bytes hash value, ELSE it will generate
* the 32 bytes hash value.
***************************************************************
    PERFORM OS_COMMAND USING V_PAYFILE.
****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
****************************************************PP01

*  IF WS_CHKSUM = 'Y'.
*    CALL FUNCTION 'SXPG_COMMAND_EXECUTE'
*         EXPORTING
*              COMMANDNAME                = 'YDBCHKSUM'
*              ADDITIONAL_PARAMETERS      = ADDPARAM
*         TABLES
*              EXEC_PROTOCOL              = EXEC_PROTOCOL
*         EXCEPTIONS
*              NO_PERMISSION              = 1
*              COMMAND_NOT_FOUND          = 2
*              PARAMETERS_TOO_LONG        = 3
*              SECURITY_RISK              = 4
*              WRONG_CHECK_CALL_INTERFACE = 5
*              PROGRAM_START_ERROR        = 6
*              PROGRAM_TERMINATION_ERROR  = 7
*              X_ERROR                    = 8
*              PARAMETER_EXPECTED         = 9
*              TOO_MANY_PARAMETERS        = 10
*              ILLEGAL_COMMAND            = 11
*              OTHERS                     = 12.
*  ELSE.
*    CALL FUNCTION 'SXPG_CALL_SYSTEM'
*         EXPORTING
*              COMMANDNAME                = 'YDBCHKSUM'
*              ADDITIONAL_PARAMETERS      = ADDPARAM
*         TABLES
*              EXEC_PROTOCOL              = EXEC_PROTOCOL
*         EXCEPTIONS
*              NO_PERMISSION              = 1
*              COMMAND_NOT_FOUND          = 2
*              PARAMETERS_TOO_LONG        = 3
*              SECURITY_RISK              = 4
*              WRONG_CHECK_CALL_INTERFACE = 5
*              PROGRAM_START_ERROR        = 6
*              PROGRAM_TERMINATION_ERROR  = 7
*              X_ERROR                    = 8
*              PARAMETER_EXPECTED         = 9
*              TOO_MANY_PARAMETERS        = 10
*              ILLEGAL_COMMAND            = 11
*              OTHERS                     = 12.
*  ENDIF.
****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
****************************************************PP01
*FOR 4.6
*  OPEN DATASET CHKFILE FOR OUTPUT.
*FOR 4.6

*FOR 4.7
  OPEN DATASET CHKFILE FOR OUTPUT in TEXT MODE ENCODING DEFAULT.
*END 4.7
  CHKSUM = EXEC_PROTOCOL+3.
  IF SYST-OPSYS = 'AS/400' OR SYST-OPSYS = 'OS/400'.
   IF WS_CHKSUM1 = 'Y'.
     LOOP AT EXEC_PROTOCOL.
      TRANSFER: EXEC_PROTOCOL+3(40) TO CHKFILE.
     ENDLOOP.
   ELSE.
     LOOP AT EXEC_PROTOCOL.
      TRANSFER: EXEC_PROTOCOL+3(32) TO CHKFILE.
     ENDLOOP.
   ENDIF.
  ELSE.
    LOOP AT EXEC_PROTOCOL.
      TRANSFER: EXEC_PROTOCOL+3(128) TO CHKFILE.
    ENDLOOP.
  ENDIF.

  IF WS_PC_DOWNLOAD EQ 'Y'.
    REFRESH : I_TABLE.
    CLEAR :  NRLINES, L_FILELENGTH.

*FOR 4.6
*    OPEN DATASET CHKFILE FOR INPUT IN BINARY MODE.
*END 4.6

*FOR 4.7
  CLOSE DATASET CHKFILE.
  OPEN DATASET CHKFILE FOR INPUT IN BINARY MODE.
*END 4.7
    IF SY-SUBRC <> 0.
      WRITE:/ 'cannot open Extraction  file'.
      EXIT.
    ENDIF.
    READ DATASET CHKFILE INTO I_TABLE LENGTH L_FILELENGTH.
    CLOSE DATASET CHKFILE.

    IF SY-SUBRC <> 0.
      EXIT.
    ENDIF.
    APPEND I_TABLE.
    DESCRIBE TABLE I_TABLE LINES NRLINES.
    IMPORT DBD_PAY FROM MEMORY ID 'DBD_PAY'.
    IMPORT DBD_PAY1 FROM MEMORY ID 'DBD_PAY1'.

* -------------------------------------------
* Suffix date and time stamp to checksum file
* -------------------------------------------
    SELECT SINGLE PARM_VAL INTO V_FILE_FLAG FROM YHFPARMI
           WHERE ( BUKRS = CO_CODE OR BUKRS = SPACE )
             AND PARM1  = 'FIX'
             AND PARM2   = 'NME'.

    IF V_FILE_FLAG EQ 'Y'.
      CONCATENATE DBD_PAY 'DBI.CHK' INTO RLGRAP-FILENAME.
    ELSE.
      CONCATENATE DBD_PAY 'DBI' SY-DATUM SY-UZEIT '.CHK' INTO
RLGRAP-FILENAME.
    ENDIF.

*    CONCATENATE DBD_PAY 'DBI.CHK' INTO RLGRAP-FILENAME.
    CALL FUNCTION 'WS_DOWNLOAD'
         EXPORTING
              BIN_FILESIZE            = L_FILELENGTH
              FILENAME                = RLGRAP-FILENAME
              FILETYPE                = 'BIN'
         TABLES
              DATA_TAB                = I_TABLE
         EXCEPTIONS
              FILE_OPEN_ERROR         = 1
              FILE_WRITE_ERROR        = 2
              INVALID_FILESIZE        = 3
              INVALID_TYPE            = 4
              NO_BATCH                = 5
              UNKNOWN_ERROR           = 6
              INVALID_TABLE_WIDTH     = 7
              GUI_REFUSE_FILETRANSFER = 8
              CUSTOMER_ERROR          = 9
              OTHERS                  = 10.
    IF SY-SUBRC <> 0.
      MESSAGE E030 WITH RLGRAP-FILENAME.   "could not open file
    ENDIF.
  ENDIF.
  CLOSE DATASET CHKFILE.
*  IF WS_SER_DELFILE EQ 'Y'.
*    DELETE DATASET PAYFILE.
*    DELETE DATASET CHKFILE.
*    DELETE DATASET V_ERRFILE.
  ENDIF.
ENDFORM.                               " MD5_COMPUTE_CHKSUM

*---------------------------------------------------------------------*
*       FORM PRINT_HEADING                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  PAYFILE                                                       *
*  -->  PAYCHK                                                        *
*---------------------------------------------------------------------*
FORM PRINT_HEADING USING PAYFILE PAYCHK.
  DATA: W_COL TYPE I, C TYPE I, PROG_NAME LIKE SY-REPID.

  MOVE SY-REPID TO PROG_NAME.
  CALL FUNCTION 'RS_REFRESH_FROM_SELECTOPTIONS'
       EXPORTING
            CURR_REPORT     = PROG_NAME
       TABLES
            SELECTION_TABLE = SELTAB
       EXCEPTIONS
            NOT_FOUND       = 1
            NO_REPORT       = 2
            OTHERS          = 3.

  NEW-PAGE NO-HEADING.
  SKIP 1.
  IF WS_PC_DOWNLOAD EQ 'Y'.
    WRITE: /1 'Payment File     :',  23(120) DIS_PLY.
    WRITE: /1 'Checksum File    :',  23(120) RLGRAP-FILENAME.
  ELSE.
    WRITE: /1 'Payment File     :',  23(120) PAYFILE.
    WRITE: /1 'Checksum File    :',  23(120) V_CHECK_FILE.
  ENDIF.
  SKIP 1.
  WRITE: /1 'Company Code     :',  23 CO_CODE.
  PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                          USING 'W_DOCNO' 'Payment Doc No'.
  PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                          USING 'PAY_METH' 'Payment Method'.
  WRITE: /1 'Fiscal year      :', 23 W_FYR.
  WRITE: /1 'Export path      :', 23(120) DBD_PAY.
  WRITE: /1 'Stop FTP         :', 23 FALLBACK.
  WRITE: /1 'KATAKANA 2-1 byte:', 23 KATAKANA.
  WRITE: /1 'PayDtl Program   :', 23 PAYPROG.
  WRITE: /1 'WTX Program      :',  23 WTXPROG.
  PERFORM PRINT_SELECTION(YHFDBIFN) TABLES SELTAB
                          USING 'S_WITHT' 'WTX Tax Type     :'.
  ULINE.
ENDFORM.

*---------------------------------------------------------------------*
*       FORM DATA_TRANSFER                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  PAYFILE                                                       *
*  -->  CHKFILE                                                       *
*---------------------------------------------------------------------*
FORM DATA_TRANSFER USING PAYFILE CHKFILE.
  DATA: OUTPARAM(255),
        STATUS LIKE BTCXP3-EXITSTAT,
        SER_FLAG LIKE SXPGCOLIST-NAME,
        WS_ENCRYPT(1) TYPE C, WS_EXE(20) TYPE C,
        WS_IPADDR LIKE YHFPARMI-PARM_VAL,
        WS_USER   LIKE YHFPARMI-PARM_VAL,
        WS_PASS   LIKE YHFPARMI-PARM_VAL,
        WS_DIR    LIKE YHFPARMI-PARM_VAL,
        WS_CMD    LIKE SXPGCOLIST-NAME,
        V_PFILE(100), V_CFILE(100),
        V_DIRLEN TYPE I, V_FILELEN TYPE I.

  V_DIRLEN = STRLEN( DBD_PAY ).
  V_FILELEN = STRLEN( PAYFILE ) - V_DIRLEN.
  V_PFILE = PAYFILE+V_DIRLEN(V_FILELEN).
  V_CFILE = CHKFILE+V_DIRLEN(V_FILELEN).

  DATA: BEGIN OF INFILE OCCURS 100,
          LINES(250) TYPE C,
        END OF INFILE.

  DATA: FIELD_POS TYPE I,
                       STRR TYPE I,
                        LEN   TYPE I,
                 OFFSET  TYPE I.

  SELECT SINGLE PARM_VAL INTO WS_ENCRYPT FROM YHFPARMI
        WHERE BUKRS = CO_CODE
          AND PARM1 = 'ENC'
          AND PARM2 = SPACE.
*  IF WS_ENCRYPT = 'Y'.
*    PERFORM ENCRYPT_FILE USING DBD_PAY PAYFILE.
*  ENDIF.
  IF WS_PC_DOWNLOAD  = 'Y'.
    IF WS_ENCRYPT = 'Y' .
      PERFORM ENCRYPT_FILE USING DBD_PAY1 PAYFILE.
    ENDIF.
  ELSE.
    IF WS_ENCRYPT = 'Y' .
      PERFORM ENCRYPT_FILE USING DBD_PAY PAYFILE.
    ENDIF.
  ENDIF.

  SELECT SINGLE PARM_VAL INTO SER_FLAG FROM YHFPARMI
             WHERE BUKRS = CO_CODE
             AND   PARM1 = 'SER'
             AND   PARM2 = 'FTP'.

  IF SER_FLAG EQ 'YDBFTP01'.
    PERFORM FTP_TYP1_WITH_TARGET_DIRECTORY USING V_PAYFILE V_CHECK_FILE.
  ELSE.
    PERFORM FTP_ORIGINAL USING V_PAYFILE V_CHECK_FILE.
  ENDIF.

  IF WS_PC_DOWNLOAD EQ 'Y'.
    SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = SPACE
                     AND PARM1 = 'WDN'
                     AND PARM2 = 'WSE'.
    IF SY-SUBRC EQ 0.
      MOVE YHFPARMI-PARM_VAL TO WS_EXE.
    ELSE.
      SELECT SINGLE * FROM YHFPARMI WHERE BUKRS = CO_CODE
                        AND PARM1 = 'WDN'
                        AND PARM2 = 'WSE'.
      IF SY-SUBRC EQ 0.
        MOVE YHFPARMI-PARM_VAL TO WS_EXE.
      ENDIF.
    ENDIF.

    STRR = STRLEN( DBD_PAY ).
    DO STRR  TIMES.
      OFFSET = SY-INDEX - 1.
      IF DBD_PAY+OFFSET(1) =  '\'.
        FIELD_POS = OFFSET.
      ENDIF.
    ENDDO.
    FIELD_POS = FIELD_POS + 1.
    LEN = STRR - FIELD_POS.
    IF LEN NE 0.
      CLEAR:  DBD_PAY+FIELD_POS(LEN).
    ENDIF.
    CONCATENATE DBD_PAY WS_EXE INTO WS_EXT.
    CALL FUNCTION 'WS_EXECUTE'
        EXPORTING
             DOCUMENT           = 'X '
             CD                 = DBD_PAY
            PROGRAM            = WS_EXE
*         EXEC_RC            = ' '
*    IMPORTING
*         RBUFF              =
        EXCEPTIONS
             FRONTEND_ERROR     = 1
             NO_BATCH           = 2
             PROG_NOT_FOUND     = 3
             ILLEGAL_OPTION     = 4
             GUI_REFUSE_EXECUTE = 5
             OTHERS             = 6.
    CASE SY-SUBRC.
      WHEN 0.
        CLEAR: INFILE.
        WRITE: /1 'Executing external command', 28 WS_EXT,
       54  'Successful. Please review log details below:'.
        CONCATENATE DBD_PAY 'ws_exe_log.txt' INTO IN.
        TRANSLATE IN TO UPPER CASE.
        CALL FUNCTION 'WS_UPLOAD'
            EXPORTING
                 FILENAME                = IN
                 FILETYPE                 = 'ASC'
*            IMPORTING
*                 FILELENGTH              =
             TABLES
                  DATA_TAB                = INFILE
            EXCEPTIONS
                 CONVERSION_ERROR        = 1
                 FILE_OPEN_ERROR         = 2
                 FILE_READ_ERROR         = 3
                 INVALID_TYPE            = 4
                 NO_BATCH                = 5
                 UNKNOWN_ERROR           = 6
                 INVALID_TABLE_WIDTH     = 7
                 GUI_REFUSE_FILETRANSFER = 8
                 CUSTOMER_ERROR          = 9
                 OTHERS                  = 10
                  .
        IF SY-SUBRC EQ 0.
          LOOP AT INFILE.
            WRITE:/ INFILE.
          ENDLOOP.
        ELSE.
          WRITE: 'File cannot be open. reason: ', SY-SUBRC.
          EXIT.
        ENDIF.
      WHEN 1.
        MESSAGE I368 WITH
         'ERROR WHILE EXECUTING WS_EXECUTE'
                       '- Error occurred in SAPGUI'.
        PERFORM DELETE_FILE.
      WHEN 2.
        MESSAGE I368 WITH
         'ERROR WHILE EXECUTING WS_EXECUTE'
              '- Front end function cannot be executed in batch'.
        PERFORM DELETE_FILE.
      WHEN 3.
        MESSAGE I368 WITH
        'ERROR WHILE EXECUTING WS_EXECUTE'
               '- Encryption Unsuccessful due to dll is not there'.
        PERFORM DELETE_FILE.
      WHEN 4.
        MESSAGE I368 WITH
         'ERROR WHILE EXECUTING WS_EXECUTE'
                       '- OSMAC* or WIN16_EXT at incorrect frontend'.
        PERFORM DELETE_FILE.
      WHEN 5.
        MESSAGE I368 WITH
         'ERROR WITH GUI REFUSE'
                    '-VERIFY GUI EXECUTION or not executable way'.
        PERFORM DELETE_FILE.
      WHEN OTHERS.
        MESSAGE I368 WITH
                       ' OHTER ERRORS'.
        PERFORM DELETE_FILE.
    ENDCASE.
    STOP.
  ENDIF.
ENDFORM.                               " DATA_TRANSFER
*---------------------------------------------------------------------*
*       FORM ENCRYPT_FILE                                             *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  V_PATH                                                        *
*  -->  PAYFILE                                                       *
*---------------------------------------------------------------------*
FORM ENCRYPT_FILE USING V_PATH PAYFILE.
  DATA: LOCAL_COMMAND(250) TYPE C.
  DATA: ADDPARAM LIKE SXPGCOLIST-PARAMETERS.
  DATA: TEMP_FILE(270).

  CONCATENATE V_PATH 'TEMP.TXT' INTO TEMP_FILE.

* move payment file to temporary location
  IF SYST-OPSYS CS 'WIN'.
    CONCATENATE 'move' PAYFILE TEMP_FILE INTO LOCAL_COMMAND
              SEPARATED BY SPACE.
  ELSE.
    CONCATENATE 'mv' PAYFILE TEMP_FILE INTO LOCAL_COMMAND
              SEPARATED BY SPACE.
  ENDIF.

  CALL 'SYSTEM' ID 'COMMAND' FIELD LOCAL_COMMAND.
  IF SY-SUBRC > 0.
    MESSAGE E368 WITH 'Error creating temporary file'.
  ENDIF.

  CONCATENATE: 'e' TEMP_FILE PAYFILE CHKSUM
               INTO ADDPARAM SEPARATED BY SPACE.

  REFRESH EXEC_PROTOCOL.
  IF WS_CHKSUM = 'Y'.
    CALL FUNCTION 'SXPG_COMMAND_EXECUTE'
       EXPORTING
            COMMANDNAME                = 'YDBCRYPT'
            ADDITIONAL_PARAMETERS      = ADDPARAM
*    IMPORTING
*         STATUS                     =
*         EXITCODE                   =
       TABLES
            EXEC_PROTOCOL              = EXEC_PROTOCOL
       EXCEPTIONS
            NO_PERMISSION              = 1
            COMMAND_NOT_FOUND          = 2
            PARAMETERS_TOO_LONG        = 3
            SECURITY_RISK              = 4
            WRONG_CHECK_CALL_INTERFACE = 5
            PROGRAM_START_ERROR        = 6
            PROGRAM_TERMINATION_ERROR  = 7
            X_ERROR                    = 8
            PARAMETER_EXPECTED         = 9
            TOO_MANY_PARAMETERS        = 10
            ILLEGAL_COMMAND            = 11
            OTHERS                     = 12.
  ELSE.
    CALL FUNCTION 'SXPG_CALL_SYSTEM'
       EXPORTING
            COMMANDNAME                = 'YDBCRYPT'
            ADDITIONAL_PARAMETERS      = ADDPARAM
*    IMPORTING
*         STATUS                     =
*         EXITCODE                   =
       TABLES
            EXEC_PROTOCOL              = EXEC_PROTOCOL
       EXCEPTIONS
            NO_PERMISSION              = 1
            COMMAND_NOT_FOUND          = 2
            PARAMETERS_TOO_LONG        = 3
            SECURITY_RISK              = 4
            WRONG_CHECK_CALL_INTERFACE = 5
            PROGRAM_START_ERROR        = 6
            PROGRAM_TERMINATION_ERROR  = 7
            X_ERROR                    = 8
            PARAMETER_EXPECTED         = 9
            TOO_MANY_PARAMETERS        = 10
            ILLEGAL_COMMAND            = 11
            OTHERS                     = 12.
  ENDIF.

  SKIP 2.
  WRITE:/ 'STATUS OF ENCRYPTION'.
  ULINE.
  LOOP AT EXEC_PROTOCOL.
    WRITE:/ EXEC_PROTOCOL.
  ENDLOOP.

  DELETE DATASET TEMP_FILE.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  FTP_TYP1_WITH_TARGET_DIRECTORY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_V_PAYFILE  text
*      -->P_V_CHECK_FILE  text
*----------------------------------------------------------------------*
FORM FTP_TYP1_WITH_TARGET_DIRECTORY USING PAYFILE CHKFILE.

  DATA: OUTPARAM(255),
        STATUS LIKE BTCXP3-EXITSTAT,
        SER_FLAG LIKE SXPGCOLIST-NAME,
        WS_ENCRYPT(1) TYPE C,
        WS_IPADDR LIKE YHFPARMI-PARM_VAL,
        WS_USER   LIKE YHFPARMI-PARM_VAL,
        WS_PASS   LIKE YHFPARMI-PARM_VAL,
        WS_DIR    LIKE YHFPARMI-PARM_VAL,
        WS_CMD    LIKE SXPGCOLIST-NAME,
        V_PFILE(100), V_CFILE(100),
        V_DIRLEN TYPE I, V_FILELEN TYPE I.
  V_DIRLEN  = STRLEN( DBD_PAY ).
  V_FILELEN = STRLEN( PAYFILE ) - V_DIRLEN.
  V_PFILE   = PAYFILE+V_DIRLEN(V_FILELEN).
  V_CFILE   = CHKFILE+V_DIRLEN(V_FILELEN).

  SELECT SINGLE PARM_VAL INTO WS_IPADDR FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'SER'
           AND PARM2 = 'IPA'.
  SELECT SINGLE PARM_VAL INTO WS_USER FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'SER'
           AND PARM2 = 'USR'.
  SELECT SINGLE PARM_VAL INTO WS_PASS FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'SER'
           AND PARM2 = 'PWD'.
  SELECT SINGLE PARM_VAL INTO WS_DIR FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'SER'
           AND PARM2 = 'DIR'.

  IF FALLBACK EQ SPACE AND WS_IPADDR NE SPACE.

    SKIP 2.
    WS_CMD = 'YDBFTP01'.
    IF DBD_PAY1 NE SPACE.
      CONCATENATE: WS_IPADDR WS_USER WS_PASS DBD_PAY1
      V_PFILE V_CFILE WS_DIR INTO OUTPARAM SEPARATED BY SPACE.
    ELSE.
      CONCATENATE: WS_IPADDR WS_USER WS_PASS DBD_PAY
             V_PFILE V_CFILE WS_DIR
             INTO OUTPARAM SEPARATED BY SPACE.
    ENDIF.
    WRITE:/ 'STATUS OF FILE TRANSFER TO REPOSITORY SERVER'.
    ULINE.

    REFRESH: EXEC_PROTOCOL.
    IF WS_CHKSUM = 'Y'.
      CALL FUNCTION 'SXPG_COMMAND_EXECUTE'
           EXPORTING
                COMMANDNAME                = WS_CMD
                ADDITIONAL_PARAMETERS      = OUTPARAM
           IMPORTING
                STATUS                     = STATUS
           TABLES
                EXEC_PROTOCOL              = EXEC_PROTOCOL
           EXCEPTIONS
                NO_PERMISSION              = 1
                COMMAND_NOT_FOUND          = 2
                PARAMETERS_TOO_LONG        = 3
                SECURITY_RISK              = 4
                WRONG_CHECK_CALL_INTERFACE = 5
                PROGRAM_START_ERROR        = 6
                PROGRAM_TERMINATION_ERROR  = 7
                X_ERROR                    = 8
                PARAMETER_EXPECTED         = 9
                TOO_MANY_PARAMETERS        = 10
                ILLEGAL_COMMAND            = 11
                OTHERS                     = 12.
    ELSE.
      CALL FUNCTION 'SXPG_CALL_SYSTEM'
           EXPORTING
                COMMANDNAME                = WS_CMD
                ADDITIONAL_PARAMETERS      = OUTPARAM
           IMPORTING
                STATUS                     = STATUS
           TABLES
                EXEC_PROTOCOL              = EXEC_PROTOCOL
           EXCEPTIONS
                NO_PERMISSION              = 1
                COMMAND_NOT_FOUND          = 2
                PARAMETERS_TOO_LONG        = 3
                SECURITY_RISK              = 4
                WRONG_CHECK_CALL_INTERFACE = 5
                PROGRAM_START_ERROR        = 6
                PROGRAM_TERMINATION_ERROR  = 7
                X_ERROR                    = 8
                PARAMETER_EXPECTED         = 9
                TOO_MANY_PARAMETERS        = 10
                ILLEGAL_COMMAND            = 11
                OTHERS                     = 12.
    ENDIF.
*    IF WS_IPADDR EQ 'H2H'.
*      IF SY-SUBRC EQ 0.
*        WRITE:/ 'File transfer completed successfully'.
*      ENDIF.
*    ELSE.
    LOOP AT EXEC_PROTOCOL WHERE MESSAGE(3) EQ '226'.
      DELETE DATASET     PAYFILE.
      DELETE DATASET     CHKFILE.
      EXIT.
    ENDLOOP.
*    ENDIF.

    LOOP AT EXEC_PROTOCOL.
      WRITE:/ EXEC_PROTOCOL.
    ENDLOOP.
  ENDIF.
  ULINE.
  SKIP 2.
  WRITE: /50 'End of Report'.

ENDFORM.                    " FTP_TYP1_WITH_TARGET_DIRECTORY

*&---------------------------------------------------------------------*
*&      Form  FTP_ORIGINAL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_V_PAYFILE  text
*      -->P_V_CHECK_FILE  text
*----------------------------------------------------------------------*
FORM FTP_ORIGINAL USING  PAYFILE CHKFILE.

  DATA: OUTPARAM(255),
        STATUS LIKE BTCXP3-EXITSTAT,
        SER_FLAG LIKE SXPGCOLIST-NAME,
        WS_ENCRYPT(1) TYPE C,
        WS_IPADDR LIKE YHFPARMI-PARM_VAL,
        WS_USER   LIKE YHFPARMI-PARM_VAL,
        WS_PASS   LIKE YHFPARMI-PARM_VAL,
        WS_DIR    LIKE YHFPARMI-PARM_VAL,
        WS_CMD    LIKE SXPGCOLIST-NAME,
        V_PFILE(100), V_CFILE(100),
        V_DIRLEN TYPE I, V_FILELEN TYPE I.

  V_DIRLEN = STRLEN( DBD_PAY ).
  V_FILELEN = STRLEN( PAYFILE ) - V_DIRLEN.
  V_PFILE = PAYFILE+V_DIRLEN(V_FILELEN).
  V_CFILE = CHKFILE+V_DIRLEN(V_FILELEN).


  SELECT SINGLE PARM_VAL INTO WS_IPADDR FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'GIF'
           AND PARM2 = 'IPA'.
  SELECT SINGLE PARM_VAL INTO WS_USER FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'GIF'
           AND PARM2 = 'USR'.
  SELECT SINGLE PARM_VAL INTO WS_PASS FROM YHFPARMI
         WHERE BUKRS = CO_CODE
           AND PARM1 = 'GIF'
           AND PARM2 = 'PWD'.

  IF FALLBACK EQ SPACE AND WS_IPADDR NE SPACE.

    SKIP 2.
    IF WS_IPADDR = 'H2H'.
      WS_CMD = 'YDBPOSTPROC'.
      IF DBD_PAY1 NE SPACE.
        CONCATENATE: DBD_PAY1 V_PFILE V_CFILE
                     INTO OUTPARAM SEPARATED BY SPACE.
      ELSE.
        CONCATENATE: DBD_PAY V_PFILE V_CFILE
                     INTO OUTPARAM SEPARATED BY SPACE.
      ENDIF.
      WRITE:/ 'STATUS OF H2H TRANSFER'.
    ELSE.
      WS_CMD = 'YDBFTP'.
      CONCATENATE: WS_IPADDR WS_USER WS_PASS
                   PAYFILE V_PFILE CHKFILE V_CFILE
                   INTO OUTPARAM SEPARATED BY SPACE.
*      WRITE:/ 'STATUS OF GIFTED SERVER TRANSFER'.
      WRITE:/ 'STATUS OF FILE TRANSFER TO REPOSITORY SERVER'.
    ENDIF.
    ULINE.

    REFRESH: EXEC_PROTOCOL.
    IF WS_CHKSUM = 'Y'.
      CALL FUNCTION 'SXPG_COMMAND_EXECUTE'
           EXPORTING
                COMMANDNAME                = 'YDBFTP'
                ADDITIONAL_PARAMETERS      = OUTPARAM
           IMPORTING
                STATUS                     = STATUS
           TABLES
                EXEC_PROTOCOL              = EXEC_PROTOCOL
           EXCEPTIONS
                NO_PERMISSION              = 1
                COMMAND_NOT_FOUND          = 2
                PARAMETERS_TOO_LONG        = 3
                SECURITY_RISK              = 4
                WRONG_CHECK_CALL_INTERFACE = 5
                PROGRAM_START_ERROR        = 6
                PROGRAM_TERMINATION_ERROR  = 7
                X_ERROR                    = 8
                PARAMETER_EXPECTED         = 9
                TOO_MANY_PARAMETERS        = 10
                ILLEGAL_COMMAND            = 11
                OTHERS                     = 12.
    ELSE.
      CALL FUNCTION 'SXPG_CALL_SYSTEM'
           EXPORTING
                COMMANDNAME                = 'YDBFTP'
                ADDITIONAL_PARAMETERS      = OUTPARAM
           IMPORTING
                STATUS                     = STATUS
           TABLES
                EXEC_PROTOCOL              = EXEC_PROTOCOL
           EXCEPTIONS
                NO_PERMISSION              = 1
                COMMAND_NOT_FOUND          = 2
                PARAMETERS_TOO_LONG        = 3
                SECURITY_RISK              = 4
                WRONG_CHECK_CALL_INTERFACE = 5
                PROGRAM_START_ERROR        = 6
                PROGRAM_TERMINATION_ERROR  = 7
                X_ERROR                    = 8
                PARAMETER_EXPECTED         = 9
                TOO_MANY_PARAMETERS        = 10
                ILLEGAL_COMMAND            = 11
                OTHERS                     = 12.
    ENDIF.
    IF WS_IPADDR EQ 'H2H'.
      IF SY-SUBRC EQ 0.
        WRITE:/ 'File transfer completed successfully'.
      ENDIF.
    ELSE.
      LOOP AT EXEC_PROTOCOL WHERE MESSAGE(3) EQ '226'.
        DELETE DATASET     PAYFILE.
        DELETE DATASET     CHKFILE.
        EXIT.
      ENDLOOP.
    ENDIF.
    LOOP AT EXEC_PROTOCOL.
      WRITE:/ EXEC_PROTOCOL.
    ENDLOOP.
  ENDIF.
  ULINE.
  SKIP 2.
  WRITE: /50 'End of Report'.
ENDFORM.                    " FTP_ORIGINAL

*&---------------------------------------------------------------------*
*&      Form  DELETE_FILE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DELETE_FILE.
  CLEAR : L_FILENAME.
  MOVE  DIS_PLY TO L_FILENAME.
  CALL FUNCTION 'WS_FILE_DELETE'
       EXPORTING
            FILE = L_FILENAME.
ENDFORM.                    " DELETE_FILE

*&---------------------------------------------------------------------*
*&      Form  DOWN_LOAD_PC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DOWN_LOAD_PC.
  REFRESH : I_TABLE.
  CLEAR :  L_FILELENGTH.
  DATA: V_FILE_FLAG LIKE YHFPARMI-PARM_VAL.

*FOR 4.6
*  OPEN DATASET V_PAYFILE FOR INPUT IN BINARY MODE.
*END 4.6

*FOR 4.7
   OPEN DATASET V_PAYFILE FOR INPUT IN BINARY MODE.
*END 4.7
  IF SY-SUBRC <> 0.
*          WRITE:/ 'cannot open Extraction  file'.
    EXIT.
  ENDIF.
  BYTES = 0.
  DO.
    READ DATASET V_PAYFILE INTO I_TABLE LENGTH L_FILELENGTH.
    SUBRC = SY-SUBRC.
    APPEND I_TABLE.
    ADD L_FILELENGTH  TO BYTES.
    IF SUBRC NE 0.
      EXIT.
    ENDIF.
  ENDDO.
  CLOSE DATASET V_PAYFILE.

*  IMPORT DBD_PAY FROM MEMORY ID 'DBD_PAY'.
*  IMPORT V_PAYFILE1 FROM MEMORY ID 'V_PAYFILE1'.
*  IMPORT WS_PC_EOP FROM MEMORY ID 'WS_PC_EOP'.

  SELECT SINGLE PARM_VAL INTO V_FILE_FLAG FROM YHFPARMI
        WHERE ( BUKRS = CO_CODE OR BUKRS = SPACE )
          AND PARM1  = 'FIX'
          AND PARM2   = 'NME'.

  IF V_FILE_FLAG EQ 'Y'.
    CONCATENATE DBD_PAY 'DBI.TXT' INTO RLGRAP-FILENAME.
  ELSE.
    CONCATENATE DBD_PAY 'DBI' SY-DATUM SY-UZEIT '.TXT'
    INTO RLGRAP-FILENAME.
  ENDIF.

*  CONCATENATE DBD_PAY 'DBI.TXT' INTO RLGRAP-FILENAME.
  CALL FUNCTION 'WS_DOWNLOAD'
       EXPORTING
            BIN_FILESIZE            = BYTES  "L_FILELENGTH
            FILENAME                = RLGRAP-FILENAME
            FILETYPE                = 'BIN'
       TABLES
            DATA_TAB                = I_TABLE
       EXCEPTIONS
            FILE_OPEN_ERROR         = 1
            FILE_WRITE_ERROR        = 2
            INVALID_FILESIZE        = 3
            INVALID_TYPE            = 4
            NO_BATCH                = 5
            UNKNOWN_ERROR           = 6
            INVALID_TABLE_WIDTH     = 7
            GUI_REFUSE_FILETRANSFER = 8
            CUSTOMER_ERROR          = 9
            OTHERS                  = 10.
  IF SY-SUBRC <> 0.
    MESSAGE E030  WITH RLGRAP-FILENAME.   "could not open file
  ELSE.
  ENDIF.
ENDFORM.                    " DOWN_LOAD_PC



*&---------------------------------------------------------------------*
*&      Form  POP_UP_INFOR_PAYFILE
*&---------------------------------------------------------------------*
*       POP-UP FOR INFORMATION THAT THE PAYMENT FILE HAS BEEN GENERATED
*----------------------------------------------------------------------*
FORM POP_UP_INFOR_PAYFILE .

  data: TO_PROCEED_FLAG, v_skip_parm1.

  SELECT SINGLE PARM_VAL FROM YHFPARMI INTO V_SKIP_PARM1
                             WHERE ( BUKRS = CO_CODE OR BUKRS = SPACE )
                                AND  PARM1 = 'STR'
                                AND  PARM2 = 'SPL'.

  if v_skip_parm1 eq 'Y'.

    CALL FUNCTION 'POPUP_TO_DISPLAY_TEXT'
         EXPORTING
              TITEL     = 'Payment file generated'
              TEXTLINE1 = 'Use tcode /nSP01 to retrieve the reports'.

  endif.
ENDFORM.                    " POP_UP_INFOR_PAYFILE
****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.
****************************************************PP01
*&---------------------------------------------------------------------*
*&      Form  OS_COMMAND
*&---------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
*      PAYFILE
*----------------------------------------------------------------------*
FORM OS_COMMAND USING PAYFILE.
  DATA: ADDPARAM LIKE SXPGCOLIST-PARAMETERS.
  DATA: V_DBCHK LIKE SXPGCOLIST-NAME.

  ADDPARAM = PAYFILE.
  REFRESH EXEC_PROTOCOL.

  IF SYST-OPSYS = 'AS/400' OR SYST-OPSYS = 'OS/400'.
    CONCATENATE 'PARM(' '''' ADDPARAM '''' ')' INTO ADDPARAM.
  ENDIF.
  IF WS_CHKSUM1 = 'Y'.
    V_DBCHK = 'YDBCHKSHA'.
  ELSE.
    V_DBCHK = 'YDBCHKSUM'.
  ENDIF.
  IF WS_CHKSUM = 'Y'.
    CALL FUNCTION 'SXPG_COMMAND_EXECUTE'
         EXPORTING
              COMMANDNAME                = V_DBCHK
              ADDITIONAL_PARAMETERS      = ADDPARAM
         TABLES
              EXEC_PROTOCOL              = EXEC_PROTOCOL
         EXCEPTIONS
              NO_PERMISSION              = 1
              COMMAND_NOT_FOUND          = 2
              PARAMETERS_TOO_LONG        = 3
              SECURITY_RISK              = 4
              WRONG_CHECK_CALL_INTERFACE = 5
              PROGRAM_START_ERROR        = 6
              PROGRAM_TERMINATION_ERROR  = 7
              X_ERROR                    = 8
              PARAMETER_EXPECTED         = 9
              TOO_MANY_PARAMETERS        = 10
              ILLEGAL_COMMAND            = 11
              OTHERS                     = 12.
  ELSE.
    CALL FUNCTION 'SXPG_CALL_SYSTEM'
         EXPORTING
              COMMANDNAME                = V_DBCHK
              ADDITIONAL_PARAMETERS      = ADDPARAM
         TABLES
              EXEC_PROTOCOL              = EXEC_PROTOCOL
         EXCEPTIONS
              NO_PERMISSION              = 1
              COMMAND_NOT_FOUND          = 2
              PARAMETERS_TOO_LONG        = 3
              SECURITY_RISK              = 4
              WRONG_CHECK_CALL_INTERFACE = 5
              PROGRAM_START_ERROR        = 6
              PROGRAM_TERMINATION_ERROR  = 7
              X_ERROR                    = 8
              PARAMETER_EXPECTED         = 9
              TOO_MANY_PARAMETERS        = 10
              ILLEGAL_COMMAND            = 11
              OTHERS                     = 12.
  ENDIF.
ENDFORM.                    " OS_COMMAND
****************************************************PP01
* Changed by : Purna Chandra
* Date       : 20\08\2007
* To create the SHA checksum value generation.

****************************************************PP01
*Text symbol text£º
*003:Additional Details
*005:Test Run
*006:Live Run

*012:House Bank Details ( Applicable to all payments in this extraction )
*Selection text£º
*ACCT_ID:        Account ID
*CO_CODE:        Company Code
*DBD_PAY:        Export path for db-direct File
*HBK_KEY:        House Bank
*PAYDET:        Payment Detail Path
*PAYPROG:        Payment Detail Program
*PAY_METH:        Payment Method
*W_DOCNO:        Payment Document Number
*W_FYR:        Fiscal Year
*YHLIVE:        Live

*YHTEST:        Test
*List Title: Titlebar£º
*:DEUTSCHE BANK AG - OUTGOING PAYMENT CHECKSUM LIST
