*&---------------------------------------------------------------------*
*& Report  YBDC_CALLTRANSACTION
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  YBDC_CALLTRANSACTION.

DATA: BEGIN OF WA_DATA,
  KOKRS TYPE KOKRS,
  KOSTL TYPE KOSTL,
  DATAB TYPE DATAB,
  DATBI TYPE DATBI,
  KTEXT TYPE KTEXT,
  LTEXT TYPE LTEXT,
  VERAK TYPE VERAK,
  KOSAR TYPE KOSAR,
  KHINR TYPE KHINR,
  END OF WA_DATA.

  DATA: IT_DATA LIKE TABLE OF WA_DATA,
        IT_BDCDATA LIKE TABLE OF BDCDATA,

  WA_BDCDATA LIKE LINE OF IT_BDCDATA,
  IT_BDCMSGCOLL LIKE TABLE OF BDCMSGCOLL,
  WA_BDCMSGCOLL LIKE LINE OF IT_BDCMSGCOLL.

  DATA:  V_FILE TYPE STRING.

  CONSTANTS:  C_KS01(4) TYPE C VALUE 'KS01',
  C_X(1) TYPE C VALUE 'X',
  C_A(1) TYPE C VALUE 'A'.

  SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-000.
    PARAMETERS: PA_FILE LIKE FC03TAB-PL00_FILE OBLIGATORY .
    SELECTION-SCREEN END OF BLOCK B1.

    AT SELECTION-SCREEN ON VALUE-REQUEST FOR PA_FILE.
      PERFORM GET_F4_FOR_FILE USING PA_FILE.
 START-OF-SELECTION.
   V_FILE = PA_FILE.
   PERFORM UPLOAD_FILE_TO_ITAB USING V_FILE
        CHANGING IT_DATA.
      LOOP AT IT_DATA INTO WA_DATA.
     REFRESH IT_BDCDATA.

        PERFORM FILL_SCREEN_DETAILS USING 'SAPLKMA1' '0200' 'X'.
        PERFORM FILL_FIELD_DETAILS USING 'BDC_CURSOR' 'CSKSZ-KOKRS'.
        PERFORM FILL_FIELD_DETAILS USING 'BDC_OKCODE' '/00'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-KOKRS' WA_DATA-KOKRS.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-KOSTL' WA_DATA-KOSTL.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-DATAB_ANFO' WA_DATA-DATAB. " '/00'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-DATBI_ANFO' WA_DATA-DATBI.
        PERFORM FILL_SCREEN_DETAILS USING 'SAPLKMA1' '0299' 'X'.
        PERFORM FILL_FIELD_DETAILS USING 'BDC_OKCODE' '=BU'.
        PERFORM FILL_FIELD_DETAILS USING 'BDC_SUBSCR' 'BDC_SUBSCR'.
        PERFORM FILL_FIELD_DETAILS USING 'BDC_CURSOR' 'CSKSZ-WAERS'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-KTEXT' 'WA_DATA-KTEXT'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-LTEXT' 'WA_DATA-LTEXT'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-VERAK' 'WA_DATA-VERAK'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-KOSAR' 'WA_DATA-KOSAR'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-KHINR' 'WA_DATA-KHINR'.
        PERFORM FILL_FIELD_DETAILS USING 'CSKSZ-WAERS' 'INR' .

        CALL TRANSACTION C_KS01 USING IT_BDCDATA MODE C_A " A - ALL SCREENS
              UPDATE 'A'
              MESSAGES INTO IT_BDCMSGCOLL.
     ENDLOOP.

     FORM FILL_SCREEN_DETAILS USING PROGRAM LIKE BDCDATA-PROGRAM
              DYNPRO LIKE BDCDATA-DYNPRO
              DYNBEGIN LIKE BDCDATA-DYNBEGIN.
      CLEAR WA_BDCDATA.
          WA_BDCDATA-PROGRAM = PROGRAM.
          WA_BDCDATA-DYNPRO = DYNPRO.
          WA_BDCDATA-DYNBEGIN = DYNBEGIN.
     CLEAR : WA_BDCDATA.
      ENDFORM.

   FORM FILL_FIELD_DETAILS USING FNAM FVAL.
       CLEAR: WA_BDCDATA.
         WA_BDCDATA-FNAM = FNAM.
         WA_BDCDATA-FVAL = FVAL.
  APPEND WA_BDCDATA TO IT_BDCDATA.
 ENDFORM.

 FORM GET_F4_FOR_FILE USING P_PA_FILE.

CALL FUNCTION 'KD_GET_FILENAME_ON_F4'
 EXPORTING
*   PROGRAM_NAME        = SYST-REPID
*   DYNPRO_NUMBER       = SYST-DYNNR
   FIELD_NAME          = 'PA_FILE'
*   STATIC              = ' '
*   MASK                = ' '
*   FILEOPERATION       = 'R'
  CHANGING
    FILE_NAME           = PA_FILE .
*   LOCATION_FLAG       = 'P'
* EXCEPTIONS
*   MASK_TOO_LONG       = 1
*   OTHERS              = 2
          .
IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
ENDFORM.

FORM UPLOAD_FILE_TO_ITAB USING FP_FILE
      CHANGING FP_IT_DATA LIKE IT_DATA.

  CALL FUNCTION 'GUI_UPLOAD'
    EXPORTING
      FILENAME                      = FP_FILE
*     FILETYPE                      = 'ASC'
     HAS_FIELD_SEPARATOR           = 'X'
*     HEADER_LENGTH                 = 0
*     READ_BY_LINE                  = 'X'
*     DAT_MODE                      = ' '
*     CODEPAGE                      = ' '
*     IGNORE_CERR                   = ABAP_TRUE
*     REPLACEMENT                   = '#'
*     CHECK_BOM                     = ' '
*     VIRUS_SCAN_PROFILE            =
*     NO_AUTH_CHECK                 = ' '
*   IMPORTING
*     FILELENGTH                    =
*     HEADER                        =
    TABLES
      DATA_TAB                      = FP_IT_DATA.
            .
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.


  ENDFORM.
